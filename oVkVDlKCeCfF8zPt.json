{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Router de Acciones FIXED": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          },
          {
            "node": "¿Solicita Cancelar Operacion?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Tarea Odoo": {
      "main": [
        [
          {
            "node": "¿Falta Horas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Falta Horas?": {
      "main": [
        [
          {
            "node": "Guardar Estado Falta Horas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Buscar Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Estado Falta Horas": {
      "main": [
        [
          {
            "node": "Solicitar Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Procesar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Respuesta": {
      "main": [
        [
          {
            "node": "Router de Acciones FIXED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos AI Agent": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          },
          {
            "node": "Procesando Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Datos Transcripción": {
      "main": [
        [
          {
            "node": "Verificar Usuario Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Transcripción": {
      "main": [
        [
          {
            "node": "Actualizar Datos Transcripción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Transcripción": {
      "main": [
        [
          {
            "node": "Confirmar Transcripción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Audio": {
      "main": [
        [
          {
            "node": "Transcribe a recording",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Descarga": {
      "main": [
        [
          {
            "node": "Descargar Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Archivo de Voz": {
      "main": [
        [
          {
            "node": "Preparar Descarga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Audio?": {
      "main": [
        [
          {
            "node": "Obtener Archivo de Voz",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Verificar Usuario Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Verificación BD": {
      "main": [
        [
          {
            "node": "Verificar Historial Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Chat ID": {
      "main": [
        [
          {
            "node": "Preparar Verificación BD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Historial Usuario": {
      "main": [
        [
          {
            "node": "IF Tiene Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Tiene Historial": {
      "main": [
        [
          {
            "node": "Verificar Último Mensaje Bot",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cargar Perfil Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Último Mensaje Bot": {
      "main": [
        [
          {
            "node": "Preparar Datos para IF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos para IF": {
      "main": [
        [
          {
            "node": "Acceso a memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Memoria PostgreSQL": {
      "main": [
        [
          {
            "node": "Cargar Perfil Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo": {
      "main": [
        [
          {
            "node": "Obtener Chat ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos": {
      "main": [
        [
          {
            "node": "¿Mensaje Es Dirección?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Upload Audio": {
      "main": [
        [
          {
            "node": "HTTP Request - Create Transcript (ES)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Create Transcript (ES)": {
      "main": [
        [
          {
            "node": "Esperar Transcripción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar Transcripción": {
      "main": [
        [
          {
            "node": "HTTP Request - Get Transcript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acceso a memoria": {
      "main": [
        [
          {
            "node": "Consultar Memoria PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cargar Perfil Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Resumen Diario 8:00 AM": {
      "main": [
        [
          {
            "node": "Preparar Resumen Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Resumen Diario": {
      "main": [
        [
          {
            "node": "Consultar Usuarios Registrados y Validados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Usuario Existente": {
      "main": [
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Resultado Verificación": {
      "main": [
        [
          {
            "node": "¿Usuario Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usuario Ya Existe": {
      "main": [
        [
          {
            "node": "PostgreSQL Actualizar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL Actualizar Usuario": {
      "main": [
        [
          {
            "node": "Limpiar Datos Registro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registro Usuario": {
      "main": [
        [
          {
            "node": "PostgreSQL Registrar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL Registrar Usuario": {
      "main": [
        [
          {
            "node": "Mensaje nuevo registro sin user",
            "type": "main",
            "index": 0
          },
          {
            "node": "Mensaje para Admins de Nuevo Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Datos Registro": {
      "main": [
        [
          {
            "node": "Consultar Límite Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Usuario Telegram": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Sin Usuario Odoo": {
      "main": [
        [
          {
            "node": "Autenticar Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo para Resumen": {
      "main": [
        [
          {
            "node": "Preparar Consulta Eventos Diarios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Eventos Diarios": {
      "main": [
        [
          {
            "node": "HTTP Consultar Eventos Diarios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Eventos Diarios": {
      "main": [
        [
          {
            "node": "HTTP Consultar Tareas Diarias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Órdenes Pendientes": {
      "main": [
        [
          {
            "node": "HTTP Consultar Órdenes Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Órdenes Pendientes": {
      "main": [
        [
          {
            "node": "Formatear Resumen Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Resumen Diario": {
      "main": [
        [
          {
            "node": "Preparar Envío Masivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Envío Masivo": {
      "main": [
        [
          {
            "node": "Bucle por Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bucle por Usuario": {
      "main": [
        [],
        [
          {
            "node": "Preparar Mensaje Individual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Mensaje Individual": {
      "main": [
        [
          {
            "node": "Consultar Eventos Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Eventos Usuario": {
      "main": [
        [
          {
            "node": "HTTP Buscar Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Eventos Personalizados": {
      "main": [
        [
          {
            "node": "Preparar Consulta Tareas Ayer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Tareas Ayer": {
      "main": [
        [
          {
            "node": "HTTP Consultar Tareas Ayer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Tareas Ayer": {
      "main": [
        [
          {
            "node": "Formatear Resumen Personalizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Resumen Personalizado": {
      "main": [
        [
          {
            "node": "Telegram Envío Individual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Envío Individual": {
      "main": [
        [
          {
            "node": "Vaciar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vaciar": {
      "main": [
        [
          {
            "node": "Bucle por Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Usuario Pasando Mail?": {
      "main": [
        [
          {
            "node": "Extraer y Validar Correo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Normalizar Entrada Documento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer y Validar Correo": {
      "main": [
        [
          {
            "node": "¿Correo Válido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Correo Válido?": {
      "main": [
        [
          {
            "node": "Actualizar Correo en BD",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Correo Inválido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Correo en BD": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Correo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Correo": {
      "main": [
        [
          {
            "node": "Confirmar Correo al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Correo al Usuario": {
      "main": [
        [
          {
            "node": "Notificar Admin Correo Recibido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Imagen Inmediatamente": {
      "main": [
        [
          {
            "node": "HTTP Descargar Imagen REAL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Último Horas ID": {
      "main": [
        [
          {
            "node": "Adjuntar Imagen al Último Parte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Adjuntar Imagen al Último Parte": {
      "main": [
        [
          {
            "node": "¿Tiene Imagen para Adjuntar (Último)?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Tiene Imagen para Adjuntar (Último)?": {
      "main": [
        [
          {
            "node": "Preparar Adjunto Directo (PARTE)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Autenticar Odoo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Sin Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Informe Semanal Lunes 10:00": {
      "main": [
        [
          {
            "node": "Preparar Informe Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Informe Semanal": {
      "main": [
        [
          {
            "node": "Consultar Usuarios Registrados y Validados Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo para Resumen Semanal": {
      "main": [
        [
          {
            "node": "Preparar Consultas Semanales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consultas Semanales": {
      "main": [
        [
          {
            "node": "HTTP Ventas Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Ventas Semana": {
      "main": [
        [
          {
            "node": "Guardar Ventas Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Ventas Semana": {
      "main": [
        [
          {
            "node": "HTTP Leads Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Leads Semana": {
      "main": [
        [
          {
            "node": "Guardar Leads Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Leads Semana": {
      "main": [
        [
          {
            "node": "HTTP Tickets Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Tickets Semana": {
      "main": [
        [
          {
            "node": "Guardar Tickets Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Tickets Semana": {
      "main": [
        [
          {
            "node": "Formatear Informe Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Informe Semanal": {
      "main": [
        [
          {
            "node": "Enviar Informe Semanal Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Límite Usuario": {
      "main": [
        [
          {
            "node": "Aplicar Límite Consultas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Límite Consultas": {
      "main": [
        [
          {
            "node": "¿Puede Continuar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Puede Continuar?": {
      "main": [
        [
          {
            "node": "Consultar Usuario Telegram",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aviso Bloqueo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Admins": {
      "main": [
        [
          {
            "node": "Avisar Admin Nuevo Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje para Admins de Nuevo Usuario": {
      "main": [
        [
          {
            "node": "Listar Admins",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Usuario Existe?": {
      "main": [
        [
          {
            "node": "Preparar Registro Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Usuario Ya Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Comando Validar?": {
      "main": [
        [
          {
            "node": "¿Es Admin?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Usuario Pasando Mail?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Admin?": {
      "main": [
        [
          {
            "node": "¿Admin Autorizado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Admin Autorizado?": {
      "main": [
        [
          {
            "node": "Parsear Objetivo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No autorizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear Objetivo": {
      "main": [
        [
          {
            "node": "Buscar Usuario Por Nombre",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario Por Nombre": {
      "main": [
        [
          {
            "node": "¿Encontrado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Encontrado?": {
      "main": [
        [
          {
            "node": "¿Tiene Mail?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Validar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Tiene Mail?": {
      "main": [
        [
          {
            "node": "Autenticar Odoo Validación",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Solicitar Mail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Solicitar Mail": {
      "main": [
        [
          {
            "node": "Solicitar Mail Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Solicitar Mail Usuario": {
      "main": [
        [
          {
            "node": "Confirmar Solicitud Mail al Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Login Odoo": {
      "main": [
        [
          {
            "node": "Verificar Login Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Login Existe": {
      "main": [
        [
          {
            "node": "Ajustar Login Si Necesario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ajustar Login Si Necesario": {
      "main": [
        [
          {
            "node": "Validar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Usuario": {
      "main": [
        [
          {
            "node": "Preservar Datos Usuario",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar al Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preservar Datos Usuario": {
      "main": [
        [
          {
            "node": "Autenticar Odoo Creación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo Validación": {
      "main": [
        [
          {
            "node": "Verificar Usuario Existe Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo Creación": {
      "main": [
        [
          {
            "node": "Preparar Crear Partner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Usuario Existe Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Verificación Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Verificación Usuario": {
      "main": [
        [
          {
            "node": "¿Usuario Ya Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Usuario Ya Existe?": {
      "main": [
        [
          {
            "node": "Notificar Usuario Ya Existe",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generar Login Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notificar Usuario Ya Existe": {
      "main": [
        [
          {
            "node": "Notificar Admin Usuario Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Partner": {
      "main": [
        [
          {
            "node": "Crear Partner Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Partner Odoo": {
      "main": [
        [
          {
            "node": "Buscar Grupo Portal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Grupo Portal": {
      "main": [
        [
          {
            "node": "Obtener Grupo Portal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Grupo Portal": {
      "main": [
        [
          {
            "node": "Combinar Datos Grupo Portal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combinar Datos Grupo Portal": {
      "main": [
        [
          {
            "node": "Preparar Crear Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Usuario Odoo": {
      "main": [
        [
          {
            "node": "Crear Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Usuario Odoo": {
      "main": [
        [
          {
            "node": "Preparar Datos Finales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos Finales": {
      "main": [
        [
          {
            "node": "Avisar Usuario Validado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Avisar Usuario Validado": {
      "main": [
        [
          {
            "node": "Mensaje de Inicio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Usuarios Registrados y Validados": {
      "main": [
        [
          {
            "node": "Autenticar Odoo para Resumen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Usuarios Registrados y Validados Semanal": {
      "main": [
        [
          {
            "node": "Autenticar Odoo para Resumen Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cargar Perfil Usuario": {
      "main": [
        [
          {
            "node": "Preparar Datos AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Mensaje Es Dirección?": {
      "main": [
        [
          {
            "node": "Extraer Dirección Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Comando Validar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Dirección Pedido": {
      "main": [
        [
          {
            "node": "¿Dirección Válida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Dirección Válida?": {
      "main": [
        [
          {
            "node": "Actualizar Dirección Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Error Dirección",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Dirección Usuario": {
      "main": [
        [
          {
            "node": "Confirmar Dirección Guardada Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Dirección Guardada Pedido": {
      "main": [
        [
          {
            "node": "Preservar Datos Dirección",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preservar Datos Dirección": {
      "main": [
        [
          {
            "node": "Autenticar Odoo Dirección",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar País Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Búsqueda País",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Búsqueda País": {
      "main": [
        [
          {
            "node": "Buscar Provincia Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Provincia Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Búsqueda Provincia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Búsqueda Provincia": {
      "main": [
        [
          {
            "node": "Buscar Partner Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Partner Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Búsqueda Partner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Búsqueda Partner": {
      "main": [
        [
          {
            "node": "Actualizar Dirección en Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Dirección en Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Update Dirección Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo Dirección": {
      "main": [
        [
          {
            "node": "Buscar País Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Normalizar Parte+Materiales FSM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registrar Tarea Odoo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fallback",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Bienvenida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Actividad Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Horas Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Horas Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Estado Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar Datos Gasto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Fichaje?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Autenticar Odoo LOPD",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Admin Envio Masivos?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Uso Liberar Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Uso Liberar Coche": {
      "main": [
        [
          {
            "node": "¿Sin Error Coche?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Sin Error Coche?": {
      "main": [
        [
          {
            "node": "HTTP Buscar Usuario Odoo Coche",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Usuario Odoo Coche": {
      "main": [
        [
          {
            "node": "Preparar Consulta Vehículos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Vehículos": {
      "main": [
        [
          {
            "node": "¿Usuario Encontrado Coche?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Usuario Encontrado Coche?": {
      "main": [
        [
          {
            "node": "HTTP Consultar Vehículos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Vehículos": {
      "main": [
        [
          {
            "node": "Procesar Uso Liberar Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Uso Liberar Coche": {
      "main": [
        [
          {
            "node": "¿Ejecutar Acción Odoo Coche?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Ejecutar Acción Odoo Coche?": {
      "main": [
        [
          {
            "node": "Ejecutar Asignar Liberar Coche",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Guardar Memoria Coche?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Guardar Memoria Coche?": {
      "main": [
        [
          {
            "node": "Guardar Memoria Coche",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Coche": {
      "main": [
        [
          {
            "node": "Unificar Respuesta Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Asignar Liberar Coche": {
      "main": [
        [
          {
            "node": "HTTP Ejecutar Coche Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Ejecutar Coche Odoo": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Coche": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unificar Respuesta Coche": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Coche",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Coche": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Admin Envio Masivos?": {
      "main": [
        [
          {
            "node": "Obtener Todos Usuarios",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Admin Envio Masivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Todos Usuarios": {
      "main": [
        [
          {
            "node": "Preparar Items Envio Masivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Items Envio Masivo": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [
          {
            "node": "Confirmar Envio Masivo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Masivo Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Masivo Telegram": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Envio Masivo": {
      "main": [
        [
          {
            "node": "Confirmar Admin Envio Masivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo LOPD": {
      "main": [
        [
          {
            "node": "Preparar Consulta Tareas LOPD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Tareas LOPD": {
      "main": [
        [
          {
            "node": "HTTP Consultar Tareas LOPD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Tareas LOPD": {
      "main": [
        [
          {
            "node": "Preparar Lista LOPD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Lista LOPD": {
      "main": [
        [
          {
            "node": "Guardar Estado LOPD",
            "type": "main",
            "index": 0
          },
          {
            "node": "Enviar Lista LOPD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Parte+Materiales FSM": {
      "main": [
        [
          {
            "node": "Consultar Tareas Calendario Día",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Materiales": {
      "main": [
        [
          {
            "node": "¿Hay Materiales?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Horas Directo FSM": {
      "main": [
        [
          {
            "node": "¿Registra Horas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Horas Directo FSM": {
      "main": [
        [
          {
            "node": "Preparar Obtener Cliente desde Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Usuario Odoo": {
      "main": [
        [
          {
            "node": "Buscar Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario Odoo": {
      "main": [
        [
          {
            "node": "Registrar Horas Directo FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Datos Válidos para PostgreSQL?": {
      "main": [
        [
          {
            "node": "Insertar en PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Datos Inválidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos PostgreSQL": {
      "main": [
        [
          {
            "node": "Marcar Descuento Final",
            "type": "main",
            "index": 0
          },
          {
            "node": "¿Datos Válidos para PostgreSQL?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marcar Descuento Final": {
      "main": [
        [
          {
            "node": "¿Descontar Ahora?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Descontar Ahora?": {
      "main": [
        [
          {
            "node": "Descontar Consulta Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Extraer Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe a recording": {
      "main": [
        [
          {
            "node": "Procesar Transcripción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Actividad Usuario": {
      "main": [
        [
          {
            "node": "HTTP Consulta Actividad Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Actividad Usuario": {
      "main": [
        [
          {
            "node": "Procesar Búsqueda Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Actividad Usuario": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Actividad Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Actividad Usuario": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Búsqueda Usuario": {
      "main": [
        [
          {
            "node": "HTTP Consulta Actividad Usuario Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Actividad Usuario Final": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Actividad Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Horas Proyecto": {
      "main": [
        [
          {
            "node": "HTTP Consulta Horas Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Horas Proyecto": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Horas Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Horas Proyecto": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Horas Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Horas Proyecto": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Horas Tarea": {
      "main": [
        [
          {
            "node": "HTTP Consulta Horas Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Horas Tarea": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Horas Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Horas Tarea": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Horas Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Horas Tarea": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Estado Proyecto": {
      "main": [
        [
          {
            "node": "¿Listar por etapa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Proyecto": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyecto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolver Proyecto / Desambiguar": {
      "main": [
        [
          {
            "node": "¿Proyecto encontrado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Proyecto encontrado?": {
      "main": [
        [
          {
            "node": "Preparar Get Tareas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Desambiguación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Desambiguación": {
      "main": [
        [
          {
            "node": "Telegram Preguntar Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Get Tareas": {
      "main": [
        [
          {
            "node": "HTTP Get Tareas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Get Tareas": {
      "main": [
        [
          {
            "node": "Preparar Horas Agrupadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Horas Agrupadas": {
      "main": [
        [
          {
            "node": "HTTP Horas por Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Horas por Tarea": {
      "main": [
        [
          {
            "node": "Preparar Timesheets Detalle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Timesheets Detalle": {
      "main": [
        [
          {
            "node": "HTTP Timesheets Detalle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Timesheets Detalle": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Estado Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Estado Proyecto": {
      "main": [
        [
          {
            "node": "Telegram Enviar Estado Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Enviar Estado Proyecto": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyecto1": {
      "main": [
        [
          {
            "node": "Resolver Proyecto / Desambiguar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Listar por etapa?": {
      "main": [
        [
          {
            "node": "Preparar Buscar Proyectos por Etapa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Buscar Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Proyectos por Etapa": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyectos por Etapa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyectos por Etapa": {
      "main": [
        [
          {
            "node": "Preparar Buscar Proyectos por ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Lista Proyectos por Etapa": {
      "main": [
        [
          {
            "node": "Enviar Lista Proyectos por Etapa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Lista Proyectos por Etapa": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Proyectos por ID": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyectos por ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyectos por ID": {
      "main": [
        [
          {
            "node": "Formatear Lista Proyectos por Etapa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Procesar Resultado Verificación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Nota Materiales": {
      "main": [
        [
          {
            "node": "Buscar Almacén",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Almacén": {
      "main": [
        [
          {
            "node": "HTTP Buscar Warehouse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Warehouse": {
      "main": [
        [
          {
            "node": "Resolver Ubicaciones WH",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolver Ubicaciones WH": {
      "main": [
        [
          {
            "node": "HTTP Buscar Ubicación Scrap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Ubicación Scrap": {
      "main": [
        [
          {
            "node": "Fijar IDs de Ubicaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fijar IDs de Ubicaciones": {
      "main": [
        [
          {
            "node": "Preparar Orden Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Orden Desecho": {
      "main": [
        [
          {
            "node": "Crear Órdenes de Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Órdenes de Desecho": {
      "main": [
        [
          {
            "node": "Loop Over Items para Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Desecho": {
      "main": [
        [
          {
            "node": "Preparar Message Post Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items para Desecho": {
      "main": [
        [
          {
            "node": "Formatear Confirmación Desecho",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Crear Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Confirmación Desecho": {
      "main": [
        [
          {
            "node": "Confirmar Todo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Validación Scrap": {
      "main": [
        [
          {
            "node": "HTTP Validar Scrap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Validar Scrap": {
      "main": [
        [
          {
            "node": "Loop Over Items para Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Message Post Desecho": {
      "main": [
        [
          {
            "node": "HTTP Postear Autor Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Postear Autor Desecho": {
      "main": [
        [
          {
            "node": "Preparar Validación Scrap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Tareas Calendario Día": {
      "main": [
        [
          {
            "node": "HTTP Consultar Tareas Calendario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Tareas Calendario": {
      "main": [
        [
          {
            "node": "Validar y Elegir Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar y Elegir Tarea": {
      "main": [
        [
          {
            "node": "Switch Acciones Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Acciones Tarea": {
      "main": [
        [
          {
            "node": "Guardar Memoria Confirmar Única",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Elegir Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notificar Error Sin Tareas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Elegir Tarea": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Tarea": {
      "main": [
        [
          {
            "node": "Solicitar Elegir Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Confirmar Única": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Tarea Unica",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Tarea Unica": {
      "main": [
        [
          {
            "node": "Confirmar Tarea Única",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar & Resumen": {
      "main": [
        [
          {
            "node": "Guardar Último Horas ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Último Horas ID": {
      "main": [
        [
          {
            "node": "Limpiar Memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria": {
      "main": [
        [
          {
            "node": "Confirmar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Hay Materiales?": {
      "main": [
        [
          {
            "node": "Preparar Búsqueda Productos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Limpiar & Resumen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Productos": {
      "main": [
        [
          {
            "node": "Validar Productos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Búsqueda Productos": {
      "main": [
        [
          {
            "node": "Buscar Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Productos1": {
      "main": [
        [
          {
            "node": "¿Productos Necesitan Corrección?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Obtener Cliente desde Tarea": {
      "main": [
        [
          {
            "node": "HTTP Leer Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Leer Tarea": {
      "main": [
        [
          {
            "node": "Extraer partner_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer partner_id": {
      "main": [
        [
          {
            "node": "Preparar Presupuesto (Productos Mencionados)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Nota Materiales": {
      "main": [
        [
          {
            "node": "HTTP Registrar Nota Materiales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Materiales1": {
      "main": [
        [
          {
            "node": "HTTP Registrar Materiales Parte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Materiales Parte": {
      "main": [
        [
          {
            "node": "Preparar Nota Materiales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Presupuesto (Productos Mencionados)": {
      "main": [
        [
          {
            "node": "¿Registrar Presupuesto?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Registrar Presupuesto?": {
      "main": [
        [
          {
            "node": "HTTP Buscar Producto Presupuesto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registrar Materiales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Presupuesto (Mencionados)": {
      "main": [
        [
          {
            "node": "Registrar Materiales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Solicita Cancelar Operacion?": {
      "main": [
        [
          {
            "node": "Borrar Memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Payload Presupuesto (Servicio)": {
      "main": [
        [
          {
            "node": "HTTP Registrar Presupuesto (Mencionados)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Producto Presupuesto": {
      "main": [
        [
          {
            "node": "Preparar Payload Presupuesto (Servicio)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Tiene Imagen?": {
      "main": [
        [
          {
            "node": "Detectar Ruta Imagen",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirma si Odoo devolvió OK": {
      "main": [
        [
          {
            "node": "¿Subida Imagen?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Subida Imagen?": {
      "main": [
        [
          {
            "node": "Confirmar Imagen Adjuntada (Último)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Imagen Adjuntada (Último)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Descargar Imagen REAL": {
      "main": [
        [
          {
            "node": "Construir URL Descarga Parte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Construir URL Descarga Parte": {
      "main": [
        [
          {
            "node": "Descargar Imagen REAL (PARTE)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Imagen REAL (PARTE)": {
      "main": [
        [
          {
            "node": "Buscar Último Horas ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detectar Ruta Imagen": {
      "main": [
        [
          {
            "node": "¿Imagen suelta?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Imagen suelta?": {
      "main": [
        [
          {
            "node": "Descargar Imagen Inmediatamente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Descargar Imagen Inmediatamente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Imagen Descargada": {
      "main": [
        [
          {
            "node": "¿Es Audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Imagen Inmediatamente1": {
      "main": [
        [
          {
            "node": "Procesar Imagen Descargada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Adjunto Directo (PARTE)": {
      "main": [
        [
          {
            "node": "HTTP Login Odoo (admin)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Adjunto Odoo (PARTE)": {
      "main": [
        [
          {
            "node": "Confirma si Odoo devolvió OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada Documento": {
      "main": [
        [
          {
            "node": "¿Tiene Imagen?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Login Odoo (admin)": {
      "main": [
        [
          {
            "node": "HTTP Crear Adjunto Odoo (PARTE)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Tareas Diarias": {
      "main": [
        [
          {
            "node": "Preparar Consulta Órdenes Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Usuario Odoo": {
      "main": [
        [
          {
            "node": "Preparar Consulta FSM Hoy",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta FSM Hoy": {
      "main": [
        [
          {
            "node": "HTTP Eventos Personalizados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Productos Necesitan Corrección?": {
      "main": [
        [
          {
            "node": "Guardar Corrección Productos Pendientes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registrar Materiales1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Corrección Productos Pendientes": {
      "main": [
        [
          {
            "node": "Pedir Corrección Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Registra Horas?": {
      "main": [
        [
          {
            "node": "HTTP Registrar Horas Directo FSM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Obtener Cliente desde Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Datos Gasto": {
      "main": [
        [
          {
            "node": "Buscar Empleado Simplificado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Gasto Creado": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Empleado Simplificado": {
      "main": [
        [
          {
            "node": "HTTP Buscar Empleado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Empleado": {
      "main": [
        [
          {
            "node": "Verificar Empleado Simplificado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Empleado Simplificado": {
      "main": [
        [
          {
            "node": "¿Existe empleado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Gasto Simplificado": {
      "main": [
        [
          {
            "node": "Crear Gasto Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Gasto Odoo": {
      "main": [
        [
          {
            "node": "Descargar y Adjuntar Imagen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar y Adjuntar Imagen": {
      "main": [
        [
          {
            "node": "Obtener File Path Real",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Construir URL Descarga": {
      "main": [
        [
          {
            "node": "Descargar Imagen HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener File Path Real": {
      "main": [
        [
          {
            "node": "Construir URL Descarga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Imagen HTTP": {
      "main": [
        [
          {
            "node": "Preparar Adjunto Directo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Adjunto Directo": {
      "main": [
        [
          {
            "node": "HTTP Crear Adjunto Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Adjunto Odoo": {
      "main": [
        [
          {
            "node": "Finalizar Adjunto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalizar Adjunto": {
      "main": [
        [
          {
            "node": "Confirmar Gasto Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Existe empleado?": {
      "main": [
        [
          {
            "node": "Crear Gasto Simplificado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Empleado No Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Fichaje?": {
      "main": [
        [
          {
            "node": "Consultar Usuario Fichaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Usuario Fichaje": {
      "main": [
        [
          {
            "node": "Construir Mensaje Fichaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Construir Mensaje Fichaje": {
      "main": [
        [
          {
            "node": "Obtener Employee ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Employee ID": {
      "main": [
        [
          {
            "node": "Extraer Employee ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Employee ID": {
      "main": [
        [
          {
            "node": "Buscar empleado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Fichaje en Odoo": {
      "main": [
        [
          {
            "node": "Procesar Respuesta Fichaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Respuesta Fichaje": {
      "main": [
        [
          {
            "node": "Enviar Fichaje Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Fichaje Telegram": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Fecha Odoo": {
      "main": [
        [
          {
            "node": "Buscar sesión abierta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar empleado": {
      "main": [
        [
          {
            "node": "Extraer empleado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer empleado": {
      "main": [
        [
          {
            "node": "Normalizar Fecha Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar sesión abierta": {
      "main": [
        [
          {
            "node": "Decidir Entrada o Salida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Decidir Entrada o Salida": {
      "main": [
        [
          {
            "node": "¿Es salida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es salida?": {
      "main": [
        [
          {
            "node": "Cerrar Sesión",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Registrar Fichaje en Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cerrar Sesión": {
      "main": [
        [
          {
            "node": "Procesar Respuesta Fichaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Admin Envio Masivos?": {
      "main": [
        [
          {
            "node": "¿Admin Envio Masivos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-02-18T07:38:00.953Z",
  "id": "oVkVDlKCeCfF8zPt",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "Chatbot Partes Trabajo",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// ROUTER INTELIGENTE - Detecta confirmaciones y consulta memoria\nconst respuestaAgent = $json;\nconst chatId = respuestaAgent.chat_id;\n\n// =============================\n// 0) RESPUESTA REAL DEL NODO ANTERIOR (FIX)\n// =============================\nconst Procesar_Respuesta = 'Procesar Respuesta';\n\nconst safeFirstJson = (nodeName) => {\n  try { return $items(nodeName, 0)?.[0]?.json ?? null; } catch { return null; }\n};\n\nconst prevNode = safeFirstJson(Procesar_Respuesta) || {};\nconst respuestaRealAnterior =\n  (typeof respuestaAgent.respuesta_usuario === 'string' && respuestaAgent.respuesta_usuario.trim())\n    ? respuestaAgent.respuesta_usuario.trim()\n    : (typeof prevNode.respuesta_usuario === 'string' && prevNode.respuesta_usuario.trim())\n      ? prevNode.respuesta_usuario.trim()\n      : '';\n\n// =============================\n// MEMORIA desde PostgreSQL\n// =============================\nconst datosConMemoria = $('Preparar Datos AI Agent').first().json;\n\nconst parseJSONSafe = (v) => {\n  try { return typeof v === 'string' ? JSON.parse(v) : (v || {}); }\n  catch { return {}; }\n};\n\nlet memoria = {\n  esperando_confirmacion: datosConMemoria.esperando_confirmacion,\n  datos_pendientes_raw: datosConMemoria.datos_pendientes,\n  datos_pendientes: parseJSONSafe(datosConMemoria.datos_pendientes),\n};\n\nconsole.log('🎯 === ROUTER INTELIGENTE ===');\nconsole.log('📥 Acción recibida:', respuestaAgent.accion);\nconsole.log('💬 Mensaje usuario:', respuestaAgent.mensaje_usuario || respuestaAgent.mensaje_original);\nconsole.log('🧠 Memoria PostgreSQL:', JSON.stringify(memoria, null, 2));\nconsole.log('✅ Respuesta real anterior:', respuestaRealAnterior);\n\n// =============================\n// DETECTAR CONFIRMACIONES INTELIGENTES\n// =============================\nlet accionFinal = respuestaAgent.accion;\n\nlet datosFinales = {\n  ...respuestaAgent,\n  ...(respuestaRealAnterior ? { respuesta_usuario: respuestaRealAnterior } : {}),\n};\n\n// Helpers (SOLO UNA VEZ)\nconst norm = (s) =>\n  String(s || '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim();\n\nconst msgRaw = (\n  respuestaAgent.mensaje_original ||\n  respuestaAgent.mensaje_usuario ||\n  respuestaAgent.text ||\n  respuestaAgent.mensaje ||\n  ''\n).trim();\n\nconst msg = norm(msgRaw);\n\nconst isYes = ['si', 'sí', 'vale', 'ok', 'perfecto', 'adelante', 'confirmo', 'confirmar', 'hazlo', 'de acuerdo']\n  .some(w => msg.includes(norm(w)));\n\nconst isNo  = ['no', 'cancelar', 'cancela', 'anula', 'parar', 'nada']\n  .some(w => msg.includes(norm(w)));\n\nconst esConfirmacion = isYes;\nconst esNegacion = isNo;\n\n// ✅ CANCELACIÓN DURA (siempre)\nconst cancelHardPhrases = [\n  'cancelar',\n  'cancela',\n  'cancela la tarea',\n  'cancelar tarea',\n  'cancela la operacion',\n  'cancelar operacion',\n  'no quiero seguir',\n  'resetea',\n  'reset',\n  'reinicia',\n  'borra memoria',\n  'borrar memoria',\n  'olvida'\n];\n\nconst esCancelacionDura = cancelHardPhrases.some(p => msg.includes(norm(p)));\n\nif (esCancelacionDura) {\n  // 🔥 limpia memoria legacy global\n  if (chatId) {\n    const contextoKey = `memoria_${chatId}`;\n    try { delete global[contextoKey]; } catch {}\n  }\n\n  return {\n    ...respuestaAgent,\n    accion: 'mensaje_bienvenida', // o 'conversar'\n    respuesta_usuario: '👌 He cancelado y he reseteado el contexto. ¿Qué necesitas ahora?',\n    borrar_memoria: true,\n\n    // ✅ para que tu UPDATE/guardado en Postgres lo deje a NULL/vacío\n    limpiar_confirmacion: true,\n    esperando_confirmacion: null,\n    ultimo_mensaje_bot: null,\n    datos_pendientes: null,\n  };\n}\n\n// ===============================\n// 1) PRIORIDAD: Confirmaciones FSM\n// ===============================\nif (memoria.esperando_confirmacion === 'confirmar_tarea_unica') {\n\n  if (esNegacion) {\n    accionFinal = 'conversar';\n    datosFinales = {\n      ...datosFinales,\n      accion: 'conversar',\n      respuesta_usuario: '✅ Vale, no registro el parte.',\n      borrar_memoria: true,\n    };\n  }\n  else if (esConfirmacion) {\n    const pendientes = memoria.datos_pendientes || {};\n    const dp = pendientes.datos_parte || {};\n\n    accionFinal = 'registrar_tarea';\n    datosFinales = {\n      ...datosFinales,\n      accion: 'registrar_tarea',\n      tarea: pendientes.tarea_nombre,\n      tarea_id: pendientes.tarea_id,\n      proyecto_id: pendientes.proyecto_id,\n      proyecto_nombre: pendientes.proyecto_nombre,\n\n      // ✅ travel se conserva (prioridad: datos_parte -> agent -> 0)\n      travel_distance_km: dp.travel_distance_km ?? respuestaAgent.travel_distance_km ?? 0,\n      travel_time_hours: dp.travel_time_hours ?? respuestaAgent.travel_time_hours ?? 0,\n\n      // ✅ SIEMPRE pasar datos_parte completo (dp)\n      datos_parte: dp,\n      origen_confirmacion: 'tarea_unica',\n    };\n  }\n  else {\n    accionFinal = 'conversar';\n    datosFinales = {\n      ...datosFinales,\n      accion: 'conversar',\n      respuesta_usuario: 'Respóndeme \"sí\" para registrar el parte o \"no\" para cancelar.',\n    };\n  }\n}\n\nelse if (memoria.esperando_confirmacion === 'elegir_tarea_multiple') {\n  const pendientes = memoria.datos_pendientes || {};\n  const dp = pendientes.datos_parte || {};\n  const opciones = pendientes.tareas_opciones || [];\n\n  if (esNegacion) {\n    accionFinal = 'conversar';\n    datosFinales = {\n      ...datosFinales,\n      accion: 'conversar',\n      respuesta_usuario: '✅ Vale, cancelado. No registro nada.',\n      borrar_memoria: true,\n    };\n  }\n  else {\n    const n = parseInt(msgRaw, 10);\n\n    if (Number.isFinite(n) && n >= 1 && n <= opciones.length) {\n      const t = opciones[n - 1];\n\n      accionFinal = 'registrar_tarea';\n      datosFinales = {\n        ...datosFinales,\n        accion: 'registrar_tarea',\n        tarea: t.nombre_completo,\n        tarea_id: t.id,\n        proyecto_id: t.proyecto_id,\n        proyecto_nombre: t.proyecto_nombre,\n\n        // ✅ travel se conserva\n        travel_distance_km: dp.travel_distance_km ?? respuestaAgent.travel_distance_km ?? 0,\n        travel_time_hours: dp.travel_time_hours ?? respuestaAgent.travel_time_hours ?? 0,\n\n        datos_parte: dp,\n        origen_confirmacion: 'tarea_multiple_numero',\n      };\n    }\n    else {\n      const matches = opciones.filter(o => {\n        const nom = norm(o.nombre_completo);\n        return nom === msg || nom.includes(msg) || msg.includes(nom);\n      });\n\n      if (matches.length === 1) {\n        const t = matches[0];\n\n        accionFinal = 'registrar_tarea';\n        datosFinales = {\n          ...datosFinales,\n          accion: 'registrar_tarea',\n          tarea: t.nombre_completo,\n          tarea_id: t.id,\n          proyecto_id: t.proyecto_id,\n          proyecto_nombre: t.proyecto_nombre,\n\n          // ✅ travel se conserva\n          travel_distance_km: dp.travel_distance_km ?? respuestaAgent.travel_distance_km ?? 0,\n          travel_time_hours: dp.travel_time_hours ?? respuestaAgent.travel_time_hours ?? 0,\n\n          datos_parte: dp,\n          origen_confirmacion: 'tarea_multiple_nombre',\n        };\n      }\n      else if (matches.length > 1) {\n        accionFinal = 'conversar';\n        datosFinales = {\n          ...datosFinales,\n          accion: 'conversar',\n          respuesta_usuario: 'Hay varias tareas parecidas. Responde con el número (1,2,3...).',\n        };\n      }\n      else {\n        accionFinal = 'conversar';\n        datosFinales = {\n          ...datosFinales,\n          accion: 'conversar',\n          respuesta_usuario: `No identifico esa tarea. Responde con el número (1 a ${opciones.length}).`,\n        };\n      }\n    }\n  }\n}\n\nelse if (memoria.esperando_confirmacion === 'elegir_tarea_lopd') {\n  const pendientes = memoria.datos_pendientes || {};\n  const opciones = pendientes.tareas_opciones || [];\n\n  if (esNegacion) {\n    accionFinal = 'conversar';\n    datosFinales = {\n      ...datosFinales,\n      accion: 'conversar',\n      respuesta_usuario: '✅ Vale, cancelado.',\n      borrar_memoria: true,\n      limpiar_confirmacion: true,\n      esperando_confirmacion: null,\n      datos_pendientes: null,\n    };\n  }\n  else {\n    const n = parseInt(msgRaw, 10);\n    if (Number.isFinite(n) && n >= 1 && n <= opciones.length) {\n      const t = opciones[n - 1];\n      const baseUrl = 'https://mchecagoshawk-webinar.odoo.com';\n      const urlLopd = `${baseUrl}/firma-lopd/${t.id}`;\n\n      accionFinal = 'conversar';\n      datosFinales = {\n        ...datosFinales,\n        accion: 'conversar',\n        respuesta_usuario: `✅ Aquí tienes el enlace para firmar la LOPD:\\n\\n${urlLopd}\\n\\nAbre el enlace en tu navegador (debes estar conectado a Odoo).`,\n        borrar_memoria: true,\n        limpiar_confirmacion: true,\n        esperando_confirmacion: null,\n        datos_pendientes: null,\n      };\n    }\n    else {\n      accionFinal = 'conversar';\n      datosFinales = {\n        ...datosFinales,\n        accion: 'conversar',\n        respuesta_usuario: `Responde con el número (1 a ${opciones.length}) para obtener el enlace de firma LOPD.`,\n      };\n    }\n  }\n}\n\n// ===============================\n// 1b) Confirmaciones USO/LIBERAR COCHE\n// ===============================\nelse if (memoria.esperando_confirmacion === 'confirmar_usar_coche_cambio') {\n  const pendientes = memoria.datos_pendientes || {};\n  if (esNegacion) {\n    accionFinal = 'conversar';\n    datosFinales = { ...datosFinales, accion: 'conversar', respuesta_usuario: '✅ Vale, no cambio el coche.', borrar_memoria: true };\n  } else if (esConfirmacion) {\n    accionFinal = 'uso_liberar_coche';\n    datosFinales = { ...datosFinales, accion: 'uso_liberar_coche', tipo_accion: 'usar', coche_id: pendientes.vehicle_id, coche_nombre: pendientes.vehicle_name, partner_id: pendientes.partner_id, confirmar_cambio: true };\n  } else {\n    accionFinal = 'conversar';\n    datosFinales = { ...datosFinales, accion: 'conversar', respuesta_usuario: '¿Quieres que asigne ese coche a tu usuario? Responde sí o no.' };\n  }\n}\nelse if (memoria.esperando_confirmacion === 'elegir_coche_liberar') {\n  const pendientes = memoria.datos_pendientes || {};\n  const opciones = pendientes.coches_mios || [];\n  if (esNegacion) {\n    accionFinal = 'conversar';\n    datosFinales = { ...datosFinales, accion: 'conversar', respuesta_usuario: '✅ Vale, no libero ningún coche.', borrar_memoria: true };\n  } else if (msg.includes('ambos') || msg.includes('los dos') || msg.includes('todos')) {\n    accionFinal = 'uso_liberar_coche';\n    datosFinales = { ...datosFinales, accion: 'uso_liberar_coche', tipo_accion: 'liberar', vehicle_ids: opciones.map(c => c.id), liberar_ambos: true };\n  } else {\n    const n = parseInt(msgRaw, 10);\n    if (Number.isFinite(n) && n >= 1 && n <= opciones.length) {\n      const c = opciones[n - 1];\n      accionFinal = 'uso_liberar_coche';\n      datosFinales = { ...datosFinales, accion: 'uso_liberar_coche', tipo_accion: 'liberar', vehicle_ids: [c.id], coche_nombre: c.name };\n    } else {\n      const match = opciones.find(o => norm(o.name).includes(msg) || msg.includes(norm(o.name)));\n      if (match) {\n        accionFinal = 'uso_liberar_coche';\n        datosFinales = { ...datosFinales, accion: 'uso_liberar_coche', tipo_accion: 'liberar', vehicle_ids: [match.id], coche_nombre: match.name };\n      } else {\n        accionFinal = 'conversar';\n        datosFinales = { ...datosFinales, accion: 'conversar', respuesta_usuario: `Responde con el número (1 a ${opciones.length}) o \"ambos\" para liberar todos.` };\n      }\n    }\n  }\n}\n\n// ===============================\n// 2) Otras confirmaciones genéricas\n// ===============================\nelse if (memoria.esperando_confirmacion && memoria.datos_pendientes_raw) {\n  if (esConfirmacion) {\n    // ... tu lógica existente sin tocar ...\n  }\n}\n\n// ===============================\n// 3) Guardados legacy\n// ===============================\nif (accionFinal === 'registrar_horas') {\n  const contextoKey = `memoria_${chatId}`;\n  let memoriaGlobal = global[contextoKey] || {};\n  memoriaGlobal.proyecto_anterior = respuestaAgent.proyecto;\n  memoriaGlobal.tarea_anterior = respuestaAgent.tarea;\n  memoriaGlobal.ultima_accion = 'registrar_horas';\n  global[contextoKey] = memoriaGlobal;\n}\n\nconsole.log('🎯 ACCIÓN FINAL:', accionFinal);\nconsole.log('📊 DATOS FINALES:', JSON.stringify(datosFinales, null, 2));\n\nreturn datosFinales;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4256,
        -9552
      ],
      "id": "65697f6f-69b2-4942-923f-5e5fb80f58ee",
      "name": "Router de Acciones FIXED"
    },
    {
      "parameters": {
        "jsCode": "// 📋 REGISTRAR PARTE DE TRABAJO EN ODOO - PROYECTO FSM\n\nconst {\n  tarea_id,\n  tarea,\n  proyecto_id,\n  proyecto_nombre,\n  datos_parte,\n  chat_id,\n  borrar_memoria\n} = $json;\n\nconsole.log('📝 === REGISTRAR TAREA ODOO ===');\nconsole.log('🎯 Datos recibidos:', JSON.stringify($json, null, 2));\n\n// ✅ Capturar mensaje original del operario (Telegram / contexto)\nconst mensajeOriginal =\n  $json.mensaje_usuario_original ||\n  $json.transcripcion_original ||\n  datos_parte?.transcripcion_original ||\n  datos_parte?.mensaje_usuario_original ||\n  $json.message?.text ||\n  $json.body?.message?.text ||\n  $json.text ||\n  '';\n\nconsole.log('🗣️ Mensaje original capturado:', mensajeOriginal);\n\n// ✅ Validar datos mínimos\nif (!tarea_id) {\n  return {\n    exito: false,\n    error: 'Falta tarea_id para registrar',\n    respuesta_usuario: '❌ Error: No puedo registrar sin ID de tarea. Contacta soporte.',\n    chat_id,\n    mensaje_usuario_original: mensajeOriginal,\n\n    // 👇 CLAVE: no pierdas el contexto\n    datos_parte: datos_parte || {},\n  };\n}\n\n// ✅ VALIDACIÓN CRÍTICA: Horas REQUERIDAS\n// Soportar ambos casos: \n// 1. datos_parte.horas (cuando llega desde flujo normal inicial)\n// 2. $json.horas (cuando llega desde agent después que usuario envía horas)\nconst horasRaw = $json.horas !== undefined ? $json.horas : (datos_parte?.horas || 0);\nconst horas = Number(horasRaw);\n\nconsole.log('🕐 Validación de horas:');\nconsole.log('   horasRaw:', horasRaw, '(tipo:', typeof horasRaw, ')');\nconsole.log('   horas convertidas:', horas);\nconsole.log('   Number.isFinite(horas):', Number.isFinite(horas));\nconsole.log('   horas > 0:', horas > 0);\n\nif (!Number.isFinite(horas) || horas <= 0) {\n  // 🔴 NO HAY HORAS VÁLIDAS - Devolver error para que se pida al usuario\n  console.log('❌ VALIDACIÓN FALLIDA: Horas no son válidas');\n  return {\n    exito: false,\n    validacion_error: 'falta_horas',\n    error: 'Horas inválidas (debe ser > 0)',\n    respuesta_usuario: '⏰ Te faltan las horas. Introducelas para poder continuar con el registro.',\n    chat_id,\n    mensaje_usuario_original: mensajeOriginal,\n    tarea: tarea || 'Tarea',\n    proyecto_nombre: proyecto_nombre || 'Proyecto',\n    tarea_id,\n    proyecto_id,\n    datos_parte: datos_parte || {},\n    borrar_memoria: false,  // NO borrar, guardar para que el usuario proporcione horas\n  };\n}\n\nconsole.log('✅ VALIDACIÓN EXITOSA: Horas válidas -', horas);\n\n// 🚗 EXTRACCIÓN DE DATOS DE DESPLAZAMIENTO\nconst travel_distance_km = Number($json.travel_distance_km || datos_parte?.travel_distance_km || 0);\nconst travel_time_hours = Number($json.travel_time_hours || datos_parte?.travel_time_hours || 0);\n\nconsole.log('🚗 Travel distance_km:', travel_distance_km);\nconsole.log('⏱️ Travel time_hours:', travel_time_hours);\n\n\nconsole.log('✅ Datos validados correctamente');\nconsole.log('   Tarea:', tarea);\nconsole.log('   Horas:', horas);\nconsole.log('   Proyecto:', proyecto_nombre);\n\n// ✅ Construir descripción completa con productos\n// Soportar descripción desde datos_parte o directamente desde $json\nlet descripcionCompleta = String($json.descripcion || datos_parte?.descripcion || 'Trabajo registrado').trim();\n\n// Soportar productos desde datos_parte o directamente desde $json\nconst productos = Array.isArray($json.productos) ? $json.productos : (Array.isArray(datos_parte?.productos) ? datos_parte.productos : []);\nif (productos.length > 0 && typeof productos !== 'number') {  // Verificar que no sea solo el número 0\n  const listaProductos = productos\n    .map(p => `- ${p.nombre || 'Producto sin nombre'}: ${p.cantidad || 1} unidad(es)`)\n    .join('\\n');\n\n  descripcionCompleta = `${descripcionCompleta}\\n\\n📦 MATERIALES/PRODUCTOS:\\n${listaProductos}`;\n  console.log('📦 Productos agregados a descripción');\n}\n\n// ✅ Agregar cliente si existe (desde $json o datos_parte)\nconst cliente = $json.cliente || datos_parte?.cliente || 'interno';\ndescripcionCompleta = `${descripcionCompleta}\\n\\n👤 Cliente: ${cliente}`;\n\n// (Opcional) dejar también trazado el presupuesto en texto (NO sustituye \"Productos mencionados\")\nif (Number(datos_parte?.horas_presupuestadas || 0) > 0) {\n  descripcionCompleta = `${descripcionCompleta}\\n\\n🧾 Horas presupuestadas: ${Number(datos_parte.horas_presupuestadas)}h`;\n}\n\nconsole.log('📝 Descripción final:', descripcionCompleta);\n\n// ✅ Construir datos para registrar (seed)\nconst hoy = new Date().toISOString().split('T')[0];\n\nconst datosTimesheet = {\n  name: `${tarea || 'Tarea'} - ${horas}h`,\n  project_id: proyecto_id,\n  task_id: tarea_id,\n  unit_amount: horas,\n  description: descripcionCompleta,\n  date: hoy\n,\n  travel_distance_km: travel_distance_km,\n  travel_time_hours: travel_time_hours};\n\nconsole.log('✅ Datos timesheet preparados:', JSON.stringify(datosTimesheet, null, 2));\n\n// ⚠️ Este nodo SOLO prepara el “seed” (simulado)\nconst timesheet_id = Math.floor(Math.random() * 1000000);\n\nconsole.log('✅ Timesheet (simulado) creado con ID:', timesheet_id);\n\n// ✅ Respuesta al usuario (informativa)\nconst respuesta_usuario =\n  `✅ **PARTE REGISTRADO CORRECTAMENTE**\\n\\n` +\n  `📌 Tarea: ${tarea || '—'}\\n` +\n  `🕐 Horas: ${horas}h\\n` +\n  `📂 Proyecto: ${proyecto_nombre || '—'}\\n` +\n  `👤 Cliente: ${cliente}\\n` +\n  `📋 ID Timesheet: #${timesheet_id}\\n` +\n  `📅 Fecha: ${hoy}`;\n\nconsole.log('📤 Respuesta usuario:', respuesta_usuario);\n\n// ✅ ÚNICO return final\nreturn {\n  exito: true,\n  timesheet_id,\n  respuesta_usuario,\n  limpiar_confirmacion: true,\n  borrar_memoria: borrar_memoria || false,\n  chat_id: chat_id,\n\n  // ✅ esto lo consumirá \"Registrar Horas Directo FSM\" como seed\n  datos_registrados: datosTimesheet,\n\n  // ✅ clave para transcripción real\n  mensaje_usuario_original: mensajeOriginal,\n  \n  // 🚗 Travel fields propagados al siguiente nodo\n  travel_distance_km: travel_distance_km,\n  travel_time_hours: travel_time_hours,\n\n  datos_parte: {\n  ...(datos_parte || {}),\n  // si vienen productos corregidos en el input, mételos aquí\n  productos: Array.isArray($json.productos) && $json.productos.length ? $json.productos :   (datos_parte?.productos || []),\n  },\n  // (opcional) duplicado útil para debug rápido\n  is_diagnosis_task: !!datos_parte?.is_diagnosis_task,\n  ticket_type: datos_parte?.ticket_type || '',\n  horas_presupuestadas: Number(datos_parte?.horas_presupuestadas || 0),\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5136,
        -9488
      ],
      "id": "c0198e38-f193-4284-9c2b-d33d4bac0e59",
      "name": "Registrar Tarea Odoo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "falta-horas-check",
              "leftValue": "={{$json.validacion_error}}",
              "rightValue": "falta_horas",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        5328,
        -9488
      ],
      "id": "66710b71-6700-4e8f-9646-741a7321a9df",
      "name": "¿Falta Horas?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n\nSET \n  esperando_confirmacion = 'falta_horas_registrar_tarea',\n  ultimo_mensaje_bot = $2,\n  datos_pendientes = $3,\n  updated_at = NOW()\nWHERE chat_id = $1::bigint;",
        "options": {
          "queryReplacement": "={{ [$json.chat_id, $json.respuesta_usuario, JSON.stringify({tarea: $json.tarea, proyecto_nombre: $json.proyecto_nombre, tarea_id: $json.tarea_id, proyecto_id: $json.proyecto_id, travel_distance_km: $json.travel_distance_km || 0, travel_time_hours: $json.travel_time_hours || 0, datos_parte: $json.datos_parte})] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5568,
        -9696
      ],
      "id": "6fc07e6e-244b-47d4-bfdd-211e91f653e8",
      "name": "Guardar Estado Falta Horas"
    },
    {
      "parameters": {
        "chatId": "={{$('Registrar Tarea Odoo').first().json.chat_id}}",
        "text": "={{$('Registrar Tarea Odoo').first().json.respuesta_usuario}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5744,
        -9696
      ],
      "id": "3f622ca5-6d64-45fa-9209-38266bb9468d",
      "name": "Solicitar Horas",
      "webhookId": "falta-horas-webhook-001"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.3,
          "topP": 0.9
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3728,
        -9344
      ],
      "id": "a21fdd6f-fa5c-4bbc-95e5-94eab9b3e77e",
      "name": "Google Gemini Chat Model"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un asistente virtual para Odoo con el estilo de comunicación de Jorge, un consultor especializado en automatización con IA y Odoo. Analiza este mensaje y responde en JSON.\n\n**MENSAJE DEL USUARIO (ORIGINAL):** {{ $json.mensaje_usuario_original || $json.mensaje_usuario }}\n**MENSAJE DEL USUARIO (NORMALIZADO):** {{ $json.mensaje_usuario }}\n**USUARIO:** {{ $json.user_name || 'Usuario' }} (ID: {{ $json.user_id || 'unknown' }})\n**TIPO:** {{ $json.es_audio ? 'Audio transcrito' : 'Texto' }}\n**ODOO_USER (login/email):** {{ $json.odoo_user || 'desconocido' }}\n\n\n{% if $json.es_audio %}\n🎤 **MENSAJE DE VOZ TRANSCRITO:** {{ $json.mensaje_usuario }}\n{% endif %}\n\nAÑO_ACTUAL: {{ (new Date()).getFullYear() }}\n\n{% set PERFIL = ($json.cliente_perfil || {}) %}\n{% set ODOO_USER = ($json.odoo_user || PERFIL.login || PERFIL.email || $json.user_mail || null) %}\n{% set CLIENTE_SUGERIDO = (PERFIL.name || $json.user_name || '').toString().trim() %}\n\n\n**MEMORIA DEL USUARIO (CONTEXTO ACTUAL):**\n{% if $json.esperando_confirmacion %}\n🔄 **ESPERANDO CONFIRMACIÓN PARA:** {{ $json.esperando_confirmacion }}\n📝 **ÚLTIMO MENSAJE BOT:** {{ $json.ultimo_mensaje_bot }}\n📋 **DATOS PENDIENTES:** {{ $json.datos_pendientes | tojsonpretty }}\n**EXCEPCIONES:** Si el usuario dice \"cancelar operacion\", \"no quiero seguir\", \"resetea\", \"cancela\", u otro mensaje parecido con cancelar la operacion borras la memoria, borras ÚLTIMO MENSAJE BOT y mandas mensaje de bienvenida. \n{% endif %}\n\n**📌 CONTEXTO GENERAL - ESTILO AzerionBot**\nSoy consultor en automatización con IA y Odoo, especializado en eficiencia tecnológica para empresas. Trabajo con pymes industriales, empresas de servicios y startups tecnológicas. Mi objetivo es generar leads, construir autoridad, abrir conversaciones, educar al mercado y posicionarme como una voz experta en tecnología, IA y herramientas como n8n. Me dirijo principalmente a decisores de negocio y tecnología, mostrando con claridad cómo la automatización puede transformar procesos reales.\n\n**🧠 ACTÚA COMO UN COPYWRITER ESPECIALIZADO EN COMUNICACIÓN TECNOLÓGICA**\nEres AzerionBot, un profesional directo, técnico pero cercano, que prioriza la claridad y la confianza. Su forma de escribir se basa en construir relaciones reales con clientes, explicar conceptos con naturalidad y mostrar el valor de forma transparente, sin adornos innecesarios.\n\n**👨‍💼 IDENTIDAD PERSONAL**\n* Hombre, 33 años, madrileño.\n* Más de 10 años de experiencia en tecnología y negocios.\n* Apasionado de la tecnología que genera impacto real.\n* Sagaz, directo, crítico y auténtico.\n\n**🗣️ TONO**\n* Profesional sin rigidez. Habla claro, con naturalidad, como si escribieras un correo real a un cliente.\n* Cercano pero sin adornos. Nada de exageraciones ni frases hechas. No busca sonar \"moderno\" ni intentar impresionar con jerga.\n* Reflexivo, observador y con criterio propio. El texto debe sonar como alguien que piensa en voz alta con lógica y experiencia.\n* Se puede usar una ligera ironía o comentarios personales, si aporta cercanía.\n* Evita palabras en inglés salvo que sean necesarias (ej. nombres propios, conceptos como \"Data Driven, Business Intelligence,etc...\"). Si existe una forma clara de decirlo en castellano, úsala.\n* Siempre orientado a construir confianza. No se vende humo, se aportan hechos.\n* Se prioriza la lógica, los beneficios tangibles y la claridad técnica explicada sin jerga.\n\n**✨ ESTILO ESCRITO**\n* Frases cortas y naturales. Nada rebuscado ni inflado. Como si lo dijeras hablando.\n* Tono directo, sin vueltas. Si hay un problema, se menciona. Si hay una ventaja, se justifica.\n* Expone ideas como una secuencia de pensamiento: plantea una observación, la analiza y ofrece una postura razonable.\n* Incluye ejemplos concretos o referencias a situaciones reales (sin sonar como manual).\n* Si el contenido es técnico, explícalo como si se lo contaras a alguien que no lo domina (pero con respeto).\n* Uso puntual de MAYÚSCULAS para énfasis y estructura clara.\n* Cierre con reflexión o pregunta que invite al lector a compartir su opinión, además de posibles CTAs.\n\n**🌟 PÚBLICO OBJETIVO**\nConecta con:\nCTOs, COOs, CIOs, CMOs, CFOs, Tech Leads, project managers, responsables de BI, operaciones, supply chain, fundadores de eCommerce, gerentes de pymes industriales y consultores IT.\n\nHabla como a un colega que sabe de lo que habla, entiende los retos y ofrece soluciones claras: automatización, integración, eficiencia y escalabilidad. Nada de discursos vacíos.\n\n**RECONOCIMIENTO DE PATRONES - EVALÚA SI EL MENSAJE CONTIENE:**\n- ✅ Palabras clave de REGISTRO: \"registrar\", \"parte\", \"horas\", \"proyecto\", \"tarea\"\n- ✅ Palabras clave de CREACIÓN: \"crear\", \"nuevo\", \"proyecto\", \"tarea\"\n- ✅ Palabras clave de CONSULTA: \"cuánto\", \"precio\", \"stock\", \"ventas\", \"contacto\"\n- ✅ Palabras clave de CONSULTA HORAS: \"cuántas horas\", \"horas dedicadas\", \"tiempo dedicado\", \"tiempo invertido\"\n- ✅ Palabras clave de CONSULTA TEMPORAL: \"hoy\", \"ayer\", \"esta semana\", \"semana pasada\", \"este mes\", \"mes pasado\", \"qué ha hecho\", \"qué hice\"\n- ✅ Palabras clave de ESTADO DE PROYECTO:\n  Frases como: \"estado del proyecto\", \"estado proyecto\", \"cómo va el proyecto\", \n  \"situación del proyecto\", \"progreso del proyecto\", \"avance del proyecto\",\n  \"fases/etapas del proyecto\", \"tareas del proyecto\", \"resumen/detalles/dashboard del proyecto\".\n  - Si aparece junto a \"proyecto\" + <nombre> → intención = consultar_estado_proyecto.\n  - Si el mensaje menciona \"registros\", \"timesheets\", \"partes de trabajo\", \"horas registradas\"\n    → incluir_registros = true.\n  - Si el mensaje indica un periodo tipo \"últimos 30 días\" → dias = 30.\n    También mapea expresiones:\n      \"esta semana\" → 7, \"semana pasada\" → 7, \n      \"este mes\" → 31, \"mes pasado\" → 31.\n- ✅ Palabras clave de MODIFICACIÓN: \"modificar\", \"cambiar\", \"editar\", \"actualizar\", \"corregir\", \"pon\", \"quitar\", \"eliminar\", \"añadir\" (contactos)\n- ✅ Palabras de CONFIRMACIÓN: \"sí\", \"si\", \"vale\", \"adelante\", \"confirmar\", \"crear\", \"ok\", \"perfecto\"\n- ✅ Palabras clave de PARTE+STOCK: si aparecen a la vez intención de registrar horas\n  ( \"registrar\" | \"parte\" | \"horas\" )  y mención de materiales\n  ( \"material\" | \"materiales\" | \"producto\" | \"productos\" | \"stock\" | \"he usado\" |\n    \"usé\" | \"he consumido\" | \"consumí\" | \"utilicé\" ), entonces → registrar_parte_y_stock\n\n\n**🧾 REGLAS CRÍTICAS: DIAGNÓSTICO / PRESUPUESTO (FSM)**\n\n🔎 IMPORTANTE:\n- Usa **MENSAJE NORMALIZADO** para detectar patrones (sin tildes, minúsculas).\n- Usa **MENSAJE ORIGINAL** para construir descripciones y textos finales \"bonitos\".\n\n📌 DEFINICIONES:\n- Horas TRABAJADAS = horas ya realizadas (ej: \"he estado 5 horas\", \"he trabajado 3 horas\").\n- Horas PRESUPUESTADAS = horas estimadas para ejecutar el trabajo (ej: \"presupuesto 10 horas\", \"vamos a necesitar 8 horas\", \"hara falta 12 horas\").\n- Productos/MATERIALES en contexto de presupuesto = **NO son consumidos**, son **mencionados** (diagnóstico).\n\n🔝 PRIORIDAD ABSOLUTA (pisa TODO lo demás):\n- Si detectas presupuesto/estimación (en texto o audio), NO uses \"registrar_horas\".\n- Aunque sea audio, si hay presupuesto → la acción correcta es **\"registrar_parte_y_stock\"**.\n\n✅ DETECTAR PRESUPUESTO / DIAGNÓSTICO:\nSi el mensaje (normalizado) contiene palabras o patrones como:\n- \"presupuesto\", \"presupuest\", \"estimacion\", \"estimar\", \"aprox\", \"aproximadamente\"\n- \"vamos a necesitar\", \"necesitaremos\", \"se necesitaran\", \"hara falta\", \"hace falta\"\n- \"para presupuestar\"\n- \"he revisado\" + (\"necesitar\"|\"hara falta\"|\"vamos a necesitar\")\n→ entonces DEBES tratarlo como **DIAGNÓSTICO**.\n\n🎯 RESULTADO OBLIGATORIO EN DIAGNÓSTICO:\n- `\"accion\": \"registrar_parte_y_stock\"`\n- `\"diagnostico_detectado\": true`\n- `\"horas\"` = SOLO horas trabajadas (si existen)\n- `\"horas_presupuestadas\"` = SOLO horas estimadas/presupuestadas (si existen)\n- `\"productos\"` = materiales mencionados (aunque no sean consumidos)\n- Si solo hay presupuesto y no hay trabajo real: `\"horas\": 0` y rellena `\"horas_presupuestadas\"`.\n\n🧠 REGLA CLAVE DE NO-CONFUSIÓN:\n- Si una frase menciona horas pero está claramente en contexto de estimación (\"presupuesto\", \"vamos a necesitar\", \"hara falta\"), esas horas VAN a `\"horas_presupuestadas\"`, NO a `\"horas\"`.\n\n🧰 MATERIALES EN DIAGNÓSTICO:\n- Todo lo que suene a \"vamos a necesitar X productos/materiales\" o \"hará falta X\" → va en `\"productos\"` como mencionados.\n- NO lo trates como stock consumido real.\n- No inventes tipo_accion_stock (puedes omitirlo o dejarlo vacío).\n\n🧾 EJEMPLO (diagnóstico):\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"diagnostico_detectado\": true,\n  \"proyecto\": \"Servicio de campo\",\n  \"tarea\": \"Diagnóstico - Nueva instalación\",\n  \"horas\": 5,\n  \"horas_presupuestadas\": 10,\n  \"descripcion\": \"Revisión de instalación y propuesta\",\n  \"productos\": [\n    { \"nombre\": \"Cable UTP\", \"cantidad\": 20 },\n    { \"nombre\": \"Conector RJ45\", \"cantidad\": 8 }\n  ],\n  \"cliente\": \"interno\",\n  \"travel_distance_km\": 0,\n  \"travel_time_hours\": 0,\n  \"respuesta_usuario\": \"✅ Vale. Registro el diagnóstico: 5h trabajadas + presupuesto 10h y materiales mencionados. ¿Procedo?\"\n}\n\n\n**DATOS BÁSICOS:**\n- Usuario actual procesando mensaje\n- Sistema listo para registro de horas y gestión de proyectos\n\n**INSTRUCCIONES CRÍTICAS PARA TRANSCRIPCIONES DE AUDIO:**\n- SIEMPRE extrae información de registro de horas de las transcripciones de audio\n- Busca patrones como: \"registrar\", \"parte de horas\", \"proyecto\", \"tarea\", números de horas\n- Interpreta números escritos como texto: \"dos horas\" = 2, \"tres horas\" = 3, etc.\n- Si detectas solicitud de registro de horas en audio, SIEMPRE usar acción \"registrar_horas\"\n- Busca nombres de proyectos y tareas aunque estén mal transcritos\n- Si en el audio aparecen horas y también materiales/cantidades (p.ej. \"2 horas y 10 tornillos\"),\n  devuelve la acción **\"registrar_parte_y_stock\"** con los productos normalizados:\n  productos = [{ \"nombre\": \"<producto>\", \"cantidad\": <numero> }, ...]\n\n**EJEMPLOS DE TRANSCRIPCIONES DE AUDIO A RECONOCER:**\n- \"Registrar parte de horas en proyecto test N8N, tarea prueba N8N. Quiero un parte de horas de dos horas con un mensaje que sea cortar fichaje\" → registrar_horas\n- \"Quiero registrar tres horas en el proyecto Marketing Digital tarea gestión redes\" → registrar_horas\n- \"Parte de horas proyecto X tarea Y cinco horas mensaje desarrollo\" → registrar_horas\n\n**INSTRUCCIONES GENERALES:**\n- ANALIZA EL MENSAJE para entender el contexto\n- Si el usuario dice \"sí\", \"si\", \"crear\", \"adelante\" considera que está confirmando algo\n- Mantén la conversación fluida\n\n**MANEJO DE CONFIRMACIONES (CRÍTICO):**\n{% if $json.esperando_confirmacion %}\n🔥 **ATENCIÓN: EL USUARIO ESTÁ EN PROCESO DE CONFIRMACIÓN**\n\n// Para confirmaciones de TAREA (tarea_unica o elegir_tarea_multiple), \n// NO generar acción aquí - dejar que el ROUTER lo manejo\n{% if $json.esperando_confirmacion in ['confirmar_tarea_unica', 'elegir_tarea_multiple', 'elegir_tarea_lopd', 'confirmar_usar_coche_cambio', 'elegir_coche_liberar'] %}\n// ✅ El ROUTER DE ACCIONES manejará estos casos, solo devolver el mensaje\n{\n  \"accion\": \"conversar\",\n  \"respuesta_usuario\": \"Esperando tu confirmación...\",\n  \"travel_distance_km\": 0,\n  \"travel_time_hours\": 0\n}\n{% else %}\n// Para otros tipos de confirmación, generar acciones normales\n{% set ES_FSM = (\n  ($json.datos_pendientes and $json.datos_pendientes.accion_original == 'registrar_parte_y_stock')\n  or ($json.ultima_accion == 'registrar_parte_y_stock')\n) %}\n\n{% set es_fsm = ($json.datos_pendientes && $json.datos_pendientes.accion_original == 'registrar_parte_y_stock') %}\n{% set espera = $json.esperando_confirmacion %}\n\n{% if $json.esperando_confirmacion in ['modificar_pedido_detalle', 'modificar_pedido_elegir_linea'] %}\n{\n  \"accion\": \"modificar_pedido_detalle\",\n  \"detalle_modificacion\": \"{{ ($json.mensaje_usuario || $json.mensaje_usuario_original || $json.text || '').toString().trim() }}\",\n  \"chat_id\": {{ $json.chat_id }},\n  \"user_id\": {{ $json.user_id }},\n  \"user_name\": \"{{ $json.user_name || 'Usuario' }}\",\n  \"pedido_id\": {{ $json.datos_pendientes.pedido_id }},\n  \"pedido_numero\": \"{{ $json.datos_pendientes.pedido_numero }}\",\n  \"lineas\": {{ ($json.datos_pendientes.lineas || []) | tojson }},\n  \"respuesta_usuario\": \"👌 Entendido. Ajusto el pedido con lo que acabas de indicar.\"\n}\n{% else %}\n\n\n{% elif $json.esperando_confirmacion == 'falta_horas_registrar_tarea' %}\n{\n\"accion\": \"registrar_tarea\",\n\"proyecto\": \"{{ $json.datos_pendientes.proyecto_nombre || 'Servicio de campo' }}\",\n\"proyecto_id\": {{ $json.datos_pendientes.proyecto_id || 0 }},\n\"tarea\": \"{{ $json.datos_pendientes.tarea }}\",\n\"tarea_id\": {{ $json.datos_pendientes.tarea_id || 0 }},\n\"horas\": {{ (parseInt($json.mensaje_usuario) || 0) }},\n\"descripcion\": \"{{ $json.datos_pendientes.datos_parte.descripcion || 'Trabajo realizado' }}\",\n\"productos\": {{ ($json.datos_pendientes.datos_parte.productos || []) | tojson }},\n\"travel_distance_km\": {{ $json.datos_pendientes.travel_distance_km || 0 }},\n\"travel_time_hours\": {{ $json.datos_pendientes.travel_time_hours || 0 }},\n\"cliente\": \"{{ $json.datos_pendientes.cliente || 'interno' }}\",\n\"respuesta_usuario\": \"✅ Perfecto. Registraré {{ (parseInt($json.mensaje_usuario) || 0) }}h en '{{ $json.datos_pendientes.tarea }}' del proyecto '{{ $json.datos_pendientes.proyecto_nombre }}'. ¿Procedo?\"\n}\n\n{% elif $json.esperando_confirmacion == 'correccion_productos' %}\n{\n\"accion\": \"registrar_tarea\",\n\"proyecto\": \"{{ $json.datos_pendientes.proyecto || 'Servicio de campo' }}\",\n\"proyecto_id\": {{ $json.datos_pendientes.proyecto_id || $json.datos_pendientes.project_id || 0 }},\n\"tarea\": \"{{ $json.datos_pendientes.tarea }}\",\n\"tarea_id\": {{ $json.datos_pendientes.tarea_id || $json.datos_pendientes.task_id || 0 }},\n\"horas\": {{ $json.datos_pendientes.horas || 0 }},\n\"descripcion\": \"{{ $json.datos_pendientes.descripcion || 'Trabajo realizado' }}\",\n\"productos\": {% if $json.datos_pendientes.productos_validados %}{{ $json.datos_pendientes.productos_validados | tojson }}{% else %}[{\"nombre\": \"{{ ($json.mensaje_usuario) | trim }}\", \"cantidad\": 1}]{% endif %},\n\"travel_distance_km\": {{ $json.datos_pendientes.travel_distance_km || 0 }},\n\"travel_time_hours\": {{ $json.datos_pendientes.travel_time_hours || 0 }},\n\"chat_id\": {{ $json.chat_id }},\n\"db\": {{ $json.datos_pendientes.db || 'mchecagoshawk-webinar-main-28403608' }},\n\"uid\": {{ $json.datos_pendientes.uid || $json.uid || 0 }},\n\"cliente\": \"{{ $json.datos_pendientes.cliente || 'interno' }}\",\n\"respuesta_usuario\": \"✅ Perfecto. Registraré el parte con los datos guardados y el producto corregido que enviaste.\"\n}\n{% endif %}\n{% endif %}\n{% endif %}\n\n\n**CONFIRMACIÓN DETECTADA EN ESTOS CASOS:**\n1. **Confirmación EXPLÍCITA**: palabras como \"sí\", \"si\", \"vale\", \"crear\", \"adelante\", \"ok\", \"perfecto\", \"confirmar\"\n2. **Confirmación IMPLÍCITA**: usuario repite solicitud de \"registrar horas\" cuando ya está esperando confirmación\n3. **Confirmación por INSISTENCIA**: menciona \"quiero registrar\", \"registrar parte\" o similar cuando está esperando confirmación\n\n**SI DETECTAS CONFIRMACIÓN (EXPLÍCITA O IMPLÍCITA):**\n  * Si esperando_confirmacion = \"crear_proyecto_completo\" → acción: \"crear_proyecto_tarea_horas\"\n  * Si esperando_confirmacion = \"crear_tarea_solamente\" → acción: \"crear_tarea_y_horas\"\n  * Si esperando_confirmacion = \"crear_proyecto\" → acción: \"crear_proyecto_tarea_horas\"\n  * Si esperando_confirmacion = \"crear_tarea_y_registrar\" → acción: \"crear_tarea_y_horas\"\n  {% if ES_FSM %}\n  * Si esperando_confirmacion = \"crear_proyecto_completo\" o \"crear_proyecto_completo_fsm\" → \"crear_proyecto_tarea_horas_fsm\"\n  * Si esperando_confirmacion = \"crear_tarea_solamente\" o \"crear_tarea_solamente_fsm\" → \"crear_tarea_y_horas_fsm\"\n{% else %}\n  * \"crear_proyecto_completo\" → \"crear_proyecto_tarea_horas\"\n  * \"crear_tarea_solamente\" → \"crear_tarea_y_horas\"\n{% endif %}\n\n\n**RESPUESTA PARA CONFIRMACIONES:**\n\n\n- Si el mensaje contiene negación (no, cancelar, nada), usa acción: \"conversar\"\n{% else %}\n- Si el usuario confirma algo sin contexto previo → pedir aclaración\n{% endif %}\n\n\n\n**FORMATOS DE RESPUESTA REQUERIDOS (CON ESTILO JORGE):**\n\n\n**Para registrar partes de hora y stock**:\n\n- `\"is_diagnosis_task\": false`\n- `\"horas_presupuestadas\": 0`\n- \"travel_distance_km\": 0\n- \"travel_time_hours\": 0\n\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"is_diagnosis_task\": false,\n  \"horas_presupuestadas\": 0,\n  \"proyecto\": \"nombre del proyecto (por defecto: Servicio de campo)\",\n  \"tarea\": \"nombre de la tarea\",\n  \"horas\": 0,\n  \"descripcion\": \"descripción del trabajo\",\n  \"productos\": [\n    { \"nombre\": \"nombre material\", \"cantidad\": 1 }\n  ],\n  \"cliente\": \"interno (por defecto) o nombre del cliente\",\n  \"travel_distance_km\": 0,\n  \"travel_time_hours\": 0,\n  \"respuesta_usuario\": \"🧰 Registraré el parte (FSM): [HORAS]h en [TAREA] / [PROYECTO] y dejaré los materiales en las notas: [LISTA]. ¿Procedo?\"\n}\n\n\n```\n\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"proyecto\": \"Servicio de campo\",\n  \"tarea\": \"Instalación router oficina\",\n  \"horas\": 2.5,\n  \"descripcion\": \"Instalación y pruebas\",\n  \"productos\": [\n    { \"nombre\": \"Cable UTP\", \"cantidad\": 20 },\n    { \"nombre\": \"Conector RJ45\", \"cantidad\": 8 }\n  ],\n  \"tipo_accion_stock\": \"consumir\",\n  \"warehouse_hint\": \"principal\",\n  \"cliente\": \"interno\",\n  \"travel_distance_km\": 0,\n  \"travel_time_hours\": 0,\n  \"respuesta_usuario\": \"📝 Registraré 2.5h en 'Instalación router oficina' y anotaré Cable UTP x20, Conector RJ45 x8. ¿Procedo?\"\n}\n```\n\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"proyecto\": \"Servicio de campo\",\n  \"tarea\": \"Montaje mesa\",\n  \"horas\": 1.5,\n  \"descripcion\": \"Ajuste patas y nivelado\",\n  \"productos\": [\n    { \"nombre\": \"Tornillo M6\", \"cantidad\": 12 }\n  ],\n  \"tipo_accion_stock\": \"consumir\",\n  \"warehouse_hint\": \"principal\",\n  \"travel_distance_km\": 0,\n  \"travel_time_hours\": 0,\n  \"respuesta_usuario\": \"📝 Registraré 1.5h en 'Montaje mesa' y Tornillo M6 x12. ¿Procedo?\"\n}\n```\n\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"proyecto\": \"{{ $json.datos_pendientes.proyecto || 'Servicio de campo' }}\",\n  \"tarea\": \"{{ $json.datos_pendientes.tarea }}\",\n  \"horas\": {{ $json.datos_pendientes.horas || 0 }},\n  \"descripcion\": \"{{ $json.datos_pendientes.descripcion }}\",\n  \"productos\": [\n    {\n      \"nombre\": \"{{ $json.datos_pendientes.productos_validados[0].product_name }}\",\n      \"cantidad\": {{ $json.datos_pendientes.productos_validados[0].quantity || 1 }}\n    },\n    {\n      \"nombre\": \"nombre ejemplo\",\n      \"cantidad\": 12,\n      \"sugerencias\": [\"Tornillo M6x20\", \"Tornillo M6x30\", \"Tornillo M6x40\"]\n    }\n  ],\n  \"tipo_accion_stock\": \"consumir\",\n  \"warehouse_hint\": \"principal\",\n  \"travel_distance_km\": 0,\n  \"travel_time_hours\": 0,\n  \"respuesta_usuario\": \"📝 He detectado que quieres registrar un parte con productos. Para el producto 'Tornillo M6', ¿podrías especificar cuál de estas opciones es la correcta?\\n- Tornillo M6x20\\n- Tornillo M6x30\\n- Tornillo M6x40\"\n}\n```\n\n\n\n**Para registrar fichaje (entrada/salida con ubicación GPS)**:\n```json\n{\n  \"accion\": \"registrar_fichaje\",\n  \"tipo_fichaje\": \"entrada|salida|auto\",\n  \"latitude\": número_decimal_entre_-90_y_90,\n  \"longitude\": número_decimal_entre_-180_y_180,\n  \"respuesta_usuario\": \"✅ **ENTRADA REGISTRADA** 👤 [EMPLEADO] 🕐 [HORA] 📍 [COORDENADAS]\"\n}\n```\n\nEjemplo práctico:\n```json\n{\n  \"accion\": \"registrar_fichaje\",\n  \"tipo_fichaje\": \"entrada\",\n  \"latitude\": 39.589193,\n  \"longitude\": 2.611675,\n  \"respuesta_usuario\": \"✅ **ENTRADA REGISTRADA** 👤 Juan García 🕐 09:15:32 📍 39.589193°, 2.611675°\"\n}\n```\n\n\n\n**Para consultar actividad temporal por usuario** (NUEVA FUNCIONALIDAD):\n```json\n{\n  \"accion\": \"consultar_actividad_usuario\",\n  \"usuario\": \"nombre del usuario\",\n  \"periodo\": \"hoy|ayer|esta_semana|semana_pasada|este_mes|mes_pasado\",\n  \"respuesta_usuario\": \"⏰ Consultando qué ha hecho [USUARIO] [PERIODO]...\"\n}\n```\n\n**Para consultar horas de proyecto**:\n```json\n{\n  \"accion\": \"consultar_horas_proyecto\",\n  \"proyecto\": \"nombre del proyecto\",\n  \"respuesta_usuario\": \"⏰ Consultando horas dedicadas al proyecto '[PROYECTO]'...\"\n}\n```\n\n**Para consultar horas de tarea**:\n```json\n{\n  \"accion\": \"consultar_horas_tarea\",\n  \"proyecto\": \"nombre del proyecto\",\n  \"tarea\": \"nombre de la tarea\",\n  \"respuesta_usuario\": \"⏰ Consultando horas dedicadas a la tarea '[TAREA]' del proyecto '[PROYECTO]'...\"\n}\n```\n\n**Para consultar el estado de un proyecto**:\n```json\n{\n  \"accion\": \"consultar_estado_proyecto\",\n  \"proyecto\": \"nombre del proyecto (si se detecta; puede ir vacío)\",\n  \"incluir_registros\": false,\n  \"dias\": 90,\n  \"respuesta_usuario\": \"🔎 Consultando el estado del proyecto '[PROYECTO]'...\"\n}\n```\n\n**Para registrar gastos**:\n```json\n{\n  \"accion\": \"registrar_gasto\",\n  \"importe\": numero_decimal,\n  \"descripcion\": \"descripción del gasto\",\n  \"fecha\": \"YYYY-MM-DD (opcional, por defecto hoy)\",\n  \"categoria\": \"categoría del gasto (opcional)\",\n  \"respuesta_usuario\": \"💰 Perfecto, voy a registrar un gasto de [IMPORTE]€ por: [DESCRIPCION]. Verificando tu usuario en Odoo...\"\n}\n```\n\n**Para firmar LOPD (tareas de apertura):**\n```json\n{\n  \"accion\": \"firmar_lopd\",\n  \"respuesta_usuario\": \"📋 Consultando tareas de apertura de hoy para firmar LOPD...\"\n}\n```\n\n**Para envío masivo (solo admins):**\nSi el mensaje es \"Envio masivo: XXXXXXXXXXXX\" (o \"Envío masivo:\"), extrae el texto después de los dos puntos en mensaje_masivo.\n```json\n{\n  \"accion\": \"envio_masivos\",\n  \"mensaje_masivo\": \"XXXXXXXXXXXX\",\n  \"respuesta_usuario\": \"✅ Enviando mensaje a todos los usuarios...\"\n}\n```\n\n**Para usar o liberar coche:**\n```json\n{\n  \"accion\": \"uso_liberar_coche\",\n  \"tipo_accion\": \"usar|liberar\",\n  \"coche\": \"nombre o matrícula del coche (vacío si no menciona)\",\n  \"respuesta_usuario\": \"🚗 Gestionando coche...\"\n}\n```\n- tipo_accion: \"usar\" si quiere asignarse un coche, \"liberar\" si quiere devolverlo.\n- coche: extrae si menciona un coche concreto (matrícula, modelo, nombre).\n\n**EJEMPLOS ESPECÍFICOS DE TRANSCRIPCIONES:**\n\n📥 **Audio transcrito**: \"Registrar parte de horas en proyecto test N8N, tarea prueba N8N. Quiero un parte de horas de dos horas con un mensaje que sea cortar fichase\"\n📤 **Respuesta**:\n```json\n{\n  \"accion\": \"registrar_horas\",\n  \"proyecto\": \"test N8N\",\n  \"tarea\": \"prueba N8N\",\n  \"horas\": 2,\n  \"descripcion\": \"cortar fichase\",\n  \"travel_distance_km\": 0,\n  \"travel_time_hours\": 0,\n  \"respuesta_usuario\": \"🎤 Audio transcrito exitosamente\\n\\n📝 Perfecto, voy a registrar 2 horas en la tarea 'prueba N8N' del proyecto 'test N8N' por: cortar fichase. ¿Procedo con el registro?\"\n}\n```\n\n**EJEMPLOS CONSULTAS A ODOO**\n\n**Actividad Temporal por Usuario (NUEVA FUNCIONALIDAD):**\n- \"qué ha hecho Marco hoy\" → consultar_actividad_usuario, usuario: \"Marco\", periodo: \"hoy\"\n- \"qué hice ayer\" → consultar_actividad_usuario, usuario: \"Usuario actual\", periodo: \"ayer\"\n- \"actividad de Juan esta semana\" → consultar_actividad_usuario, usuario: \"Juan\", periodo: \"esta_semana\"\n- \"qué trabajó Ana la semana pasada\" → consultar_actividad_usuario, usuario: \"Ana\", periodo: \"semana_pasada\"\n- \"trabajo de Pedro este mes\" → consultar_actividad_usuario, usuario: \"Pedro\", periodo: \"este_mes\"\n- \"qué hizo María el mes pasado\" → consultar_actividad_usuario, usuario: \"María\", periodo: \"mes_pasado\"\n- \"mi actividad de hoy\" → consultar_actividad_usuario, usuario: \"Usuario actual\", periodo: \"hoy\"\n- \"mi trabajo esta semana\" → consultar_actividad_usuario, usuario: \"Usuario actual\", periodo: \"esta_semana\"\n\n**Consultar Horas (NUEVA FUNCIONALIDAD):**\n- \"cuántas horas he dedicado al proyecto Marketing\" → consultar_horas_proyecto, proyecto: \"Marketing\"\n- \"horas invertidas en el proyecto test N8N\" → consultar_horas_proyecto, proyecto: \"test N8N\"\n- \"tiempo dedicado al proyecto Desarrollo Web\" → consultar_horas_proyecto, proyecto: \"Desarrollo Web\"\n- \"cuántas horas llevo en la tarea documentación del proyecto Marketing\" → consultar_horas_tarea, proyecto: \"Marketing\", tarea: \"documentación\"\n- \"tiempo invertido en la tarea pruebas del proyecto test N8N\" → consultar_horas_tarea, proyecto: \"test N8N\", tarea: \"pruebas\"\n- \"horas dedicadas a la tarea desarrollo del proyecto Web\" → consultar_horas_tarea, proyecto: \"Web\", tarea: \"desarrollo\"\n\n**Estado de proyecto (NUEVA FUNCIONALIDAD):**\n- \"dime el estado del proyecto casa\" → consultar_estado_proyecto, proyecto: \"casa\", incluir_registros: true, dias: 90\n- \"cómo va el proyecto 'Reforma local' con registros\" → consultar_estado_proyecto, proyecto: \"Reforma local\", incluir_registros: true, dias: 90\n- \"situación de las tareas del proyecto marketing este mes\" → consultar_estado_proyecto, proyecto: \"marketing\", incluir_registros: true, dias: 31\n- \"avance del proyecto web con timesheets de los últimos 30 días\" → consultar_estado_proyecto, proyecto: \"web\", incluir_registros: true, dias: 30\n\n\n**RECONOCIMIENTO DE NÚMEROS EN TEXTO:**\n- \"uno\" / \"una hora\" = 1\n- \"dos horas\" = 2\n- \"tres horas\" = 3\n- \"cuatro horas\" = 4\n- \"cinco horas\" = 5\n- \"media hora\" = 0.5\n- \"hora y media\" = 1.5\n\n**🚗 DETECCIÓN DE DISTANCIA DE DESPLAZAMIENTO (travel_distance_km):**\nBusca DISTANCIA RECORRIDA/VIAJADA (NO confundir con horas de trabajo):\n- Palabras clave: \"km\", \"kilómetros\", \"kms\", \"he recorrido\", \"recorrí\", \"he desplazado\", \"distancia de desplazamiento\"\n- Patrones: extraer número INMEDIATAMENTE antes o después de \"km\" o \"kilómetros\"\n- Ejemplos: \"he recorrido 50 km\", \"50 kilómetros\", \"viaje de 25 km\"\n- INCLUIR EN JSON: `\"travel_distance_km\": <número>`\n\n**⏱️ DETECCIÓN DE TIEMPO DE DESPLAZAMIENTO (travel_time_hours):**\nBusca TIEMPO DE DESPLAZAMIENTO/VIAJE (NO confundir con horas trabajadas):\n- Palabras clave: \"tardé en llegar\", \"tardé en desplazarme\", \"he llegado en\", \"viaje de\", \"desplazamiento de\", \"traslado de\"\n- Conversiones: \"media hora\" = 0.5h, \"1h\" = 1h, \"30 minutos\" = 0.5h, \"hora y media\" = 1.5h\n- Ejemplos: \"tardé 1 hora en llegar\", \"he llegado en media hora\", \"30 minutos de viaje\"\n- INCLUIR EN JSON: `\"travel_time_hours\": <número>`\n\n🔴 **DIFERENCIACIÓN CRÍTICA (FUNDAMENTAL - NO CONFUNDIR):**\n- \"he trabajado 5 horas\" → horas (TRABAJO)\n- \"la tarea me llevó 3 horas\" → horas (TRABAJO)\n- \"tardé 1 hora en llegar\" → travel_time_hours (DESPLAZAMIENTO)\n- \"50 km\" → travel_distance_km (DISTANCIA RECORRIDA)\n- \"el viaje fue de 1 hora\" → travel_time_hours (DESPLAZAMIENTO)\n- \"media hora de viaje\" → travel_time_hours (DESPLAZAMIENTO)\n\n**EJEMPLOS DE EXTRACCIÓN COMPLETA:**\n- \"Registrar 5h, 50 km, 1h desplazamiento\" → horas=5, travel_distance_km=50, travel_time_hours=1\n- \"He trabajado 3 horas, tardé media hora en llegar, 25 kilómetros\" → horas=3, travel_distance_km=25, travel_time_hours=0.5\n- \"2h trabajo, 45 minutos de viaje, 18 kms\" → horas=2, travel_distance_km=18, travel_time_hours=0.75\n\n**REGLAS CRÍTICAS:**\n- SIEMPRE responde con JSON válido\n- Para audio transcripto, EXTRAE DATOS aunque el texto no sea perfecto\n- Si detectas \"registrar\", \"parte de horas\" o similar en audio → acción \"registrar_horas\"\n- Si detectas \"modificar\", \"cambiar\", \"editar\", \"actualizar\" + \"contacto\" → acción \"modificar_contacto\"\n- Nunca devuelvas \"conversar\" si detectas solicitud de modificar contacto, aunque sea incompleta\n- APLICA SIEMPRE EL ESTILO DE JORGE: directo, técnico pero cercano, sin jerga innecesaria\n- Si el usuario no indica año, en el campo \"fecha\" usa el AÑO_ACTUAL. Nunca asumas 2024 u otro año salvo que el usuario lo diga explícitamente.\n\n**🔴 REGLAS CRÍTICAS PARA ELEGIR ACCIÓN - PARTE vs HORAS:**\n- **REGISTRAR_PARTE_Y_STOCK** si detectas CUALQUIERA de estos:\n  1. Las palabras \"parte\", \"parte de trabajo\", \"registra parte\", \"registra un parte\" EN EL MENSAJE\n  2. Las frases \"he realizado\", \"he hecho\" combinadas con horas o trabajo\n  3. Horas + materiales/productos (\"10 tornillos\", \"3 cables\", etc.)\n  4. PRIORITARIO: Si ves \"registra parte de trabajo\", \"parte de trabajo\", \"he realizado horas\" → SIEMPRE \"registrar_parte_y_stock\"\n- **REGISTRAR_HORAS** SOLO si:\n  - El usuario dice \"registrar horas\" O \"parte de horas\" SIN mencionar la palabra \"parte\" de forma aislada\n  - NUNCA uses \"registrar_horas\" si el mensaje contiene \"parte\", \"parte de trabajo\", o \"he realizado\"\n  - Ejemplo CORRECTO para registrar_horas: \"registro 5 horas en proyecto X tarea Y\" (sin \"parte\")\n  - Ejemplo INCORRECTO para registrar_horas: \"registra un parte de trabajo con 5 horas\" (contiene \"parte\" → usa \"registrar_parte_y_stock\")\n- Si hay horas + materiales → acción \"registrar_parte_y_stock\"\n- Proyecto por defecto: \"Servicio de campo\" si no se indica\n- CLIENTE (FSM): Si el mensaje especifica cliente (p. ej. \"para ClienteCorp\", \"cliente Juan\", \"de ACME\", \"para el cliente X\"), extrae el nombre exacto en el campo \"cliente\". Si no especifica, usa \"interno\".\n\n\n\nResponde ÚNICAMENTE con el JSON requerido:",
        "options": {
          "systemMessage": "=MENSAJE ACTUAL: {{ $json.mensaje_usuario }}\n\n🎯 DETECTAR AUTOMÁTICAMENTE:\n- Contiene \"presupuesto\" o \"vamos a necesitar\" o \"hará falta\" → registrar_parte_y_stock y is_diagnosis_task=true.\n- Contiene \"hola ¿quién eres?\" o \"quien eres\" o \"que eres\" → mensaje_bienvenida\n- Contiene \"mi usuario de odoo es\" seguido de cualquier texto → registrar_usuario\n- Contiene \"limitar modulos\" o \"restringir modulos\" o \"limitar módulos\" o \"restringir módulos\" seguido de usuario y módulos → limitar_modulos\n- Contiene \"registrar\" + \"horas\" → registrar_horas\n- Contiene \"registrar\" + (\"ausencia\"|\"vacaciones\"|\"permiso\"|\"baja\") → registrar_ausencia\n- Contiene \"registrar\" + \"gasto\" o \"expense\" o números con € o euros → registrar_gasto\n- Contiene \"fichar\" o \"fichaje\" o \"entrada\" o \"salida\" o \"check in\" o \"check out\" + ubicación (coordenadas/localización GPS) → registrar_fichaje\n- Contiene \"crear proyecto\" → crear_proyecto  \n- Contiene \"crear tarea\" → crear_tarea\n- Contiene \"precio\" o \"stock\" → consultar_producto\n- Contiene \"ventas\" + \"orden\" o \"S\" + números → consultar_ventas_por_orden\n- Contiene \"ventas\" → consultar_ventas\n- Contiene \"compras\" → consultar_compras\n- Contiene \"facturas\" → consultar_facturas\n- Contiene \"pagos pendientes\" o \"cobrar\" o \"deben\" → consultar_pagos_pendientes\n- Contiene \"top\" o \"mejores\" o \"ranking\" o \"más vendidos\" → consultar_top_rankings\n- Contiene \"comerciales\" o \"vendedores\" o \"facturado cada\" o \"rendimiento comercial\" o \"ranking comerciales\" → consultar_ranking_comerciales\n- Contiene \"ventas perdidas\" o \"conversión\" o \"perdido\" o \"no facturadas\" o \"ventas pendientes\" o \"pendientes\" → consultar_ventas_perdidas\n- Contiene \"cuántas horas\" o \"horas dedicadas\" o \"tiempo dedicado\" o \"tiempo invertido\" → consultar_horas_proyecto o consultar_horas_tarea\n- Contiene \"qué ha hecho\" o \"qué hice\" o \"hoy\" o \"ayer\" o \"esta semana\" o \"este mes\" → consultar_actividad_usuario\n- Contiene \"ausencias\" o \"ausente\" o \"vacaciones\" or \"permisos\" or \"libre\" or \"off\" or \"no está\" or \"fuera\" (con o sin nombre de persona) → consultar_ausencias\n- Contiene \"consulta\" + \"ausencias\" + nombre de persona → consultar_ausencias\n- Contiene \"está\" + nombre + (\"libre\"|\"fuera\"|\"vacaciones\"|\"ausente\") → consultar_ausencias\n- Contiene \"eventos\" o \"evento\" o \"reuniones\" o \"reunión\" o \"calendario\" o \"qué tiene\" o \"agenda\" o \"citas\" → consultar_eventos_usuario\n- Contiene \"visitantes\" o \"visitas\" o \"tráfico web\" o \"web\" o \"página\" o \"usuarios web\" → consultar_visitantes_web\n- Contiene \"contacto\" → consultar_contacto\n- Contiene \"crear pedido\" o \"pedido de venta\" o \"crear venta\" o \"nuevo pedido\" → crear_pedido_venta\n- Contiene \"crear cita\" o \"crear evento\" o \"cita en el calendario\" o \"evento calendario\" o \"reunión\" o \"meeting\" o \"agendar\" → crear_evento_calendario\n- Contiene \"tickets\" o \"ticket\" o \"servicio de asistencia\" o \"soporte\" o \"incidencias\" o \"helpdesk\" → consultar_tickets\n- Contiene \"añadir mensaje\" o \"agregar mensaje\" o \"comentar\" o \"responder\" + \"ticket\" → anadir_mensaje_ticket\n- Contiene \"fabricaciones\" o \"fabricación\" o \"manufacturing\" o \"producción\" o \"estado fabricación\" o \"órdenes de fabricación\" → consultar_fabricaciones\n- Contiene \"crear pedido de compra\" o \"pedido de compra\" o \"crear compra\" o \"nueva compra\" o \"orden de compra\" → crear_pedido_compra\n- INVENTARIO FSM: Contiene verbos de consumo (\"consumir\", \"he gastado\", \"gasta\", \"resta\", \"descuenta\") + cantidad + producto → fsm_inventario (tipo_accion=\"consumir\")\n- INVENTARIO FSM: Contiene verbos de reposición (\"reponer\", \"repón\", \"añade\", \"suma\", \"he comprado\") + cantidad + producto → fsm_inventario (tipo_accion=\"reponer\")\n🧩 Si esperando_confirmacion == \"corregir_pedido_venta\":\n- Combina productos de la memoria (originales válidos + preconfirmados) con los corregidos del mensaje actual.\n- Quita duplicados normalizando nombre (minúsculas, sin tildes, un espacio).\n- Para nombres iguales, suma cantidades o prioriza la del mensaje si es la corrección del ambiguo.\n- Devuelve la acción \"crear_pedido_venta\" con el array \"productos\" resultante y el \"cliente\".\n- Contiene (\"estado\" OR \"situación\" OR \"progreso\" OR \"avance\" OR \"fases\" OR \"etapas\" OR \"tareas\")\n  + \"proyecto\" → consultar_estado_proyecto\n- Contiene \"cómo va\" + \"proyecto\" → consultar_estado_proyecto\n- Contiene \"resumen del proyecto\" OR \"detalles del proyecto\" OR \"dashboard del proyecto\" → consultar_estado_proyecto\n- Contiene \"proyectos\" + (\"en proceso\"|\"en progreso\"|\"en curso\"|\"hechos\"|\"finalizados\"|\"cerrados\"|\"nuevos\") → consultar_proyectos_por_etapa\n- Contiene \"lopd\" o \"firmar\" (en contexto de firmar LOPD de apertura) → firmar_lopd\n- Contiene \"envio masivo\" o \"envío masivo\" o \"envio masivos\" seguido de \":\" y texto → envio_masivos. Extrae el texto después de \":\" en mensaje_masivo.\n- Contiene \"usar coche\" o \"liberar coche\" o \"coche en uso\" o \"coches libres\" o \"quiero el coche\" o \"asignar coche\" o \"dejar coche\" o \"devolver coche\" o \"coger coche\" → uso_liberar_coche. Detecta: USAR (usar, asignar, coger, necesito, quiero) vs LIBERAR (liberar, dejar, devolver). Extrae nombre/matrícula del coche si lo menciona en campo \"coche\".\n\n\n\n\nUSAR datos reales del mensaje, NUNCA valores fijos.\nResponder SOLO con JSON válido.",
          "maxIterations": 1,
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3696,
        -9552
      ],
      "id": "0f538cac-553f-4765-98e6-d0a9e9679900",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta del AI Agent - SIMPLIFICADO\n\nlet respuestaAgent;\n\ntry {\n  // Obtener la respuesta del AI Agent\n  const textoRespuesta = $json.output || $json.response || $json.text || $json.message || '';\n  \n  // Intentar extraer JSON de la respuesta\n  const jsonMatch = textoRespuesta.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                   textoRespuesta.match(/{[\\s\\S]*}/);\n  \n  if (jsonMatch) {\n    respuestaAgent = JSON.parse(jsonMatch[1] || jsonMatch[0]);\n  } else {\n    try {\n      respuestaAgent = JSON.parse(textoRespuesta);\n    } catch {\n      respuestaAgent = {\n        accion: \"conversar\",\n        respuesta_usuario: textoRespuesta || \"Lo siento, no entendí tu mensaje. ¿Podrías reformularlo?\"\n      };\n    }\n  }\n} catch (error) {\n  console.error('Error parseando respuesta del AI Agent:', error);\n  respuestaAgent = {\n    accion: \"conversar\",\n    respuesta_usuario: \"Hubo un error procesando tu solicitud. ¿Podrías intentar de nuevo?\"\n  };\n}\n\n// OBTENER DATOS DEL USUARIO DESDE EL NODO ANTERIOR (PREPARAR DATOS AI AGENT)\n// El AI Agent solo devuelve su respuesta JSON, los datos del usuario están en el nodo anterior\nconst datosUsuario = $('Preparar Datos AI Agent').first().json;\n\nconst chatId = datosUsuario.chat_id || 'unknown';\nconst userId = datosUsuario.user_id || 'unknown';\nconst userName = datosUsuario.user_name || 'Usuario';\nconst mensajeUsuario = datosUsuario.mensaje_usuario || 'mensaje no disponible';\nconst uid = datosUsuario.uid || 'unknown';\n// PERFIL desde \"Preparar Datos AI Agent\"\nconst perfil = $('Preparar Datos AI Agent').first().json?.cliente_perfil || null;\n\nconsole.log('🔍 PROCESAR RESPUESTA - Datos recibidos:');\nconsole.log('   chat_id:', chatId);\nconsole.log('   user_name:', userName);\nconsole.log('   mensaje_usuario:', mensajeUsuario);\nconsole.log('   uid:', uid);\nconsole.log('📋 Datos del usuario completos:', JSON.stringify(datosUsuario, null, 2));\nconsole.log('🤖 Respuesta del AI Agent:', JSON.stringify(respuestaAgent, null, 2));\n\n// Actualizar memoria según la acción\nif (chatId !== 'unknown') {\n  const contextoKey = `memoria_${chatId}`;\n  let memoriaActualizada = global[contextoKey] || {};\n\n  if (respuestaAgent.accion === 'crear_tarea') {\n    memoriaActualizada = {\n      ...memoriaActualizada,\n      esperando_confirmacion: 'crear_tarea',\n      datos_pendientes: {\n        proyecto: respuestaAgent.proyecto,\n        tarea: respuestaAgent.tarea,\n        accion_original: 'crear_tarea_simple'\n      }\n    };\n    global[contextoKey] = memoriaActualizada;\n  } else if (respuestaAgent.accion === 'registrar_horas') {\n    memoriaActualizada = {\n      ...memoriaActualizada,\n      proyecto_anterior: respuestaAgent.proyecto,\n      tarea_anterior: respuestaAgent.tarea,\n      ultima_accion: 'registrar_horas'\n    };\n    global[contextoKey] = memoriaActualizada;\n  }\n}\n\nconst odooUser = datosUsuario.odoo_user || perfil?.email || null;\n\nreturn [{\n  ...respuestaAgent,\n  chat_id: chatId,\n  user_id: userId,\n  user_name: userName,\n  uid: uid,\n  mensaje_original: mensajeUsuario,\n  cliente_perfil: perfil,\n  odoo_user: odooUser,                      // 👈 login/email del usuario de Odoo\n  odoo_user_id: perfil?.user_id ?? null,    // 👈 opcional: id de res.users si lo tienes en el perfil\n  // 🚗 Travel fields from AI Agent\n  travel_distance_km: respuestaAgent.travel_distance_km || 0,\n  travel_time_hours: respuestaAgent.travel_time_hours || 0,\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4000,
        -9552
      ],
      "id": "c71ccde0-3562-406a-a06d-55365212ec91",
      "name": "Procesar Respuesta"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS PARA AI AGENT CON MEMORIA + PERFIL CLIENTE (ventas)\n\n// Helper seguro para leer JSON de otro nodo (soporta .first() y .item)\nfunction getNodeJson(name) {\n  try {\n    const h = $(name);\n    if (typeof h.first === 'function') {\n      const f = h.first();\n      if (f && f.json) return f.json;\n    }\n    return h.item.json;\n  } catch {\n    return {};\n  }\n}\n\n// 🔤 NUEVO: helper para normalizar texto (quita tildes, minúsculas, trim)\nfunction normalizeText(raw) {\n  if (raw === undefined || raw === null) return '';\n  return String(raw)\n    .normalize('NFD')                  // separa letra + tilde\n    .replace(/[\\u0300-\\u036f]/g, '')   // elimina marcas diacríticas\n    .replace(/´/g, '')                 // elimina acentos sueltos\n    .toLowerCase()                     // minúsculas\n    .trim();\n}\n\n// 1) Datos del usuario (texto/audio) y autenticación\nconst datosUsuario = getNodeJson('Obtener Chat ID');\n\n// 🔤 NUEVO: decidir mensaje original y normalizado\n// - Si viene de audio, usamos transcripcion_original.\n// - Si es texto escrito, usamos mensaje_usuario.\nconst mensajeOriginal =\n  datosUsuario.transcripcion_original ||\n  datosUsuario.mensaje_usuario ||\n  '';\n\nconst mensajeNormalizado = normalizeText(mensajeOriginal);\n\nconsole.log('✅ CAMINO CONFIRMACIÓN - Obteniendo memoria PostgreSQL...');\nconsole.log('📝 Mensaje original:', mensajeOriginal);\nconsole.log('🔤 Mensaje normalizado:', mensajeNormalizado);\n\n// 2) Memoria desde PostgreSQL (si existe)\nlet memoriaUsuario = {\n  esperando_confirmacion: null,\n  ultimo_mensaje_bot: null,\n  datos_pendientes: null,\n};\n\ntry {\n  const registro = getNodeJson('Consultar Memoria PostgreSQL');\n  if (registro && (registro.esperando_confirmacion !== undefined || registro.ultimo_mensaje_bot !== undefined)) {\n    memoriaUsuario = {\n      esperando_confirmacion: registro.esperando_confirmacion ?? null,\n      ultimo_mensaje_bot:     registro.ultimo_mensaje_bot     ?? null,\n      datos_pendientes:       registro.datos_pendientes\n        ? (typeof registro.datos_pendientes === 'string'\n            ? JSON.parse(registro.datos_pendientes)\n            : registro.datos_pendientes)\n        : null,\n    };\n    console.log('✅ Memoria PostgreSQL encontrada:', memoriaUsuario);\n  } else {\n    console.log('📭 No se encontró memoria previa para este usuario');\n  }\n} catch (error) {\n  console.log('⚠️ Error obteniendo memoria PostgreSQL:', error.message);\n}\n\n// 3) Perfil del usuario para ventas (desde Postgres: Cargar Perfil Usuario (ventas))\nlet perfil = {};\ntry {\n  perfil = getNodeJson('Cargar Perfil Usuario') || {};\n  console.log('👤 Perfil cargado:', perfil);\n} catch (e) {\n  perfil = {};\n}\n\nconst odoo_user = (perfil.odoo_user ?? perfil.user_mail ?? datosUsuario.odoo_user ?? null);\n\nconst cliente_perfil = {\n  name:        (perfil.user_name        || '').trim(),\n  email:       (perfil.user_mail        || '').trim(),\n  street:      (perfil.direccion_calle  || '').trim(),\n  zip:         (perfil.codigo_postal    || '').trim(),\n  city:        (perfil.poblacion        || '').trim(),\n  state_name:  (perfil.provincia        || '').trim(),\n  country_name:(perfil.pais             || '').trim(),\n  // opcional: ids crudos por si luego los necesitas\n  user_id:     perfil.user_id ?? null,\n  chat_id:     perfil.chat_id ?? null,\n};\n\n// 4) Construir el payload final para el agente\nconst datosCompletos = {\n  // Datos del usuario\n  mensaje_usuario:         mensajeNormalizado,     // 🔤 lo que ve el AGENTE (sin tildes)\n  mensaje_usuario_original: mensajeOriginal,       // 🧾 versión tal cual la escribió/dijo el usuario\n\n  chat_id:                datosUsuario.chat_id,\n  user_id:                datosUsuario.user_id,\n  odoo_user,\n  user_name:              datosUsuario.user_name,\n  es_audio:               datosUsuario.es_audio || false,\n  timestamp:              datosUsuario.timestamp || new Date().toISOString(),\n\n  // Odoo auth\n  uid:                    datosUsuario.uid,\n\n  // Memoria actual\n  esperando_confirmacion: memoriaUsuario.esperando_confirmacion,\n  ultimo_mensaje_bot:     memoriaUsuario.ultimo_mensaje_bot,\n  datos_pendientes:       memoriaUsuario.datos_pendientes,\n\n  // Extras\n  file_id:                datosUsuario.file_id,\n  transcripcion_original: datosUsuario.transcripcion_original,\n  audio_transcrito:       datosUsuario.audio_transcrito,\n\n  // 💡 PERFIL PARA VENTAS\n  cliente_perfil,\n};\n\nconsole.log('📤 ENVIANDO AL AI AGENT CON MEMORIA + PERFIL');\nconsole.log('🎯 Datos:', {\n  mensaje_usuario: datosCompletos.mensaje_usuario,\n  mensaje_usuario_original: datosCompletos.mensaje_usuario_original,\n  user_name: datosCompletos.user_name,\n  chat_id: datosCompletos.chat_id,\n  odoo_user: datosCompletos.odoo_user,\n  tiene_memoria: !!datosCompletos.esperando_confirmacion,\n  tiene_perfil: !!cliente_perfil.name || !!cliente_perfil.email\n});\n\n// ✅ Devolver como ARRAY (un único item)\nreturn [ datosCompletos ];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3456,
        -9472
      ],
      "id": "1e6c802e-27b0-41a8-837c-8189fb029c83",
      "name": "Preparar Datos AI Agent"
    },
    {
      "parameters": {
        "content": "## Trasncriptor de audio a texto\n",
        "width": 1900,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3776,
        -8704
      ],
      "typeVersion": 1,
      "id": "4d0212ed-94b9-4455-9362-0005fc7b46ee",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// Combinar datos de transcripción para que lleguen correctamente al AI Agent\nconst datosTranscripcion = $('Procesar Transcripción').item.json;\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('🔄 Combinando datos para AI Agent:');\nconsole.log('📄 Datos originales:', JSON.stringify(datosOriginales, null, 2));\nconsole.log('🎤 Datos transcripción:', JSON.stringify(datosTranscripcion, null, 2));\n\n// Usar los datos de transcripción que ya tienen el mensaje_usuario actualizado\nconst datosFinales = {\n  ...datosTranscripcion,\n  // Asegurar que tenemos todos los campos necesarios\n  chat_id: datosTranscripcion.chat_id || datosOriginales.chat_id,\n  user_id: datosTranscripcion.user_id || datosOriginales.user_id,\n  user_name: datosTranscripcion.user_name || datosOriginales.user_name,\n  timestamp: datosTranscripcion.timestamp || datosOriginales.timestamp,\n  es_audio: true,\n  audio_transcrito: true,\n  file_id: datosTranscripcion.file_id || datosOriginales.file_id\n};\n\nconsole.log('✅ Datos finales para AI Agent:', JSON.stringify(datosFinales, null, 2));\nconsole.log('💬 Mensaje que recibirá AI Agent:', datosFinales.mensaje_usuario);\n\nreturn datosFinales;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2624,
        -8656
      ],
      "id": "b0d2e245-fde1-4b8b-b149-094e7c2ea513",
      "name": "Actualizar Datos Transcripción"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=🎤 **Audio transcrito exitosamente:**\n\n\"{{ $json.transcripcion_original }}\"\n\n✅ Procesando tu solicitud...",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2800,
        -8656
      ],
      "id": "a8a1a7fc-684f-42f6-98cc-f6ea715ce16e",
      "name": "Confirmar Transcripción",
      "webhookId": "237a0319-b9b0-4c5f-8561-1aef1c7c9116"
    },
    {
      "parameters": {
        "jsCode": "// Procesar transcripción de AssemblyAI y combinar con datos originales\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('📄 Respuesta completa de AssemblyAI:', JSON.stringify($json, null, 2));\n\n// AssemblyAI devuelve la transcripción en el campo 'text'\nlet transcripcion = '';\n\n// Verificar si el proceso se completó exitosamente\nif ($json.status === 'completed' && $json.text) {\n  transcripcion = $json.text;\n} else if ($json.status === 'error') {\n  transcripcion = '[Error en transcripción: ' + ($json.error || 'Error desconocido') + ']';\n  console.error('❌ Error en AssemblyAI:', $json.error);\n} else if ($json.status === 'processing') {\n  transcripcion = '[Transcripción aún en proceso, espera un momento más]';\n  console.log('⏳ AssemblyAI aún está procesando');\n} else if ($json.status === 'queued') {\n  transcripcion = '[Transcripción en cola, espera un momento]';\n  console.log('⏳ AssemblyAI en cola');\n} else {\n  // Fallback: intentar obtener texto de otras posibles ubicaciones\n  transcripcion = $json.text || $json.transcript || '[Error: no se pudo obtener transcripción]';\n}\n\n// Limpiar la transcripción\ntranscripcion = String(transcripcion).trim();\n\nif (!transcripcion || transcripcion === '' || transcripcion === 'undefined') {\n  transcripcion = '[Error: transcripción vacía]';\n  console.error('❌ Error: No se pudo obtener transcripción válida');\n  console.error('📄 Estado:', $json.status);\n  console.error('📄 Datos recibidos:', JSON.stringify($json, null, 2));\n}\n\nconsole.log('🎤 Transcripción obtenida de AssemblyAI (ES):', transcripcion);\nconsole.log('📊 Estado AssemblyAI:', $json.status);\nconsole.log('🌍 Idioma detectado:', $json.language_code);\nconsole.log('🎯 Confianza:', $json.confidence);\n\n// 🔤 NUEVO: generar una versión normalizada SIN tildes para la lógica del agente\nconst transcripcionNormalizada = transcripcion\n  .normalize('NFD')                  // separa letra + tilde\n  .replace(/[\\u0300-\\u036f]/g, '')   // elimina marcas diacríticas\n  .replace(/´/g, '')                 // elimina acentos sueltos\n  .toLowerCase();                    // minúsculas para comparar mejor\n\nconsole.log('🎤 Transcripción normalizada (sin tildes):', transcripcionNormalizada);\n\n// Actualizar el mensaje usuario con la transcripción\nreturn {\n  ...datosOriginales,\n\n  // 👇 Lo que verá el AGENTE (sin tildes, minúsculas)\n  mensaje_usuario: transcripcionNormalizada,\n\n  // 👇 Lo que verás tú en Telegram (con tildes, intacto)\n  transcripcion_original: transcripcion,\n  mensaje_usuario_original: transcripcion,\n\n  es_audio: true,\n  audio_transcrito: true,\n  assemblyai_response: $json,\n  transcriptor: 'assemblyai',\n  estado_transcripcion: $json.status,\n  confidence: $json.confidence,\n  audio_duration: $json.audio_duration\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2992,
        -8656
      ],
      "id": "ec2a296c-c520-46f3-b24b-d968cc0e040d",
      "name": "Procesar Transcripción"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3376,
        -8656
      ],
      "id": "8beef004-44bf-4fae-8fb6-d5c871a8736a",
      "name": "Descargar Audio",
      "webhookId": "1f9d320a-2e58-48ab-bf94-f02ee44a09d2"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos del archivo de voz para descarga via Telegram\nconst datosArchivo = $json;\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('📄 Datos del archivo obtenidos:', JSON.stringify(datosArchivo, null, 2));\nconsole.log('📄 Datos originales:', JSON.stringify(datosOriginales, null, 2));\n\n// Obtener file_id desde los datos originales (es lo que necesita el nodo Telegram)\nlet fileId = datosOriginales.file_id;\n\n// También intentar obtener file_path si está disponible para referencia\nlet filePath = null;\nif (datosArchivo.file_path) {\n  filePath = datosArchivo.file_path;\n} else if (datosArchivo.result && datosArchivo.result.file_path) {\n  filePath = datosArchivo.result.file_path;\n} else if (datosArchivo.body && datosArchivo.body.result && datosArchivo.body.result.file_path) {\n  filePath = datosArchivo.body.result.file_path;\n}\n\nif (!fileId) {\n  console.error('❌ No se encontró file_id. Estructura completa:', JSON.stringify(datosArchivo, null, 2));\n  throw new Error('No se obtuvo file_id del archivo de voz. Revisa la estructura de datos en los logs.');\n}\n\nconsole.log('✅ file_id obtenido:', fileId);\nif (filePath) {\n  console.log('📁 file_path obtenido:', filePath);\n}\n\n// Usar file_id que es lo que requiere el nodo Telegram\nreturn {\n  ...datosArchivo,\n  ...datosOriginales,\n  file_id: fileId,\n  file_path: filePath,\n  voice_file_ready: true,\n  processing_method: 'telegram_file_id',\n  // Información para debug\n  download_info: {\n    file_id: fileId,\n    file_path: filePath,\n    method: 'telegram_get_file'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3552,
        -8656
      ],
      "id": "e77547b4-575c-4be4-b4f4-f464d5b2bf94",
      "name": "Preparar Descarga"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3728,
        -8656
      ],
      "id": "539d381c-439b-4d3d-b133-7c61a6d57410",
      "name": "Obtener Archivo de Voz",
      "webhookId": "7f3270c4-aed6-4c93-8195-10f4a570cb3b"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.es_audio }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -3232,
        -9120
      ],
      "id": "9a395ab8-1797-4ed8-a38d-cddb83e31b6e",
      "name": "¿Es Audio?"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS PARA VERIFICACIÓN DE BD\nconst datosUsuario = $json;\nconst mensajeUsuario = (datosUsuario.mensaje_usuario || '').toLowerCase().trim();\nconst chatId = datosUsuario.chat_id;\n\nconsole.log('🔍 === PREPARAR VERIFICACIÓN BD ===');\nconsole.log('📝 Mensaje usuario:', mensajeUsuario);\nconsole.log('💬 Chat ID:', chatId);\n\n// Simplemente pasar los datos para consultar la BD\nreturn {\n  ...datosUsuario\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        -9264
      ],
      "id": "d5b686a3-3198-4d76-90ee-fc710262127a",
      "name": "Preparar Verificación BD"
    },
    {
      "parameters": {
        "jsCode": "// OBTENER CHAT_ID DEL USUARIO\nconst uid = $json.result;\n\n// Función para obtener datos de nodos anteriores con manejo de errores\nfunction obtenerDatosSeguro(nombreNodo) {\n  try {\n    return $(nombreNodo).item.json;\n  } catch (e) {\n    console.log(`⚠️ Nodo \"${nombreNodo}\" no disponible:`, e.message);\n    return null;\n  }\n}\n\n// Intentar obtener datos del usuario desde diferentes fuentes\nlet datosUsuario = null;\n\n// Primero intentar desde \"Actualizar Datos Transcripción\" (para audio)\ndatosUsuario = obtenerDatosSeguro('Actualizar Datos Transcripción');\n\n// Si no existe, intentar desde \"Extraer Datos\" (para texto)\nif (!datosUsuario) {\n  datosUsuario = obtenerDatosSeguro('Extraer Datos');\n}\n\n// Si aún no tenemos datos, usar valores por defecto\nif (!datosUsuario) {\n  console.error('❌ GRAVE: No se encontraron datos del usuario en ningún nodo');\n  datosUsuario = {\n    mensaje_usuario: 'ERROR: No se encontró mensaje del usuario',\n    chat_id: 'unknown',\n    user_id: 'unknown',\n    user_name: 'Usuario',\n    odoo_user: 'User',\n    es_audio: false\n  };\n}\n\nconsole.log('🔍 OBTENER CHAT ID - Datos obtenidos:', {\n  mensaje_usuario: datosUsuario.mensaje_usuario,\n  chat_id: datosUsuario.chat_id,\n  user_name: datosUsuario.user_name,\n  odoo_user: datosUsuario.odoo_user,\n  \n});\n\nreturn {\n  ...datosUsuario,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1072,
        -9264
      ],
      "id": "5039ffad-9092-4132-a912-273a536655a9",
      "name": "Obtener Chat ID"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) as total_mensajes FROM n8n WHERE chat_id = $1",
        "options": {
          "queryReplacement": "={{ [$json.chat_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1568,
        -9264
      ],
      "id": "ce641947-ef18-4ac4-bd41-84060f9eaddd",
      "name": "Verificar Historial Usuario"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ parseInt($json.total_mensajes) }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              },
              "id": "af90a793-a413-4a98-8e3b-7d0d6527bed6"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1792,
        -9264
      ],
      "id": "8798edbf-18f5-433a-9bc5-b1696c943673",
      "name": "IF Tiene Historial"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT ultimo_mensaje_bot, esperando_confirmacion FROM n8n WHERE chat_id = $1 ORDER BY created_at DESC LIMIT 1",
        "options": {
          "queryReplacement": "={{ $('Preparar Verificación BD').item.json.chat_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        2160,
        -9536
      ],
      "id": "3e406222-60cd-4974-a8f7-92d848634caa",
      "name": "Verificar Último Mensaje Bot"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS PARA IF - VERIFICAR SI DEBE ACCEDER A MEMORIA\nconst datosUsuario = $('Preparar Verificación BD').item.json;\nconst consultaDB = $json; // $json viene directamente del nodo 'Verificar Último Mensaje Bot'\n\nconsole.log('🔍 === PREPARAR DATOS PARA IF ===');\nconsole.log('📋 Datos usuario:', datosUsuario);\nconsole.log('🗄️ Consulta DB (directa):', consultaDB);\nconsole.log('🗄️ Estructura consultaDB:', JSON.stringify(consultaDB, null, 2));\n\n// Extraer información de la BD - CORREGIDO: acceder directamente a los campos\nlet ultimoMensajeBot = null;\nlet esperandoConfirmacion = null;\n\n// Los datos vienen directamente del nodo PostgreSQL, no como array\nif (consultaDB) {\n  ultimoMensajeBot = consultaDB.ultimo_mensaje_bot;\n  esperandoConfirmacion = consultaDB.esperando_confirmacion;\n}\n\nconsole.log('🤖 Último mensaje bot:', ultimoMensajeBot);\nconsole.log('⏳ Esperando confirmación:', esperandoConfirmacion);\n\n// LÓGICA CORREGIDA: Si es 'Respuesta procesada' → FALSE (no acceder a memoria)\n// Si es cualquier otro mensaje → TRUE (acceder a memoria)\nconst debeAccederMemoria = (ultimoMensajeBot !== 'Respuesta procesada' && ultimoMensajeBot !== null);\n\nconsole.log('🎯 Lógica de decisión:');\nconsole.log('   - Último mensaje bot:', ultimoMensajeBot);\nconsole.log('   - Es \"Respuesta procesada\"?:', ultimoMensajeBot === 'Respuesta procesada');\nconsole.log('   - Es null?:', ultimoMensajeBot === null);\nconsole.log('   - Debe acceder a memoria?:', debeAccederMemoria);\n\n// Combinar toda la información para el IF\nconst datosCompletos = {\n  ...datosUsuario,\n  ultimo_mensaje_bot: ultimoMensajeBot,\n  esperando_confirmacion: esperandoConfirmacion,\n  debe_acceder_memoria: debeAccederMemoria\n};\n\nconsole.log('📤 Datos completos preparados para IF');\nconsole.log('   - debe_acceder_memoria:', datosCompletos.debe_acceder_memoria);\nconsole.log('   - Ruta que seguirá:', debeAccederMemoria ? 'TRUE (acceder memoria)' : 'FALSE (no acceder memoria)');\n\nreturn datosCompletos;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2352,
        -9536
      ],
      "id": "9027546a-163e-4519-96f0-4e647a8bc9b3",
      "name": "Preparar Datos para IF"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, created_at FROM n8n WHERE chat_id = $1 AND esperando_confirmacion IS NOT NULL AND esperando_confirmacion != '' ORDER BY created_at DESC LIMIT 1",
        "options": {
          "queryReplacement": "={{ [$('Obtener Chat ID').item.json.chat_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        2848,
        -9680
      ],
      "id": "304549e9-5d44-4149-a9ca-331142be8871",
      "name": "Consultar Memoria PostgreSQL",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"mchecagoshawk-webinar-main-28403608\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        864,
        -9264
      ],
      "id": "7cefc464-3f9b-4b27-8c66-991d7f19bd8c",
      "name": "Autenticar Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Extraer información básica del mensaje de Telegram con soporte para fotos y DOCUMENTOS (imagenes)\nlet mensaje = '';\nlet esAudio = false;\nlet tieneImagen = false;\nlet fileId = null;\nlet imagenFileId = null;\nlet imgData = null;\n\nconst msg = $json.message;\nconst chatId = msg.chat.id;\nconst userId = msg.from.id;\nconst userName = msg.from.first_name || 'Usuario';\n\nconsole.log('📱 === EXTRAER DATOS TELEGRAM ===');\nconsole.log('📥 Mensaje completo:', JSON.stringify(msg, null, 2));\n\n// Helpers\nconst nowIso = () => new Date().toISOString();\nconst caption = (msg.caption ?? '').trim();\n\n// 1) Texto\nif (msg.text) {\n  mensaje = msg.text.trim();\n  console.log('📝 Mensaje de texto:', mensaje);\n}\n\n// 2) Voz\nelse if (msg.voice) {\n  esAudio = true;\n  fileId = msg.voice.file_id;\n  mensaje = '[Mensaje de voz recibido. Transcribiendo...]';\n  console.log('🎤 Mensaje de voz detectado');\n}\n\n// 3) DOCUMENTO (posible imagen enviada como archivo)\nelse if (msg.document) {\n  const d = msg.document;\n\n  // Solo consideramos \"imagen\" si el mime_type es image/*\n  const isImageDoc = typeof d.mime_type === 'string' && d.mime_type.startsWith('image/');\n\n  if (isImageDoc) {\n    tieneImagen = true;\n    imagenFileId = d.file_id;\n\n    // mensaje: caption si hay, si no placeholder\n    mensaje = caption ? caption : '[Imagen recibida sin texto]';\n\n    imgData = {\n      kind: 'document',\n      file_id: d.file_id,\n      file_unique_id: d.file_unique_id,\n      file_size: d.file_size,\n      file_name: d.file_name || null,\n      mime_type: d.mime_type || null,\n      caption: caption || null,\n      message_id: msg.message_id,\n      // ✅ usa la fecha del mensaje como fallback, pero guardamos también timestamp ISO\n      message_date_unix: msg.date || null,\n      timestamp: nowIso(),\n      from_chat_id: chatId,\n      from_user_id: userId,\n    };\n\n    console.log('📎 Documento imagen detectado');\n    console.log('🖼️ File ID documento:', imagenFileId);\n    console.log('📊 Datos completos documento:', JSON.stringify(imgData, null, 2));\n  } else {\n    // Documento no imagen (pdf, zip, etc.)\n    mensaje = '[Documento recibido (no imagen)]';\n    console.log('📎 Documento no imagen detectado:', d.mime_type);\n  }\n}\n\n// 4) FOTO (photo) con/sin caption\nelse if (msg.photo && Array.isArray(msg.photo) && msg.photo.length) {\n  // Tomar la de mayor resolución\n  const photoData = msg.photo[msg.photo.length - 1];\n\n  tieneImagen = true;\n  imagenFileId = photoData.file_id;\n\n  // mensaje: caption si hay, si no placeholder\n  mensaje = caption ? caption : '[Imagen recibida sin texto]';\n\n  imgData = {\n    kind: 'photo',\n    file_id: photoData.file_id,\n    file_unique_id: photoData.file_unique_id,\n    file_size: photoData.file_size,\n    width: photoData.width,\n    height: photoData.height,\n    all_sizes: msg.photo, // Todas las resoluciones disponibles\n    caption: caption || null,\n    message_id: msg.message_id,\n    message_date_unix: msg.date || null,\n    timestamp: nowIso(),\n    from_chat_id: chatId,\n    from_user_id: userId,\n  };\n\n  console.log(caption ? '📸 Imagen con caption detectada' : '📸 Solo imagen detectada');\n  console.log('🖼️ File ID imagen:', imagenFileId);\n  console.log('📊 Datos completos imagen:', JSON.stringify(imgData, null, 2));\n}\n\n// 5) UBICACIÓN GPS (location)\nelse if (msg.location && msg.location.latitude !== undefined && msg.location.longitude !== undefined) {\n  const loc = msg.location;\n  const lat = loc.latitude;\n  const lon = loc.longitude;\n  \n  // Mensaje que AI Agent pueda reconocer como ubicación/fichaje\n  mensaje = `fichar ubicacion: ${lat}, ${lon}`;\n  \n  imgData = {\n    kind: 'location',\n    latitude: lat,\n    longitude: lon,\n    horizontal_accuracy: loc.horizontal_accuracy || null,\n    heading: loc.heading || null,\n    proximity_alert_radius: loc.proximity_alert_radius || null,\n    live_period: loc.live_period || null,\n    message_id: msg.message_id,\n    message_date_unix: msg.date || null,\n    timestamp: nowIso(),\n    from_chat_id: chatId,\n    from_user_id: userId,\n  };\n  \n  tieneImagen = true; // Flag para indicar que hay datos de ubicación\n  \n  console.log('📍 Ubicación GPS detectada:', lat, lon);\n  console.log('📊 Datos ubicación:', JSON.stringify(imgData, null, 2));\n}\n\n// 6) No soportado\nelse {\n  mensaje = '[Mensaje no soportado]';\n  console.log('❌ Tipo de mensaje no soportado');\n}\n\nconst resultado = {\n  mensaje_usuario: mensaje,\n  chat_id: chatId,\n  user_id: userId,\n  user_name: userName,\n  timestamp: nowIso(),\n  es_audio: esAudio,\n  tiene_imagen: tieneImagen,\n  file_id: fileId,\n  imagen_file_id: imagenFileId,\n  img_data: imgData,\n};\n\nconsole.log('✅ Datos extraídos:', JSON.stringify(resultado, null, 2));\nconsole.log('🔍 Campo img_data:', imgData ? 'PRESENTE' : 'NO HAY IMAGEN');\n\nreturn resultado;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6832,
        -9536
      ],
      "id": "14b4df4e-5520-433d-a92a-8b9af12f1177",
      "name": "Extraer Datos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.assemblyai.com/v2/upload",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3728,
        -8464
      ],
      "id": "cb10fe3a-3f45-4ac1-a68a-22a086bc08d0",
      "name": "HTTP Request - Upload Audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.assemblyai.com/v2/transcript",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify({audio_url: $json.upload_url, language_code: 'es', punctuate: true}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3552,
        -8464
      ],
      "id": "7b4c04ac-0062-41ef-81cc-6cddd9162146",
      "name": "HTTP Request - Create Transcript (ES)"
    },
    {
      "parameters": {
        "url": "=https://api.assemblyai.com/v2/transcript/{{ $json.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3216,
        -8464
      ],
      "id": "ba069e2d-87db-4053-936c-2d9772949c82",
      "name": "HTTP Request - Get Transcript"
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -3392,
        -8464
      ],
      "id": "9bce5e66-a3f2-4c25-aaab-e9379cb746a0",
      "name": "Esperar Transcripción",
      "webhookId": "931d9a97-c65b-4acc-9c80-67d8efa0b7f4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "verificar-acceso-memoria",
              "leftValue": "={{ $json.ultimo_mensaje_bot }}",
              "rightValue": "Respuesta procesada",
              "operator": {
                "type": "string",
                "operation": "notEquals",
                "name": "filter.operator.notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2560,
        -9536
      ],
      "id": "5a44b467-87f9-4135-adb9-d7af41470cad",
      "name": "Acceso a memoria"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 3 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -5120,
        -8096
      ],
      "id": "8b52cdf3-494d-4224-9a3f-27b65070f30d",
      "name": "Trigger Resumen Diario 8:00 AM"
    },
    {
      "parameters": {
        "jsCode": "// Preparar resumen diario automático para las 8:00 AM\nconst hoy = new Date();\nconst fechaHoy = hoy.toISOString().split('T')[0];\n\nconsole.log('🌅 Iniciando resumen diario automático para:', fechaHoy);\nconsole.log('👥 Consultando usuarios registrados para envío masivo...');\n\n// Preparar consulta para obtener todos los usuarios activos registrados\nconst queryUsuarios = `\n  SELECT user_id, user_name, chat_id \n  FROM telegram_users \n  WHERE is_active = true \n  ORDER BY last_seen DESC\n`;\n\nreturn {\n  fecha: fechaHoy,\n  tipo_resumen: 'diario_automatico',\n  timestamp: new Date().toISOString(),\n  query_usuarios: queryUsuarios\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4928,
        -8096
      ],
      "id": "0ee7b675-320d-4a30-b671-9056b0d28ec8",
      "name": "Preparar Resumen Diario"
    },
    {
      "parameters": {
        "jsCode": "// Verificar si el usuario ya existe antes de registrar\nconst userId = $json.user_id;\nconst userName = $json.user_name;\nconst chatId = $json.chat_id;\n\nconsole.log('🔍 === VERIFICAR EXISTENCIA USUARIO ===');\nconsole.log('🆔 User ID a verificar:', userId);\nconsole.log('👤 User Name:', userName);\nconsole.log('💬 Chat ID:', chatId);\nconsole.log('📋 Datos completos recibidos:', JSON.stringify($json, null, 2));\n\n// Si no tenemos user_id, no podemos verificar - tratar como usuario nuevo\nif (!userId) {\n  console.warn('⚠️ No hay user_id disponible, tratando como usuario nuevo');\n  return {\n    json: {\n      ...arguments[0],\n      usuario_existe: false,\n      verificacion_usuario: {\n        query: null,\n        params: [],\n        usuario_info: {\n          user_id: userId,\n          user_name: userName,\n          chat_id: chatId\n        }\n      }\n    }\n  };\n}\n\n// Preparar consulta para verificar si el usuario existe\n// Usamos COALESCE para siempre devolver al menos una fila\nconst queryVerificar = `\n  SELECT \n    COALESCE(user_id, 0) as user_id,\n    COALESCE(user_name, '') as user_name,\n    COALESCE(chat_id, 0) as chat_id,\n    COALESCE(is_active, false) as is_active,\n    COALESCE(last_seen, NOW()) as last_seen,\n    CASE WHEN user_id IS NOT NULL THEN 1 ELSE 0 END as existe\n  FROM (\n    SELECT user_id, user_name, chat_id, is_active, last_seen\n    FROM telegram_users \n    WHERE user_id = $1\n    UNION ALL\n    SELECT NULL::BIGINT, NULL::VARCHAR, NULL::BIGINT, NULL::BOOLEAN, NULL::TIMESTAMP\n    WHERE NOT EXISTS (SELECT 1 FROM telegram_users WHERE user_id = $1)\n  ) t\n  LIMIT 1\n`;\n\nconsole.log('📋 Query a ejecutar:', queryVerificar);\nconsole.log('🔍 Parámetros:', [userId]);\n\nreturn {\n  json: {\n    ...arguments[0], // Pasar todos los datos originales\n    verificacion_usuario: {\n      query: queryVerificar,\n      params: [userId],\n      usuario_info: {\n        user_id: userId,\n        user_name: userName,\n        chat_id: chatId\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2080,
        -9104
      ],
      "id": "f971e9cf-e888-46a1-bdee-ffc60ee59263",
      "name": "Verificar Usuario Existente"
    },
    {
      "parameters": {
        "jsCode": "console.log('🔍 === PROCESAR RESULTADO VERIFICACIÓN ==='); let datosOriginales = {}; try { const nodoVerificar = $('Verificar Usuario Existente').first().json; console.log('📋 Datos desde Verificar Usuario Existente:', JSON.stringify(nodoVerificar, null, 2)); if (nodoVerificar && nodoVerificar.usuario_info) { datosOriginales = { user_id: nodoVerificar.usuario_info.user_id, user_name: nodoVerificar.usuario_info.user_name, chat_id: nodoVerificar.usuario_info.chat_id, timestamp: new Date().toISOString() }; console.log('✅ Datos extraídos de usuario_info:', datosOriginales); } else if (nodoVerificar) { datosOriginales = { user_id: nodoVerificar.user_id, user_name: nodoVerificar.user_name, chat_id: nodoVerificar.chat_id, timestamp: nodoVerificar.timestamp || new Date().toISOString() }; console.log('✅ Datos extraídos directamente:', datosOriginales); } } catch (e) { console.error('❌ Error obteniendo datos originales:', e.message); } if (!datosOriginales.user_id || !datosOriginales.chat_id) { console.warn('⚠️ Datos originales incompletos, intentando obtener desde otros nodos...'); try { const nodos = ['Extraer Datos', 'Actualizar Datos Transcripción']; for (const nombreNodo of nodos) { try { const nodo = $(nombreNodo).first().json; if (nodo && nodo.user_id && nodo.chat_id) { datosOriginales = { user_id: nodo.user_id, user_name: nodo.user_name, chat_id: nodo.chat_id, timestamp: nodo.timestamp || new Date().toISOString() }; console.log(`✅ Datos encontrados en ${nombreNodo}:`, datosOriginales); break; } } catch (e2) { console.log(`⚠️ No se pudo obtener datos de ${nombreNodo}`); } } } catch (e3) { console.error('❌ Error buscando en nodos alternativos:', e3.message); } } const resultadoPostgreSQL = $json; console.log('🗃️ Resultado PostgreSQL:', JSON.stringify(resultadoPostgreSQL, null, 2)); let usuarioExiste = false; let datosUsuario = null; let longitudResultado = 0; if (Array.isArray(resultadoPostgreSQL) && resultadoPostgreSQL.length > 0) { const primerResultado = resultadoPostgreSQL[0]; console.log('📊 Analizando resultado array:', primerResultado); const existeCampo = primerResultado.existe === 1 || primerResultado.existe === '1'; const userIdValido = primerResultado.user_id && primerResultado.user_id !== '0' && primerResultado.user_id !== 0; if (existeCampo && userIdValido) { usuarioExiste = true; datosUsuario = primerResultado; longitudResultado = 1; console.log('✅ Usuario EXISTE'); } else { usuarioExiste = false; longitudResultado = 0; console.log('❌ Usuario NO EXISTE'); } } else if (resultadoPostgreSQL && typeof resultadoPostgreSQL === 'object') { console.log('📊 Analizando resultado objeto:', resultadoPostgreSQL); const existeCampo = resultadoPostgreSQL.existe === 1 || resultadoPostgreSQL.existe === '1'; const userIdValido = resultadoPostgreSQL.user_id && resultadoPostgreSQL.user_id !== '0' && resultadoPostgreSQL.user_id !== 0; if (existeCampo && userIdValido) { usuarioExiste = true; datosUsuario = resultadoPostgreSQL; longitudResultado = 1; console.log('✅ Usuario EXISTE (objeto)'); } else { usuarioExiste = false; longitudResultado = 0; console.log('❌ Usuario NO EXISTE (objeto)'); } } else { console.log('❌ Sin resultados válidos'); longitudResultado = 0; } const resultadoFinal = { user_id: datosOriginales.user_id, user_name: datosOriginales.user_name, chat_id: datosOriginales.chat_id, timestamp: datosOriginales.timestamp, usuario_existe: usuarioExiste, datos_usuario_existente: datosUsuario, length: longitudResultado, resultado_original: resultadoPostgreSQL }; console.log('📏 Length final para IF:', longitudResultado); console.log('🔍 Verificando datos finales - user_id:', resultadoFinal.user_id, 'chat_id:', resultadoFinal.chat_id); console.log('📤 Resultado final:', JSON.stringify(resultadoFinal, null, 2)); return { json: resultadoFinal };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1744,
        -9104
      ],
      "id": "56840010-b852-4bc1-8cf6-a5ea50530cbb",
      "name": "Procesar Resultado Verificación"
    },
    {
      "parameters": {
        "jsCode": "// Usuario ya existe - actualizar última actividad sin duplicar\nconst datosOriginales = $('Verificar Usuario Existente').first().json;\nconst usuarioExistente = $json[0] || $json; // Puede venir como array o objeto\n\nconsole.log('✅ === USUARIO YA REGISTRADO ===');\nconsole.log('👤 Usuario existente:', usuarioExistente);\nconsole.log('📋 Datos originales:', datosOriginales);\n\n// Preparar query para actualizar solo el last_seen\nconst queryActualizar = `\n  UPDATE telegram_users \n  SET last_seen = $1, \n      user_name = $2,\n      chat_id = $3,\n      is_active = true\n  WHERE user_id = $4\n`;\n\nconst timestamp = new Date().toISOString();\nconst params = [\n  timestamp,\n  datosOriginales.user_name,\n  datosOriginales.chat_id,\n  datosOriginales.user_id\n];\n\nconsole.log('🔄 Actualizando last_seen del usuario existente');\nconsole.log('📋 Query:', queryActualizar);\nconsole.log('🔍 Params:', params);\n\nreturn {\n  json: {\n    ...datosOriginales, // Pasar datos originales\n    actualizacion_usuario: {\n      query: queryActualizar,\n      params: params,\n      usuario_existente: true,\n      mensaje: `Usuario ${datosOriginales.user_name} ya estaba registrado - actualizando actividad`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1328,
        -9104
      ],
      "id": "5cdb0173-efd1-4ec6-a0b4-7c68906c3f14",
      "name": "Usuario Ya Existe"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.actualizacion_usuario.query }}",
        "options": {
          "queryReplacement": "={{ $json.actualizacion_usuario.params }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1120,
        -9104
      ],
      "id": "cdb2ab93-e04f-415e-93ec-904ac1b3360a",
      "name": "PostgreSQL Actualizar Usuario"
    },
    {
      "parameters": {
        "jsCode": "const datosRecibidos = $json;\n\nconsole.log('👤 === PREPARAR REGISTRO USUARIO ===');\nconsole.log('📋 Datos recibidos completos:', JSON.stringify(datosRecibidos, null, 2));\n\nconst userId = datosRecibidos.user_id;\nconst userName = datosRecibidos.user_name || 'Usuario';\nconst chatId = datosRecibidos.chat_id;\nconst timestamp = datosRecibidos.timestamp || new Date().toISOString();\n\nconsole.log('🔍 Datos extraídos:', { userId, userName, chatId, timestamp });\n\nif (!userId || !chatId) {\n  console.error('❌ Error: user_id o chat_id faltantes');\n  console.error('📋 Datos disponibles:', datosRecibidos);\n  throw new Error(`Datos insuficientes para registrar usuario: user_id=${userId}, chat_id=${chatId}`);\n}\n\n// Inserta por defecto consultas_restantes=5 y usuario_valido=false al crear.\n// En updates NO modifica estos campos (no resetea contadores ni flags).\nconst queryUpsert = `\n  INSERT INTO telegram_users (\n    user_id, user_name, chat_id, first_seen, last_seen, is_active,\n    consultas_restantes, usuario_valido\n  ) VALUES (\n    $1, $2, $3, $4, $5, true,\n    5, false\n  )\n  ON CONFLICT (user_id) DO UPDATE SET\n    user_name = EXCLUDED.user_name,\n    chat_id = EXCLUDED.chat_id,\n    last_seen = EXCLUDED.last_seen,\n    is_active = true\n`;\n\nconst params = [userId, userName, chatId, timestamp, timestamp];\n\nconsole.log('✅ Query preparada correctamente');\nconsole.log('📊 Params:', params);\n\nreturn {\n  json: {\n    ...datosRecibidos,\n    registro_usuario: {\n      query: queryUpsert,\n      params,\n      usuario_info: {\n        user_id: userId,\n        user_name: userName,\n        chat_id: chatId,\n        timestamp\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1184,
        -9648
      ],
      "id": "cd17a7fc-b5d6-44d2-926e-326ebe4a3f6b",
      "name": "Preparar Registro Usuario"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.registro_usuario.query }}",
        "options": {
          "queryReplacement": "={{ $json.registro_usuario.params }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -976,
        -9648
      ],
      "id": "2124a8e8-bb9c-4c10-928f-f9e1b36c02dc",
      "name": "PostgreSQL Registrar Usuario"
    },
    {
      "parameters": {
        "jsCode": "// Continuar con el flujo normal después del registro\n// Eliminar datos internos de registro y continuar\nconst { registro_usuario, ...datosOriginales } = $json;\n\nconsole.log('✅ Usuario registrado correctamente');\n\nreturn { json: datosOriginales };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -912,
        -9104
      ],
      "id": "e9c9acac-191c-45ed-822b-6becaedbd6e6",
      "name": "Limpiar Datos Registro"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, odoo_user FROM telegram_users WHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ [parseInt($('Procesar Resultado Verificación').item.json.user_id)] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -48,
        -9248
      ],
      "id": "a65cb33b-972c-470d-9956-0303c4d77d09",
      "name": "Consultar Usuario Telegram"
    },
    {
      "parameters": {
        "chatId": "={{ $('Procesar Resultado Verificación').item.json.chat_id }}",
        "text": "❌ No tienes configurado tu usuario de Odoo.\n\nPor favor, envía tu usuario de Odoo para un correcto funcionamiento:\n\n*Mi usuario de Odoo es: _________*\n\nGracias 🙏",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        592,
        -9040
      ],
      "id": "5139a153-c34e-4da8-90ea-806b074d3bba",
      "name": "Mensaje Sin Usuario Odoo",
      "webhookId": "2f96c558-e814-43c3-99be-34048ccca5fa"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\"jsonrpc\": \"2.0\", \"method\": \"call\", \"params\": {\"service\": \"common\", \"method\": \"authenticate\", \"args\": [\"mchecagoshawk-webinar-main-28403608\", \"admin\", \"admin\", {}]}, \"id\": 1}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4544,
        -8096
      ],
      "id": "a38fb2ca-822f-4824-97c7-88c41d729aa7",
      "name": "Autenticar Odoo para Resumen"
    },
    {
      "parameters": {
        "jsCode": "const datosPreparacion = $('Preparar Resumen Diario').item.json;\nconst uid = $json.result;\n\nif (!uid) throw new Error('Error en autenticación');\n\nconst fechaMadrid = new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Madrid' });\nconst inicioDia = `${fechaMadrid} 00:00:00`;\nconst finDia = `${fechaMadrid} 23:59:59`;\n\n// 1) Calendar (por si lo quieres mantener)\nconst consultaEventosCalendar = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"calendar.event\",\n      \"search_read\",\n      [\n        [\n          [\"start\", \"<=\", finDia],\n          [\"stop\", \">=\", inicioDia]\n        ]\n      ],\n      {\n        fields: [\"name\",\"description\",\"start\",\"stop\",\"duration\",\"partner_ids\",\"user_id\",\"location\"],\n        order: \"start asc\"\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\n// 2) FSM / Planificación global del día (project.task)\n// OJO: esto trae tareas de TODOS los usuarios (para el resumen global)\n// Si quieres solo tareas asignadas: user_ids != false\nconst consultaTareasDiarias = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"search_read\",\n      [\n        [\n          [\"planned_date_begin\", \"<=\", finDia],\n          [\"date_deadline\", \">=\", inicioDia],\n          [\"state\", \"not in\", [\"1_done\", \"1_canceled\"]],\n          [\"fsm_done\", \"!=\", true],\n          [\"user_ids\", \"!=\", false]\n        ]\n      ],\n      {\n        fields: [\"name\",\"planned_date_begin\",\"date_deadline\",\"partner_id\",\"project_id\",\"stage_id\",\"user_ids\",\"fsm_done\"],\n        order: \"planned_date_begin asc\"\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  fecha: fechaMadrid,\n  uid,\n  inicioDia,\n  finDia,\n  payload_calendar: consultaEventosCalendar,\n  payload_tasks: consultaTareasDiarias\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4368,
        -8096
      ],
      "id": "da9c1bf1-cba6-4ad0-9983-aac81c6fbc32",
      "name": "Preparar Consulta Eventos Diarios"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload_calendar) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4160,
        -8096
      ],
      "id": "ad29f36e-9df5-48fa-9ae9-a8dcede5f35a",
      "name": "HTTP Consultar Eventos Diarios"
    },
    {
      "parameters": {
        "jsCode": "// Consultar órdenes de venta pendientes de confirmar\nconst eventosRespuesta = $json.result || [];\n\n// Obtener UID de la autenticación (tomar el primer item válido)\nconst autenticacionData = $('Autenticar Odoo para Resumen').all();\nlet uid = null;\nfor (const item of autenticacionData) {\n  if (item.json && item.json.result) {\n    uid = item.json.result;\n    break;\n  }\n}\n\n// Obtener fecha del resumen diario\nconst fechaHoy = $('Preparar Resumen Diario').first().json.fecha;\n\nif (!uid) {\n  throw new Error('Error: UID no disponible para consulta de órdenes pendientes');\n}\n\nconsole.log('📋 Eventos encontrados:', eventosRespuesta.length);\nconsole.log('🛒 Preparando consulta de órdenes pendientes...');\nconsole.log('🔑 UID obtenido:', uid);\nconsole.log('📅 Fecha:', fechaHoy);\n\n// Consultar órdenes de venta en estado 'draft' (pendientes de confirmar)\nconst consultaOrdenesPendientes = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"sale.order\",\n      \"search_read\",\n      [\n        [\n          [\"state\", \"in\", [\"draft\", \"sent\"]]\n        ]\n      ],\n      {\n        fields: [\n          \"name\", \"partner_id\", \"amount_total\", \"date_order\", \n          \"state\", \"validity_date\", \"user_id\"\n        ],\n        order: \"date_order desc\",\n        limit: 20\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultaOrdenesPendientes,\n  eventos_del_dia: eventosRespuesta,\n  fecha: fechaHoy,\n  uid: uid,\n  paso: 'consultar_ordenes_pendientes'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3680,
        -8096
      ],
      "id": "54cdff4c-d5fe-4807-8297-ba1b3331033f",
      "name": "Preparar Consulta Órdenes Pendientes"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3472,
        -8096
      ],
      "id": "6c51778e-eec7-455b-9241-f35f9c995bf6",
      "name": "HTTP Consultar Órdenes Pendientes"
    },
    {
      "parameters": {
        "jsCode": "// Formatear resumen diario completo\nconst ordenesPendientes = $json.result || [];\n\n// ========= 1) LEER EVENTOS (calendar.event) =========\nconst eventosData = $('HTTP Consultar Eventos Diarios').all();\nlet eventosCalendar = [];\nfor (const item of eventosData) {\n  if (item.json && Array.isArray(item.json.result)) {\n    eventosCalendar = item.json.result;\n    break;\n  }\n}\n\n// ========= 2) LEER TAREAS (project.task / Field Service planning) =========\n// OJO: cambia el nombre del nodo si el tuyo es distinto\nconst tareasData = $('HTTP Consultar Tareas Diarias').all();\nlet tareasPlanificadas = [];\nfor (const item of tareasData) {\n  if (item.json && Array.isArray(item.json.result)) {\n    tareasPlanificadas = item.json.result;\n    break;\n  }\n}\n\n// ========= 3) FECHA =========\nconst fecha = $('Preparar Resumen Diario').first().json.fecha;\n\nconsole.log('📊 Generando resumen diario...');\nconsole.log('   - Eventos calendar:', eventosCalendar.length);\nconsole.log('   - Tareas planificadas:', tareasPlanificadas.length);\nconsole.log('   - Órdenes pendientes:', ordenesPendientes.length);\n\n// ========= 4) FUNCIÓN UTC -> HORA MADRID =========\nconst convertirUTCaHoraLocal = (fechaString) => {\n  if (!fechaString) return '00:00';\n\n  try {\n    const fechaUTC = new Date(fechaString + 'Z'); // Odoo suele venir sin zona; forzamos UTC\n    return fechaUTC.toLocaleTimeString('es-ES', {\n      hour: '2-digit',\n      minute: '2-digit',\n      timeZone: 'Europe/Madrid'\n    });\n  } catch (error) {\n    console.log('❌ Error convirtiendo hora:', error);\n    return '00:00';\n  }\n};\n\n// ========= 5) NORMALIZAR AGENDA (calendar + tasks) =========\n// Estructura común: { origen, name, start, stop, location, usuarios[] }\nconst agenda = [];\n\n// A) Calendar\nfor (const e of eventosCalendar) {\n  const usuario = e.user_id?.[1] || 'Sin asignar';\n  agenda.push({\n    origen: 'calendar',\n    name: e.name,\n    start: e.start,\n    stop: e.stop,\n    location: e.location || null,\n    usuarios: [usuario],\n  });\n}\n\n// B) Tareas planificadas\n// IMPORTANTE: user_ids es many2many -> puede venir como array de IDs (dependiendo de Odoo)\n// Si en tu respuesta viene como [[id, \"Nombre\"]] (raro en search_read), ajusta abajo.\n// Aquí asumimos lo normal: user_ids: [1,2,3] y NO trae nombres.\n// Pero tú has pedido fields: user_ids, así que solo tendrás IDs.\n// => Solución práctica: si NO hay nombres, las agrupamos como \"Asignado\" genérico.\n// Si quieres nombres reales: hay que pedir user_ids y hacer lookup en res.users (te lo monto si lo quieres).\n\nfor (const t of tareasPlanificadas) {\n  const inicio = t.planned_date_begin || null;\n  // En tu vista usan date_deadline como “fin” para el filtro; úsalo como stop\n  const fin = t.date_deadline || null;\n\n  // Location: cliente si existe\n  const location = t.partner_id?.[1] || null;\n\n  // Si user_ids trae nombres (no siempre), intentamos extraerlos:\n  let usuarios = [];\n  if (Array.isArray(t.user_ids) && t.user_ids.length > 0) {\n    // Caso 1: user_ids = [1,2,3] (IDs)\n    if (typeof t.user_ids[0] === 'number') {\n      usuarios = ['Asignado (user_ids)']; // fallback sin nombres\n    }\n    // Caso 2: user_ids = [[id,\"Nombre\"], ...] (si tu Odoo lo devolviera así)\n    else if (Array.isArray(t.user_ids[0])) {\n      usuarios = t.user_ids.map(u => u?.[1]).filter(Boolean);\n    }\n  }\n\n  if (usuarios.length === 0) usuarios = ['Sin asignar'];\n\n  // Duplicar por usuario (si hay varios) para que aparezca bajo cada uno\n  for (const u of usuarios) {\n    agenda.push({\n      origen: 'task',\n      name: `🛠️ ${t.name}`,\n      start: inicio,\n      stop: fin,\n      location,\n      usuarios: [u],\n    });\n  }\n}\n\n// ========= 6) ORDENAR POR HORA =========\nagenda.sort((a, b) => {\n  const da = a.start ? new Date(a.start + 'Z').getTime() : 0;\n  const db = b.start ? new Date(b.start + 'Z').getTime() : 0;\n  return da - db;\n});\n\n// ========= 7) FORMATEAR FECHA =========\nconst fechaFormateada = new Date(fecha).toLocaleDateString('es-ES', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\n\n// ========= 8) GENERAR MENSAJE =========\nlet resumen = `🌅 **Buenos días! Resumen para ${fechaFormateada}**\\n\\n`;\n\n// --- AGENDA ---\nresumen += `📅 **AGENDA DEL DÍA**\\n`;\n\nif (agenda.length === 0) {\n  resumen += `✅ No hay eventos ni tareas planificadas para hoy\\n\\n`;\n} else {\n  const agendaPorUsuario = {};\n\n  for (const item of agenda) {\n    const usuario = item.usuarios?.[0] || 'Sin asignar';\n    if (!agendaPorUsuario[usuario]) agendaPorUsuario[usuario] = [];\n    agendaPorUsuario[usuario].push(item);\n  }\n\n  for (const usuario of Object.keys(agendaPorUsuario)) {\n    resumen += `👤 **${usuario}:**\\n`;\n\n    for (const item of agendaPorUsuario[usuario]) {\n      const horaInicio = convertirUTCaHoraLocal(item.start);\n      const horaFin = convertirUTCaHoraLocal(item.stop);\n\n      resumen += `   🕐 ${horaInicio}-${horaFin}: ${item.name}`;\n      if (item.location) resumen += ` 📍 ${item.location}`;\n      resumen += `\\n`;\n    }\n\n    resumen += `\\n`;\n  }\n}\n\n// --- ÓRDENES ---\nresumen += `🛒 **ÓRDENES PENDIENTES DE CONFIRMAR**\\n`;\nif (ordenesPendientes.length === 0) {\n  resumen += `✅ No hay órdenes pendientes\\n\\n`;\n} else {\n  const totalPendiente = ordenesPendientes.reduce((acc, orden) => acc + (orden.amount_total || 0), 0);\n  resumen += `📊 **${ordenesPendientes.length} órdenes** por €${totalPendiente.toFixed(2)}\\n\\n`;\n\n  const ordenesAMostrar = ordenesPendientes.slice(0, 10);\n\n  ordenesAMostrar.forEach((orden, idx) => {\n    const fechaOrden = new Date(orden.date_order).toLocaleDateString('es-ES');\n    const estadoTexto = orden.state === 'draft' ? '📝 Borrador' : '📨 Enviado';\n\n    resumen += `${idx + 1}. **${orden.name}**\\n`;\n    resumen += `   👤 ${orden.partner_id?.[1] || 'Cliente no identificado'}\\n`;\n    resumen += `   💰 €${orden.amount_total?.toFixed(2) || '0.00'} | ${estadoTexto} | 📅 ${fechaOrden}\\n`;\n\n    if (orden.validity_date) {\n      const fechaValidez = new Date(orden.validity_date).toLocaleDateString('es-ES');\n      resumen += `   ⏰ Válido hasta: ${fechaValidez}\\n`;\n    }\n\n    resumen += `\\n`;\n  });\n\n  if (ordenesPendientes.length > 10) {\n    resumen += `📋 _Y ${ordenesPendientes.length - 10} órdenes más..._\\n\\n`;\n  }\n}\n\n// Footer\nresumen += `⚡ _Resumen automático generado a las ${new Date().toLocaleTimeString('es-ES')}_`;\n\nreturn {\n  texto: resumen,\n  eventos_count: eventosCalendar.length,\n  tareas_count: tareasPlanificadas.length,\n  ordenes_count: ordenesPendientes.length,\n  fecha\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3280,
        -8096
      ],
      "id": "e055bc1c-7bcc-40f7-9ed1-8e61144764a3",
      "name": "Formatear Resumen Diario"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos para el bucle de envío masivo\nconst resumenFormateado = $json.texto;\n\n// Obtener TODOS los usuarios registrados usando método robusto\nconst usuariosData = $('Consultar Usuarios Registrados y Validados').all();\nlet usuariosRegistrados = [];\n\nconsole.log('📨 Preparando envío masivo del resumen diario...');\nconsole.log('📊 Datos recibidos de PostgreSQL:', usuariosData.length, 'items');\n\n// PostgreSQL devuelve cada registro como un item separado\n// Necesitamos recopilar todos los usuarios de todos los items\nfor (const item of usuariosData) {\n  if (item.json) {\n    // Si el item tiene propiedades de usuario directamente\n    if (item.json.user_id && item.json.user_name && item.json.chat_id) {\n      usuariosRegistrados.push(item.json);\n      console.log('👤 Usuario encontrado:', item.json.user_name, '(ID:', item.json.user_id, ')');\n    }\n    // Si el item tiene un array result (formato alternativo)\n    else if (Array.isArray(item.json.result)) {\n      usuariosRegistrados.push(...item.json.result);\n      console.log('👥 Usuarios en result:', item.json.result.length);\n    }\n    // Si es un array directo\n    else if (Array.isArray(item.json)) {\n      usuariosRegistrados.push(...item.json);\n      console.log('👥 Usuarios en array:', item.json.length);\n    }\n  }\n}\n\nconsole.log('👥 Usuarios registrados encontrados:', usuariosRegistrados.length);\nconsole.log('👥 Lista de usuarios:', usuariosRegistrados);\n\n// Verificar que hay usuarios registrados\nif (!Array.isArray(usuariosRegistrados) || usuariosRegistrados.length === 0) {\n  console.log('⚠️ No se encontraron usuarios registrados para enviar el resumen');\n  return {\n    json: {\n      error: true,\n      mensaje: 'No hay usuarios registrados para enviar el resumen diario',\n      debug_data: usuariosData\n    }\n  };\n}\n\nconsole.log('📋 === PREPARANDO ITEMS PARA SPLITINBATCHES ===');\nconsole.log('🔄 Total de usuarios a procesar:', usuariosRegistrados.length);\n\n// Crear items individuales para splitInBatches con formato N8N correcto\nconst itemsParaBucle = usuariosRegistrados.map((usuario, index) => {\n  const item = {\n    json: {\n      usuario: usuario,\n      resumen_texto: resumenFormateado,\n      index: index,\n      total: usuariosRegistrados.length\n    }\n  };\n  \n  console.log(`📝 Item ${index + 1}: ${usuario.user_name} (${usuario.chat_id})`);\n  return item;\n});\n\nconsole.log('✅ Items preparados para splitInBatches:', itemsParaBucle.length);\nconsole.log('📊 Primer item ejemplo:', JSON.stringify(itemsParaBucle[0], null, 2));\n\n// Retornar array de objetos con formato N8N correcto\nreturn itemsParaBucle;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3072,
        -8096
      ],
      "id": "8eb0f576-71d1-465b-9cf5-b760c5ef8e42",
      "name": "Preparar Envío Masivo"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -2784,
        -8096
      ],
      "id": "a3ad4c44-5c95-4207-b2dc-c66445bebd7a",
      "name": "Bucle por Usuario"
    },
    {
      "parameters": {
        "jsCode": "// Procesar item individual del bucle\nconst itemActual = $json;\n\nconsole.log('🔍 === PREPARAR MENSAJE INDIVIDUAL ===');\nconsole.log('🔍 Datos recibidos:', JSON.stringify(itemActual, null, 2));\n\n// Si son datos de respuesta de Telegram, pasar sin procesar para que el bucle continúe\nif (itemActual.ok && itemActual.result) {\n  console.log('⚠️ Respuesta de Telegram detectada - saltando procesamiento');\n  // Retornar datos marcados para saltar en Control de Envío\n  return {\n    json: {\n      skip: true,\n      reason: 'telegram_response'\n    }\n  };\n}\n\n// Verificar si tenemos los datos correctos del usuario\nif (!itemActual.usuario || !itemActual.usuario.user_name) {\n  console.log('⚠️ Datos sin estructura de usuario válida - saltando');\n  return {\n    json: {\n      skip: true,\n      reason: 'invalid_user_data',\n      received_data: itemActual\n    }\n  };\n}\n\nconst usuario = itemActual.usuario;\nconst resumenTexto = itemActual.resumen_texto;\nconst index = itemActual.index;\nconst total = itemActual.total;\n\nconsole.log(`📤 ✅ PROCESANDO USUARIO VÁLIDO ${index + 1}/${total}: ${usuario.user_name} (${usuario.chat_id})`);\n\n// Retornar datos formateados para Telegram en formato correcto de n8n\nreturn {\n  json: {\n    chat_id: usuario.chat_id,\n    texto: resumenTexto,\n    user_name: usuario.user_name,\n    user_id: usuario.user_id,\n    odoo_user: usuario.odoo_user,\n    mensaje_numero: index + 1,\n    total_usuarios: total,\n    skip: false\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2512,
        -8064
      ],
      "id": "42d0187a-92c6-40dd-aaa1-5a0446ba2c02",
      "name": "Preparar Mensaje Individual"
    },
    {
      "parameters": {
        "jsCode": "// Consultar eventos personalizados para el usuario actual usando odoo_user\nconst itemActual = $json;\n\nconsole.log('📅 === CONSULTA EVENTOS PERSONALIZADA (ODOO_USER) ===');\nconsole.log('📋 Datos recibidos:', JSON.stringify(itemActual, null, 2));\n\nconst odooUser = itemActual.odoo_user; // <-- clave\nconst fechaHoy = new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Madrid' }); // YYYY-MM-DD Madrid\n\nif (!odooUser) {\n  console.log('⚠️ El usuario no tiene odoo_user, no se puede filtrar en Odoo');\n  return {\n    json: {\n      ...itemActual,\n      eventos_personalizados: [],\n      mensaje_eventos: '📅 **TU AGENDA DEL DÍA**\\n⚠️ No tienes usuario Odoo vinculado (odoo_user vacío)\\n',\n      consulta_eventos: null\n    }\n  };\n}\n\n// Obtener UID de autenticación de Odoo\nconst autenticacionData = $('Autenticar Odoo para Resumen').all();\nlet uid = null;\nfor (const item of autenticacionData) {\n  if (item.json && item.json.result) {\n    uid = item.json.result;\n    break;\n  }\n}\n\nif (!uid) {\n  throw new Error('❌ No se pudo obtener UID para consulta personalizada');\n}\n\n// 1) Buscar res.users por login EXACTO = odoo_user\nconst payloadBuscarUser = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"res.users\",\n      \"search_read\",\n      [[[\"login\", \"=\", odooUser]]],\n      { fields: [\"id\", \"name\", \"login\", \"partner_id\"], limit: 1 }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  json: {\n    ...itemActual,\n    fecha: fechaHoy,\n    uid,\n    odoo_user: odooUser,\n    payload_buscar_user: payloadBuscarUser\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2336,
        -8064
      ],
      "id": "df465939-7b27-449f-8af5-3c9e744c885b",
      "name": "Consultar Eventos Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.consulta_fsm) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1760,
        -8064
      ],
      "id": "b26cc17c-911b-4f43-b2d1-184c77ec533f",
      "name": "HTTP Eventos Personalizados"
    },
    {
      "parameters": {
        "jsCode": "// Consultar tareas del día anterior del usuario (simplificado)\nconst eventosRespuesta = $json.result || [];\nconst datosUsuario = $('Consultar Eventos Usuario').first().json;\nconst userName = datosUsuario.usuario_actual || datosUsuario.user_name;\nconst uid = datosUsuario.uid;\n\nconsole.log('📊 === CONSULTA TAREAS AYER ===');\nconsole.log('👤 Usuario:', userName);\nconsole.log('🔑 UID:', uid);\n\nif (!uid) {\n  console.log('❌ No hay UID válido, omitiendo consulta de tareas');\n  return {\n    json: {\n      ...datosUsuario,\n      eventos_personalizados: eventosRespuesta,\n      tareas_ayer: [],\n      usuario_encontrado: false,\n      error_uid: true\n    }\n  };\n}\n\n// Calcular fecha de tareas (ayer o viernes si hoy es lunes)\nconst hoy = new Date();\nconst diaSemana = hoy.getDay(); // 0=domingo, 1=lunes, 2=martes, etc.\nlet fechaTareas;\nlet descripcionDia;\n\nif (diaSemana === 1) { // Si hoy es lunes\n  // Buscar tareas del viernes (3 días atrás)\n  fechaTareas = new Date(hoy);\n  fechaTareas.setDate(hoy.getDate() - 3);\n  descripcionDia = 'viernes';\n  console.log('🗓️ Hoy es lunes, buscando tareas del viernes anterior');\n} else {\n  // Buscar tareas de ayer\n  fechaTareas = new Date(hoy);\n  fechaTareas.setDate(hoy.getDate() - 1);\n  descripcionDia = 'ayer';\n  console.log('📅 Buscando tareas del día anterior');\n}\n\nconst fechaTareasStr = fechaTareas.toISOString().split('T')[0];\n\nconsole.log('📅 Fecha tareas:', fechaTareasStr, '(' + descripcionDia + ')');\nconsole.log('📅 Día de la semana actual:', diaSemana, '(1=lunes)');\n\n// Consulta simplificada: buscar tareas directamente por nombre de usuario\nconst consultaTareasAyer = {\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"search_read\",\n      [\n        [\n          [\"date\", \"=\", fechaTareasStr],\n          \"|\",\n          [\"user_id.name\", \"ilike\", userName],\n          [\"employee_id.name\", \"ilike\", userName]\n        ]\n      ],\n      {\n        \"fields\": [\n          \"name\", \"project_id\", \"task_id\", \"unit_amount\", \n          \"date\", \"employee_id\", \"user_id\"\n        ],\n        \"order\": \"unit_amount desc\",\n        \"limit\": 20\n      }\n    ]\n  },\n  \"id\": Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Consulta directa de tareas para:', userName, 'en fecha:', fechaTareasStr, '(' + descripcionDia + ')');\n\nreturn {\n  json: {\n    ...datosUsuario,\n    eventos_personalizados: eventosRespuesta,\n    consulta_tareas: consultaTareasAyer,\n    fecha_tareas: fechaTareasStr,\n    descripcion_dia: descripcionDia,\n    es_lunes: diaSemana === 1,\n    paso: 'consultar_tareas_directa'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1552,
        -8064
      ],
      "id": "3fb6a091-4372-4a13-be63-31992bef09a6",
      "name": "Preparar Consulta Tareas Ayer"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.consulta_tareas) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1312,
        -8064
      ],
      "id": "929454ff-e89c-49ac-a8e1-995c0b10fb42",
      "name": "HTTP Consultar Tareas Ayer"
    },
    {
      "parameters": {
        "jsCode": "// Formatear resumen personalizado: FSM hoy (project.task) + tareas ayer (account.analytic.line)\nconst tareasAyerRespuesta = $json.result || [];\nconst datosTareas = $('Preparar Consulta Tareas Ayer').first().json;\n\n// OJO: aquí \"eventos_personalizados\" ahora realmente son tareas FSM de hoy (project.task)\nconst eventosPersonalizados = datosTareas.eventos_personalizados || [];\n\nconsole.log('📊 === FORMATEAR RESUMEN PERSONALIZADO ===');\nconsole.log('📋 Datos tareas:', JSON.stringify(datosTareas, null, 2));\n\n// Obtener datos del usuario correctamente\nconst userName = datosTareas.usuario_actual || datosTareas.user_name;\nconst userId = datosTareas.user_id;\nconst chatId = datosTareas.chat_id;\nconst fechaHoy = datosTareas.fecha;\nconst fechaTareas = datosTareas.fecha_tareas;\nconst descripcionDia = datosTareas.descripcion_dia;\nconst esLunes = datosTareas.es_lunes;\nconst mensajeNumero = datosTareas.mensaje_numero;\nconst totalUsuarios = datosTareas.total_usuarios;\nconst errorUid = datosTareas.error_uid;\n\nconsole.log('👤 Usuario:', userName);\nconsole.log('🛠️ Planificación (FSM) hoy:', eventosPersonalizados.length);\nconsole.log('📊 Tareas ayer encontradas:', tareasAyerRespuesta.length);\nconsole.log('📅 Fecha tareas:', fechaTareas, '(' + descripcionDia + ')');\nconsole.log('🗓️ Es lunes:', esLunes);\n\n// Formatear fecha de hoy\nconst fechaFormateada = new Date(fechaHoy).toLocaleDateString('es-ES', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\n\n// Formatear fecha de tareas (ayer o viernes)\nconst fechaTareasFormateada = new Date(fechaTareas).toLocaleDateString('es-ES', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\n\n// FUNCIÓN PARA CONVERTIR UTC A HORA LOCAL ESPAÑOLA\nconst convertirUTCaHoraLocal = (fechaString) => {\n  if (!fechaString) return '--:--';\n\n  try {\n    // Forzamos UTC porque Odoo suele devolver sin zona\n    const fechaUTC = new Date(fechaString + 'Z');\n    return fechaUTC.toLocaleTimeString('es-ES', {\n      hour: '2-digit',\n      minute: '2-digit',\n      timeZone: 'Europe/Madrid'\n    });\n  } catch (error) {\n    console.log('❌ Error convirtiendo hora:', error);\n    return '--:--';\n  }\n};\n\n// =====================\n// SECCIÓN: PLANIFICACIÓN HOY (FSM / project.task)\n// =====================\nlet seccionEventos = `🛠️ **TU PLANIFICACIÓN PARA ${fechaFormateada.toUpperCase()}**\\n\\n`;\n\nif (!Array.isArray(eventosPersonalizados) || eventosPersonalizados.length === 0) {\n  seccionEventos += '🌟 **¡Día libre!** No tienes tareas planificadas\\n\\n';\n} else {\n  seccionEventos += `📋 **Tienes ${eventosPersonalizados.length} tarea(s) planificada(s):**\\n\\n`;\n\n  eventosPersonalizados.forEach((evento, index) => {\n    // evento = project.task\n    const inicio = convertirUTCaHoraLocal(evento.planned_date_begin);\n    const fin = convertirUTCaHoraLocal(evento.date_deadline);\n\n    const cliente = evento.partner_id?.[1] || null;\n    const proyecto = evento.project_id?.[1] || null;\n    const etapa = evento.stage_id?.[1] || null;\n\n    seccionEventos += `${index + 1}. **${evento.name || 'Sin título'}**\\n`;\n    seccionEventos += `   🕐 ${inicio} - ${fin}`;\n\n    // Cliente (en vez de location)\n    if (cliente) {\n      seccionEventos += ` | 📍 ${cliente}`;\n    }\n\n    // Info extra útil (opcional y corta)\n    const extras = [];\n    if (proyecto) extras.push(`📁 ${proyecto}`);\n    if (etapa) extras.push(`🏷️ ${etapa}`);\n    if (extras.length) {\n      seccionEventos += `\\n   ${extras.join(' | ')}`;\n    }\n\n    seccionEventos += '\\n\\n';\n  });\n}\n\n// =====================\n// SECCIÓN: TAREAS AYER (NO TOCAR, ya funciona)\n// =====================\nconst tituloTareas = esLunes\n  ? `📊 **TUS TAREAS DEL ${fechaTareasFormateada.toUpperCase()}** 📅 (último día laboral)`\n  : `📊 **TUS TAREAS DEL ${fechaTareasFormateada.toUpperCase()}**`;\n\nlet seccionTareas = `${tituloTareas}\\n\\n`;\n\nif (errorUid || tareasAyerRespuesta.length === 0) {\n  seccionTareas += '⚠️ **No se encontraron tareas registradas**\\n\\n';\n} else {\n  // Agrupar tareas por proyecto\n  const tareasPorProyecto = {};\n  let totalHoras = 0;\n\n  tareasAyerRespuesta.forEach(tarea => {\n    const proyectoNombre = tarea.project_id ? tarea.project_id[1] : 'Sin proyecto';\n    const tareaInfo = tarea.task_id ? ` - ${tarea.task_id[1]}` : '';\n    const descripcion = tarea.name || 'Sin descripción';\n    const horas = tarea.unit_amount || 0;\n\n    totalHoras += horas;\n\n    if (!tareasPorProyecto[proyectoNombre]) {\n      tareasPorProyecto[proyectoNombre] = [];\n    }\n\n    tareasPorProyecto[proyectoNombre].push({\n      tarea: tareaInfo,\n      descripcion: descripcion,\n      horas: horas\n    });\n  });\n\n  seccionTareas += `⏱️ **Total: ${totalHoras.toFixed(2)} horas registradas**\\n\\n`;\n\n  Object.keys(tareasPorProyecto).forEach((proyecto, index) => {\n    const tareas = tareasPorProyecto[proyecto];\n    const horasProyecto = tareas.reduce((sum, t) => sum + t.horas, 0);\n\n    seccionTareas += `${index + 1}. **${proyecto}** (${horasProyecto.toFixed(2)}h)\\n`;\n\n    tareas.forEach(tarea => {\n      seccionTareas += `   • ${tarea.descripcion}${tarea.tarea} - ${tarea.horas}h\\n`;\n    });\n\n    seccionTareas += '\\n';\n  });\n}\n\n// Resumen final\nconst resumenPersonalizado =\n  `🌅 **¡Buenos días, ${userName}!**\\n\\n` +\n  seccionEventos +\n  seccionTareas;\n\nconsole.log('✅ Resumen personalizado generado para:', userName);\n\nreturn {\n  json: {\n    chat_id: chatId,\n    texto: resumenPersonalizado,\n    user_name: userName,\n    user_id: userId,\n    mensaje_numero: mensajeNumero,\n    total_usuarios: totalUsuarios,\n    // Aquí ya no son \"eventos\", pero dejo el nombre por compatibilidad\n    eventos_personalizados: Array.isArray(eventosPersonalizados) ? eventosPersonalizados.length : 0,\n    tareas_ayer: Array.isArray(tareasAyerRespuesta) ? tareasAyerRespuesta.length : 0,\n    skip: false\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        -8064
      ],
      "id": "b4dbbbad-cdf5-4a0a-8df0-ed7262930a72",
      "name": "Formatear Resumen Personalizado"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -848,
        -8064
      ],
      "id": "daf0e52e-ab10-4f19-8ada-35eb7b70fa08",
      "name": "Telegram Envío Individual",
      "webhookId": "a059deb7-eb6b-491f-98ad-58d8100219de"
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta de Telegram y continuar bucle\nconst telegramResponse = $json;\n\nconsole.log('🧹 === NODO VACIAR - CONTINUAR BUCLE ===');\nconsole.log('📥 Respuesta de Telegram:', telegramResponse.ok ? '✅ Éxito' : '❌ Error');\n\n// Obtener datos del contexto del bucle desde el nodo de resumen personalizado\nconst datosDelBucle = $('Formatear Resumen Personalizado').first().json;\nconst mensajeNumero = datosDelBucle.mensaje_numero || 1;\nconst totalUsuarios = datosDelBucle.total_usuarios || 0;\nconst userName = datosDelBucle.user_name || 'Usuario';\n\nconsole.log(`📊 ✅ Iteración ${mensajeNumero}/${totalUsuarios} completada`);\nconsole.log(`👤 Usuario procesado: ${userName} (${datosDelBucle.chat_id})`);\nconsole.log(`📅 Eventos personalizados: ${datosDelBucle.eventos_personalizados || 0}`);\n\nif (telegramResponse.ok) {\n  console.log('📤 ✅ Mensaje enviado exitosamente');\n} else {\n  console.log('📤 ❌ Error en envío:', telegramResponse.description || 'Error desconocido');\n}\n\n// Verificar si es la última iteración\nif (mensajeNumero >= totalUsuarios) {\n  console.log('🎉 ¡Última iteración completada! Bucle terminado.');\n  console.log(`✅ Resumen personalizado enviado a ${totalUsuarios} usuarios`);\n} else {\n  console.log(`➡️ Preparando siguiente iteración (${mensajeNumero + 1}/${totalUsuarios})`);\n}\n\n// CLAVE: Enviar señal vacía para que splitInBatches continúe\n// pero sin datos que interfieran con el siguiente elemento del array\nreturn {\n  json: {}\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -656,
        -8064
      ],
      "id": "4dc96c1a-61eb-4237-8dc3-5a00dfdc42cd",
      "name": "Vaciar"
    },
    {
      "parameters": {
        "content": "## Mensaje diario resumen",
        "height": 80,
        "width": 380,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5120,
        -8192
      ],
      "id": "4af7eb38-1dd7-404c-8443-527ec9ff6516",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "",
        "width": 3940,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5120,
        -8112
      ],
      "typeVersion": 1,
      "id": "17f05b3c-4e32-4473-94f6-c9a8ceb5d92b",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "es-correo-condition",
              "leftValue": "={{ String($json.mensaje_usuario || '').trim().toLowerCase().match(/^mi\\s+correo\\s+(es|:)\\s*(.+)$/i) !== null }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5840,
        -8960
      ],
      "id": "b5c3a534-d29d-4bd1-8472-dd4399cbe9a6",
      "name": "¿Es Usuario Pasando Mail?"
    },
    {
      "parameters": {
        "jsCode": "// Extraer SOLO el correo del mensaje\nconst datosExtraer = $('Extraer Datos').item.json;\nconst mensaje = String(datosExtraer.mensaje_usuario || '').trim();\n\n// Patrón: mi correo es X\nconst regex = /^mi\\s+correo\\s+(?:es|:)\\s*([^ \\t@]+@[^ \\t@]+\\.[^ \\t@]+)\\s*$/i;\n\nconst match = mensaje.match(regex);\n\nif (!match) {\n  console.log('❌ No coincide con el patrón de correo simple');\n  console.log('Mensaje recibido:', mensaje);\n  return {\n    ...datosExtraer,\n    correo_invalido: true,\n    correo_valido: false,\n    error_mensaje: 'Formato inválido. Usa: mi correo es tu@email.com',\n  };\n}\n\nconst correo = match[1].trim();\n\nconsole.log('✅ Correo extraído:', correo);\n\n// Validación básica de correo\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(correo)) {\n  console.log('❌ Formato de correo inválido:', correo);\n  return {\n    ...datosExtraer,\n    correo_invalido: true,\n    correo_texto: correo,\n    correo_valido: false,\n    error_mensaje: 'El correo no tiene un formato válido',\n  };\n}\n\n// Verificar si hay memoria de solicitud de correo para notificar al admin\nconst chatId = datosExtraer.chat_id || datosExtraer.user_id;\nconst userId = datosExtraer.user_id;\nconst userName = datosExtraer.user_name;\nconst contextoKey = `memoria_${chatId}`;\nconst memoria = global[contextoKey] || {};\n\nlet hayAdminEsperando = false;\nlet adminChatId = null;\n\nif (memoria.esperando_correo) {\n  console.log('✅ Hay un admin esperando este correo');\n  hayAdminEsperando = true;\n  adminChatId = memoria.admin_chat_id;\n}\n\nreturn {\n  ...datosExtraer,\n  correo_extraido: correo,\n  // el resto ya no nos interesa, pero dejamos los campos sin usar\n  user_id_actualizar: userId,\n  user_name_actualizar: userName,\n  admin_esperando: hayAdminEsperando,\n  admin_chat_id: adminChatId,\n  correo_valido: true\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5536,
        -9408
      ],
      "id": "b5be1786-a9d7-462c-8a0e-4194558a2d34",
      "name": "Extraer y Validar Correo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "correo-valido-check",
              "leftValue": "={{ $json.correo_valido === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5344,
        -9392
      ],
      "id": "c4d089f0-d517-404b-a361-a38200a24407",
      "name": "¿Correo Válido?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE telegram_users\nSET user_mail = $1\nWHERE user_id = $2\n",
        "options": {
          "queryReplacement": "={{ [ $json.correo_extraido, parseInt($json.user_id_actualizar) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5136,
        -9488
      ],
      "id": "a1d1983a-e942-44b1-999a-93809cee97a5",
      "name": "Actualizar Correo en BD"
    },
    {
      "parameters": {
        "jsCode": "// Limpiar memoria si había admin esperando y preservar todos los datos\n// IMPORTANTE: Tomar datos del nodo anterior al UPDATE porque UPDATE solo devuelve success\nconst datosCompletos = $('¿Correo Válido?').item.json;\nconst chatId = datosCompletos.chat_id || datosCompletos.user_id;\nconst contextoKey = `memoria_${chatId}`;\n\n// Limpiar memoria solo si había solicitud pendiente\nif (global[contextoKey] && global[contextoKey].esperando_correo) {\n  console.log('🧹 Limpiando memoria de solicitud de correo');\n  delete global[contextoKey].esperando_correo;\n  delete global[contextoKey].user_id_validar;\n  delete global[contextoKey].user_name_validar;\n  delete global[contextoKey].chat_id_validar;\n  delete global[contextoKey].admin_chat_id;\n}\n\nconsole.log('✅ === CORREO ACTUALIZADO ===');\nconsole.log('Usuario:', datosCompletos.user_name_actualizar);\nconsole.log('Correo:', datosCompletos.correo_extraido);\n\n// Preservar todos los datos necesarios para el siguiente nodo\nreturn {\n  chat_id: datosCompletos.chat_id,\n  user_id: datosCompletos.user_id,\n  user_name: datosCompletos.user_name,\n  user_id_actualizar: datosCompletos.user_id_actualizar,\n  user_name_actualizar: datosCompletos.user_name_actualizar,\n  correo_extraido: datosCompletos.correo_extraido,\n  admin_esperando: datosCompletos.admin_esperando,\n  admin_chat_id: datosCompletos.admin_chat_id,\n  correo_guardado: true,\n  success: $json.success || true\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4960,
        -9488
      ],
      "id": "5061d65f-66d5-4954-a6cc-8c9849276e61",
      "name": "Limpiar Memoria Correo"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id && $json.chat_id !== 'null' && $json.chat_id !== '' ? Number($json.chat_id) : Number($json.user_id || $json.user_id_actualizar) }}",
        "text": "=✅ **Correo actualizado correctamente**\n\n📧 **Correo:** `{{ $json.correo_extraido }}`\n\n⏳ Ahora el administrador podrá completar tu validación.\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4784,
        -9488
      ],
      "id": "15740f54-0198-45b4-b0fd-ebf677086e1f",
      "name": "Confirmar Correo al Usuario",
      "webhookId": "confirmar-correo-usuario-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "=✅ **Usuario ha enviado su correo**\n\n👤 **Usuario:** {{$node[\"Limpiar Memoria Correo\"].json[\"user_name_actualizar\"]}}\n📧 **Correo:** `{{$node[\"Limpiar Memoria Correo\"].json[\"correo_extraido\"]}}`\n\n✅ Ahora puedes validarlo con:\n`validar {{$node[\"Limpiar Memoria Correo\"].json[\"user_name_actualizar\"]}}`\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4528,
        -9536
      ],
      "id": "8545898e-bdbf-4243-ab7c-4a9d93643f70",
      "name": "Notificar Admin Correo Recibido",
      "webhookId": "notificar-admin-correo-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=❌ **Datos inválidos**\n\n⚠️ {{ $json.error_mensaje || 'El formato que enviaste no es válido.' }}\n\n✉️ **Por favor, envía tus datos con el siguiente formato:**\n\n`mi correo es pepe@gmail.com`\n\n📝 **Recuerda incluir:**\n• Correo electrónico válido",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4912,
        -9328
      ],
      "id": "f5b00b42-1e2e-4981-82eb-c24da3d9183a",
      "name": "Error Correo Inválido",
      "webhookId": "error-correo-invalido-webhook-001"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.img_data.all_sizes[$json.img_data.all_sizes.length - 1].file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4080,
        -9344
      ],
      "id": "945aa339-07ee-4ae0-909d-b05d34b17ff4",
      "name": "Descargar Imagen Inmediatamente",
      "webhookId": "112bd982-9aa8-409c-88ac-1c3c956c0c09",
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT ultimo_horas_id, chat_id, user_id, user_name FROM n8n WHERE chat_id = $1 AND ultimo_horas_id IS NOT NULL ORDER BY updated_at DESC LIMIT 1",
        "options": {
          "queryReplacement": "={{ [$json.chat_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -3360,
        -9344
      ],
      "id": "cde639ca-7468-46dc-8772-d254df431888",
      "name": "Buscar Último Horas ID"
    },
    {
      "parameters": {
        "jsCode": "// ✅ PREPARAR ADJUNTO DIRECTO (PARTE)\n\nconst datosBase = $items('Construir URL Descarga Parte', 0)[0].json;\nconst ultimo = $items('Buscar Último Horas ID', 0)[0].json;\n\nconst horasId = Number(ultimo.ultimo_horas_id);\nif (!Number.isFinite(horasId) || horasId <= 0) {\n  throw new Error('No hay ultimo_horas_id válido para adjuntar.');\n}\n\n// 1) Intento: binario en el item actual\nlet bin = null;\nlet binKeys = Object.keys($binary || {});\nif (binKeys.length) {\n  bin = $binary[binKeys[0]];\n}\n\n// 2) Fallback: leer binario del nodo HTTP Descargar Imagen REAL\nif (!bin || !bin.data) {\n  const httpItems = $items('Descargar Imagen REAL (PARTE)', 0, 0) || [];\n  if (httpItems.length && httpItems[0].binary) {\n    const httpBinKeys = Object.keys(httpItems[0].binary);\n    if (httpBinKeys.length) {\n      bin = httpItems[0].binary[httpBinKeys[0]];\n    }\n  }\n}\n\n// 3) Si aún no hay binario, error con debug\nif (!bin || !bin.data) {\n  const debug = {\n    tieneBinaryActual: !!$binary,\n    keysBinaryActual: Object.keys($binary || {}),\n    download_url: datosBase.download_url || null,\n  };\n  throw new Error('No se encontraron datos binarios del archivo descargado | DEBUG: ' + JSON.stringify(debug));\n}\n\n// 4) Convertir base64 → Buffer\nconst archivoBinario = Buffer.from(bin.data, 'base64');\n\n// 5) Detectar mimetype/extensión\nlet mimetype = bin.mimeType || 'image/jpeg';\nlet extension = bin.fileExtension || null;\n\nif (!extension) {\n  const sig = archivoBinario.slice(0, 8).toString('hex').toUpperCase();\n  if (sig.startsWith('89504E47')) { mimetype = 'image/png'; extension = 'png'; }\n  else if (sig.startsWith('FFD8FF')) { mimetype = 'image/jpeg'; extension = 'jpg'; }\n  else { extension = mimetype.includes('png') ? 'png' : 'jpg'; }\n}\n\n// 6) Preparar adjunto Odoo\nconst archivoBase64 = archivoBinario.toString('base64');\nconst ts = new Date().toISOString().replace(/[:.]/g, '-');\nconst nombreArchivo = `Parte-${horasId}-${ts}.${extension}`;\n\nconst db = 'mchecagoshawk-webinar-main-28403608';\nconst uid = 2; // admin\n\nconst consultaAdjunto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      db,\n      uid,\n      \"admin\",\n      \"ir.attachment\",\n      \"create\",\n      [{\n        name: nombreArchivo,\n        datas: archivoBase64,\n        res_model: \"account.analytic.line\",\n        res_id: horasId,\n        mimetype: mimetype,\n        type: \"binary\"\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  ...datosBase,\n  horas_id: horasId,\n  imagen_lista_para_subir: true,\n  imagen_adjuntada: true,\n  consulta_adjunto: consultaAdjunto,\n  archivo_info: {\n    nombre: nombreArchivo,\n    mimetype,\n    tamaño: archivoBinario.length\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3200,
        -9344
      ],
      "id": "5a3b0839-273b-4a08-a494-78a349072cf9",
      "name": "Adjuntar Imagen al Último Parte"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "adjuntar-imagen-cond-001",
              "leftValue": "={{ $json.imagen_lista_para_subir === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3040,
        -9344
      ],
      "id": "7ef02597-56d1-40c3-9878-f45aeff8b4e5",
      "name": "¿Tiene Imagen para Adjuntar (Último)?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Construir URL Descarga Parte').item.json.chat_id }}",
        "text": "=📸 **Imagen adjuntada al último parte de trabajo**\n\n✅ La imagen ha sido adjuntada al parte de trabajo más reciente (ID: {{ $json.task_id }}).\n\n{{ $json.nombre_archivo ? '📁 **Archivo:** ' + $json.nombre_archivo : '' }}\n\n💡 Si querías adjuntarla a otro parte, primero registra un nuevo parte de trabajo.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1872,
        -9488
      ],
      "id": "a3358dc3-75f1-4198-b43b-a811d7549cf8",
      "name": "Confirmar Imagen Adjuntada (Último)",
      "webhookId": "imagen-adjuntada-ultimo-webhook-001"
    },
    {
      "parameters": {
        "content": "## Registra usuario, avisa a admin del nuevo registro y revisa el limite de consultas realizadas",
        "height": 864,
        "width": 1552
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3536,
        -9728
      ],
      "typeVersion": 1,
      "id": "52dc4de3-0aa7-4078-a68a-8c914d1dfae2",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Registro Usuario').item.json.chat_id }}",
        "text": "=Hola, soy tu asistente AzerionBot 🤖.\nTu usuario aún está pendiente de validación.\n📋 **¿Ya enviaste tu correo electrónico?** Si no lo has hecho, envía un mensaje con este formato:\n`mi correo es tu@email.com`\n⏳ En cuanto un administrador lo active, podrás continuar sin problema 🚀. ¡Gracias por tu paciencia!",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -752,
        -9712
      ],
      "id": "a118f6eb-8275-48c3-bce1-7943b469bb72",
      "name": "Mensaje nuevo registro sin user",
      "webhookId": "a60338e6-2cca-4589-90ce-e811f19111be"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "76440ca2-83c3-4912-81d9-b4a5353324c4",
              "leftValue": "={{ $json.odoo_user }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "80c36466-afdc-49c6-89af-744df0e95892",
              "leftValue": "={{ $('Extraer Datos').item.json.mensaje_usuario }}",
              "rightValue": "usuario es",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        272,
        -9248
      ],
      "id": "3a55ea52-2268-4703-bcde-791570b2987c",
      "name": "If2"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 4 * * 1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -5104,
        -7664
      ],
      "id": "a76d7665-d028-4763-8df0-60a1ba438274",
      "name": "Trigger Informe Semanal Lunes 10:00"
    },
    {
      "parameters": {
        "jsCode": "function formatDate(d){ return d.toISOString().split('T')[0]; }\nconst hoy = new Date();\nconst day = hoy.getDay(); // 0=Dom, 1=Lun\nconst diffToMonday = ((day + 6) % 7);\nconst lunesActual = new Date(hoy);\nlunesActual.setDate(hoy.getDate() - diffToMonday);\nconst lunesAnterior = new Date(lunesActual);\nlunesAnterior.setDate(lunesActual.getDate() - 7);\nconst domingoAnterior = new Date(lunesAnterior);\ndomingoAnterior.setDate(lunesAnterior.getDate() + 6);\n\nreturn {\n  rango: { desde: formatDate(lunesAnterior), hasta: formatDate(domingoAnterior) }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4896,
        -7664
      ],
      "id": "4e0ddff3-fc48-44bc-8c2c-16dbe788f551",
      "name": "Preparar Informe Semanal"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\"jsonrpc\": \"2.0\", \"method\": \"call\", \"params\": {\"service\": \"common\", \"method\": \"authenticate\", \"args\": [\"mchecagoshawk-webinar-main-28403608\", \"admin\", \"admin\", {}]}, \"id\": 1}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4496,
        -7664
      ],
      "id": "5163a578-2779-46e4-9cfb-34ae2e29f98d",
      "name": "Autenticar Odoo para Resumen Semanal"
    },
    {
      "parameters": {
        "jsCode": "const uid = $item(0).$node[\"Autenticar Odoo para Resumen Semanal\"].json.result;\nif (!uid) throw new Error(\"No UID de Odoo\");\n\nconst rango = $item(0).$node[\"Preparar Informe Semanal\"].json.rango;\nconst { desde, hasta } = rango;\n\nconst desdeTS = `${desde} 00:00:00`;\nconst hastaTS = `${hasta} 23:59:59`;\n\nconst db = \"mchecagoshawk-webinar-main-28403608\";\nconst password = \"admin\";\nconst ctx = { tz: \"Europe/Madrid\" };\n\nconst ventas_domain = [\n  [\"state\",\"in\",[\"sale\",\"done\"]],\n  [\"date_order\",\">=\",desdeTS],\n  [\"date_order\",\"<=\",hastaTS],\n];\n\n\nconst payload_ventas = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      db, uid, password,\n      \"sale.order\", \"search_read\",\n      [ventas_domain],\n      { fields: [\"id\",\"name\",\"state\",\"amount_total\",\"currency_id\",\"date_order\"], context: ctx }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\n/** ---------- LEADS ---------- */\nconst payload_leads = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      db, uid, password,\n      \"crm.lead\", \"search_read\",\n      [[\n        [\"type\",\"=\",\"opportunity\"],\n        [\"create_date\",\">=\",desdeTS],\n        [\"create_date\",\"<=\",hastaTS],\n      ]],\n      { fields: [\"id\",\"name\",\"create_date\",\"stage_id\"], context: ctx }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\n/** ---------- TICKETS ----------\n * En tu instancia no existe helpdesk.stage.is_close (lo indica el error).\n * Muchas instancias usan stage.fold para “cerrado/colapsado”.\n */\nconst tickets_domain = [\n  \"&\",\n  [\"stage_id.fold\",\"=\",true],\n  \"&\", [\"write_date\",\">=\",desdeTS], [\"write_date\",\"<=\",hastaTS],\n];\n\nconst payload_tickets = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      db, uid, password,\n      \"helpdesk.ticket\", \"search_read\",\n      [tickets_domain],\n      { fields: [\"id\",\"name\",\"stage_id\",\"write_date\"], context: ctx }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn { rango, payload_ventas, payload_leads, payload_tickets };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4288,
        -7664
      ],
      "id": "565d7d58-cdaf-4a7f-a135-5636c7916494",
      "name": "Preparar Consultas Semanales"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload_ventas }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4080,
        -7664
      ],
      "id": "e67207d3-7a6a-402c-9815-97d873f8dcc2",
      "name": "HTTP Ventas Semana"
    },
    {
      "parameters": {
        "jsCode": "const ventas = $json.result || [];\nconst total = Array.isArray(ventas) ? ventas.length : 0;\nconst importe = Array.isArray(ventas) ? ventas.reduce((a,v)=> a + (v.amount_total || 0), 0) : 0;\nreturn { total_ventas: total, importe_ventas: importe };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3872,
        -7664
      ],
      "id": "891b8a8f-c70b-4361-9fe6-9ffc444595c7",
      "name": "Guardar Ventas Semana"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $item(0).$node[\"Preparar Consultas Semanales\"].json.payload_leads }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3680,
        -7664
      ],
      "id": "6c9db58e-cb38-4a18-a670-4751073a7bd1",
      "name": "HTTP Leads Semana"
    },
    {
      "parameters": {
        "jsCode": "const leads = $json.result || [];\nreturn { total_leads: Array.isArray(leads) ? leads.length : 0 };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3472,
        -7664
      ],
      "id": "ea3205eb-ffd0-477f-bc51-d9420aaf490b",
      "name": "Guardar Leads Semana"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $item(0).$node[\"Preparar Consultas Semanales\"].json.payload_tickets }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3280,
        -7664
      ],
      "id": "a18ebf38-8a10-45dc-8e02-2645daac0bd0",
      "name": "HTTP Tickets Semana"
    },
    {
      "parameters": {
        "jsCode": "const tickets = $json.result || [];\nreturn { total_tickets: Array.isArray(tickets) ? tickets.length : 0 };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3072,
        -7664
      ],
      "id": "e711e443-1314-44e9-bbf8-48f0dbf3ac1d",
      "name": "Guardar Tickets Semana"
    },
    {
      "parameters": {
        "jsCode": "// Datos agregados\nconst rango = $item(0).$node[\"Preparar Consultas Semanales\"]?.json.rango\n  || $item(0).$node[\"Preparar Informe Semanal\"]?.json.rango;\n\nconst totalVentas   = $item(0).$node[\"Guardar Ventas Semana\"]?.json.total_ventas || 0;\nconst importeVentas = $item(0).$node[\"Guardar Ventas Semana\"]?.json.importe_ventas || 0;\nconst totalLeads    = $item(0).$node[\"Guardar Leads Semana\"]?.json.total_leads || 0;\nconst totalTickets  = $item(0).$node[\"Guardar Tickets Semana\"]?.json.total_tickets || 0;\n\n// Trae todos los usuarios del nodo Postgres\nconst usuarios = $(\"Consultar Usuarios Registrados y Validados Semanal\").all().map(i => i.json);\n\n// Mensaje en HTML (evitamos MarkdownV2)\nconst titulo = `📊 Informe semanal (${rango.desde} a ${rango.hasta})`;\nconst textoBase =\n  `<b>${titulo}</b>\\n\\n` +\n  `• <b>Ventas</b>: ${totalVentas} (importe total: €${importeVentas.toFixed(2)})\\n` +\n  `• <b>Leads</b>: ${totalLeads}\\n` +\n  `• <b>Tickets cerrados</b>: ${totalTickets}\\n\\n` +\n  `⏰ Enviado automáticamente cada lunes a las 10:00 (Europe/Madrid)`;\n\n// Devuelve un item por usuario\nreturn usuarios.map(u => ({\n  json: {\n    chat_id: u.chat_id,\n    texto: textoBase\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2864,
        -7664
      ],
      "id": "5a009fca-639c-425a-922b-18dd9e217651",
      "name": "Formatear Informe Semanal"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2656,
        -7664
      ],
      "id": "4fcc13a8-abed-4db6-8c90-17e251952123",
      "name": "Enviar Informe Semanal Telegram",
      "webhookId": "f708491c-63bc-4dc9-a6c1-6494a91fb7c2"
    },
    {
      "parameters": {
        "content": "## Mensaje Informe Semanal \n",
        "height": 256,
        "width": 2688,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5136,
        -7776
      ],
      "id": "8e01e9ed-a181-4d29-a4ae-5e546dd6fca4",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT consultas_restantes, usuario_valido, is_admin\nFROM telegram_users\nWHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ [parseInt($('Procesar Resultado Verificación').item.json.user_id)] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -704,
        -9104
      ],
      "id": "e668ba18-0e0a-40bd-9614-3b85ee519e7b",
      "name": "Consultar Límite Usuario"
    },
    {
      "parameters": {
        "jsCode": "const base = $('Limpiar Datos Registro').first().json;\nconst fila = $json || {};\n\nif ($json.es_fallback === true || base.es_fallback === true) {\n  return { ...base, puede_continuar: true, es_fallback: true };\n}\n\nconst isAdmin = fila.is_admin === true || fila.is_admin === 'true';\nconst usuarioValido = fila.usuario_valido === true || fila.usuario_valido === 'true';\nconst restantes = parseInt(fila.consultas_restantes ?? 0, 10);\n\nif (isAdmin) return { ...base, puede_continuar: true };\nif (!usuarioValido) return { ...base, puede_continuar: false, texto_bloqueo: 'Hola, soy tu asistente AzerionBot 🤖. Tu usuario aún está pendiente de validación.\\n\\n📋 **¿Ya enviaste tu correo electrónico?**\\nSi no lo has hecho, envía un mensaje con este formato:\\n\\n`mi correo es tu@email.com`\\n\\n⏳ En cuanto un administrador lo active, podrás continuar sin problema 🚀. ¡Gracias por tu paciencia!' };\nif (!Number.isFinite(restantes) || restantes <= 0) {\n  return { ...base, puede_continuar: false, texto_bloqueo: `Has alcanzado el límite de consultas disponibles.\\n\nSi deseas seguir utilizando el servicio o resolver tus dudas, puedes ponerte en contacto con nuestros profesionales en:\\n\n📧 laura.sanchez@goshawkanalytics.com \\n \n📧 marcos.checa@goshawkanalytics.com` };\n}\nreturn { ...base, puede_continuar: true };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        -9104
      ],
      "id": "316d55b9-ac3b-4515-aaab-6c0b4aa51045",
      "name": "Aplicar Límite Consultas"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "196f8ea7-508c-42be-8db3-1ffa1505c489",
              "leftValue": "={{ $json.puede_continuar }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -288,
        -9104
      ],
      "id": "f0aa4159-1ed8-4fda-b942-8a16b2a165ab",
      "name": "¿Puede Continuar?"
    },
    {
      "parameters": {
        "chatId": "={{ Number($('Extraer Datos').first().json.chat_id || $('Limpiar Datos Registro').first().json.chat_id || $json.chat_id) }}",
        "text": "={{$json.texto_bloqueo}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -48,
        -8976
      ],
      "id": "ef01396c-7a7d-4532-8d1a-315d672ed3d1",
      "name": "Aviso Bloqueo",
      "webhookId": "0b44b88f-28dc-4008-a15b-5a9af5d6d273"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT chat_id FROM telegram_users WHERE is_admin = true",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -608,
        -9488
      ],
      "id": "a38e1e38-7e3b-45c5-95b8-3d40aa272ea8",
      "name": "Listar Admins"
    },
    {
      "parameters": {
        "jsCode": "const u = $('Preparar Registro Usuario').first().json;\nconst texto = `Un nuevo usuario de nombre \"${u.user_name}\" quiere registrarse. Valídalo para que pueda continuar (comando: validar ${u.user_name}).`;\nreturn { texto, nuevo_user_chat_id: u.chat_id, nuevo_user_name: u.user_name };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        -9488
      ],
      "id": "ce33e627-97ff-4aff-a131-b763b901fc7c",
      "name": "Mensaje para Admins de Nuevo Usuario"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $('Mensaje para Admins de Nuevo Usuario').item.json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -432,
        -9488
      ],
      "id": "5e7c717f-0ad0-46e2-b0bb-9876699a4dde",
      "name": "Avisar Admin Nuevo Usuario",
      "webhookId": "bc709e5b-d58d-4af8-87fb-33732614c610"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "78dccaed-58f8-4e23-a645-5f2340600a0e",
              "leftValue": "={{ $json.usuario_existe }}",
              "rightValue": "=false",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1568,
        -9104
      ],
      "id": "b3282792-52d0-4c53-b2a3-90f85ff0b7be",
      "name": "¿Usuario Existe?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "82a258a6-ba2d-422c-80f3-2c3fce01ef03",
              "leftValue": "={{ String(($json.mensaje_usuario || '')).trim().toLowerCase().startsWith('validar ') || String(($json.mensaje_usuario || '')).trim().toLowerCase().startsWith('/validar ') }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6128,
        -9536
      ],
      "id": "ed7234cd-e6ca-49a0-a95c-ce1ac4013b8d",
      "name": "¿Es Comando Validar?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT is_admin\nFROM telegram_users\nWHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ [ parseInt($('Extraer Datos').item.json.user_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5920,
        -9632
      ],
      "id": "3e66543f-5945-43ad-b3ff-9e4126e363c8",
      "name": "¿Es Admin?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b071b90c-f7bf-425c-b01f-f2c17272c3d6",
              "leftValue": "={{ $json.is_admin === true || $json.is_admin === 'true' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5776,
        -9728
      ],
      "id": "24b1f706-793f-45f5-8290-a22c2f95282b",
      "name": "¿Admin Autorizado?"
    },
    {
      "parameters": {
        "jsCode": "const msg = ($('Extraer Datos').first().json.mensaje_usuario || '').trim();\nconst m = msg.match(/^validar\\s+(.+)$/i);\nif (!m) {\n  throw new Error('Formato inválido. Usa: validar <nombre>');\n}\nconst nombre = m[1].trim();\nreturn { nombre };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5568,
        -9824
      ],
      "id": "1dbc4fee-f006-4bda-9493-7fee36c1213e",
      "name": "Parsear Objetivo"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, chat_id, user_name, usuario_valido, user_mail, direccion_calle, codigo_postal, poblacion, provincia, pais\nFROM telegram_users\nWHERE user_name ILIKE $1\nORDER BY first_seen ASC\nLIMIT 1",
        "options": {
          "queryReplacement": "={{ [ '%' + String($json.nombre || '').trim() + '%' ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5408,
        -9824
      ],
      "id": "17a91a02-e7e8-414d-b331-01c1b687dae6",
      "name": "Buscar Usuario Por Nombre",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "Solo los administradores pueden validar usuarios.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -5568,
        -9648
      ],
      "id": "b4968b8c-25f2-44d3-b822-bb73e6ecb6b5",
      "name": "No autorizado",
      "webhookId": "8639f06d-9611-4667-ad53-778547c73de0"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dc4e2f2e-f2bb-455f-b0e3-80a64a51ee9b",
              "leftValue": "={{ !!$json.user_id }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5232,
        -9824
      ],
      "id": "db02df78-61c4-4123-aee9-33b55a188ded",
      "name": "¿Encontrado?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "No se encontró un usuario con ese nombre.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -5024,
        -9648
      ],
      "id": "579da86d-e922-471a-9fdb-046a558b0b24",
      "name": "Error Validar Usuario",
      "webhookId": "194a93f7-e0f3-4370-9277-126cb270ad2e"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "tiene-mail-check-001",
              "leftValue": "={{ $json.user_mail && $json.user_mail !== null && String($json.user_mail).trim() !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5040,
        -9920
      ],
      "id": "5fe24766-ed20-44ee-9d7c-b645eaf163d8",
      "name": "¿Tiene Mail?"
    },
    {
      "parameters": {
        "jsCode": "// Guardar en memoria que el usuario debe enviar su correo\nconst userData = $json;\nconst chatId = userData.chat_id;\nconst userId = userData.user_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconsole.log('📧 === SOLICITAR CORREO AL USUARIO ===');\nconsole.log('Usuario:', userData.user_name);\nconsole.log('User ID:', userId);\n\n// Guardar en memoria que estamos esperando el correo\nmemoria.esperando_correo = true;\nmemoria.user_id_validar = userId;\nmemoria.user_name_validar = userData.user_name;\nmemoria.chat_id_validar = chatId;\nmemoria.admin_chat_id = $('Extraer Datos').item.json.chat_id; // Chat del admin que ejecutó el comando\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  ...userData,\n  solicitar_mail: true\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4800,
        -9824
      ],
      "id": "811889be-00ac-4786-b120-4f420d906be1",
      "name": "Preparar Solicitar Mail"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=📧 Hola {{ $json.user_name }},\n\nPara completar tu validación y crear el acceso a Odoo necesitamos tu correo electrónico.\n\n✉️ Por favor, envía un mensaje con el siguiente formato:\n\n`mi correo es pepe@gmail.com`\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4624,
        -9824
      ],
      "id": "b4ecf747-d9a8-4f89-9c23-54c079545b5f",
      "name": "Solicitar Mail Usuario",
      "webhookId": "solicitar-mail-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "=✅ Se ha solicitado el correo electrónico al usuario {{ $json.user_name }}.\n\n⏳ Esperando respuesta...",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4448,
        -9824
      ],
      "id": "a6fb8b3c-3fc5-4caf-b68d-86443a224550",
      "name": "Confirmar Solicitud Mail al Admin",
      "webhookId": "confirmar-solicitud-mail-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// Generar login único para Odoo basado en el correo del usuario\nconst userData = $('Buscar Usuario Por Nombre').first().json;\nconst userMail = userData.user_mail;\nconst userName = userData.user_name || 'usuario';\n\nlet baseLogin;\n\n// Si tiene correo, usar el correo completo como login\nif (userMail && userMail.includes('@')) {\n  baseLogin = userMail.toLowerCase().trim();\n  console.log('✅ Usando correo completo como login:', baseLogin);\n} else {\n  // Fallback: usar el nombre de usuario de Telegram\n  baseLogin = userName.toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '') // Eliminar acentos\n    .replace(/[^a-z0-9]/g, '_') // Reemplazar caracteres especiales con guión bajo\n    .replace(/_+/g, '_') // Evitar múltiples guiones bajos consecutivos\n    .replace(/^_|_$/g, ''); // Eliminar guiones bajos al inicio y final\n  \n  // Si el login queda vacío, usar 'usuario'\n  if (!baseLogin) {\n    baseLogin = 'usuario';\n  }\n  console.log('⚠️ No hay correo, usando nombre de usuario:', baseLogin);\n}\n\n// Generar una contraseña aleatoria segura\nconst chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';\nlet password = '';\nfor (let i = 0; i < 12; i++) {\n  password += chars.charAt(Math.floor(Math.random() * chars.length));\n}\n\nconsole.log('📧 Correo:', userMail || 'No disponible');\nconsole.log('🔐 Contraseña generada (temporal)');\n\nreturn {\n  ...userData,\n  odoo_user: baseLogin,\n  odoo_password: password,\n  login_attempt: 0 // Para el control de unicidad\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3952,
        -9984
      ],
      "id": "b69b9090-bdd8-496d-8d6f-0be3755e1855",
      "name": "Generar Login Odoo"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT odoo_user FROM telegram_users WHERE odoo_user = $1",
        "options": {
          "queryReplacement": "={{ [ $json.odoo_user + ($json.login_attempt > 0 ? $json.login_attempt : '') ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3760,
        -9984
      ],
      "id": "0e292832-a623-4739-a7e2-cca3bb91d3ba",
      "name": "Verificar Login Existe",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Verificar si el login ya existe y ajustar si es necesario\nconst userData = $('Generar Login Odoo').item.json;\nconst queryResult = $input.all();\n\nlet loginFinal = userData.odoo_user;\nlet loginAttempt = userData.login_attempt || 0;\n\n// Si el login existe, añadir un número\nif (queryResult && queryResult.length > 0 && queryResult[0].json.odoo_user) {\n  loginAttempt++;\n  loginFinal = userData.odoo_user + loginAttempt;\n  \n  // Si hemos intentado más de 100 veces, añadir un timestamp\n  if (loginAttempt > 100) {\n    loginFinal = userData.odoo_user + '_' + Date.now();\n  }\n  \n  console.log('⚠️ Login ya existe, intentando:', loginFinal);\n  \n  // Si aún no hemos encontrado uno único, necesitamos reintentar\n  if (loginAttempt < 100) {\n    return {\n      ...userData,\n      odoo_user: userData.odoo_user,\n      login_attempt: loginAttempt,\n      needs_retry: true\n    };\n  }\n}\n\nconsole.log('✅ Login único encontrado:', loginFinal);\n\nreturn {\n  ...userData,\n  odoo_user_final: loginFinal,\n  odoo_password: userData.odoo_password,\n  needs_retry: false\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3584,
        -9984
      ],
      "id": "5c9ab268-b2e6-471b-842e-e8e4812f9a0b",
      "name": "Ajustar Login Si Necesario"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE telegram_users\nSET usuario_valido = true,\n    odoo_user = $2\nWHERE user_id = $1\nRETURNING *",
        "options": {
          "queryReplacement": "={{ [ parseInt($json.user_id), $json.odoo_user_final ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3408,
        -9984
      ],
      "id": "e9249a72-312d-4194-a64d-8f49956ce1af",
      "name": "Validar Usuario",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Preservar datos del nodo anterior para pasar al flujo de creación de Odoo\nconst datosAjustados = $('Ajustar Login Si Necesario').item.json;\n\nreturn {\n  ...datosAjustados,\n  user_id: datosAjustados.user_id,\n  user_name: datosAjustados.user_name,\n  user_mail: datosAjustados.user_mail,\n  direccion_calle: datosAjustados.direccion_calle,\n  codigo_postal: datosAjustados.codigo_postal,\n  poblacion: datosAjustados.poblacion,\n  provincia: datosAjustados.provincia,\n  pais: datosAjustados.pais,\n  chat_id: datosAjustados.chat_id,\n  odoo_user_final: datosAjustados.odoo_user_final,\n  odoo_password: datosAjustados.odoo_password\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3232,
        -9984
      ],
      "id": "b1bbc85f-11be-4b87-88fe-2887dc2b56b9",
      "name": "Preservar Datos Usuario"
    },
    {
      "parameters": {
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"mchecagoshawk-webinar-main-28403608\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4784,
        -10064
      ],
      "id": "4ae7a229-10d2-4549-bc41-ef44d8bb8f1b",
      "name": "Autenticar Odoo Validación"
    },
    {
      "parameters": {
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"mchecagoshawk-webinar-main-28403608\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3024,
        -9984
      ],
      "id": "425024ae-21f9-499a-997a-f7b879f3baf5",
      "name": "Autenticar Odoo Creación"
    },
    {
      "parameters": {
        "jsCode": "// Verificar si el usuario ya existe en Odoo antes de crearlo\n// Ahora buscamos ANTES de generar el login, usando el correo electrónico\nconst userData = $('Buscar Usuario Por Nombre').first().json;\nconst uid = $json.result;\n\n// Usar el correo electrónico para buscar\nconst correoUsuario = userData.user_mail;\n\nconsole.log('🔍 Verificando si el usuario ya existe en Odoo por correo:', correoUsuario);\nconsole.log('📋 Datos usuario completos:', JSON.stringify(userData, null, 2));\n\nif (!correoUsuario || correoUsuario === '') {\n  console.error('❌ No hay correo para verificar');\n  throw new Error('No se pudo obtener el correo del usuario para verificar en Odoo');\n}\n\n// Buscar en res.users si el correo (login) ya existe\nconst verificarUsuario = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"res.users\",\n      \"search_read\",\n      [\n        [[\"login\", \"=\", correoUsuario]]\n      ],\n      {\n        fields: [\"id\", \"login\", \"name\"],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Búsqueda preparada para correo:', correoUsuario);\n\nreturn {\n  url: 'https://mchecagoshawk-webinar.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: verificarUsuario,\n  method: 'POST',\n  uid: uid,\n  user_data: userData,\n  correo_buscado: correoUsuario\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4608,
        -10064
      ],
      "id": "9e12959f-8473-468e-b3de-1cd94b392513",
      "name": "Verificar Usuario Existe Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4416,
        -10064
      ],
      "id": "bd79725b-4cd1-4aaa-9e39-405166e4bb9b",
      "name": "Ejecutar Verificación Usuario",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "usuario-existe-check",
              "leftValue": "={{ $json.result && $json.result.length > 0 }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4240,
        -10064
      ],
      "id": "aa8be895-4633-4ef6-b174-e9dbbe3da0c6",
      "name": "¿Usuario Ya Existe?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Verificar Usuario Existe Odoo').item.json.user_data.chat_id || $('Verificar Usuario Existe Odoo').item.json.user_data.user_id }}",
        "text": "=⚠️ **Usuario ya registrado en Odoo**\n\n👤 El usuario con correo `{{ $('Verificar Usuario Existe Odoo').item.json.user_data.user_mail }}` ya está registrado en Odoo.\n\n✅ Puedes utilizar el bot sin problemas.\n\n💡 Si necesitas ayuda, contacta con el administrador.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3952,
        -10240
      ],
      "id": "0835c000-e06a-4387-a4dd-8b4f02528773",
      "name": "Notificar Usuario Ya Existe",
      "webhookId": "usuario-ya-existe-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "=⚠️ **Intento de registro duplicado**\n\n👤 **Usuario:** {{ $('Verificar Usuario Existe Odoo').item.json.user_data.user_name }}\n📧 **Correo:** `{{ $('Verificar Usuario Existe Odoo').item.json.user_data.user_mail }}`\n\n✅ El usuario ya existe en Odoo, no se creó de nuevo.\n\n💡 Se le ha notificado que su usuario ya está registrado.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3776,
        -10240
      ],
      "id": "9e5c5271-f47b-4a02-ab89-4785a42001cf",
      "name": "Notificar Admin Usuario Existe",
      "webhookId": "admin-usuario-existe-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// Crear partner solo con nombre + email\nconst userData = $('Preservar Datos Usuario').item.json;\nconst uid = $json.result;  // viene de Autenticar Odoo Creación\n\nconst nombreCompleto = userData.user_name || 'Usuario Telegram';\nconst login = userData.odoo_user_final;\nconst password = userData.odoo_password;\nconst userMail = userData.user_mail;\n\n// Si por lo que sea no hubiera correo, usamos el login como pseudo-email\nconst emailPartner = (userMail && userMail.trim() !== '')\n  ? userMail.trim()\n  : `${login}@telegram.user`;\n\nconst partnerData = {\n  name: nombreCompleto,\n  email: emailPartner,\n  customer_rank: 1,\n  // si en el futuro quieres meter más campos (street, city, etc.), se añaden aquí\n};\n\nconsole.log('📧 Creando partner mínimo con:');\nconsole.log('  Nombre:', nombreCompleto);\nconsole.log('  Email:', emailPartner);\n\nconst crearPartner = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"res.partner\",\n      \"create\",\n      [partnerData]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  url: 'https://mchecagoshawk-webinar.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: crearPartner,\n  method: 'POST',\n  uid: uid,\n  login: login,\n  password: password,\n  user_data: userData\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2816,
        -9984
      ],
      "id": "4e9fface-814a-4f4e-b5d8-8f3ef7d31f44",
      "name": "Preparar Crear Partner"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2624,
        -9984
      ],
      "id": "1634d9bc-142e-44ac-8ba2-62a1600b2383",
      "name": "Crear Partner Odoo",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Crear usuario de Odoo con el partner creado\nconst prepData = $('Preparar Crear Partner').item.json;\nconst partnerId = $json.result;\nconst uid = prepData.uid;\nconst login = prepData.login;\nconst password = prepData.password;\n\n// Buscar el grupo de portal\nconst buscarGrupoPortal = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"res.groups\",\n      \"search\",\n      [[[\"name\", \"=\", \"Portal\"]]]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  url: 'https://mchecagoshawk-webinar.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: buscarGrupoPortal,\n  method: 'POST',\n  uid: uid,\n  login: login,\n  password: password,\n  partner_id: partnerId,\n  user_data: prepData.user_data\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2384,
        -9984
      ],
      "id": "f8c6862c-2fd0-4508-85a0-f89a31f4a560",
      "name": "Buscar Grupo Portal"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2160,
        -9984
      ],
      "id": "e9b52a36-be9a-4601-ab82-ec90ead44696",
      "name": "Obtener Grupo Portal"
    },
    {
      "parameters": {
        "jsCode": "// Combinar resultado del HTTP con datos previos\nconst grupoPortalIds = $json.result || [];\nconst datosOriginales = $('Buscar Grupo Portal').item.json;\n\nconsole.log('🔍 Grupos Portal encontrados:', grupoPortalIds);\nconsole.log('📋 Login a usar:', datosOriginales.login);\nconsole.log('🔐 Password disponible:', datosOriginales.password ? 'Sí' : 'No');\n\nreturn {\n  ...datosOriginales,\n  grupo_portal_ids: grupoPortalIds\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1968,
        -9984
      ],
      "id": "718a660a-ec61-40ee-8746-970374cfa939",
      "name": "Combinar Datos Grupo Portal"
    },
    {
      "parameters": {
        "jsCode": "// Crear el usuario con permisos de portal\nconst prepData = $json;\nconst grupoPortalIds = prepData.grupo_portal_ids || [];\nconst uid = prepData.uid;\nconst login = prepData.login;\nconst password = prepData.password;\nconst partnerId = prepData.partner_id;\n\n// ⚠️ VALIDACIÓN CRÍTICA: Verificar que login esté definido\nif (!login || login === 'undefined' || login === 'null' || login.trim() === '') {\n  console.error('❌ ERROR CRÍTICO: Login no definido');\n  console.error('prepData completo:', JSON.stringify(prepData, null, 2));\n  throw new Error(`Login no puede ser vacío. Valor recibido: \"${login}\"`);\n}\n\nconsole.log('✅ Login validado:', login);\nconsole.log('🔐 Password:', password ? 'Definido' : 'NO DEFINIDO');\nconsole.log('👤 Partner ID:', partnerId);\n\n// Si no encontramos el grupo Portal exacto, buscar \"Portal\" en category_id\nlet groupsToAssign = [];\nif (grupoPortalIds && grupoPortalIds.length > 0) {\n  groupsToAssign = [[6, 0, grupoPortalIds]];\n} else {\n  // Usar el ID estándar del grupo portal (normalmente es 8 o 9)\n  groupsToAssign = [[6, 0, [9]]];\n}\n\nconst crearUsuario = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"res.users\",\n      \"create\",\n      [{\n        login: login,\n        password: password,\n        partner_id: partnerId,\n        groups_id: groupsToAssign\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Usuario a crear:', JSON.stringify(crearUsuario.params.args[5][0], null, 2));\n\nreturn {\n  url: 'https://mchecagoshawk-webinar.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: crearUsuario,\n  method: 'POST',\n  uid: uid,\n  login: login,\n  password: password,\n  partner_id: partnerId,\n  user_data: prepData.user_data\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1760,
        -9984
      ],
      "id": "61adf862-277e-4d44-a741-5bf00fa73d6f",
      "name": "Preparar Crear Usuario Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1552,
        -9984
      ],
      "id": "d40f34d7-1d2a-4b70-a8d9-18f31daefc70",
      "name": "Crear Usuario Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos para el mensaje final\nconst prepData = $('Preparar Crear Usuario Odoo').item.json;\nconst odooUserId = $json.result;\n\nreturn {\n  ...prepData.user_data,\n  odoo_user_id: odooUserId,\n  odoo_user: prepData.login,\n  odoo_password: prepData.password\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1344,
        -9984
      ],
      "id": "d6435ad6-4ddd-46e1-8f4c-e056fb905a82",
      "name": "Preparar Datos Finales"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id && $json.chat_id !== 'null' && $json.chat_id !== '' ? Number($json.chat_id) : Number($json.user_id) }}",
        "text": "=✅ **¡Tu usuario ha sido validado exitosamente!**\n\n👤 **Usuario de Odoo creado:**\n🔑 **Login:** `{{ $json.odoo_user }}`\n🔐 **Contraseña temporal:** `{{ $json.odoo_password }}`\n\n⚠️ **IMPORTANTE:** Por razones de seguridad, te recomendamos cambiar tu contraseña inmediatamente después de iniciar sesión en Odoo.\n\n🌐 **Acceso a Odoo:**\nhttps://mchecagoshawk-webinar.odoo.com/\n\n📱 Ahora tienes acceso completo al portal y puedes usar todas las funciones del bot.\n\n💡 **Tienes 5 consultas de prueba disponibles.**",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1168,
        -9984
      ],
      "id": "b41df84c-07c8-4a65-bfa2-5e58c8f59c4c",
      "name": "Avisar Usuario Validado",
      "webhookId": "c5da80f0-323b-4b98-940b-224cd076a242"
    },
    {
      "parameters": {
        "chatId": "={{ Number($('Buscar Usuario Por Nombre').first().json.chat_id || $('Buscar Usuario Por Nombre').first().json.user_id) }}",
        "text": "=🤖 Hola {{ $('Buscar Usuario Por Nombre').first().json.user_name || 'Usuario' }}, soy **AzerionBot**, tu asistente de Odoo.\n\nPara ver los datos reales puedes acceder a una base de datos de odoo en https://mchecagoshawk-webinar.odoo.com/\ncon user: azordata y contraseña :1234\n\n **Tengo la capacidad de:**\n• 📋 Registrar partes de horas\n• 🏗️ Crear proyecto\n• ✅ Crear tarea\n• 🛍️ Consultar producto\n• 💰 Consultar ventas\n• 🛒 Consultar compras\n• 🧾 Consultar facturas\n• 🔴 Consultar pagos pendientes\n• 🏆 Consultar top rankings\n• 👔 Consultar ranking comerciales\n• 📊 Consultar ventas perdidas\n• 🔍 Consultar ventas por orden\n• 👤 Consultar contacto\n• 🆕 Crear contacto\n• ✏️ Modificar contacto\n• 🛒 Crear pedidos de venta\n• 📅 Crear eventos en calendario\n• ⏰ Consultar horas de proyecto\n• ⏰ Consultar horas de tarea\n• ⏰ Consultar actividad temporal por usuario\n• 🏖️ Consultar ausencias\n• 📅 Consultar eventos de usuario\n• 🌐 Consultar visitantes web\n• 🏖️ Registrar ausencias\n• 💰 Registrar gastos\n• 🎤 Transcribir audios\n\n📱 Y además me tienes también en **WhatsApp**\n\n❓ **¿En qué puedo ayudarte?**",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -992,
        -9984
      ],
      "id": "3c95e22a-b9ba-41fe-b285-38be8ae46b4e",
      "name": "Mensaje de Inicio",
      "webhookId": "bienvenida-webhook-12345"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "=✅ Usuario \"{{ $('Ajustar Login Si Necesario').item.json.user_name || 'Usuario' }}\" validado correctamente.\n\n👤 **Usuario Odoo creado:**\n🔑 Login: `{{ $('Ajustar Login Si Necesario').item.json.odoo_user_final }}`\n\n✅ Se le ha enviado sus credenciales y se ha creado su acceso al portal.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3232,
        -10144
      ],
      "id": "3ca1bcd2-a28f-4b3f-9c77-7d5b72f2dcf9",
      "name": "Confirmar al Admin",
      "webhookId": "5ceb27f3-034e-44b8-bf0e-3cb33700551f"
    },
    {
      "parameters": {
        "content": "## Comprobar que es Admin y validar usuarios mediante el comando \"validar (nombre usuario)\"",
        "height": 496,
        "width": 1488,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -5952,
        -10160
      ],
      "id": "ec66cbf0-8524-4f76-b7ec-a6b9dd13df92",
      "name": "Sticky Note23"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, user_name, chat_id, odoo_user\nFROM public.telegram_users\nWHERE is_active = true\n  AND COALESCE(usuario_valido, false) = true\nORDER BY last_seen DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -4752,
        -8096
      ],
      "id": "ef46d1f6-73f0-44fd-8c49-d6973f5d0cca",
      "name": "Consultar Usuarios Registrados y Validados",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, user_name, chat_id\nFROM public.telegram_users\nWHERE is_active = true\n  AND COALESCE(usuario_valido, false) = true\nORDER BY last_seen DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -4688,
        -7664
      ],
      "id": "2324111f-2751-490c-bcba-51702b2106a2",
      "name": "Consultar Usuarios Registrados y Validados Semanal"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  user_id,\n  user_name,\n  chat_id,\n  odoo_user,\n  user_mail,\n  direccion_calle,\n  codigo_postal,\n  poblacion,\n  provincia,\n  pais\nFROM telegram_users\nWHERE (chat_id = $1 OR user_id = $1)\nLIMIT 1;\n",
        "options": {
          "queryReplacement": "={{ [ parseInt($('Obtener Chat ID').item.json.chat_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        3184,
        -9520
      ],
      "id": "a0bef733-d765-464a-84c7-a0a2efed0d44",
      "name": "Cargar Perfil Usuario"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "⏳ <b>Tu solicitud se está procesando…</b> En breve te envío la respuesta.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3632,
        -9744
      ],
      "id": "c32fd32c-c802-412d-b34f-f658621eaf90",
      "name": "Procesando Respuesta",
      "webhookId": "9b411b17-88a5-4ee8-8ab0-bf1401062624",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "51a3f3ef-7159-4659-9fc0-821427950e0d",
              "leftValue": "={{ $json.mensaje_usuario && $json.mensaje_usuario.toString().toLowerCase().trim().startsWith('mi direccion es') }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6656,
        -9536
      ],
      "id": "0a1949e6-ae15-4efc-bf30-64493f0910bf",
      "name": "¿Mensaje Es Dirección?"
    },
    {
      "parameters": {
        "jsCode": "// Tomamos los datos básicos\nconst datosExtraer = $('Extraer Datos').item.json;\nconst mensaje = String(datosExtraer.mensaje_usuario || '').trim();\n\nconsole.log('📍 Mensaje para extraer dirección:', mensaje);\n\n// Formato:\n// mi direccion es Calle 123 4ºB CP 07013 poblacion Palma Provincia Islas Baleares Pais España\nconst regex = /^mi\\s+direc+i[oó]n\\s+(?:es|:)\\s*(.+?)\\s+CP\\s+(\\d{4,5})\\s+poblacion\\s+(.+?)\\s+provincia\\s+(.+?)\\s+pais\\s+(.+)$/i;\n\nconst match = mensaje.match(regex);\n\nif (!match) {\n  console.log('❌ No coincide con el patrón de dirección');\n  return {\n    ...datosExtraer,\n    direccion_valida: false,\n    error_mensaje: 'Formato inválido. Usa: mi direccion es Gran Via 25 CP 28013 poblacion Madrid Provincia Madrid Pais España'\n  };\n}\n\nconst direccion = match[1].trim();\nconst codigoPostal = match[2].trim();\nconst poblacion = match[3].trim();\nconst provincia = match[4].trim();\nconst pais = match[5].trim();\n\nconsole.log('✅ Dirección extraída:');\nconsole.log('🏠', direccion);\nconsole.log('📮', codigoPostal);\nconsole.log('🏙️', poblacion);\nconsole.log('🗺️', provincia);\nconsole.log('🌍', pais);\n\nreturn {\n  ...datosExtraer,\n  direccion_valida: true,\n  direccion_calle: direccion,\n  codigo_postal: codigoPostal,\n  poblacion,\n  provincia,\n  pais\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8624,
        -9088
      ],
      "id": "908fe24f-b701-4449-9477-499142a121dc",
      "name": "Extraer Dirección Pedido"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b899e3f8-f0cb-47dd-ba1a-59c054bdf120",
              "leftValue": "={{ $json.direccion_valida === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8448,
        -9088
      ],
      "id": "a985305a-fe99-454a-95db-e7fa6cdd04e6",
      "name": "¿Dirección Válida?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE telegram_users\nSET \n  direccion_calle = $1,\n  codigo_postal   = $2,\n  poblacion       = $3,\n  provincia       = $4,\n  pais            = $5\nWHERE user_id     = $6;\n",
        "options": {
          "queryReplacement": "={{ [$json.direccion_calle, $json.codigo_postal, $json.poblacion, $json.provincia, $json.pais, $json.user_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -8224,
        -9104
      ],
      "id": "9720b595-5cf5-46b6-8211-55ae286261f1",
      "name": "Actualizar Dirección Usuario"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Dirección Pedido').item.json.chat_id }}",
        "text": "=✅ **Dirección guardada correctamente**\n\n🏠 {{ $('Extraer Dirección Pedido').item.json.direccion_calle }}\n📮 CP {{ $('Extraer Dirección Pedido').item.json.codigo_postal }} – {{ $('Extraer Dirección Pedido').item.json.poblacion }} ({{ $('Extraer Dirección Pedido').item.json.provincia }}, {{ $('Extraer Dirección Pedido').item.json.pais }})\n\n🛒 Ya puedes volver a decirme qué quieres pedir.\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -8032,
        -9104
      ],
      "id": "94ab886a-7d9e-405e-8a14-a610724caaab",
      "name": "Confirmar Dirección Guardada Pedido",
      "webhookId": "8639f06d-9611-4667-ad53-778547c73de0"
    },
    {
      "parameters": {
        "chatId": "=={{ $json.chat_id && $json.chat_id !== 'null' && $json.chat_id !== '' \n    ? Number($json.chat_id) \n    : Number($json.user_id) }}\n",
        "text": "={{ $json.error_mensaje || \"⚠️ El formato de la dirección no es válido. Prueba de nuevo con algo como:\\n`mi direccion es Calle Ciudad de Barcelona 123 4ºB CP 28007 poblacion Madrid Provincia Madrid Pais España`\" }}\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -8224,
        -8896
      ],
      "id": "10cea126-0b85-480b-8e2f-6607d50aaebb",
      "name": "Mensaje Error Dirección",
      "webhookId": "8639f06d-9611-4667-ad53-778547c73de0"
    },
    {
      "parameters": {
        "jsCode": "// Tomamos los datos de la dirección recién extraída\nconst d = $('Extraer Dirección Pedido').item.json;\n\nreturn {\n  user_id: d.user_id,\n  chat_id: d.chat_id,\n  user_name: d.user_name,\n  // si ya tienes el correo guardado, intenta arrastrarlo aquí también\n  user_mail: d.correo_extraido || d.user_mail || null,\n\n  direccion_calle: d.direccion_calle,\n  codigo_postal: d.codigo_postal,\n  poblacion: d.poblacion,\n  provincia: d.provincia,\n  pais: d.pais,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7840,
        -9104
      ],
      "id": "5b27c28b-1ca0-4b74-aed9-e6f26af247c5",
      "name": "Preservar Datos Dirección"
    },
    {
      "parameters": {
        "jsCode": "// PASO 1: Buscar país en Odoo por código ISO\nconst userData = $('Preservar Datos Dirección').item.json;\n// Tomamos el UID desde el nodo de autenticación de Odoo\nconst uid = $('Autenticar Odoo Dirección').item.json.result;\n\nlet paisNombre = userData.pais || '';\n\nif (!paisNombre || paisNombre.trim() === '') {\n  console.log('⚠️ No hay país para buscar');\n  return {\n    skip_country: true,\n    user_data: userData,\n    uid: uid\n  };\n}\n\n// Mapeo de países a códigos ISO\nconst paisesMap = {\n  'españa': 'ES', 'espana': 'ES', 'spain': 'ES',\n  'mexico': 'MX', 'méxico': 'MX',\n  'argentina': 'AR',\n  'colombia': 'CO',\n  'chile': 'CL',\n  'peru': 'PE', 'perú': 'PE',\n  'venezuela': 'VE',\n  'ecuador': 'EC',\n  'bolivia': 'BO',\n  'paraguay': 'PY',\n  'uruguay': 'UY',\n  'costa rica': 'CR',\n  'panama': 'PA', 'panamá': 'PA',\n  'estados unidos': 'US', 'united states': 'US',\n  'francia': 'FR', 'france': 'FR',\n  'alemania': 'DE', 'germany': 'DE',\n  'italia': 'IT', 'italy': 'IT',\n  'portugal': 'PT',\n  'reino unido': 'GB', 'united kingdom': 'GB',\n  'brasil': 'BR', 'brazil': 'BR'\n};\n\nconst paisKey = paisNombre\n  .toLowerCase()\n  .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\n  .replace(/ñ/gi, 'n')\n  .trim();\n\nconst paisCode = paisesMap[paisKey];\n\nconsole.log('🔍 Buscando país en Odoo:');\nconsole.log('  Original:', paisNombre);\nconsole.log('  Código ISO:', paisCode || 'No mapeado - buscando por nombre');\n\nlet filtros;\nif (paisCode) {\n  filtros = [[\"code\", \"=\", paisCode]];\n} else {\n  filtros = [[\"name\", \"ilike\", paisNombre]];\n}\n\nconst buscarPais = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"res.country\",\n      \"search_read\",\n      [filtros],\n      {\n        fields: [\"id\", \"name\", \"code\"],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Filtros búsqueda:', JSON.stringify(filtros, null, 2));\n\nreturn {\n  url: 'https://mchecagoshawk-webinar.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: buscarPais,\n  method: 'POST',\n  uid: uid,\n  user_data: userData\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7504,
        -9104
      ],
      "id": "1c0206eb-24a7-4ca6-9465-37225e3d289d",
      "name": "Buscar País Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -7312,
        -9104
      ],
      "id": "344d29e2-5061-4016-8465-44cd851a1360",
      "name": "Ejecutar Búsqueda País",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// PASO 2: Procesar resultado del país y buscar provincia\nconst userData = $('Buscar País Odoo').item.json.user_data;\nconst uid = $('Buscar País Odoo').item.json.uid;\nconst paisResultado = $json.result || [];\nlet provinciaNombre = userData.provincia || '';\n\nlet paisId = null;\nif (paisResultado && paisResultado.length > 0) {\n  paisId = paisResultado[0].id;\n  console.log('✅ País encontrado:', paisResultado[0].name, 'ID:', paisId);\n} else {\n  console.log('⚠️ País no encontrado:', userData.pais);\n}\n\nif (!provinciaNombre || provinciaNombre.trim() === '') {\n  console.log('⚠️ No hay provincia para buscar');\n  return {\n    skip_state: true,\n    user_data: userData,\n    uid: uid,\n    pais_id: paisId\n  };\n}\n\n// Normalizar el nombre de la provincia\nconst provinciaNormalizada = provinciaNombre\n  .normalize('NFD')\n  .replace(/[\\u0300-\\u036f]/g, '')\n  .replace(/ñ/gi, 'n')\n  .trim();\n\nconsole.log('🔍 Buscando provincia:');\nconsole.log('  Original:', provinciaNombre);\nconsole.log('  Normalizada:', provinciaNormalizada);\n\nprovinciaNombre = provinciaNormalizada;\n\n// Buscar provincia/estado\nconst filtros = [[\"name\", \"ilike\", provinciaNombre]];\nif (paisId) {\n  filtros.push([\"country_id\", \"=\", paisId]);\n}\n\nconst buscarProvincia = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"res.country.state\",\n      \"search_read\",\n      [filtros],\n      {\n        fields: [\"id\", \"name\", \"code\", \"country_id\"],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Request de búsqueda provincia:', JSON.stringify(buscarProvincia, null, 2));\n\nreturn {\n  url: 'https://mchecagoshawk-webinar.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: buscarProvincia,\n  method: 'POST',\n  uid: uid,\n  user_data: userData,\n  pais_id: paisId\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7104,
        -9104
      ],
      "id": "35298a52-0baf-40f7-9ea0-ea5b5fd71f16",
      "name": "Buscar Provincia Odoo",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -6912,
        -9104
      ],
      "id": "b24a2e26-4a7a-40a6-bfbd-dd2bced8747d",
      "name": "Ejecutar Búsqueda Provincia",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const userData = $('Preservar Datos Dirección').item.json;\nconst uid = $('Autenticar Odoo Dirección').item.json.result;\n\nconst email = (userData.user_mail || '').toString().trim();\nconst nombre = (userData.user_name || '').toString().trim();\n\nif (!email && !nombre) {\n  throw new Error('No hay email ni nombre para buscar el partner en Odoo');\n}\n\nlet domain;\nif (email) {\n  domain = [['email', 'ilike', email]];\n} else {\n  domain = [['name', 'ilike', nombre]];\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'mchecagoshawk-webinar-main-28403608',\n      uid,\n      'admin',\n      'res.partner',\n      'search_read',\n      [domain],\n      {\n        fields: ['id', 'name', 'email'],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000),\n};\n\nreturn {\n  url: 'https://mchecagoshawk-webinar.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: payload,\n  method: 'POST',\n  uid,\n  user_data: userData\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6704,
        -9104
      ],
      "id": "460036a4-f6aa-4efb-b231-f6210f3e739a",
      "name": "Buscar Partner Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -6512,
        -9104
      ],
      "id": "030c6a80-7322-4844-b59e-dfcd38489df7",
      "name": "Ejecutar Búsqueda Partner",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const userData   = $('Preservar Datos Dirección').item.json;\nconst uid        = $('Autenticar Odoo Dirección').item.json.result;\n\nconst paisRes    = $('Ejecutar Búsqueda País').item.json.result || [];\nconst provRes    = $('Ejecutar Búsqueda Provincia').item.json.result || [];\nconst partnerRes = $json.result || [];\n\nconst countryId  = paisRes[0]?.id || null;\nconst stateId    = provRes[0]?.id || null;\nconst partnerId  = partnerRes[0]?.id || null;\n\nif (!partnerId) {\n  throw new Error('No se encontró el contacto en Odoo para actualizar la dirección');\n}\n\nconst vals = {\n  street: userData.direccion_calle || '',\n  zip: userData.codigo_postal || '',\n  city: userData.poblacion || '',\n};\n\nif (stateId)   vals.state_id   = stateId;\nif (countryId) vals.country_id = countryId;\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'mchecagoshawk-webinar-main-28403608',\n      uid,\n      'admin',\n      'res.partner',\n      'write',\n      [[partnerId], vals]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📝 Actualizando partner', partnerId, 'con', vals);\n\nreturn {\n  url: 'https://mchecagoshawk-webinar.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: payload,\n  method: 'POST',\n  partner_id: partnerId,\n  country_id: countryId,\n  state_id: stateId\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6304,
        -9104
      ],
      "id": "20ea7371-d6ad-4e5f-a133-2519af73e9bc",
      "name": "Actualizar Dirección en Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -6080,
        -9104
      ],
      "id": "cdbb6ae5-f602-4988-ba1f-99d1975c8b88",
      "name": "Ejecutar Update Dirección Odoo",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"mchecagoshawk-webinar-main-28403608\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -7664,
        -9104
      ],
      "id": "7cdf2c37-9149-4cde-865d-fa11b0be818f",
      "name": "Autenticar Odoo Dirección"
    },
    {
      "parameters": {
        "content": "## Guarda Dirección del Usuario",
        "width": 2656
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -8640,
        -9136
      ],
      "id": "adb56cfc-3c24-4860-9bcd-1fa9c519b6fc",
      "name": "Sticky Note27"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_parte_y_stock",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0ed02254-bc1c-4329-81ae-f24306206107"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_parte_y_stock"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e60d3270-e53f-463b-883f-89f274d7e96a",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_tarea",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_tarea"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "18dda6e2-a779-4be3-a3e3-622a930c0220",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "conversar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "conversar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b618b459-f106-4d11-827e-13c259b3c0b0",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "mensaje_bienvenida",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "=mensaje_bienvenida"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "cb5a1d0e-66d5-4bc3-8da9-ed15198c65e8",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_actividad_usuario",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_actividad_usuario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c61b4dcd-e59c-48c2-9265-611d2d4375f4",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_horas_proyecto",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_horas_proyecto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "34f1557f-466c-4068-ae3d-6567d30fa48c",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_horas_tarea",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_horas_tarea"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "759d71e6-d8e6-4072-b495-f05e69fd7533",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_estado_proyecto",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_estado_proyecto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6196ae11-3626-4eca-89c1-cc88397674b7",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_gasto",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_gasto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "c8a77884-0097-4e09-ba5e-9d5441c1b904",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_fichaje",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_fichaje"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "lopd-firmar-001",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "firmar_lopd",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "firmar_lopd"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "envio-masivos-001",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "envio_masivos",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "envio_masivos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "uso-liberar-coche-001",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "uso_liberar_coche",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "uso_liberar_coche"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4704,
        -9552
      ],
      "id": "e469f8fb-bb27-446c-9e28-82259fd921fb",
      "name": "Switch"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT is_admin FROM telegram_users WHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ [ parseInt($json.user_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4928,
        -4592
      ],
      "id": "f1c6007d-0a05-44c6-865f-9718ace37594",
      "name": "¿Es Admin Envio Masivos?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "envio-masivos-if-admin",
              "leftValue": "={{ $json.is_admin === true || $json.is_admin === 'true' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5312,
        -4592
      ],
      "id": "9b1f1a45-2058-4d36-bd40-fa34d5d09a52",
      "name": "¿Admin Envio Masivos?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT chat_id FROM telegram_users WHERE chat_id IS NOT NULL",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5616,
        -4736
      ],
      "id": "997be720-298d-4a7e-9c2a-f8784cd07dbd",
      "name": "Obtener Todos Usuarios"
    },
    {
      "parameters": {
        "jsCode": "const datos = $('Switch').first().json;\nconst mensaje = datos.mensaje_masivo || datos.respuesta_usuario || '';\nconst items = $input.all();\nreturn items.map(item => ({ json: { ...item.json, text: mensaje } }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5744,
        -4736
      ],
      "id": "199bdcdc-8a4b-4871-abf7-2a2e90cc1ac5",
      "name": "Preparar Items Envio Masivo"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6192,
        -4720
      ],
      "id": "32bbc2b7-5f89-4577-9f48-de8b3de8d780",
      "name": "Enviar Masivo Telegram",
      "webhookId": "23884ac8-5c05-451d-bd7d-3dc33a9b332f"
    },
    {
      "parameters": {
        "jsCode": "const datos = $('Switch').first().json;\nconst total = $('Preparar Items Envio Masivo').all().length;\nreturn [{ json: { chat_id: datos.chat_id, text: `✅ Mensaje enviado correctamente a ${total} usuario(s).` } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6176,
        -5040
      ],
      "id": "cbee6e49-555c-4e21-aa77-3cacdd453185",
      "name": "Confirmar Envio Masivo"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6496,
        -5040
      ],
      "id": "54f60eb8-fe8b-457b-8904-1970ec1d291d",
      "name": "Confirmar Admin Envio Masivo",
      "webhookId": "6e20e6ca-18cf-4fa3-8eb4-c552688eb4a8"
    },
    {
      "parameters": {
        "chatId": "={{ $('Switch').first().json.chat_id }}",
        "text": "❌ No eres admin, no puedes hacer esta acción.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5616,
        -4480
      ],
      "id": "5fb61e5a-ca76-4a12-bd68-54ee8e2758bf",
      "name": "No Admin Envio Masivos",
      "webhookId": "9797518f-97d6-429c-93de-118e685fda6f"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos para uso/liberar coche - busca usuario Odoo\nconst x = $json;\nconst db = 'mchecagoshawk-webinar-main-28403608';\nconst pass = 'admin';\nlet uid = 2;\ntry { uid = $('Autenticar Odoo').first().json.result || 2; } catch (e) {}\n\nconst odooUser = String(x.odoo_user || (x.cliente_perfil && x.cliente_perfil.email) || '').trim();\nif (!odooUser) {\n  return { ...x, error_coche: true, texto: '❌ No tienes usuario Odoo vinculado. Indica tu correo con \"mi usuario de odoo es...\" para poder gestionar coches.' };\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [db, uid, pass, 'res.users', 'search_read', [['|', ['login','=',odooUser], ['email','=',odooUser]]], { fields: ['id','name','partner_id'], limit: 1 }]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn { ...x, payload_buscar_usuario: payload, db, uid, pass, odoo_user: odooUser, tipo_accion: x.tipo_accion || 'usar', coche: x.coche || '' };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4544,
        -4016
      ],
      "id": "3c6c9768-3613-46f9-a4b2-928f444486d1",
      "name": "Preparar Uso Liberar Coche"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "coche-sin-error",
              "leftValue": "={{ !$json.error_coche }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4704,
        -4016
      ],
      "id": "2c547d26-595a-4ce5-813b-49132f1ef54c",
      "name": "¿Sin Error Coche?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload_buscar_usuario }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4928,
        -4160
      ],
      "id": "478fc8f0-c1dc-404d-b94a-99daaf053f2c",
      "name": "HTTP Buscar Usuario Odoo Coche"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta fleet.vehicle - obtener partner_id del usuario\nconst prep = $('Preparar Uso Liberar Coche').first().json;\nconst res = $json.result || [];\nconst usuario = Array.isArray(res) && res.length ? res[0] : null;\nlet partnerId = null;\nif (usuario && usuario.partner_id) partnerId = Array.isArray(usuario.partner_id) ? usuario.partner_id[0] : usuario.partner_id;\n\nif (!partnerId) {\n  return { ...prep, error_coche: true, texto: '❌ No se encontró tu usuario en Odoo. Verifica que tu correo esté registrado.' };\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [prep.db, prep.uid, prep.pass, 'fleet.vehicle', 'search_read', [[]], { fields: ['id','name','license_plate','driver_id'], order: 'name asc' }]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn { ...prep, payload_vehiculos: payload, partner_id: partnerId, usuario_nombre: usuario.name };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5120,
        -4160
      ],
      "id": "75192032-d1d0-441c-b38e-fbbab5f296ca",
      "name": "Preparar Consulta Vehículos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "coche-sin-error-2",
              "leftValue": "={{ !$json.error_coche }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5280,
        -4160
      ],
      "id": "ad4d1810-ae6c-4745-80e7-064d2d7aeba1",
      "name": "¿Usuario Encontrado Coche?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload_vehiculos }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5504,
        -4256
      ],
      "id": "04248120-7fb9-4509-8f91-376b0041f1a9",
      "name": "HTTP Consultar Vehículos"
    },
    {
      "parameters": {
        "jsCode": "// Procesar resultado uso/liberar coche - lógica completa\nconst prep = $('Preparar Consulta Vehículos').first().json;\nconst vehiculos = $json.result || [];\nconst norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').trim();\n\nif (prep.error_coche) return { ...prep, texto: prep.texto };\n\nconst partnerId = prep.partner_id;\nconst tipoAccion = (prep.tipo_accion || 'usar').toLowerCase();\nconst cocheMencionado = norm(prep.coche || '');\nconst confirmarCambio = !!prep.confirmar_cambio;\nconst vehicleIds = prep.vehicle_ids || [];\nconst liberarAmbos = !!prep.liberar_ambos;\n\nconst enUso = vehiculos.filter(v => v.driver_id && v.driver_id !== false);\nconst libres = vehiculos.filter(v => !v.driver_id || v.driver_id === false);\nconst cochesMios = enUso.filter(v => { const d = v.driver_id; const pid = Array.isArray(d) ? d[0] : d; return pid === partnerId; });\n\nconst fmt = v => `${v.name || 'Sin nombre'} (${v.license_plate || 'sin matrícula'})`;\n\nif (tipoAccion === 'liberar') {\n  if (vehicleIds.length > 0) {\n    const ids = Array.isArray(vehicleIds) ? vehicleIds : [vehicleIds];\n    return { ...prep, accion_odoo: 'liberar', vehicle_ids: ids, texto: null };\n  }\n  if (cochesMios.length === 0) return { ...prep, texto: '✅ No tienes ningún coche asignado.' };\n  if (cochesMios.length === 1) return { ...prep, accion_odoo: 'liberar', vehicle_ids: [cochesMios[0].id], texto: null };\n  const lista = cochesMios.map((c,i) => `${i+1}. ${fmt(c)}`).join('\\n');\n  return { ...prep, esperando_confirmacion: 'elegir_coche_liberar', coches_mios: cochesMios, texto: `Tienes ${cochesMios.length} coches asignados:\\n\\n${lista}\\n\\n¿Cuál quieres liberar? Responde con el número o \"ambos\".` };\n}\n\nif (tipoAccion === 'usar' && confirmarCambio && prep.coche_id) {\n  return { ...prep, accion_odoo: 'asignar', vehicle_id: prep.coche_id, partner_id: prep.partner_id || partnerId, texto: null };\n}\n\nif (tipoAccion === 'usar') {\n  if (cochesMios.length > 0 && !cocheMencionado) {\n    const nombres = cochesMios.map(c => fmt(c)).join(', ');\n    return { ...prep, texto: `Ya tienes asignado: ${nombres}. ¿Quieres usar otro coche?` };\n  }\n  if (cocheMencionado) {\n    const match = vehiculos.find(v => norm(v.name||'').includes(cocheMencionado) || norm(v.license_plate||'').includes(cocheMencionado) || cocheMencionado.includes(norm(v.name||'')));\n    if (match) {\n      const driver = match.driver_id;\n      const driverId = Array.isArray(driver) ? driver[0] : driver;\n      const driverName = Array.isArray(driver) ? (driver[1]||'') : '';\n      if (!driverId || driverId === partnerId) return { ...prep, accion_odoo: 'asignar', vehicle_id: match.id, partner_id: partnerId, texto: null };\n      return { ...prep, esperando_confirmacion: 'confirmar_usar_coche_cambio', vehicle_id: match.id, vehicle_name: fmt(match), partner_id: partnerId, driver_actual: driverName, texto: `El coche ${fmt(match)} lo tiene asignado ${driverName}. ¿Quieres que te lo asigne a ti?` };\n    }\n  }\n  if (!cocheMencionado) {\n    let txt = '🚗 **Coches disponibles**\\n\\n';\n    if (enUso.length) { txt += '**En uso:**\\n' + enUso.map(v => `• ${fmt(v)} → ${Array.isArray(v.driver_id)?v.driver_id[1]:'?'}`).join('\\n') + '\\n\\n'; }\n    if (libres.length) { txt += '**Libres:**\\n' + libres.map(v => `• ${fmt(v)}`).join('\\n'); }\n    if (!enUso.length && !libres.length) txt += 'No hay coches registrados.';\n    return { ...prep, texto: txt };\n  }\n  return { ...prep, texto: `No encontré el coche \"${prep.coche || ''}\". Indica el nombre o matrícula.` };\n}\n\nreturn { ...prep, texto: 'No entendí la acción. Di \"usar coche\" o \"liberar coche\".' };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5680,
        -4256
      ],
      "id": "fa86bdf1-5837-4216-8fe0-f00997728b91",
      "name": "Procesar Uso Liberar Coche"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "coche-accion-odoo",
              "leftValue": "={{ $json.accion_odoo }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5872,
        -4256
      ],
      "id": "87d6d1fd-bdf3-4ef4-b5c3-39cfeed2adb2",
      "name": "¿Ejecutar Acción Odoo Coche?"
    },
    {
      "parameters": {
        "jsCode": "// Ejecutar asignar o liberar en Odoo\nconst x = $json;\nconst db = x.db || 'mchecagoshawk-webinar-main-28403608';\nconst uid = x.uid || 2;\nconst pass = x.pass || 'admin';\n\nif (x.accion_odoo === 'asignar' && x.vehicle_id && x.partner_id) {\n  const payload = { jsonrpc: '2.0', method: 'call', params: { service: 'object', method: 'execute_kw', args: [db, uid, pass, 'fleet.vehicle', 'write', [[x.vehicle_id], { driver_id: x.partner_id }]] }, id: Math.floor(Math.random()*1e6) };\n  return { ...x, payload_odoo: payload };\n}\nif (x.accion_odoo === 'liberar' && x.vehicle_ids && x.vehicle_ids.length) {\n  const payload = { jsonrpc: '2.0', method: 'call', params: { service: 'object', method: 'execute_kw', args: [db, uid, pass, 'fleet.vehicle', 'write', [x.vehicle_ids, { driver_id: false }]] }, id: Math.floor(Math.random()*1e6) };\n  return { ...x, payload_odoo: payload };\n}\nreturn x;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6112,
        -4368
      ],
      "id": "508ce5bf-3f11-458d-b299-5e92b90d702f",
      "name": "Ejecutar Asignar Liberar Coche"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload_odoo }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6368,
        -4368
      ],
      "id": "f23ba4e3-353b-4544-bf72-0540ced20d61",
      "name": "HTTP Ejecutar Coche Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta final tras asignar/liberar\nconst x = $json;\nconst prep = $('Procesar Uso Liberar Coche').first().json;\nconst textoBase = prep.accion_odoo === 'asignar' ? '✅ Coche asignado correctamente.' : '✅ Coche(s) liberado(s) correctamente.';\nreturn { ...prep, ...x, texto: textoBase };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6592,
        -4368
      ],
      "id": "653842fd-0b01-4e6d-8264-61dc7b41b3cd",
      "name": "Formatear Respuesta Coche"
    },
    {
      "parameters": {
        "jsCode": "// Unificar salida: texto a enviar por Telegram\nconst proc = $('Procesar Uso Liberar Coche').first().json;\nconst tieneTexto = proc.texto && String(proc.texto).trim();\nif (tieneTexto) return { ...proc, texto_final: proc.texto };\nconst formatear = $json;\nreturn { ...proc, ...formatear, texto_final: formatear.texto || '✅ Operación completada.' };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6864,
        -3744
      ],
      "id": "f93252de-0a09-49ea-a5cc-61c26d57936b",
      "name": "Unificar Respuesta Coche"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto_final || $json.texto || '✅ Operación completada.' }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        7184,
        -4016
      ],
      "id": "b6ef137c-e9cf-42e9-8c58-1756ae14794a",
      "name": "Enviar Respuesta Coche",
      "webhookId": "8e0a8530-60eb-4e38-b9e3-a800b1bbc2e9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "tiene-esperando",
              "leftValue": "={{ $json.esperando_confirmacion }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6160,
        -4160
      ],
      "id": "0fb5c146-4319-47b7-bd30-1205ab133f1c",
      "name": "¿Guardar Memoria Coche?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n SET esperando_confirmacion = $2, ultimo_mensaje_bot = $3, datos_pendientes = $4, updated_at = NOW() WHERE chat_id = $1::bigint",
        "options": {
          "queryReplacement": "={{ [$json.chat_id, $json.esperando_confirmacion || null, $json.texto || $json.texto_final || '', JSON.stringify({coches_mios: $json.coches_mios || [], vehicle_id: $json.vehicle_id, vehicle_name: $json.vehicle_name, partner_id: $json.partner_id})] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        6368,
        -4176
      ],
      "id": "c9217a75-2c2c-4ddc-9715-57958f28f3f9",
      "name": "Guardar Memoria Coche"
    },
    {
      "parameters": {
        "jsCode": "const x = $json;\nconst chatId = x.chat_id;\n\nconst asStr = (v) => (v == null ? '' : String(v).trim());\nconst asNum = (v, d = 0) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : d;\n};\n\nconst norm = (s) =>\n  String(s || '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim();\n\nconst isDiagnosis = !!x.is_diagnosis_task;\n\nconst ticketType = norm(x.ticket_type);\nconst isNuevaInstalacion =\n  ticketType === 'nueva instalacion' ||\n  ticketType === 'nueva_instalacion' ||\n  ticketType.includes('nueva instalacion') ||\n  ticketType === 'instalacion' ||\n  ticketType.includes('instalacion');\n\nconst horasPresup = asNum(x.horas_presupuestadas, 0);\n\n// 🔍 Intentar obtener productos validados desde el nodo de validación\nlet productosValidados = [];\ntry {\n  const validacionResult = $('Validar Productos FSM')?.item?.json;\n  if (validacionResult && Array.isArray(validacionResult.productos_validados)) {\n    productosValidados = validacionResult.productos_validados;\n    console.log('✅ Productos validados encontrados:', productosValidados.length);\n  }\n} catch (e) {\n  console.log('⚠️ No se encontraron productos validados, usando productos originales');\n}\n\nconst productos =\n  productosValidados.length > 0\n    ? productosValidados\n    : (Array.isArray(x.productos) ? x.productos : []);\n\n// ✅ Ahora sí: inicializa items primero\nconst items = productos\n  .map((p) => ({\n    nombre: asStr(p.product_name || p.nombre),\n    cantidad: asNum(p.quantity || p.cantidad, 1),\n    product_id: p.product_id || false,\n    notes: asStr(p.notes || ''), // opcional\n  }))\n  .filter((p) => p.nombre);\n\n// ✅ Y DESPUÉS metes la línea de presupuesto si aplica\nif (isDiagnosis && horasPresup > 0) {\n  items.push({\n    nombre: 'Horas presupuestadas',\n    cantidad: horasPresup,\n    product_id: false,\n    notes: 'Estimación / Presupuesto (diagnóstico/presupuesto)',\n  });\n}\n\nconsole.log('📦 Productos normalizados:', items);\n\n// Proyecto FSM por defecto\nconst proyecto = asStr(x.proyecto) || 'Servicio de campo';\nconst tareaSugerida =\n  asStr(x.tarea) || `Intervención - ${new Date().toLocaleDateString('es-ES')}`;\n\nconst uid = x.uid || ($('Autenticar Odoo')?.item?.json?.result);\nconst db = x.db || 'mchecagoshawk-webinar-main-28403608';\n\nconst odoo_user = asStr(x.odoo_user || x.cliente_perfil?.email || '');\nconst odoo_user_id = x.odoo_user_id || x.cliente_perfil?.user_id || null;\n\nconst transcripcion_original = asStr(\n  x.transcripcion_original || x.mensaje_usuario_original || x.mensaje_original || ''\n);\nconst mensaje_usuario_original = asStr(x.mensaje_usuario_original || x.mensaje_original || '');\n\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconst parteEnMemoria = {\n  horas: asNum(x.horas, 0),\n  descripcion: asStr(x.descripcion) || 'Trabajo realizado',\n  productos: items,\n  cliente: asStr(x.cliente || ''),\n  proyecto_sugerido: proyecto,\n  tarea_sugerida: tareaSugerida,\n  transcripcion_original,\n  timestamp: new Date().toISOString(),\n  ticket_type: x.ticket_type || '',\n  horas_presupuestadas: horasPresup,\n  is_diagnosis_task: isDiagnosis,\n  travel_distance_km: asNum(x.travel_distance_km, 0),\n  travel_time_hours: asNum(x.travel_time_hours, 0),\n};\n\nmemoria.parte_en_registro = parteEnMemoria;\nmemoria.esperando_confirmacion = 'elegir_tarea_calendario';\nglobal[contextoKey] = memoria;\n\nreturn {\n  proyecto,\n  tarea: tareaSugerida,\n  horas: asNum(x.horas, 0),\n  descripcion: asStr(x.descripcion) || 'Trabajo realizado',\n  productos: items,\n  cliente: asStr(x.cliente || ''),\n  is_diagnosis_task: isDiagnosis,\n  ticket_type: x.ticket_type || '',\n  horas_presupuestadas: horasPresup,\n  odoo_user,\n  odoo_user_id,\n  transcripcion_original,\n  mensaje_usuario_original,\n  parte_en_memoria: parteEnMemoria,\n  db,\n  uid,\n  chat_id: x.chat_id,\n  travel_distance_km: asNum(x.travel_distance_km, 0),\n  travel_time_hours: asNum(x.travel_time_hours, 0),\n\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5440,
        -10256
      ],
      "id": "644f51c5-edb9-4f4b-a8b2-aa1e4a76125f",
      "name": "Normalizar Parte+Materiales FSM"
    },
    {
      "parameters": {
        "jsCode": "// REGISTRAR MATERIALES (robusto en esta rama)\n// - timesheet_line_id SIEMPRE se lee de \"HTTP Registrar Horas Directo FSM\"\n// - productos se leen con prioridad: input validados > Validar Productos1 validados > input productos/datos_parte > seed Registrar Tarea Odoo > pendientes > reg > normalizar\n// ✅ CORRECCION: las \"horas_presupuestadas\" NO son materiales (no deben entrar en account.analytic.line.product)\n\nconst firstJson = (nodeName) => {\n  try { return $items(nodeName, 0)?.[0]?.json ?? null; } catch { return null; }\n};\n\nconst parseMaybeJson = (v) => {\n  if (!v) return null;\n  if (typeof v === 'object') return v;\n  if (typeof v === 'string') {\n    try { return JSON.parse(v); } catch { return null; }\n  }\n  return null;\n};\n\n// ✅ 1) timesheet_line_id (robusto para rama normal + corrección productos)\n// Prioridad: input -> Registro (Registrar Horas Directo FSM) -> memoria -> HTTP\n\nconst toNum = (v) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : null;\n};\n\nconst httpHoras = firstJson('HTTP Registrar Horas Directo FSM') || {};\nconst regNodeWrap = firstJson('Registrar Horas Directo FSM') || {};\nconst reg = regNodeWrap.registro || regNodeWrap || {};\n\nconst memRow = firstJson('Preparar Datos AI Agent') || {};\nconst pendientesMem = parseMaybeJson(memRow?.datos_pendientes) || {};\n\nlet timesheetLineId =\n  toNum($json.timesheet_line_id) ||\n  toNum(reg.timesheet_line_id) ||\n  toNum(pendientesMem.timesheet_line_id) ||\n  (() => {\n    let raw =\n      httpHoras.result ??\n      httpHoras.body?.result ??\n      httpHoras.json?.result ??\n      null;\n    if (Array.isArray(raw)) raw = raw[0];\n    return toNum(raw);\n  })();\n\nif (!timesheetLineId || timesheetLineId <= 0) {\n  return {\n    skip_materiales: true,\n    motivo: 'Sin timesheet_line_id (input/registro/memoria/HTTP)',\n    timesheet_line_id: timesheetLineId || null,\n    debug_timesheet_sources: {\n      input: $json.timesheet_line_id ?? null,\n      reg: reg.timesheet_line_id ?? null,\n      mem: pendientesMem.timesheet_line_id ?? null,\n      http_has_item: !!firstJson('HTTP Registrar Horas Directo FSM'),\n    },\n  };\n}\n\n\n// ✅ 2) contexto\n\nconst norm = firstJson('Normalizar Parte+Materiales FSM') || {};\nconst auth = firstJson('Autenticar Odoo') || {};\n\n// ⚠️ validador (según ramas)\nconst valid =\n  firstJson('Validar Productos1') ||\n  firstJson('Validar Productos FSM') ||\n  {};\n\n// ✅ seed del nodo Registrar Tarea Odoo (donde a menudo está el producto correcto estructurado)\nconst seed = firstJson('Registrar Tarea Odoo') || {};\nconst seedParte = seed.datos_parte || {};\n\n// memoria postgres (si existe)\nconst dpObj =\n  parseMaybeJson($json.datos_pendientes) ||\n  parseMaybeJson($json.datos_pendientes_json) ||\n  $json.datos_pendientes ||\n  null;\n\n// ✅ 3) productos (PRIORIDAD CORREGIDA)\nlet productos = [];\n\n// 0) input actual ya trae validados (p.ej. vienes de la corrección/validación)\nif (Array.isArray($json.productos_validados) && $json.productos_validados.length) {\n  productos = $json.productos_validados;\n\n// ✅ 0.1) lo que dejó \"Validar Productos1\" (VALORES YA CON product_id) → PRIORIDAD MUY ALTA\n} else if (Array.isArray(valid.productos_validados) && valid.productos_validados.length) {\n  productos = valid.productos_validados;\n\n// 0.2) input actual trae productos ya estructurados (corrección parseada)\n} else if (Array.isArray($json.productos) && $json.productos.length) {\n  productos = $json.productos;\n\n// 0.3) o dentro del input datos_parte\n} else if (Array.isArray($json.datos_parte?.productos) && $json.datos_parte.productos.length) {\n  productos = $json.datos_parte.productos;\n\n// 0.4) seed de “Registrar Tarea Odoo”\n} else if (Array.isArray(seedParte.productos) && seedParte.productos.length) {\n  productos = seedParte.productos;\n\n// 0.5) datos_pendientes.datos_parte.productos\n} else if (Array.isArray(dpObj?.datos_parte?.productos) && dpObj.datos_parte.productos.length) {\n  productos = dpObj.datos_parte.productos;\n\n// 0.6) fallback registro original (a veces viene “mal escrito” aquí)\n} else if (Array.isArray(reg.productos) && reg.productos.length) {\n  productos = reg.productos;\n\n// 0.7) fallback normalizado\n} else if (Array.isArray(norm.productos) && norm.productos.length) {\n  productos = norm.productos;\n}\n\n// ✅ 3b) FILTRAR: quitar \"Horas presupuestadas\" (no son materiales)\nconst normText = (s) =>\n  String(s ?? '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/\\s+/g, ' ')\n    .trim();\n\nconst isPresupuestoItem = (p) => {\n  const name = normText(p?.product_name || p?.nombre || p?.notes || '');\n  const notes = normText(p?.notes || '');\n\n  const byName =\n    name.includes('hora presupuestada') ||\n    name.includes('horas presupuestadas') ||\n    name === 'horas' ||\n    name.includes('presupuesto') ||\n    name.includes('estimacion') ||\n    name.includes('estimación');\n\n  const byNotes =\n    notes.includes('presupuesto') ||\n    notes.includes('estimacion') ||\n    notes.includes('estimación');\n\n  const pid = p?.product_id;\n  const pidNum = Array.isArray(pid) ? Number(pid[0]) : Number(pid);\n  const noPid = !Number.isFinite(pidNum) || pidNum <= 0;\n\n  return (\n    byName ||\n    byNotes ||\n    (noPid && name.includes('horas') && (name.includes('presup') || name.includes('estim')))\n  );\n};\n\nif (Array.isArray(productos) && productos.length) {\n  productos = productos.filter((p) => !isPresupuestoItem(p));\n}\n\nif (!Array.isArray(productos) || productos.length === 0) {\n  return {\n    skip_materiales: true,\n    motivo: 'Sin materiales (solo venían horas presupuestadas / estimación, que NO se registran como consumo)',\n    timesheet_line_id: timesheetLineId,\n    debug: {\n      input_pv_len: Array.isArray($json.productos_validados) ? $json.productos_validados.length : null,\n      valid_pv_len: Array.isArray(valid.productos_validados) ? valid.productos_validados.length : null,\n      input_prod_len: Array.isArray($json.productos) ? $json.productos.length : null,\n      input_dp_prod_len: Array.isArray($json.datos_parte?.productos) ? $json.datos_parte.productos.length : null,\n      seed_prod_len: Array.isArray(seedParte.productos) ? seedParte.productos.length : null,\n      dp_seed_prod_len: Array.isArray(dpObj?.datos_parte?.productos) ? dpObj.datos_parte.productos.length : null,\n      reg_len: Array.isArray(reg.productos) ? reg.productos.length : null,\n      norm_len: Array.isArray(norm.productos) ? norm.productos.length : null,\n      horas_presupuestadas: reg.horas_presupuestadas ?? $json.horas_presupuestadas ?? null,\n      reg_wrap_has_registro: !!regNodeWrap?.registro,\n      reg_wrap_keys: regNodeWrap ? Object.keys(regNodeWrap) : null,\n    },\n  };\n}\n\n// ✅ 4) separar conId vs sinId\nconst conId = [];\nconst sinId = [];\n\nfor (const p of productos) {\n  const name = String(p.product_name || p.nombre || p.notes || '').trim();\n  const qty = Number(p.quantity || p.cantidad || 1);\n\n  let pid = p.product_id;\n  if (Array.isArray(pid)) pid = pid[0];\n  if (pid === false || pid === null || pid === undefined || pid === '') pid = null;\n  else pid = Number(pid);\n\n  const uom =\n    (Array.isArray(p.uom_id) ? p.uom_id[0] : p.uom_id) ||\n    (Array.isArray(p.product_uom_id) ? p.product_uom_id[0] : p.product_uom_id) ||\n    null;\n\n  const item = {\n    timesheet_line_id: timesheetLineId,\n    product_id: pid,\n    quantity: Number.isFinite(qty) && qty > 0 ? qty : 1,\n    notes: name,\n  };\n\n  if (uom) item.product_uom_id = Number(uom);\n\n  if (Number.isFinite(pid) && pid > 0) conId.push(item);\n  else if (name) sinId.push({ nombre: name, cantidad: item.quantity });\n}\n\nif (conId.length === 0 && sinId.length === 0) {\n  return {\n    skip_materiales: true,\n    motivo: 'Materiales vacíos o sin nombre (tras filtrar horas presupuestadas)',\n    timesheet_line_id: timesheetLineId,\n  };\n}\n\n// ✅ 5) db/uid\nconst db =\n  reg.db ||\n  norm.db ||\n  valid.db ||\n  $json.db ||\n  seed.db ||\n  'mchecagoshawk-webinar-main-28403608';\n\nconst uid =\n  reg.uid ||\n  norm.uid ||\n  valid.uid ||\n  $json.uid ||\n  seed.uid ||\n  auth.result ||\n  2;\n\nconst pass = 'admin';\n\n// ✅ 6) si faltan IDs -> pedir resolución por búsqueda\nif (sinId.length > 0 && conId.length === 0) {\n  const names = sinId.map((x) => x.nombre).filter(Boolean);\n\n  let domain = [];\n  if (names.length === 1) {\n    domain = [['name', 'ilike', names[0]]];\n  } else {\n    for (let i = 0; i < names.length; i++) {\n      if (i < names.length - 1) domain.push('|');\n      domain.push(['name', 'ilike', names[i]]);\n    }\n  }\n\n  const payloadBuscarProductos = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        db, Number(uid), pass,\n        'product.product', 'search_read',\n        [domain],\n        { fields: ['id', 'name', 'display_name', 'uom_id', 'default_code'], limit: 80 },\n      ],\n    },\n    id: Math.floor(Math.random() * 1e6),\n  };\n\n  return {\n    skip_materiales: true,\n    motivo: 'Hay materiales pero sin product_id. Hay que resolverlos por nombre antes de registrar consumo.',\n    timesheet_line_id: timesheetLineId,\n    productos_sin_id: sinId,\n    necesita_resolver_productos: true,\n    payload_buscar_productos: payloadBuscarProductos,\n    db,\n    uid: Number(uid),\n  };\n}\n\n// ✅ 7) si hay IDs -> crear líneas de consumo en el parte (account.analytic.line.product)\nif (conId.length > 0) {\n  const payloadCreate = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        db,\n        Number(uid),\n        pass,\n        'account.analytic.line.product',\n        'create',\n        [conId],\n      ],\n    },\n    id: Math.floor(Math.random() * 1e6),\n  };\n\n  return {\n    skip_materiales: false,\n    payload: payloadCreate,\n    timesheet_line_id: timesheetLineId,\n    productos_creados: conId.length,\n    productos_sin_id: sinId,\n    db,\n    uid: Number(uid),\n  };\n}\n\n// fallback final\nreturn {\n  skip_materiales: true,\n  motivo: 'No hay materiales registrables',\n  timesheet_line_id: timesheetLineId,\n  debug_paths: {\n    input_productos_validados: Array.isArray($json.productos_validados) ? $json.productos_validados.length : null,\n    valid_productos_validados: Array.isArray(valid.productos_validados) ? valid.productos_validados.length : null,\n    input_productos: Array.isArray($json.productos) ? $json.productos.length : null,\n    input_datos_parte_productos: Array.isArray($json.datos_parte?.productos) ? $json.datos_parte.productos.length : null,\n    seed_productos: Array.isArray(seedParte.productos) ? seedParte.productos.length : null,\n    dp_productos: Array.isArray(dpObj?.datos_parte?.productos) ? dpObj.datos_parte.productos.length : null,\n    reg_len: Array.isArray(reg.productos) ? reg.productos.length : null,\n    norm_len: Array.isArray(norm.productos) ? norm.productos.length : null,\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8800,
        -9472
      ],
      "id": "a288f772-91fe-48b1-b41f-8f24dea6ecee",
      "name": "Registrar Materiales"
    },
    {
      "parameters": {
        "jsCode": "// ✅ Registrar Horas Directo FSM\n// ✅ FIXES:\n// 1) Idempotencia: si ya existe timesheet_line_id (input o memoria), NO vuelve a crear horas\n// 2) Transcripción: MENSAJE INICIAL siempre el inicial; MENSAJE HORAS solo si texto tiene número válido\n// 3) Evita que \"sí\" o \"juntas\" contaminen los mensajes\n// 4) En corrección de productos, reutiliza transcripción guardada en memoria (no recalcula)\n\nconst safeNodeJson = (name) => {\n  try { return $items(name, 0)?.[0]?.json ?? null; } catch { return null; }\n};\n\nconst parseJSONSafe = (v) => {\n  try { return typeof v === 'string' ? JSON.parse(v) : (v || {}); } catch { return {}; }\n};\n\nconst toNum = (v) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : null;\n};\n\nconst clean = (s) => String(s ?? '').trim();\n\nconst x = $json || {};\n\n// -------------------------\n// ✅ Contexto base\n// -------------------------\nconst seed = safeNodeJson('Registrar Tarea Odoo') || {};\nconst seedReg = seed.datos_registrados || {};\n\nconst memRow = safeNodeJson('Preparar Datos AI Agent') || {};\nconst pendientes = parseJSONSafe(memRow?.datos_pendientes);\n\nconst normalizado = safeNodeJson('Normalizar Parte+Materiales FSM') || {};\nconst authNode = safeNodeJson('Autenticar Odoo') || {};\nconst prepCompleto = safeNodeJson('FSM ▸ Preparar Datos Completos') || {};\nconst prepUser = safeNodeJson('Preparar Buscar Usuario Odoo') || {};\n\n// -------------------------\n// ✅ Flags de rama\n// -------------------------\nconst enCorreccionProductos =\n  memRow?.esperando_confirmacion === 'correccion_productos' ||\n  x.necesita_resolver_productos === true ||\n  (Array.isArray(x.productos_sin_id) && x.productos_sin_id.length > 0) ||\n  !!x.payload_buscar_productos;\n\n// -------------------------\n// ✅ Idempotencia: detectar si YA existe línea creada\n// -------------------------\nconst existingTimesheetLineId = toNum(\n  x.timesheet_line_id ||\n  x.timesheetLineId ||\n  x.timesheet_line_id_creado ||\n  pendientes.timesheet_line_id ||\n  pendientes.timesheetLineId\n);\n\n// ⚠️ Si ya hay timesheet_line_id, NO volvemos a crear horas\nif (existingTimesheetLineId && existingTimesheetLineId > 0) {\n  return {\n    payload: null,\n    skip_registrar_horas: true,\n    motivo: enCorreccionProductos\n      ? 'Reentrada por corrección de productos: NO se vuelven a registrar horas'\n      : 'Ya existía timesheet_line_id: NO se vuelven a registrar horas',\n    timesheet_line_id: existingTimesheetLineId,\n    ...x,\n    registro: {\n      ...(x.registro || {}),\n      chat_id: x.chat_id || pendientes.chat_id || memRow.chat_id || seed.chat_id || normalizado.chat_id,\n      db: x.db || pendientes.db || seed.db || normalizado.db || 'mchecagoshawk-webinar-main-28403608',\n      uid: toNum(x.uid || pendientes.uid || seed.uid || normalizado.uid || authNode?.result) || 2,\n      timesheet_line_id: existingTimesheetLineId,\n    },\n  };\n}\n\n// -------------------------\n// ✅ IDs tarea/proyecto\n// -------------------------\nconst tareaId = toNum(\n  x.tarea_id ||\n  x.task_id ||\n  x.datos_registrados?.task_id ||\n  pendientes.tarea_id ||\n  seedReg.task_id\n);\n\nconst proyectoId = toNum(\n  x.proyecto_id ||\n  x.project_id ||\n  x.datos_registrados?.project_id ||\n  pendientes.proyecto_id ||\n  seedReg.project_id\n);\n\nconst tareaNombre =\n  x.tarea ||\n  x.tarea_nombre ||\n  pendientes.tarea_nombre ||\n  seed.tarea ||\n  'Tarea';\n\nconst proyectoNombre =\n  x.proyecto_nombre ||\n  pendientes.proyecto_nombre ||\n  seed.proyecto_nombre ||\n  'Proyecto';\n\nconst datosParte = x.datos_parte || pendientes.datos_parte || {};\n\n// -------------------------\n// ✅ descripcion y productos\n// -------------------------\nconst descripcion =\n  x.descripcion ||\n  x.datos_parte?.descripcion ||\n  datosParte?.descripcion ||\n  pendientes?.datos_parte?.descripcion ||\n  seedReg?.name ||\n  '';\n\nconst productos =\n  x.productos ||\n  x.datos_parte?.productos ||\n  datosParte?.productos ||\n  pendientes?.datos_parte?.productos ||\n  [];\n\n// -------------------------\n// ✅ HORAS (solo crear si hay >0)\n// -------------------------\nlet horas = null;\nconst horasCandidatos = [\n  x.horas,\n  x.unit_amount,\n  x.datos_registrados?.unit_amount,\n  x.datos_parte?.horas,\n  datosParte.horas,\n  pendientes.datos_parte?.horas,\n  seedReg.unit_amount,\n];\n\nfor (const candidate of horasCandidatos) {\n  const num = toNum(candidate);\n  if (num !== null && num > 0) {\n    horas = num;\n    break;\n  }\n}\n\nhoras = horas ?? 0;\n\nif (horas <= 0) {\n  const debugInfo = {\n    'x.horas': x.horas,\n    'x.unit_amount': x.unit_amount,\n    'x.datos_registrados?.unit_amount': x.datos_registrados?.unit_amount,\n    'x.datos_parte?.horas': x.datos_parte?.horas,\n    'datosParte.horas': datosParte.horas,\n    'pendientes.datos_parte?.horas': pendientes.datos_parte?.horas,\n    'seedReg.unit_amount': seedReg.unit_amount,\n    'horas_final': horas,\n  };\n  throw new Error(`Horas inválidas: ${horas}. DEBUG: ${JSON.stringify(debugInfo, null, 2)}`);\n}\n\n// -------------------------\n// ✅ Credenciales\n// -------------------------\nconst DB =\n  x.db ||\n  pendientes.db ||\n  seed.db ||\n  normalizado.db ||\n  'mchecagoshawk-webinar-main-28403608';\n\nconst UID =\n  toNum(x.uid_admin || x.uid || pendientes.uid_admin || seed.uid || normalizado.uid) ||\n  toNum(authNode?.result) ||\n  2;\n\nconst PASS =\n  x.pass_admin ||\n  x.pass ||\n  pendientes.pass_admin ||\n  'admin';\n\nconst hoy = new Date().toISOString().split('T')[0];\n\n// -------------------------\n// ✅ user_id desde \"Buscar Usuario Odoo\"\n// -------------------------\nlet userIdFromPerfil = null;\nlet userNameFromPerfil = null;\n\ntry {\n  const listaUsuarios =\n    x?.result ??\n    x?.body?.result ??\n    x?.data?.result ??\n    x?.json?.result ??\n    [];\n\n  const usuario = Array.isArray(listaUsuarios) && listaUsuarios.length ? listaUsuarios[0] : null;\n  userIdFromPerfil = usuario?.id ?? null;\n  userNameFromPerfil = usuario?.name ?? null;\n} catch {}\n\n// -------------------------\n// ✅ Diagnóstico\n// -------------------------\nconst esDiagnosis =\n  x.is_diagnosis_task === true ||\n  datosParte.is_diagnosis_task === true ||\n  pendientes.is_diagnosis_task === true ||\n  false;\n\n// -------------------------\n// ✅ TRANSCRIPCIÓN (NO contaminada + no recalcular en corrección)\n// -------------------------\nlet transcripcionCompleta = '';\n\nif (enCorreccionProductos) {\n  // ✅ En corrección: usa lo guardado (no lo machaques con \"juntas\"/\"si\")\n  transcripcionCompleta =\n    clean(pendientes?.transcripcion_real) ||\n    clean(pendientes?.transcripcion_original) ||\n    clean(descripcion) ||\n    'Sin transcripción disponible';\n} else {\n  // ✅ MENSAJE INICIAL: SOLO de fuentes iniciales estables\n  const primerMensaje =\n    pendientes?.datos_parte?.mensaje_usuario_original ||\n    pendientes?.datos_parte?.transcripcion_original ||\n    seed?.mensaje_usuario_original ||\n    seed?.transcripcion_original ||\n    null;\n\n  const mensajeActualRaw =\n    memRow?.mensaje_usuario ||\n    x.mensaje_usuario ||\n    prepCompleto?.message?.text ||\n    prepUser?.message?.text ||\n    normalizado?.message?.text ||\n    x.message?.text ||\n    x.body?.message?.text ||\n    x.text ||\n    null;\n\n  const parseHorasFromText = (txt) => {\n    const s = clean(txt).toLowerCase();\n    if (!s) return null;\n\n    const banal = new Set(['si', 'sí', 'ok', 'vale', 'de acuerdo', 'correcto']);\n    if (banal.has(s)) return null;\n\n    const m = s.replace(',', '.').match(/(\\d+(\\.\\d+)?)/);\n    if (!m) return null;\n\n    const n = Number(m[1]);\n    return Number.isFinite(n) && n > 0 ? n : null;\n  };\n\n  const p = clean(primerMensaje);\n  const horasEnTexto = parseHorasFromText(mensajeActualRaw);\n  const mensajeHoras = (horasEnTexto !== null) ? clean(mensajeActualRaw) : null;\n\n  if (p && mensajeHoras) {\n    transcripcionCompleta = (p === mensajeHoras)\n      ? p\n      : `🟦 MENSAJE INICIAL:\\n${p}\\n\\n🟩 MENSAJE HORAS:\\n${mensajeHoras}`;\n  } else if (p) {\n    transcripcionCompleta = p; // ✅ si no hay mensaje horas válido, solo inicial\n  } else if (mensajeHoras) {\n    transcripcionCompleta = mensajeHoras;\n  } else {\n    transcripcionCompleta = clean(descripcion) || 'Sin transcripción disponible';\n  }\n}\n\nconst transcripcionReal = transcripcionCompleta;\n\n// -------------------------\n// ✅ Horas presupuestadas\n// -------------------------\nconst horasPresupuestadas =\n  toNum(\n    x.horas_presupuestadas ||\n    datosParte.horas_presupuestadas ||\n    pendientes.horas_presupuestadas ||\n    seed.horas_presupuestadas ||\n    normalizado?.horas_presupuestadas ||\n    0\n  ) ?? 0;\n\n// -------------------------\n\n// -------------------------\n// ✅ Travel fields (distancia y tiempo de desplazamiento)\n// -------------------------\nconst travel_distance_km = toNum(\n  x.travel_distance_km ||\n  datosParte.travel_distance_km ||\n  pendientes?.datos_parte?.travel_distance_km ||\n  pendientes?.travel_distance_km ||\n  seed.travel_distance_km ||\n  normalizado?.travel_distance_km ||\n  0\n) ?? 0;\n\nconst travel_time_hours = toNum(\n  x.travel_time_hours ||\n  datosParte.travel_time_hours ||\n  pendientes?.datos_parte?.travel_time_hours ||\n  pendientes?.travel_time_hours ||\n  seed.travel_time_hours ||\n  normalizado?.travel_time_hours ||\n  0\n) ?? 0;\n\nconsole.log('🚗 Travel distance_km:', travel_distance_km);\nconsole.log('⏱️ Travel time_hours:', travel_time_hours);\n\n// ✅ Descripción mejorada\n// -------------------------\nlet descripcionMejorada = (descripcion || seedReg.name || `Parte - ${tareaNombre}`).trim();\n\nif (esDiagnosis && horasPresupuestadas > 0) {\n  descripcionMejorada = `${descripcionMejorada} [PRESUPUESTO: ${horasPresupuestadas}h]`;\n}\n\nif (Array.isArray(productos) && productos.length > 0) {\n  const listaProductos = productos\n    .map(p => `- ${p.nombre || p.product_name || 'Producto sin nombre'}: ${p.cantidad || p.quantity || 1} unidad(es)`)\n    .join('\\n');\n\n  if (esDiagnosis) {\n    descripcionMejorada = `${descripcionMejorada}\\n\\n📋 PRODUCTOS MENCIONADOS (Presupuesto):\\n${listaProductos}`;\n  } else {\n    descripcionMejorada = `${descripcionMejorada}\\n\\n📦 MATERIALES UTILIZADOS:\\n${listaProductos}`;\n  }\n}\n\nif (transcripcionCompleta) {\n  descripcionMejorada = `${descripcionMejorada}\\n\\n🗒️ CONTEXTO COMPLETO (OPERARIO):\\n${transcripcionCompleta}`;\n}\n\n// -------------------------\n// ✅ Validación IDs\n// -------------------------\nif (!tareaId || !proyectoId) {\n  throw new Error(\n    `Faltan IDs. task_id=${tareaId} project_id=${proyectoId}. ` +\n    `Revisa que lleguen desde Registrar Tarea Odoo / pendientes / input.`\n  );\n}\n\n// -------------------------\n// ✅ Payload create (account.analytic.line)\n// -------------------------\nconst valoresParte = {\n  name: descripcionMejorada,\n  project_id: proyectoId,\n  task_id: tareaId,\n  unit_amount: horas,\n  date: hoy,\n  transcripcion_real: transcripcionReal,\n  is_diagnosis_task: esDiagnosis,\n  travel_distance_km: travel_distance_km,\n  travel_time_hours: travel_time_hours,\n  ...(userIdFromPerfil ? { user_id: Number(userIdFromPerfil) } : {}),\n};\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      DB, UID, PASS,\n      'account.analytic.line', 'create',\n      [[valoresParte]],\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  payload,\n  skip_registrar_horas: false,\n  registro: {\n    chat_id: x.chat_id || seed.chat_id || normalizado.chat_id || memRow?.chat_id,\n    proyecto: proyectoNombre,\n    tarea: tareaNombre,\n    horas,\n    horas_presupuestadas: horasPresupuestadas,\n    is_diagnosis_task: esDiagnosis,\n    descripcion: (descripcion || seedReg.name || `Parte - ${tareaNombre}`).trim(),\n    transcripcion_original: transcripcionCompleta,\n    transcripcion_real: transcripcionReal,\n    task_id: tareaId,\n    project_id: proyectoId,\n    travel_distance_km: travel_distance_km,\n    travel_time_hours: travel_time_hours,\n    odoo_user: x.odoo_user || pendientes.odoo_user || seed.odoo_user || normalizado.odoo_user || memRow?.odoo_user || null,\n    odoo_user_id: userIdFromPerfil || null,\n    odoo_user_name: userNameFromPerfil || null,\n    productos,\n    db: DB,\n    uid: UID,\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6256,
        -9488
      ],
      "id": "585cce32-1f72-4549-8c10-dab8e77fc481",
      "name": "Registrar Horas Directo FSM"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6704,
        -9600
      ],
      "id": "eeab4dd3-4998-4240-a832-c52a050f496d",
      "name": "HTTP Registrar Horas Directo FSM"
    },
    {
      "parameters": {
        "jsCode": "// ✅ Preparar Buscar Usuario Odoo (robusto para rama registrar_tarea)\n\nconst x = $json;\n\n// helper: leer json de otro nodo si existe / se ejecutó\nconst safeNodeJson = (name) => {\n  try {\n    const it = $items(name, 0);\n    return it?.[0]?.json ?? null;\n  } catch {\n    return null;\n  }\n};\n\n// 1) Fuentes posibles\nconst normalizado = safeNodeJson('Normalizar Parte+Materiales FSM') || null;\nconst authNode = safeNodeJson('Autenticar Odoo') || null;\n\nconst memRow = safeNodeJson('Preparar Datos AI Agent') || null;\n\n// 2) Parse seguro de datos_pendientes de Postgres\nconst parseJSONSafe = (v) => {\n  try { return typeof v === 'string' ? JSON.parse(v) : (v || {}); }\n  catch { return {}; }\n};\n\nconst pendientes = parseJSONSafe(memRow?.datos_pendientes);\n\n// 3) Credenciales / contexto (prioridad: input -> pendientes -> normalizado -> defaults)\nconst DB =\n  x.db ||\n  pendientes.db ||\n  normalizado?.db ||\n  'mchecagoshawk-webinar-main-28403608';\n\nlet UID =\n  x.uid_admin ||\n  x.uid ||\n  pendientes.uid_admin ||\n  normalizado?.uid ||\n  2;\n\n// si existe Autenticar Odoo y trae result, úsalo\nif (authNode?.result) UID = authNode.result;\n\nconst PASS =\n  x.pass_admin ||\n  pendientes.pass_admin ||\n  'admin';\n\n// 4) Email del usuario final (muy importante)\nconst email =\n  x.odoo_user ||\n  pendientes.odoo_user ||\n  normalizado?.odoo_user ||\n  memRow?.odoo_user ||\n  '';\n\n// Si no hay email, NO rompas el flujo: devuelve skip para que lo bypasses\nif (!email) {\n  return {\n    ...x,\n    db: DB,\n    uid: UID,\n    pass_admin: PASS,\n    skip_user_lookup: true,\n    motivo: 'Falta odoo_user/email para buscar res.users',\n  };\n}\n\n// 5) Payload JSON-RPC\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      DB, UID, PASS,\n      'res.users', 'search_read',\n      [[\n        '|',\n        ['login', '=', email],\n        ['email', '=', email],\n      ]],\n      { fields: ['id', 'name', 'login', 'email', 'partner_id'], limit: 1 },\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...x,\n  db: DB,\n  uid: UID,\n  pass_admin: PASS,\n  odoo_user: email,\n  payload,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5792,
        -9488
      ],
      "id": "81466588-38fa-40a1-bef2-b6a4f0219d95",
      "name": "Preparar Buscar Usuario Odoo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json[\"payload\"]}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6032,
        -9488
      ],
      "id": "ff7ad59b-d2a4-4b04-9a47-208b84e8ea5d",
      "name": "Buscar Usuario Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Log para datos inválidos que no se pueden guardar en PostgreSQL\nconsole.log('❌ DATOS INVÁLIDOS - No se guardó en PostgreSQL:');\nconsole.log('📄 Datos recibidos:', JSON.stringify($json, null, 2));\nconsole.log('🚫 Razón:', $json.razon || 'No especificada');\nconsole.log('📊 Chat ID original:', $json.chat_id_original);\nconsole.log('🔢 Chat ID numérico:', $json.chat_id_numerico);\n\nreturn { \n  mensaje: 'Datos no guardados en PostgreSQL por ser inválidos',\n  detalles: $json \n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        20288,
        -9296
      ],
      "id": "4ada9428-981e-4117-a838-247f6edb93d1",
      "name": "Log Datos Inválidos"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.resultado !== 'skipped' }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        19984,
        -9456
      ],
      "id": "6ae5c4a1-d727-4bd0-bda5-48ed058b5043",
      "name": "¿Datos Válidos para PostgreSQL?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (\n  chat_id, user_id, user_name, proyecto_anterior, tarea_anterior,\n  ultima_accion, esperando_confirmacion, esperando_respuesta,\n  ultimo_mensaje_bot, mensaje_usuario, datos_pendientes, historial, historial_conversacion,\n  created_at, updated_at\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, NOW(), NOW()\n);",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,\n  $json.user_id,\n  $json.user_name,\n  $json.proyecto_anterior,\n  $json.tarea_anterior,\n  $json.ultima_accion,\n  $json.esperando_confirmacion,\n  $json.esperando_respuesta,\n  $json.ultimo_mensaje_bot,\n  $json.mensaje_usuario,\n  $json.datos_pendientes,\n  $json.historial,\n  $json.historial_conversacion\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        20432,
        -9520
      ],
      "id": "e93c2e7b-b520-4cbd-a7ac-9b0b24977c51",
      "name": "Insertar en PostgreSQL"
    },
    {
      "parameters": {
        "jsCode": "// NODO UNIFICADOR - PREPARAR DATOS POSTGRESQL CON BÚSQUEDA ACTIVA\nconst timestampActual = new Date().toISOString();\n\n// Detectar si viene del flujo de evento incompleto\nlet respuestaBot = $json.text || $json.respuesta_usuario || 'Respuesta procesada';\n\n// Si viene de evento incompleto, usar mensaje específico\nif ($json.esperando_confirmacion === 'crear_evento_calendario' && $json.datos_pendientes) {\n  respuestaBot = 'faltan datos';\n} else if ($json.ultimo_mensaje_bot) {\n  respuestaBot = $json.ultimo_mensaje_bot;\n}\n\nconsole.log('🔄 === PREPARAR DATOS POSTGRESQL - BÚSQUEDA ACTIVA ===');\nconsole.log('📥 Datos recibidos directamente:', JSON.stringify($json, null, 2));\n\n// FUNCIÓN PARA BUSCAR DATOS DEL USUARIO EN NODOS ANTERIORES\nfunction buscarDatosUsuario() {\n  const nodosABuscar = [\n    'Router de Acciones FIXED',\n    'Procesar Respuesta',\n    'Preparar Datos AI Agent',\n    'Obtener Chat ID',\n    'Extraer Datos'\n  ];\n  for (const nombreNodo of nodosABuscar) {\n    try {\n      const datos = $(nombreNodo).first().json;\n      if (datos && datos.chat_id && datos.chat_id !== 'unknown') {\n        console.log(`✅ Datos encontrados en: ${nombreNodo}`);\n        return {\n          chat_id: datos.chat_id,\n          user_id: datos.user_id || datos.chat_id,\n          user_name: datos.user_name || 'Usuario',\n          mensaje_original: datos.mensaje_usuario || datos.mensaje_original || 'mensaje no disponible',\n          fuente: nombreNodo,\n          es_fallback: datos.es_fallback === true\n        };\n      }\n    } catch (e) {\n      console.log(`⚠️ No se pudo acceder a ${nombreNodo}:`, e.message);\n    }\n  }\n  return null;\n}\n\n// INTENTAR OBTENER DATOS DEL USUARIO\nlet datosUsuario = {\n  chat_id: $json.chat_id,\n  user_id: $json.user_id,\n  user_name: $json.user_name,\n  mensaje_original: $json.mensaje_usuario || $json.mensaje_original,\n  es_fallback: $json.es_fallback === true\n};\n\n// Si no tenemos chat_id válido, buscar en nodos anteriores\nif (!datosUsuario.chat_id || datosUsuario.chat_id === 'unknown') {\n  console.log('🔍 Chat ID no válido, buscando en nodos anteriores...');\n  const datosBuscados = buscarDatosUsuario();\n  if (datosBuscados) {\n    datosUsuario = datosBuscados;\n    console.log(`✅ Datos recuperados desde: ${datosBuscados.fuente}`);\n  } else {\n    console.log('❌ No se encontraron datos válidos del usuario');\n    datosUsuario = {\n      chat_id: 0,\n      user_id: 0,\n      user_name: 'unknown',\n      mensaje_original: 'mensaje no disponible',\n      fuente: 'fallback',\n      es_fallback: true\n    };\n  }\n}\n\nconsole.log('👤 DATOS FINALES DEL USUARIO:', {\n  chat_id: datosUsuario.chat_id,\n  user_id: datosUsuario.user_id,\n  user_name: datosUsuario.user_name,\n  fuente: datosUsuario.fuente || 'directo',\n  es_fallback: datosUsuario.es_fallback === true\n});\n\n// CREAR REGISTRO PARA POSTGRESQL\nconst registroPostgreSQL = {\n  chat_id: parseInt(datosUsuario.chat_id) || 0,\n  user_id: parseInt(datosUsuario.user_id) || 0,\n  user_name: datosUsuario.user_name === 'unknown' ? null : datosUsuario.user_name,\n  ultima_accion: 'conversar',\n  ultimo_mensaje_bot: respuestaBot,\n  mensaje_usuario: datosUsuario.mensaje_original === 'mensaje no disponible' ? null : datosUsuario.mensaje_original,\n  historial: JSON.stringify([{\n    timestamp: timestampActual,\n    usuario: datosUsuario.mensaje_original,\n    bot: respuestaBot,\n    accion: 'conversar'\n  }]),\n  historial_conversacion: JSON.stringify([{\n    timestamp: timestampActual,\n    contenido: datosUsuario.mensaje_original,\n    tipo: 'usuario'\n  }, {\n    timestamp: timestampActual,\n    contenido: respuestaBot,\n    tipo: 'bot'\n  }]),\n  // Propagar al post-descontar\n  es_fallback: datosUsuario.es_fallback === true\n};\n\nconsole.log('📤 REGISTRO FINAL PARA POSTGRESQL:', {\n  chat_id: registroPostgreSQL.chat_id,\n  user_id: registroPostgreSQL.user_id,\n  user_name: registroPostgreSQL.user_name,\n  es_fallback: registroPostgreSQL.es_fallback\n});\n\nreturn [registroPostgreSQL];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19488,
        -9344
      ],
      "id": "f93e05ec-5341-4b2f-862d-0aa7fabcd314",
      "name": "Preparar Datos PostgreSQL"
    },
    {
      "parameters": {
        "jsCode": "const esFallback = $json.es_fallback === true;\nconst userId = Number($json.user_id || 0);\n\n// Si es fallback, no descontar\nreturn {\n  ...$json,\n  descuento_necesario: !esFallback,\n  user_id_descuento: userId\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19648,
        -9088
      ],
      "id": "1e29175f-8fd6-4297-b9a7-c28dff1da3ae",
      "name": "Marcar Descuento Final"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "36c84a69-10d6-4d07-9c9c-fd7b8b89bbc2",
              "leftValue": "={{ ($json.descuento_necesario ?? false) === true && $json.es_fallback !== true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        19824,
        -9088
      ],
      "id": "a07d0858-10ce-4f33-9a44-957361bb39b3",
      "name": "¿Descontar Ahora?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": " UPDATE telegram_users\n        SET consultas_restantes = GREATEST(consultas_restantes - 1, 0),\n            last_seen = NOW()\n        WHERE user_id = $1\n  AND COALESCE(is_admin, false) = false\n  AND COALESCE(usuario_valido, false) = true;",
        "options": {
          "queryReplacement": "={{ [ Number($json.user_id_descuento || $json.user_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        20000,
        -9200
      ],
      "id": "1e86041c-602f-4a29-8740-9ced8e824f35",
      "name": "Descontar Consulta Final"
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -7040,
        -9536
      ],
      "id": "701eea8d-4af2-4eac-b4c6-46c89c288a2d",
      "name": "Telegram Trigger",
      "webhookId": "b399a49a-b163-49bf-a56d-e2f14d200fee"
    },
    {
      "parameters": {
        "chatId": "={{ $('Router de Acciones FIXED').item.json.chat_id }}",
        "text": "={{ $('Router de Acciones FIXED').item.json.respuesta_usuario }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5232,
        -9024
      ],
      "id": "c4c6b8ae-1c6d-464e-95d2-81cc3702030f",
      "name": "Fallback",
      "webhookId": "aedba30e-bcd9-4ffd-aef7-45e457144bc0"
    },
    {
      "parameters": {
        "chatId": "={{ $('Router de Acciones FIXED').item.json.chat_id }}",
        "text": "={{ $('Router de Acciones FIXED').item.json.respuesta_usuario }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5248,
        -8656
      ],
      "id": "364fffec-370d-4f07-9187-e11ce3ff10af",
      "name": "Bienvenida",
      "webhookId": "aedba30e-bcd9-4ffd-aef7-45e457144bc0"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {
          "language": "es",
          "temperature": 0.2
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -3200,
        -8656
      ],
      "id": "4173ab65-f922-45c2-ae2d-72afee2920f3",
      "name": "Transcribe a recording"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de actividad temporal por usuario\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreUsuario = datosAI.usuario;\nconst periodo = datosAI.periodo;\n\nconsole.log('🔍 Consultando actividad de usuario:', nombreUsuario, 'en período:', periodo);\n\n// Validar datos\nif (!uid) throw new Error('No se pudo obtener el UID de autenticación');\nif (!nombreUsuario) throw new Error('No se encontró el nombre del usuario');\n\n// Si no hay período, enviar mensaje de ayuda por Telegram\nif (!periodo) {\n  const mensajeAyuda = `❌ **Período no especificado**\\n\\n` +\n    `👤 **Usuario:** \"${nombreUsuario}\"\\n\\n` +\n    `Para consultar la actividad de un usuario, necesitas especificar el período de tiempo.\\n\\n` +\n    `📅 **Períodos disponibles:**\\n` +\n    `• **hoy** - actividad de hoy\\n` +\n    `• **ayer** - actividad de ayer\\n` +\n    `• **esta semana** - actividad de esta semana\\n` +\n    `• **semana pasada** - actividad de la semana pasada\\n` +\n    `• **este mes** - actividad de este mes\\n` +\n    `• **mes pasado** - actividad del mes pasado\\n\\n` +\n    `💡 **Ejemplos:**\\n` +\n    `• \"¿qué ha hecho ${nombreUsuario} hoy?\"\\n` +\n    `• \"actividad de ${nombreUsuario} esta semana\"\\n` +\n    `• \"¿cuántas horas trabajó ${nombreUsuario} este mes?\"`;\n  \n  return {\n    accion: 'enviar_mensaje_directo',\n    chat_id: datosAI.chat_id,\n    texto: mensajeAyuda\n  };\n}\n\n// Calcular fechas según el período\nconst ahora = new Date();\nlet fechaInicio, fechaFin;\n\nswitch(periodo) {\n  case 'hoy':\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() + 1);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'ayer':\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() - 1);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'esta_semana':\n    // Calcular el lunes de esta semana (getDay(): 0=domingo, 1=lunes, etc.)\n    const diasDesdeInicioSemana = ahora.getDay() === 0 ? 6 : ahora.getDay() - 1; // Si es domingo, retroceder 6 días\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() - diasDesdeInicioSemana);\n    fechaInicio.setHours(0, 0, 0, 0); // Inicio del día\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() + 1);\n    fechaFin.setHours(0, 0, 0, 0); // Inicio del día siguiente\n    break;\n  case 'semana_pasada':\n    // Calcular el lunes de la semana pasada\n    const diasDesdeInicioSemanaAnterior = ahora.getDay() === 0 ? 6 : ahora.getDay() - 1;\n    const lunesSemanaAnterior = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() - diasDesdeInicioSemanaAnterior - 7);\n    fechaInicio = new Date(lunesSemanaAnterior);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(lunesSemanaAnterior.getFullYear(), lunesSemanaAnterior.getMonth(), lunesSemanaAnterior.getDate() + 7);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'este_mes':\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 1);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'mes_pasado':\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth() - 1, 1);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth(), 1);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'mes_nombre':\n    // Para consultas de mes específico por nombre (ej: \"enero\", \"febrero\", etc.)\n    // Por defecto usar el mes actual si no se puede determinar el mes específico\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 1);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  default:\n    throw new Error('Período no válido: ' + periodo);\n}\n\n// Formatear fechas para Odoo (YYYY-MM-DD)\nconst formatearFecha = (fecha) => {\n  return fecha.toISOString().split('T')[0];\n};\n\nconst fechaInicioStr = formatearFecha(fechaInicio);\nconst fechaFinStr = formatearFecha(fechaFin);\n\nconsole.log('📅 Fecha actual:', ahora.toISOString());\nconsole.log('📅 Día de la semana:', ahora.getDay(), '(0=domingo)');\nconsole.log('📅 Rango de fechas calculado:', fechaInicioStr, 'a', fechaFinStr);\nconsole.log('📅 FechaInicio completa:', fechaInicio.toISOString());\nconsole.log('📅 FechaFin completa:', fechaFin.toISOString());\n\n// Determinar el mejor término de búsqueda\nlet terminoBusqueda = nombreUsuario;\n\n// Mapeo específico para palabras clave comunes\nconst mapeoNombres = {\n  'administrador': 'administrator',\n  'admin': 'administrator',\n  'gerente': 'manager',\n  'desarrollador': 'developer',\n  'consultor': 'consultant',\n  'diseñador': 'designer'\n};\n\nconst nombreLower = nombreUsuario.toLowerCase();\nif (mapeoNombres[nombreLower]) {\n  terminoBusqueda = mapeoNombres[nombreLower];\n  console.log('🔄 Mapeando:', nombreUsuario, '→', terminoBusqueda);\n}\n\nconsole.log('🔍 Término de búsqueda final:', terminoBusqueda);\n\n// Buscar usando el término más apropiado con búsqueda flexible\nconst buscarUsuario = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"hr.employee\",\n      \"search_read\",\n      [\n        [\n          [\"name\", \"ilike\", `%${terminoBusqueda}%`]\n        ]\n      ],\n      {\n        fields: [\"id\", \"name\", \"user_id\"],\n        limit: 20\n      }\n    ]\n  }\n};\n\nconsole.log('🔍 Primero buscando usuario exacto:', JSON.stringify(buscarUsuario, null, 2));\n\nreturn {\n  ...datosAI,\n  payload: JSON.stringify(buscarUsuario),\n  fechaInicio: fechaInicioStr,\n  fechaFin: fechaFinStr,\n  periodoTexto: periodo.replace('_', ' '),\n  paso: 'buscar_usuario'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5248,
        -8272
      ],
      "id": "640ae752-42e3-45f6-a07f-48184e59de92",
      "name": "Preparar Consulta Actividad Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5568,
        -8272
      ],
      "id": "c9373693-9374-4619-a898-3436e416d2fa",
      "name": "HTTP Consulta Actividad Usuario"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de actividad temporal por usuario\nconst datosOriginales = $('Procesar Búsqueda Usuario').item.json;\nconst actividadData = $json.result || [];\n\nconst nombreUsuario = datosOriginales.usuario;\nconst usuarioEncontrado = datosOriginales.usuarioEncontrado || nombreUsuario;\nconst periodo = datosOriginales.periodoTexto;\nconst fechaInicio = datosOriginales.fechaInicio;\nconst fechaFin = datosOriginales.fechaFin;\n\nconsole.log('📊 Formateando respuesta para usuario:', usuarioEncontrado);\nconsole.log('📊 Registros encontrados:', actividadData.length);\n\nif (!actividadData || actividadData.length === 0) {\n  let textoError = `❌ **Sin actividad registrada**\\n\\n`;\n  textoError += `👤 **Usuario:** \"${usuarioEncontrado}\"\\n`;\n  textoError += `📅 **Período:** ${periodo} (${fechaInicio} a ${fechaFin})\\n\\n`;\n  textoError += `No se encontraron registros de tiempo para este usuario en el período especificado.\\n\\n`;\n  textoError += `💡 **Sugerencias:**\\n`;\n  textoError += `• Verifica que el nombre del usuario sea correcto\\n`;\n  textoError += `• Intenta con un período más amplio\\n`;\n  textoError += `• Usa /listar usuarios para ver los usuarios disponibles`;\n  \n  return {\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\n// Calcular estadísticas\nlet totalHoras = 0;\nconst actividadPorProyecto = {};\nconst actividadPorTarea = {};\nconst actividadPorDia = {};\nconst usuarioReal = actividadData[0].user_id[1];\n\nactividadData.forEach(registro => {\n  const horas = parseFloat(registro.unit_amount || 0);\n  totalHoras += horas;\n  \n  // Agrupar por proyecto\n  const proyecto = registro.project_id ? registro.project_id[1] : 'Sin proyecto';\n  if (!actividadPorProyecto[proyecto]) {\n    actividadPorProyecto[proyecto] = { horas: 0, registros: 0 };\n  }\n  actividadPorProyecto[proyecto].horas += horas;\n  actividadPorProyecto[proyecto].registros++;\n  \n  // Agrupar por tarea\n  const tarea = registro.task_id ? registro.task_id[1] : 'Sin tarea específica';\n  if (!actividadPorTarea[tarea]) {\n    actividadPorTarea[tarea] = { horas: 0, registros: 0 };\n  }\n  actividadPorTarea[tarea].horas += horas;\n  actividadPorTarea[tarea].registros++;\n  \n  // Agrupar por día\n  const dia = registro.date;\n  if (!actividadPorDia[dia]) {\n    actividadPorDia[dia] = { horas: 0, registros: 0 };\n  }\n  actividadPorDia[dia].horas += horas;\n  actividadPorDia[dia].registros++;\n});\n\n// Construir respuesta\nlet texto = `⏰ **Actividad de ${usuarioReal}**\\n\\n`;\ntexto += `📅 **Período:** ${periodo} (${fechaInicio} a ${fechaFin})\\n\\n`;\ntexto += `📊 **Resumen:**\\n`;\ntexto += `• Total de horas: ${totalHoras.toFixed(2)}h\\n`;\ntexto += `• Registros: ${actividadData.length}\\n`;\ntexto += `• Promedio diario: ${(totalHoras / Object.keys(actividadPorDia).length).toFixed(2)}h\\n\\n`;\n\n// Mostrar proyectos trabajados\nconst proyectos = Object.entries(actividadPorProyecto)\n  .sort(([,a], [,b]) => b.horas - a.horas);\n\nif (proyectos.length > 0) {\n  texto += `🏗️ **Proyectos trabajados:**\\n`;\n  proyectos.forEach(([proyecto, datos]) => {\n    texto += `• ${proyecto}: ${datos.horas.toFixed(2)}h (${datos.registros} registros)\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar tareas principales\nconst tareas = Object.entries(actividadPorTarea)\n  .sort(([,a], [,b]) => b.horas - a.horas)\n  .slice(0, 5);\n\nif (tareas.length > 0) {\n  texto += `🎯 **Principales tareas:**\\n`;\n  tareas.forEach(([tarea, datos], index) => {\n    texto += `${index + 1}. ${tarea}: ${datos.horas.toFixed(2)}h\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar actividad por días\nconst dias = Object.entries(actividadPorDia)\n  .sort(([a], [b]) => new Date(b) - new Date(a))\n  .slice(0, 7);\n\nif (dias.length > 0) {\n  texto += `📅 **Actividad diaria:**\\n`;\n  dias.forEach(([dia, datos]) => {\n    const fecha = new Date(dia).toLocaleDateString('es-ES');\n    texto += `• ${fecha}: ${datos.horas.toFixed(2)}h (${datos.registros} registros)\\n`;\n  });\n}\n\nreturn {\n  chat_id: datosOriginales.chat_id,\n  texto: texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6416,
        -8272
      ],
      "id": "b679d20d-0eea-4b69-a602-9d562c814880",
      "name": "Formatear Respuesta Actividad Usuario"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6848,
        -8272
      ],
      "id": "5f351255-4187-4c45-8e86-23fd68bae261",
      "name": "Enviar Respuesta Actividad Usuario",
      "webhookId": "webhook-actividad-usuario-001"
    },
    {
      "parameters": {
        "jsCode": "// Procesar resultado de búsqueda de usuarios y preparar consulta de actividad\nconst datosOriginales = $('Preparar Consulta Actividad Usuario').item.json;\nconst usuariosBuscados = $json.result || [];\n\nconst nombreUsuario = datosOriginales.usuario;\nconst fechaInicio = datosOriginales.fechaInicio;\nconst fechaFin = datosOriginales.fechaFin;\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconsole.log('👥 Usuarios encontrados:', usuariosBuscados.length);\nconsole.log('👥 Lista de usuarios:', usuariosBuscados.map(u => u.name));\n\nif (!usuariosBuscados || usuariosBuscados.length === 0) {\n  // No se encontró el usuario\n  const textoError = `❌ **Usuario no encontrado**\\n\\n` +\n    `👤 **Usuario buscado:** \"${nombreUsuario}\"\\n\\n` +\n    `No se encontró ningún usuario con ese nombre.\\n\\n` +\n    `💡 **Sugerencias:**\\n` +\n    `• Verifica que el nombre del usuario sea correcto\\n` +\n    `• Intenta con solo el nombre sin apellidos\\n` +\n    `• Intenta con variaciones como \"admin\", \"administrador\", etc.`;\n  \n  return {\n    accion: 'enviar_mensaje_directo',\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\n// Buscar la mejor coincidencia\nlet usuarioSeleccionado = usuariosBuscados[0];\n\n// Buscar coincidencia exacta (sin distinguir mayúsculas/minúsculas)\nconst coincidenciaExacta = usuariosBuscados.find(user => \n  user.name.toLowerCase() === nombreUsuario.toLowerCase()\n);\n\nif (coincidenciaExacta) {\n  usuarioSeleccionado = coincidenciaExacta;\n  console.log('✅ Coincidencia exacta encontrada:', usuarioSeleccionado.name);\n} else {\n  console.log('⚠️ No hay coincidencia exacta, usando primera opción:', usuarioSeleccionado.name);\n}\n\nconsole.log('👤 Empleado seleccionado:', usuarioSeleccionado.name, 'Employee ID:', usuarioSeleccionado.id, 'User ID:', usuarioSeleccionado.user_id);\n\n// Verificar que el empleado tenga un user_id asociado\nif (!usuarioSeleccionado.user_id) {\n  const textoError = `❌ **Empleado sin usuario asociado**\\n\\n` +\n    `👤 **Empleado encontrado:** \"${usuarioSeleccionado.name}\"\\n\\n` +\n    `Este empleado no tiene un usuario de sistema asociado para registrar horas.\\n\\n` +\n    `💡 **Sugerencia:**\\n` +\n    `• Contacta al administrador para asociar un usuario a este empleado`;\n  \n  return {\n    accion: 'enviar_mensaje_directo',\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\nconst userIdDelEmpleado = usuarioSeleccionado.user_id[0]; // user_id es un array [id, \"nombre\"]\n\n// Ahora buscar actividad del usuario usando su user_id exacto\nconst consultarActividad = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"search_read\",\n      [\n        [\n          [\"user_id\", \"=\", userIdDelEmpleado],\n          [\"date\", \">=\", fechaInicio],\n          [\"date\", \"<\", fechaFin]\n        ]\n      ],\n      {\n        fields: [\n          \"date\", \"unit_amount\", \"name\", \"task_id\", \"project_id\", \"user_id\"\n        ],\n        order: \"date desc\"\n      }\n    ]\n  }\n};\n\nconsole.log('🔍 Consultando actividad con User ID exacto:', userIdDelEmpleado);\nconsole.log('📅 Filtros:', `[\"user_id\", \"=\", ${userIdDelEmpleado}], [\"date\", \">=\", \"${fechaInicio}\"], [\"date\", \"<\", \"${fechaFin}\"]`);\n\nreturn {\n  ...datosOriginales,\n  payload: JSON.stringify(consultarActividad),\n  usuarioEncontrado: usuarioSeleccionado.name,\n  usuarioId: usuarioSeleccionado.id,\n  paso: 'consultar_actividad'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5856,
        -8272
      ],
      "id": "62ce48ec-5f3d-45e0-a9aa-3606a6de547c",
      "name": "Procesar Búsqueda Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6144,
        -8272
      ],
      "id": "185ee39a-b6eb-486e-aaca-1ca119844cea",
      "name": "HTTP Consulta Actividad Usuario Final"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de horas por proyecto\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreProyecto = datosAI.proyecto;\n\nconsole.log('🔍 Consultando horas del proyecto:', nombreProyecto);\n\n// Validar datos\nif (!uid) throw new Error('No se pudo obtener el UID de autenticación');\nif (!nombreProyecto) throw new Error('No se encontró el nombre del proyecto');\n\n// Buscar proyecto y sus horas en una sola consulta\nconst consultarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"search_read\",\n      [\n        [[\"project_id.name\", \"ilike\", nombreProyecto]],\n        [\"id\", \"name\", \"date\", \"unit_amount\", \"task_id\", \"user_id\", \"project_id\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultarHoras,\n  proyecto: nombreProyecto,\n  chat_id: datosAI.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5232,
        -7872
      ],
      "id": "e734e203-4c73-414b-b56a-e733f22ef2a7",
      "name": "Preparar Consulta Horas Proyecto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5424,
        -7872
      ],
      "id": "042cbf59-a30f-4593-bad2-182e7e5e49cb",
      "name": "HTTP Consulta Horas Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de horas por proyecto\nconst datosOriginales = $('Preparar Consulta Horas Proyecto').item.json;\nconst horasData = $json.result || [];\n\nconst nombreProyecto = datosOriginales.proyecto;\n\nif (!horasData || horasData.length === 0) {\n  let textoError = `❌ **Proyecto no encontrado**\\n\\n`;\n  textoError += `🏗️ **Proyecto buscado:** \"${nombreProyecto}\"\\n\\n`;\n  textoError += `No se encontraron registros de horas para un proyecto con ese nombre.\\n\\n`;\n  textoError += `💡 **Sugerencias:**\\n`;\n  textoError += `• Verifica que el nombre del proyecto sea correcto\\n`;\n  textoError += `• Intenta con un nombre más corto o parcial\\n`;\n  textoError += `• Usa /listar proyectos para ver los proyectos disponibles`;\n  \n  return {\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\n// Calcular estadísticas\nlet totalHoras = 0;\nconst registrosPorTarea = {};\nconst registrosPorUsuario = {};\nconst proyectosEncontrados = new Set();\n\nhorasData.forEach(registro => {\n  totalHoras += parseFloat(registro.unit_amount || 0);\n  proyectosEncontrados.add(registro.project_id[1]);\n  \n  // Agrupar por tarea\n  const tarea = registro.task_id ? registro.task_id[1] : 'Sin tarea específica';\n  if (!registrosPorTarea[tarea]) {\n    registrosPorTarea[tarea] = { horas: 0, registros: 0 };\n  }\n  registrosPorTarea[tarea].horas += parseFloat(registro.unit_amount || 0);\n  registrosPorTarea[tarea].registros++;\n  \n  // Agrupar por usuario\n  const usuario = registro.user_id ? registro.user_id[1] : 'Usuario desconocido';\n  if (!registrosPorUsuario[usuario]) {\n    registrosPorUsuario[usuario] = { horas: 0, registros: 0 };\n  }\n  registrosPorUsuario[usuario].horas += parseFloat(registro.unit_amount || 0);\n  registrosPorUsuario[usuario].registros++;\n});\n\n// Obtener el nombre real del proyecto\nconst proyectoReal = Array.from(proyectosEncontrados)[0] || nombreProyecto;\n\n// Formatear respuesta\nlet texto = `⏰ **Horas del Proyecto:** ${proyectoReal}\\n\\n`;\ntexto += `📊 **Total de horas:** ${totalHoras.toFixed(2)}h\\n`;\ntexto += `📄 **Registros:** ${horasData.length}\\n\\n`;\n\n// Mostrar horas por usuario\nconst usuarios = Object.entries(registrosPorUsuario)\n  .sort(([,a], [,b]) => b.horas - a.horas);\n\nif (usuarios.length > 0) {\n  texto += `👥 **Horas por usuario:**\\n`;\n  usuarios.forEach(([usuario, datos]) => {\n    texto += `• ${usuario}: ${datos.horas.toFixed(2)}h (${datos.registros} registros)\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar top 5 tareas con más horas\nconst topTareas = Object.entries(registrosPorTarea)\n  .sort(([,a], [,b]) => b.horas - a.horas)\n  .slice(0, 5);\n\nif (topTareas.length > 0) {\n  texto += `🎯 **Top Tareas:**\\n`;\n  topTareas.forEach(([tarea, datos], index) => {\n    texto += `${index + 1}. ${tarea}: ${datos.horas.toFixed(2)}h\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar últimos 5 registros\nconst ultimosRegistros = horasData\n  .sort((a, b) => new Date(b.date) - new Date(a.date))\n  .slice(0, 5);\n\nif (ultimosRegistros.length > 0) {\n  texto += `📅 **Últimos registros:**\\n`;\n  ultimosRegistros.forEach(registro => {\n    const fecha = new Date(registro.date).toLocaleDateString('es-ES');\n    const tarea = registro.task_id ? registro.task_id[1] : 'Sin tarea';\n    const usuario = registro.user_id ? registro.user_id[1] : 'Usuario desconocido';\n    texto += `• ${fecha}: ${parseFloat(registro.unit_amount).toFixed(2)}h - ${tarea} (${usuario})\\n`;\n  });\n}\n\nreturn {\n  chat_id: datosOriginales.chat_id,\n  texto: texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5648,
        -7872
      ],
      "id": "1a4ba87b-dda7-4fef-891b-b3ad4261d23c",
      "name": "Formatear Respuesta Horas Proyecto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5872,
        -7872
      ],
      "id": "053108c1-3176-4751-8278-7562bfb991f6",
      "name": "Enviar Respuesta Horas Proyecto",
      "webhookId": "webhook-horas-proyecto-001"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de horas por tarea específica\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreProyecto = datosAI.proyecto || null;\nconst nombreTarea = datosAI.tarea;\n\nconsole.log('🔍 Consultando horas de tarea:', nombreTarea, nombreProyecto ? 'en proyecto: ' + nombreProyecto : '(en cualquier proyecto)');\n\n// Validar datos esenciales\nif (!uid) throw new Error('No se pudo obtener el UID de autenticación');\nif (!nombreTarea) throw new Error('No se encontró el nombre de la tarea');\n\n// Construir filtros - solo por tarea, sin filtrar por proyecto\nconst filtros = [[\"task_id.name\", \"ilike\", nombreTarea]];\n\n// Buscar horas de la tarea específica\nconst consultarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"search_read\",\n      [\n        filtros,\n        [\"id\", \"name\", \"date\", \"unit_amount\", \"task_id\", \"user_id\", \"project_id\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultarHoras,\n  proyecto: nombreProyecto,\n  tarea: nombreTarea,\n  chat_id: datosAI.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5248,
        -7504
      ],
      "id": "e0d2659e-47d9-4b82-8608-8ef6edae0157",
      "name": "Preparar Consulta Horas Tarea"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5440,
        -7504
      ],
      "id": "09a573c5-a02d-4a03-ad0d-5ada95a92a12",
      "name": "HTTP Consulta Horas Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de horas por tarea específica\nconst datosOriginales = $('Preparar Consulta Horas Tarea').item.json;\nconst horasData = $json.result || [];\n\nconst nombreProyecto = datosOriginales.proyecto;\nconst nombreTarea = datosOriginales.tarea;\n\n// Verificar si no se encontraron resultados\nif (!horasData || horasData.length === 0) {\n  let textoError = `❌ **Tarea no encontrada**\\n\\n`;\n  textoError += `🎯 **Tarea buscada:** \"${nombreTarea}\"\\n\\n`;\n  textoError += `No se encontraron registros de horas para una tarea con ese nombre.\\n\\n`;\n  textoError += `💡 **Sugerencias:**\\n`;\n  textoError += `• Verifica que el nombre de la tarea sea correcto\\n`;\n  textoError += `• Intenta con un nombre más corto o parcial\\n`;\n  textoError += `• Usa /listar tareas para ver las tareas disponibles`;\n  \n  return {\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\n// Calcular estadísticas\nlet totalHoras = 0;\nconst registrosPorUsuario = {};\nconst registrosPorProyecto = {};\nconst proyectoReal = horasData[0].project_id[1];\nconst tareaReal = horasData[0].task_id[1];\n\nhorasData.forEach(registro => {\n  totalHoras += parseFloat(registro.unit_amount || 0);\n  \n  // Agrupar por usuario\n  const usuario = registro.user_id ? registro.user_id[1] : 'Usuario desconocido';\n  if (!registrosPorUsuario[usuario]) {\n    registrosPorUsuario[usuario] = { horas: 0, registros: 0 };\n  }\n  registrosPorUsuario[usuario].horas += parseFloat(registro.unit_amount || 0);\n  registrosPorUsuario[usuario].registros++;\n  \n  // Agrupar por proyecto (en caso de que la tarea esté en múltiples proyectos)\n  const proyecto = registro.project_id[1];\n  if (!registrosPorProyecto[proyecto]) {\n    registrosPorProyecto[proyecto] = { horas: 0, registros: 0 };\n  }\n  registrosPorProyecto[proyecto].horas += parseFloat(registro.unit_amount || 0);\n  registrosPorProyecto[proyecto].registros++;\n});\n\n// Formatear respuesta\nlet texto = `⏰ **Horas de Tarea:** ${tareaReal}\\n`;\n\n// Mostrar proyecto(s) donde se encontró la tarea\nconst proyectos = Object.keys(registrosPorProyecto);\nif (proyectos.length === 1) {\n  texto += `🏗️ **Proyecto:** ${proyectos[0]}\\n\\n`;\n} else if (proyectos.length > 1) {\n  texto += `🏗️ **Proyectos:** ${proyectos.join(', ')}\\n\\n`;\n}\n\ntexto += `📊 **Total de horas:** ${totalHoras.toFixed(2)}h\\n`;\ntexto += `📄 **Registros:** ${horasData.length}\\n\\n`;\n\n// Mostrar horas por proyecto si hay múltiples\nif (proyectos.length > 1) {\n  texto += `🏗️ **Horas por proyecto:**\\n`;\n  Object.entries(registrosPorProyecto).forEach(([proyecto, datos]) => {\n    texto += `• ${proyecto}: ${datos.horas.toFixed(2)}h\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar horas por usuario si hay múltiples usuarios\nconst usuarios = Object.entries(registrosPorUsuario);\nif (usuarios.length > 1) {\n  texto += `👥 **Horas por usuario:**\\n`;\n  usuarios.forEach(([usuario, datos]) => {\n    texto += `• ${usuario}: ${datos.horas.toFixed(2)}h\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar todos los registros (limitado a 10)\nconst registrosOrdenados = horasData\n  .sort((a, b) => new Date(b.date) - new Date(a.date))\n  .slice(0, 10);\n\nif (registrosOrdenados.length > 0) {\n  texto += `📅 **Registros de tiempo:**\\n`;\n  registrosOrdenados.forEach(registro => {\n    const fecha = new Date(registro.date).toLocaleDateString('es-ES');\n    const usuario = registro.user_id ? registro.user_id[1] : 'Usuario';\n    const proyecto = registro.project_id[1];\n    const descripcion = registro.name || 'Sin descripción';\n    texto += `• ${fecha}: ${parseFloat(registro.unit_amount).toFixed(2)}h - ${usuario}`;\n    if (proyectos.length > 1) {\n      texto += ` (${proyecto})`;\n    }\n    texto += `\\n`;\n    if (descripcion && descripcion !== 'Sin descripción') {\n      texto += `  📝 ${descripcion}\\n`;\n    }\n  });\n}\n\nif (horasData.length > 10) {\n  texto += `\\n... y ${horasData.length - 10} registros más.`;\n}\n\nreturn {\n  chat_id: datosOriginales.chat_id,\n  texto: texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5664,
        -7504
      ],
      "id": "e7daa603-4368-4851-858b-d023807dc9b5",
      "name": "Formatear Respuesta Horas Tarea"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5856,
        -7504
      ],
      "id": "117f1143-212c-46d8-b9f8-67d772177f71",
      "name": "Enviar Respuesta Horas Tarea",
      "webhookId": "webhook-horas-tarea-001"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR CONSULTA ESTADO PROYECTO (con filtro por ETAPA)\nlet base = $json || {};\ntry { base = $('Router de Acciones FIXED').first().json || base; } catch {}\ntry { base = Object.assign({}, base, $('Preparar Datos AI Agent').first().json || {}); } catch {}\n\nconst rawMsg = String(base.mensaje_usuario || base.mensaje_original || '').trim();\n\n// --- detectar etapa solicitada ---\nconst stages = [\n  { key: 'in_progress', re: /(en\\s+(proceso|progreso|curso)|in\\s*progress|andando)/i,\n    labels: ['In Progress','En Progreso','En proceso','En curso'] },\n  { key: 'new', re: /(nuevo(s)?|nueva(s)?|por\\s*empezar|planificaci[oó]n|por\\s*hacer|to\\s*do)/i,\n    labels: ['New','Nuevo','Por hacer','To Do'] },\n  { key: 'done', re: /(hecho(s)?|finalizad[oa]s?|completad[oa]s?|cerrad[oa]s?|terminad[oa]s?|done)/i,\n    labels: ['Done','Hecho','Finalizado','Completado','Cerrado','Terminado'] },\n  { key: 'cancelled', re: /(cancelad[oa]s?|anulad[oa]s?)/i,\n    labels: ['Cancelled','Cancelado','Anulado'] },\n];\n\nlet listar_por_etapa = false;\nlet filtro_etapa = null;\nif (/\\bproyectos?\\b/i.test(rawMsg)) {\n  for (const s of stages) {\n    if (s.re.test(rawMsg)) { listar_por_etapa = true; filtro_etapa = { key: s.key, labels: s.labels }; break; }\n  }\n}\n\n// --- extracción de posible nombre de proyecto (para el flujo “uno solo”) ---\nlet proyecto = base.proyecto || '';\nif (!proyecto) {\n  let m = rawMsg.match(/[\"'“”‘’]([^\"'“”‘’]+)[\"'“”‘’]/); if (m) proyecto = m[1];\n}\nif (!proyecto) {\n  let m = rawMsg.match(/(?:proyecto|del\\s+proyecto|estado\\s+del\\s+proyecto)\\s+([\\p{L}\\d _-]+)/iu);\n  if (m) proyecto = m[1].trim();\n}\nif (!proyecto && rawMsg) {\n  const toks = rawMsg.split(/\\s+/); proyecto = (toks[toks.length-1]||'').replace(/[\\.,;:!?]+$/,'');\n}\n\n// detalle de timesheets\nconst includeTimesheets = /\\b(registro|registros|timesheet|partes?\\s*de\\s*trabajo|horas\\s*registradas)\\b/i.test(rawMsg) || base.includeTimesheets === true;\nconst daysBack = Number(base.daysBack || 90);\nconst since = new Date(Date.now() - daysBack*24*3600*1000).toISOString().slice(0,10);\n\nreturn {\n  chat_id: base.chat_id || 0,\n  user_id: base.user_id || 0,\n  user_name: base.user_name || 'Usuario',\n  mensaje_original: rawMsg,\n  proyecto_query: proyecto,\n  includeTimesheets,\n  daysBack,\n  since,\n  listar_por_etapa,\n  filtro_etapa\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5184,
        -6752
      ],
      "id": "8f315cd6-62eb-4790-8eaa-3cb4ce107ede",
      "name": "Preparar Consulta Estado Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Buscar Proyecto (SAFE)\nconst uid = $('Autenticar Odoo').item.json.result;\nconst name = $json.proyecto_query;\nif (!name) throw new Error('No se pudo extraer el nombre del proyecto');\n\nconst fields = [\n  'id','name','partner_id','user_id','date_start','date','company_id'\n  // ⛔ NO pongas: analytic_account_id, planned_hours, timesheet_grid, allow_timesheets\n];\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'mchecagoshawk-webinar-main-28403608',\n      uid,\n      'admin',\n      'project.project',\n      'search_read',\n      [\n        [[ 'name', 'ilike', name ]],\n        fields\n      ]\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn {\n  payload,\n  proyecto_query: name,\n  chat_id: $json.chat_id,\n  includeTimesheets: $json.includeTimesheets,\n  daysBack: $json.daysBack,\n  since: $json.since\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5632,
        -6752
      ],
      "id": "6610dbad-6d16-4655-abd3-f25053c8c13a",
      "name": "Preparar Buscar Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// Elegir proyecto o desambiguar\nconst res = $json.body?.result || $json.result || [];\nconst query = $('Preparar Buscar Proyecto').item.json.proyecto_query;\nlet chosen = null;\nlet suggestions = [];\nif (Array.isArray(res) && res.length) {\n  const norm = s => String(s||'').trim().toLowerCase();\n  chosen = res.find(p => norm(p.name) === norm(query)) || res[0];\n  suggestions = res.map(p => ({ id: p.id, name: p.name })).slice(0,5);\n}\nreturn { found: !!chosen, project: chosen, suggestions, query,\n         chat_id: $('Preparar Buscar Proyecto').item.json.chat_id,\n         includeTimesheets: $('Preparar Buscar Proyecto').item.json.includeTimesheets,\n         daysBack: $('Preparar Buscar Proyecto').item.json.daysBack,\n         since: $('Preparar Buscar Proyecto').item.json.since }"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6112,
        -6752
      ],
      "id": "f2fa5f48-2f04-48a2-ad25-5532a2913cba",
      "name": "Resolver Proyecto / Desambiguar"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "96dab1fd-11a8-44fc-9a98-f44466d2fec3",
              "leftValue": "={{ $json.found === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        6352,
        -6752
      ],
      "id": "3af47cf3-ded7-48de-b950-d794a0563c0a",
      "name": "¿Proyecto encontrado?"
    },
    {
      "parameters": {
        "jsCode": "// Preguntar por desambiguación y guardar memoria mínima\nconst sug = $json.suggestions || [];\nconst chat_id = $json.chat_id;\nlet texto = `🧭 No encontré una coincidencia clara para \"${$json.query}\".\\n`;\nif (sug.length) {\n  texto += `¿Te refieres a alguno de estos?\\n` + sug.map((s,i)=>`${i+1}. ${s.name}`).join('\\n');\n  texto += `\\n\\nResponde con el número o el nombre exacto.`;\n}\n// Guardar memoria simple en global para este chat (tu flujo ya persiste en PostgreSQL más adelante si quieres)\nconst key = `memoria_${chat_id}`; const m = global[key] || {}; m.esperando_confirmacion = 'elegir_proyecto_consulta'; m.datos_pendientes = { accion_original: 'consulta_estado_proyecto', query: $json.query, opciones: sug }; global[key] = m;\nreturn { chat_id, texto }"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6576,
        -6608
      ],
      "id": "4b338bf0-b96f-4c9a-92ac-b46237d16a11",
      "name": "Formatear Desambiguación"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6832,
        -6576
      ],
      "id": "bff27c30-e7f4-485a-8923-e5e66b559ca2",
      "name": "Telegram Preguntar Proyecto",
      "webhookId": "1a111111-1111-4111-8111-111111111111"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Get Tareas (SAFE, sin planned_hours)\nconst uid = $('Autenticar Odoo').item.json.result;\nconst p = $json.project;\n\nconst fields = [\n  'id','name','stage_id','priority','date_deadline',\n  'project_id','create_date','write_date'\n  // ⛔ NO: 'planned_hours', 'kanban_state', 'user_id', 'effective_hours', 'remaining_hours'\n];\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'mchecagoshawk-webinar-main-28403608',\n      uid,\n      'admin',\n      'project.task',\n      'search_read',\n      [\n        [[ 'project_id','=', p.id ]],\n        fields\n      ]\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn {\n  payload,\n  project: p,\n  chat_id: $json.chat_id,\n  includeTimesheets: $json.includeTimesheets,\n  daysBack: $json.daysBack,\n  since: $json.since\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6592,
        -6944
      ],
      "id": "d2ee0d46-01ba-45fe-bdba-ff737131966f",
      "name": "Preparar Get Tareas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6832,
        -6944
      ],
      "id": "de4a0424-7468-4854-8cd2-d2b76ff2e7bc",
      "name": "HTTP Get Tareas"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Horas Agrupadas (robusto)\n// - Si hay tareas: domain = ['task_id','in', taskIds]\n// - Si NO hay tareas: domain = ['project_id','=', project.id]\n// - Opcional: filtro por fecha 'since' si existe\n\nconst uid = $('Autenticar Odoo').item.json.result;\n\n// Normaliza de dónde vienen las tareas\nconst raw = $json || {};\nconst tasksFromHttp = (raw.body && raw.body.result) ? raw.body.result\n                     : (Array.isArray(raw.result) ? raw.result\n                     : (Array.isArray(raw.tasks_full) ? raw.tasks_full : []));\nconst taskIds = tasksFromHttp.map(t => t.id).filter(id => Number.isInteger(id));\n\nconst project = raw.project || {};\nconst since = raw.since; // 'YYYY-MM-DD' si lo pasas en tu flujo\n\n// Construye el dominio\nconst domain = [];\nif (taskIds.length > 0) {\n  domain.push(['task_id', 'in', taskIds]);\n} else if (project.id) {\n  domain.push(['project_id', '=', project.id]);\n} else {\n  // Sin tareas y sin proyecto → evita llamada y devuelve estructura vacía\n  return {\n    skip_http: true,\n    tasks_full: [],\n    project,\n    chat_id: raw.chat_id,\n    since\n  };\n}\n\n// Filtro temporal opcional\nif (since) domain.push(['date', '>=', since]);\n\n// Payload para read_group\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'mchecagoshawk-webinar-main-28403608', // <-- tu DB\n      uid,\n      'admin',\n      'account.analytic.line',\n      'read_group',\n      [\n        domain,\n        ['unit_amount:sum'],   // suma horas\n        ['task_id']            // agrupación\n      ],\n      { lazy: false }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn {\n  payload,\n  tasks_full: tasksFromHttp,\n  project,\n  chat_id: raw.chat_id,\n  since\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7072,
        -6944
      ],
      "id": "3613b10c-ce25-4e02-a06b-322d39619afa",
      "name": "Preparar Horas Agrupadas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7312,
        -6944
      ],
      "id": "295b35ff-4ecd-4c1a-bf33-cdec4b5c26e5",
      "name": "HTTP Horas por Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Timesheets Detalle (robusto con fallback por grupos de horas)\n\n// Utilidad para leer items de otros nodos sin romper\nconst getNodeJson = (name, runIndex = 0, outputIndex = 0) => {\n  try {\n    const arr = $items(name, runIndex, outputIndex);\n    return (Array.isArray(arr) && arr.length) ? arr[0].json : null;\n  } catch (e) { return null; }\n};\n\nconst uid = $('Autenticar Odoo').item.json.result;\nconst db  = 'mchecagoshawk-webinar-main-28403608'; // tu DB\n\n// 1) Intentamos conseguir TAREAS completas\nconst httpTareas = getNodeJson('HTTP Get Tareas');           // respuesta HTTP con body.result = tareas\nconst prepHoras  = getNodeJson('Preparar Horas Agrupadas');  // suele llevar tasks_full y since\nconst resProj    = getNodeJson('Resolver Proyecto / Desambiguar');\n\nconst tasks = (httpTareas?.body?.result) || httpTareas?.result || prepHoras?.tasks_full || $json.tasks_full || [];\nlet taskIds = (Array.isArray(tasks) ? tasks : []).map(t => t.id).filter(n => Number.isInteger(n));\n\n// 2) PROYECTO (si existe)\nconst project = (resProj?.project) || $json.project || prepHoras?.project || {};\n\n// 3) SINCE (si existe y es válido YYYY-MM-DD)\nconst sinceRaw = prepHoras?.since || $json.since || null;\nconst since = (sinceRaw && String(sinceRaw).match(/^\\d{4}-\\d{2}-\\d{2}$/)) ? sinceRaw : null;\n\n// 4) FALLBACK: si NO hay tasks, usa los GRUPOS del nodo de horas (entrada directa de este nodo)\nconst groupsIn = ($json?.body?.result) || $json.result || [];\nif ((!taskIds || taskIds.length === 0) && Array.isArray(groupsIn) && groupsIn.length) {\n  const fromGroups = [];\n  for (const g of groupsIn) {\n    const tid = Array.isArray(g.task_id) ? g.task_id[0] : g.task_id;\n    if (Number.isInteger(tid)) fromGroups.push(tid);\n  }\n  if (fromGroups.length) taskIds = Array.from(new Set(fromGroups));\n}\n\n// 5) Construcción de dominio (tareas > proyecto). Si nada, evitamos HTTP.\nconst domain = [];\nif (taskIds.length > 0) {\n  domain.push(['task_id','in', taskIds]);\n} else if (project.id) {\n  domain.push(['project_id','=', project.id]);\n} else {\n  return { skip_http: true, tasks_full: [], project: {} };\n}\nif (since) domain.push(['date','>=', since]); // jamás meter date >= null\n\n// 6) Payload search_read de líneas de horas (detalle)\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'account.analytic.line',\n      'search_read',\n      [\n        domain,\n        ['id','task_id','date','user_id','employee_id','unit_amount','name']\n      ],\n      { limit: 2000, order: 'date desc, id desc' }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn {\n  payload,\n  project,\n  tasks_full: tasks,                       // puede ir vacío; no pasa nada\n  chat_id: prepHoras?.chat_id || $json.chat_id || 0,\n  since\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7552,
        -6944
      ],
      "id": "652bbb05-2e00-4766-93da-242a77cf4292",
      "name": "Preparar Timesheets Detalle"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7776,
        -6944
      ],
      "id": "0cef9707-b56e-467b-bcac-477a2e3610a3",
      "name": "HTTP Timesheets Detalle"
    },
    {
      "parameters": {
        "jsCode": "// ===== Formatear Respuesta Estado Proyecto (versión visual con emojis) =====\n\n// Helper: leer 1ª salida JSON de otro nodo\nconst getNodeJson = (name, runIndex = 0, outputIndex = 0) => {\n  try {\n    const arr = $items(name, runIndex, outputIndex);\n    return (Array.isArray(arr) && arr.length) ? arr[0].json : null;\n  } catch { return null; }\n};\n\n// Escape seguro para Markdown (usaremos backticks en nombres)\nconst clean = (s) => String(s ?? '').replace(/`/g, \"'\");\n\n// Datos base\nconst resProj   = getNodeJson('Resolver Proyecto / Desambiguar');\nconst httpTasks = getNodeJson('HTTP Get Tareas');\nconst httpHours = getNodeJson('HTTP Horas por Tarea');\nconst httpTs    = getNodeJson('HTTP Timesheets Detalle');\n\nconst project    = resProj?.project || $json.project || {};\nconst tasks      = (httpTasks?.body?.result) || httpTasks?.result || $json.tasks_full || [];\nconst hoursGroup = ($json.body?.result) || $json.result || httpHours?.body?.result || httpHours?.result || [];\nconst timesheets = (httpTs?.body?.result) || httpTs?.result || [];\n\nconst baseUrl = 'https://lsanchezgoshawk-azordatatest.odoo.com';\nconst today   = new Date().toISOString().slice(0,10);\n\n// Mapa horas por tarea (read_group)\nconst hoursByTask = {};\nfor (const g of (hoursGroup || [])) {\n  const tid = Array.isArray(g.task_id) ? g.task_id[0] : g.task_id;\n  if (!tid) continue;\n  const v = (g['unit_amount'] ?? g['unit_amount:sum'] ?? 0);\n  hoursByTask[tid] = Number(v) || 0;\n}\n\n// KPI globales\nlet plan = 0, eff = 0;\nfor (const t of tasks) {\n  if (typeof t.planned_hours === 'number') plan += Number(t.planned_hours || 0);\n  eff += Number(hoursByTask[t.id] || t.effective_hours || 0);\n}\nconst avance = plan > 0 ? Math.min(100, Math.max(0, Math.round((eff/plan)*100))) : null;\n\n// Barra de progreso (10 bloques)\nconst progressBar = (pct) => {\n  const total = 10;\n  const filled = Math.round((pct/100)*total);\n  return '▰'.repeat(filled) + '▱'.repeat(total - filled);\n};\n\n// Icono por etapa / estado + retraso\nconst stageIcon = (stageName, isLate) => {\n  const s = String(stageName || '').toLowerCase();\n  const base = s.includes('done') || s.includes('hecho') ? '✅'\n             : s.includes('progress') || s.includes('en ') ? '🚧'\n             : '🆕';\n  return isLate ? '⏰' : base;\n};\n\n// Cabecera\nlet texto = `🗂️ *Proyecto:* \\`${clean(project?.name || '—')}\\`\\n`;\ntexto += `👤 *Cliente:* \\`${clean(project?.partner_id ? project.partner_id[1] : '—')}\\`  •  👨‍💼 *PM:* \\`${clean(project?.user_id ? project.user_id[1] : '—')}\\`\\n`;\ntexto += `🗓️ *Fechas:* inicio \\`${clean(project?.date_start || '—')}\\` · fin prevista \\`${clean(project?.date || '—')}\\`\\n`;\n\nif (plan > 0) {\n  texto += `⏱️ *Horas:* plan \\`${plan}h\\` · efectivas \\`${eff}h\\` · avance \\`${avance}%\\`\\n`;\n  texto += `   ${progressBar(avance)}\\n`;\n} else {\n  texto += `⏱️ *Horas:* efectivas \\`${eff}h\\`\\n`;\n}\n\nif (project?.id) {\n  texto += `🔗 [Abrir proyecto](${baseUrl}/web#id=${project.id}&model=project.project&view_type=form)\\n`;\n}\n\ntexto += `\\n📋 *Tareas (${tasks.length}):*\\n`;\n\n// Filas de tareas (máx 25 para no saturar Telegram)\nconst MAX_ROWS = 25;\nconst rows = [];\nfor (const t of tasks.slice(0, MAX_ROWS)) {\n  const etapa = Array.isArray(t.stage_id) ? t.stage_id[1] : null;\n\n  // Horas hechas\n  const hechas = (typeof t.effective_hours === 'number') ? t.effective_hours : (hoursByTask[t.id] || 0);\n\n  // Plan y restantes (si existe planned_hours)\n  const tienePlan = typeof t.planned_hours === 'number';\n  const rest = tienePlan ? Math.max(0, Number(t.planned_hours || 0) - Number(hechas || 0)) : null;\n\n  // Retraso (si no está done/hecho y deadline vencida)\n  const isDone = (String(etapa||'').toLowerCase().includes('done') || String(etapa||'').toLowerCase().includes('hecho'));\n  const isLate = (t.date_deadline && t.date_deadline < today && !isDone);\n\n  const icon = stageIcon(etapa, isLate);\n  const link = t.id ? `  🔗 [Abrir](${baseUrl}/web#id=${t.id}&model=project.task&view_type=form)` : '';\n\n  let line1 = `${icon} *\\`${clean(t.name)}\\`*  —  \\`${clean(etapa || '—')}\\``;\n  let line2 = `   · ⏱️ \\`Hechas ${hechas}h\\`` + (tienePlan ? ` · \\`Plan ${t.planned_hours||0}h\\` · \\`Rest. ${rest}h\\`` : ``);\n  if (t.date_deadline) line2 += ` · 🗓️ \\`${t.date_deadline}\\``;\n  const line3 = link;\n\n  rows.push(`${line1}\\n${line2}${line3 ? `\\n${line3}` : ''}`);\n}\nif (rows.length) texto += rows.join('\\n') + (tasks.length > MAX_ROWS ? `\\n… \\`${tasks.length - MAX_ROWS}\\` más` : '');\nelse texto += '—';\n\n// Bloque de timesheets (si hay)\nif (Array.isArray(timesheets) && timesheets.length) {\n  // Índice por tarea + ordenar por fecha desc\n  const tsByTask = {};\n  for (const l of timesheets) {\n    const tid = Array.isArray(l.task_id) ? l.task_id[0] : l.task_id;\n    if (!tid) continue;\n    (tsByTask[tid] ||= []).push(l);\n  }\n  for (const k of Object.keys(tsByTask)) tsByTask[k].sort((a,b)=> a.date < b.date ? 1 : -1);\n\n  texto += `\\n\\n🧾 *Registros recientes (máx. 3 por tarea):*\\n`;\n  for (const t of tasks) {\n    const ts = (tsByTask[t.id] || []).slice(0,3);\n    if (!ts.length) continue;\n    const lines = ts.map(x=>{\n      const who = (Array.isArray(x.user_id) ? x.user_id[1] :\n                  (Array.isArray(x.employee_id) ? x.employee_id[1] : '—'));\n      return `   · \\`${x.date || '—'}\\` · \\`${clean(who)}\\` · \\`${x.unit_amount || 0}h\\` · ${clean(x.name || '')}`;\n    });\n    texto += `• *\\`${clean(t.name)}\\`*\\n${lines.join('\\n')}\\n`;\n  }\n}\n\n// chat_id desde cualquier nodo previo\n\nconst chatId =\n  getNodeJson('Preparar Horas Agrupadas')?.chat_id ||\n  getNodeJson('Preparar Get Tareas')?.chat_id ||\n  getNodeJson('Resolver Proyecto / Desambiguar')?.chat_id ||\n  $json.chat_id || 0;\n\n// ===== Split en chunks compatibles con Telegram =====\n// 4096 es el límite; dejo margen por Markdown/enlaces\nconst MAX = 3800;\n\n// parte por líneas para no romper Markdown a mitad de una línea\nconst lines = String(texto || '').split('\\n');\n\nconst chunks = [];\nlet buf = '';\n\nfor (const line of lines) {\n  // si una sola línea es enorme, la troceamos a pelo\n  if (line.length > MAX) {\n    if (buf) { chunks.push(buf); buf = ''; }\n    for (let i = 0; i < line.length; i += MAX) {\n      chunks.push(line.slice(i, i + MAX));\n    }\n    continue;\n  }\n\n  const next = buf ? (buf + '\\n' + line) : line;\n\n  if (next.length > MAX) {\n    if (buf) chunks.push(buf);\n    buf = line;\n  } else {\n    buf = next;\n  }\n}\nif (buf) chunks.push(buf);\n\n// Devuelve varios mensajes (items) para que Telegram node los envíe en cadena\nreturn chunks.map((c, i) => ({\n  chat_id: chatId,\n  text: (chunks.length > 1 ? `(${i + 1}/${chunks.length})\\n` : '') + c,\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7984,
        -6944
      ],
      "id": "a80c10af-e699-426a-8d22-5ab8b18ec6b0",
      "name": "Formatear Respuesta Estado Proyecto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        8208,
        -6944
      ],
      "id": "6eb14463-3ea6-451e-b980-fb9de404f854",
      "name": "Telegram Enviar Estado Proyecto",
      "webhookId": "2b222222-2222-4222-8222-222222222222"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5872,
        -6752
      ],
      "id": "a6100783-fb8b-4fca-b373-6d18640c59e4",
      "name": "HTTP Buscar Proyecto1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "05637c0d-ea70-4f42-84d5-93370d8d8f11",
              "leftValue": "={{ $json.listar_por_etapa === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5392,
        -6752
      ],
      "id": "bf615fa4-2eb2-4237-a0a0-987f847a86bf",
      "name": "¿Listar por etapa?"
    },
    {
      "parameters": {
        "jsCode": "// Lee las tareas por etapa y devuelve los proyectos que caen en esa etapa.\n// No toca stage_id de project.project (evita AccessError).\nconst uid = $('Autenticar Odoo').item.json.result;\nconst db  = 'mchecagoshawk-webinar-main-28403608';\n\nconst labels = ($json.filtro_etapa && $json.filtro_etapa.labels) || [];\nif (!labels.length) throw new Error('No pude identificar la etapa solicitada');\n\nconst parts = labels.map(l => ['stage_id.name','ilike', l]);\n// OR en dominio: N-1 pipes\nconst domain = parts.length === 1 ? parts\n  : [ ...Array(parts.length - 1).fill('|'), ...parts ];\n\n// Opcionalmente filtra activos\n// domain.push(['active','=',true]);\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'project.task', 'read_group',\n      [ domain, ['id:count'], ['project_id','stage_id'] ],\n      { lazy: false }\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn { payload, filtro_etapa: $json.filtro_etapa, chat_id: $json.chat_id };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5648,
        -7200
      ],
      "id": "ecdc496e-ea0e-4f61-9153-dec28b20c202",
      "name": "Preparar Buscar Proyectos por Etapa"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5840,
        -7200
      ],
      "id": "02526f39-8b11-4ec6-9f51-c2567ac9fe14",
      "name": "HTTP Buscar Proyectos por Etapa"
    },
    {
      "parameters": {
        "jsCode": "const clean = s => String(s ?? '').replace(/`/g,\"'\");\nconst baseUrl = 'https://lsanchezgoshawk-azordatatest.odoo.com';\n\nconst rows = ($json.body?.result) || $json.result || [];\nconst stage_by_project =\n  $json.stage_by_project ||\n  ($items('Preparar Buscar Proyectos por ID')[0]?.json?.stage_by_project) ||\n  {};\n\nconst etapaTxt = ($json.filtro_etapa?.labels?.[0]) ||\n                 ($items('Preparar Buscar Proyectos por ID')[0]?.json?.filtro_etapa?.labels?.[0]) ||\n                 'Etapa';\n\nconst iconByStage = (s) => {\n  s = String(s||'').toLowerCase();\n  if (s.includes('done') || s.includes('hecho') || s.includes('finaliz')) return '✅';\n  if (s.includes('progress') || s.includes('progreso') || s.includes('proceso') || s.includes('curso')) return '🚧';\n  if (s.includes('cancel')) return '🚫';\n  return '🆕';\n};\n\nlet texto = `🗂️ *Proyectos en:* \\`${clean(etapaTxt)}\\`\\n`;\ntexto += `Total: \\`${rows.length}\\`\\n\\n`;\n\nconst MAX = 50;\nconst list = [];\nfor (const p of rows.slice(0, MAX)) {\n  const stageName = stage_by_project[p.id] || '';\n  const icon = iconByStage(stageName);\n  const link = p.id ? `🔗 [Abrir](${baseUrl}/web#id=${p.id}&model=project.project&view_type=form)` : '';\n  list.push(\n    `${icon} *\\`${clean(p.name)}\\`* — \\`${clean(stageName||'—')}\\`\\n` +\n    `   👤 \\`${p.partner_id ? p.partner_id[1] : '—'}\\` · 👨‍💼 \\`${p.user_id ? p.user_id[1] : '—'}\\`${link ? `\\n   ${link}`: ''}`\n  );\n}\ntexto += list.join('\\n\\n');\nif (rows.length > MAX) texto += `\\n\\n… \\`${rows.length - MAX}\\` más`;\n\nconst chat_id = $json.chat_id || ($items('Preparar Buscar Proyectos por Etapa')[0]?.json?.chat_id) || 0;\nreturn { chat_id, texto };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6416,
        -7200
      ],
      "id": "1615aa24-4563-49d1-af8e-da191b01a4a6",
      "name": "Formatear Lista Proyectos por Etapa"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6640,
        -7200
      ],
      "id": "08985798-5d85-412b-9683-7c98156b0173",
      "name": "Enviar Lista Proyectos por Etapa",
      "webhookId": "2b222222-2222-4222-8222-222222222222"
    },
    {
      "parameters": {
        "jsCode": "// Toma el resultado del read_group, extrae IDs de proyecto y arma un search_read seguro\nconst uid = $('Autenticar Odoo').item.json.result;\nconst db  = 'mchecagoshawk-webinar-main-28403608';\n\nconst groups = ($json.body?.result) || $json.result || [];\nconst projectIds = [];\nconst stageByProject = {};\n\nfor (const g of groups) {\n  const pid = Array.isArray(g.project_id) ? g.project_id[0] : g.project_id;\n  const sName = Array.isArray(g.stage_id) ? g.stage_id[1] : g.stage_id;\n  if (Number.isInteger(pid)) {\n    projectIds.push(pid);\n    // guardamos la etapa “que ha hecho match” (leeremos 1)\n    if (!stageByProject[pid]) stageByProject[pid] = sName || '';\n  }\n}\n\nconst ids = Array.from(new Set(projectIds));\nif (!ids.length) {\n  return { chat_id: $json.chat_id, stage_by_project: stageByProject, empty: true };\n}\n\nconst fields = ['id','name','partner_id','user_id','date_start','date','company_id']; // SIN stage_id\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'project.project', 'search_read',\n      [ [ ['id','in', ids] ], fields ]\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn {\n  payload,\n  chat_id: $json.chat_id,\n  stage_by_project: stageByProject,\n  filtro_etapa: $json.filtro_etapa\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6048,
        -7200
      ],
      "id": "1438044e-66d8-47fd-aa68-5849c2234f27",
      "name": "Preparar Buscar Proyectos por ID"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6240,
        -7200
      ],
      "id": "faab4148-2735-4fe0-845e-be2a0552136d",
      "name": "HTTP Buscar Proyectos por ID"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.verificacion_usuario.query }}",
        "options": {
          "queryReplacement": "={{ $json.verificacion_usuario.params }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1904,
        -9104
      ],
      "id": "64975854-bda3-4246-86a4-5b11702a9ec0",
      "name": "Execute a SQL query"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10400,
        -9648
      ],
      "id": "3204bd83-d4a3-49dd-a8ff-bfeff6d6452f",
      "name": "HTTP Registrar Nota Materiales"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        12704,
        -9936
      ],
      "id": "cabb0d14-b55b-4beb-a3be-a30944bccf78",
      "name": "Confirmar Todo",
      "webhookId": "1dadcc74-c513-44a1-88b9-c7aa71c7ec47"
    },
    {
      "parameters": {
        "jsCode": "// Buscar Almacén (robusto) - NO usa $('...'), usa $items()\n\nconst firstJson = (nodeName) => {\n  try { return $items(nodeName, 0)?.[0]?.json ?? {}; }\n  catch { return {}; }\n};\n\n// En tu rama el nodo se llama \"Validar Productos1\"\nconst base = firstJson('Validar Productos1');\n\n// Fallbacks si en algún caso no pasa por Validar Productos1\nconst prep = firstJson('Preparar Búsqueda Productos');\nconst regWrap = firstJson('Registrar Horas Directo FSM');\nconst reg = regWrap.registro || regWrap || {};\n\nconst db =\n  base.db ||\n  prep.db ||\n  reg.db ||\n  'mchecagoshawk-webinar-main-28403608';\n\nconst uidRaw =\n  base.uid ||\n  prep.uid ||\n  reg.uid ||\n  2;\n\nconst uid = Number(uidRaw);\nif (!Number.isFinite(uid) || uid <= 0) {\n  throw new Error(`UID inválido: ${uidRaw}`);\n}\n\n// warehouse_hint opcional\nconst hintRaw =\n  base.warehouse_hint ||\n  prep.warehouse_hint ||\n  'principal';\n\nconst hint = String(hintRaw).toLowerCase().trim();\n\n// Dominio warehouse\nlet domainWH;\nif (hint === 'principal') {\n  domainWH = ['|', ['code', '=', 'WH'], ['name', 'ilike', 'Principal']];\n} else if (hint === 'secundario') {\n  domainWH = ['|', ['code', '=', 'WH2'], ['name', 'ilike', 'Secundario']];\n} else {\n  domainWH = [['code', '=', 'WH']];\n}\n\n// ✅ Odoo domain: NO metas [[domainWH].flat()] si domainWH ya es domain válido\n// Debe ser: [domainWH]  (un array que contiene el domain)\nconst payloadWH = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'stock.warehouse', 'search_read',\n      [domainWH],\n      { fields: ['id','name','code','company_id','lot_stock_id','out_type_id'], limit: 1 }\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn { payloadWH, db, uid, warehouse_hint: hint };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10560,
        -9648
      ],
      "id": "f19e198b-b732-4235-8638-58cdd90be895",
      "name": "Buscar Almacén"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payloadWH }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10736,
        -9648
      ],
      "id": "11de7542-7feb-46f5-b316-173ed2aa1b71",
      "name": "HTTP Buscar Warehouse"
    },
    {
      "parameters": {
        "jsCode": "// Resolver Ubicaciones WH (usar contexto del nodo \"HTTP Buscar Warehouse\")\nconst httpWH = $json;\nconst list = httpWH.json?.result || httpWH.result || httpWH.body?.result || [];\nconst wh = Array.isArray(list) && list[0] ? list[0] : null;\nif (!wh) throw new Error('No se encontró warehouse');\n\n// ← contexto original con db/uid viene de \"Buscar Almacén\"\nconst ctx = $items('Buscar Almacén', 0)[0]?.json || {};\nconst db  = String(ctx.db || 'mchecagoshawk-webinar-main-28403608');\nconst uid = Number(ctx.uid);\n\nconst company_id   = Array.isArray(wh.company_id)   ? wh.company_id[0]   : wh.company_id;\nconst lot_stock_id = Array.isArray(wh.lot_stock_id) ? wh.lot_stock_id[0] : wh.lot_stock_id;\nconst out_type_id  = Array.isArray(wh.out_type_id)  ? wh.out_type_id[0]  : wh.out_type_id;\n\n// Buscar ubicación de Clientes (usage = customer)\nconst payloadCustomerLoc = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'stock.location', 'search_read',\n      [[\n        ['usage', '=', 'customer'],\n        '|',\n        ['company_id', '=', false],\n        ['company_id', '=', company_id],\n      ]],\n      { fields: ['id','complete_name'], limit: 1 }\n    ],\n  },\n  id: Math.floor(Math.random()*1e6),\n};\n\nreturn {\n  db,\n  uid,\n  company_id,\n  location_id: lot_stock_id,       // origen: almacén\n  picking_type_id: out_type_id,    // tipo de picking de entrega\n  payloadCustomerLoc,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10928,
        -9648
      ],
      "id": "5a0dee1c-2da4-4aa2-a507-6267809c124a",
      "name": "Resolver Ubicaciones WH"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payloadCustomerLoc }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        11104,
        -9648
      ],
      "id": "66d07a24-5dd2-4aa5-9d51-ad181875c292",
      "name": "HTTP Buscar Ubicación Scrap"
    },
    {
      "parameters": {
        "jsCode": "// Fijar IDs de Ubicaciones (origen almacén y destino Cliente)\nconst res = $json.json?.result || $json.result || $json.body?.result || [];\nconst customerLoc = Array.isArray(res) && res[0] ? res[0] : null;\nif (!customerLoc) throw new Error('No se encontró ubicación de Clientes');\n\n// Recupera el contexto del nodo \"Resolver Ubicaciones WH\"\nlet ctx = {};\ntry {\n  ctx = $items('Resolver Ubicaciones WH', 0)[0]?.json || {};\n} catch (e) {}\n\nconst db             = ctx.db ?? $json.db;\nconst uid            = Number(ctx.uid ?? $json.uid);\nconst company_id     = ctx.company_id ?? $json.company_id;\nconst location_id    = ctx.location_id ?? $json.location_id;\nconst picking_type_id = ctx.picking_type_id ?? $json.picking_type_id;\n\nif (!db || !Number.isFinite(uid)) {\n  return { error: true, motivo: 'sin db/uid en contexto', db, uid };\n}\n\nreturn {\n  db,\n  uid,\n  company_id,\n  location_id,                     // almacén (origen)\n  customer_location_id: customerLoc.id, // Clientes (destino)\n  picking_type_id,                 // tipo de entrega (outgoing)\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11312,
        -9648
      ],
      "id": "8ae63e30-bb41-4822-91d8-00024063ce40",
      "name": "Fijar IDs de Ubicaciones"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR ORDEN (ENTREGA / DESECHO) - robusto para tu rama\n\nconst firstJson = (nodeName) => {\n  try { return $items(nodeName, 0)?.[0]?.json ?? {}; }\n  catch { return {}; }\n};\n\n// En tu rama el nodo se llama \"Validar Productos1\"\nconst base = firstJson('Validar Productos1');\n\n// salida de \"Fijar IDs de Ubicaciones\" (o el nodo anterior que te pase locs)\nconst locs = $json || {};\n\n// Productos validados\nconst productosValidados = Array.isArray(base.productos_validados)\n  ? base.productos_validados\n  : [];\n\nif (!productosValidados.length) {\n  return {\n    skip_entrega: true,\n    chat_id: base.chat_id || locs.chat_id || null,\n    total_productos: 0,\n    motivo: 'No hay productos_validados',\n  };\n}\n\n/**\n * ✅ 1) partner_id desde tu rama REAL: nodo \"Extraer partner_id\"\n * Ese nodo ya devuelve partner_id Number(...)\n */\nlet partner_id = null;\nlet partner_name = null;\n\ntry {\n  const partnerCtx = firstJson('Extraer partner_id');\n  partner_id = Number(partnerCtx.partner_id || null);\n  partner_name = partnerCtx.partner_name || null;\n} catch (e) {}\n\n/**\n * ✅ 2) FALLBACKS (por si en algún caso no pasa por Extraer partner_id)\n */\nif (!partner_id || !Number.isFinite(partner_id) || partner_id <= 0) {\n  const fromLocs = Number(locs.partner_id || null);\n  const fromBase = Number(base.partner_id || base.cliente_id || base.customer_id || null);\n\n  if (Number.isFinite(fromLocs) && fromLocs > 0) partner_id = fromLocs;\n  else if (Number.isFinite(fromBase) && fromBase > 0) partner_id = fromBase;\n}\n\nif (!partner_id || !Number.isFinite(partner_id) || partner_id <= 0) {\n  return {\n    error: true,\n    motivo: 'Falta partner_id del cliente para crear la entrega (no viene de Extraer partner_id)',\n    chat_id: base.chat_id || locs.chat_id || null,\n    debug: {\n      extraer_partner_id: firstJson('Extraer partner_id'),\n      locs_partner_id: locs.partner_id ?? null,\n      base_partner_id: base.partner_id ?? null,\n    }\n  };\n}\n\n// Líneas de entrega/desecho (normalizamos cantidades y uom)\nconst lineas_entrega = productosValidados.map((p) => ({\n  product_id: Number(p.product_id),\n  product_name: p.product_name || p.name || null,\n  qty: Number(p.quantity ?? p.qty ?? 1),\n  uom_id: Array.isArray(p.uom_id) ? p.uom_id[0] : (p.uom_id || p.product_uom || null),\n}));\n\nreturn {\n  lineas_entrega,\n  productos_validados: productosValidados,\n  skip_entrega: false,\n  chat_id: base.chat_id || locs.chat_id || null,\n\n  db: locs.db || base.db,\n  uid: Number(locs.uid || base.uid || 2),\n\n  company_id: locs.company_id,\n  location_id: locs.location_id,                   // origen almacén\n  customer_location_id: locs.customer_location_id, // destino clientes\n  picking_type_id: locs.picking_type_id,\n\n  partner_id,\n  partner_name,\n  total_productos: productosValidados.length,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11616,
        -9808
      ],
      "id": "c35ac264-8253-4a0e-9a96-31f081724b4e",
      "name": "Preparar Orden Desecho"
    },
    {
      "parameters": {
        "jsCode": "const d = $json;\n\nif (\n  d.skip_entrega ||\n  !Array.isArray(d.lineas_entrega) || !d.lineas_entrega.length ||\n  !d.db || !Number.isFinite(Number(d.uid)) ||\n  !d.location_id || !d.customer_location_id ||\n  !d.picking_type_id || !d.partner_id\n) {\n  return [{\n    json: {\n      error: true,\n      motivo: 'Faltan datos para crear la entrega',\n      db: d.db,\n      uid: d.uid,\n      location_id: d.location_id,\n      customer_location_id: d.customer_location_id,\n      picking_type_id: d.picking_type_id,\n      partner_id: d.partner_id,\n    },\n  }];\n}\n\nconst items = [];\nconst fecha = new Date().toISOString().split('T')[0]; // fecha sin hora\n\nfor (const l of d.lineas_entrega) {\n  if (!l.product_id || !l.qty) continue;\n\n  const move = {\n    name: l.product_name || 'Material',\n    product_id: l.product_id,\n    product_uom_qty: l.qty,\n    location_id: d.location_id,\n    location_dest_id: d.customer_location_id,\n  };\n\n  if (l.uom_id) {\n    move.product_uom = Array.isArray(l.uom_id) ? l.uom_id[0] : l.uom_id;\n  }\n\n  const payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        d.db,\n        Number(d.uid),\n        'admin',\n        'stock.picking', 'create',\n        [[{\n          picking_type_id: d.picking_type_id,\n          partner_id: d.partner_id,\n          location_id: d.location_id,               // origen almacén\n          location_dest_id: d.customer_location_id, // destino clientes\n          scheduled_date: fecha,\n          origin: `Parte FSM - ${fecha}`,\n          move_ids_without_package: [[0, 0, move]],\n        }]],\n        { context: { allowed_company_ids: d.company_id ? [d.company_id] : [] } },\n      ],\n    },\n    id: Math.floor(Math.random()*1e6),\n  };\n\n  items.push({\n    json: {\n      payload,\n      db: d.db,\n      uid: d.uid,\n      chat_id: d.chat_id,\n      total_productos: d.total_productos,\n    },\n  });\n}\n\nreturn items;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11872,
        -9808
      ],
      "id": "0f10adff-37eb-4d5e-a861-e7455008bf29",
      "name": "Crear Órdenes de Desecho"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12384,
        -9744
      ],
      "id": "f51504b5-eead-4609-aa64-8dcda9680149",
      "name": "HTTP Crear Desecho"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        12112,
        -9808
      ],
      "id": "971e0e63-8fc6-49d8-944b-22851cd94fa9",
      "name": "Loop Over Items para Desecho"
    },
    {
      "parameters": {
        "jsCode": "// ✅ Formatear Confirmación Desecho (robusto si algunos nodos no se ejecutaron)\n\nconst safeItems = (nodeName) => {\n  try {\n    return $items(nodeName, 0) || [];\n  } catch (e) {\n    return [];\n  }\n};\n\nconst safeFirstJson = (nodeName) => {\n  const it = safeItems(nodeName);\n  return it?.[0]?.json ?? null;\n};\n\nconst regNode = safeFirstJson('Registrar Horas Directo FSM') || {};\nconst reg = regNode?.registro || regNode || {};\n\n// Intentar sacar horasId desde HTTP Registrar Horas (si existe) y si no, desde cualquier sitio disponible\nconst httpHoras = safeFirstJson('HTTP Registrar Horas Directo FSM') || {};\nlet horasId =\n  httpHoras?.result ??\n  httpHoras?.body?.result ??\n  httpHoras?.json?.result ??\n  null;\n\nif (Array.isArray(horasId)) horasId = horasId[0];\nif (horasId !== null && horasId !== undefined) horasId = Number(horasId);\nif (!Number.isFinite(horasId) || horasId <= 0) horasId = null;\n\n// Fallback extra: si en tu flujo guardas timesheet_line_id en registro/memoria\nif (!horasId) {\n  const memRow = safeFirstJson('Preparar Datos AI Agent') || {};\n  const pendientes = (() => {\n    const v = memRow?.datos_pendientes;\n    if (!v) return {};\n    if (typeof v === 'object') return v;\n    try { return JSON.parse(v); } catch { return {}; }\n  })();\n\n  const alt =\n    reg.timesheet_line_id ||\n    reg.timesheetLineId ||\n    pendientes.timesheet_line_id ||\n    pendientes.timesheetLineId ||\n    null;\n\n  const n = Number(alt);\n  if (Number.isFinite(n) && n > 0) horasId = n;\n}\n\n// total de entregas procesadas\nconst createdItems = safeItems('Crear Órdenes de Desecho');\nconst totalEntregas = createdItems.length;\n\n// chat_id\nconst chatFromEntregas = createdItems?.[0]?.json?.chat_id ?? null;\nconst chatId =\n  reg.chat_id ||\n  regNode.chat_id ||\n  chatFromEntregas ||\n  null;\n\n// mensaje\nlet texto = '✅ **¡Parte de horas registrado exitosamente!**\\n\\n';\ntexto += '📋 **Detalles del registro:**\\n';\ntexto += `• **Proyecto:** ${reg.proyecto || '-'}\\n`;\ntexto += `• **Tarea:** ${reg.tarea || '-'}\\n`;\ntexto += `• **Horas:** ${reg.horas ?? '-'}\\n`;\ntexto += `• **Descripción:** ${reg.descripcion || '-'}\\n`;\ntexto += `• **Fecha:** ${new Date().toLocaleDateString('es-ES')}\\n`;\n\nif (horasId) {\n  texto += `• **ID del registro:** ${horasId}\\n`;\n  texto += `🔗 **Registro de horas:** [Abrir en Odoo](https://mchecagoshawk-webinar.odoo.com/web#id=${horasId}&model=account.analytic.line&view_type=form)\\n`;\n}\n\ntexto += `\\n📦 **Entregas de material creadas:** ${totalEntregas}\\n`;\ntexto += '🎉 **¡Listo!** 😊\\n';\n\nif (horasId) {\n  texto += `\\n**Para firmar el parte de trabajo pulsa en el siguiente enlace:**\\n[Firma aquí](https://mchecagoshawk-webinar.odoo.com/firma-parte/${horasId})`;\n}\n\nreturn { chat_id: chatId, texto };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12496,
        -9936
      ],
      "id": "f30b5a11-6b27-45f9-89d0-f15aae580219",
      "name": "Formatear Confirmación Desecho"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Validación Entrega (stock.picking.button_validate)\n\nconst httpCreateNode = 'HTTP Crear Desecho'; // mismo nombre de nodo HTTP\n\n// Intentar extraer la respuesta exactamente del nodo HTTP Crear Desecho (mismo itemIndex)\nconst createResp = $items(httpCreateNode, 0)[$itemIndex]?.json ?? null;\n\nlet pickingId = null;\nif (createResp) {\n  // respuesta típica: { result: id } o { body: { result: id } }\n  const candidate = createResp.result ?? createResp.body?.result ?? createResp.json?.result ?? createResp;\n  if (candidate !== null && candidate !== undefined) {\n    if (Array.isArray(candidate) && candidate.length) pickingId = Number(candidate[0]);\n    else if (typeof candidate === 'number' || (typeof candidate === 'string' && /^\\d+$/.test(candidate))) pickingId = Number(candidate);\n    else if (typeof candidate === 'object' && typeof candidate.id !== 'undefined') pickingId = Number(candidate.id);\n  }\n}\n\n// Fallback con el propio $json\nif (!Number.isFinite(pickingId)) {\n  const res = $json.json?.result ?? $json.result ?? $json.body?.result ?? null;\n  if (res !== null && res !== undefined) {\n    if (Array.isArray(res) && res.length) pickingId = Number(res[0]);\n    else if (typeof res === 'number' || (typeof res === 'string' && /^\\d+$/.test(res))) pickingId = Number(res);\n    else if (typeof res === 'object' && typeof res.id !== 'undefined') pickingId = Number(res.id);\n  }\n}\n\nif (!Number.isFinite(pickingId)) {\n  return [{\n    json: {\n      error: true,\n      motivo: 'No se pudo determinar pickingId desde HTTP Crear Entrega',\n      createRespSnapshot: createResp ?? null,\n      currentJson: $json,\n    },\n  }];\n}\n\n// Obtener db/uid desde el item generado por Crear Órdenes de Desecho o desde HTTP create\nconst originItem =\n  $items('Crear Órdenes de Desecho', 0)[$itemIndex]?.json ||\n  $items(httpCreateNode, 0)[$itemIndex]?.json ||\n  $json ||\n  {};\n\nconst db = originItem.db ?? originItem.json?.db ?? $json.db ?? null;\nconst uidCandidate = originItem.uid ?? originItem.json?.uid ?? $json.uid ?? null;\nconst uid = Number(uidCandidate);\n\nif (!db || !Number.isFinite(uid)) {\n  return [{\n    json: {\n      error: true,\n      motivo: 'Faltan db/uid para validar',\n      db,\n      uid,\n      pickingId,\n    },\n  }];\n}\n\n// Construir payload para button_validate\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'stock.picking',\n      'button_validate',\n      [[ Number(pickingId) ]], // lista de ids\n    ],\n  },\n  id: Math.floor(Math.random()*1e6),\n};\n\nreturn [{\n  json: { payload, db, uid, picking_id: pickingId },\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        13008,
        -9744
      ],
      "id": "fc4fb746-051d-411b-800f-df1e6eac77d5",
      "name": "Preparar Validación Scrap"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        13232,
        -9744
      ],
      "id": "0f34b201-b6d8-4233-8279-4d9ebc05ad2f",
      "name": "HTTP Validar Scrap",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Preparar Message Post Entrega - construir payload para message_post (args y kwargs separados)\nconst res = $json.json?.result ?? $json.result ?? $json.body?.result;\nconst pickingId = Array.isArray(res) ? res[0] : res;\n\nconst prev = $items('Crear Órdenes de Desecho', 0)[$itemIndex] || {};\nconst db  = prev.json?.db || prev.db || $json.db;\nconst uid = Number(prev.json?.uid ?? prev.uid ?? $json.uid);\n\n// obtener partner_id si está disponible (buscar en Buscar Usuario Odoo o en seed)\nlet partnerId = null;\ntry {\n  const respUsuario = $('Buscar Usuario Odoo')?.first()?.json;\n  if (respUsuario) {\n    const listaUsuarios = respUsuario.result || respUsuario;\n    const usuario = Array.isArray(listaUsuarios) && listaUsuarios.length > 0 ? listaUsuarios[0] : null;\n    if (usuario && Array.isArray(usuario.partner_id) && usuario.partner_id.length > 0) {\n      partnerId = usuario.partner_id[0];\n    }\n  }\n} catch (e) {\n  console.log('No se pudo leer Buscar Usuario Odoo:', e.message);\n}\n\nconst usuarioNombre = prev.json?.usuarioNombre ?? prev.usuarioNombre ?? null;\n\nif (!pickingId || !db || !Number.isFinite(uid)) {\n  return [{\n    json: {\n      skip_post: true,\n      motivo: 'Faltan pickingId/db/uid',\n      pickingId,\n      db,\n      uid,\n    },\n  }];\n}\n\nconst bodyText = usuarioNombre\n  ? `Entrega registrada por: ${usuarioNombre}`\n  : 'Entrega registrada';\n\nconst kwargs = {\n  body: bodyText,\n  message_type: 'comment',\n  subtype_xmlid: 'mail.mt_note',\n};\nif (partnerId) kwargs.author_id = partnerId;\n\n// args: list of ids as positional arg; kwargs separate\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'stock.picking',\n      'message_post',\n      [[ Number(pickingId) ]], // positional args\n      kwargs,                  // kwargs dict\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn [{\n  json: { payload, db, uid, pickingId, partnerId, usuarioNombre },\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12592,
        -9744
      ],
      "id": "c6aa8f71-3474-46cc-b04a-4d817dae46f1",
      "name": "Preparar Message Post Desecho"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        12800,
        -9744
      ],
      "id": "4f707341-187f-4715-9c66-6e68d9608f6b",
      "name": "HTTP Postear Autor Desecho"
    },
    {
      "parameters": {
        "jsCode": "// CONSULTAR TAREAS DEL CALENDARIO PARA HOY\nconst x = $json;\nconst db = x.db || 'mchecagoshawk-webinar-main-28403608';\nconst uid = x.uid || 2;\nconst chatId = x.chat_id;\nconst clienteBuscado = (x.cliente || '').toLowerCase().trim();\nconst odooUserId = Number(x.odoo_user_id); // ID del usuario en Odoo (res.users)\n\n\nconsole.log('📅 CONSULTAR TAREAS CALENDARIO - Usuario:', uid, 'Cliente:', clienteBuscado);\n\n// Fecha de hoy (NO CAMBIO NADA)\nconst hoy = new Date();\nconst fechaHoy = hoy.toISOString().split('T')[0];\nconst mañana = new Date(hoy);\nmañana.setDate(mañana.getDate() + 1);\nconst fechaMañana = mañana.toISOString().split('T')[0];\n\n// Si tu campo es Datetime (lo normal en planning), Odoo suele esperar \"YYYY-MM-DD HH:MM:SS\".\n// No cambio tu fecha, solo le añado hora 00:00:00 para que encaje como Datetime.\nconst fechaHoyDT = `${fechaHoy} 00:00:00`;\nconst fechaMañanaDT = `${fechaMañana} 00:00:00`;\n\n// Dominio bien formado:\n// (planned_date_begin >= hoy AND planned_date_begin < mañana) AND (user_ids contiene uid OR create_uid = uid)\nconst domain = [\n  '&','&',\n    ['planned_date_begin', '>=', fechaHoyDT],\n    ['planned_date_begin', '<', fechaMañanaDT],\n    ['user_ids.login', '=', x.odoo_user],   // lau88@gmail.com\n    ['fsm_done', '!=', true]  // ✅ excluir tareas hechas\n];\n\n\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n  db, uid, 'admin',\n  'project.task',\n  'search_read',\n  [domain],\n  {\n    fields: ['id', 'name', 'project_id', 'user_ids', 'description', 'planned_date_begin', 'fsm_done'],\n    limit: 100\n  }\n  ]\n\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nconst transcripcion_original =\n  (x.transcripcion_original || x.mensaje_usuario_original || x.mensaje_original || '').toString();\n\nconst mensaje_usuario_original =\n  (x.mensaje_usuario_original || x.transcripcion_original || x.mensaje_original || '').toString();\n\nreturn {\n  payload,\n  db,\n  uid,\n  fecha_hoy: fechaHoy,\n  cliente_buscado: clienteBuscado,\n  horas_parte: x.horas || 0,\n  descripcion_parte: x.descripcion || '',\n  productos_parte: x.productos || [],\n  proyecto_sugerido: x.proyecto || 'Servicio de campo',\n  chat_id: chatId,\n\n  is_diagnosis_task: x.is_diagnosis_task || false,\n  ticket_type: x.ticket_type || '',\n  horas_presupuestadas: x.horas_presupuestadas || 0,\n\n  // ✅ NUEVO\n  transcripcion_original,\n  mensaje_usuario_original,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5600,
        -10256
      ],
      "id": "e053bdd5-5112-4b48-a008-288a7578d07f",
      "name": "Consultar Tareas Calendario Día"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.payload}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5792,
        -10256
      ],
      "id": "370cd68e-9f07-4b20-969c-527d2e7a91f3",
      "name": "HTTP Consultar Tareas Calendario"
    },
    {
      "parameters": {
        "jsCode": "// =============================\n// HELPERS\n// =============================\nconst normalizar = (s) =>\n  String(s || '')\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '') // quita acentos\n    .trim();\n\n// Convierte HTML a texto plano con viñetas\nconst productosAPlano = (html) => {\n  if (!html) return '• No especificados';\n\n  const txt = String(html)\n    .replace(/<\\/li>\\s*<li[^>]*>/gi, '\\n• ')\n    .replace(/<li[^>]*>/gi, '• ')\n    .replace(/<\\/li>/gi, '')\n    .replace(/<\\/?(ul|ol)[^>]*>/gi, '')\n    .replace(/<\\/?(strong|b|em|i|u|ins|s|strike|del|p|div|span|h1|h2|h3|h4|h5)[^>]*>/gi, '')\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<[^>]+>/g, '')\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&amp;/g, '&')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    .replace(/&quot;/g, '\"')\n    .replace(/&#39;/g, \"'\")\n    .replace(/[ \\t]+\\n/g, '\\n')\n    .replace(/\\n{3,}/g, '\\n\\n')\n    .trim();\n\n  return txt ? txt : '• No especificados';\n};\n\n// Extrae \"Cliente: X\" del HTML de description\nconst extraerClienteDeDescripcion = (html) => {\n  const m = String(html || '').match(/<strong>\\s*Cliente:\\s*<\\/strong>\\s*([^<]+)/i);\n  return m ? m[1].trim() : '';\n};\n\n// Extrae el <ul> de \"Productos/Servicios Solicitados\" y lo convierte a texto plano\nconst extraerProductosDeDescripcion = (html) => {\n  const m = String(html || '').match(/Productos\\/Servicios Solicitados<\\/h3>\\s*(<ul[\\s\\S]*?<\\/ul>)/i);\n  return m ? productosAPlano(m[1]) : '• No especificados';\n};\n\n// =============================\n// VALIDAR Y ELEGIR TAREA CORRECTA\n// =============================\nconst x = $json;\n\n// Por si el HTTP no trae el input original:\nconst normalizadoNode = $node[\"Normalizar Parte+Materiales FSM\"]?.json || {};\n\n// ✅ Flags / campos CRÍTICOS que deben viajar hasta registrar_tarea\nconst isDiagnosis =\n  x.is_diagnosis_task ?? normalizadoNode.is_diagnosis_task ?? false;\n\nconst ticketType =\n  x.ticket_type ?? normalizadoNode.ticket_type ?? '';\n\nconst horasPresup =\n  x.horas_presupuestadas ?? normalizadoNode.horas_presupuestadas ?? 0;\n\n// ✅ NUEVO: recuperar transcripción aunque el HTTP haya perdido el input\nconst transcripcionOriginal =\n  x.transcripcion_original ||\n  x.mensaje_usuario_original ||\n  x.mensaje_original ||\n  normalizadoNode.transcripcion_original ||\n  normalizadoNode.mensaje_usuario_original ||\n  normalizadoNode.mensaje_original ||\n  normalizadoNode.parte_en_memoria?.transcripcion_original ||\n  '';\n\nconst chatId = x.chat_id ?? normalizadoNode.chat_id;\n\n// Cliente con fallbacks\nconst clienteRaw =\n  x.cliente_buscado ??\n  x.cliente ??\n  normalizadoNode.cliente ??\n  normalizadoNode.parte_en_memoria?.cliente ??\n  '';\n\nconst clienteBuscado = normalizar(clienteRaw);\n\n// Parte (lo que viene del primer mensaje)\nconst horasParte = x.horas_parte ?? normalizadoNode.horas ?? 0;\nconst descripcionParte = x.descripcion_parte ?? normalizadoNode.descripcion ?? '';\nconst productosParte = x.productos_parte ?? normalizadoNode.productos ?? [];\n\nconsole.log('🔍 VALIDAR TAREA - Cliente raw:', clienteRaw);\nconsole.log('🔍 VALIDAR TAREA - Cliente buscado:', clienteBuscado);\nconsole.log('🧾 Flags parte:', { isDiagnosis, ticketType, horasPresup });\n\n// Obtener tareas del resultado HTTP (tus datos vienen como x.result)\nconst httpResult = x.result || x.body?.result || x.json?.result || x.data?.result || [];\nconst tareas = Array.isArray(httpResult) ? httpResult : [];\n\nconsole.log('📋 Tareas encontradas (sin filtrar):', tareas.length);\n\n// Obtener Km y tiempo de desplazamiento\nconst travelDistanceKm =\n  x.travel_distance_km ??\n  normalizadoNode.travel_distance_km ??\n  normalizadoNode.parte_en_memoria?.travel_distance_km ??\n  0;\n\nconst travelTimeHours =\n  x.travel_time_hours ??\n  normalizadoNode.travel_time_hours ??\n  normalizadoNode.parte_en_memoria?.travel_time_hours ??\n  0;\n\n\n// ✅ Construir datos_parte COMPLETO (esto es lo que debe sobrevivir al flujo)\nconst datosParteCompleto = {\n  horas: Number(horasParte) || 0,\n  descripcion: String(descripcionParte || ''),\n  productos: Array.isArray(productosParte) ? productosParte : [],\n\n  // ✅ CLAVE para diagnóstico/presupuesto\n  is_diagnosis_task: !!isDiagnosis,\n  ticket_type: ticketType,\n  horas_presupuestadas: Number(horasPresup) || 0,\n\n  travel_distance_km: Number(travelDistanceKm) || 0,\n  travel_time_hours: Number(travelTimeHours) || 0,\n\n  // ✅ auditoría / trazabilidad\n  transcripcion_original: transcripcionOriginal,\n  mensaje_usuario_original: transcripcionOriginal,\n};\n\nif (tareas.length === 0) {\n  return [{\n    json: {\n      accion: 'error_sin_tareas',\n      mensaje: '❌ No hay tareas en tu calendario para hoy.',\n      tareas_encontradas: 0,\n      chat_id: chatId,\n      cliente_buscado: clienteBuscado,\n\n      // ✅ IMPORTANTE: devolverlo completo\n      datos_parte: datosParteCompleto,\n    }\n  }];\n}\n\n// 1) Intentar filtrar por cliente (si tengo cliente)\nlet tareasFiltradas = tareas;\n\nif (clienteBuscado) {\n  tareasFiltradas = tareas.filter((t) => {\n    const name = normalizar(t.name || '');\n    const desc = String(t.description || '');\n    const clienteEnDesc = normalizar(extraerClienteDeDescripcion(desc));\n\n    // Match fuerte: cliente extraído del HTML\n    if (\n      clienteEnDesc &&\n      (clienteEnDesc === clienteBuscado ||\n        clienteEnDesc.includes(clienteBuscado) ||\n        clienteBuscado.includes(clienteEnDesc))\n    ) {\n      return true;\n    }\n\n    // Fallback: buscar el texto del cliente en name/desc\n    return name.includes(clienteBuscado) || normalizar(desc).includes(clienteBuscado);\n  });\n}\n\nconsole.log('✅ Tareas tras filtro por cliente:', tareasFiltradas.length);\n\n// Si NO hay coincidencia por cliente, NO damos error: mostramos todas para elegir\nconst tareasParaMostrar = (clienteBuscado && tareasFiltradas.length === 0) ? tareas : tareasFiltradas;\n\n// Detalles de tareas (con productos limpios y cliente extraído)\nconst tareasConDetalles = tareasParaMostrar.map((t) => {\n  const desc = String(t.description || '');\n  return {\n    id: t.id,\n    nombre_completo: t.name,\n    proyecto_id: t.project_id ? t.project_id[0] : null,\n    proyecto_nombre: t.project_id ? t.project_id[1] : '',\n    cliente_en_tarea: extraerClienteDeDescripcion(desc) || '',\n    productos: extraerProductosDeDescripcion(desc),\n  };\n});\n\n// Guardar en memoria global (si la usas todavía)\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\nmemoria.tareas_calendario_hoy = tareasConDetalles;\nmemoria.cliente_buscado = clienteBuscado;\nmemoria.parte_en_registro = datosParteCompleto;\nglobal[contextoKey] = memoria;\n\n// =============================\n// RESPUESTA\n// =============================\nlet respuesta;\n\nif (tareasConDetalles.length === 1) {\n  const tarea = tareasConDetalles[0];\n\n  const notaCliente = (clienteBuscado && tareasFiltradas.length === 0)\n    ? `\\nTienes 1 tarea hoy.`\n    : '';\n\n  respuesta = {\n    accion: 'tarea_unica',\n    tarea_id: tarea.id,\n    tarea_nombre: tarea.nombre_completo,\n    proyecto_id: tarea.proyecto_id,\n    proyecto_nombre: tarea.proyecto_nombre,\n    productos_tarea: tarea.productos,\n    mensaje: [\n      `✅ Encontré UNA tarea para hoy.${notaCliente}`,\n      `📌 ${tarea.nombre_completo}`,\n      `🏢 ${tarea.proyecto_nombre}`,\n      tarea.cliente_en_tarea ? `👤 Cliente: ${tarea.cliente_en_tarea}` : '',\n      `📦 ${tarea.productos}`,\n      '',\n      '¿Registro el parte aquí?'\n    ].filter(Boolean).join('\\n'),\n    tareas_encontradas: 1\n  };\n\n} else {\n  const notaCliente = (clienteBuscado && tareasFiltradas.length === 0)\n    ? `\\nTe muestro todas las tareas de hoy para que elijas:`\n    : '';\n\n  const lista = tareasConDetalles.map((t, i) =>\n    `\\n${i + 1}️⃣ ${t.nombre_completo}\\n   🏢 ${t.proyecto_nombre}` +\n    (t.cliente_en_tarea ? `\\n   👤 Cliente: ${t.cliente_en_tarea}` : '') +\n    `\\n   📦 ${t.productos}`\n  ).join('');\n\n  respuesta = {\n    accion: 'elegir_tarea_multiple',\n    tareas_opciones: tareasConDetalles,\n    mensaje: `🔀 Tareas para hoy:${notaCliente}${lista}\\n\\n✍️ Responde con el número (1, 2, 3...)`,\n    tareas_encontradas: tareasConDetalles.length\n  };\n}\n\nreturn [{\n  json: {\n    ...respuesta,\n    chat_id: chatId,\n    cliente_buscado: clienteBuscado,\n\n    // ✅ Top-level opcional (por si lo necesitas en nodos posteriores)\n    transcripcion_original: transcripcionOriginal,\n    mensaje_usuario_original: transcripcionOriginal,\n\n    // ✅ CLAVE: datos_parte completo para que registrar_tarea lo reciba\n    datos_parte: datosParteCompleto\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5984,
        -10256
      ],
      "id": "9f8dd926-36e3-47eb-9eca-6bf355afa869",
      "name": "Validar y Elegir Tarea"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.accion}}",
                    "rightValue": "tarea_unica",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "34bdf9db-f6c5-4324-a381-7f06bc9ee4af"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Confirmar Tarea Única"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f06d4030-217c-4465-a9be-8c5b98cd1d8d",
                    "leftValue": "={{$json.accion}}",
                    "rightValue": "elegir_tarea_multiple",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Solicitar Elegir Tarea"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a9219c8c-24ed-4a60-9f80-8b1aca16bc97",
                    "leftValue": "={{$json.accion}}",
                    "rightValue": "error_sin_tareas",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Notificar Error Sin Tareas"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        6176,
        -10256
      ],
      "id": "a475eb7f-d5f7-48d5-a1a3-5feb29318ad2",
      "name": "Switch Acciones Tarea"
    },
    {
      "parameters": {
        "chatId": "={{ $('Normalizar Parte+Materiales FSM').item.json.chat_id }}",
        "text": "={{ $('Validar y Elegir Tarea').item.json.mensaje }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6752,
        -10320
      ],
      "id": "c7996237-d098-46b0-9505-6d199a76d7f4",
      "name": "Confirmar Tarea Única",
      "webhookId": "f4c5cb88-d865-4c2a-af2c-01815d0ee28e"
    },
    {
      "parameters": {
        "chatId": "={{ $('Normalizar Parte+Materiales FSM').item.json.chat_id }}",
        "text": "={{ $('Validar y Elegir Tarea').item.json.mensaje }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6736,
        -10144
      ],
      "id": "daece14c-76b8-41a8-adcf-2ece691ea820",
      "name": "Solicitar Elegir Tarea",
      "webhookId": "d884db10-b7d9-46e3-a600-4f5bb2ee5550"
    },
    {
      "parameters": {
        "jsCode": "const chatId = $json.chat_id;\nconst tareasOpciones = $json.tareas_opciones || [];\nconst datosParteRaw = $json.datos_parte || {};\nconst normalizado = $node[\"Normalizar Parte+Materiales FSM\"]?.json || {};\n\nconst transcripcionOriginal =\n  $json.transcripcion_original ||\n  datosParteRaw.transcripcion_original ||\n  normalizado.transcripcion_original ||\n  normalizado.parte_en_memoria?.transcripcion_original ||\n  '';\n\nconst datosParte = {\n  ...datosParteRaw,\n  transcripcion_original: transcripcionOriginal,\n  mensaje_usuario_original: transcripcionOriginal,\n};\n\nconst datospendientes = {\n  modo: 'elegir_tarea_multiple',\n  tareas_opciones: tareasOpciones,\n  datos_parte: datosParte,                   // ✅ ya incluye transcripción\n  cliente_buscado: $json.cliente_buscado,\n  db: normalizado.db,\n  uid_admin: normalizado.uid || 2,\n  pass_admin: 'admin',\n  odoo_user: normalizado.odoo_user || '',\n  odoo_user_id: normalizado.odoo_user_id || null,\n};\n\nreturn {\n  chat_id: chatId,\n  user_id: $json.user_id || 0,\n  user_name: $json.user_name || 'Usuario',\n  esperando_confirmacion: 'elegir_tarea_multiple',\n  ultimo_mensaje_bot: $json.mensaje || '¿Cuál tarea deseas?',\n  datos_pendientes: JSON.stringify(datospendientes),\n\n  // ✅ opcional: por si quieres ver en tabla\n  mensaje_usuario: transcripcionOriginal,\n\n  historial: JSON.stringify([]),\n  historial_conversacion: JSON.stringify([]),\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6400,
        -10144
      ],
      "id": "42867cf2-6f2b-4e26-a4c7-7dbbc282e1c5",
      "name": "Guardar Memoria Elegir Tarea"
    },
    {
      "parameters": {
        "chatId": "={{ $('Normalizar Parte+Materiales FSM').item.json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6400,
        -9968
      ],
      "id": "fc62f62f-b28a-468c-aee6-ea81b1a6855e",
      "name": "Notificar Error Sin Tareas",
      "webhookId": "3a38d98a-2da3-4882-a747-88ac5f507468"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,\n  $json.user_id,\n  $json.user_name,\n  $json.esperando_confirmacion,\n  $json.ultimo_mensaje_bot,\n  $json.datos_pendientes,\n  $json.mensaje_usuario,\n  $json.historial,\n  $json.historial_conversacion\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        6576,
        -10144
      ],
      "id": "e495f106-c7c7-495e-b3b9-42ee1d48afcb",
      "name": "Guardar Memoria PostgreSQL Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Guardar memoria para confirmar tarea única\nconst chatId = $json.chat_id;\nconst normalizado = $node[\"Normalizar Parte+Materiales FSM\"]?.json || {};\n\nconst transcripcionOriginal =\n  $json.transcripcion_original ||\n  $json.datos_parte?.transcripcion_original ||\n  normalizado.transcripcion_original ||\n  normalizado.parte_en_memoria?.transcripcion_original ||\n  '';\n\nconst datosParte = {\n  ...($json.datos_parte || {}),\n  transcripcion_original: transcripcionOriginal,\n  mensaje_usuario_original: transcripcionOriginal,\n};\n\nconst pendientes = {\n  modo: 'confirmar_tarea_unica',\n  tarea_id: $json.tarea_id,\n  tarea_nombre: $json.tarea_nombre,\n  proyecto_id: $json.proyecto_id,\n  proyecto_nombre: $json.proyecto_nombre,\n  datos_parte: $json.datos_parte, // ✅ ya trae is_diagnosis_task/ticket_type/horas_presupuestadas\n  db: normalizado.db,\n  uid_admin: normalizado.uid || 2,\n  pass_admin: 'admin',\n  odoo_user: normalizado.odoo_user || '',\n  odoo_user_id: normalizado.odoo_user_id || null,\n};\n\nreturn [{\n  json: {\n    chat_id: chatId,\n    user_id: pendientes.odoo_user_id || 0,\n    user_name: pendientes.odoo_user || 'Usuario',\n    esperando_confirmacion: 'confirmar_tarea_unica',\n    ultimo_mensaje_bot: $json.mensaje || '¿Confirmas?',\n    datos_pendientes: JSON.stringify(pendientes),\n\n    // ✅ opcional: guardarlo también en campo plano\n    mensaje_usuario: transcripcionOriginal,\n\n    historial: JSON.stringify([]),\n    historial_conversacion: JSON.stringify([]),\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6400,
        -10320
      ],
      "id": "d724cebc-a7b7-4578-baa6-f8435aa5d3e4",
      "name": "Guardar Memoria Confirmar Única"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,\n  $json.user_id,\n  $json.user_name,\n  $json.esperando_confirmacion,\n  $json.ultimo_mensaje_bot,\n  $json.datos_pendientes,\n  $json.mensaje_usuario,\n  $json.historial,\n  $json.historial_conversacion\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        6576,
        -10320
      ],
      "id": "7f3c5a41-161e-43f6-8006-1f0ee364a4a8",
      "name": "Guardar Memoria PostgreSQL Tarea Unica"
    },
    {
      "parameters": {
        "jsCode": "// Limpiar & Resumen (robusto aunque falten nodos en esta rama)\n\nconst safeFirstJson = (nodeName) => {\n  try {\n    const arr = $items(nodeName, 0);\n    return arr && arr[0] ? arr[0].json : null;\n  } catch (e) {\n    return null; // nodo no ejecutado o no existe en esta rama\n  }\n};\n\nconst items = $input.all();\n\nconst httpHorasNode = safeFirstJson('HTTP Registrar Horas Directo FSM') || {};\nconst regNodeWrap   = safeFirstJson('Registrar Horas Directo FSM') || {};\nconst regNode       = regNodeWrap.registro || regNodeWrap || {};\nconst base          = safeFirstJson('Normalizar Parte+Materiales FSM') || {}; // puede no existir aquí\nconst extraerPartnerNode = safeFirstJson('Extraer Partner ID') || {};  // fallback para cuando se envían horas después\n\n// horas_id desde HTTP (fallbacks)\nlet horasId =\n  httpHorasNode.result ??\n  httpHorasNode.body?.result ??\n  httpHorasNode.json?.result ??\n  null;\n\nif (Array.isArray(horasId)) horasId = horasId[0];\nhorasId = horasId != null ? Number(horasId) : null;\n\nreturn items.map(({ json: ctx }) => {\n  // chat_id robusto: primero input actual, luego registro, luego base\n  const chatId =\n    ctx.chat_id ??\n    regNode.chat_id ??\n    base.chat_id ??\n    0;\n\n  const user_id =\n    ctx.user_id ??\n    ctx.odoo_user_id ??\n    regNode.odoo_user_id ??\n    base.odoo_user_id ??\n    null;\n\n  const user_name =\n    ctx.user_name ??\n    ctx.odoo_user ??\n    regNode.odoo_user ??\n    base.odoo_user ??\n    null;\n\n  return {\n    json: {\n      chat_id: chatId,\n      user_id,\n      user_name,\n      resumen_creado: {\n        proyecto: regNode.proyecto ?? ctx.proyecto ?? base.proyecto ?? extraerPartnerNode.result?.[0]?.project_id?.[1] ?? null,\n        proyecto_id: ctx.proyecto_id ?? regNode.project_id ?? extraerPartnerNode.project_id?.[0] ?? null,\n        tarea: regNode.tarea ?? ctx.tarea ?? base.tarea ?? extraerPartnerNode.result?.[0]?.name ?? null,\n        tarea_id: regNode.task_id ?? ctx.task_id ?? extraerPartnerNode.result?.[0]?.id ?? null,\n        horas: regNode.horas ?? ctx.horas ?? base.horas ?? 0,\n        horas_id: Number.isFinite(horasId) ? horasId : (ctx.horas_id ?? null),\n        descripcion: regNode.descripcion ?? ctx.descripcion ?? base.descripcion ?? null,\n        fecha: ctx.fecha_hoy ?? base.fecha_hoy ?? new Date().toISOString().split('T')[0],\n        db: regNode.db ?? ctx.db ?? base.db ?? null,\n        uid: regNode.uid ?? ctx.uid ?? base.uid ?? null,\n      }\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9840,
        -9376
      ],
      "id": "dd9a3dd0-eeb9-4453-9090-d05e2c14d625",
      "name": "Limpiar & Resumen"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n\nSET user_id = $2,\n    user_name = $3,\n    ultimo_horas_id = $4,\n    updated_at = NOW()\nWHERE chat_id = $1;",
        "options": {
          "queryReplacement": "={{ [$json.chat_id || $json.resumen_creado?.chat_id, $json.user_id, $json.user_name, $json.resumen_creado.horas_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        10032,
        -9376
      ],
      "id": "c5218730-b219-4103-a368-3682ee9b1b22",
      "name": "Guardar Último Horas ID"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n\nSET\n  esperando_confirmacion = NULL,\n  ultimo_mensaje_bot     = NULL,\n  datos_pendientes       = NULL,\n  updated_at             = NOW()\nWHERE chat_id::text = $1;",
        "options": {
          "queryReplacement": "={{ [ String($items('Limpiar & Resumen', 0)[0].json.chat_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10224,
        -9376
      ],
      "id": "bf5a25b0-7937-4b7f-9db4-9a81b671abc8",
      "name": "Limpiar Memoria"
    },
    {
      "parameters": {
        "chatId": "={{ $('Limpiar & Resumen').item.json.chat_id }} ",
        "text": "=✅ ¡Parte de horas registrado exitosamente!\n\n📋 Detalles del registro:\n• Proyecto: {{ $('Limpiar & Resumen').item.json.resumen_creado.proyecto }} \n• Tarea: {{ $('Limpiar & Resumen').item.json.resumen_creado.tarea }} \n• Horas: {{ $('Limpiar & Resumen').item.json.resumen_creado.horas}} \n• Descripción: {{ $('Limpiar & Resumen').item.json.resumen_creado.descripcion}} \n• Fecha: {{ $('Limpiar & Resumen').item.json.resumen_creado.fecha }} \n• ID del registro: {{ $('Limpiar & Resumen').item.json.resumen_creado.horas_id }} \n{{ $json.imagen_adjuntada ? '\\n📸 **Imagen adjuntada correctamente al parte de trabajo**' : '' }}\n🔗 Registro de horas: [Abrir en Odoo](https://mchecagoshawk-webinar.odoo.com/web#id={{ $('Limpiar & Resumen').item.json.resumen_creado.horas_id }}&model=account.analytic.line&view_type=form)\n\n🎉 ¡Listo! 😊\n\nPara firmar el parte de trabajo pulsa en el siguiente enlace:\n[Firma aquí](https://mchecagoshawk-webinar.odoo.com/firma-parte/{{ $('Limpiar & Resumen').item.json.resumen_creado.horas_id }})\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        10416,
        -9376
      ],
      "id": "e8e44a30-b18f-4938-af14-1f383ef94088",
      "name": "Confirmar",
      "webhookId": "e99a7f75-c964-40eb-be55-943594a16829"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "58855599-ad78-4b26-8ced-c034f3bcfb99",
              "leftValue": "={{$json.necesita_resolver_productos === true}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        8976,
        -9488
      ],
      "id": "ddd5d0a4-a870-4d66-bed5-3160d28c02cb",
      "name": "¿Hay Materiales?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.payload_buscar_productos}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        9312,
        -9616
      ],
      "id": "186cc3a7-dfc5-42dd-bd98-ebf53fe433ce",
      "name": "Buscar Productos"
    },
    {
      "parameters": {
        "jsCode": "// ✅ PREPARAR BÚSQUEDA PRODUCTOS FSM (RAMA: Registrar Horas Directo FSM)\n// ✅ FIX: coger productos_sin_id cuando vienen desde \"Registrar Materiales\"\n\nconst safeFirstJson = (name) => {\n  try { return $items(name, 0)?.[0]?.json ?? null; } catch { return null; }\n};\n\nconst regWrap = safeFirstJson('Registrar Horas Directo FSM') || {};\nconst reg = regWrap.registro || regWrap || {};\n\nconst httpHoras = safeFirstJson('HTTP Registrar Horas Directo FSM') || {};\nlet timesheet_line_id =\n  httpHoras.result ??\n  httpHoras.body?.result ??\n  httpHoras.json?.result ??\n  null;\n\nif (Array.isArray(timesheet_line_id)) timesheet_line_id = timesheet_line_id[0];\ntimesheet_line_id = Number(timesheet_line_id);\n\n// ✅ Origen fiable: Postgres (Preparar Datos AI Agent)\nconst memRow = safeFirstJson('Preparar Datos AI Agent') || {};\n\n// ✅ chat_id real: prioridad memRow -> input -> reg\nconst chat_id =\n  memRow.chat_id ??\n  memRow.user_id ??\n  $json.chat_id ??\n  reg.chat_id ??\n  null;\n\n// ✅ db/uid: si vienen en input, priorízalos\nconst db = $json.db || reg.db || memRow.db || 'mchecagoshawk-webinar-main-28403608';\nconst uid = Number($json.uid || reg.uid || memRow.uid || 2);\nconst PASS = 'admin';\n\n// ----------------------------------------------------\n// ✅ 1) PRIORIDAD: si vienes de \"Registrar Materiales\"\n// ----------------------------------------------------\nif ($json.necesita_resolver_productos === true && $json.payload_buscar_productos) {\n  const productos_solicitados = (Array.isArray($json.productos_sin_id) ? $json.productos_sin_id : [])\n    .map(p => ({\n      nombre: String(p?.nombre || '').trim(),\n      cantidad: Number(p?.cantidad || 1),\n    }))\n    .filter(p => p.nombre)\n    .map(p => ({ nombre: p.nombre, cantidad: Number.isFinite(p.cantidad) && p.cantidad > 0 ? p.cantidad : 1 }));\n\n  // Si no hay nada que resolver, salimos\n  if (productos_solicitados.length === 0) {\n    return {\n      necesita_resolver_productos: false,\n      motivo: 'Todos los productos ya tienen product_id o no hay productos',\n      productos_solicitados: [],\n      ...reg,\n      timesheet_line_id,\n      db,\n      uid,\n      chat_id,\n    };\n  }\n\n  // ✅ Reutiliza el payload ya calculado\n  return {\n    necesita_resolver_productos: true,\n    motivo: $json.motivo || 'Passthrough desde Registrar Materiales',\n    productos_solicitados,\n    payload_buscar_productos: $json.payload_buscar_productos,\n    timesheet_line_id,\n    db,\n    uid,\n    ...reg,\n    chat_id, // ✅ al final\n  };\n}\n\n// ----------------------------------------------------\n// ✅ 2) Rama normal: usar reg.productos (como antes)\n// ----------------------------------------------------\nconst productosRaw = Array.isArray(reg.productos) ? reg.productos : [];\n\n// Solo los que NO tienen product_id válido\nconst productos_solicitados = productosRaw\n  .map(p => ({\n    nombre: (p.nombre || p.product_name || '').toString().trim(),\n    cantidad: Number(p.cantidad || p.quantity || 1),\n    product_id: p.product_id,\n  }))\n  .filter(p => p.nombre && (!p.product_id || p.product_id === false || Number(p.product_id) <= 0))\n  .map(p => ({ nombre: p.nombre, cantidad: Number.isFinite(p.cantidad) && p.cantidad > 0 ? p.cantidad : 1 }));\n\n// Si no hay nada que resolver, salimos\nif (productos_solicitados.length === 0) {\n  return {\n    necesita_resolver_productos: false,\n    motivo: 'Todos los productos ya tienen product_id o no hay productos',\n    productos_solicitados: [],\n    ...reg,\n    timesheet_line_id,\n    db,\n    uid,\n    chat_id, // ✅ fijado\n  };\n}\n\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\n\nconst normalize = (s) =>\n  (s || '')\n    .toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .toLowerCase()\n    .replace(/[^a-z0-9%\\.\\ ]+/g,' ')\n    .replace(/\\s+/g,' ')\n    .trim();\n\nfunction variants(tok) {\n  const out = new Set();\n  if (!tok) return [];\n  out.add(tok);\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s')) out.add(tok.slice(0, -1));\n  if (tok.length >= 4) {\n    out.add(tok.slice(0, 4));\n    if (tok.length >= 5) out.add(tok.slice(0, 5));\n  }\n  return [...out];\n}\n\nfunction tokens(nombre) {\n  const base = normalize(nombre);\n  if (!base) return [];\n  const raw = base.split(' ').filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) for (const v of variants(tk)) uniq.add(v);\n  return [...uniq];\n}\n\n// OR global: name ilike tk OR default_code ilike tk\nlet leaves = [];\nfor (const p of productos_solicitados) {\n  for (const tk of tokens(p.nombre)) {\n    if (tk.length < 2) continue;\n    leaves.push(['name', 'ilike', tk]);\n    leaves.push(['default_code', 'ilike', tk]);\n  }\n}\n\n// dedupe\nconst seen = new Set();\nleaves = leaves.filter(l => {\n  const k = JSON.stringify(l);\n  if (seen.has(k)) return false;\n  seen.add(k);\n  return true;\n});\n\nlet domain;\nif (leaves.length === 0) {\n  domain = [['id', '=', -1]];\n} else {\n  const orTokens = (leaves.length === 1)\n    ? [leaves[0]]\n    : [...Array(leaves.length - 1).fill('|'), ...leaves];\n\n  domain = [\n    ['active', '=', true],\n    ['type', 'in', ['product','consu']],\n    ...orTokens\n  ];\n}\n\nconst payload_buscar_productos = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      PASS,\n      'product.product',\n      'search_read',\n      [domain],\n      { fields: ['id','name','uom_id','default_code'], limit: 300 }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  necesita_resolver_productos: true,\n  payload_buscar_productos,\n  productos_solicitados,\n  timesheet_line_id,\n  db,\n  uid,\n  ...reg,\n  chat_id, // ✅ fijado al final\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9152,
        -9616
      ],
      "id": "6370e082-3a44-4c08-b6ff-8d8a999ed2a4",
      "name": "Preparar Búsqueda Productos"
    },
    {
      "parameters": {
        "jsCode": "// VALIDAR PRODUCTOS (rama: Buscar Productos -> Validar Productos1)\n\n// 1) Pool de productos encontrados (respuesta JSON-RPC del HTTP Buscar Productos)\nconst httpResult =\n  $json.result ??\n  $json.body?.result ??\n  $json.json?.result ??\n  [];\n\nconst pool = Array.isArray(httpResult) ? httpResult : [];\n\n// 2) Leer datos del nodo \"Preparar Búsqueda Productos\"\nconst getFirstJson = (nodeName) => {\n  try {\n    return $items(nodeName, 0, 0)?.[0]?.json ?? {};\n  } catch {\n    return {};\n  }\n};\n\nconst datosBusqueda = getFirstJson('Preparar Búsqueda Productos');\n\n// 👇 en tu Preparar Búsqueda Productos lo llamas \"productos_solicitados\"\nconst productosSolicitados = Array.isArray(datosBusqueda.productos_solicitados)\n  ? datosBusqueda.productos_solicitados\n  : [];\n\n// Palabras vacías\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\n\n// Normalización\nconst normalize = (s) => {\n  let out = (s || '')\n    .toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .toLowerCase()\n    .replace(/\\s+/g,' ')\n    .trim();\n\n  out = out\n    .replace(/h/g, '')\n    .replace(/ll/g, 'y')\n    .replace(/v/g, 'b')\n    .replace(/qu/g, 'k')\n    .replace(/c(?=[ei])/g, 's')\n    .replace(/z/g, 's')\n    .replace(/ge/g, 'je')\n    .replace(/gi/g, 'ji');\n\n  return out;\n};\n\nfunction tokenVariants(tok) {\n  const out = new Set([tok]);\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s'))  out.add(tok.slice(0, -1));\n\n  const m = tok.match(/^(\\d+(?:\\.\\d+)?)(kg|g|mg|l|ml|cm|mm|m|u|uds?)$/);\n  if (m) { out.add(m[1]); out.add(m[2]); }\n\n  return [...out];\n}\n\nfunction tokens(s) {\n  const base = normalize(s);\n  if (!base) return [];\n  const raw = base.split(/[ \\-_/]+/).filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) {\n    for (const v of tokenVariants(tk)) {\n      if (v.length >= 2 || /^\\d+(?:\\.\\d+)?$/.test(v)) uniq.add(v);\n    }\n  }\n  return [...uniq];\n}\n\nfunction levenshtein(a, b) {\n  a = normalize(a);\n  b = normalize(b);\n  const m = a.length, n = b.length;\n  if (m === 0) return n;\n  if (n === 0) return m;\n\n  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));\n  for (let i = 0; i <= m; i++) dp[i][0] = i;\n  for (let j = 0; j <= n; j++) dp[0][j] = j;\n\n  for (let i = 1; i <= m; i++) {\n    for (let j = 1; j <= n; j++) {\n      const cost = a[i - 1] === b[j - 1] ? 0 : 1;\n      dp[i][j] = Math.min(\n        dp[i - 1][j] + 1,\n        dp[i][j - 1] + 1,\n        dp[i - 1][j - 1] + cost\n      );\n    }\n  }\n  return dp[m][n];\n}\n\nfunction jaccardToken(a, b) {\n  const A = new Set(tokens(a));\n  const B = new Set(tokens(b));\n  const inter = [...A].filter(x => B.has(x)).length; // ✅ .length\n  const uni = new Set([...A, ...B]).size;\n  return uni === 0 ? 0 : inter / uni;\n}\n\nfunction similarity(a, b) {\n  const la = normalize(a), lb = normalize(b);\n  if (!la || !lb) return 0;\n  if (la === lb) return 1;\n\n  const maxLen = Math.max(la.length, lb.length);\n  const ld = levenshtein(la, lb);\n  const levScore = 1 - (ld / Math.max(1, maxLen));\n  const jac = jaccardToken(a, b);\n\n  return (levScore * 0.7) + (jac * 0.3);\n}\n\n// Umbrales\nconst THRESHOLD_HIGH = 0.88;\nconst MIN_SUGGESTION = 0.35;\n\n// Índice rápido\nconst byName = new Map(pool.map(p => [normalize(p.name), p]));\n\nconst productosValidados = [];\nconst productosAmbiguos = [];\n\nfor (const sol of productosSolicitados) {\n  const nombreSolicitado = (sol?.nombre || '').toString().trim();\n  const cant = Number(sol?.cantidad || 1);\n\n  if (!nombreSolicitado) continue;\n\n  const qNorm = normalize(nombreSolicitado);\n  const qTokens = new Set(tokens(nombreSolicitado));\n\n  // Match exacto por name normalizado\n  if (byName.has(qNorm)) {\n    const p = byName.get(qNorm);\n    productosValidados.push({\n      product_id: p.id,\n      product_name: p.name,\n      quantity: Number.isFinite(cant) && cant > 0 ? cant : 1,\n      uom_id: Array.isArray(p.uom_id) ? p.uom_id[0] : p.uom_id,\n      default_code: p.default_code ?? null,\n    });\n    continue;\n  }\n\n  // Prefiltro + scoring\n  const candidates = [];\n  for (const p of pool) {\n    const cName = p.name || '';\n    const cTokens = new Set(tokens(cName));\n    const overlap = [...qTokens].some(t => cTokens.has(t));\n    const score = similarity(nombreSolicitado, cName);\n\n    if (overlap || score >= MIN_SUGGESTION) {\n      candidates.push({\n        id: p.id,\n        name: cName,\n        uom_id: Array.isArray(p.uom_id) ? p.uom_id[0] : p.uom_id,\n        default_code: p.default_code ?? null,\n        score\n      });\n    }\n  }\n\n  candidates.sort((a, b) => b.score - a.score);\n  const best = candidates[0];\n  const top = candidates.slice(0, 7);\n\n  if (best && best.score >= THRESHOLD_HIGH) {\n    productosValidados.push({\n      product_id: best.id,\n      product_name: best.name,\n      quantity: Number.isFinite(cant) && cant > 0 ? cant : 1,\n      uom_id: best.uom_id ?? null,\n      default_code: best.default_code ?? null,\n    });\n  } else if (top.length > 0) {\n    productosAmbiguos.push({\n      solicitado: nombreSolicitado,\n      cantidad: Number.isFinite(cant) && cant > 0 ? cant : 1,\n      candidatos: top.map(x => ({\n        id: x.id,\n        name: x.name,\n        score: Number(x.score.toFixed(2)),\n      }))\n    });\n  } else {\n    productosAmbiguos.push({\n      solicitado: nombreSolicitado,\n      cantidad: Number.isFinite(cant) && cant > 0 ? cant : 1,\n      candidatos: []\n    });\n  }\n}\n\n// 3) Output (manteniendo contexto) + texto_correccion\nconst requiereCorreccion = productosAmbiguos.length > 0;\n\nconst texto_correccion = !requiereCorreccion\n  ? ''\n  : (\n    `📦 *CONFIRMACIÓN DE PRODUCTOS*\\n\\n` +\n    `Responde *escribiendo el NOMBRE del producto correcto* (tal cual aparece en las opciones).\\n` +\n    `Si hay varios productos, escribe *uno por línea* en el mismo orden.\\n\\n` +\n    productosAmbiguos.map((p, i) => {\n      const candidatos = Array.isArray(p.candidatos) ? p.candidatos : [];\n      const lista = candidatos.length\n        ? candidatos.map(c => `   - *${c.name}*  _(≈ ${(Number(c.score || 0) * 100).toFixed(0)}%)_`).join('\\n')\n        : '   - (No encontré sugerencias)';\n\n      return `*${i + 1}. Detectado:* \"${p.solicitado}\"  (x${p.cantidad})\\n*Opciones sugeridas:*\\n${lista}`;\n    }).join('\\n\\n') +\n    `\\n\\n✅ *Ejemplo de respuesta*\\n` +\n    `juntas`\n  );\n\nreturn [{\n  json: {\n    ...datosBusqueda,\n    requiere_correccion: requiereCorreccion,\n    productos_validados: productosValidados,\n    productos_ambiguos: productosAmbiguos,\n    texto_correccion,\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9472,
        -9616
      ],
      "id": "78c8aab0-9e06-47dc-83df-7866a02288c8",
      "name": "Validar Productos1"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR OBTENER partner_id + ticket_type + is_diagnosis_task DESDE project.task\n\nconst firstJson = (nodeName) => {\n  try { return $items(nodeName, 0)?.[0]?.json ?? {}; } catch { return {}; }\n};\n\nconst regWrap = firstJson('Registrar Horas Directo FSM');\nconst reg = regWrap.registro || regWrap || {};\n\nconst locs = $json || {};\nconst prepBuscarUsuario = firstJson('Preparar Buscar Usuario Odoo') || {};\nconst seed = firstJson('Registrar Tarea Odoo') || {};\n\n// task_id\nconst task_id = Number(\n  reg.task_id ||\n  reg.tarea_id ||\n  locs.task_id ||\n  locs.tarea_id ||\n  locs.datos_registrados?.task_id ||\n  prepBuscarUsuario.task_id ||\n  prepBuscarUsuario.tarea_id ||\n  prepBuscarUsuario.datos_registrados?.task_id ||\n  seed.datos_registrados?.task_id\n);\n\nif (!Number.isFinite(task_id) || task_id <= 0) {\n  return { error: true, motivo: 'No hay task_id para leer la tarea', task_id };\n}\n\n// db / uid\nconst db = reg.db || locs.db || 'mchecagoshawk-webinar-main-28403608';\nconst uid = Number(reg.uid || locs.uid || 2);\nconst PASS = 'admin';\n\nconst payload_get_task = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, PASS,\n      'project.task', 'search_read',\n      [[['id', '=', task_id]]],\n      {\n        // ✅ AÑADIMOS LOS 2 CAMPOS\n       fields: ['id','name','partner_id','project_id','is_diagnosis_task','sale_line_id'],\n        limit: 1\n      }\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...locs,\n  ...reg,\n  task_id,\n  db,\n  uid,\n  payload_get_task,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6928,
        -9488
      ],
      "id": "4ae88d75-3039-4b36-bfb6-c83d4f74969b",
      "name": "Preparar Obtener Cliente desde Tarea"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload_get_task }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        7136,
        -9488
      ],
      "id": "01d2ab67-588b-439b-bebb-e77270351846",
      "name": "HTTP Leer Tarea"
    },
    {
      "parameters": {
        "jsCode": "// EXTRAER partner_id + ticket_type + is_diagnosis_task desde la respuesta de project.task\n\nconst resp =\n  $json.result ??\n  $json.body?.result ??\n  $json.json?.result ??\n  [];\n\nconst task = Array.isArray(resp) ? resp[0] : resp;\n\n// partner_id\nlet partner_id = null;\nif (task?.partner_id) {\n  partner_id = Array.isArray(task.partner_id) ? task.partner_id[0] : task.partner_id;\n}\n\n// ✅ campos Odoo\n\nconst is_diagnosis_task = task?.is_diagnosis_task === true; // fuerza boolean\n\nif (!partner_id) {\n  return {\n    ...$json,\n    error: true,\n    motivo: 'La tarea no tiene partner_id (cliente) asignado en Odoo',\n    task_id: $json.task_id,\n    \n    is_diagnosis_task,\n  };\n}\n\nreturn {\n  ...$json,\n  partner_id: Number(partner_id),\n  partner_name: Array.isArray(task.partner_id) ? task.partner_id[1] : null,\n\n  // ✅ CLAVE\n  \n  is_diagnosis_task,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7296,
        -9488
      ],
      "id": "7f19c822-ffb9-470c-9a23-ad3fbebab7e8",
      "name": "Extraer partner_id"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR NOTA MATERIALES (publica en project.task, no en account.analytic.line)\n\nconst firstJson = (nodeName) => {\n  try { return $items(nodeName, 0)?.[0]?.json ?? null; } catch { return null; }\n};\n\nconst ctx = $json || {};\n\nconst regWrap = firstJson('Registrar Horas Directo FSM') || {};\nconst reg = regWrap.registro || regWrap || {};\nconst baseValid = firstJson('Validar Productos1') || {};\nconst normalizado = firstJson('Normalizar Parte+Materiales FSM') || {};\nconst auth = firstJson('Autenticar Odoo') || {};\n\nconst db =\n  ctx.db || reg.db || baseValid.db || normalizado.db ||\n  'mchecagoshawk-webinar-main-28403608';\n\nconst uid = Number(ctx.uid || reg.uid || baseValid.uid || normalizado.uid || auth?.result || 0);\nif (!uid) {\n  return { ...ctx, db, skip_nota: true, motivo: 'Falta uid' };\n}\n\n// ✅ task_id (robusto: ctx/reg/validador/memoria/seed)\nconst memRow = firstJson('Preparar Datos AI Agent') || {};\nconst pendientes = (memRow?.datos_pendientes && typeof memRow.datos_pendientes === 'object')\n  ? memRow.datos_pendientes\n  : (() => { try { return JSON.parse(memRow?.datos_pendientes || '{}'); } catch { return {}; } })();\n\nconst seed = firstJson('Registrar Tarea Odoo') || {};\nconst seedReg = seed?.datos_registrados || {};\n\nconst taskId = Number(\n  ctx.task_id ||\n  ctx.tarea_id ||\n  reg.task_id ||\n  reg.tarea_id ||\n  baseValid.task_id ||\n  baseValid.tarea_id ||\n  pendientes.task_id ||\n  pendientes.tarea_id ||\n  seedReg.task_id ||\n  seedReg.tarea_id ||\n  0\n);\n\nif (!taskId) {\n  return { ...ctx, db, uid, skip_nota: true, motivo: 'Sin task_id para publicar la nota' };\n}\n\n\n// ---- materiales (prioridad: validados > registro > normalizado > ctx) ----\nlet productos = [];\n\nif (Array.isArray(baseValid.productos_validados) && baseValid.productos_validados.length) {\n  productos = baseValid.productos_validados.map(p => ({\n    nombre: p.product_name || p.name || '',\n    cantidad: Number(p.quantity ?? p.cantidad ?? 1),\n  }));\n} else if (Array.isArray(reg.productos) && reg.productos.length) {\n  productos = reg.productos.map(p => ({\n    nombre: p.nombre || p.product_name || '',\n    cantidad: Number(p.cantidad ?? p.quantity ?? 1),\n  }));\n} else if (Array.isArray(normalizado.productos) && normalizado.productos.length) {\n  productos = normalizado.productos.map(p => ({\n    nombre: p.nombre || p.product_name || '',\n    cantidad: Number(p.cantidad ?? p.quantity ?? 1),\n  }));\n} else if (Array.isArray(ctx.productos) && ctx.productos.length) {\n  productos = ctx.productos.map(p => ({\n    nombre: p.nombre || p.product_name || '',\n    cantidad: Number(p.cantidad ?? p.quantity ?? 1),\n  }));\n}\n\nproductos = productos\n  .map(p => ({ nombre: String(p.nombre || '').trim(), cantidad: Number(p.cantidad || 1) }))\n  .filter(p => p.nombre);\n\nif (!productos.length) {\n  return { ...ctx, db, uid, task_id: taskId, skip_nota: true, motivo: 'Sin materiales' };\n}\n\n// Texto de la nota\nconst lineas = productos\n  .map(p => `• ${Number.isFinite(p.cantidad) && p.cantidad > 0 ? p.cantidad : 1} × ${p.nombre}`)\n  .join('\\n');\n\nconst texto = `🧰 Material utilizado:\\n${lineas}`;\n\n// author_id opcional (partner del usuario)\nlet authorId = null;\ntry {\n  const buo = firstJson('Buscar Usuario Odoo') || {};\n  const lista = buo?.result ?? buo?.json?.result ?? buo?.body?.result ?? [];\n  const u = Array.isArray(lista) && lista[0] ? lista[0] : null;\n  if (u?.partner_id) authorId = Array.isArray(u.partner_id) ? Number(u.partner_id[0]) : Number(u.partner_id);\n} catch {}\n\n// ✅ payload: project.task.message_post\nconst valsMessage = {\n  body: texto,\n  message_type: 'comment',\n  subtype_xmlid: 'mail.mt_comment',\n};\nif (Number.isFinite(authorId) && authorId > 0) valsMessage.author_id = authorId;\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'project.task',\n      'message_post',\n      [[taskId]],\n      valsMessage,\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...ctx,\n  db,\n  uid,\n  task_id: taskId,\n  hay_materiales: true,\n  skip_nota: false,\n  payload,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10208,
        -9648
      ],
      "id": "bc3949bd-78ac-4ec3-b9c8-16f8ab849382",
      "name": "Preparar Nota Materiales"
    },
    {
      "parameters": {
        "jsCode": "// REGISTRAR MATERIALES (para tu rama DESPUÉS de Validar Productos1)\n//\n// Entrada esperada: output de \"Validar Productos1\"\n// - productos_validados: [{ product_id, product_name, quantity, uom_id, ... }]\n// - timesheet_line_id (si viene) o lo cogemos del HTTP Registrar Horas Directo FSM\n// - db / uid (si vienen) o los cogemos del registro/auth\n\nconst firstJson = (nodeName) => {\n  try { return $items(nodeName, 0)?.[0]?.json ?? null; } catch { return null; }\n};\n\nconst ctx = $json || {}; // <-- viene de Validar Productos1\n\n// ✅ 1) timesheet_line_id: prioridad ctx -> HTTP Registrar Horas Directo FSM\nlet timesheetLineId = ctx.timesheet_line_id;\n\nif (!timesheetLineId) {\n  const httpHoras = firstJson('HTTP Registrar Horas Directo FSM') || {};\n  timesheetLineId =\n    httpHoras.result ??\n    httpHoras.body?.result ??\n    httpHoras.json?.result ??\n    null;\n}\n\nif (Array.isArray(timesheetLineId)) timesheetLineId = timesheetLineId[0];\ntimesheetLineId = Number(timesheetLineId);\n\nif (!Number.isFinite(timesheetLineId) || timesheetLineId <= 0) {\n  return {\n    skip_materiales: true,\n    motivo: 'Sin timesheet_line_id válido',\n    timesheet_line_id: timesheetLineId || null,\n  };\n}\n\n// ✅ 2) si hay ambigüedad, NO registramos nada (evitas basura)\nif (ctx.requiere_correccion === true) {\n  return {\n    skip_materiales: true,\n    motivo: 'Productos ambiguos: requiere corrección antes de registrar materiales',\n    timesheet_line_id: timesheetLineId,\n    productos_ambiguos: ctx.productos_ambiguos || [],\n  };\n}\n\n// ✅ 3) productos validados\nconst productosValidados = Array.isArray(ctx.productos_validados) ? ctx.productos_validados : [];\n\nif (!productosValidados.length) {\n  return {\n    skip_materiales: true,\n    motivo: 'No hay productos_validados',\n    timesheet_line_id: timesheetLineId,\n  };\n}\n\n// ✅ 4) db/uid\nconst regWrap = firstJson('Registrar Horas Directo FSM') || {};\nconst reg = regWrap.registro || regWrap || {};\nconst auth = firstJson('Autenticar Odoo') || {};\n\nconst db = ctx.db || reg.db || 'mchecagoshawk-webinar-main-28403608';\nconst uid = Number(ctx.uid || reg.uid || auth?.result || 2);\nconst pass = 'admin';\n\n// ✅ 5) construir líneas para account.analytic.line.product\nconst lines = [];\n\nfor (const p of productosValidados) {\n  const pid = Number(p.product_id);\n  if (!Number.isFinite(pid) || pid <= 0) continue;\n\n  const qty = Number(p.quantity ?? 1);\n  const name = String(p.product_name || p.name || '').trim();\n\n  const uom =\n    (Array.isArray(p.uom_id) ? p.uom_id[0] : p.uom_id) ||\n    (Array.isArray(p.product_uom_id) ? p.product_uom_id[0] : p.product_uom_id) ||\n    null;\n\n  \n  const item = {\n    timesheet_line_id: timesheetLineId,\n    product_id: pid,\n    quantity: Number.isFinite(qty) && qty > 0 ? qty : 1,\n    notes: name,\n    product_uom_id: uom ? Number(uom) : undefined,\n  };\n  // OJO: si tu modelo NO tiene este campo, Odoo dará \"Invalid field\".\n  // Si te pasara, lo quitamos.\n  if (uom) item.product_uom_id = Number(uom);\n\n  lines.push(item);\n}\n\nif (!lines.length) {\n  return {\n    skip_materiales: true,\n    motivo: 'No hay líneas válidas para crear',\n    timesheet_line_id: timesheetLineId,\n  };\n}\n\n// ✅ 6) payload create\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      pass,\n      'account.analytic.line.product',\n      'create',\n      [lines],\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  skip_materiales: false,\n  payload,\n  timesheet_line_id: timesheetLineId,\n  productos_creados: lines.length,\n  db,\n  uid,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9856,
        -9648
      ],
      "id": "7b6fbb8a-7499-4c36-bfdd-9d0cff6749ad",
      "name": "Registrar Materiales1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        10032,
        -9648
      ],
      "id": "a26d96de-57ed-484b-b00d-6ac5c9acad9b",
      "name": "HTTP Registrar Materiales Parte",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "jsCode": "// FSM ▸ Preparar Presupuesto (Productos Mencionados)\n\nconst safeFirst = (name) => { try { return $items(name, 0)?.[0]?.json ?? null; } catch { return null; } };\n\nconst x = $json;\n\n// 1) timesheet_line_id (del HTTP de crear horas)\nconst httpHoras = safeFirst('HTTP Registrar Horas Directo FSM') || {};\nlet timesheetLineId =\n  httpHoras.result ??\n  httpHoras.body?.result ??\n  httpHoras.json?.result ??\n  null;\n\nif (Array.isArray(timesheetLineId)) timesheetLineId = timesheetLineId[0];\ntimesheetLineId = Number(timesheetLineId);\nif (!Number.isFinite(timesheetLineId) || timesheetLineId <= 0) {\n  return { ...x, registrar_presupuesto: false, motivo_presupuesto: 'sin timesheet_line_id' };\n}\n\n// 2) is_diagnosis_task: PRIORIDAD a lo que viene de Odoo (Extraer partner_id)\nconst ctxTask = safeFirst('Extraer partner_id') || {};\nconst isDiagnosis = ctxTask.is_diagnosis_task === true;\n\n// 3) horas presupuestadas (si no vienen, quedará 0)\nconst seed = safeFirst('Registrar Tarea Odoo') || {};\nconst normalizado = safeFirst('Normalizar Parte+Materiales FSM') || {};\nconst datosParte = x.datos_parte || seed.datos_parte || normalizado.parte_en_memoria || normalizado || {};\n\nconst horasPresup = Number(\n  x.horas_presupuestadas ??\n  datosParte.horas_presupuestadas ??\n  seed.horas_presupuestadas ??\n  normalizado.horas_presupuestadas ??\n  0\n);\n\n// ✅ REGLA NUEVA: si es diagnóstico, registrar_presupuesto = true\nif (!isDiagnosis) {\n  return { ...x, registrar_presupuesto: false, motivo_presupuesto: 'no_diagnostico' };\n}\n\n// 4) db/uid/pass (reconstrucción robusta)\nconst regWrap = safeFirst('Registrar Horas Directo FSM') || {};\nconst reg = regWrap.registro || regWrap || {};\n\nconst db =\n  x.db ||\n  reg.db ||\n  seed.db ||\n  normalizado.db ||\n  'mchecagoshawk-webinar-main-28403608';\n\nconst uid = Number(x.uid || reg.uid || seed.uid || normalizado.uid || 2);\nconst pass = 'admin';\n\n// 5) Buscar producto service\nconst domain = ['&', ['type','=','service'], ['name','ilike', 'Service on Timesheets']];\n\nconst payload_presupuesto = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, pass,\n      'product.template', 'search_read',\n      [domain],\n      {\n        fields: ['id','name','type','active','uom_id','product_variant_id','product_variant_ids'],\n        limit: 50,\n        context: { active_test: false },\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...x,\n  registrar_presupuesto: true,\n  // ✅ garantizamos estos 2 SIEMPRE\n  timesheet_line_id: timesheetLineId,\n  horas_presupuestadas: Number.isFinite(horasPresup) ? horasPresup : 0,\n\n  payload_presupuesto,\n  db,\n  uid,\n  pass,\n\n  // debug útil\n  is_diagnosis_task: true,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7488,
        -9488
      ],
      "id": "d49d494d-2c4f-4f8d-a152-0bb853a9e0d4",
      "name": "Preparar Presupuesto (Productos Mencionados)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3a83a8d9-156c-4108-86e2-ecbf72f79fd2",
              "leftValue": "={{ $json.horas_presupuestadas }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "25b9a8dd-700e-4026-bb13-bdfa574c37a1",
              "leftValue": "={{ $json.registrar_presupuesto === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        7664,
        -9488
      ],
      "id": "81ad8047-525c-40d6-a544-f3d3faf764ad",
      "name": "¿Registrar Presupuesto?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload_presupuesto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        8368,
        -9728
      ],
      "id": "f8ed9213-bb33-4e6f-b6b8-7e72fe264648",
      "name": "HTTP Registrar Presupuesto (Mencionados)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n\nSET\n  esperando_confirmacion = NULL,\n  ultimo_mensaje_bot = NULL,\n  datos_pendientes = NULL\nWHERE chat_id = $1;",
        "options": {
          "queryReplacement": "={{ [$json.chat_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        4656,
        -9776
      ],
      "id": "2d200f0f-7c75-4588-97ef-139b6ec3809a",
      "name": "Borrar Memoria"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "6e540e8a-1fda-4dbe-acca-da4191e990bd",
              "leftValue": "={{ $json.borrar_memoria === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        4432,
        -9712
      ],
      "id": "d28d5eb3-6936-4e61-8582-0d2bd06753a7",
      "name": "¿Solicita Cancelar Operacion?"
    },
    {
      "parameters": {
        "jsCode": "const resp = $json; // respuesta del HTTP Buscar Producto Presupuesto\n\nconst base = (() => {\n  try {\n    const items = $items('Preparar Presupuesto (Productos Mencionados)', 0);\n    return items?.[$itemIndex]?.json ?? {};\n  } catch {\n    return {};\n  }\n})();\n\n// Mezcla correcta\nconst x = { ...base, ...resp };\n\n// --- 1) Validar contexto crítico (antes de nada) ---\nconst db = x.db ?? base.db;\nconst uid = Number(x.uid ?? base.uid);\nconst pass = x.pass || base.pass || 'admin';\n\nconst timesheetLineId = Number(x.timesheet_line_id);\n\nif (!db || !Number.isFinite(uid) || uid <= 0 || !Number.isFinite(timesheetLineId) || timesheetLineId <= 0) {\n  return {\n    ...x,\n    skip_presupuesto: true,\n    motivo_presupuesto: 'faltan db/uid/timesheet_line_id',\n    debug: {\n      db,\n      uid,\n      timesheet_line_id_raw: x.timesheet_line_id,\n      timesheetLineId,\n      base_has_db: !!base.db,\n      base_has_uid: !!base.uid,\n      base_has_timesheet: base.timesheet_line_id,\n      itemIndex: $itemIndex,\n    }\n  };\n}\n\n// --- 2) Leer resultado del search_read ---\nconst res = x.result ?? x.body?.result ?? x.json?.result ?? [];\nconst list = Array.isArray(res) ? res : [];\n\nif (!list.length) {\n  return { ...x, skip_presupuesto: true, motivo_presupuesto: 'No encontré el product.template (revisa dominio/compañía/archivado)' };\n}\n\nconst tmpl = list[0];\n\n// --- 3) Resolver product.product (variant) ---\nlet pid = tmpl.product_variant_id;\nif (Array.isArray(pid)) pid = pid[0];\npid = pid === false || pid == null ? null : Number(pid);\n\nif (!pid && Array.isArray(tmpl.product_variant_ids) && tmpl.product_variant_ids.length) {\n  pid = Number(tmpl.product_variant_ids[0]);\n}\n\nif (!Number.isFinite(pid) || pid <= 0) {\n  return { ...x, skip_presupuesto: true, motivo_presupuesto: 'Template sin product_variant_id (product.product)', debug_template: tmpl };\n}\n\n// --- 4) Horas presupuestadas ---\nconst horasPresup = Number(x.horas_presupuestadas);\nconst quantity = Number.isFinite(horasPresup) ? horasPresup : 0;\n\n// uom\nlet uom = tmpl.uom_id;\nif (Array.isArray(uom)) uom = uom[0];\n\n// --- 5) Construir línea y payload ---\nconst line = {\n  timesheet_line_id: timesheetLineId,\n  product_id: pid,\n  quantity,\n  notes: `Horas presupuestadas (${tmpl.name})`,\n};\nif (uom) line.product_uom_id = Number(uom);\n\nconst payload_presupuesto = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, pass,\n      'account.analytic.line.product', 'create',\n      [[line]],\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...x,\n  skip_presupuesto: false,\n  presupuesto_line: line,\n  payload_presupuesto,\n  producto_presupuesto_resuelto: { template_id: tmpl.id, template_name: tmpl.name, product_id: pid },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8208,
        -9728
      ],
      "id": "ab4a2615-8a9a-428e-97a0-8e3fe187a0b3",
      "name": "Preparar Payload Presupuesto (Servicio)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload_presupuesto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        8000,
        -9728
      ],
      "id": "727473da-0439-49f8-ace7-9b017982f2a4",
      "name": "HTTP Buscar Producto Presupuesto"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "9443648d-ef61-4680-b897-c15d33dbd33c",
              "leftValue": "={{ $json.tiene_imagen === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -4720,
        -9136
      ],
      "id": "77bee24d-7f5b-43bb-ba4c-2ebc7a0a3e02",
      "name": "¿Tiene Imagen?"
    },
    {
      "parameters": {
        "jsCode": "const res =\n  $json.result ??\n  $json.body?.result ??\n  $json.json?.result ??\n  null;\n\nreturn {\n  ...$json,\n  attachment_id: res,\n  adjunto_creado_en_odoo: !!res,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2240,
        -9392
      ],
      "id": "637ba0c5-d7ca-4f1e-99a1-eca7fd4f37bf",
      "name": "Confirma si Odoo devolvió OK"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "98337dc3-1dc9-4372-b0e3-583ad688e2e8",
              "leftValue": "={{ $json.success }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -2080,
        -9392
      ],
      "id": "e9f07af5-2780-4b94-9180-9df465c7aebb",
      "name": "¿Subida Imagen?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Construir URL Descarga Parte').item.json.chat_id }}",
        "text": "=❌  La imagen no ha podido ser adjuntada, por favor inténtelo más tarade.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1872,
        -9280
      ],
      "id": "445d34c4-2c5b-46b1-83d0-278d5a0d4026",
      "name": "Error Imagen Adjuntada (Último)",
      "webhookId": "imagen-adjuntada-ultimo-webhook-001"
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot8163442849:AAFYMCxlzQ5z5ao6FT87GzIJhrUgVw1bu_s/{{$json.result.file_path}}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3904,
        -9344
      ],
      "id": "32381611-a6c2-43f3-8e38-f510a8e02aba",
      "name": "HTTP Descargar Imagen REAL"
    },
    {
      "parameters": {
        "jsCode": "// CONSTRUIR URL DE DESCARGA CON FILE_PATH REAL (PARTE)\n\nconst datosOrigen = $items('Extraer Datos', 0)[0].json;\nconst getFileResponse = $json;\n\nlet filePath = null;\n\nif (getFileResponse.ok && getFileResponse.result?.file_path) {\n  filePath = getFileResponse.result.file_path;\n} else {\n  return {\n    ...datosOrigen,\n    imagen_adjuntada: false,\n    error: 'No se pudo obtener file_path real',\n    debug: getFileResponse\n  };\n}\n\nconst tokenReal = '8163442849:AAFYMCxlzQ5z5ao6FT87GzIJhrUgVw1bu_s'; // ⚠️ mismo token que usas en getFile\nconst downloadUrl = `https://api.telegram.org/file/bot${tokenReal}/${filePath}`;\n\nreturn {\n  ...datosOrigen,\n  file_path: filePath,\n  download_url: downloadUrl,\n  telegram_file_info: getFileResponse.result,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3728,
        -9344
      ],
      "id": "0c472bd6-87a4-4209-843e-fae7ad406a55",
      "name": "Construir URL Descarga Parte"
    },
    {
      "parameters": {
        "url": "={{ $json.download_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -3552,
        -9344
      ],
      "id": "cacd15ad-5ed5-4283-9f64-4827539d555e",
      "name": "Descargar Imagen REAL (PARTE)"
    },
    {
      "parameters": {
        "jsCode": "// ✅ Detectar si la imagen es “suelta” (para último parte) o “con texto” (otro mensaje)\n\nconst tieneImagen =\n  $json.tiene_imagen === true ||\n  !!$json.imagen_file_id ||\n  !!$json.img_data?.file_id;\n\nconst caption = ($json.img_data?.caption ?? \"\").trim();\nconst mensaje = ($json.mensaje_usuario ?? \"\").trim();\n\n// Esto es lo que tú estás metiendo cuando no hay texto:\nconst esPlaceholder = mensaje === \"[Imagen recibida sin texto]\" || mensaje === \"\";\n\n// ✅ Imagen suelta = no caption + no texto real\nconst imagenSuelta = tieneImagen && caption === \"\" && esPlaceholder;\n\n// ✅ Imagen con texto = caption o mensaje real\nconst imagenConTexto = tieneImagen && (caption !== \"\" && !esPlaceholder);\n\nreturn {\n  ...$json,\n  tieneImagen,\n  imagen_suelta: imagenSuelta,\n  imagen_con_texto: imagenConTexto,\n  ruta_imagen: imagenSuelta ? \"ULTIMO_PARTE\" : \"OTRO_MENSAJE\",\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4512,
        -9232
      ],
      "id": "5e3a525d-6535-4608-9e1b-1be43e8dc6ee",
      "name": "Detectar Ruta Imagen"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "5552e3da-587b-4839-94f4-392231a266d2",
              "leftValue": "={{ $json.imagen_suelta === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -4304,
        -9232
      ],
      "id": "45f7d827-ded2-4926-807e-e32d5c5dbb6a",
      "name": "¿Imagen suelta?"
    },
    {
      "parameters": {
        "jsCode": "// PROCESAR IMAGEN DESCARGADA INMEDIATAMENTE Y CONVERTIR A BASE64\nconst datosOriginales = $('Extraer Datos').item.json;\nconst imgData = datosOriginales.img_data;\n\nconsole.log('🖼️ === PROCESAR IMAGEN INMEDIATAMENTE ===');\nconsole.log('📊 Datos originales presentes:', !!datosOriginales);\nconsole.log('🖼️ Datos imagen presentes:', !!imgData);\n\n// Buscar datos binarios\nlet archivoBinario = null;\nlet archivoBase64 = null;\n\nif ($binary && $binary.data && Buffer.isBuffer($binary.data)) {\n  archivoBinario = $binary.data;\n  console.log('✅ Imagen descargada:', archivoBinario.length, 'bytes');\n  \n  // Convertir a base64 inmediatamente\n  archivoBase64 = archivoBinario.toString('base64');\n  console.log('✅ Convertido a base64:', archivoBase64.length, 'caracteres');\n} else {\n  console.log('❌ No se pudo descargar la imagen');\n}\n\n// Devolver datos originales + imagen en base64\nreturn {\n  ...datosOriginales,\n  imagen_base64: archivoBase64,\n  imagen_descargada: !!archivoBase64\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3840,
        -9120
      ],
      "id": "326fb6e4-12de-4d7b-b5b9-de305f3108d5",
      "name": "Procesar Imagen Descargada"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.img_data.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4016,
        -9120
      ],
      "id": "7bf958c6-a470-4c40-a8f9-105f9523ad48",
      "name": "Descargar Imagen Inmediatamente1",
      "webhookId": "112bd982-9aa8-409c-88ac-1c3c956c0c09",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ✅ PREPARAR ADJUNTO DIRECTO (PARTE) DESDE DESCARGA HTTP\n// Metadatos desde el nodo que construye la URL\nconst datosAnteriores = $items('Construir URL Descarga Parte', 0)[0].json;\nconst ultimo = $items('Buscar Último Horas ID', 0)[0].json;\n\nconst horasId = Number(ultimo.ultimo_horas_id);\nconst chatId = datosAnteriores.chat_id ?? ultimo.chat_id ?? null;\n\nif (!Number.isFinite(horasId) || horasId <= 0) {\n  throw new Error('ultimo_horas_id inválido para adjuntar.');\n}\n\n// 1) Binario del item actual\nlet bin = null;\nconst binKeys = Object.keys($binary || {});\nif (binKeys.length) bin = $binary[binKeys[0]];\n\n// 2) Fallback: binario desde \"Descargar Imagen REAL (PARTE)\"\nif (!bin || !bin.data) {\n  const httpItems = $items('Descargar Imagen REAL (PARTE)', 0, 0) || [];\n  if (httpItems.length && httpItems[0].binary) {\n    const httpBinKeys = Object.keys(httpItems[0].binary);\n    if (httpBinKeys.length) bin = httpItems[0].binary[httpBinKeys[0]];\n  }\n}\n\nif (!bin || !bin.data) {\n  throw new Error('No se encontraron datos binarios del archivo descargado');\n}\n\n// base64 -> buffer\nconst archivoBinario = Buffer.from(bin.data, 'base64');\n\n// detectar firma\nconst sig = archivoBinario.slice(0, 8).toString('hex').toUpperCase();\nlet mimetype = 'image/jpeg';\nlet extension = 'jpg';\n\nif (sig.startsWith('89504E47')) { mimetype = 'image/png'; extension = 'png'; }\nelse if (sig.startsWith('FFD8FF')) { mimetype = 'image/jpeg'; extension = 'jpg'; }\nelse if (sig.startsWith('47494638')) { mimetype = 'image/gif'; extension = 'gif'; }\nelse if (sig.startsWith('52494646')) { mimetype = 'image/webp'; extension = 'webp'; }\n\n// base64 limpio para Odoo\nconst archivoBase64 = archivoBinario.toString('base64');\n\n// nombre\nconst ts = new Date().toISOString().replace(/[:.]/g, '-');\nconst nombreArchivo = `Parte-${horasId}-${ts}.${extension}`;\n\n// Odoo\nconst db = 'mchecagoshawk-webinar-main-28403608';\nconst uid = 2; // admin\nconst pass = 'admin';\n\n// ✅ AHORA sí: construir el attachment con los campos que necesita tu pestaña \"Imágenes\"\nconst attachmentVals = {\n  name: nombreArchivo,\n  datas: archivoBase64,\n  res_model: \"account.analytic.line\",\n  res_id: horasId,\n\n  // ✅ CLAVE para que aparezca en la pestaña Imágenes (según tu vista)\n  timesheet_line_id: horasId,\n\n  mimetype: mimetype,\n  type: \"binary\",\n\n  // ✅ Opcionales (si existen en tu ir.attachment)\n  is_repair_photo: true,\n  photo_type: \"none\",\n  // fecha_reparacion: new Date().toISOString().split('T')[0],\n};\n\nconst consultaAdjunto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      db,\n      uid,\n      pass,\n      \"ir.attachment\",\n      \"create\",\n      [attachmentVals],\n      {\n        context: {\n          force_google_drive: true\n        }\n      }\n    ],\n  },\n  id: Math.floor(Math.random() * 1000000),\n};\n\nreturn {\n  ...datosAnteriores,\n  chat_id: chatId,\n  horas_id: horasId,\n\n  // ✅ Payload para tu endpoint /api/sync_telegram_image\n  odoo_api_payload: {\n    chat_id: chatId,\n    horas_id: horasId,\n    filename: nombreArchivo,\n    mimetype,\n    image_base64: archivoBase64,\n  },\n  consulta_adjunto: consultaAdjunto,\n  imagen_lista_para_subir: true,\n  imagen_adjuntada: true,\n  archivo_info: {\n    nombre: nombreArchivo,\n    mimetype,\n    tamaño: archivoBinario.length,\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2800,
        -9392
      ],
      "id": "518082b5-2b6f-4634-bb0d-921a2321f464",
      "name": "Preparar Adjunto Directo (PARTE)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/api/sync_telegram_image",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Cookie",
              "value": "={{ $node[\"HTTP Login Odoo (admin)\"].json.headers[\"set-cookie\"][0].split(\";\")[0] }}"
            },
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($node[\"Preparar Adjunto Directo (PARTE)\"].json.odoo_api_payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2416,
        -9392
      ],
      "id": "076e54d5-e821-4d02-a99b-5e2616471675",
      "name": "HTTP Crear Adjunto Odoo (PARTE)"
    },
    {
      "parameters": {
        "jsCode": "const x = $json || {};\nconst msg = x.message || x.body?.message || null;\n\n// Detectar document/photo en update crudo\nconst doc = msg?.document || null;\nconst photo = msg?.photo || null;\n\n// Elegir file_id\nlet fileIdFinal = null;\nlet tipo = null;\n\nif (doc?.file_id) {\n  fileIdFinal = doc.file_id;\n  tipo = 'document';\n} else if (Array.isArray(photo) && photo.length && photo[photo.length - 1]?.file_id) {\n  fileIdFinal = photo[photo.length - 1].file_id;\n  tipo = 'photo';\n} else if (x.imagen_file_id) {\n  fileIdFinal = x.imagen_file_id;\n  tipo = 'legacy';\n} else if (x.img_data?.file_id) {\n  fileIdFinal = x.img_data.file_id;\n  tipo = 'legacy';\n}\n\nreturn {\n  ...x,\n  file_id_final: fileIdFinal,\n  tipo_media: tipo,\n  // compatibilidad con tu flow actual\n  tiene_imagen: !!fileIdFinal,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4960,
        -9104
      ],
      "id": "ff2a3baf-16dd-4010-949c-ad9c744d0f0e",
      "name": "Normalizar Entrada Documento",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/web/session/authenticate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"jsonrpc\": \"2.0\",\n  \"params\": {\n    \"db\": \"mchecagoshawk-webinar-main-28403608\",\n    \"login\": \"admin\",\n    \"password\": \"admin\"\n  }\n}",
        "options": {
          "response": {
            "response": {
              "fullResponse": true
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -2592,
        -9392
      ],
      "id": "a8b18f64-db5a-4690-acbe-309bedc031ef",
      "name": "HTTP Login Odoo (admin)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($node[\"Preparar Consulta Eventos Diarios\"].json.payload_tasks) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3936,
        -8096
      ],
      "id": "5cfe6696-4635-4aa0-ab08-3e1fdca3d100",
      "name": "HTTP Consultar Tareas Diarias"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload_buscar_user) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2144,
        -8064
      ],
      "id": "fa2934d9-8914-488b-8aaf-4f1c3d20870c",
      "name": "HTTP Buscar Usuario Odoo"
    },
    {
      "parameters": {
        "jsCode": "const itemActual = $json;\n\n// UID robusto\nconst auth = $('Autenticar Odoo para Resumen').all();\nlet uid = null;\nfor (const it of auth) {\n  if (it.json?.result) { uid = it.json.result; break; }\n}\nif (!uid) throw new Error('❌ UID no disponible');\n\n// Fecha HOY en Madrid (siempre)\nconst fechaHoy = new Date().toLocaleDateString('en-CA', { timeZone: 'Europe/Madrid' });\nconst inicioDia = `${fechaHoy} 00:00:00`;\nconst finDia = `${fechaHoy} 23:59:59`;\n\n// Resultado de res.users (lo trae el HTTP Buscar Usuario Odoo)\nconst userRes = Array.isArray(itemActual.result) ? itemActual.result : [];\nconst userOdoo = userRes[0];\n\nif (!userOdoo?.id) {\n  return {\n    json: {\n      ...itemActual,\n      uid,\n      fechaHoy,\n      inicioDia,\n      finDia,\n      consulta_fsm: null,\n      fsm_hoy: [],\n      mensaje_eventos: `🛠️ **TU PLANIFICACIÓN DEL DÍA**\\n⚠️ No se encontró el usuario Odoo para: ${itemActual.odoo_user}\\n`\n    }\n  };\n}\n\nconst userIdOdoo = userOdoo.id;\n\n// ✅ Dominio SOLAPE (overlap) para incluir:\n// - tareas dentro del día\n// - tareas todo el día\n// - tareas multi-día que \"tocan\" hoy\nconst dominioFSM = [\n  [\"planned_date_begin\", \"<=\", finDia],\n  [\"date_deadline\", \">=\", inicioDia],\n  [\"user_ids\", \"in\", [userIdOdoo]],\n  [\"state\", \"not in\", [\"1_done\", \"1_canceled\"]],\n  [\"fsm_done\", \"!=\", true]\n];\n\n// (Opcional) Si en tu Odoo algunas tareas tienen planned_date_begin vacío,\n// puedes OR para permitirlas usando date_deadline. Te lo dejo preparado abajo.\n// Si quieres activarlo, dímelo y lo ajusto, porque depende de cómo planifica FSM.\n\nconst consultaFSM = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"search_read\",\n      [dominioFSM],\n      {\n        fields: [\n          \"name\",\n          \"planned_date_begin\",\n          \"date_deadline\",\n          \"partner_id\",\n          \"project_id\",\n          \"stage_id\",\n          \"user_ids\",\n          \"fsm_done\"\n        ],\n        order: \"planned_date_begin asc\"\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  json: {\n    ...itemActual,\n    uid,\n    fechaHoy,\n    inicioDia,\n    finDia,\n    consulta_fsm: consultaFSM,\n    odoo_user_name: userOdoo.name\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1936,
        -8064
      ],
      "id": "9548e2f4-0431-4a6d-8be5-293493349993",
      "name": "Preparar Consulta FSM Hoy"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "685d8535-a283-4d14-a517-31b6525dd70a",
              "leftValue": "={{$json.requiere_correccion}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        9648,
        -9616
      ],
      "id": "2154fe37-2527-4995-9a47-78606de8098b",
      "name": "¿Productos Necesitan Corrección?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n\nSET\n  esperando_confirmacion = 'correccion_productos',\n  ultimo_mensaje_bot = $2,\n  datos_pendientes = $3,\n  updated_at = NOW()\nWHERE chat_id = $1::bigint;",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,\n  $json.texto_correccion || 'Indica los productos correctos en un solo mensaje (nombre x cantidad, separados por comas).',\n  JSON.stringify({...($json.datos_pendientes || $json), travel_distance_km: ($json.datos_pendientes?.travel_distance_km || $json.travel_distance_km || 0), travel_time_hours: ($json.datos_pendientes?.travel_time_hours || $json.travel_time_hours || 0), productos_ambiguos: $json.productos_ambiguos, productos_validados: $json.productos_validados})\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        9840,
        -9920
      ],
      "id": "43cce02c-1f65-4204-9a32-132a7c869504",
      "name": "Guardar Corrección Productos Pendientes"
    },
    {
      "parameters": {
        "chatId": "={{ $items(\"Preparar Búsqueda Productos\", 0)[0].json.chat_id }}",
        "text": "={{ \n$items(\"Validar Productos1\", 0)[0].json.texto_correccion \n|| 'Indica los productos correctos en un solo mensaje (nombre x cantidad, separados por comas).' \n}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        10064,
        -9920
      ],
      "id": "a5ecc2fa-8eb6-4b09-9879-77316cec7f37",
      "name": "Pedir Corrección Productos",
      "webhookId": "correccion-productos-webhook-001"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "eea29d6e-6e10-4e9f-bff8-6a43619fd9c5",
              "leftValue": "={{$json.skip_registrar_horas !== true}}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        6464,
        -9488
      ],
      "id": "a9a8bda9-0af3-43c9-9670-99507126a536",
      "name": "¿Registra Horas?"
    },
    {
      "parameters": {
        "content": "## Consulta actividad usuario"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5232,
        -8384
      ],
      "typeVersion": 1,
      "id": "74be9ad7-854a-4059-9b21-65dd917798d4",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Consulta horas proyecto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5216,
        -7984
      ],
      "typeVersion": 1,
      "id": "e68c4bda-c32d-4303-a289-228819e156fd",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## Consulta horas tareas"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5232,
        -7600
      ],
      "typeVersion": 1,
      "id": "f721a85c-d8b8-476a-bde1-0a8a7dcd24fb",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Mensaje bienvenida"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5232,
        -8752
      ],
      "typeVersion": 1,
      "id": "2a57a46c-c815-4867-a026-dc643ff561d9",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## Mensaje fallback"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5216,
        -9104
      ],
      "typeVersion": 1,
      "id": "b51f33a9-9432-44f9-98ec-bfe861c5a9cd",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "jsCode": "// PROCESAR DATOS DE GASTO DEL AI AGENT — empleado_nombre = user_name + odoo_user para desambiguar\n// Los datos ya vienen procesados del AI Agent\nconst datos = $json;\n\nconsole.log('💰 === PROCESAR DATOS GASTO DEL AI AGENT ===');\nconsole.log('📥 Datos recibidos:', JSON.stringify(datos, null, 2));\n\n// Extraer datos del AI Agent\nlet importe = parseFloat(datos.importe) || 0;\nconst descripcionAI = datos.descripcion || 'Gasto registrado';\nconst fechaAI = datos.fecha || 'hoy';\nconst chatId = datos.chat_id;\nconst userName = (datos.user_name || 'Usuario').toString().trim(); // empleado_nombre = user_name\nconst userId = datos.user_id;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst mensajeOriginal = datos.mensaje_original || '';\n\n// Resolver odoo_user con fallbacks (lo usaremos para desambiguar empleados con mismo nombre)\nconst odooUser = (\n  datos.odoo_user\n  || datos.cliente_perfil?.login\n  || datos.cliente_perfil?.email\n  || datos.user_mail\n  || null\n)?.toString().trim() || null;\n\nconsole.log('💰 Importe del AI:', importe);\nconsole.log('📝 Descripción del AI:', descripcionAI);\nconsole.log('📅 Fecha del AI:', fechaAI);\nconsole.log('👤 empleado_nombre (user_name):', userName);\nconsole.log('📧 odoo_user (login/email para desambiguar):', odooUser);\n\n// 🔧 BACKUP: Si el AI Agent no detectó el importe, extraerlo del mensaje\nif (importe === 0 || !importe) {\n  console.log('⚠️ AI Agent no detectó importe, extrayendo del mensaje...');\n  const mensajeCompleto = mensajeOriginal;\n\n  // Patrones para detectar importes: 25€, 25 €, 25 euros, €25, etc.\n  const patronesImporte = [\n    /([0-9]+(?:[.,][0-9]{1,2})?)\\s*€/i,\n    /([0-9]+(?:[.,][0-9]{1,2})?)\\s*euros?/i,\n    /€\\s*([0-9]+(?:[.,][0-9]{1,2})?)/i,\n    /([0-9]+(?:[.,][0-9]{1,2})?)\\s*eur/i\n  ];\n\n  for (const patron of patronesImporte) {\n    const match = mensajeCompleto.match(patron);\n    if (match) {\n      const importeStr = match[1].replace(',', '.'); // Normalizar decimales\n      importe = parseFloat(importeStr);\n      console.log('✅ Importe extraído del mensaje:', importe, '€');\n      break;\n    }\n  }\n\n  if (importe === 0) {\n    console.log('❌ No se pudo extraer importe del mensaje');\n  }\n}\n\n// Procesar fecha\nlet fecha = new Date().toISOString().split('T')[0]; // Por defecto hoy\nif (fechaAI === 'ayer' || /\\bayer\\b/i.test(mensajeOriginal)) {\n  const ayer = new Date();\n  ayer.setDate(ayer.getDate() - 1);\n  fecha = ayer.toISOString().split('T')[0];\n}\n\n// ===== EMPLEADO =====\n// Requisito: empleado_nombre debe ser SIEMPRE el user_name.\n// Usaremos odoo_user por separado para desambiguar en la búsqueda (email/login).\nconst empleadoNombre = userName;\n\n// === Imagen/recibo adjunto ===\nlet tieneImagen = false;\nlet imagenFileId = null;\nlet imgData = null;\ntry {\n  // Obtener desde 'Extraer Datos' usando el nuevo campo img_data\n  const datosOriginales = $('Extraer Datos').first().json;\n  imgData = datosOriginales.img_data || null;\n  tieneImagen = datosOriginales.tiene_imagen || false;\n  imagenFileId = datosOriginales.imagen_file_id || null;\n\n  console.log('=== INFO IMAGEN DESDE EXTRAER DATOS ===');\n  console.log('Tiene imagen:', tieneImagen);\n  console.log('File ID:', imagenFileId);\n  console.log('Datos imagen completos (img_data):', imgData ? 'PRESENTE' : 'NO DISPONIBLE');\n\n  if (imgData) {\n    console.log('Detalles img_data:', JSON.stringify(imgData, null, 2));\n    console.log('File ID desde img_data:', imgData.file_id);\n    console.log('Tamaño archivo:', imgData.file_size);\n    console.log('Dimensiones:', imgData.width + 'x' + imgData.height);\n    console.log('Timestamp captura:', imgData.timestamp);\n  }\n} catch (e) {\n  console.log('ERROR: No se pudo obtener info de imagen desde Extraer Datos:', e.message);\n  // Fallback: intentar desde datos actuales si están disponibles\n  tieneImagen = datos.tiene_imagen || false;\n  imagenFileId = datos.imagen_file_id || null;\n  imgData = null;\n}\n\nconsole.log('📊 DATOS PROCESADOS:');\nconsole.log('💰 Importe:', importe);\nconsole.log('📅 Fecha:', fecha);\nconsole.log('📝 Descripción:', descripcionAI);\nconsole.log('👤 Empleado (por nombre):', empleadoNombre);\nconsole.log('📧 Empleado (odoo_user para desambiguar):', odooUser);\nconsole.log('📸 Imagen adjunta:', tieneImagen ? 'SÍ' : 'NO');\n\n// Validación mínima\nif (!importe || importe <= 0) {\n  throw new Error('❌ No se pudo extraer el importe del gasto. Importe recibido: ' + importe);\n}\n\nreturn {\n  datos_gasto: {\n    importe: importe,\n    descripcion: descripcionAI,\n    fecha: fecha,\n    chat_id: chatId,\n    user_name: userName,     // lo mantenemos\n    odoo_user: odooUser,     // ✅ clave para desambiguar en la búsqueda\n    user_id: userId,\n    empleado_nombre: empleadoNombre, // ✅ SIEMPRE el user_name\n    tiene_imagen: tieneImagen,\n    imagen_file_id: imagenFileId,\n    img_data: imgData        // campo completo de la imagen\n  },\n  uid: uid,\n  mensaje_usuario: mensajeOriginal\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5040,
        -6128
      ],
      "id": "e9850aef-b4c8-4c4e-9f21-700c11db54a0",
      "name": "Procesar Datos Gasto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id \n   || $json.datos_gasto?.chat_id\n   || $('Crear Gasto Simplificado').item.json.datos_gasto?.chat_id\n}}",
        "text": "=✅ **¡Gasto registrado exitosamente!**\n💰 **Importe:** {{ $('Crear Gasto Simplificado').item.json.datos_gasto.importe }}€\n📝 **Descripción:** {{ $('Crear Gasto Simplificado').item.json.datos_gasto.descripcion }}\n📅 **Fecha:** {{ $('Crear Gasto Simplificado').item.json.datos_gasto.fecha }}\n👤 **Empleado:** {{ $('Crear Gasto Simplificado').item.json.empleado.name }}\n🆔 **ID Gasto:** {{ $('Crear Gasto Odoo').item.json.result }}\n🔗 **Gasto:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $('Crear Gasto Odoo').item.json.result }}&model=hr.expense&view_type=form)\n\n¡Tu gasto ha sido registrado en Odoo! 😊\n\n📸 **{{ $json.imagen_adjuntada ? 'Foto adjunta procesada correctamente' : 'Gasto registrado sin foto' }}** ",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        8272,
        -6128
      ],
      "id": "54f2194a-0572-4dd1-88d6-2deb2df1f69f",
      "name": "Confirmar Gasto Creado",
      "webhookId": "confirmar-gasto-creado-001"
    },
    {
      "parameters": {
        "jsCode": "// BUSCAR EMPLEADO SIMPLIFICADO\nconst datos = $('Procesar Datos Gasto').item.json;\n\nconsole.log('🔍 === BUSCAR EMPLEADO SIMPLIFICADO ===');\nconsole.log('📥 Datos recibidos:', JSON.stringify(datos, null, 2));\n\nconst datosGasto = datos.datos_gasto;\nconst uid = datos.uid;\nlet empleadoNombre = datosGasto.empleado_nombre;\n\n// Si empleado_nombre está vacío, usar odoo_user como fallback\nif (!empleadoNombre || empleadoNombre.trim() === '') {\n    empleadoNombre = datosGasto.odoo_user;\n    console.log('ℹ️ Usando odoo_user como fallback:', empleadoNombre);\n}\n\nconsole.log('👤 Buscando empleado:', empleadoNombre);\n\n// Preparar consulta para buscar empleado directamente en hr.employee\nconst consultaEmpleado = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"hr.employee\",\n      \"search_read\",\n      [[\n        [\"name\", \"ilike\", empleadoNombre]\n      ]],\n      {\n        fields: [\"id\", \"name\", \"work_email\", \"user_id\"]\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Consulta empleado:', JSON.stringify(consultaEmpleado, null, 2));\n\nreturn {\n  consulta_empleado: consultaEmpleado,\n  datos_gasto: datosGasto,\n  empleado_nombre: empleadoNombre,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5232,
        -6128
      ],
      "id": "897f817f-cfca-437d-8849-021a9bc26044",
      "name": "Buscar Empleado Simplificado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_empleado }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5424,
        -6128
      ],
      "id": "c16e2493-6ae5-4861-8d60-5cde9c5f7fb8",
      "name": "HTTP Buscar Empleado"
    },
    {
      "parameters": {
        "jsCode": "// VERIFICAR EMPLEADO SIMPLIFICADO (desambiguar por odoo_user ↔ work_email)\nconst empleadosEncontrados = $json.result || [];\nconst datos = $('Buscar Empleado Simplificado').item.json;\nconst datosGasto = datos.datos_gasto || {};\nconst empleadoNombre = (datos.empleado_nombre || '').toString().trim();\nconst uid = datos.uid;\n\nconst odooUser = (datosGasto.odoo_user || '').toString().trim().toLowerCase();\n\nconsole.log('✅ === VERIFICAR EMPLEADO SIMPLIFICADO ===');\nconsole.log('👥 Empleados encontrados:', empleadosEncontrados.length);\nconsole.log('👤 Buscando por nombre:', empleadoNombre);\nconsole.log('📧 Desambiguando por odoo_user:', odooUser || '(no provisto)');\n\nif (empleadosEncontrados.length === 0) {\n  console.log('❌ No se encontró empleado');\n  return {\n    empleado_encontrado: false,\n    datos_gasto: datosGasto,\n    empleado_nombre: empleadoNombre,\n    uid: uid,\n    mensaje_error: `❌ No encontré al empleado \"${empleadoNombre}\" en Odoo.\\n\\n💰 Gasto: ${datosGasto.importe}€ por ${datosGasto.descripcion}\\n\\n🤔 Verifica el nombre del empleado o el email (odoo_user).`\n  };\n}\n\n// 1) Si tenemos odoo_user, priorizar coincidencia EXACTA con work_email\nlet candidato = null;\nif (odooUser) {\n  const exactEmailMatch = empleadosEncontrados.find(e =>\n    (e.work_email || '').toString().trim().toLowerCase() === odooUser\n  );\n  if (exactEmailMatch) {\n    candidato = exactEmailMatch;\n    console.log('🎯 Coincidencia EXACTA por work_email:', exactEmailMatch.work_email, 'ID:', exactEmailMatch.id);\n  }\n}\n\n// 2) Si no hay exacta, y hay varias, intentar coincidencia parcial por email\nif (!candidato && odooUser && empleadosEncontrados.length > 1) {\n  const [local, domain] = odooUser.split('@');\n  const parcial = empleadosEncontrados.find(e => {\n    const em = (e.work_email || '').toString().trim().toLowerCase();\n    return (local && em.includes(local)) || (domain && em.endsWith('@' + domain));\n  });\n  if (parcial) {\n    candidato = parcial;\n    console.log('🔎 Coincidencia PARCIAL por work_email:', parcial.work_email, 'ID:', parcial.id);\n  }\n}\n\n// 3) Si sigue sin candidato y hay un único resultado, tomarlo\nif (!candidato && empleadosEncontrados.length === 1) {\n  candidato = empleadosEncontrados[0];\n  console.log('✔️ Único resultado, seleccionado:', candidato.name, 'ID:', candidato.id);\n}\n\n// 4) Si no hay odoo_user y hay múltiples, intentar match EXACTO por nombre\nif (!candidato && !odooUser && empleadosEncontrados.length > 1) {\n  const exactName = empleadosEncontrados.find(e =>\n    (e.name || '').toString().trim().toLowerCase() === empleadoNombre.toLowerCase()\n  );\n  if (exactName) {\n    candidato = exactName;\n    console.log('🧭 Coincidencia EXACTA por nombre:', exactName.name, 'ID:', exactName.id);\n  }\n}\n\n// 5) Si aún ambiguo, devolver error con opciones para que el flujo lo maneje\nif (!candidato) {\n  const opciones = empleadosEncontrados.map(e => {\n    const email = e.work_email || 'sin email';\n    return `${e.name} <${email}> [id:${e.id}]`;\n  }).join('\\n- ');\n  const msg = `⚠️ Hay varias coincidencias para \"${empleadoNombre}\" y no se pudo desambiguar por email.\\n` +\n              (odooUser ? `Intenté casar con \"${odooUser}\".\\n` : 'No se proporcionó odoo_user para desambiguar.\\n') +\n              `\\nCoincidencias:\\n- ${opciones}\\n\\n` +\n              `💰 Gasto: ${datosGasto.importe}€ por ${datosGasto.descripcion}\\n` +\n              `👉 Indica el email exacto (odoo_user) o elige uno.`;\n\n  console.log('❌ Ambigüedad en empleados. Requiere intervención.', opciones);\n  return {\n    empleado_encontrado: false,\n    datos_gasto: datosGasto,\n    empleado_nombre: empleadoNombre,\n    uid: uid,\n    mensaje_error: msg\n  };\n}\n\n// ✅ Candidato elegido\nconsole.log('✅ Empleado seleccionado:', candidato.name, 'Email:', candidato.work_email, 'ID:', candidato.id);\n\nreturn {\n  empleado_encontrado: true,\n  empleado: candidato,\n  datos_gasto: datosGasto,\n  uid: uid\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5632,
        -6128
      ],
      "id": "fd9d678e-6e77-40a8-9777-02f0be5ae65c",
      "name": "Verificar Empleado Simplificado"
    },
    {
      "parameters": {
        "jsCode": "// CREAR GASTO SIMPLIFICADO — con manejo de error de empleado no encontrado\nconst empleadoEncontrado = $json.empleado_encontrado;\nconst empleado = $json.empleado;\nconst datosGasto = $json.datos_gasto;\nconst uid = $json.uid;\n\nconsole.log('💰 === CREAR GASTO SIMPLIFICADO ===');\n\n// Verificar si el empleado fue encontrado\nif (!empleadoEncontrado) {\n  console.log('❌ Empleado no encontrado, lanzando error para manejo del workflow');\n  const mensajeError = $json.mensaje_error || 'No se pudo encontrar el empleado';\n  \n  // Crear un error personalizado que incluya el chat_id para poder enviar el mensaje\n  const error = new Error(mensajeError);\n  error.chatId = datosGasto.chat_id;\n  error.description = JSON.stringify({\n    error: true,\n    chat_id: datosGasto.chat_id,\n    mensaje: mensajeError,\n    tipo: 'empleado_no_encontrado'\n  });\n  \n  throw error;\n}\n\nconsole.log('👤 Empleado:', empleado.name, '(ID:', empleado.id, ')');\nconsole.log('💵 Gasto:', datosGasto.importe, '€ -', datosGasto.descripcion);\nconsole.log('📅 Fecha:', datosGasto.fecha);\n\n// Crear gasto directamente en hr.expense\nconst consultaCrearGasto = {\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"hr.expense\",\n      \"create\",\n      [{\n        \"name\": datosGasto.descripcion,\n        \"total_amount_currency\": datosGasto.importe,\n        \"quantity\": 1.0,\n        \"date\": datosGasto.fecha,\n        \"employee_id\": empleado.id,\n        \"payment_mode\": \"own_account\",\n        \"product_id\": 1  // Categoría \"Gastos\" por defecto - ajustar ID según tu configuración\n      }]\n    ]\n  },\n  \"id\": Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  consulta_crear_gasto: consultaCrearGasto,\n  empleado: empleado,\n  datos_gasto: datosGasto,\n  uid: uid,\n  error: false\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6064,
        -6128
      ],
      "id": "b512eeee-9b87-4652-8a73-3dee1267ec6d",
      "name": "Crear Gasto Simplificado",
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_crear_gasto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6256,
        -6128
      ],
      "id": "cee93f04-81cb-405f-948b-f03c6eeac4d1",
      "name": "Crear Gasto Odoo",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ADJUNTAR IMAGEN AL GASTO - ACTIVO CON MANEJO DE ERROR\n// Verificar si hubo error en los nodos anteriores\nconst datosCrearGasto = $('Crear Gasto Simplificado').item.json;\n\n// Si el nodo anterior falló por empleado no encontrado\nif (datosCrearGasto.error) {\n  console.log('❌ === ERROR DETECTADO: Empleado no encontrado ===');\n  console.log('📤 Preparando mensaje de error para Telegram');\n  \n  // Extraer el mensaje de error del objeto error\n  let mensajeError = datosCrearGasto.mensaje_error || '❌ No se pudo crear el gasto.';\n  \n  // Si hay información del error en pairedItem\n  if ($json.error && $json.error.message) {\n    console.log('Error capturado:', $json.error.message);\n    mensajeError = $json.error.message;\n  }\n  \n  // Retornar datos para enviar mensaje de error por Telegram\n  return {\n    error_gasto: true,\n    chat_id: datosCrearGasto.datos_gasto?.chat_id,\n    mensaje_telegram: mensajeError,\n    tipo: 'error_empleado_no_encontrado'\n  };\n}\n\nconst gastoId = $json.result; // ID del gasto creado\nconst datosGasto = datosCrearGasto.datos_gasto;\nconst uid = datosCrearGasto.uid;\n\nconsole.log('🖼️ === ADJUNTAR IMAGEN - ACTIVO ===');\nconsole.log('Gasto ID:', gastoId);\nconsole.log('UID:', uid);\nconsole.log('Tiene imagen flag:', datosGasto.tiene_imagen);\n\n// Si no hay imagen, continuar sin ella\nif (!datosGasto.tiene_imagen) {\n  console.log('ℹ️ No hay imagen para adjuntar');\n  return {\n    gasto_id: gastoId,\n    datos_gasto: datosGasto,\n    imagen_adjuntada: false,\n    imagen_base64: null,\n    imagen_descargada: false,\n    uid: uid,\n    paso: 'sin_imagen',\n    mensaje: 'Gasto creado sin imagen'\n  };\n}\n\nconsole.log('📸 Preparando descarga de imagen...');\nconsole.log('🆔 File ID:', datosGasto.imagen_file_id);\n\n// Pasar datos para que el siguiente nodo descargue la imagen\nreturn {\n  gasto_id: gastoId,\n  datos_gasto: datosGasto,\n  imagen_file_id: datosGasto.imagen_file_id,\n  img_data: datosGasto.img_data,\n  uid: uid,\n  paso: 'descargar_imagen',\n  mensaje: 'Preparando descarga de imagen'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6560,
        -6128
      ],
      "id": "683bd565-d44e-4f5b-8db0-f065f2f968f8",
      "name": "Descargar y Adjuntar Imagen"
    },
    {
      "parameters": {
        "jsCode": "// CONSTRUIR URL DE DESCARGA CON FILE_PATH REAL\nconst datosAnteriores = $('Descargar y Adjuntar Imagen').item.json;\nconst getFileResponse = $('Obtener File Path Real').item.json;\n\n// Crear objeto debug\nconst debugInfo = {\n  paso: 'CONSTRUIR_URL_CON_FILE_PATH_REAL',\n  respuesta_getfile: getFileResponse,\n  tiene_result: !!getFileResponse.result,\n  file_path_recibido: getFileResponse.result ? getFileResponse.result.file_path : null\n};\n\n// Obtener file_path real de la respuesta de getFile\nlet filePath = null;\nif (getFileResponse.ok && getFileResponse.result && getFileResponse.result.file_path) {\n  filePath = getFileResponse.result.file_path;\n  debugInfo.file_path_extraido = filePath;\n} else {\n  debugInfo.error = 'No se pudo obtener file_path de la respuesta getFile';\n  debugInfo.respuesta_completa = getFileResponse;\n  return {\n    ...datosAnteriores,\n    ERROR: 'No se pudo obtener file_path real de la API de Telegram',\n    DEBUG_COMPLETO: debugInfo\n  };\n}\n\n// Construir URL completa de descarga\nconst tokenReal = '8163442849:AAFYMCxlzQ5z5ao6FT87GzIJhrUgVw1bu_s';\nconst downloadUrl = `https://api.telegram.org/file/bot${tokenReal}/${filePath}`;\n\ndebugInfo.url_construida = downloadUrl;\ndebugInfo.token_usado = 'TOKEN_REAL_CORRECTO';\n\nconst resultado = {\n  ...datosAnteriores,\n  file_path: filePath,\n  download_url: downloadUrl,\n  telegram_file_info: getFileResponse.result,\n  DEBUG_VISIBLE: debugInfo\n};\n\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6976,
        -6128
      ],
      "id": "078917ad-ea60-4d13-bf86-c577c5141d87",
      "name": "Construir URL Descarga",
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot8163442849:AAFYMCxlzQ5z5ao6FT87GzIJhrUgVw1bu_s/getFile?file_id={{ $('Descargar y Adjuntar Imagen').item.json.imagen_file_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6768,
        -6128
      ],
      "id": "095f8c0e-79e2-44a8-8c9e-c1c2e8a367bd",
      "name": "Obtener File Path Real",
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $json.download_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7168,
        -6128
      ],
      "id": "44498aa5-02d7-4b92-b6b8-edec53cc8492",
      "name": "Descargar Imagen HTTP",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR ADJUNTO DIRECTO DESDE DESCARGA HTTP\n// Metadatos desde el nodo que construye la URL\nconst datosAnteriores = $('Construir URL Descarga').item.json;\nconst gastoId = datosAnteriores.gasto_id;\nconst uid = datosAnteriores.uid || 2;\n\nconsole.log('📎 === PREPARAR ADJUNTO DIRECTO ===');\nconsole.log('Gasto ID:', gastoId);\nconsole.log('UID:', uid);\nconsole.log('🔗 download_url:', datosAnteriores.download_url);\n\n// Validar que tenemos el gasto ID\nif (!gastoId) {\n  throw new Error('gastoId es requerido para crear el adjunto');\n}\n\n// 1) Intento normal: binario del item actual\nlet bin = null;\nlet binKeys = Object.keys($binary || {});\nconsole.log('Binary keys (item actual):', binKeys);\n\nif (binKeys.length) {\n  bin = $binary[binKeys[0]];\n}\n\n// 2) Fallback: tomar binario explícitamente del nodo \"Descargar Imagen HTTP\"\nif (!bin || !bin.data) {\n  const httpItems = $items('Descargar Imagen HTTP', 0, 0) || [];\n  if (httpItems.length && httpItems[0].binary) {\n    const httpBinKeys = Object.keys(httpItems[0].binary);\n    console.log('Binary keys (desde \"Descargar Imagen HTTP\"):', httpBinKeys);\n    if (httpBinKeys.length) {\n      bin = httpItems[0].binary[httpBinKeys[0]];\n    }\n  }\n}\n\n// Si aún no hay binario, detallar por qué\nif (!bin || !bin.data) {\n  console.log('❌ No hay binario disponible.');\n  console.log('Resumen debug:', {\n    tieneBinaryActual: !!$binary,\n    keysBinaryActual: Object.keys($binary || {}),\n    tieneItemsHTTP: !!$items('Descargar Imagen HTTP', 0, 0)?.length,\n    jsonHTTP: $items('Descargar Imagen HTTP', 0, 0)?.[0]?.json || null,\n  });\n  throw new Error('No se encontraron datos binarios del archivo descargado');\n}\n\n// Convertir base64 → Buffer\nconst archivoBinario = Buffer.from(bin.data, 'base64');\nconsole.log('✅ Binario cargado:', archivoBinario.length, 'bytes');\n\n// Detectar tipo de archivo\nlet mimetype = bin.mimeType || 'image/jpeg';\nlet extension = bin.fileExtension || null;\n\n// Deducción por firma si falta extensión\nif (!extension) {\n  const firstBytes = archivoBinario.slice(0, 8);\n  const signature = firstBytes.toString('hex').toUpperCase();\n\n  if (signature.startsWith('89504E47')) {\n    mimetype = 'image/png';\n    extension = 'png';\n  } else if (signature.startsWith('FFD8FF')) {\n    mimetype = 'image/jpeg';\n    extension = 'jpg';\n  } else if (signature.startsWith('47494638')) {\n    mimetype = 'image/gif';\n    extension = 'gif';\n  } else if (signature.startsWith('52494646')) {\n    mimetype = 'image/webp';\n    extension = 'webp';\n  } else {\n    if (mimetype.includes('png')) extension = 'png';\n    else if (mimetype.includes('webp')) extension = 'webp';\n    else if (mimetype.includes('gif')) extension = 'gif';\n    else extension = 'jpg';\n  }\n}\n\nconsole.log('🖼️ Tipo detectado:', mimetype, 'Extensión:', extension);\n\n// Convertir a base64 para Odoo\nconst archivoBase64 = archivoBinario.toString('base64');\nconsole.log('✅ Convertido a base64:', archivoBase64.length, 'caracteres');\n\n// Crear nombre de archivo\nconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\nconst nombreArchivo = `Recibo-${timestamp}.${extension}`;\n\n// Preparar consulta para Odoo\nconst consultaAdjunto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      uid,\n      \"admin\",\n      \"ir.attachment\",\n      \"create\",\n      [{\n        name: nombreArchivo,\n        datas: archivoBase64,\n        res_model: 'hr.expense',\n        res_id: gastoId,\n        mimetype: mimetype,\n        type: 'binary'\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🎯 Adjunto preparado para Odoo');\nconsole.log('📄 Nombre:', nombreArchivo);\nconsole.log('📏 Tamaño:', archivoBinario.length, 'bytes');\n\nreturn {\n  gasto_id: gastoId,\n  datos_gasto: datosAnteriores.datos_gasto,\n  consulta_adjunto: consultaAdjunto,\n  imagen_adjuntada: true,\n  archivo_info: {\n    nombre: nombreArchivo,\n    mimetype: mimetype,\n    tamaño: archivoBinario.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7424,
        -6128
      ],
      "id": "bc40c148-a065-4b12-b35a-98ab13ef5ab3",
      "name": "Preparar Adjunto Directo",
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_adjunto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7680,
        -6128
      ],
      "id": "1fc73343-cae4-400a-8f0a-9d69dcbfd87f",
      "name": "HTTP Crear Adjunto Odoo",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// FINALIZAR ADJUNTO DE RECIBO\nconst adjuntoId = $json.result;\nconst datosAnteriores = $('Preparar Adjunto Directo').item.json;\n\nconsole.log('✅ === ADJUNTO COMPLETADO ===');\nconsole.log('🆔 Adjunto ID:', adjuntoId);\n\nreturn {\n  gasto_id: datosAnteriores.gasto_id,\n  datos_gasto: datosAnteriores.datos_gasto,\n  imagen_adjuntada: true,\n  adjunto_id: adjuntoId,\n  mensaje: 'Gasto creado con recibo adjuntado exitosamente'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8048,
        -6128
      ],
      "id": "78fc4565-323b-4fae-b9a1-57db5643342c",
      "name": "Finalizar Adjunto",
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aa3050fe-0829-419c-b963-1656907cb793",
              "leftValue": "={{ $json.empleado_encontrado }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        5824,
        -6128
      ],
      "id": "44fbd43e-a105-430f-94d3-7b7abef49295",
      "name": "¿Existe empleado?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id \n   || $json.datos_gasto?.chat_id\n   || $('Crear Gasto Simplificado').item.json.datos_gasto?.chat_id\n}}",
        "text": "={{ $('Verificar Empleado Simplificado').item.json.mensaje_error || '❌ Ha ocurrido un error. Por favor revisa el nombre del empleado.' }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6000,
        -5952
      ],
      "id": "c62ac088-1109-4cfc-90ac-3c970b9b6655",
      "name": "Empleado No Encontrado",
      "webhookId": "621a1ad0-bd5c-4899-aabf-3ac32ca741ef"
    },
    {
      "parameters": {
        "content": "## Consulta etapa proyectos/tareas\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5152,
        -6896
      ],
      "typeVersion": 1,
      "id": "1fce2992-0cbc-4df0-9c95-8e02ad16892e",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## Lista tareas diarias para registrara el PT"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5280,
        -10384
      ],
      "typeVersion": 1,
      "id": "ea0177ca-1a88-495c-89f3-3c0c067bfee8",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## Registra PT"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5104,
        -9600
      ],
      "typeVersion": 1,
      "id": "b50f2109-f3a2-4f56-89b8-e0bf8502366f",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## Crear gasto + imagen\n\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5040,
        -6256
      ],
      "typeVersion": 1,
      "id": "80b4f866-5d24-430f-a75d-a6a33b8bad04",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "detectar-fichaje",
              "leftValue": "={{$json.accion}}",
              "rightValue": "registrar_fichaje",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        5024,
        -5696
      ],
      "id": "a672ece7-ab54-450b-b4fa-6b50e3a4d3c7",
      "name": "¿Es Fichaje?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, user_name, user_mail, odoo_user FROM telegram_users WHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ [ parseInt($json.user_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5232,
        -5696
      ],
      "id": "a2155aa1-53e1-4787-9236-f49d54a5dca9",
      "name": "Consultar Usuario Fichaje"
    },
    {
      "parameters": {
        "jsCode": "// Construir mensaje de fichaje en formato Odoo\nconst datosFichaje = $('Procesar Respuesta').item.json;\nconst datosUsuario = $json; // fila de BD\n\nconst odooUser = datosUsuario.odoo_user || null;\nconst latitude = datosFichaje.latitude;\nconst longitude = datosFichaje.longitude;\n\nlet mensajeOdoo = '';\nif (latitude && longitude && odooUser) {\n  mensajeOdoo = `Fichar ubicacion: ${latitude}, ${longitude}\\nEmpleado: ${odooUser}`;\n} else {\n  mensajeOdoo = datosFichaje.mensaje_usuario || 'Fichar ubicacion';\n}\n\nconsole.log('📍 Mensaje de fichaje para Odoo:', mensajeOdoo);\n\nreturn {\n  ...datosFichaje,\n  ...datosUsuario,\n  odoo_user: odooUser,\n  tiene_odoo_user: !!(odooUser && String(odooUser).trim() !== ''),\n  mensaje_fichaje: mensajeOdoo,\n  latitude: latitude,\n  longitude: longitude\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5424,
        -5696
      ],
      "id": "b8d44df8-ffe7-4bed-8a09-b6a29eb505a3",
      "name": "Construir Mensaje Fichaje"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      $(\"Autenticar Odoo\").item.json.result,\n      \"admin\",\n      \"res.users\",\n      \"search_read\",\n      [[[\"login\", \"=\", $json.odoo_user]]],\n      { fields: [\"id\", \"name\", \"login\"], limit: 1 }\n    ]\n  },\n  id: 1\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5584,
        -5696
      ],
      "id": "d1019197-8f2f-4325-bb58-a33345c773ae",
      "name": "Obtener Employee ID"
    },
    {
      "parameters": {
        "jsCode": "const res = $json.result;\nconst user = Array.isArray(res) && res.length ? res[0] : null;\n\nif (!user) {\n  throw new Error(`No se encontró res.users con login=${$json.odoo_user}`);\n}\n\nreturn {\n  ...$input.all()[0].json,\n  odoo_user_id: user.id,\n  odoo_user_name: user.name,\n  odoo_user_login: user.login,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5792,
        -5696
      ],
      "id": "79c23de3-ff5f-48f8-8786-59249845c67b",
      "name": "Extraer Employee ID"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      $(\"Autenticar Odoo\").item.json.result,\n      \"admin\",\n      \"hr.attendance\",\n      \"create\",\n      [{\n        employee_id: $json.employee_id,\n        check_in: $json.check_in_odoo,\n        in_latitude: ($json.latitude ?? null),\n        in_longitude: ($json.longitude ?? null)\n      }]\n    ]\n  },\n  id: 1\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7200,
        -5504
      ],
      "id": "c23c2627-aa40-426b-b61e-30fcc3b4288d",
      "name": "Registrar Fichaje en Odoo"
    },
    {
      "parameters": {
        "jsCode": "const respuestaOdoo = $json;\n\n// ✅ Contexto “fijo” desde tu nodo clave\nconst ctx = $('Construir Mensaje Fichaje').item.json;\n\n// Tipo fichaje: del decisor (más fiable) y si no, del ctx\nconst tipo =\n  $('Decidir Entrada o Salida').item.json.tipo_fichaje ||\n  ctx.tipo_fichaje ||\n  'entrada';\n\nconst accionTxt = (tipo === 'salida') ? 'SALIDA REGISTRADA' : 'ENTRADA REGISTRADA';\n\n// ✅ Chat ID (y validación)\nconst chatId = ctx.chat_id;\nif (chatId === null || chatId === undefined || Number(chatId) === 0) {\n  throw new Error(`chat_id inválido para Telegram: ${chatId}`);\n}\n\n// ✅ Nombre empleado (mejor sacarlo del nodo donde lo calculas)\nconst empleado =\n  $('Extraer empleado').item.json.employee_name ||\n  ctx.employee_name ||\n  ctx.user_name ||\n  'Empleado';\n\nconst hora = new Date().toLocaleTimeString('es-ES');\nconst lat = ctx.latitude;\nconst lon = ctx.longitude;\n\nlet respuesta = '';\nif (respuestaOdoo.error) {\n  respuesta = `❌ Error al registrar fichaje: ${respuestaOdoo.error?.data?.message || 'Error desconocido'}`;\n} else {\n  respuesta =\n    `✅ **${accionTxt}**\\n` +\n    `👤 ${empleado}\\n` +\n    `🕐 ${hora}` +\n    (lat != null && lon != null ? `\\n📍 ${Number(lat).toFixed(6)}°, ${Number(lon).toFixed(6)}°` : '');\n}\n\nreturn {\n  chat_id: chatId,\n  texto: respuesta,\n  tipo_fichaje: tipo,\n  employee_name: empleado,\n  fichaje_ok: !respuestaOdoo.error,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7520,
        -5664
      ],
      "id": "080a8789-af86-499e-bd27-a57b9b91da35",
      "name": "Procesar Respuesta Fichaje"
    },
    {
      "parameters": {
        "chatId": "={{$json.chat_id}}",
        "text": "={{$json.texto}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        7728,
        -5664
      ],
      "id": "93773ee5-9d8b-4798-83cc-f7e2b009cb22",
      "name": "Enviar Fichaje Telegram",
      "webhookId": "deff32f0-c1bd-46c0-9afb-26e1c1a30738"
    },
    {
      "parameters": {
        "jsCode": "const toOdooDatetime = (d) => {\n  const dt = d ? new Date(d) : new Date();\n  const pad = (n) => String(n).padStart(2, '0');\n  return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;\n};\n\nreturn {\n  ...$json,\n  check_in_odoo: toOdooDatetime($json.check_in),\n  check_out_odoo: $json.check_out ? toOdooDatetime($json.check_out) : null,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6320,
        -5696
      ],
      "id": "6271551a-8b8e-4468-901e-65cf539ec0a4",
      "name": "Normalizar Fecha Odoo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      $(\"Autenticar Odoo\").item.json.result,\n      \"admin\",\n      \"hr.employee\",\n      \"search_read\",\n      [[[ \"user_id\", \"=\", $json.odoo_user_id ]]],\n      { fields: [\"id\", \"name\", \"user_id\"], limit: 1 }\n    ]\n  },\n  id: 1\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5984,
        -5696
      ],
      "id": "6de2fd64-3e4e-4afe-8163-26bc7b386b39",
      "name": "Buscar empleado"
    },
    {
      "parameters": {
        "jsCode": "const res = $json.result;\nconst emp = Array.isArray(res) && res.length ? res[0] : null;\n\nif (!emp) {\n  throw new Error(`No se encontró hr.employee asociado al user_id=${$json.odoo_user_id}`);\n}\n\nreturn {\n  ...$input.all()[0].json,\n  employee_id: emp.id,\n  employee_name: emp.name,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6144,
        -5696
      ],
      "id": "6d26f394-01a1-45c3-9ce4-b47afb953cc2",
      "name": "Extraer empleado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      $(\"Autenticar Odoo\").item.json.result,\n      \"admin\",\n      \"hr.attendance\",\n      \"search_read\",\n      [[\n        [\"employee_id\", \"=\", $json.employee_id],\n        [\"check_out\", \"=\", false]\n      ]],\n      { fields: [\"id\", \"check_in\"], order: \"check_in desc\", limit: 1 }\n    ]\n  },\n  id: 1\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6496,
        -5696
      ],
      "id": "a54f2a13-2f40-423e-b857-5eed57bb2972",
      "name": "Buscar sesión abierta"
    },
    {
      "parameters": {
        "jsCode": "const base = $('Normalizar Fecha Odoo').item.json;   // payload “bueno”\nconst res = $json.result;                            // respuesta del search_read\nconst abierto = Array.isArray(res) && res.length ? res[0] : null;\n\nreturn {\n  ...base,\n  attendance_abierto_id: abierto?.id ?? null,\n  tipo_fichaje: abierto ? \"salida\" : \"entrada\",\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6704,
        -5696
      ],
      "id": "46c58421-d5e0-4b85-8ab8-7d2de23dabbe",
      "name": "Decidir Entrada o Salida"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "ebae44b1-2590-4173-acb7-30d49a11b33c",
              "leftValue": "={{$json.tipo_fichaje}}",
              "rightValue": "salida",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        6912,
        -5696
      ],
      "id": "54cf06c9-4aa2-4c64-9ac2-6e94b639c23e",
      "name": "¿Es salida?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"mchecagoshawk-webinar-main-28403608\",\n      $(\"Autenticar Odoo\").item.json.result,\n      \"admin\",\n      \"hr.attendance\",\n      \"write\",\n      [\n        [ Number($json.attendance_abierto_id) ],\n        {\n          check_out: $json.check_out_odoo || $json.check_in_odoo || new Date().toISOString().slice(0,19).replace('T',' '),\n          out_latitude: ($json.latitude ?? null),\n          out_longitude: ($json.longitude ?? null)\n        }\n      ]\n    ]\n  },\n  id: 1\n}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7184,
        -5808
      ],
      "id": "7d120fd5-58be-406b-ab32-98bcd68c86c6",
      "name": "Cerrar Sesión"
    },
    {
      "parameters": {
        "content": "## Fichaje\n\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5024,
        -5824
      ],
      "typeVersion": 1,
      "id": "036b087f-c5b7-4a98-977b-73be7d1cb0a3",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"mchecagoshawk-webinar-main-28403608\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4960,
        -5264
      ],
      "id": "4976ae54-d1fe-40e1-87f0-5dcd403570c7",
      "name": "Autenticar Odoo LOPD"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta Odoo: tareas de apertura planificadas hoy\nconst routerData = $('Router de Acciones FIXED').first().json;\nconst uid = $json.result;\n\nif (!uid) throw new Error('Error en autenticación Odoo para LOPD');\n\nconst db = 'mchecagoshawk-webinar-main-28403608';\nconst pass = 'admin';\nconst hoy = new Date();\nconst fechaHoy = hoy.toLocaleDateString('en-CA', { timeZone: 'Europe/Madrid' });\nconst manana = new Date(hoy);\nmanana.setDate(manana.getDate() + 1);\nconst fechaManana = manana.toLocaleDateString('en-CA', { timeZone: 'Europe/Madrid' });\nconst inicioDia = `${fechaHoy} 00:00:00`;\nconst finDia = `${fechaManana} 00:00:00`;\n\nconst domain = [\n  ['planned_date_begin', '>=', inicioDia],\n  ['planned_date_begin', '<', finDia],\n  ['ticket_type', '=', 'apertura']\n];\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, pass,\n      'project.task', 'search_read',\n      [domain],\n      { fields: ['id', 'name', 'project_id', 'planned_date_begin', 'partner_id'], order: 'planned_date_begin asc', limit: 50 }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn {\n  payload,\n  chat_id: routerData.chat_id,\n  user_id: routerData.user_id,\n  user_name: routerData.user_name,\n  odoo_user: routerData.odoo_user\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5200,
        -5264
      ],
      "id": "d2ba02a9-7082-461e-9b34-b6bffa77c076",
      "name": "Preparar Consulta Tareas LOPD"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mchecagoshawk-webinar.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5440,
        -5264
      ],
      "id": "e6218acb-da83-477b-a665-7f4354cc10c9",
      "name": "HTTP Consultar Tareas LOPD"
    },
    {
      "parameters": {
        "jsCode": "// Formatear lista de tareas LOPD y preparar para guardar estado\nconst tareas = $json.result || $json.body?.result || [];\nconst contexto = $('Preparar Consulta Tareas LOPD').first().json;\nconst chatId = contexto.chat_id;\nconst tareasOpciones = tareas.map(t => ({\n  id: t.id,\n  nombre_completo: t.name || 'Sin nombre',\n  proyecto_id: t.project_id ? t.project_id[0] : null,\n  proyecto_nombre: t.project_id ? t.project_id[1] : '',\n  cliente: t.partner_id ? t.partner_id[1] : ''\n}));\n\nlet mensaje;\nif (tareasOpciones.length === 0) {\n  mensaje = '❌ No tienes tareas de apertura planificadas para hoy. No hay nada que firmar.';\n} else {\n  const lista = tareasOpciones.map((t, i) =>\n    `\\n${i + 1}️⃣ ${t.nombre_completo}${t.cliente ? ' - ' + t.cliente : ''}`\n  ).join('');\n  mensaje = `📋 **Tareas de apertura de hoy para firmar LOPD:**${lista}\\n\\n✍️ Responde con el número (1, 2, 3...) para obtener el enlace de firma.`;\n}\n\nreturn {\n  chat_id: chatId,\n  respuesta_usuario: mensaje,\n  tareas_opciones: tareasOpciones,\n  cantidad: tareasOpciones.length,\n  datos_pendientes: JSON.stringify({\n    esperando_confirmacion: tareasOpciones.length > 0 ? 'elegir_tarea_lopd' : null,\n    tareas_opciones: tareasOpciones\n  })\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5680,
        -5264
      ],
      "id": "fe0649d9-3bee-4d9d-bfa2-2d7e52a55c31",
      "name": "Preparar Lista LOPD"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n SET esperando_confirmacion = $2, ultimo_mensaje_bot = $3, datos_pendientes = $4, updated_at = NOW() WHERE chat_id = $1::bigint",
        "options": {
          "queryReplacement": "={{ [$json.chat_id, $json.cantidad > 0 ? 'elegir_tarea_lopd' : null, $json.respuesta_usuario, $json.cantidad > 0 ? $json.datos_pendientes : null] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        5920,
        -5264
      ],
      "id": "ccc83ef7-d356-4421-99f2-c6d354df3df4",
      "name": "Guardar Estado LOPD"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.respuesta_usuario }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        6160,
        -5264
      ],
      "id": "e2633b33-370e-4db2-a816-13dbac9c9434",
      "name": "Enviar Lista LOPD",
      "webhookId": "5e0c7e18-4997-4ea4-9ef4-e8ba61d491f3"
    },
    {
      "parameters": {
        "content": "## LOPD\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4960,
        -5424
      ],
      "typeVersion": 1,
      "id": "423d9ec5-ef99-4cff-a20e-b2906e0f9737",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        5968,
        -4736
      ],
      "id": "ac3f67ae-fb72-4d28-8385-15c5bce16700",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "content": "## envio masivo"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4944,
        -4720
      ],
      "typeVersion": 1,
      "id": "33184ba7-adf5-4554-8018-a0dcc79c3d41",
      "name": "Sticky Note13"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "shared": [
    {
      "updatedAt": "2026-02-18T07:38:00.953Z",
      "createdAt": "2026-02-18T07:38:00.953Z",
      "role": "workflow:owner",
      "workflowId": "oVkVDlKCeCfF8zPt",
      "projectId": "s4WYDaCaT1Iwz31l"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-02-18T07:42:08.180Z",
  "versionId": "859530e4-f0dc-4c2e-b1e8-7824aa44d47c"
}