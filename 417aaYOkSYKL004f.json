{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Preparar Datos Completos Tarea": {
      "main": [
        [
          {
            "node": "Flujo Crear Tarea y Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Horas Registradas": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Horas Directo": {
      "main": [
        [
          {
            "node": "Confirmar Horas Registradas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Horas Directo": {
      "main": [
        [
          {
            "node": "HTTP Registrar Horas Directo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Tarea No Existe": {
      "main": [
        [
          {
            "node": "Preguntar Crear Tarea Solamente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Tarea No Existe": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Tarea No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Proyecto No Existe": {
      "main": [
        [
          {
            "node": "Preguntar Crear Proyecto Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Proyecto No Existe": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Proyecto No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Tarea": {
      "main": [
        [
          {
            "node": "¿Tarea Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Tarea": {
      "main": [
        [
          {
            "node": "HTTP Buscar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyecto": {
      "main": [
        [
          {
            "node": "¿Proyecto Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Proyecto y Tarea Horas": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Datos Válidos para PostgreSQL?": {
      "main": [
        [
          {
            "node": "Insertar en PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Datos Inválidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos PostgreSQL": {
      "main": [
        [
          {
            "node": "Marcar Descuento Final",
            "type": "main",
            "index": 0
          },
          {
            "node": "¿Datos Válidos para PostgreSQL?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Contacto Creado": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Contacto Creado": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Contacto Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Contacto": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Contacto Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Contacto": {
      "main": [
        [
          {
            "node": "HTTP Crear Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Tarea Horas": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Tarea Horas": {
      "main": [
        [
          {
            "node": "Confirmar Tarea Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Horas Tarea Solo": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Tarea Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Horas Tarea Solo": {
      "main": [
        [
          {
            "node": "HTTP Registrar Horas Tarea Solo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Tarea Solo": {
      "main": [
        [
          {
            "node": "Preparar Horas Tarea Solo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Flujo Completo": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Flujo Completo": {
      "main": [
        [
          {
            "node": "Confirmar Flujo Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Horas Paso3": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Flujo Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registrar Horas Paso3": {
      "main": [
        [
          {
            "node": "HTTP Registrar Horas Paso3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Tarea Paso2": {
      "main": [
        [
          {
            "node": "Preparar Registrar Horas Paso3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Tarea Paso2": {
      "main": [
        [
          {
            "node": "HTTP Crear Tarea Paso2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Proyecto Paso1": {
      "main": [
        [
          {
            "node": "Preparar Crear Tarea Paso2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Confirmar Modificación": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Confirmación": {
      "main": [
        [
          {
            "node": "Telegram Confirmar Modificación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Contacto": {
      "main": [
        [
          {
            "node": "Formatear Confirmación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Nuevo Valor": {
      "main": [
        [
          {
            "node": "Actualizar Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Falta Nuevo Valor?": {
      "main": [
        [
          {
            "node": "Guardar Memoria Modificar Contacto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Nuevo Valor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Contacto": {
      "main": [
        [
          {
            "node": "¿Falta Nuevo Valor?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Modificar Contacto": {
      "main": [
        [
          {
            "node": "Buscar Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flujo Crear Tarea y Horas": {
      "main": [
        [
          {
            "node": "HTTP Crear Tarea Solo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flujo Crear Proyecto Tarea Horas": {
      "main": [
        [
          {
            "node": "HTTP Crear Proyecto Paso1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos Completos Proyecto": {
      "main": [
        [
          {
            "node": "Flujo Crear Proyecto Tarea Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo Completado": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Horas Automático": {
      "main": [
        [
          {
            "node": "Confirmar Todo Completado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registro Automático": {
      "main": [
        [
          {
            "node": "Registrar Horas Automático",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Tiene Horas Pendientes?": {
      "main": [
        [
          {
            "node": "Preparar Registro Automático",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Registro Horas Pendiente": {
      "main": [
        [
          {
            "node": "¿Tiene Horas Pendientes?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Tarea": {
      "main": [
        [
          {
            "node": "Verificar Registro Horas Pendiente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Procesar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Tarea Creada": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Tarea",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Tarea HTTP": {
      "main": [
        [
          {
            "node": "Confirmar Tarea Creada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Tarea": {
      "main": [
        [
          {
            "node": "Crear Tarea HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Proyecto No Existe para Tarea": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Proyecto Existe para Tarea?": {
      "main": [
        [
          {
            "node": "Preparar Crear Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Proyecto No Existe para Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Proyecto para Tarea": {
      "main": [
        [
          {
            "node": "¿Proyecto Existe para Tarea?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Proyecto para Tarea": {
      "main": [
        [
          {
            "node": "Consultar Proyecto para Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo Automático": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Completa",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Horas Automático Completo": {
      "main": [
        [
          {
            "node": "Confirmar Todo Automático",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registro Automático Completo": {
      "main": [
        [
          {
            "node": "Registrar Horas Automático Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Tarea Automática HTTP": {
      "main": [
        [
          {
            "node": "Preparar Registro Automático Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Tarea Automática": {
      "main": [
        [
          {
            "node": "Crear Tarea Automática HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Proyecto Creado": {
      "main": [
        [
          {
            "node": "Preparar Crear Tarea Automática",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Continuar con Tarea?": {
      "main": [
        [
          {
            "node": "Confirmar Proyecto Creado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Proyecto Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analizar Proyecto Creado": {
      "main": [
        [
          {
            "node": "¿Continuar con Tarea?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Proyecto HTTP": {
      "main": [
        [
          {
            "node": "Analizar Proyecto Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Proyecto": {
      "main": [
        [
          {
            "node": "Crear Proyecto HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Tarea Existe?": {
      "main": [
        [
          {
            "node": "Registrar Horas Directo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Tarea No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Proyecto Existe?": {
      "main": [
        [
          {
            "node": "Preparar Buscar Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Proyecto No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Contacto": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Contacto": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Contacto": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Contacto": {
      "main": [
        [
          {
            "node": "HTTP Consulta Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Ventas": {
      "main": [
        [
          {
            "node": "Generar Estadísticas Ventas por Período",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Ventas": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Estadísticas Ventas por Período": {
      "main": [
        [
          {
            "node": "Generar URL Gráfico Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar URL Gráfico Ventas": {
      "main": [
        [
          {
            "node": "Descargar Gráfico Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Gráfico Ventas": {
      "main": [
        [
          {
            "node": "Enviar Gráfico Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Gráfico Ventas": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Facturas Completo": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Pre-HTTP": {
      "main": [
        [
          {
            "node": "HTTP Info Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Info Facturas": {
      "main": [
        [
          {
            "node": "Debug Facturas Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Requiere Info Facturas?": {
      "main": [
        [
          {
            "node": "Debug Pre-HTTP",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Respuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Info Facturas": {
      "main": [
        [
          {
            "node": "¿Requiere Info Facturas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Ventas": {
      "main": [
        [
          {
            "node": "Preparar Consulta Líneas Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Líneas Productos": {
      "main": [
        [
          {
            "node": "HTTP Consulta Líneas Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Líneas Productos": {
      "main": [
        [
          {
            "node": "Combinar Ventas con Líneas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combinar Ventas con Líneas": {
      "main": [
        [
          {
            "node": "Calcular Comparación Mes Anterior",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Ventas": {
      "main": [
        [
          {
            "node": "HTTP Consulta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Producto": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Producto": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consultas Adicionales": {
      "main": [
        [
          {
            "node": "HTTP Stock Ubicaciones",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Ventas Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Ventas Producto": {
      "main": [
        [
          {
            "node": "Combinar Info Completa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combinar Info Completa": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Producto": {
      "main": [
        [
          {
            "node": "Preparar Consultas Adicionales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Producto": {
      "main": [
        [
          {
            "node": "HTTP Consulta Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Acciones": {
      "main": [
        [
          {
            "node": "Verificar Proyecto y Tarea Horas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar Datos Gasto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Crear Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar Proyecto para Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Producto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Ventas por Orden",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Ventas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Compras",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Facturas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Pagos Pendientes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Top Rankings",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Ranking Comerciales",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Ventas Perdidas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Contacto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Crear Contacto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Datos Completos Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Datos Completos Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Modificar Contacto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Mensaje Bienvenida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Horas Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Horas Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Actividad Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Verificar Datos Ausencias Completos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Eventos Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Visitantes Web",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Verificar Restricciones Usuario Venta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Crear Evento Calendario",
            "type": "main",
            "index": 0
          },
          {
            "node": "Leer Memoria Antes De Validar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Crear Evento Calendario",
            "type": "main",
            "index": 0
          },
          {
            "node": "Leer Memoria Antes De Validar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extraer Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extraer Datos Limitar Módulos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Procesar Datos Ausencia",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Leer Memoria Tickets",
            "type": "main",
            "index": 0
          },
          {
            "node": "Detectar Intención Tickets",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar Ticket para Mensaje",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Consultar Fabricaciones",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Pedido Compra",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar FSM Inventario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Normalizar Parte+Materiales FSM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FSM ▸ Preparar Datos Completos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FSM ▸ Preparar Datos Completos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Normalizar Parte+Materiales FSM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reformatear Reanudación FSM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Estado Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Estado Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Datos Transferencia Stock",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Detectar Número Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Interpretar Modificación Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Acción No Contemplada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router de Acciones FIXED": {
      "main": [
        [
          {
            "node": "Switch Acciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Respuesta": {
      "main": [
        [
          {
            "node": "Router de Acciones FIXED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos AI Agent": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          },
          {
            "node": "Procesando Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acción No Contemplada": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Acción No Contemplada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Ventas por Orden": {
      "main": [
        [
          {
            "node": "HTTP Consulta Ventas por Orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Ventas por Orden": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Ventas por Orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Ventas por Orden": {
      "main": [
        [
          {
            "node": "¿Consultar Líneas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Consultar Líneas?": {
      "main": [
        [
          {
            "node": "Preparar Consulta Líneas Orden",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Ventas por Orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Líneas Orden": {
      "main": [
        [
          {
            "node": "HTTP Consulta Líneas Orden",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Líneas Orden": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Final con Líneas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Final con Líneas": {
      "main": [
        [
          {
            "node": "Enviar Respuesta con Líneas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta con Líneas": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Ventas por Orden": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Compras": {
      "main": [
        [
          {
            "node": "HTTP Consulta Compras",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Compras": {
      "main": [
        [
          {
            "node": "Preparar Consulta Líneas Compras",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Compras": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Compras",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Líneas Compras": {
      "main": [
        [
          {
            "node": "HTTP Consulta Líneas Compras",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Líneas Compras": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Compras",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Compras": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Facturas": {
      "main": [
        [
          {
            "node": "HTTP Consulta Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Facturas": {
      "main": [
        [
          {
            "node": "Preparar Consulta Líneas Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Facturas": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Facturas": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Líneas Facturas": {
      "main": [
        [
          {
            "node": "HTTP Consulta Líneas Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Líneas Facturas": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Pagos Pendientes": {
      "main": [
        [
          {
            "node": "HTTP Consulta Pagos Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Pagos Pendientes": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Pagos Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Pagos Pendientes": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Pagos Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Pagos Pendientes": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Top Rankings": {
      "main": [
        [
          {
            "node": "HTTP Consulta Top Rankings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Top Rankings": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Top Rankings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Top Rankings": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Top Rankings",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Top Rankings": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Ventas Perdidas": {
      "main": [
        [
          {
            "node": "HTTP Consulta Ventas Perdidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Ventas Perdidas": {
      "main": [
        [
          {
            "node": "Formatear Análisis Ventas Perdidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Análisis Ventas Perdidas": {
      "main": [
        [
          {
            "node": "Enviar Análisis Ventas Perdidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Análisis Ventas Perdidas": {
      "main": [
        [
          {
            "node": "Generar Gráfico Donut Ventas Perdidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Gráfico Donut Ventas Perdidas": {
      "main": [
        [
          {
            "node": "Generar URL Gráfico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar URL Gráfico": {
      "main": [
        [
          {
            "node": "Descargar Imagen Gráfico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Imagen Gráfico": {
      "main": [
        [
          {
            "node": "Envio grafico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Envio grafico": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Horas Proyecto": {
      "main": [
        [
          {
            "node": "HTTP Consulta Horas Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Horas Tarea": {
      "main": [
        [
          {
            "node": "HTTP Consulta Horas Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Horas Proyecto": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Horas Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Horas Proyecto": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Horas Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Horas Proyecto": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Horas Tarea": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Horas Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Horas Tarea": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Horas Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Horas Tarea": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Actividad Usuario": {
      "main": [
        [
          {
            "node": "HTTP Consulta Actividad Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Actividad Usuario": {
      "main": [
        [
          {
            "node": "Procesar Búsqueda Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Actividad Usuario": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Actividad Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Actividad Usuario": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Búsqueda Usuario": {
      "main": [
        [
          {
            "node": "HTTP Consulta Actividad Usuario Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Actividad Usuario Final": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Actividad Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Eventos Usuario": {
      "main": [
        [
          {
            "node": "HTTP Buscar Usuario Eventos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Usuario Eventos": {
      "main": [
        [
          {
            "node": "Procesar Usuario y Consultar Eventos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Usuario y Consultar Eventos": {
      "main": [
        [
          {
            "node": "HTTP Consulta Eventos Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Eventos Final": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Eventos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Eventos": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Eventos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Eventos": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Comparación Mes Anterior": {
      "main": [
        [
          {
            "node": "HTTP Consultar Mes Anterior",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Mes Anterior": {
      "main": [
        [
          {
            "node": "Procesar Comparación Porcentual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Comparación Porcentual": {
      "main": [
        [
          {
            "node": "Preparar Info Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Usuario Odoo": {
      "main": [
        [
          {
            "node": "Autenticar Odoo Registro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo Registro": {
      "main": [
        [
          {
            "node": "Preparar Verificar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Verificar Usuario": {
      "main": [
        [
          {
            "node": "HTTP Verificar Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Verificar Usuario Odoo": {
      "main": [
        [
          {
            "node": "Evaluar Existencia Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Evaluar Existencia Usuario": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Usuario Telegram": {
      "main": [
        [
          {
            "node": "Mensaje Usuario Registrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Usuario Registrado": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Ranking Comerciales": {
      "main": [
        [
          {
            "node": "HTTP Consultar Facturas Comerciales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Facturas Comerciales": {
      "main": [
        [
          {
            "node": "Formatear Ranking Comerciales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Ranking Comerciales": {
      "main": [
        [
          {
            "node": "Enviar Ranking Comerciales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Ranking Comerciales": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Visitantes Web": {
      "main": [
        [
          {
            "node": "HTTP Visitantes Web",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Visitantes Web": {
      "main": [
        [
          {
            "node": "Procesar Visitantes Web",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Visitantes Web": {
      "main": [
        [
          {
            "node": "Formatear Visitantes Web",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Visitantes Web": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Visitantes Web",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Visitantes Web": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Datos Gasto": {
      "main": [
        [
          {
            "node": "Buscar Empleado Simplificado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Gasto Creado": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Restricciones Usuario Venta": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Pedido Venta": {
      "main": [
        [
          {
            "node": "Buscar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Cliente": {
      "main": [
        [
          {
            "node": "HTTP Buscar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Cliente": {
      "main": [
        [
          {
            "node": "Procesar Cliente Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Cliente Encontrado": {
      "main": [
        [
          {
            "node": "Preparar Búsqueda Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Pedido Venta": {
      "main": [
        [
          {
            "node": "¿Confirmación Sí?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Requiere Corrección Pedido?": {
      "main": [
        [
          {
            "node": "Preparar Memoria Corrección Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Crear Pedido Venta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Memoria Corrección Pedido": {
      "main": [
        [
          {
            "node": "Guardar Memoria Corrección Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Corrección Pedido": {
      "main": [
        [
          {
            "node": "Enviar Correcciones Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Confirmación Sí?": {
      "main": [
        [
          {
            "node": "HTTP Crear Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Confirmación Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Confirmación Pedido": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Pedido Venta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Pedido Venta": {
      "main": [
        [
          {
            "node": "Enviar Confirmación Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Pedido": {
      "main": [
        [
          {
            "node": "Mensaje para Admins de Nuevo Pedido",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Leer Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Pedido": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Evento Calendario": {
      "main": [
        [
          {
            "node": "¿Datos Completos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Datos Completos?": {
      "main": [
        [
          {
            "node": "Buscar Participantes Evento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Evento Incompleto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Participantes Evento": {
      "main": [
        [
          {
            "node": "HTTP Buscar Participantes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Participantes": {
      "main": [
        [
          {
            "node": "Preparar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Evento": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Evento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Evento": {
      "main": [
        [
          {
            "node": "¿Evento creado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Evento": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos Limitar Módulos": {
      "main": [
        [
          {
            "node": "Verificar Admin Ejecutor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Admin Ejecutor": {
      "main": [
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario Objetivo": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Auto-Limitación Simple": {
      "main": [
        [
          {
            "node": "Actualizar Módulos Restringidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Módulos Restringidos": {
      "main": [
        [
          {
            "node": "Mensaje Limitación Exitosa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Limitación Exitosa": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Actualizar Usuario Telegram",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Usuario No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Buscar Usuario Objetivo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Error No Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Validar Auto-Limitación Simple",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Usuario No Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Mensaje Sin Acceso Ventas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Tiene Dirección Para Pedido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Datos Ausencia": {
      "main": [
        [
          {
            "node": "Buscar Empleado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Ausencia Creada": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Tickets": {
      "main": [
        [
          {
            "node": "HTTP Tickets Abiertos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Tickets Abiertos": {
      "main": [
        [
          {
            "node": "HTTP Tickets Cerrados 7 Días",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Tickets Cerrados 7 Días": {
      "main": [
        [
          {
            "node": "HTTP Tickets Abiertos 7 Días",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Tickets Abiertos 7 Días": {
      "main": [
        [
          {
            "node": "HTTP Tickets Todos Estados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Tickets Todos Estados": {
      "main": [
        [
          {
            "node": "HTTP Listado Abiertos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consolidar Resultados Tickets": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Tickets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Tickets": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Ticket para Mensaje": {
      "main": [
        [
          {
            "node": "HTTP Buscar Ticket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Ticket": {
      "main": [
        [
          {
            "node": "Validar Ticket y Preparar Mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Ticket y Preparar Mensaje": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Añadir Mensaje Chatter": {
      "main": [
        [
          {
            "node": "Confirmar Mensaje Añadido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Mensaje Añadido": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "HTTP Añadir Mensaje Chatter",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Ticket No Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Fabricaciones": {
      "main": [
        [
          {
            "node": "HTTP Fabricaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Fabricaciones": {
      "main": [
        [
          {
            "node": "Procesar Fabricaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Fabricaciones": {
      "main": [
        [
          {
            "node": "Telegram Fabricaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Fabricaciones": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Pedido Compra": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proveedor Compra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proveedor Compra": {
      "main": [
        [
          {
            "node": "Procesar Proveedor y Preparar Productos Compra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Proveedor y Preparar Productos Compra": {
      "main": [
        [
          {
            "node": "HTTP Buscar Productos Compra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Productos Compra": {
      "main": [
        [
          {
            "node": "Crear Pedido Compra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Pedido Compra": {
      "main": [
        [
          {
            "node": "HTTP Crear Pedido Compra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Pedido Compra": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Pedido Compra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Pedido Compra": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Pedido Compra",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Pedido Compra": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marcar Descuento Final": {
      "main": [
        [
          {
            "node": "¿Descontar Ahora?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Descontar Ahora?": {
      "main": [
        [
          {
            "node": "Descontar Consulta Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos": {
      "main": [
        [
          {
            "node": "HTTP Crear Evento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Modificar Contacto": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Modificar Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Modificar Contacto": {
      "main": [
        [
          {
            "node": "Pedir Nuevo Valor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pedir Nuevo Valor": {
      "main": [
        [
          {
            "node": "Telegram Pedir Nuevo Valor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Datos Ausencias Completos": {
      "main": [
        [
          {
            "node": "¿Datos Ausencias Completos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Datos Ausencias Completos?": {
      "main": [
        [
          {
            "node": "Preparar Consulta Ausencias1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Ausencias Incompletas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Ausencias": {
      "main": [
        [
          {
            "node": "Telegram Solicitar Datos Ausencias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Ausencias Incompletas": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Ausencias",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Ausencias1": {
      "main": [
        [
          {
            "node": "HTTP Consulta Ausencias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Ausencias1": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Ausencias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Ausencias1": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Ausencias1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Ausencias1": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Evento Incompleto": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Evento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Evento": {
      "main": [
        [
          {
            "node": "Enviar Mensaje Evento Incompleto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Evento creado?": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Evento",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Evento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Evento": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Evento",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Listado Abiertos": {
      "main": [
        [
          {
            "node": "HTTP Listado Cerrados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Estado Ticket": {
      "main": [
        [
          {
            "node": "Consolidar Resultados Tickets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detectar Intención Tickets": {
      "main": [
        [
          {
            "node": "Preparar Consulta Tickets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Listado Cerrados": {
      "main": [
        [
          {
            "node": "HTTP Estado Ticket",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar FSM Inventario": {
      "main": [
        [
          {
            "node": "Preparar FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Parte+Materiales FSM": {
      "main": [
        [
          {
            "node": "Preparar Buscar Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Datos Completos": {
      "main": [
        [
          {
            "node": "Preparar Buscar Usuario Odoo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Flujo Crear Proyecto": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Crear Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Crear Proyecto": {
      "main": [
        [
          {
            "node": "Proyecto ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Crear Tarea": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Crear Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Crear Tarea": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Registrar Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Registrar Horas": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Buscar Clientee",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Nota Materiales": {
      "main": [
        [
          {
            "node": "FSM ▸ ¿Hay materiales?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ ¿Hay materiales?": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Nota Materiales",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FSM ▸ Limpiar & Resumen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Nota Materiales": {
      "main": [
        [
          {
            "node": "Buscar Almacén1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Limpiar & Resumen": {
      "main": [
        [
          {
            "node": "Limpiar Memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Confirmar Flujo": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Leer Compañía": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Leer Compañía",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Leer Compañía": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Buscar Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Validar Cliente": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Leer Compañía",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Buscar Clientee": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Buscar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Buscar Cliente": {
      "main": [
        [
          {
            "node": "FSM ▸ Resolver Cliente ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Resolver Cliente ID": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Asignar Cliente a Tarea (FSM)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Asignar Cliente a Tarea (FSM)": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Asignar Cliente a Tarea (FSM)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Asignar Cliente a Tarea (FSM)": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Registrar Horas (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Registrar Horas (final)": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Registrar Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Registrar Horas": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Nota Materiales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Búsqueda Productos": {
      "main": [
        [
          {
            "node": "HTTP Buscar Productos FIXED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Productos FIXED": {
      "main": [
        [
          {
            "node": "Preparar Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje para Admins de Nuevo Pedido": {
      "main": [
        [
          {
            "node": "Listar Admins Para Mandar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Admins Para Mandar Pedido": {
      "main": [
        [
          {
            "node": "Avisar Admin Nuevo Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reformatear Reanudación FSM": {
      "main": [
        [
          {
            "node": "Preparar FSM Inventario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Pedido": {
      "main": [
        [
          {
            "node": "Preparar Guardar Pedido Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Productos": {
      "main": [
        [
          {
            "node": "¿Correcciones Recibidas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Correcciones Recibidas?": {
      "main": [
        [
          {
            "node": "Normalizar Memoria",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Requiere Corrección Pedido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Leer Memoria Corrección Pedido": {
      "main": [
        [
          {
            "node": "Fusionar Correcciones con Original",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fusionar Correcciones con Original": {
      "main": [
        [
          {
            "node": "Limpiar Espera Corrección Pedido",
            "type": "main",
            "index": 0
          },
          {
            "node": "Volver A Búsqueda Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Memoria": {
      "main": [
        [
          {
            "node": "Leer Memoria Corrección Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Productos FIXED1": {
      "main": [
        [
          {
            "node": "Crear Pedido Venta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Volver A Búsqueda Productos": {
      "main": [
        [
          {
            "node": "HTTP Buscar Productos FIXED1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Datos Transcripción": {
      "main": [
        [
          {
            "node": "Verificar Usuario Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Transcripción": {
      "main": [
        [
          {
            "node": "Actualizar Datos Transcripción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Transcripción": {
      "main": [
        [
          {
            "node": "Confirmar Transcripción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Audio": {
      "main": [
        [
          {
            "node": "HTTP Request - Upload Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Descarga": {
      "main": [
        [
          {
            "node": "Descargar Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Archivo de Voz": {
      "main": [
        [
          {
            "node": "Preparar Descarga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Audio?": {
      "main": [
        [
          {
            "node": "Obtener Archivo de Voz",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Verificar Usuario Existente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Verificación BD": {
      "main": [
        [
          {
            "node": "Verificar Historial Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Chat ID": {
      "main": [
        [
          {
            "node": "Preparar Verificación BD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Historial Usuario": {
      "main": [
        [
          {
            "node": "IF Tiene Historial",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Tiene Historial": {
      "main": [
        [
          {
            "node": "Verificar Último Mensaje Bot",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cargar Perfil Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Último Mensaje Bot": {
      "main": [
        [
          {
            "node": "Preparar Datos para IF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos para IF": {
      "main": [
        [
          {
            "node": "Acceso a memoria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Memoria PostgreSQL": {
      "main": [
        [
          {
            "node": "Cargar Perfil Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo": {
      "main": [
        [
          {
            "node": "Obtener Chat ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos": {
      "main": [
        [
          {
            "node": "¿Mensaje Es Dirección?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Upload Audio": {
      "main": [
        [
          {
            "node": "HTTP Request - Create Transcript (ES)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Create Transcript (ES)": {
      "main": [
        [
          {
            "node": "Esperar Transcripción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Get Transcript": {
      "main": [
        [
          {
            "node": "Procesar Transcripción",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar Transcripción": {
      "main": [
        [
          {
            "node": "HTTP Request - Get Transcript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acceso a memoria": {
      "main": [
        [
          {
            "node": "Consultar Memoria PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cargar Perfil Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Resumen Diario 8:00 AM": {
      "main": [
        [
          {
            "node": "Preparar Resumen Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Resumen Diario": {
      "main": [
        [
          {
            "node": "Consultar Usuarios Registrados y Validados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Usuario Existente": {
      "main": [
        [
          {
            "node": "PostgreSQL Verificar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Resultado Verificación": {
      "main": [
        [
          {
            "node": "¿Usuario Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usuario Ya Existe": {
      "main": [
        [
          {
            "node": "PostgreSQL Actualizar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL Actualizar Usuario": {
      "main": [
        [
          {
            "node": "Limpiar Datos Registro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registro Usuario": {
      "main": [
        [
          {
            "node": "PostgreSQL Registrar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL Registrar Usuario": {
      "main": [
        [
          {
            "node": "Mensaje nuevo registro sin user",
            "type": "main",
            "index": 0
          },
          {
            "node": "Mensaje para Admins de Nuevo Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Datos Registro": {
      "main": [
        [
          {
            "node": "Consultar Límite Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Usuario Telegram": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Sin Usuario Odoo": {
      "main": [
        [
          {
            "node": "Autenticar Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo para Resumen": {
      "main": [
        [
          {
            "node": "Preparar Consulta Eventos Diarios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Eventos Diarios": {
      "main": [
        [
          {
            "node": "HTTP Consultar Eventos Diarios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Eventos Diarios": {
      "main": [
        [
          {
            "node": "Preparar Consulta Órdenes Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Órdenes Pendientes": {
      "main": [
        [
          {
            "node": "HTTP Consultar Órdenes Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Órdenes Pendientes": {
      "main": [
        [
          {
            "node": "Formatear Resumen Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Resumen Diario": {
      "main": [
        [
          {
            "node": "Preparar Envío Masivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Envío Masivo": {
      "main": [
        [
          {
            "node": "Bucle por Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Bucle por Usuario": {
      "main": [
        [],
        [
          {
            "node": "Preparar Mensaje Individual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Mensaje Individual": {
      "main": [
        [
          {
            "node": "Consultar Eventos Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Eventos Usuario": {
      "main": [
        [
          {
            "node": "HTTP Eventos Personalizados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Eventos Personalizados": {
      "main": [
        [
          {
            "node": "Preparar Consulta Tareas Ayer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Tareas Ayer": {
      "main": [
        [
          {
            "node": "HTTP Consultar Tareas Ayer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consultar Tareas Ayer": {
      "main": [
        [
          {
            "node": "Formatear Resumen Personalizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Resumen Personalizado": {
      "main": [
        [
          {
            "node": "Telegram Envío Individual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Envío Individual": {
      "main": [
        [
          {
            "node": "Vaciar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vaciar": {
      "main": [
        [
          {
            "node": "Bucle por Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PostgreSQL Verificar Usuario": {
      "main": [
        [
          {
            "node": "Procesar Resultado Verificación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Usuario Pasando Mail?": {
      "main": [
        [
          {
            "node": "Extraer y Validar Correo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Tiene Imagen?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer y Validar Correo": {
      "main": [
        [
          {
            "node": "¿Correo Válido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Correo Válido?": {
      "main": [
        [
          {
            "node": "Actualizar Correo en BD",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Correo Inválido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Correo en BD": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Correo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Correo": {
      "main": [
        [
          {
            "node": "Confirmar Correo al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Correo al Usuario": {
      "main": [
        [
          {
            "node": "Notificar Admin Correo Recibido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Tiene Imagen?": {
      "main": [
        [
          {
            "node": "Descargar Imagen Inmediatamente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Imagen Inmediatamente": {
      "main": [
        [
          {
            "node": "Procesar Imagen Descargada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Imagen Descargada": {
      "main": [
        [
          {
            "node": "¿Es Audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Autenticar Odoo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Sin Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Informe Semanal Lunes 10:00": {
      "main": [
        [
          {
            "node": "Preparar Informe Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Informe Semanal": {
      "main": [
        [
          {
            "node": "Consultar Usuarios Registrados y Validados Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo para Resumen Semanal": {
      "main": [
        [
          {
            "node": "Preparar Consultas Semanales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consultas Semanales": {
      "main": [
        [
          {
            "node": "HTTP Ventas Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Ventas Semana": {
      "main": [
        [
          {
            "node": "Guardar Ventas Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Ventas Semana": {
      "main": [
        [
          {
            "node": "HTTP Leads Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Leads Semana": {
      "main": [
        [
          {
            "node": "Guardar Leads Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Leads Semana": {
      "main": [
        [
          {
            "node": "HTTP Tickets Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Tickets Semana": {
      "main": [
        [
          {
            "node": "Guardar Tickets Semana",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Tickets Semana": {
      "main": [
        [
          {
            "node": "Formatear Informe Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Informe Semanal": {
      "main": [
        [
          {
            "node": "Enviar Informe Semanal Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Límite Usuario": {
      "main": [
        [
          {
            "node": "Aplicar Límite Consultas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Límite Consultas": {
      "main": [
        [
          {
            "node": "¿Puede Continuar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Puede Continuar?": {
      "main": [
        [
          {
            "node": "Consultar Usuario Telegram",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aviso Bloqueo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listar Admins": {
      "main": [
        [
          {
            "node": "Avisar Admin Nuevo Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje para Admins de Nuevo Usuario": {
      "main": [
        [
          {
            "node": "Listar Admins",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Usuario Existe?": {
      "main": [
        [
          {
            "node": "Preparar Registro Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Usuario Ya Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Comando Validar?": {
      "main": [
        [
          {
            "node": "¿Es Admin?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Usuario Pasando Mail?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es Admin?": {
      "main": [
        [
          {
            "node": "¿Admin Autorizado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Admin Autorizado?": {
      "main": [
        [
          {
            "node": "Parsear Objetivo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No autorizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parsear Objetivo": {
      "main": [
        [
          {
            "node": "Buscar Usuario Por Nombre",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario Por Nombre": {
      "main": [
        [
          {
            "node": "¿Encontrado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Encontrado?": {
      "main": [
        [
          {
            "node": "¿Tiene Mail?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Validar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Tiene Mail?": {
      "main": [
        [
          {
            "node": "Autenticar Odoo Validación",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Solicitar Mail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Solicitar Mail": {
      "main": [
        [
          {
            "node": "Solicitar Mail Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Solicitar Mail Usuario": {
      "main": [
        [
          {
            "node": "Confirmar Solicitud Mail al Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generar Login Odoo": {
      "main": [
        [
          {
            "node": "Verificar Login Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Login Existe": {
      "main": [
        [
          {
            "node": "Ajustar Login Si Necesario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ajustar Login Si Necesario": {
      "main": [
        [
          {
            "node": "Validar Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Usuario": {
      "main": [
        [
          {
            "node": "Preservar Datos Usuario",
            "type": "main",
            "index": 0
          },
          {
            "node": "Confirmar al Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preservar Datos Usuario": {
      "main": [
        [
          {
            "node": "Autenticar Odoo Creación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo Validación": {
      "main": [
        [
          {
            "node": "Verificar Usuario Existe Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo Creación": {
      "main": [
        [
          {
            "node": "Preparar Crear Partner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Usuario Existe Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Verificación Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Verificación Usuario": {
      "main": [
        [
          {
            "node": "¿Usuario Ya Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Usuario Ya Existe?": {
      "main": [
        [
          {
            "node": "Notificar Usuario Ya Existe",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generar Login Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notificar Usuario Ya Existe": {
      "main": [
        [
          {
            "node": "Notificar Admin Usuario Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Partner": {
      "main": [
        [
          {
            "node": "Crear Partner Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Partner Odoo": {
      "main": [
        [
          {
            "node": "Buscar Grupo Portal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Grupo Portal": {
      "main": [
        [
          {
            "node": "Obtener Grupo Portal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Grupo Portal": {
      "main": [
        [
          {
            "node": "Combinar Datos Grupo Portal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combinar Datos Grupo Portal": {
      "main": [
        [
          {
            "node": "Preparar Crear Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Usuario Odoo": {
      "main": [
        [
          {
            "node": "Crear Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Usuario Odoo": {
      "main": [
        [
          {
            "node": "Preparar Datos Finales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos Finales": {
      "main": [
        [
          {
            "node": "Avisar Usuario Validado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Avisar Usuario Validado": {
      "main": [
        [
          {
            "node": "Mensaje de Inicio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Usuarios Registrados y Validados": {
      "main": [
        [
          {
            "node": "Autenticar Odoo para Resumen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Usuarios Registrados y Validados Semanal": {
      "main": [
        [
          {
            "node": "Autenticar Odoo para Resumen Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cargar Perfil Usuario": {
      "main": [
        [
          {
            "node": "Preparar Datos AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Plantilla": {
      "main": [
        [
          {
            "node": "Payload Buscar Variante por Plantilla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Variante por Plantilla": {
      "main": [
        [
          {
            "node": "Payload Buscar Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Validación Picking": {
      "main": [
        [
          {
            "node": "¿Requiere Validación?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Confirmar Picking": {
      "main": [
        [
          {
            "node": "Pasar a Validar Picking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Validar Picking": {
      "main": [
        [
          {
            "node": "Resolver Validación1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolver Validación1": {
      "main": [
        [
          {
            "node": "¿Hay Wizard De Transferencia?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta1": {
      "main": [
        [
          {
            "node": "Confirmar FSM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar FSM1": {
      "main": [
        [
          {
            "node": "Limpiar Memoria FSM Inventario",
            "type": "main",
            "index": 0
          },
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Requiere Validación?": {
      "main": [
        [
          {
            "node": "HTTP Confirmar Picking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Respuesta1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Hay Wizard De Transferencia?": {
      "main": [
        [
          {
            "node": "HTTP Procesar Transfer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Respuesta1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Producto": {
      "main": [
        [
          {
            "node": "Resolver Coincidencias Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Ubicación Interna": {
      "main": [
        [
          {
            "node": "Merge Ubicaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Ubicación Proveedor": {
      "main": [
        [
          {
            "node": "Merge Ubicaciones",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "HTTP PickingType Entrada": {
      "main": [
        [
          {
            "node": "Merge Ubicaciones",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "HTTP Crear Operación": {
      "main": [
        [
          {
            "node": "Preparar Validación Picking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Procesar Transfer": {
      "main": [
        [
          {
            "node": "Formatear Respuesta1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payload Buscar Plantilla": {
      "main": [
        [
          {
            "node": "HTTP Buscar Plantilla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payload Buscar Variante por Plantilla": {
      "main": [
        [
          {
            "node": "HTTP Buscar Variante por Plantilla",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar FSM": {
      "main": [
        [
          {
            "node": "Payload Buscar Almacén",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payload Buscar Producto": {
      "main": [
        [
          {
            "node": "HTTP Buscar Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Operación": {
      "main": [
        [
          {
            "node": "HTTP Crear Operación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Ubicaciones": {
      "main": [
        [
          {
            "node": "Preparar Operación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payload Buscar Almacén": {
      "main": [
        [
          {
            "node": "HTTP Buscar Almacén",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Almacén": {
      "main": [
        [
          {
            "node": "Payload Buscar Plantilla",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Ubicaciones",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Pasar a Validar Picking": {
      "main": [
        [
          {
            "node": "HTTP Validar Picking",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolver Coincidencias Producto": {
      "main": [
        [
          {
            "node": "¿Requiere Corrección Producto?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Requiere Corrección Producto?": {
      "main": [
        [
          {
            "node": "Preparar Memoria FSM Inventario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Ubicación Interna",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Ubicación Proveedor",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP PickingType Entrada",
            "type": "main",
            "index": 0
          },
          {
            "node": "HTTP Ubicación Scrap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Memoria FSM Inventario": {
      "main": [
        [
          {
            "node": "Guardar Memoria FSM Inventario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria FSM Inventario": {
      "main": [
        [
          {
            "node": "Sugerencia Productos Encontrados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Ubicación Scrap": {
      "main": [
        [
          {
            "node": "Merge Ubicaciones",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "¿Existe Proyecto?": {
      "main": [
        [
          {
            "node": "Preparar Buscar Tarea FSM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Proyecto No Existe FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Materiales": {
      "main": [
        [
          {
            "node": "HTTP Registrar Nota Materiales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Nota Materiales": {
      "main": [
        [
          {
            "node": "Buscar Almacén",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyecto FSM": {
      "main": [
        [
          {
            "node": "¿Existe Proyecto?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Tarea FSM": {
      "main": [
        [
          {
            "node": "HTTP Buscar Tarea FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Proyecto No Existe FSM": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Proyecto No Existe FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Tarea FSM": {
      "main": [
        [
          {
            "node": "¿Existe Tarea?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Proyecto No Existe FSM": {
      "main": [
        [
          {
            "node": "Preguntar Crear Proyecto Completo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Horas Directo FSM": {
      "main": [
        [
          {
            "node": "HTTP Registrar Horas Directo FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Horas Directo FSM": {
      "main": [
        [
          {
            "node": "Registrar Materiales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Tarea No Existe FSM": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Tarea No Existe FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Tarea No Existe FSM": {
      "main": [
        [
          {
            "node": "Preguntar Crear Tarea Solamente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Payload Buscar Proyecto FSM": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyecto FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Existe Tarea?": {
      "main": [
        [
          {
            "node": "Preparar Asignar Cliente a Tareade",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Tarea No Existe FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Asignar Cliente a Tareade": {
      "main": [
        [
          {
            "node": "HTTP Asignar Cliente a Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Asignar Cliente a Tarea": {
      "main": [
        [
          {
            "node": "Registrar Horas Directo FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Falta Cliente?": {
      "main": [
        [
          {
            "node": "Guardar Memoria Falta Cliente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Payload Buscar Proyecto FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Falta Cliente": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Falta Cliente FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Falta Cliente FSM": {
      "main": [
        [
          {
            "node": "Preguntar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Búsqueda Productos FSM": {
      "main": [
        [
          {
            "node": "HTTP Buscar Productos FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Productos FSM": {
      "main": [
        [
          {
            "node": "Validar Productos FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Productos FSM": {
      "main": [
        [
          {
            "node": "¿Requiere Corrección Productos FSM?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Requiere Corrección Productos FSM?": {
      "main": [
        [
          {
            "node": "Guardar Memoria Corrección Productos FSM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Falta Cliente?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Corrección Productos FSM": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Corrección FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Corrección FSM": {
      "main": [
        [
          {
            "node": "Telegram Pedir Corrección Productos FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Orden Desecho": {
      "main": [
        [
          {
            "node": "Crear Órdenes de Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Órdenes de Desecho": {
      "main": [
        [
          {
            "node": "Loop Over Items para Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Desecho": {
      "main": [
        [
          {
            "node": "Preparar Message Post Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items para Desecho": {
      "main": [
        [
          {
            "node": "Formatear Confirmación Desecho",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Crear Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Confirmación Desecho": {
      "main": [
        [
          {
            "node": "Confirmar Todo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Validación Scrap": {
      "main": [
        [
          {
            "node": "HTTP Validar Scrap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Validar Scrap": {
      "main": [
        [
          {
            "node": "Loop Over Items para Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Almacén": {
      "main": [
        [
          {
            "node": "HTTP Buscar Warehouse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Warehouse": {
      "main": [
        [
          {
            "node": "Resolver Ubicaciones WH",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolver Ubicaciones WH": {
      "main": [
        [
          {
            "node": "HTTP Buscar Ubicación Scrap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Ubicación Scrap": {
      "main": [
        [
          {
            "node": "Fijar IDs de Ubicaciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fijar IDs de Ubicaciones": {
      "main": [
        [
          {
            "node": "Preparar Orden Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria": {
      "main": [
        [
          {
            "node": "FSM ▸ Confirmar Flujo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Buscar Proyecto": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Buscar Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Buscar Proyecto": {
      "main": [
        [
          {
            "node": "FSM ▸ Resolver Proyecto ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Resolver Proyecto ID": {
      "main": [
        [
          {
            "node": "¿Proyecto existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Proyecto existe?": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Buscar Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FSM ▸ Flujo Crear Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Buscar Tarea": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Buscar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Buscar Tarea": {
      "main": [
        [
          {
            "node": "FSM ▸ Resolver Tarea ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Resolver Tarea ID": {
      "main": [
        [
          {
            "node": "FSM ▸ ¿Tarea existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ ¿Tarea existe?": {
      "main": [
        [
          {
            "node": "Tarea Existe",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "FSM ▸ Preparar Crear Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo1": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Orden Desecho1": {
      "main": [
        [
          {
            "node": "Crear Órdenes de Desecho1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Órdenes de Desecho1": {
      "main": [
        [
          {
            "node": "Loop Over Items para Desecho1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Desecho1": {
      "main": [
        [
          {
            "node": "Preparar Validación Scrap1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items para Desecho1": {
      "main": [
        [
          {
            "node": "Formatear Confirmación Desecho1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Crear Desecho1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Confirmación Desecho1": {
      "main": [
        [
          {
            "node": "Confirmar Todo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Validación Scrap1": {
      "main": [
        [
          {
            "node": "HTTP Validar Scrap1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Validar Scrap1": {
      "main": [
        [
          {
            "node": "Loop Over Items para Desecho1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Almacén1": {
      "main": [
        [
          {
            "node": "HTTP Buscar Warehouse1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Warehouse1": {
      "main": [
        [
          {
            "node": "Resolver Ubicaciones WH1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolver Ubicaciones WH1": {
      "main": [
        [
          {
            "node": "HTTP Buscar Ubicación Scrap1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Ubicación Scrap1": {
      "main": [
        [
          {
            "node": "Fijar IDs de Ubicaciones1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fijar IDs de Ubicaciones1": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Buscar Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Proyecto ID": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Crear Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tarea Existe": {
      "main": [
        [
          {
            "node": "FSM ▸ Preparar Registrar Horas (final)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ Preparar Buscar Productos": {
      "main": [
        [
          {
            "node": "FSM ▸ HTTP Buscar Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "FSM ▸ HTTP Buscar Producto": {
      "main": [
        [
          {
            "node": "Validar Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Productos": {
      "main": [
        [
          {
            "node": "Preparar Orden Desecho1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Estado Proyecto": {
      "main": [
        [
          {
            "node": "¿Listar por etapa?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Proyecto": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyecto1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resolver Proyecto / Desambiguar": {
      "main": [
        [
          {
            "node": "¿Proyecto encontrado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Proyecto encontrado?": {
      "main": [
        [
          {
            "node": "Preparar Get Tareas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Desambiguación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Desambiguación": {
      "main": [
        [
          {
            "node": "Telegram Preguntar Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Get Tareas": {
      "main": [
        [
          {
            "node": "HTTP Get Tareas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Get Tareas": {
      "main": [
        [
          {
            "node": "Preparar Horas Agrupadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Horas Agrupadas": {
      "main": [
        [
          {
            "node": "HTTP Horas por Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Horas por Tarea": {
      "main": [
        [
          {
            "node": "Preparar Timesheets Detalle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Timesheets Detalle": {
      "main": [
        [
          {
            "node": "HTTP Timesheets Detalle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Timesheets Detalle": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Estado Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Estado Proyecto": {
      "main": [
        [
          {
            "node": "Telegram Enviar Estado Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Enviar Estado Proyecto": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyecto1": {
      "main": [
        [
          {
            "node": "Resolver Proyecto / Desambiguar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Listar por etapa?": {
      "main": [
        [
          {
            "node": "Preparar Buscar Proyectos por Etapa",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Buscar Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Proyectos por Etapa": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyectos por Etapa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyectos por Etapa": {
      "main": [
        [
          {
            "node": "Preparar Buscar Proyectos por ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Lista Proyectos por Etapa": {
      "main": [
        [
          {
            "node": "Enviar Lista Proyectos por Etapa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Proyectos por ID": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyectos por ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyectos por ID": {
      "main": [
        [
          {
            "node": "Formatear Lista Proyectos por Etapa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener File Path Real1": {
      "main": [
        [
          {
            "node": "Construir URL Descarga Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Empleado": {
      "main": [
        [
          {
            "node": "HTTP Buscar Empleado Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Empleado Ausencia": {
      "main": [
        [
          {
            "node": "¿Empleado Ausencia Encontrado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Tipo Ausencia": {
      "main": [
        [
          {
            "node": "HTTP Buscar Tipo Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Tipo Ausencia": {
      "main": [
        [
          {
            "node": "Elegir Tipo Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Ausencia": {
      "main": [
        [
          {
            "node": "Crear Ausencia Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Ausencia Odoo": {
      "main": [
        [
          {
            "node": "Descargar y Adjuntar Imagen Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar y Adjuntar Imagen Ausencia": {
      "main": [
        [
          {
            "node": "¿Hay imagen para adjuntar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Construir URL Descarga Ausencia": {
      "main": [
        [
          {
            "node": "Descargar Imagen HTTP Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Imagen HTTP Ausencia": {
      "main": [
        [
          {
            "node": "Preparar Adjunto Directo Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Adjunto Directo Ausencia": {
      "main": [
        [
          {
            "node": "HTTP Crear Adjunto Odoo Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Adjunto Odoo Ausencia": {
      "main": [
        [
          {
            "node": "Finalizar Adjunto Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalizar Adjunto Ausencia": {
      "main": [
        [
          {
            "node": "Confirmar Ausencia Creada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Elegir Tipo Ausencia": {
      "main": [
        [
          {
            "node": "Crear Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Hay imagen para adjuntar?": {
      "main": [
        [
          {
            "node": "Obtener File Path Real1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Ausencia Creada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Empleado Ausencia Encontrado?": {
      "main": [
        [
          {
            "node": "Buscar Tipo Ausencia",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Empleado No Encontrado Ausencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Empleado Simplificado": {
      "main": [
        [
          {
            "node": "HTTP Buscar Empleado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Empleado": {
      "main": [
        [
          {
            "node": "Verificar Empleado Simplificado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Empleado Simplificado": {
      "main": [
        [
          {
            "node": "¿Existe empleado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Gasto Simplificado": {
      "main": [
        [
          {
            "node": "Crear Gasto Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Gasto Odoo": {
      "main": [
        [
          {
            "node": "Descargar y Adjuntar Imagen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar y Adjuntar Imagen": {
      "main": [
        [
          {
            "node": "Obtener File Path Real",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Construir URL Descarga": {
      "main": [
        [
          {
            "node": "Descargar Imagen HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener File Path Real": {
      "main": [
        [
          {
            "node": "Construir URL Descarga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Imagen HTTP": {
      "main": [
        [
          {
            "node": "Preparar Adjunto Directo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Adjunto Directo": {
      "main": [
        [
          {
            "node": "HTTP Crear Adjunto Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Adjunto Odoo": {
      "main": [
        [
          {
            "node": "Finalizar Adjunto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalizar Adjunto": {
      "main": [
        [
          {
            "node": "Confirmar Gasto Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Existe empleado?": {
      "main": [
        [
          {
            "node": "Crear Gasto Simplificado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Empleado No Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos Transferencia Stock": {
      "main": [
        [
          {
            "node": "Validar Completitud Transferencia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Completitud Transferencia": {
      "main": [
        [
          {
            "node": "Consultar Transferencia Completada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Transferencia Completada": {
      "main": [
        [
          {
            "node": "Enviar Datos Faltantes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Datos Faltantes": {
      "main": [
        [
          {
            "node": "Enviar respuesta al usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos Transferencia": {
      "main": [
        [
          {
            "node": "Buscar Producto Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Producto Odoo": {
      "main": [
        [
          {
            "node": "Procesar Buscar Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Buscar Producto": {
      "main": [
        [
          {
            "node": "Buscar Almacen Origen Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Almacen Origen Odoo": {
      "main": [
        [
          {
            "node": "Procesar Almacen Origen",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Almacen Origen": {
      "main": [
        [
          {
            "node": "Buscar Almacen Destino Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Almacen Destino Odoo": {
      "main": [
        [
          {
            "node": "Procesar Almacen Destino",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Almacen Destino": {
      "main": [
        [
          {
            "node": "Crear Stock Move Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Stock Move Odoo": {
      "main": [
        [
          {
            "node": "Procesar Crear Move",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Crear Move": {
      "main": [
        [
          {
            "node": "Notificar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Extraer Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Usuario Odoo": {
      "main": [
        [
          {
            "node": "Buscar Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario Odoo": {
      "main": [
        [
          {
            "node": "Preparar Búsqueda Productos FSM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Usuario Odoo1": {
      "main": [
        [
          {
            "node": "Buscar Usuario Odoo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usuario Odoo1": {
      "main": [
        [
          {
            "node": "Propagar Usuario Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Propagar Usuario Odoo": {
      "main": [
        [
          {
            "node": "FSM ▸ Validar Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Message Post Desecho": {
      "main": [
        [
          {
            "node": "HTTP Postear Autor Desecho",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Postear Autor Desecho": {
      "main": [
        [
          {
            "node": "Preparar Validación Scrap",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Tiene Dirección Para Pedido?": {
      "main": [
        [
          {
            "node": "Preparar Crear Pedido Venta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pedir Dirección Para Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Mensaje Es Dirección?": {
      "main": [
        [
          {
            "node": "Extraer Dirección Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Es Comando Validar?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Dirección Pedido": {
      "main": [
        [
          {
            "node": "¿Dirección Válida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Dirección Válida?": {
      "main": [
        [
          {
            "node": "Actualizar Dirección Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensaje Error Dirección",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Dirección Usuario": {
      "main": [
        [
          {
            "node": "Confirmar Dirección Guardada Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preservar Datos Dirección": {
      "main": [
        [
          {
            "node": "Autenticar Odoo Dirección",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar País Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Búsqueda País",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Búsqueda País": {
      "main": [
        [
          {
            "node": "Buscar Provincia Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Provincia Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Búsqueda Provincia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Búsqueda Provincia": {
      "main": [
        [
          {
            "node": "Buscar Partner Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Partner Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Búsqueda Partner",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ejecutar Búsqueda Partner": {
      "main": [
        [
          {
            "node": "Actualizar Dirección en Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Dirección en Odoo": {
      "main": [
        [
          {
            "node": "Ejecutar Update Dirección Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Dirección Guardada Pedido": {
      "main": [
        [
          {
            "node": "Preservar Datos Dirección",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo Dirección": {
      "main": [
        [
          {
            "node": "Buscar País Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Leer Pedido": {
      "main": [
        [
          {
            "node": "HTTP Leer Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Leer Pedido": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Guardar Pedido Cliente": {
      "main": [
        [
          {
            "node": "Guardar Pedido Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Pedido Cliente": {
      "main": [
        [
          {
            "node": "Limitar a 10 Pedidos por Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limitar a 10 Pedidos por Cliente": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Hay número de pedido?": {
      "main": [
        [
          {
            "node": "Pedir Número de Pedido",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Detectar Número Pedido": {
      "main": [
        [
          {
            "node": "¿Hay número de pedido?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pedir Número de Pedido": {
      "main": [
        [
          {
            "node": "Guardar Memoria Modificar Pedido - Pedir Número",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Pedido Cliente": {
      "main": [
        [
          {
            "node": "¿Pedido encontrado?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Pedido encontrado?": {
      "main": [
        [
          {
            "node": "Formatear Pedido para Mostrar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Avisar Pedido No Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Pedido para Mostrar": {
      "main": [
        [
          {
            "node": "Guardar Memoria Modificar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Interpretar Modificación Pedido": {
      "main": [
        [
          {
            "node": "¿Necesita aclaración modificación?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Necesita aclaración modificación?": {
      "main": [
        [
          {
            "node": "Preparar Memoria Aclaración Modificación",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Aplicar Modificación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Modificación": {
      "main": [
        [
          {
            "node": "¿Es producto nuevo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Error en modificación?": {
      "main": [
        [
          {
            "node": "Mensaje Error Modificación",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Payload Actualizar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Actualizar Pedido": {
      "main": [
        [
          {
            "node": "Formatear Resumen Pedido Actualizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Resumen Pedido Actualizado": {
      "main": [
        [
          {
            "node": "Enviar Pedido Actualizado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Pedido Actualizado": {
      "main": [
        [
          {
            "node": "Actualizar pedidos_cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar pedidos_cliente": {
      "main": [
        [
          {
            "node": "Guardar Memoria Modificar Pedido - Detalle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Error Modificación": {
      "main": [
        [
          {
            "node": "Modificar Líneas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es producto nuevo?": {
      "main": [
        [
          {
            "node": "Preparar Búsqueda Producto Nuevo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Error en modificación?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Búsqueda Producto Nuevo": {
      "main": [
        [
          {
            "node": "HTTP Buscar Producto Nuevo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Producto Nuevo": {
      "main": [
        [
          {
            "node": "Procesar Producto Nuevo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Producto Nuevo": {
      "main": [
        [
          {
            "node": "¿Error producto nuevo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Error producto nuevo?": {
      "main": [
        [
          {
            "node": "Mensaje Error Producto Nuevo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Payload Actualizar Pedido1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Resumen Pedido Actualizado1": {
      "main": [
        [
          {
            "node": "Enviar Pedido Actualizado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Pedido Actualizado1": {
      "main": [
        [
          {
            "node": "Actualizar pedidos_cliente1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar pedidos_cliente1": {
      "main": [
        [
          {
            "node": "Guardar Memoria Modificar Pedido - Detalle1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Actualizar Pedido1": {
      "main": [
        [
          {
            "node": "Formatear Resumen Pedido Actualizado1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Payload Actualizar Pedido": {
      "main": [
        [
          {
            "node": "HTTP Actualizar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Payload Actualizar Pedido1": {
      "main": [
        [
          {
            "node": "HTTP Actualizar Pedido1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Buscar Pedido Cliente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Modificar Pedido": {
      "main": [
        [
          {
            "node": "Mostrar Pedido al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Memoria Aclaración Modificación": {
      "main": [
        [
          {
            "node": "Guardar Memoria Aclaración Modificación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Aclaración Modificación": {
      "main": [
        [
          {
            "node": "Mensaje Aclaración Modificación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "HTTP Leer Líneas Actuales de Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Leer Líneas Actuales de Odoo": {
      "main": [
        [
          {
            "node": "Procesar IDs de Líneas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar IDs de Líneas": {
      "main": [
        [
          {
            "node": "HTTP Leer Líneas Detalle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Leer Líneas Detalle": {
      "main": [
        [
          {
            "node": "Formatear Líneas con IDs Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Líneas con IDs Odoo": {
      "main": [
        [
          {
            "node": "Aplicar Modificación1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Re-sincronizar Después de Actualizar": {
      "main": [
        [
          {
            "node": "HTTP Re-sincronizar Pedido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Re-sincronizar Pedido": {
      "main": [
        [
          {
            "node": "Procesar IDs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar IDs": {
      "main": [
        [
          {
            "node": "HTTP Leer Líneas Detalle1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Leer Líneas Detalle1": {
      "main": [
        [
          {
            "node": "Formatear Líneas con IDs Odoo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Líneas con IDs Odoo1": {
      "main": [
        [
          {
            "node": "Formatear Resumen Pedido Actualizado2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Re-sincronizar Después de Actualizar1": {
      "main": [
        [
          {
            "node": "HTTP Re-sincronizar Pedido1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Re-sincronizar Pedido1": {
      "main": [
        [
          {
            "node": "Procesar IDs1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar IDs1": {
      "main": [
        [
          {
            "node": "HTTP Leer Líneas Detalle2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Leer Líneas Detalle2": {
      "main": [
        [
          {
            "node": "Formatear Líneas con IDs Odoo2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Líneas con IDs Odoo2": {
      "main": [
        [
          {
            "node": "Formatear Resumen Pedido Actualizado3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Necesita aclaración modificación?1": {
      "main": [
        [
          {
            "node": "Preparar Memoria Aclaración Modificación1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aplicar Modificación1": {
      "main": [
        [
          {
            "node": "¿Es producto nuevo?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Error en modificación?1": {
      "main": [
        [
          {
            "node": "Mensaje Error Modificación1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Payload Actualizar Pedido2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensaje Error Modificación1": {
      "main": [
        [
          {
            "node": "Modificar Líneas1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Actualizar Pedido2": {
      "main": [
        [
          {
            "node": "Re-sincronizar Después de Actualizar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Resumen Pedido Actualizado2": {
      "main": [
        [
          {
            "node": "Enviar Pedido Actualizado2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Pedido Actualizado2": {
      "main": [
        [
          {
            "node": "Actualizar pedidos_cliente2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar pedidos_cliente2": {
      "main": [
        [
          {
            "node": "Guardar Memoria Modificar Pedido - Detalle2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Es producto nuevo?1": {
      "main": [
        [
          {
            "node": "Preparar Búsqueda Producto Nuevo1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿Error en modificación?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Búsqueda Producto Nuevo1": {
      "main": [
        [
          {
            "node": "HTTP Buscar Producto Nuevo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Producto Nuevo1": {
      "main": [
        [
          {
            "node": "Procesar Producto Nuevo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Producto Nuevo1": {
      "main": [
        [
          {
            "node": "¿Error producto nuevo?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿Error producto nuevo?1": {
      "main": [
        [
          {
            "node": "Mensaje Error Producto Nuevo1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Payload Actualizar Pedido3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Actualizar Pedido3": {
      "main": [
        [
          {
            "node": "Re-sincronizar Después de Actualizar1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Pedido Actualizado3": {
      "main": [
        [
          {
            "node": "Actualizar pedidos_cliente3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar pedidos_cliente3": {
      "main": [
        [
          {
            "node": "Guardar Memoria Modificar Pedido - Detalle3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Payload Actualizar Pedido2": {
      "main": [
        [
          {
            "node": "HTTP Actualizar Pedido2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Payload Actualizar Pedido3": {
      "main": [
        [
          {
            "node": "HTTP Actualizar Pedido3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Memoria Aclaración Modificación1": {
      "main": [
        [
          {
            "node": "Guardar Memoria Aclaración Modificación1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Aclaración Modificación1": {
      "main": [
        [
          {
            "node": "Mensaje Aclaración Modificación1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Resumen Pedido Actualizado3": {
      "main": [
        [
          {
            "node": "Enviar Pedido Actualizado3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-02-18T07:59:12.134Z",
  "id": "417aaYOkSYKL004f",
  "isArchived": false,
  "meta": null,
  "name": "ChatBotTest",
  "nodes": [
    {
      "parameters": {
        "content": "## Modificar contacto\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3408,
        3648
      ],
      "typeVersion": 1,
      "id": "26ccacfc-b03a-46de-aec2-a4a3295f028d",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "content": "## Guardar en postgre consulta y descuenta consultas realizadas\n",
        "height": 544,
        "width": 1248
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3152,
        3888
      ],
      "typeVersion": 1,
      "id": "faaccdfe-12fe-4b33-b7c7-544637fb7731",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "content": "## Crear tarea y horas si no existe"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3408,
        3248
      ],
      "typeVersion": 1,
      "id": "8357b723-de23-4a75-a6a4-9e409677757c",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "content": "## Crear proyecto tarea horas si no existe"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3408,
        2848
      ],
      "typeVersion": 1,
      "id": "4fd7d815-38b7-4327-bd0d-49f8da37deec",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## Bloque crear contacto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3408,
        2496
      ],
      "typeVersion": 1,
      "id": "af944756-1e06-44de-8828-70d975fffe1a",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## Bloque consultar contacto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3408,
        2128
      ],
      "typeVersion": 1,
      "id": "8c302f29-8523-4141-947b-5ef32a0b3d2e",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## Bloque consultar ventas"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3408,
        1792
      ],
      "typeVersion": 1,
      "id": "3394ff5a-fce7-422b-a28c-be992aa73244",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## Bloque consultar producto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3408,
        1456
      ],
      "typeVersion": 1,
      "id": "2a9f857a-3d79-43dc-81dd-304e0f86e603",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## Bloque crear tarea"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3392,
        1088
      ],
      "typeVersion": 1,
      "id": "a304aeb5-6fad-41fb-a6a9-ea8b71ad220f",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Bloque crear proyecto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3392,
        720
      ],
      "typeVersion": 1,
      "id": "4387e9b5-1cf5-430c-ab2f-557cc7ffcb2d",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## Bloque de registro de horas"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3392,
        112
      ],
      "typeVersion": 1,
      "id": "95f4cafc-0bbc-43dc-a69a-2269ad92e1e9",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS COMPLETOS PARA CREAR TAREA Y HORAS\n// OBTENER DATOS DESDE EL NODO CORRECTO\nlet datos = $json;\n\nconsole.log('🔧 DATOS DESDE SWITCH ACCIONES (TAREA):', JSON.stringify(datos, null, 2));\n\n// IMPORTANTE: Obtener datos desde el nodo que SÍ tiene la información\nlet datosFromAI;\ntry {\n  datosFromAI = $('Preparar Datos AI Agent').first().json;\n  console.log('✅ Datos obtenidos desde Preparar Datos AI Agent');\n  console.log('📥 Datos AI Agent:', JSON.stringify(datosFromAI, null, 2));\n  \n  // Si los datos llegan como array, extraer el primer elemento\n  if (Array.isArray(datosFromAI) && datosFromAI.length > 0) {\n    console.log('⚠️ Datos recibidos como array, extrayendo primer elemento');\n    datosFromAI = datosFromAI[0];\n  }\n  \n  datos = datosFromAI;\n} catch (e) {\n  console.error('❌ Error obteniendo datos desde Preparar Datos AI Agent:', e.message);\n  console.log('📋 Usando datos del Switch (pueden estar vacíos)');\n  \n  // Si los datos del Switch llegan como array, extraer el primer elemento\n  if (Array.isArray(datos) && datos.length > 0) {\n    console.log('⚠️ Datos del Switch como array, extrayendo primer elemento');\n    datos = datos[0];\n  }\n}\n\nconsole.log('🔧 === PREPARAR DATOS COMPLETOS TAREA ===');\nconsole.log('📥 Datos recibidos:', JSON.stringify(datos, null, 2));\nconsole.log('🔍 DEBUGGING COMPLETO:');\nconsole.log('   - Tipo de datos:', typeof datos);\nconsole.log('   - Es array?:', Array.isArray(datos));\nconsole.log('   - Claves principales:', Object.keys(datos || {}));\nconsole.log('   - datos.datos_pendientes existe?:', !!datos.datos_pendientes);\nif (datos.datos_pendientes) {\n  console.log('   - Contenido datos_pendientes:', JSON.stringify(datos.datos_pendientes, null, 2));\n  console.log('   - datos_pendientes.proyecto:', datos.datos_pendientes.proyecto);\n  console.log('   - datos_pendientes.proyecto_id:', datos.datos_pendientes.proyecto_id);\n  console.log('   - datos_pendientes.tarea:', datos.datos_pendientes.tarea);\n  console.log('   - datos_pendientes.horas:', datos.datos_pendientes.horas);\n}\n\n// Obtener datos del Router de Acciones anterior para asegurar información completa\nlet datosRouter = {};\ntry {\n  datosRouter = $('Router de Acciones FIXED').first().json;\n  console.log('✅ Datos del Router obtenidos exitosamente');\n  console.log('🔍 Datos del Router:', JSON.stringify(datosRouter, null, 2));\n} catch (e) {\n  console.log('⚠️ No se pudieron obtener datos del Router de Acciones:', e.message);\n  console.log('📋 Usando solo datos del Switch');\n}\n\n// COMBINAR Y VALIDAR DATOS DE MÚLTIPLES FUENTES\n// PRIORIDAD: datos_pendientes > datos directos > router\nconst datosCompletos = {\n  // Datos básicos del usuario\n  chat_id: datos.chat_id || datosRouter.chat_id,\n  user_id: datos.user_id || datosRouter.user_id,\n  user_name: datos.user_name || datosRouter.user_name,\n  uid: datos.uid || datosRouter.uid,\n  mensaje_original: datos.mensaje_original || datosRouter.mensaje_original,\n  \n  // Acción específica\n  accion: datos.accion || 'crear_tarea_y_horas',\n  \n  // Datos del proyecto/tarea/horas - PRIORIDAD A datos_pendientes\n  proyecto: datos.datos_pendientes?.proyecto || datos.proyecto || datosRouter.proyecto || datosRouter.datos_pendientes?.proyecto,\n  proyecto_id: datos.datos_pendientes?.proyecto_id || datos.proyecto_id || datosRouter.proyecto_id || datosRouter.datos_pendientes?.proyecto_id,\n  tarea: datos.datos_pendientes?.tarea || datos.tarea || datosRouter.tarea || datosRouter.datos_pendientes?.tarea,\n  horas: datos.datos_pendientes?.horas || datos.horas || datosRouter.horas || datosRouter.datos_pendientes?.horas,\n  descripcion: datos.datos_pendientes?.descripcion || datos.descripcion || datosRouter.descripcion || datosRouter.datos_pendientes?.descripcion,\n  \n  // Datos pendientes completos\n  datos_pendientes: {\n    proyecto: datos.datos_pendientes?.proyecto || datos.proyecto || datosRouter.proyecto || datosRouter.datos_pendientes?.proyecto,\n    proyecto_id: datos.datos_pendientes?.proyecto_id || datos.proyecto_id || datosRouter.proyecto_id || datosRouter.datos_pendientes?.proyecto_id,\n    tarea: datos.datos_pendientes?.tarea || datos.tarea || datosRouter.tarea || datosRouter.datos_pendientes?.tarea,\n    horas: datos.datos_pendientes?.horas || datos.horas || datosRouter.horas || datosRouter.datos_pendientes?.horas,\n    descripcion: datos.datos_pendientes?.descripcion || datos.descripcion || datosRouter.descripcion || datosRouter.datos_pendientes?.descripcion,\n    uid: datos.uid || datosRouter.uid,\n    tipo_creacion: 'solo_tarea_horas',\n    ...datos.datos_pendientes\n  }\n};\n\nconsole.log('🎯 DATOS COMPLETOS PREPARADOS (TAREA):');\nconsole.log('   📋 Proyecto:', datosCompletos.proyecto);\nconsole.log('   🆔 Proyecto ID:', datosCompletos.proyecto_id);\nconsole.log('   ✅ Tarea:', datosCompletos.tarea);\nconsole.log('   ⏰ Horas:', datosCompletos.horas);\nconsole.log('   📝 Descripción:', datosCompletos.descripcion);\nconsole.log('   🔑 UID:', datosCompletos.uid);\nconsole.log('   💬 Chat ID:', datosCompletos.chat_id);\nconsole.log('   🗂️ Datos pendientes completos:', JSON.stringify(datosCompletos.datos_pendientes, null, 2));\n\n// VALIDACIÓN FINAL\nif (!datosCompletos.tarea || !datosCompletos.horas || !datosCompletos.proyecto_id) {\n  console.error('❌ VALIDACIÓN FALLIDA - Faltan datos críticos después de preparación:');\n  console.error('   - Proyecto:', datosCompletos.proyecto);\n  console.error('   - Proyecto ID:', datosCompletos.proyecto_id);\n  console.error('   - Tarea:', datosCompletos.tarea);\n  console.error('   - Horas:', datosCompletos.horas);\n  console.error('   - Datos originales Switch:', JSON.stringify(datos, null, 2));\n  console.error('   - Datos Router:', JSON.stringify(datosRouter, null, 2));\n  throw new Error(`Preparación de datos fallida. Proyecto: ${datosCompletos.proyecto}, Proyecto ID: ${datosCompletos.proyecto_id}, Tarea: ${datosCompletos.tarea}, Horas: ${datosCompletos.horas}`);\n}\n\nconsole.log('✅ VALIDACIÓN EXITOSA - Todos los datos críticos están presentes');\nconsole.log('🚀 Enviando datos completos al Flujo Crear Tarea y Horas');\n\nreturn datosCompletos;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1504,
        3408
      ],
      "id": "3a4c7e97-d2e9-422f-b039-cc18f67a0a78",
      "name": "Preparar Datos Completos Tarea"
    },
    {
      "parameters": {
        "chatId": "={{ $('Registrar Horas Directo').item.json.datos_registro.chat_id }}",
        "text": "=✅ **¡Parte de horas registrado exitosamente!**\n\n📋 **Detalles del registro:**\n• **Proyecto:** {{ $('Registrar Horas Directo').item.json.datos_registro.proyecto }}\n• **Tarea:** {{ $('Registrar Horas Directo').item.json.datos_registro.tarea }}\n• **Horas:** {{ $('Registrar Horas Directo').item.json.datos_registro.horas }}\n• **Descripción:** {{ $('Registrar Horas Directo').item.json.datos_registro.descripcion }}\n• **Fecha:** {{ new Date().toLocaleDateString('es-ES') }}\n• **ID del registro:** {{ $json.result }}\n🔗 **Registro de horas:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $json.result }}&model=account.analytic.line&view_type=form)\n\n🎉 **¡Listo!** ¿Necesitas registrar más horas? 😊",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        384,
        0
      ],
      "id": "9a15be21-36d8-4164-b5c0-6839d8df5515",
      "name": "Confirmar Horas Registradas",
      "webhookId": "1dadcc74-c513-44a1-88b9-c7aa71c7ec47"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        176,
        0
      ],
      "id": "44efec13-6a5f-4fc4-acf3-b9db8f094ad3",
      "name": "HTTP Registrar Horas Directo"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO Y TAREA EXISTEN - Registrar horas directamente\nconst datosVerificacion = $('Preparar Buscar Tarea').item.json.datos_verificacion;\nconst proyectoData = $('Preparar Buscar Tarea').item.json.proyecto_data;\nconst tareaData = $json.result[0];\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconsole.log('✅ PROYECTO Y TAREA EXISTEN - Registrando horas directamente');\nconsole.log('📋 Proyecto:', proyectoData.name, 'ID:', proyectoData.id);\nconsole.log('✅ Tarea:', tareaData.name, 'ID:', tareaData.id);\nconsole.log('⏰ Horas a registrar:', datosVerificacion.horas);\n\n// Crear el registro de horas directamente\nconst registrarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosVerificacion.descripcion,\n        project_id: proyectoData.id,\n        task_id: tareaData.id,\n        unit_amount: datosVerificacion.horas,\n        date: new Date().toISOString().split('T')[0]\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: registrarHoras,\n  datos_registro: {\n    proyecto: proyectoData.name,\n    tarea: tareaData.name,\n    horas: datosVerificacion.horas,\n    descripcion: datosVerificacion.descripcion,\n    chat_id: datosVerificacion.chat_id,\n    uid: uid\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "ac49d288-e181-4667-bbee-0749a00f3c94",
      "name": "Registrar Horas Directo"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Tarea No Existe').item.json.chat_id }}",
        "text": "=✅ **El proyecto \"{{ $('Guardar Memoria Tarea No Existe').item.json.proyecto }}\" existe.**\n❌ **Pero la tarea \"{{ $('Guardar Memoria Tarea No Existe').item.json.tarea }}\" no existe.**\n\n📋 **Parte de horas pendiente:**\n• **Proyecto:** {{ $('Guardar Memoria Tarea No Existe').item.json.proyecto }} ✅\n• **Tarea:** {{ $('Guardar Memoria Tarea No Existe').item.json.tarea }} ❌\n• **Horas:** {{ $('Guardar Memoria Tarea No Existe').item.json.horas }}\n• **Descripción:** {{ $('Guardar Memoria Tarea No Existe').item.json.descripcion }}\n\n🤔 **¿Quieres que cree la tarea?**\n\nSi dices **\"sí\"**, crearé:\n1️⃣ La tarea \"{{ $('Guardar Memoria Tarea No Existe').item.json.tarea }}\" en el proyecto existente\n2️⃣ El parte de horas automáticamente\n\n**Responde:**\n• **'sí'** para crear la tarea y registrar horas\n• **'no'** para cancelar",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        528,
        400
      ],
      "id": "2aa86bfc-b646-4aba-9015-3507b6f1229e",
      "name": "Preguntar Crear Tarea Solamente",
      "webhookId": "1f3260aa-6777-49ea-8879-00370d53e7a4"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Marcos',\n  'crear_tarea_solamente',\n  `El proyecto \"${$json.proyecto}\" existe pero la tarea \"${$json.tarea}\" no existe. ¿Quieres que cree la tarea?`,\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),\n  `Registro de horas en tarea inexistente: ${$json.tarea}`,\n  JSON.stringify($json.memoria_actualizada?.historial || []),\n  JSON.stringify([{\n    tipo: 'usuario',\n    contenido: `Registrar ${$json.horas}h en ${$json.proyecto}/${$json.tarea}`,\n    timestamp: new Date().toISOString()\n  },\n    {\n      tipo: 'bot',\n      contenido: `Tarea \"${$json.tarea}\" no existe en proyecto existente. Esperando confirmación para crear.`,\n      timestamp: new Date().toISOString()\n    }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        288,
        400
      ],
      "id": "39c3f08a-62ef-49a8-8f1c-64e4f94049df",
      "name": "Guardar Memoria PostgreSQL Tarea No Existe"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO EXISTE, TAREA NO EXISTE - Guardar en memoria\nconst datosVerificacion = $('Preparar Buscar Tarea').item.json.datos_verificacion;\nconst proyectoData = $('Preparar Buscar Tarea').item.json.proyecto_data;\nconst chatId = datosVerificacion.chat_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconsole.log('✅ PROYECTO EXISTE, ❌ TAREA NO EXISTE');\nconsole.log('📋 Proyecto:', proyectoData.name, 'ID:', proyectoData.id);\nconsole.log('❌ Tarea no encontrada:', datosVerificacion.tarea);\n\n// Guardar datos para crear solo tarea + horas\nmemoria.esperando_confirmacion = 'crear_tarea_solamente';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  proyecto: datosVerificacion.proyecto_nombre,\n  proyecto_id: datosVerificacion.proyecto_id,\n  tarea: datosVerificacion.tarea,\n  horas: datosVerificacion.horas,\n  descripcion: datosVerificacion.descripcion,\n  accion_original: 'registrar_horas',\n  tipo_creacion: 'solo_tarea_horas', // Solo crear tarea y horas\n  uid: $('Autenticar Odoo').item.json.result\n};\n\n// Actualizar historial\nconst entradaHistorial = {\n  timestamp: new Date().toISOString(),\n  usuario: `Registrar ${datosVerificacion.horas}h en ${datosVerificacion.proyecto}/${datosVerificacion.tarea}`,\n  bot: `Tarea \"${datosVerificacion.tarea}\" no existe en proyecto existente`,\n  accion: 'tarea_no_existe_en_proyecto',\n  chat_id: chatId\n};\n\nif (!memoria.historial) memoria.historial = [];\nmemoria.historial.push(entradaHistorial);\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  chat_id: chatId,\n  proyecto: datosVerificacion.proyecto_nombre,\n  proyecto_id: datosVerificacion.proyecto_id,\n  tarea: datosVerificacion.tarea,\n  horas: datosVerificacion.horas,\n  descripcion: datosVerificacion.descripcion,\n  tipo_respuesta: 'tarea_no_existe',\n  memoria_actualizada: memoria\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        400
      ],
      "id": "5b49c0d9-ee51-45a7-8e50-2390e494c957",
      "name": "Guardar Memoria Tarea No Existe"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Proyecto No Existe').item.json.chat_id }}",
        "text": "=❌ **El proyecto \"{{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\" no existe.**\n\n📋 **Parte de horas pendiente:**\n• **Proyecto:** {{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\n• **Tarea:** {{ $('Guardar Memoria Proyecto No Existe').item.json.tarea }}\n• **Horas:** {{ $('Guardar Memoria Proyecto No Existe').item.json.horas }}\n• **Descripción:** {{ $('Guardar Memoria Proyecto No Existe').item.json.descripcion }}\n\n🤔 **¿Quieres que cree el proyecto completo?**\n\nSi dices **\"sí\"**, crearé:\n1️⃣ El proyecto \"{{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\"\n2️⃣ La tarea \"{{ $('Guardar Memoria Proyecto No Existe').item.json.tarea }}\"\n3️⃣ El parte de horas automáticamente\n\n**Responde:**\n• **'sí'** para crear todo\n• **'no'** para cancelar",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -240,
        656
      ],
      "id": "402c90a6-f90c-4acd-911d-f20c05364b48",
      "name": "Preguntar Crear Proyecto Completo",
      "webhookId": "c0796c6c-0854-41cc-b48d-6a1fd2478d8a"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Marcos',\n  'crear_proyecto_completo',\n  `❌ El proyecto \"${$json.proyecto}\" no existe. ¿Quieres que cree el proyecto completo?`,\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),\n  `Registro de horas en proyecto inexistente: ${$json.proyecto}`,\n  JSON.stringify($json.memoria_actualizada?.historial || []),\n  JSON.stringify([{\n    tipo: 'usuario',\n    contenido: `Registrar ${$json.horas}h en ${$json.proyecto}/${$json.tarea}`,\n    timestamp: new Date().toISOString()\n  },\n  {\n    tipo: 'bot',\n    contenido: `Proyecto \"${$json.proyecto}\" no existe. Esperando confirmación para crear.`,\n    timestamp: new Date().toISOString()\n  }])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -576,
        464
      ],
      "id": "59ed818f-5a63-4834-a18f-276a86e609eb",
      "name": "Guardar Memoria PostgreSQL Proyecto No Existe"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO NO EXISTE - Guardar en memoria y preguntar al usuario\nconst datosVerificacion = $('Verificar Proyecto y Tarea Horas').item.json.datos_verificacion;\nconst chatId = datosVerificacion.chat_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconsole.log('❌ PROYECTO NO EXISTE - Guardando en memoria:', datosVerificacion.proyecto);\n\n// Guardar TODOS los datos del parte de horas en memoria\nmemoria.esperando_confirmacion = 'crear_proyecto_completo';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  proyecto: datosVerificacion.proyecto,\n  tarea: datosVerificacion.tarea,\n  horas: datosVerificacion.horas,\n  descripcion: datosVerificacion.descripcion,\n  accion_original: 'registrar_horas',\n  tipo_creacion: 'proyecto_tarea_horas', // Indica que hay que crear todo\n  uid: $('Autenticar Odoo').item.json.result\n};\n\n// Actualizar historial\nconst entradaHistorial = {\n  timestamp: new Date().toISOString(),\n  usuario: `Registrar ${datosVerificacion.horas}h en ${datosVerificacion.proyecto}/${datosVerificacion.tarea}`,\n  bot: `Proyecto \"${datosVerificacion.proyecto}\" no existe`,\n  accion: 'proyecto_no_existe_para_horas',\n  chat_id: chatId\n};\n\nif (!memoria.historial) memoria.historial = [];\nmemoria.historial.push(entradaHistorial);\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  chat_id: chatId,\n  proyecto: datosVerificacion.proyecto,\n  tarea: datosVerificacion.tarea,\n  horas: datosVerificacion.horas,\n  descripcion: datosVerificacion.descripcion,\n  tipo_respuesta: 'proyecto_no_existe',\n  memoria_actualizada: memoria\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -864,
        464
      ],
      "id": "4de3a5a5-4282-4f9c-9367-e3bb76558021",
      "name": "Guardar Memoria Proyecto No Existe"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload_tarea }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -496,
        144
      ],
      "id": "a9e43c36-d59a-4535-afc2-fb840f9241ea",
      "name": "HTTP Buscar Tarea"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO EXISTE - Ahora verificar si la tarea también existe\nconst datosVerificacion = $('Verificar Proyecto y Tarea Horas').item.json.datos_verificacion;\nconst proyectoData = $json.result[0];\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconsole.log('✅ PROYECTO EXISTE - Verificando tarea:', datosVerificacion.tarea);\nconsole.log('📋 Proyecto encontrado:', proyectoData.name, 'ID:', proyectoData.id);\n\n// Buscar tarea en el proyecto\nconst buscarTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"search_read\",\n      [\n        [\n          [\"name\", \"ilike\", datosVerificacion.tarea],\n          [\"project_id\", \"=\", proyectoData.id]\n        ],\n        [\"id\", \"name\", \"project_id\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload_tarea: buscarTarea,\n  datos_verificacion: {\n    ...datosVerificacion,\n    proyecto_id: proyectoData.id,\n    proyecto_nombre: proyectoData.name,\n    paso: 'verificar_tarea'\n  },\n  proyecto_data: proyectoData\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -864,
        192
      ],
      "id": "e329f742-6ff1-400b-a659-c9d60b1dbd1f",
      "name": "Preparar Buscar Tarea"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload_proyecto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1264,
        272
      ],
      "id": "4bc45459-d3c7-4063-9d63-fe3cb39201db",
      "name": "HTTP Buscar Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// VERIFICACIÓN INTELIGENTE PARA REGISTRO DE HORAS\n// Este nodo verifica si el proyecto Y la tarea existen para determinar qué crear\n\nconst datosHoras = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreProyecto = datosHoras.proyecto;\nconst nombreTarea = datosHoras.tarea;\nconst horas = datosHoras.horas;\nconst descripcion = datosHoras.descripcion;\nconst chatId = datosHoras.chat_id;\n\nconsole.log('🔍 === VERIFICACIÓN INTELIGENTE PROYECTO Y TAREA ===');\nconsole.log('📋 Proyecto:', nombreProyecto);\nconsole.log('✅ Tarea:', nombreTarea);\nconsole.log('⏰ Horas:', horas);\nconsole.log('📝 Descripción:', descripcion);\n\n// PASO 1: Buscar proyecto\nconst buscarProyecto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"project.project\",\n      \"search_read\",\n      [\n        [[\"name\", \"ilike\", nombreProyecto]],\n        [\"id\", \"name\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload_proyecto: buscarProyecto,\n  datos_verificacion: {\n    proyecto: nombreProyecto,\n    tarea: nombreTarea,\n    horas: horas,\n    descripcion: descripcion,\n    chat_id: chatId,\n    uid: uid,\n    paso: 'verificar_proyecto'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        272
      ],
      "id": "4b990079-60b4-4b67-8783-05d55816cada",
      "name": "Verificar Proyecto y Tarea Horas"
    },
    {
      "parameters": {
        "jsCode": "// Log para datos inválidos que no se pueden guardar en PostgreSQL\nconsole.log('❌ DATOS INVÁLIDOS - No se guardó en PostgreSQL:');\nconsole.log('📄 Datos recibidos:', JSON.stringify($json, null, 2));\nconsole.log('🚫 Razón:', $json.razon || 'No especificada');\nconsole.log('📊 Chat ID original:', $json.chat_id_original);\nconsole.log('🔢 Chat ID numérico:', $json.chat_id_numerico);\n\nreturn { \n  mensaje: 'Datos no guardados en PostgreSQL por ser inválidos',\n  detalles: $json \n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8416,
        4160
      ],
      "id": "6a32f438-ea65-40d0-87fc-269c7b5ae7ca",
      "name": "Log Datos Inválidos"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.resultado !== 'skipped' }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        8112,
        4000
      ],
      "id": "f13bae7c-49fb-4786-bbee-0b8e77c39b1e",
      "name": "¿Datos Válidos para PostgreSQL?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (\n  chat_id, user_id, user_name, proyecto_anterior, tarea_anterior,\n  ultima_accion, esperando_confirmacion, esperando_respuesta,\n  ultimo_mensaje_bot, mensaje_usuario, datos_pendientes, historial, historial_conversacion,\n  created_at, updated_at\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, NOW(), NOW()\n);",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,\n  $json.user_id,\n  $json.user_name,\n  $json.proyecto_anterior,\n  $json.tarea_anterior,\n  $json.ultima_accion,\n  $json.esperando_confirmacion,\n  $json.esperando_respuesta,\n  $json.ultimo_mensaje_bot,\n  $json.mensaje_usuario,\n  $json.datos_pendientes,\n  $json.historial,\n  $json.historial_conversacion\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        8560,
        3936
      ],
      "id": "c35fe025-fd19-4a88-9de7-4f082c5d6758",
      "name": "Insertar en PostgreSQL"
    },
    {
      "parameters": {
        "jsCode": "// NODO UNIFICADOR - PREPARAR DATOS POSTGRESQL CON BÚSQUEDA ACTIVA\nconst timestampActual = new Date().toISOString();\n\n// Detectar si viene del flujo de evento incompleto\nlet respuestaBot = $json.text || $json.respuesta_usuario || 'Respuesta procesada';\n\n// Si viene de evento incompleto, usar mensaje específico\nif ($json.esperando_confirmacion === 'crear_evento_calendario' && $json.datos_pendientes) {\n  respuestaBot = 'faltan datos';\n} else if ($json.ultimo_mensaje_bot) {\n  respuestaBot = $json.ultimo_mensaje_bot;\n}\n\nconsole.log('🔄 === PREPARAR DATOS POSTGRESQL - BÚSQUEDA ACTIVA ===');\nconsole.log('📥 Datos recibidos directamente:', JSON.stringify($json, null, 2));\n\n// FUNCIÓN PARA BUSCAR DATOS DEL USUARIO EN NODOS ANTERIORES\nfunction buscarDatosUsuario() {\n  const nodosABuscar = [\n    'Router de Acciones FIXED',\n    'Procesar Respuesta',\n    'Preparar Datos AI Agent',\n    'Obtener Chat ID',\n    'Extraer Datos'\n  ];\n  for (const nombreNodo of nodosABuscar) {\n    try {\n      const datos = $(nombreNodo).first().json;\n      if (datos && datos.chat_id && datos.chat_id !== 'unknown') {\n        console.log(`✅ Datos encontrados en: ${nombreNodo}`);\n        return {\n          chat_id: datos.chat_id,\n          user_id: datos.user_id || datos.chat_id,\n          user_name: datos.user_name || 'Usuario',\n          mensaje_original: datos.mensaje_usuario || datos.mensaje_original || 'mensaje no disponible',\n          fuente: nombreNodo,\n          es_fallback: datos.es_fallback === true\n        };\n      }\n    } catch (e) {\n      console.log(`⚠️ No se pudo acceder a ${nombreNodo}:`, e.message);\n    }\n  }\n  return null;\n}\n\n// INTENTAR OBTENER DATOS DEL USUARIO\nlet datosUsuario = {\n  chat_id: $json.chat_id,\n  user_id: $json.user_id,\n  user_name: $json.user_name,\n  mensaje_original: $json.mensaje_usuario || $json.mensaje_original,\n  es_fallback: $json.es_fallback === true\n};\n\n// Si no tenemos chat_id válido, buscar en nodos anteriores\nif (!datosUsuario.chat_id || datosUsuario.chat_id === 'unknown') {\n  console.log('🔍 Chat ID no válido, buscando en nodos anteriores...');\n  const datosBuscados = buscarDatosUsuario();\n  if (datosBuscados) {\n    datosUsuario = datosBuscados;\n    console.log(`✅ Datos recuperados desde: ${datosBuscados.fuente}`);\n  } else {\n    console.log('❌ No se encontraron datos válidos del usuario');\n    datosUsuario = {\n      chat_id: 0,\n      user_id: 0,\n      user_name: 'unknown',\n      mensaje_original: 'mensaje no disponible',\n      fuente: 'fallback',\n      es_fallback: true\n    };\n  }\n}\n\nconsole.log('👤 DATOS FINALES DEL USUARIO:', {\n  chat_id: datosUsuario.chat_id,\n  user_id: datosUsuario.user_id,\n  user_name: datosUsuario.user_name,\n  fuente: datosUsuario.fuente || 'directo',\n  es_fallback: datosUsuario.es_fallback === true\n});\n\n// CREAR REGISTRO PARA POSTGRESQL\nconst registroPostgreSQL = {\n  chat_id: parseInt(datosUsuario.chat_id) || 0,\n  user_id: parseInt(datosUsuario.user_id) || 0,\n  user_name: datosUsuario.user_name === 'unknown' ? null : datosUsuario.user_name,\n  ultima_accion: 'conversar',\n  ultimo_mensaje_bot: respuestaBot,\n  mensaje_usuario: datosUsuario.mensaje_original === 'mensaje no disponible' ? null : datosUsuario.mensaje_original,\n  historial: JSON.stringify([{\n    timestamp: timestampActual,\n    usuario: datosUsuario.mensaje_original,\n    bot: respuestaBot,\n    accion: 'conversar'\n  }]),\n  historial_conversacion: JSON.stringify([{\n    timestamp: timestampActual,\n    contenido: datosUsuario.mensaje_original,\n    tipo: 'usuario'\n  }, {\n    timestamp: timestampActual,\n    contenido: respuestaBot,\n    tipo: 'bot'\n  }]),\n  // Propagar al post-descontar\n  es_fallback: datosUsuario.es_fallback === true\n};\n\nconsole.log('📤 REGISTRO FINAL PARA POSTGRESQL:', {\n  chat_id: registroPostgreSQL.chat_id,\n  user_id: registroPostgreSQL.user_id,\n  user_name: registroPostgreSQL.user_name,\n  es_fallback: registroPostgreSQL.es_fallback\n});\n\nreturn [registroPostgreSQL];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7616,
        4112
      ],
      "id": "b6f9ba8a-ba4e-4b18-81f0-a9134eb56175",
      "name": "Preparar Datos PostgreSQL"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -880,
        2656
      ],
      "id": "6d3adb60-7f5a-4104-9420-f0d9df42a3ba",
      "name": "Enviar Respuesta Contacto Creado",
      "webhookId": "c58a3c3f-57f8-4ea4-b8cc-3bdb8241d51e"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de contacto creado para Telegram\nconst contactoCreado = $json.result;\nconst datosContacto = $('Preparar Crear Contacto').item.json.datos_contacto;\nconst baseUrl = 'https://lsanchezgoshawk-n8npruebas.odoo.com';\nlet texto = '';\n\nif (!contactoCreado) {\n  texto = '❌ Error al crear el contacto. Por favor, intenta de nuevo.';\n} else {\n  texto = `✅ **¡Contacto creado exitosamente!**\\n\\n`;\n  texto += `👤 **Nombre:** ${datosContacto.nombre}\\n`;\n  texto += `🆔 **ID en Odoo:** ${contactoCreado}\\n`;\n  const enlace = `${baseUrl}/web#id=${contactoCreado}&model=res.partner&view_type=form`;\n  texto += `🔗 **Enlace:** [Abrir en Odoo](${enlace})\\n`;\n  \n  if (datosContacto.email && datosContacto.email.trim() !== '') {\n    texto += `📧 **Email:** ${datosContacto.email}\\n`;\n  }\n  \n  if (datosContacto.telefono && datosContacto.telefono.trim() !== '') {\n    texto += `📱 **Teléfono:** ${datosContacto.telefono}\\n`;\n  }\n  \n  if (datosContacto.es_empresa) {\n    texto += `🏢 **Tipo:** Empresa\\n`;\n  } else {\n    texto += `👤 **Tipo:** Persona\\n`;\n  }\n  \n  texto += `\\n¡Ya puedes usar este contacto en Odoo! 🎉`;\n}\n\nreturn{\n  texto,\n  chat_id: datosContacto.chat_id || $('Preparar Crear Contacto').item.json.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        2656
      ],
      "id": "a3e557f5-1271-4b31-a1c4-845b7aff001a",
      "name": "Formatear Respuesta Contacto Creado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1280,
        2656
      ],
      "id": "fe8ed15e-9598-4dcf-933f-02158d3d98e0",
      "name": "HTTP Crear Contacto"
    },
    {
      "parameters": {
        "jsCode": "// Preparar creación de contacto en Odoo\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreContacto = datosAI.nombre;\nconst emailContacto = datosAI.email || '';\nconst telefonoContacto = datosAI.telefono || '';\nconst empresaContacto = datosAI.empresa || '';\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\n// Validar que tenemos nombre del contacto\nif (!nombreContacto) {\n  throw new Error('No se encontró el nombre del contacto');\n}\n\n// Preparar datos del contacto\nconst datosContacto = {\n  name: nombreContacto,\n  is_company: false,\n  customer_rank: 1,  // Marcar como cliente\n  supplier_rank: 0   // No es proveedor por defecto\n};\n\n// Añadir email si está disponible\nif (emailContacto && emailContacto.trim() !== '') {\n  datosContacto.email = emailContacto.trim();\n}\n\n// Añadir teléfono si está disponible\nif (telefonoContacto && telefonoContacto.trim() !== '') {\n  datosContacto.phone = telefonoContacto.trim();\n}\n\n// Si se especifica empresa, buscarla primero\nlet esEmpresa = false;\nif (empresaContacto && empresaContacto.trim() !== '') {\n  esEmpresa = true;\n  datosContacto.is_company = true;\n  datosContacto.name = empresaContacto.trim();\n}\n\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\", // DB\n      uid, \n      \"admin\", \n      \"res.partner\", \n      \"create\",\n      [datosContacto]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  datos_contacto: {\n    nombre: nombreContacto,\n    email: emailContacto,\n    telefono: telefonoContacto,\n    empresa: empresaContacto,\n    es_empresa: esEmpresa\n  },\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        2656
      ],
      "id": "39378957-4582-42da-a2d8-674b5ba7227c",
      "name": "Preparar Crear Contacto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=✅ **¡Tarea y horas registradas exitosamente!**\n\n📋 **Proyecto existente:** {{ $json.resumen_creado.proyecto }} (ID: {{ $json.resumen_creado.proyecto_id }})\n🔗 **Proyecto:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $json.resumen_creado.proyecto_id }}&model=project.project&view_type=form)\n✅ **Tarea creada:** {{ $json.resumen_creado.tarea }} (ID: {{ $json.resumen_creado.tarea_id }})\n🔗 **Tarea:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $json.resumen_creado.tarea_id }}&model=project.task&view_type=form)\n⏰ **Horas registradas:** {{ $json.resumen_creado.horas }}h (ID: {{ $json.resumen_creado.horas_id }})\n📅 **Fecha:** {{ $json.resumen_creado.fecha }}\n📝 **Descripción:** {{ $json.resumen_creado.descripcion }}\n\n🎯 Tarea y horas añadidas al proyecto exitosamente.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -176,
        3408
      ],
      "id": "80240089-caba-4364-aff3-c18718fb4aa3",
      "name": "Confirmar Tarea Horas",
      "webhookId": "ac533b77-6510-42d6-94e5-9a81692c2b67"
    },
    {
      "parameters": {
        "jsCode": "// Limpiar memoria después del flujo tarea + horas exitoso\nconst responseHoras = $json;\nconst datosFlujo = $('Preparar Horas Tarea Solo').item.json.datos_flujo;\n\nconsole.log('🧹 === LIMPIAR MEMORIA TAREA + HORAS ===');\nconsole.log('✅ Respuesta horas:', JSON.stringify(responseHoras, null, 2));\nconsole.log('🔄 Datos flujo final:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID del registro de horas\nlet horasId;\nif (responseHoras.result) {\n  horasId = responseHoras.result;\n} else if (responseHoras.body && responseHoras.body.result) {\n  horasId = responseHoras.body.result;\n} else {\n  console.error('❌ No se encontró ID del registro de horas:', responseHoras);\n  throw new Error('No se pudo obtener el ID del registro de horas');\n}\n\nconsole.log('🆔 Horas ID obtenido:', horasId);\n\n// Preparar datos para limpiar memoria y confirmar éxito\nreturn {\n  chat_id: datosFlujo.chat_id,\n  uid: $('Autenticar Odoo').item.json.result,\n  flujo_tarea_horas_exitoso: true,\n  limpieza_memoria: {\n    tipo_creacion: null,\n    esperando_confirmacion: false,\n    datos_pendientes: {},\n    ultimo_mensaje_bot: 'Flujo tarea + horas exitoso'\n  },\n  resumen_creado: {\n    proyecto: datosFlujo.proyecto,\n    proyecto_id: datosFlujo.proyecto_id,\n    tarea: datosFlujo.tarea,\n    tarea_id: datosFlujo.tarea_id,\n    horas: datosFlujo.horas,\n    horas_id: horasId,\n    descripcion: datosFlujo.descripcion,\n    fecha: datosFlujo.fecha\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -416,
        3408
      ],
      "id": "027d6326-d12e-432e-965e-4515c4007012",
      "name": "Limpiar Memoria Tarea Horas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -640,
        3408
      ],
      "id": "460c8e47-957a-4e8c-9c43-f78628edf52a",
      "name": "HTTP Registrar Horas Tarea Solo"
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta de tarea creada y preparar registro de horas (proyecto existente)\nconst responseTarea = $json;\nconst datosFlujo = $('Flujo Crear Tarea y Horas').item.json.datos_flujo;\n\nconsole.log('✅ === PREPARAR HORAS - TAREA SOLO ===');\nconsole.log('📋 Respuesta tarea:', JSON.stringify(responseTarea, null, 2));\nconsole.log('🔄 Datos flujo:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID de la tarea creada\nlet tareaId;\nif (responseTarea.result) {\n  tareaId = responseTarea.result;\n} else if (responseTarea.body && responseTarea.body.result) {\n  tareaId = responseTarea.body.result;\n} else {\n  console.error('❌ No se encontró ID de la tarea en respuesta:', responseTarea);\n  throw new Error('No se pudo obtener el ID de la tarea creada');\n}\n\nconsole.log('🆔 Tarea ID obtenido:', tareaId);\n\n// Obtener fecha actual\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\n// Preparar registro de horas\nconst registrarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosFlujo.uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosFlujo.descripcion || `Registro de ${datosFlujo.horas} horas en ${datosFlujo.tarea}`,\n        project_id: datosFlujo.proyecto_id,\n        task_id: tareaId,\n        unit_amount: parseFloat(datosFlujo.horas),\n        date: fechaHoy,\n        user_id: datosFlujo.uid\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: registrarHoras,\n  datos_flujo: {\n    ...datosFlujo,\n    paso: 'registrar_horas_tarea_solo',\n    tarea_id: tareaId,\n    tarea_creada: true,\n    fecha: fechaHoy\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -832,
        3408
      ],
      "id": "dc6ba648-cfe2-4f17-aea1-bc973cc2f878",
      "name": "Preparar Horas Tarea Solo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1056,
        3408
      ],
      "id": "c83df602-c1ae-40a8-b17b-131bde2ac590",
      "name": "HTTP Crear Tarea Solo"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=🎉 **¡Flujo completo exitoso!**\n\n✅ **Proyecto creado:** {{ $json.resumen_creado.proyecto }} (ID: {{ $json.resumen_creado.proyecto_id }})\n🔗 **Proyecto:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $json.resumen_creado.proyecto_id }}&model=project.project&view_type=form)\n✅ **Tarea creada:** {{ $json.resumen_creado.tarea }} (ID: {{ $json.resumen_creado.tarea_id }})\n🔗 **Tarea:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $json.resumen_creado.tarea_id }}&model=project.task&view_type=form)\n✅ **Horas registradas:** {{ $json.resumen_creado.horas }}h (ID: {{ $json.resumen_creado.horas_id }})\n📅 **Fecha:** {{ $json.resumen_creado.fecha }}\n📝 **Descripción:** {{ $json.resumen_creado.descripcion }}\n\n🚀 Todo ha sido creado y registrado exitosamente en Odoo.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        96,
        3008
      ],
      "id": "69551bd1-d5e3-4ad9-a7ee-d45f36020337",
      "name": "Confirmar Flujo Completo",
      "webhookId": "e99a7f75-c964-40eb-be55-943594a16829"
    },
    {
      "parameters": {
        "jsCode": "// Limpiar memoria después del flujo completo exitoso\nconst responseHoras = $json;\nconst datosFlujo = $('Preparar Registrar Horas Paso3').item.json.datos_flujo;\n\nconsole.log('🧹 === LIMPIAR MEMORIA FLUJO COMPLETO ===');\nconsole.log('✅ Respuesta horas:', JSON.stringify(responseHoras, null, 2));\nconsole.log('🔄 Datos flujo final:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID del registro de horas\nlet horasId;\nif (responseHoras.result) {\n  horasId = responseHoras.result;\n} else if (responseHoras.body && responseHoras.body.result) {\n  horasId = responseHoras.body.result;\n} else {\n  console.error('❌ No se encontró ID del registro de horas:', responseHoras);\n  throw new Error('No se pudo obtener el ID del registro de horas');\n}\n\nconsole.log('🆔 Horas ID obtenido:', horasId);\n\n// Preparar datos para limpiar memoria y confirmar éxito\nreturn {\n  chat_id: datosFlujo.chat_id,\n  uid: $('Autenticar Odoo').item.json.result,\n  flujo_completo_exitoso: true,\n  limpieza_memoria: {\n    tipo_creacion: null,\n    esperando_confirmacion: false,\n    datos_pendientes: {},\n    ultimo_mensaje_bot: 'Flujo completo exitoso'\n  },\n  resumen_creado: {\n    proyecto: datosFlujo.proyecto,\n    proyecto_id: datosFlujo.proyecto_id,\n    tarea: datosFlujo.tarea,\n    tarea_id: datosFlujo.tarea_id,\n    horas: datosFlujo.horas,\n    horas_id: horasId,\n    descripcion: datosFlujo.descripcion,\n    fecha: datosFlujo.fecha\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -96,
        3008
      ],
      "id": "992c36c3-1823-44f5-ba96-d48ba023835a",
      "name": "Limpiar Memoria Flujo Completo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -304,
        3008
      ],
      "id": "9160d890-4a79-49f2-9b2b-d902ab7d244d",
      "name": "HTTP Registrar Horas Paso3"
    },
    {
      "parameters": {
        "jsCode": "// PASO 3: Procesar respuesta de la tarea creada y preparar registro de horas\nconst responseTarea = $json;\nconst datosFlujo = $('Preparar Crear Tarea Paso2').item.json.datos_flujo;\n\nconsole.log('✅ === PASO 3: PROCESAR TAREA CREADA ===');\nconsole.log('📋 Respuesta tarea:', JSON.stringify(responseTarea, null, 2));\nconsole.log('🔄 Datos flujo:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID de la tarea creada\nlet tareaId;\nif (responseTarea.result) {\n  tareaId = responseTarea.result;\n} else if (responseTarea.body && responseTarea.body.result) {\n  tareaId = responseTarea.body.result;\n} else {\n  console.error('❌ No se encontró ID de la tarea en respuesta:', responseTarea);\n  throw new Error('No se pudo obtener el ID de la tarea creada');\n}\n\nconsole.log('🆔 Tarea ID obtenido:', tareaId);\n\n// Obtener fecha actual\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\n// Preparar registro de horas\nconst registrarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosFlujo.uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosFlujo.descripcion || `Registro de ${datosFlujo.horas} horas en ${datosFlujo.tarea}`,\n        project_id: datosFlujo.proyecto_id,\n        task_id: tareaId,\n        unit_amount: parseFloat(datosFlujo.horas),\n        date: fechaHoy,\n        user_id: datosFlujo.uid\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: registrarHoras,\n  datos_flujo: {\n    ...datosFlujo,\n    paso: 'registrar_horas',\n    tarea_id: tareaId,\n    tarea_creada: true,\n    fecha: fechaHoy\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        3008
      ],
      "id": "2621e08e-75f5-4be9-aeb2-b011176ffa30",
      "name": "Preparar Registrar Horas Paso3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -704,
        3008
      ],
      "id": "92082c67-c229-449d-9e5f-c3ac1c0d7bcd",
      "name": "HTTP Crear Tarea Paso2"
    },
    {
      "parameters": {
        "jsCode": "// PASO 2: Procesar respuesta del proyecto creado y preparar creación de tarea\nconst responseProyecto = $json;\nconst datosFlujo = $('Flujo Crear Proyecto Tarea Horas').item.json.datos_flujo;\n\nconsole.log('✅ === PASO 2: PROCESAR PROYECTO CREADO ===');\nconsole.log('📋 Respuesta proyecto:', JSON.stringify(responseProyecto, null, 2));\nconsole.log('🔄 Datos flujo:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID del proyecto creado\nlet proyectoId;\nif (responseProyecto.result) {\n  proyectoId = responseProyecto.result;\n} else if (responseProyecto.body && responseProyecto.body.result) {\n  proyectoId = responseProyecto.body.result;\n} else {\n  console.error('❌ No se encontró ID del proyecto en respuesta:', responseProyecto);\n  throw new Error('No se pudo obtener el ID del proyecto creado');\n}\n\nconsole.log('🆔 Proyecto ID obtenido:', proyectoId);\n\n// Preparar creación de tarea\nconst crearTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosFlujo.uid,\n      \"admin\",\n      \"project.task\",\n      \"create\",\n      [{\n        name: datosFlujo.tarea,\n        project_id: proyectoId,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearTarea,\n  datos_flujo: {\n    ...datosFlujo,\n    paso: 'crear_tarea',\n    proyecto_id: proyectoId,\n    proyecto_creado: true\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -896,
        3008
      ],
      "id": "8c78f031-c937-4032-9698-307f1efa187d",
      "name": "Preparar Crear Tarea Paso2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1104,
        3008
      ],
      "id": "650d4e17-bdb4-49fc-bf19-479837f06ba7",
      "name": "HTTP Crear Proyecto Paso1"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -256,
        3936
      ],
      "id": "362131b4-dac0-41f6-a6a4-f998e6e81fc8",
      "name": "Telegram Confirmar Modificación",
      "webhookId": "9d0f7fcd-0945-40bf-817f-c41319a7afc3"
    },
    {
      "parameters": {
        "jsCode": "// Recupera los datos del contexto anterior\nconst contacto = $node[\"Preparar Modificar Contacto\"].json.contacto;\nconst campo = $node[\"Preparar Modificar Contacto\"].json.campo;\nconst nuevo_valor = $node[\"Formatear Nuevo Valor\"].json.nuevo_valor ?? $json.nuevo_valor;\nconst chat_id = $node[\"Preparar Modificar Contacto\"].json.chat_id;\n\n// Obtener datos del contacto actualizado desde la respuesta de búsqueda\nconst contactoData = $node[\"Buscar Contacto\"].json.result[0];\nconst nombreCompleto = contactoData ? contactoData.name : contacto;\n\n// Mapeo para mostrar el campo de forma amigable\nconst campoMap = {\n  telefono: 'teléfono',\n  email: 'email',\n  direccion: 'dirección',\n  web: 'página web',\n  notas: 'notas internas'\n};\n\nconst campoAmigable = campoMap[campo] || campo;\n\n// Obtener valor anterior del contacto para mostrar el antes/después\nconst fieldMap = {\n  telefono: 'phone',\n  email: 'email',\n  direccion: 'street',\n  web: 'website',\n  notas: 'comment'\n};\nconst valorAnterior = contactoData ? contactoData[fieldMap[campo]] : 'No disponible';\n\n// Mensaje de confirmación más detallado\nlet texto = `🎉 **¡Contacto actualizado exitosamente!**\\n\\n`;\ntexto += `👤 **Contacto:** ${nombreCompleto}\\n`;\ntexto += `📝 **Campo modificado:** ${campoAmigable}\\n\\n`;\n\nif (campo && typeof nuevo_valor !== \"undefined\") {\n  // Mostrar el antes y después\n  texto += `**CAMBIOS REALIZADOS:**\\n`;\n  texto += `• **Valor anterior:** ${valorAnterior || 'Vacío'}\\n`;\n  texto += `• **Nuevo valor:** ${nuevo_valor === \"\" ? \"Eliminado/vacío\" : nuevo_valor}\\n\\n`;\n}\n\ntexto += `✅ La información del contacto ha sido actualizada correctamente en Odoo.`;\n\nreturn {\n  chat_id,\n  texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -464,
        3936
      ],
      "id": "88fd944a-2d4d-4185-acdd-36d477fca35a",
      "name": "Formatear Confirmación"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -656,
        3936
      ],
      "id": "2191b245-bddf-4dfc-90de-16b061c4af30",
      "name": "Actualizar Contacto"
    },
    {
      "parameters": {
        "jsCode": "const contacto = $node[\"Preparar Modificar Contacto\"].json.contacto;\nconst campo = $node[\"Preparar Modificar Contacto\"].json.campo;\nconst chat_id = $node[\"Preparar Modificar Contacto\"].json.chat_id;\nconst uid = $node[\"Preparar Modificar Contacto\"].json.uid;\nconst contactoData = $node[\"Buscar Contacto\"].json.result[0];\nif (!contactoData) {\n  throw new Error(\"No se encontró el contacto para actualizar.\");\n}\nconst contacto_id = contactoData.id;\n\n// El nuevo valor viene del mensaje del usuario\nconst nuevo_valor = $json.text ?? $node[\"Preparar Modificar Contacto\"].json.nuevo_valor;\n\n// Mapeo de campos\nconst fieldMap = {\n  telefono: 'phone',\n  email: 'email',\n  direccion: 'street',\n  web: 'website',\n  notas: 'comment'\n};\nconst field = fieldMap[campo];\n\n// DEPURACIÓN\nconsole.log(\"Campo recibido:\", campo);\nconsole.log(\"Field Odoo:\", field);\nconsole.log(\"Nuevo valor:\", nuevo_valor);\n\nif (!field) {\n  throw new Error(\"Campo no soportado o no reconocido: \" + campo);\n}\nif (typeof nuevo_valor === \"undefined\" || nuevo_valor === null) {\n  throw new Error(\"No se recibió el nuevo valor del usuario.\");\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'res.partner',\n      'write',\n      [ [contacto_id], { [field]: nuevo_valor } ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload,\n  chat_id,\n  contacto_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        3936
      ],
      "id": "ec7182f6-6b3c-41c2-b21a-243e592c4564",
      "name": "Formatear Nuevo Valor"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -288,
        3712
      ],
      "id": "9f0d34a0-1fc7-46c6-a1c5-62d1b8a87b29",
      "name": "Telegram Pedir Nuevo Valor",
      "webhookId": "736d2022-240d-4701-b65b-907dc6b0f0bf"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $node[\"Preparar Modificar Contacto\"].json.nuevo_valor == null }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1104,
        3808
      ],
      "id": "777742d6-ed2b-480f-8b76-5ba3ec7ba32a",
      "name": "¿Falta Nuevo Valor?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1296,
        3808
      ],
      "id": "12edcbfa-1174-4492-a986-b10257644a0e",
      "name": "Buscar Contacto"
    },
    {
      "parameters": {
        "jsCode": "// Prepara el payload para buscar el contacto en Odoo\nconst contacto = $json.contacto;\nconst campo = $json.campo;\nconst chat_id = $json.chat_id;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nuevo_valor = $json.nuevo_valor;\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'res.partner',\n      'search_read',\n      [ [ ['name', 'ilike', contacto] ], ['id', 'name', 'phone', 'email', 'street', 'city', 'zip', 'country_id', 'website', 'comment'] ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\nreturn { contacto, campo, chat_id, uid, nuevo_valor, payload };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1504,
        3808
      ],
      "id": "ca103f8d-1689-4748-ade6-73740e3b9dae",
      "name": "Preparar Modificar Contacto"
    },
    {
      "parameters": {
        "jsCode": "// FLUJO: Crear SOLO Tarea → Registrar Horas (proyecto ya existe)\nconst datos = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\n\n// Los datos pueden venir desde el Router de Acciones de dos formas:\n// 1. Como datos.datos_pendientes (estructura anidada)\n// 2. Como datos directos desde Router (proyecto, tarea, horas, etc.)\nlet datosPendientes = datos.datos_pendientes;\n\n// Si no están en datos_pendientes, construirlos desde los datos directos\nif (!datosPendientes || !datosPendientes.tarea) {\n  datosPendientes = {\n    proyecto: datos.proyecto,\n    proyecto_id: datos.proyecto_id,\n    tarea: datos.tarea,\n    horas: datos.horas,\n    descripcion: datos.descripcion,\n    uid: $('Autenticar Odoo').item.json.result,\n    tipo_creacion: 'solo_tarea_horas'\n  };\n}\n\nconst chatId = datos.chat_id;\n\nconsole.log('✅ === FLUJO CREAR TAREA → HORAS (Proyecto existe) ===');\nconsole.log('📄 Datos recibidos completos:', JSON.stringify(datos, null, 2));\nconsole.log('📋 Datos pendientes procesados:', JSON.stringify(datosPendientes, null, 2));\n\n// Validar que tenemos los datos críticos desde cualquier fuente\nconst proyectoNombre = datosPendientes?.proyecto || datos.proyecto;\nconst proyectoId = datosPendientes?.proyecto_id || datos.proyecto_id;\nconst tareaNombre = datosPendientes?.tarea || datos.tarea;\nconst horasValor = datosPendientes?.horas || datos.horas;\n\nif (!tareaNombre || !horasValor) {\n  console.error('❌ Faltan datos críticos:');\n  console.error('  - Proyecto:', proyectoNombre);\n  console.error('  - Proyecto ID:', proyectoId);\n  console.error('  - Tarea:', tareaNombre);\n  console.error('  - Horas:', horasValor);\n  console.error('❌ Datos originales recibidos:', JSON.stringify(datos, null, 2));\n  console.error('❌ Datos pendientes procesados:', JSON.stringify(datosPendientes, null, 2));\n  throw new Error(`Faltan datos críticos para crear la tarea. Proyecto: ${proyectoNombre}, Tarea: ${tareaNombre}, Horas: ${horasValor}`);\n}\n\nif (!proyectoId) {\n  console.error('❌ No se encontró proyecto_id:');\n  console.error('  - Proyecto ID en datosPendientes:', datosPendientes?.proyecto_id);\n  console.error('  - Proyecto ID en datos:', datos.proyecto_id);\n  console.error('❌ Datos originales recibidos:', JSON.stringify(datos, null, 2));\n  throw new Error('No se encontró ID del proyecto existente. Revisa que el proyecto_id esté en memoria.');\n}\n\n// Asegurar que datosPendientes tenga todos los datos necesarios\ndatosPendientes = {\n  proyecto: proyectoNombre,\n  proyecto_id: proyectoId,\n  tarea: tareaNombre,\n  horas: horasValor,\n  descripcion: datosPendientes?.descripcion || datos.descripcion || `Registro de ${horasValor} horas en ${tareaNombre}`,\n  uid: datos.uid,\n  tipo_creacion: datosPendientes?.tipo_creacion || 'solo_tarea_horas'\n};\n\nconsole.log('📋 Proyecto existente:', datosPendientes.proyecto, 'ID:', datosPendientes.proyecto_id);\nconsole.log('✅ Tarea a crear:', datosPendientes.tarea);\nconsole.log('⏰ Horas a registrar:', datosPendientes.horas);\nconsole.log('📝 Descripción:', datosPendientes.descripcion);\n\n// PASO 1: Crear la tarea en el proyecto existente\nconst crearTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"create\",\n      [{\n        name: datosPendientes.tarea,\n        project_id: datosPendientes.proyecto_id,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearTarea,\n  datos_flujo: {\n    paso: 'crear_tarea_solo',\n    proyecto: datosPendientes.proyecto,\n    proyecto_id: datosPendientes.proyecto_id,\n    tarea: datosPendientes.tarea,\n    horas: datosPendientes.horas,\n    descripcion: datosPendientes.descripcion,\n    chat_id: chatId,\n    uid: uid\n  },\n  datos_pendientes: datosPendientes\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        3408
      ],
      "id": "b1c849b1-8d5c-41d2-8abc-e573c285e5a1",
      "name": "Flujo Crear Tarea y Horas"
    },
    {
      "parameters": {
        "jsCode": "// FLUJO SECUENCIAL: Crear Proyecto → Tarea → Registrar Horas\nconst datos = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\n\n// Los datos pueden venir desde el Router de Acciones de dos formas:\n// 1. Como datos.datos_pendientes (estructura anidada)\n// 2. Como datos directos desde Router (proyecto, tarea, horas, etc.)\nlet datosPendientes = datos.datos_pendientes;\n\n// Si no están en datos_pendientes, construirlos desde los datos directos\nif (!datosPendientes || !datosPendientes.proyecto) {\n  datosPendientes = {\n    proyecto: datos.proyecto,\n    tarea: datos.tarea,\n    horas: datos.horas,\n    descripcion: datos.descripcion,\n    uid: $('Autenticar Odoo').item.json.result,\n    tipo_creacion: 'proyecto_tarea_horas'\n  };\n}\n\nconst chatId = datos.chat_id;\n\nconsole.log('🏗️ === FLUJO CREAR PROYECTO → TAREA → HORAS ===');\nconsole.log('📄 Datos recibidos completos:', JSON.stringify(datos, null, 2));\nconsole.log('📋 Datos pendientes procesados:', JSON.stringify(datosPendientes, null, 2));\n\n// Validar que tenemos los datos críticos desde cualquier fuente\nconst proyectoNombre = datosPendientes?.proyecto || datos.proyecto;\nconst tareaNombre = datosPendientes?.tarea || datos.tarea;\nconst horasValor = datosPendientes?.horas || datos.horas;\n\nif (!proyectoNombre || !tareaNombre || !horasValor) {\n  console.error('❌ Faltan datos críticos:');\n  console.error('  - Proyecto:', proyectoNombre);\n  console.error('  - Tarea:', tareaNombre);\n  console.error('  - Horas:', horasValor);\n  console.error('❌ Datos originales recibidos:', JSON.stringify(datos, null, 2));\n  console.error('❌ Datos pendientes procesados:', JSON.stringify(datosPendientes, null, 2));\n  throw new Error(`Faltan datos críticos para crear el proyecto. Proyecto: ${proyectoNombre}, Tarea: ${tareaNombre}, Horas: ${horasValor}`);\n}\n\n// Asegurar que datosPendientes tenga todos los datos necesarios\ndatosPendientes = {\n  proyecto: proyectoNombre,\n  tarea: tareaNombre,\n  horas: horasValor,\n  descripcion: datosPendientes?.descripcion || datos.descripcion || `Registro de ${horasValor} horas`,\n  uid: datos.uid,\n  tipo_creacion: datosPendientes?.tipo_creacion || 'proyecto_tarea_horas'\n};\n\nconsole.log('📋 Proyecto a crear:', datosPendientes.proyecto);\nconsole.log('✅ Tarea a crear:', datosPendientes.tarea);\nconsole.log('⏰ Horas a registrar:', datosPendientes.horas);\nconsole.log('📝 Descripción:', datosPendientes.descripcion);\n\n// PASO 1: Crear el proyecto\nconst crearProyecto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"project.project\",\n      \"create\",\n      [{\n        name: datosPendientes.proyecto,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearProyecto,\n  datos_flujo: {\n    paso: 'crear_proyecto',\n    proyecto: datosPendientes.proyecto,\n    tarea: datosPendientes.tarea,\n    horas: datosPendientes.horas,\n    descripcion: datosPendientes.descripcion,\n    chat_id: chatId,\n    uid: uid\n  },\n  datos_pendientes: datosPendientes\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        3008
      ],
      "id": "71a7734d-27b5-44c4-94bc-8edcaed76cf3",
      "name": "Flujo Crear Proyecto Tarea Horas"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS COMPLETOS PARA CREAR PROYECTO TAREA HORAS\n// OBTENER DATOS DESDE EL NODO CORRECTO\nlet datos = $json;\n\nconsole.log('🔧 DATOS DESDE SWITCH ACCIONES:', JSON.stringify(datos, null, 2));\n\n// IMPORTANTE: Obtener datos desde el nodo que SÍ tiene la información\nlet datosFromAI;\ntry {\n  datosFromAI = $('Preparar Datos AI Agent').first().json;\n  console.log('✅ Datos obtenidos desde Preparar Datos AI Agent');\n  console.log('📥 Datos AI Agent:', JSON.stringify(datosFromAI, null, 2));\n  \n  // Si los datos llegan como array, extraer el primer elemento\n  if (Array.isArray(datosFromAI) && datosFromAI.length > 0) {\n    console.log('⚠️ Datos recibidos como array, extrayendo primer elemento');\n    datosFromAI = datosFromAI[0];\n  }\n  \n  datos = datosFromAI;\n} catch (e) {\n  console.error('❌ Error obteniendo datos desde Preparar Datos AI Agent:', e.message);\n  console.log('📋 Usando datos del Switch (pueden estar vacíos)');\n  \n  // Si los datos del Switch llegan como array, extraer el primer elemento\n  if (Array.isArray(datos) && datos.length > 0) {\n    console.log('⚠️ Datos del Switch como array, extrayendo primer elemento');\n    datos = datos[0];\n  }\n}\n\nconsole.log('🔧 === PREPARAR DATOS COMPLETOS PROYECTO ===');\nconsole.log('📥 Datos recibidos:', JSON.stringify(datos, null, 2));\nconsole.log('🔍 DEBUGGING COMPLETO:');\nconsole.log('   - Tipo de datos:', typeof datos);\nconsole.log('   - Es array?:', Array.isArray(datos));\nconsole.log('   - Claves principales:', Object.keys(datos || {}));\nconsole.log('   - datos.datos_pendientes existe?:', !!datos.datos_pendientes);\nif (datos.datos_pendientes) {\n  console.log('   - Contenido datos_pendientes:', JSON.stringify(datos.datos_pendientes, null, 2));\n  console.log('   - datos_pendientes.proyecto:', datos.datos_pendientes.proyecto);\n  console.log('   - datos_pendientes.tarea:', datos.datos_pendientes.tarea);\n  console.log('   - datos_pendientes.horas:', datos.datos_pendientes.horas);\n}\n\n// Obtener datos del Router de Acciones anterior para asegurar información completa\nlet datosRouter = {};\ntry {\n  datosRouter = $('Router de Acciones FIXED').first().json;\n  console.log('✅ Datos del Router obtenidos exitosamente');\n  console.log('🔍 Datos del Router:', JSON.stringify(datosRouter, null, 2));\n} catch (e) {\n  console.log('⚠️ No se pudieron obtener datos del Router de Acciones:', e.message);\n  console.log('📋 Usando solo datos del Switch');\n}\n\n// COMBINAR Y VALIDAR DATOS DE MÚLTIPLES FUENTES\n// PRIORIDAD: datos_pendientes > datos directos > router\nconst datosCompletos = {\n  // Datos básicos del usuario\n  chat_id: datos.chat_id || datosRouter.chat_id,\n  user_id: datos.user_id || datosRouter.user_id,\n  user_name: datos.user_name || datosRouter.user_name,\n  uid: datos.uid || datosRouter.uid,\n  mensaje_original: datos.mensaje_original || datosRouter.mensaje_original,\n  \n  // Acción específica\n  accion: datos.accion || 'crear_proyecto_tarea_horas',\n  \n  // Datos del proyecto/tarea/horas - PRIORIDAD A datos_pendientes\n  proyecto: datos.datos_pendientes?.proyecto || datos.proyecto || datosRouter.proyecto || datosRouter.datos_pendientes?.proyecto,\n  tarea: datos.datos_pendientes?.tarea || datos.tarea || datosRouter.tarea || datosRouter.datos_pendientes?.tarea,\n  horas: datos.datos_pendientes?.horas || datos.horas || datosRouter.horas || datosRouter.datos_pendientes?.horas,\n  descripcion: datos.datos_pendientes?.descripcion || datos.descripcion || datosRouter.descripcion || datosRouter.datos_pendientes?.descripcion,\n  \n  // Datos pendientes completos\n  datos_pendientes: {\n    proyecto: datos.datos_pendientes?.proyecto || datos.proyecto || datosRouter.proyecto || datosRouter.datos_pendientes?.proyecto,\n    tarea: datos.datos_pendientes?.tarea || datos.tarea || datosRouter.tarea || datosRouter.datos_pendientes?.tarea,\n    horas: datos.datos_pendientes?.horas || datos.horas || datosRouter.horas || datosRouter.datos_pendientes?.horas,\n    descripcion: datos.datos_pendientes?.descripcion || datos.descripcion || datosRouter.descripcion || datosRouter.datos_pendientes?.descripcion,\n    uid: datos.uid || datosRouter.uid,\n    tipo_creacion: 'proyecto_tarea_horas',\n    ...datos.datos_pendientes\n  }\n};\n\nconsole.log('🎯 DATOS COMPLETOS PREPARADOS:');\nconsole.log('   📋 Proyecto:', datosCompletos.proyecto);\nconsole.log('   ✅ Tarea:', datosCompletos.tarea);\nconsole.log('   ⏰ Horas:', datosCompletos.horas);\nconsole.log('   📝 Descripción:', datosCompletos.descripcion);\nconsole.log('   🔑 UID:', datosCompletos.uid);\nconsole.log('   💬 Chat ID:', datosCompletos.chat_id);\nconsole.log('   🗂️ Datos pendientes completos:', JSON.stringify(datosCompletos.datos_pendientes, null, 2));\n\n// VALIDACIÓN FINAL\nif (!datosCompletos.proyecto || !datosCompletos.tarea || !datosCompletos.horas) {\n  console.error('❌ VALIDACIÓN FALLIDA - Faltan datos críticos después de preparación:');\n  console.error('   - Proyecto:', datosCompletos.proyecto);\n  console.error('   - Tarea:', datosCompletos.tarea);\n  console.error('   - Horas:', datosCompletos.horas);\n  console.error('   - Datos originales Switch:', JSON.stringify(datos, null, 2));\n  console.error('   - Datos Router:', JSON.stringify(datosRouter, null, 2));\n  throw new Error(`Preparación de datos fallida. Proyecto: ${datosCompletos.proyecto}, Tarea: ${datosCompletos.tarea}, Horas: ${datosCompletos.horas}`);\n}\n\nconsole.log('✅ VALIDACIÓN EXITOSA - Todos los datos críticos están presentes');\nconsole.log('🚀 Enviando datos completos al Flujo Crear Proyecto Tarea Horas');\n\nreturn datosCompletos;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1504,
        3008
      ],
      "id": "69a88067-a235-4de1-a3ce-f4d65663e82a",
      "name": "Preparar Datos Completos Proyecto"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Registro Automático').item.json.datos_registro.chat_id }}",
        "text": "=✅ **¡Tarea creada y horas registradas exitosamente!**\n\n📋 **Proyecto:** {{ $('Preparar Registro Automático').item.json.datos_registro.proyecto_nombre }}\n🔗 **Proyecto:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $('Preparar Registrar Horas Paso3').item.json.resumen_creado.proyecto_id }}&model=project.project&view_type=form)\n📝 **Tarea:** {{ $('Preparar Registro Automático').item.json.datos_registro.tarea_nombre }} (NUEVA)\n🔗 **Tarea:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $('Preparar Registrar Horas Paso3').item.json.resumen_creado.tarea_id }}&model=project.task&view_type=form)\n⏰ **Horas:** {{ $('Preparar Registro Automático').item.json.datos_registro.horas }}\n📅 **Fecha:** {{ $('Preparar Registro Automático').item.json.datos_registro.fecha }}\n💬 **Descripción:** {{ $('Preparar Registro Automático').item.json.datos_registro.descripcion }}\n\n🎉 ¡Todo completado automáticamente! ¡Gracias por mantener tu registro actualizado!",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        960,
        1152
      ],
      "id": "ad819043-5654-43cc-b9a5-58463eb20150",
      "name": "Confirmar Todo Completado",
      "webhookId": "d1ff15b0-5a23-40c3-95bf-711b1f67073d"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        768,
        1152
      ],
      "id": "cc4cac43-90a5-4b6a-bc21-8ffc31565d2e",
      "name": "Registrar Horas Automático"
    },
    {
      "parameters": {
        "jsCode": "// Preparar registro automático de horas tras crear tarea\nconst datosHoras = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\nconst crearHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosHoras.descripcion,\n        unit_amount: parseFloat(datosHoras.horas),\n        project_id: parseInt(datosHoras.proyecto_data.id),\n        task_id: parseInt(datosHoras.tarea_creada_id),\n        date: fechaHoy\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearHoras,\n  datos_registro: {\n    proyecto_nombre: datosHoras.proyecto,\n    tarea_nombre: datosHoras.tarea,\n    horas: datosHoras.horas,\n    descripcion: datosHoras.descripcion,\n    fecha: fechaHoy,\n    chat_id: datosHoras.chat_id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        528,
        1152
      ],
      "id": "20c92536-1530-457f-8998-0faca59a2bfc",
      "name": "Preparar Registro Automático"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.accion === 'registrar_horas_automatico' }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        144,
        1168
      ],
      "id": "3a0f21c1-1853-487a-8bac-f1817db505dd",
      "name": "¿Tiene Horas Pendientes?"
    },
    {
      "parameters": {
        "jsCode": "// Verificar si después de crear la tarea hay que registrar horas pendientes\nconst datosLimpiar = $json;\nconst chatId = datosLimpiar.datos_tarea?.chat_id;\nconst memoria = datosLimpiar.memoria;\n\nif (!chatId || !memoria) {\n  console.log('No se encontró chatId o memoria');\n  return { accion: 'terminar' };\n}\n\n// Si había datos pendientes de registro de horas, proceder a registrarlas\nif (memoria.datos_pendientes && memoria.datos_pendientes.accion_original === 'registrar_horas') {\n  const datosHoras = memoria.datos_pendientes;\n  \n  console.log('Registrando horas automáticamente:', datosHoras);\n  \n  // Limpiar memoria ahora que vamos a registrar las horas\n  const contextoKey = `memoria_${chatId}`;\n  let memoriaActualizada = global[contextoKey] || {};\n  memoriaActualizada.esperando_confirmacion = null;\n  memoriaActualizada.datos_pendientes = null;\n  global[contextoKey] = memoriaActualizada;\n  \n  // Preparar datos para registrar horas con la tarea recién creada\n  return {\n    proyecto: datosHoras.proyecto,\n    tarea: datosHoras.tarea,\n    horas: datosHoras.horas,\n    descripcion: datosHoras.descripcion,\n    uid: datosLimpiar.uid,\n    chat_id: chatId,\n    accion: 'registrar_horas_automatico',\n    proyecto_data: {\n      id: datosLimpiar.datos_tarea.proyecto_id,\n      name: datosHoras.proyecto\n    },\n    tarea_creada_id: datosLimpiar.tarea_creada_id\n  };\n} else {\n  // No hay horas pendientes, terminar\n  console.log('No hay horas pendientes para registrar');\n  return { accion: 'terminar' };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -96,
        1168
      ],
      "id": "d6741749-a021-463d-806e-439bedf934cd",
      "name": "Verificar Registro Horas Pendiente"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos después de crear tarea exitosamente\nconst chatId = $('Preparar Crear Tarea').item.json.datos_tarea.chat_id;\nconst tareaCreada = $json.result; // ID de la tarea recién creada\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\n// Actualizar memoria con la nueva tarea creada\nmemoria.proyecto_anterior = $('Preparar Crear Tarea').item.json.datos_tarea.nombre_proyecto;\nmemoria.tarea_anterior = $('Preparar Crear Tarea').item.json.datos_tarea.nombre_tarea;\nmemoria.ultima_accion = 'crear_tarea';\n\n// Conservar datos pendientes si existen para registro automático de horas\nconst tieneHorasPendientes = memoria.datos_pendientes && memoria.datos_pendientes.accion_original === 'registrar_horas';\n\nif (!tieneHorasPendientes) {\n  memoria.esperando_confirmacion = null;\n  memoria.datos_pendientes = null;\n}\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  ...($json),\n  datos_tarea: $('Preparar Crear Tarea').item.json.datos_tarea,\n  tarea_creada_id: tareaCreada,\n  uid: $('Preparar Crear Tarea').item.json.datos_tarea.uid || $('Buscar Proyecto para Tarea').item.json.uid,\n  memoria: memoria\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        1168
      ],
      "id": "e59174b8-bba0-41f7-a8f3-8564427206b7",
      "name": "Limpiar Memoria Tarea"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.3,
          "topP": 0.9
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -4576,
        3552
      ],
      "id": "04d8fb88-428f-486f-ba12-8e34f4832548",
      "name": "Google Gemini Chat Model"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un asistente virtual para Odoo con el estilo de comunicación de Jorge, un consultor especializado en automatización con IA y Odoo. Analiza este mensaje y responde en JSON.\n\n**MENSAJE DEL USUARIO:** {{ $json.mensaje_usuario }}\n**USUARIO:** {{ $json.user_name || 'Usuario' }} (ID: {{ $json.user_id || 'unknown' }})\n**TIPO:** {{ $json.es_audio ? 'Audio transcrito' : 'Texto' }}\n**ODOO_USER (login/email):** {{ $json.odoo_user || 'desconocido' }}\n\n\n{% if $json.es_audio %}\n🎤 **MENSAJE DE VOZ TRANSCRITO:** {{ $json.mensaje_usuario }}\n{% endif %}\n\nAÑO_ACTUAL: {{ (new Date()).getFullYear() }}\n\n{% set PERFIL = ($json.cliente_perfil || {}) %}\n{% set ODOO_USER = ($json.odoo_user || PERFIL.login || PERFIL.email || $json.user_mail || null) %}\n{% set CLIENTE_SUGERIDO = (PERFIL.name || $json.user_name || '').toString().trim() %}\n\n\n**MEMORIA DEL USUARIO (CONTEXTO ACTUAL):**\n{% if $json.esperando_confirmacion %}\n🔄 **ESPERANDO CONFIRMACIÓN PARA:** {{ $json.esperando_confirmacion }}\n📝 **ÚLTIMO MENSAJE BOT:** {{ $json.ultimo_mensaje_bot }}\n📋 **DATOS PENDIENTES:** {{ $json.datos_pendientes | tojsonpretty }}\n{% endif %}\n\n**📌 CONTEXTO GENERAL - ESTILO JORGE**\nSoy consultor en automatización con IA y Odoo, especializado en eficiencia tecnológica para empresas. Trabajo con pymes industriales, empresas de servicios y startups tecnológicas. Mi objetivo es generar leads, construir autoridad, abrir conversaciones, educar al mercado y posicionarme como una voz experta en tecnología, IA y herramientas como n8n. Me dirijo principalmente a decisores de negocio y tecnología, mostrando con claridad cómo la automatización puede transformar procesos reales.\n\n**🧠 ACTÚA COMO UN COPYWRITER ESPECIALIZADO EN COMUNICACIÓN TECNOLÓGICA**\nAdopta el estilo de Jorge, un profesional directo, técnico pero cercano, que prioriza la claridad y la confianza. Su forma de escribir se basa en construir relaciones reales con clientes, explicar conceptos con naturalidad y mostrar el valor de forma transparente, sin adornos innecesarios.\n\n**👨‍💼 IDENTIDAD PERSONAL**\n* Hombre, 33 años, madrileño.\n* Más de 10 años de experiencia en tecnología y negocios.\n* Apasionado de la tecnología que genera impacto real.\n* Sagaz, directo, crítico y auténtico.\n\n**🗣️ TONO**\n* Profesional sin rigidez. Habla claro, con naturalidad, como si escribieras un correo real a un cliente.\n* Cercano pero sin adornos. Nada de exageraciones ni frases hechas. No busca sonar \"moderno\" ni intentar impresionar con jerga.\n* Reflexivo, observador y con criterio propio. El texto debe sonar como alguien que piensa en voz alta con lógica y experiencia.\n* Se puede usar una ligera ironía o comentarios personales, si aporta cercanía.\n* Evita palabras en inglés salvo que sean necesarias (ej. nombres propios, conceptos como \"Data Driven, Business Intelligence,etc...\"). Si existe una forma clara de decirlo en castellano, úsala.\n* Siempre orientado a construir confianza. No se vende humo, se aportan hechos.\n* Se prioriza la lógica, los beneficios tangibles y la claridad técnica explicada sin jerga.\n\n**✨ ESTILO ESCRITO**\n* Frases cortas y naturales. Nada rebuscado ni inflado. Como si lo dijeras hablando.\n* Tono directo, sin vueltas. Si hay un problema, se menciona. Si hay una ventaja, se justifica.\n* Expone ideas como una secuencia de pensamiento: plantea una observación, la analiza y ofrece una postura razonable.\n* Incluye ejemplos concretos o referencias a situaciones reales (sin sonar como manual).\n* Si el contenido es técnico, explícalo como si se lo contaras a alguien que no lo domina (pero con respeto).\n* Uso puntual de MAYÚSCULAS para énfasis y estructura clara.\n* Cierre con reflexión o pregunta que invite al lector a compartir su opinión, además de posibles CTAs.\n\n**🌟 PÚBLICO OBJETIVO**\nConecta con:\nCTOs, COOs, CIOs, CMOs, CFOs, Tech Leads, project managers, responsables de BI, operaciones, supply chain, fundadores de eCommerce, gerentes de pymes industriales y consultores IT.\n\nHabla como a un colega que sabe de lo que habla, entiende los retos y ofrece soluciones claras: automatización, integración, eficiencia y escalabilidad. Nada de discursos vacíos.\n\n**RECONOCIMIENTO DE PATRONES - EVALÚA SI EL MENSAJE CONTIENE:**\n- ✅ Palabras clave de REGISTRO: \"registrar\", \"parte\", \"horas\", \"proyecto\", \"tarea\"\n- ✅ Palabras clave de CREACIÓN: \"crear\", \"nuevo\", \"proyecto\", \"tarea\"\n- ✅ Palabras clave de CONSULTA: \"cuánto\", \"precio\", \"stock\", \"ventas\", \"contacto\"\n- ✅ Palabras clave de CONSULTA HORAS: \"cuántas horas\", \"horas dedicadas\", \"tiempo dedicado\", \"tiempo invertido\"\n- ✅ Palabras clave de CONSULTA TEMPORAL: \"hoy\", \"ayer\", \"esta semana\", \"semana pasada\", \"este mes\", \"mes pasado\", \"qué ha hecho\", \"qué hice\"\n- ✅ Palabras clave de MODIFICACIÓN: \"modificar\", \"cambiar\", \"editar\", \"actualizar\", \"corregir\", \"pon\", \"quitar\", \"eliminar\", \"añadir\" (contactos)\n- ✅ Palabras de CONFIRMACIÓN: \"sí\", \"si\", \"vale\", \"adelante\", \"confirmar\", \"crear\", \"ok\", \"perfecto\"\n- ✅ Palabras clave de AUSENCIAS (registro/consulta): \"ausencia\", \"ausencias\", \"vacaciones\", \"permiso\", \"permisos\", \"baja\", \"libre\", \"off\", \"no estoy\", \"no está\", \"fuera\"\n  - CONSULTA: \"ausencias\" + opcional nombre persona, \"quién está de\", \"está libre\", \"no está\", \"fuera\", \"permisos de\", \"vacaciones de\"\n  - REGISTRO: \"registrar ausencia\", \"solicitar permiso\", \"pedir vacaciones\" + fechas\n  - Detectar consulta si contiene: \"ausencias\", \"ausente\", \"vacaciones\", \"permisos\", \"libre\", \"off\", \"no está\", \"fuera\" \n  - Detectar registro si coaparece con \"registrar\", \"solicitar\", \"pedir\", \"crear\" + (tipo) + fechas\n- ✅ Palabras clave de PARTE+STOCK: si aparecen a la vez intención de registrar horas\n  ( \"registrar\" | \"parte\" | \"horas\" )  y mención de materiales\n  ( \"material\" | \"materiales\" | \"producto\" | \"productos\" | \"stock\" | \"he usado\" |\n    \"usé\" | \"he consumido\" | \"consumí\" | \"utilicé\" ), entonces → registrar_parte_y_stock\n- ✅ Palabras clave de ESTADO DE PROYECTO:\n  Frases como: \"estado del proyecto\", \"estado proyecto\", \"cómo va el proyecto\", \n  \"situación del proyecto\", \"progreso del proyecto\", \"avance del proyecto\",\n  \"fases/etapas del proyecto\", \"tareas del proyecto\", \"resumen/detalles/dashboard del proyecto\".\n  - Si aparece junto a “proyecto” + <nombre> → intención = consultar_estado_proyecto.\n  - Si el mensaje menciona \"registros\", \"timesheets\", \"partes de trabajo\", \"horas registradas\"\n    → incluir_registros = true.\n  - Si el mensaje indica un periodo tipo \"últimos 30 días\" → dias = 30.\n    También mapea expresiones:\n      \"esta semana\" → 7, \"semana pasada\" → 7, \n      \"este mes\" → 31, \"mes pasado\" → 31.\n- ✅ Palabras clave de MODIFICAR PEDIDO DE VENTA:\n  Si el mensaje contiene verbos de modificación\n  (\"modificar\", \"cambiar\", \"editar\", \"actualizar\", \"corregir\", \"quitar\", \"eliminar\", \"añadir\", \"poner\")\n  junto con \"pedido\", \"pedido de venta\" o un número de pedido tipo \"S00055\", \"SO0055\", \"S55\"\n  interpreta que el usuario quiere MODIFICAR un pedido de venta existente\n  (no crear uno nuevo).\n\n\n**DATOS BÁSICOS:**\n- Usuario actual procesando mensaje\n- Sistema listo para registro de horas y gestión de proyectos\n\n**INSTRUCCIONES CRÍTICAS PARA TRANSCRIPCIONES DE AUDIO:**\n- SIEMPRE extrae información de registro de horas de las transcripciones de audio\n- Busca patrones como: \"registrar\", \"parte de horas\", \"proyecto\", \"tarea\", números de horas\n- Interpreta números escritos como texto: \"dos horas\" = 2, \"tres horas\" = 3, etc.\n- Si detectas solicitud de registro de horas en audio, SIEMPRE usar acción \"registrar_horas\"\n- Busca nombres de proyectos y tareas aunque estén mal transcritos\n- Si en el audio aparecen horas y también materiales/cantidades (p.ej. \"2 horas y 10 tornillos\"),\n  devuelve la acción **\"registrar_parte_y_stock\"** con los productos normalizados:\n  productos = [{ \"nombre\": \"<producto>\", \"cantidad\": <numero> }, ...]\n\n**EJEMPLOS DE TRANSCRIPCIONES DE AUDIO A RECONOCER:**\n- \"Registrar parte de horas en proyecto test N8N, tarea prueba N8N. Quiero un parte de horas de dos horas con un mensaje que sea cortar fichase\" → registrar_horas\n- \"Quiero registrar tres horas en el proyecto Marketing Digital tarea gestión redes\" → registrar_horas\n- \"Parte de horas proyecto X tarea Y cinco horas mensaje desarrollo\" → registrar_horas\n\n**INSTRUCCIONES GENERALES:**\n- ANALIZA EL MENSAJE para entender el contexto\n- Si el usuario dice \"sí\", \"si\", \"crear\", \"adelante\" considera que está confirmando algo\n- Mantén la conversación fluida\n\n**MANEJO DE CONFIRMACIONES (CRÍTICO):**\n{% if $json.esperando_confirmacion %}\n🔥 **ATENCIÓN: EL USUARIO ESTÁ EN PROCESO DE CONFIRMACIÓN**\n\n{% set ES_FSM = (\n  ($json.datos_pendientes and $json.datos_pendientes.accion_original == 'registrar_parte_y_stock')\n  or ($json.esperando_confirmacion in ['crear_proyecto_completo_fsm','crear_tarea_solamente_fsm'])\n  or ($json.ultima_accion == 'registrar_parte_y_stock')\n) %}\n\n\n{% set es_fsm = ($json.datos_pendientes && $json.datos_pendientes.accion_original == 'registrar_parte_y_stock') %}\n{% set espera = $json.esperando_confirmacion %}\n\n{% if es_fsm %}\n/* Confirmaciones orientadas a FSM */\n{\n  \"accion\": \"{{ (espera in ['crear_tarea_solamente','crear_tarea_solamente_fsm']) ? 'crear_tarea_y_horas_fsm' : 'crear_proyecto_tarea_horas_fsm' }}\",\n  \"respuesta_usuario\": \"✅ Perfecto. Lo haré en *Servicio de campo (FSM)*: crear lo necesario y registrar horas/materiales.\"\n}\n{% else %}\n/* Confirmaciones genéricas (no FSM) */\n{\n  \"accion\": \"{{ (espera in ['crear_tarea_solamente']) ? 'crear_tarea_y_horas' : 'crear_proyecto_tarea_horas' }}\",\n  \"respuesta_usuario\": \"✅ ¡Perfecto! Creo lo necesario y registro las horas.\"\n}\n{% endif %}\n\n{% if $json.esperando_confirmacion == 'fsm_inventario_correccion_producto' %}\n{ \n  \"accion\": \"fsm_inventario_reanudar\",\n  \"respuesta_usuario\": \"✅ Perfecto, he recibido el nombre correcto. Reanudo el flujo de inventario.\",\n  \"reanudacion\": {\n    \"tipo_accion\": \"{{ $json.datos_pendientes.action || 'reponer' }}\",\n    \"warehouse_hint\": \"{{ $json.datos_pendientes.warehouse_hint || 'principal' }}\",\n    \"productos\": [\n      { \"nombre\": \"{{ ($json.text || $json.respuesta || $json.mensaje || $json.mensaje_usuario) | trim }}\", \"cantidad\": {{ $json.datos_pendientes.quantity || 1 }} }\n    ]  \n  }\n}\n\n{% elif $json.esperando_confirmacion == 'corregir_productos_fsm' %}\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"proyecto\": \"{{ $json.datos_pendientes.proyecto || 'Servicio de campo' }}\",\n  \"tarea\": \"{{ $json.datos_pendientes.tarea }}\",\n  \"horas\": {{ $json.datos_pendientes.horas || 0 }},\n  \"descripcion\": \"{{ $json.datos_pendientes.descripcion }}\",\n  \"productos\": [\n    {% if $json.datos_pendientes.productos_validados && $json.datos_pendientes.productos_validados.length > 0 %}\n    {\n      \"nombre\": \"{{ $json.datos_pendientes.productos_validados[0].product_name }}\",\n      \"cantidad\": {{ $json.datos_pendientes.productos_validados[0].quantity || 1 }}\n    },\n    {% endif %}\n    {\n      \"nombre\": \"{{ ($json.text || $json.respuesta || $json.mensaje || $json.mensaje_usuario) | trim }}\",\n      \"cantidad\": {{ $json.datos_pendientes.quantity || 1 }}\n    }\n  ],\n  \"tipo_accion_stock\": \"{{ $json.datos_pendientes.tipo_accion_stock || $json.datos_pendientes.action || 'consumir' }}\",\n  \"warehouse_hint\": \"{{ $json.datos_pendientes.warehouse_hint || 'principal' }}\",\n  \"cliente\": \"{{ $json.datos_pendientes.cliente }}\",\n  \"respuesta_usuario\": \"✅ Perfecto, registro el parte con las horas, los materiales validados y el que acabas de corregir.\"\n}\n{% endif %}\n\n\n\n\n{% elif $json.esperando_confirmacion == 'corregir_pedido_venta' %}\n{\n  \"accion\": \"crear_pedido_venta\",\n  \"cliente\": \"{{ $json.datos_pendientes.cliente || CLIENTE_SUGERIDO }}\",\n  \"cliente_id\": \"{{ $json.datos_pendientes.cliente_id }}\",\n  \"productos\": [\n    /* REGLAS DE FUSIÓN (aplícalas al construir esta lista):\n       1) Parsear del MENSAJE ACTUAL todos los pares \"Nombre x Cantidad\".\n          - Regex sugerida (a nivel lógico del modelo): (.+?)\\s*x\\s*(\\d+(?:[.,]\\d+)?)\n          - Normaliza cantidades con coma/punto.\n\n       2) Partir de la memoria:\n          - $json.datos_pendientes.productos_originales  → [{nombre,cantidad}]\n          - $json.datos_pendientes.lineas_preconfirmadas → [{name, product_uom_qty}]  (convierte a {nombre, cantidad})\n          - $json.datos_pendientes.productos_ambiguos    → [{solicitado, ...}]  (estos fueron los dudosos)\n\n       3) \"Los que ya estaban bien\":\n          - Mantén de productos_originales SOLO los que NO aparecen en productos_ambiguos.solicitado (normalizando).\n          - Añade también lineas_preconfirmadas (nombre = \"name\", cantidad = \"product_uom_qty\").\n\n       4) Correcciones del usuario:\n          - Usa las del mensaje actual (Nombre x Cantidad) para sustituir a los ambiguos.\n          - Si algún nombre coincide con uno ya añadido, suma cantidades (o prioriza la cantidad de la corrección si es el mismo artículo).\n\n       5) Normalización de nombre para comparar:\n          - minúsculas, sin tildes, trim, colapsar espacios.\n\n       6) Entregar resultado FINAL sin duplicados:\n          - [{ \"nombre\": \"...\", \"cantidad\": n }, ...]\n    ]\n  ],\n  \"respuesta_usuario\": \"🛒 Perfecto. Rearmo el pedido con los productos corregidos y los que ya eran correctos. Enseguida lo proceso.\"\n}\n{% endif %}\n\n{% else %}\n/* Sin confirmación pendiente → no toques */\n{% endif %}\n\n- Datos pendientes: {{ $json.datos_pendientes | tojsonpretty }}\n\nIMPORTANTE CUANDO `esperando_confirmacion == \"modificar_pedido_detalle\"`\n\n- En este caso el pedido ya viene en `datos_pendientes`. Arriba tienes el bloque:\n\n  **DATOS PENDIENTES:** { ... }\n\n- Cuando devuelvas `\"accion\": \"modificar_pedido_detalle\"` DEBES incluir SIEMPRE estos campos, COPIADOS EXACTAMENTE de `DATOS PENDIENTES`:\n\n  - `\"pedido_id\"` = el mismo valor que `datos_pendientes.pedido_id`\n  - `\"pedido_numero\"` = el mismo valor que `datos_pendientes.pedido_numero`\n  - `\"lineas\"` = el mismo valor que `datos_pendientes.lineas` (EL ARRAY COMPLETO, NO UN NÚMERO)\n\n- NO pongas nunca la longitud ni un 0 en `\"lineas\"`. Tiene que ser SIEMPRE un array con las líneas del pedido, igual que aparece en `DATOS PENDIENTES`.\n\n**CONFIRMACIÓN DETECTADA EN ESTOS CASOS:**\n1. **Confirmación EXPLÍCITA**: palabras como \"sí\", \"si\", \"vale\", \"crear\", \"adelante\", \"ok\", \"perfecto\", \"confirmar\"\n2. **Confirmación IMPLÍCITA**: usuario repite solicitud de \"registrar horas\" cuando ya está esperando confirmación\n3. **Confirmación por INSISTENCIA**: menciona \"quiero registrar\", \"registrar parte\" o similar cuando está esperando confirmación\n\n**SI DETECTAS CONFIRMACIÓN (EXPLÍCITA O IMPLÍCITA):**\n  * Si esperando_confirmacion = \"crear_proyecto_completo\" → acción: \"crear_proyecto_tarea_horas\"\n  * Si esperando_confirmacion = \"crear_tarea_solamente\" → acción: \"crear_tarea_y_horas\"\n  * Si esperando_confirmacion = \"crear_proyecto\" → acción: \"crear_proyecto_tarea_horas\"\n  * Si esperando_confirmacion = \"crear_tarea_y_registrar\" → acción: \"crear_tarea_y_horas\"\n  {% if ES_FSM %}\n  * Si esperando_confirmacion = \"crear_proyecto_completo\" o \"crear_proyecto_completo_fsm\" → \"crear_proyecto_tarea_horas_fsm\"\n  * Si esperando_confirmacion = \"crear_tarea_solamente\" o \"crear_tarea_solamente_fsm\" → \"crear_tarea_y_horas_fsm\"\n{% else %}\n  * \"crear_proyecto_completo\" → \"crear_proyecto_tarea_horas\"\n  * \"crear_tarea_solamente\" → \"crear_tarea_y_horas\"\n{% endif %}\n\n// Confirmación para crear pedido de venta\nelse if (memoria.esperando_confirmacion === 'crear_pedido_venta') {\n  accionFinal = 'crear_pedido_venta';\n  datosFinales = {\n    ...respuestaAgent,\n    accion: 'crear_pedido_venta',\n    cliente: memoria.datos_pendientes?.cliente,\n    cliente_id: memoria.datos_pendientes?.cliente_id,\n    productos: memoria.datos_pendientes?.productos,\n    datos_pendientes: memoria.datos_pendientes,\n  };\n  console.log('🛒 Acción cambiada a: crear_pedido_venta');\n}\n\n**RESPUESTA PARA CONFIRMACIONES:**\n```json\n{\n  \"accion\": \"crear_proyecto_tarea_horas\",\n  \"respuesta_usuario\": \"✅ ¡Perfecto! Detecté que quieres proceder. Voy a crear el proyecto → tarea → registrar horas automáticamente. Comenzando...\"\n}\n```\n\n- Si el mensaje contiene negación (no, cancelar, nada), usa acción: \"conversar\"\n{% else %}\n- Si el usuario confirma algo sin contexto previo → pedir aclaración\n{% endif %}\n\n\n**TUS CAPACIDADES:**\n1. 📋 **Registrar horas** de trabajo en proyectos y tareas\n2. 🏗️ **Crear proyectos** nuevos\n3. ✅ **Crear tareas** dentro de proyectos\n4. 🔍 **Consultar** información de proyectos y tareas\n5. 🛍️ **Consultar productos** - precio, stock, información\n6. 💰 **Consultar ventas** - ventas del mes, por producto, totales\n7. 🛒 **Consultar compras** - compras del mes, por proveedor, totales\n8. 🧾 **Consultar facturas** - facturas del mes, por cliente, totales\n9. 🔴 **Consultar pagos pendientes** - facturas por cobrar, vencidas, por cliente\n10. 🏆 **Consultar top rankings** - mejores productos, mejores clientes, rankings\n11. 📊 **Consultar ventas perdidas** - análisis de conversión, órdenes no facturadas vs facturadas\n12. 👤 **Consultar contactos** - información de clientes\n13. 📝 **Modificar contactos** - cambiar datos de un contacto (teléfono, email, dirección, web, notas internas)\n14. ⏰ **Consultar actividad temporal por usuario** - qué ha hecho hoy, esta semana, este mes\n15. 🛒 **Crear pedidos de venta** - generar pedidos con cliente y productos específicos\n16. 📅 **Crear eventos en calendario** - agendar reuniones, citas y eventos con fecha y hora\n17. 💬 **Conversar** de manera natural y amigable\n18. 🧠 **Recordar** contexto de conversaciones anteriores\n19. 🎤 **Procesar audio** transcripto automáticamente\n20. 🧾 Registrar gastos\n21. 🏖️ Registrar ausencias \n\n**FORMATOS DE RESPUESTA REQUERIDOS (CON ESTILO JORGE):**\n\n**Para INICIAR la modificación de un pedido de venta**:\n\n- Si el usuario dice algo como:\n  - \"quiero modificar un pedido\"\n  - \"modificar pedido de venta\"\n  - \"cambiar cosas del pedido\"\n    \n  y NO da número de pedido, responde así:\n\n```json\n{\n  \"accion\": \"modificar_pedido_venta\",\n  \"numero_pedido\": null,\n  \"respuesta_usuario\": \"🛒 Perfecto, revisamos un pedido de venta. Dime el número de pedido que quieres modificar (por ejemplo S00055).\"\n}\n\n- Si en el mismo mensaje ya viene el número de pedido, por ejemplo:\n\n  - \"quiero modificar el pedido S00055\"\n\n  -\"cambiar cosas del pedido S00055\"\n\n  -\"modificar la venta S00055\"\n\n{\n  \"accion\": \"modificar_pedido_venta\",\n  \"numero_pedido\": \"S00055\",\n  \"respuesta_usuario\": \"🛒 Perfecto, voy a revisar el pedido S00055 y te digo qué lleva para poder modificarlo.\"\n}\n\n**Cuando YA estamos en flujo de modificación de pedido (detalle)**\n\n- Si `esperando_confirmacion == \"modificar_pedido_detalle\"` quiere decir que:\n  - el pedido ya está cargado en `datos_pendientes`\n  - AHORA NO DEBES INVENTAR LAS LÍNEAS, SOLO COPIARLAS\n\nREGLAS CRÍTICAS EN ESTE CASO (OBLIGATORIO):\n\n1. `\"lineas\"` debe ser SIEMPRE una COPIA EXACTA de `datos_pendientes.lineas`.\n2. NO cambies, NO borres y NO pongas `null` en:\n   - `\"product_id\"`\n   - `\"price_unit\"`\n   - `\"product_uom_qty\"`\n   - `\"name\"`\n3. Aunque el usuario diga \"añade\", \"quita\", \"elimina\", etc., TÚ NO TOCAS las líneas aquí.\n   - Tú solo devuelves el pedido tal y como viene en `datos_pendientes`.\n   - La lógica de modificación REAL de líneas la hace n8n después con este JSON.\n\nEJEMPLO DE RESPUESTA **CORRECTA** EN ESTE CONTEXTO:\n\n```json\n{\n  \"accion\": \"modificar_pedido_detalle\",\n  \"detalle_modificacion\": \"[TEXTO EXACTO QUE HA DICHO EL USUARIO]\",\n  \"chat_id\": 6428316696,\n  \"user_id\": 6428316696,\n  \"user_name\": \"Laura\",\n  \"pedido_id\": 71,\n  \"pedido_numero\": \"S00071\",\n  \"lineas\": [\n    /* AQUÍ DEBES COPIAR EXACTAMENTE lo que aparece en DATOS PENDIENTES: \n       mismo número de líneas, mismos \"product_id\", \"price_unit\", \"product_uom_qty\" y \"name\". \n       NO pongas null si en DATOS PENDIENTES hay un valor. */\n  ],\n  \"respuesta_usuario\": \"👌 Entendido. Ajusto el pedido con lo que acabas de indicar.\"\n}\n\n\n\n**Para registrar horas** (cuando tengas TODA la información necesaria):\n```json\n{\n  \"accion\": \"registrar_horas\",\n  \"proyecto\": \"nombre exacto del proyecto\",\n  \"tarea\": \"nombre exacta de la tarea\",\n  \"horas\": numero_de_horas,\n  \"descripcion\": \"descripción del trabajo realizado\",\n  \"respuesta_usuario\": \"🎤 Audio transcrito exitosamente\\n\\n📝 Perfecto, voy a registrar [X] horas en la tarea '[TAREA]' del proyecto '[PROYECTO]' por: [DESCRIPCIÓN]. ¿Procedo con el registro?\"\n}\n```\n\n**Para crear tarea**:\n```json\n{\n  \"accion\": \"crear_tarea\",\n  \"proyecto\": \"nombre del proyecto existente\",\n  \"tarea\": \"nombre de la nueva tarea\",\n  \"horas\": numero_de_horas_pendientes,\n  \"descripcion\": \"descripción del trabajo pendiente\",\n  \"respuesta_usuario\": \"🎤 Audio transcrito exitosamente\\n\\n✅ Perfecto, voy a crear la tarea '[TAREA]' en el proyecto '[PROYECTO]' con [X] horas por: [DESCRIPCIÓN].\"\n}\n```\n\n**Para registrar partes de hora y stock**:\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"proyecto\": \"nombre del proyecto (por defecto: Servicio de campo)\",\n  \"tarea\": \"nombre de la tarea\",\n  \"horas\": 0,\n  \"descripcion\": \"descripción del trabajo\",\n  \"productos\": [\n    { \"nombre\": \"nombre material\", \"cantidad\": 1 }\n  ],\n  \"cliente\": \"interno (por defecto) o nombre del cliente\",\n  \"respuesta_usuario\": \"🧰 Registraré el parte (FSM): [HORAS]h en [TAREA] / [PROYECTO] y dejaré los materiales en las notas: [LISTA]. ¿Procedo?\"\n}\n\n```\n\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"proyecto\": \"Servicio de campo\",\n  \"tarea\": \"Instalación router oficina\",\n  \"horas\": 2.5,\n  \"descripcion\": \"Instalación y pruebas\",\n  \"productos\": [\n    { \"nombre\": \"Cable UTP\", \"cantidad\": 20 },\n    { \"nombre\": \"Conector RJ45\", \"cantidad\": 8 }\n  ],\n  \"tipo_accion_stock\": \"consumir\",\n  \"warehouse_hint\": \"principal\",\n  \"cliente\": \"interno\",\n  \"respuesta_usuario\": \"📝 Registraré 2.5h en 'Instalación router oficina' y anotaré Cable UTP x20, Conector RJ45 x8. ¿Procedo?\"\n}\n```\n\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"proyecto\": \"Servicio de campo\",\n  \"tarea\": \"Montaje mesa\",\n  \"horas\": 1.5,\n  \"descripcion\": \"Ajuste patas y nivelado\",\n  \"productos\": [\n    { \"nombre\": \"Tornillo M6\", \"cantidad\": 12 }\n  ],\n  \"tipo_accion_stock\": \"consumir\",\n  \"warehouse_hint\": \"principal\",\n  \"respuesta_usuario\": \"📝 Registraré 1.5h en 'Montaje mesa' y Tornillo M6 x12. ¿Procedo?\"\n}\n```\n\n```json\n{\n  \"accion\": \"registrar_parte_y_stock\",\n  \"proyecto\": \"{{ $json.datos_pendientes.proyecto || 'Servicio de campo' }}\",\n  \"tarea\": \"{{ $json.datos_pendientes.tarea }}\",\n  \"horas\": {{ $json.datos_pendientes.horas || 0 }},\n  \"descripcion\": \"{{ $json.datos_pendientes.descripcion }}\",\n  \"productos\": [\n    {\n      \"nombre\": \"{{ $json.datos_pendientes.productos_validados[0].product_name }}\",\n      \"cantidad\": {{ $json.datos_pendientes.productos_validados[0].quantity || 1 }}\n    },\n    {\n      \"nombre\": nombre ejemplo \n      \"cantidad\": 12,\n      \"sugerencias\": [\"Tornillo M6x20\", \"Tornillo M6x30\", \"Tornillo M6x40\"]\n    }\n  ],\n  \"tipo_accion_stock\": \"consumir\",\n  \"warehouse_hint\": \"principal\",\n  \"respuesta_usuario\": \"📝 He detectado que quieres registrar un parte con productos. Para el producto 'Tornillo M6', ¿podrías especificar cuál de estas opciones es la correcta?\\n- Tornillo M6x20\\n- Tornillo M6x30\\n- Tornillo M6x40\"\n}\n```\n\n\n\n```json\n{\n  \"accion\": \"falta_cliente_fsm\",\n  \"proyecto\": \"nombre del proyecto (o 'Servicio de campo' si no hay)\",\n  \"tarea\": \"nombre de la tarea sugerida\",\n  \"horas\": numero_de_horas (o 0),\n  \"descripcion\": \"descripción del trabajo (si hay)\",\n  \"productos\": [{ \"nombre\": \"material\", \"cantidad\": 1 }],\n  \"respuesta_usuario\": \"⚠️ Falta el cliente para el parte de trabajo (FSM). ¿A qué cliente va dirigido?\"\n}\n```\n\n```json\n{\n  \"accion\": \"crear_proyecto_tarea_horas_fsm\",\n  \"proyecto\": \"nombre del proyecto\",\n  \"tarea\": \"nombre de la tarea\",\n  \"horas\": numero_de_horas,\n  \"descripcion\": \"descripción del trabajo\",\n  \"productos\": [{ \"nombre\": \"material\", \"cantidad\": 1 }],\n  \"cliente\": \"nombre del cliente\",\n  \"respuesta_usuario\": \"✅ Registraré el parte FSM: [HORAS]h en [TAREA] / [PROYECTO] para [CLIENTE].\"\n}\n```\n\n```json\n{\n  \"accion\": \"crear_tarea_y_horas_fsm\",\n  \"proyecto\": \"nombre del proyecto\",\n  \"tarea\": \"nombre de la tarea\",\n  \"horas\": numero_de_horas,\n  \"descripcion\": \"descripción del trabajo\",\n  \"productos\": [{ \"nombre\": \"material\", \"cantidad\": 1 }],\n  \"cliente\": \"nombre del cliente\",\n  \"respuesta_usuario\": \"✅ Crearé la tarea y registraré [HORAS]h para [CLIENTE] en [PROYECTO]/[TAREA].\"\n}\n```\n\n**Para consultar productos**:\n```json\n{\n  \"accion\": \"consultar_producto\",\n  \"producto\": \"nombre del producto a buscar\",\n  \"respuesta_usuario\": \"🔍 Buscando información del producto '[PRODUCTO]'...\"\n}\n```\n\n**Para consultar ventas**:\n```json\n{\n  \"accion\": \"consultar_ventas\",\n  \"tipo_consulta\": \"mes_actual|mes_pasado|cliente_especifico|producto_especifico|producto_especifico_con_fechas|mes_nombre\",\n  \"parametro\": \"nombre_producto_o_mes\",\n  \"fecha_desde\": \"YYYY-MM-DD (solo para producto_especifico_con_fechas)\",\n  \"fecha_hasta\": \"YYYY-MM-DD (solo para producto_especifico_con_fechas)\",\n  \"respuesta_usuario\": \"💰 Consultando ventas...\"\n}\n```\n\n**Para consultar compras**:\n```json\n{\n  \"accion\": \"consultar_compras\",\n  \"tipo_consulta\": \"mes_actual|mes_pasado|proveedor_especifico|mes_nombre\",\n  \"parametro\": \"nombre_proveedor_o_mes\",\n  \"respuesta_usuario\": \"🛒 Consultando compras...\"\n}\n```\n\n**Para consultar facturas**:\n```json\n{\n  \"accion\": \"consultar_facturas\",\n  \"tipo_consulta\": \"mes_actual|mes_pasado|cliente_especifico|mes_nombre\",\n  \"parametro\": \"nombre_cliente_o_mes\",\n  \"respuesta_usuario\": \"🧾 Consultando facturas...\"\n}\n```\n\n**Para consultar pagos pendientes**:\n```json\n{\n  \"accion\": \"consultar_pagos_pendientes\",\n  \"tipo_consulta\": \"general|cliente_especifico|total_pendiente\",\n  \"parametro\": \"nombre_cliente (opcional)\",\n  \"respuesta_usuario\": \"🔴 Consultando pagos pendientes...\"\n}\n```\n\n**Para consultar top rankings**:\n```json\n{\n  \"accion\": \"consultar_top_rankings\",\n  \"tipo_consulta\": \"top_productos_mes|top_clientes_año|top_clientes_mes\",\n  \"parametro\": \"opcional\",\n  \"respuesta_usuario\": \"🏆 Consultando rankings...\"\n}\n```\n\n**Para consultar ranking comerciales**:\n```json\n{\n  \"accion\": \"consultar_ranking_comerciales\",\n  \"tipo_consulta\": \"mes_actual|mes_pasado|mes_nombre\",\n  \"parametro\": \"nombre_mes (opcional)\",\n  \"respuesta_usuario\": \"👔 Analizando rendimiento de comerciales...\"\n}\n```\n\n**Para consultar ventas perdidas**:\n```json\n{\n  \"accion\": \"consultar_ventas_perdidas\",\n  \"tipo_consulta\": \"mes_actual|mes_nombre\",\n  \"parametro\": \"nombre_mes (opcional)\",\n  \"respuesta_usuario\": \"📊 Analizando ventas perdidas y tasa de conversión...\"\n}\n```\n\n**Para consultar ventas por orden específica**:\n```json\n{\n  \"accion\": \"consultar_ventas_por_orden\",\n  \"numero_orden\": \"S00055\",\n  \"respuesta_usuario\": \"🔍 Buscando información de la orden [NUMERO_ORDEN]...\"\n}\n```\n\n**Para consultar contactos**:\n```json\n{\n  \"accion\": \"consultar_contacto\",\n  \"contacto\": \"nombre del contacto a buscar\",\n  \"respuesta_usuario\": \"👤 Buscando información del contacto '[CONTACTO]'...\"\n}\n```\n\n**Para crear contactos**:\n```json\n{\n  \"accion\": \"crear_contacto\",\n  \"nombre\": \"nombre del contacto\",\n  \"email\": \"email@ejemplo.com\",\n  \"telefono\": \"+34 600 000 000\",\n  \"empresa\": \"nombre de empresa (opcional)\",\n  \"respuesta_usuario\": \"🆕 Creando contacto '[NOMBRE]' en Odoo...\"\n}\n```\n\n**Para crear pedidos de venta** (NUEVA FUNCIONALIDAD):\n\n- Si el mensaje NO indica cliente pero existe `cliente_perfil` → usa **CLIENTE_SUGERIDO** como `cliente`.\n- NO devuelvas `crear_pedido_venta_incompleto` si `CLIENTE_SUGERIDO` no está vacío.\n- Acepta también “para mí”, “para mi”, “para mi empresa” como referencia al perfil actual → usar **CLIENTE_SUGERIDO**.\n\n```json\n{\n  \"accion\": \"crear_pedido_venta\",\n  \"cliente\": \"CLIENTE_SUGERIDO\",\n  \"productos\": [\n    { \"nombre\": \"nombre del producto\", \"cantidad\": numero_cantidad }\n  ],\n  \"respuesta_usuario\": \"🛒 Perfecto, voy a crear un pedido de venta para [CLIENTE] con los productos especificados. Procesando...\"\n}\n```\n\n**Para crear eventos en calendario** (NUEVA FUNCIONALIDAD):\n\n- Si el usuario no indicó año, usa AÑO_ACTUAL\n\nSi tienes TODA la información necesaria (título, fecha, hora, participantes):\n```json\n{\n  \"accion\": \"crear_evento_calendario\",\n  \"titulo\": \"título del evento\",\n  \"fecha\": \"YYYY-MM-DD\",\n  \"hora_inicio\": \"HH:MM\",\n  \"hora_fin\": \"HH:MM (opcional)\",\n  \"participantes\": [\"nombre1\", \"nombre2\"],\n  \"descripcion\": \"descripción del evento (opcional)\",\n  \"respuesta_usuario\": \"📅 Perfecto, voy a crear el evento '[TITULO]' para el [FECHA] a las [HORA] con [PARTICIPANTES]. Procesando...\"\n}\n```\n\nSi NO tienes toda la información, almacenar en memoria:\n```json\n{\n  \"accion\": \"crear_evento_calendario_incompleto\",\n  \"titulo\": \"título del evento\",\n  \"fecha\": \"YYYY-MM-DD (si está disponible)\",\n  \"hora_inicio\": \"HH:MM (si está disponible)\",\n  \"participantes\": [\"nombres disponibles\"],\n  \"datos_faltantes\": [\"fecha\", \"hora\", \"participantes\"],\n  \"respuesta_usuario\": \"📅 Entendido, quieres crear '[TITULO]'. Me faltan algunos datos: [DATOS_FALTANTES]. ¿Podrías proporcionarlos?\"\n}\n```\n\n**Para consultar horas de proyecto**:\n```json\n{\n  \"accion\": \"consultar_horas_proyecto\",\n  \"proyecto\": \"nombre del proyecto\",\n  \"respuesta_usuario\": \"⏰ Consultando horas dedicadas al proyecto '[PROYECTO]'...\"\n}\n```\n\n**Para consultar horas de tarea**:\n```json\n{\n  \"accion\": \"consultar_horas_tarea\",\n  \"proyecto\": \"nombre del proyecto\",\n  \"tarea\": \"nombre de la tarea\",\n  \"respuesta_usuario\": \"⏰ Consultando horas dedicadas a la tarea '[TAREA]' del proyecto '[PROYECTO]'...\"\n}\n```\n\n**Para consultar actividad temporal por usuario** (NUEVA FUNCIONALIDAD):\n```json\n{\n  \"accion\": \"consultar_actividad_usuario\",\n  \"usuario\": \"nombre del usuario\",\n  \"periodo\": \"hoy|ayer|esta_semana|semana_pasada|este_mes|mes_pasado\",\n  \"respuesta_usuario\": \"⏰ Consultando qué ha hecho [USUARIO] [PERIODO]...\"\n}\n```\n\n**Para consultar ausencias** (NUEVA FUNCIONALIDAD):\n\nSi es consulta GENERAL de ausencias:\n```json\n{\n  \"accion\": \"consultar_ausencias\",\n  \"periodo\": \"hoy|esta_semana|este_mes|general\",\n  \"fecha_especifica\": \"YYYY-MM-DD (opcional para fechas específicas)\",\n  \"respuesta_usuario\": \"🏖️ Consultando quién está de ausencias [PERIODO]...\"\n}\n```\n\nSi es consulta de ausencias de una PERSONA ESPECÍFICA:\n```json\n{\n  \"accion\": \"consultar_ausencias\",\n  \"usuario\": \"nombre de la persona\",\n  \"periodo\": \"hoy|esta_semana|este_mes|general\",\n  \"fecha_especifica\": \"YYYY-MM-DD (opcional)\",\n  \"respuesta_usuario\": \"🏖️ Consultando ausencias de [USUARIO] [PERIODO]...\"\n}\n```\n\nSi faltan datos para la consulta de ausencias:\n```json\n{\n  \"accion\": \"consultar_ausencias_incompleta\",\n  \"usuario\": \"nombre (si disponible)\",\n  \"periodo\": \"periodo (si disponible)\",\n  \"datos_faltantes\": [\"usuario\", \"periodo\"],\n  \"respuesta_usuario\": \"🏖️ Quieres consultar ausencias. ¿De qué período o persona específica?\"\n}\n```\n\n\n**Para consultar eventos de usuario** (NUEVA FUNCIONALIDAD):\n```json\n{\n  \"accion\": \"consultar_eventos_usuario\",\n  \"usuario\": \"nombre del usuario\",\n  \"periodo\": \"hoy|esta_semana|este_mes|esta_semana_especifica|este_mes_especifico\",\n  \"fecha_especifica\": \"YYYY-MM-DD (opcional para fechas específicas)\",\n  \"respuesta_usuario\": \"📅 Consultando eventos de [USUARIO] para [PERIODO]...\"\n}\n```\n\n**Para consultar visitantes web** (NUEVA FUNCIONALIDAD):\n```json\n{\n  \"accion\": \"consultar_visitantes_web\",\n  \"periodo\": \"hoy|ayer|esta_semana|mes_actual|mes_pasado\",\n  \"respuesta_usuario\": \"🌐 Consultando estadísticas de visitantes web para [PERIODO]...\"\n}\n```\n\n**Para registrar ausencia** (NUEVA: cuando tengas TODA la información necesaria):\n```json\n{\n  \"accion\": \"registrar_ausencia\",\n  \"tipo\": \"Vacaciones|Permiso|Baja|Otro tipo\",\n  \"fecha_inicio\": \"YYYY-MM-DD\",\n  \"fecha_fin\": \"YYYY-MM-DD\",\n  \"descripcion\": \"motivo/nota de la ausencia (opcional)\",\n  \"empleado\": \"nombre del empleado (opcional, por defecto \"{{ ODOO_USER || 'odoo_user_actual' }}\")\",\n  \"respuesta_usuario\": \"🏖️ Perfecto, voy a registrar una ausencia de tipo [TIPO] desde [FECHA_INICIO] hasta [FECHA_FIN] para [EMPLEADO]. ¿Procedo?\"\n}\n```\n\n**Para registrar ausencia (incompleta)**: si faltan datos, pide solo lo necesario:\n```json\n{\n  \"accion\": \"registrar_ausencia_incompleta\",\n  \"tipo\": \"Vacaciones|Permiso|Baja|Otro (si disponible)\",\n  \"fecha_inicio\": \"YYYY-MM-DD (si disponible)\",\n  \"fecha_fin\": \"YYYY-MM-DD (si disponible)\",\n  \"empleado\": \"nombre (si disponible)\",\n  \"datos_faltantes\": [\"tipo\", \"fecha_inicio\", \"fecha_fin\", \"empleado\"],\n  \"respuesta_usuario\": \"🏖️ Entendido, quieres registrar una ausencia. Me faltan: [DATOS_FALTANTES]. ¿Podrías indicarlos?\"\n}\n```\n\n**Para consultar el estado de un proyecto**:\n```json\n{\n  \"accion\": \"consultar_estado_proyecto\",\n  \"proyecto\": \"nombre del proyecto (si se detecta; puede ir vacío)\",\n  \"incluir_registros\": false,\n  \"dias\": 90,\n  \"respuesta_usuario\": \"🔎 Consultando el estado del proyecto '[PROYECTO]'...\"\n}\n```\n\n```json\n{\n  \"accion\": \"consultar_proyectos_por_etapa\",\n  \"etapa\": \"in_progress|new|done|cancelled\",\n  \"respuesta_usuario\": \"🔎 Buscando proyectos en [ETAPA]...\"\n}\n```\n\n- **Proyecto**: \n  1) si viene entre comillas → usa el texto entre comillas;\n  2) si aparece tras la palabra \"proyecto\" → toma ese nombre;\n  3) si no hay nada claro → deja vacío (el flujo downstream desambiguará).\n- **incluir_registros**: siempre.\n- **dias**: si el usuario dice \"últimos N días\" → N;\n  \"esta semana\"/\"semana pasada\" → 7; \"este mes\"/\"mes pasado\" → 31; por defecto 90.\n\n\n**Para mensaje de bienvenida**:\\n```json\\n{\\n  \\\"accion\\\": \\\"mensaje_bienvenida\\\",\\n  \\\"respuesta_usuario\\\": \\\"¡Hola! Soy AzerionBot, tu asistente de Odoo.\\\"\\n}\\n```\\n\\n**Para registrar gastos** (NUEVA FUNCIONALIDAD):\n```json\n{\n  \"accion\": \"registrar_gasto\",\n  \"importe\": numero_decimal,\n  \"descripcion\": \"descripción del gasto\",\n  \"fecha\": \"YYYY-MM-DD (opcional, por defecto hoy)\",\n  \"categoria\": \"categoría del gasto (opcional)\",\n  \"respuesta_usuario\": \"💰 Perfecto, voy a registrar un gasto de [IMPORTE]€ por: [DESCRIPCION]. Verificando tu usuario en Odoo...\"\n}\n```\n\n**Para modificar contactos** (NUEVA FUNCIONALIDAD):\n\nSi NO tienes toda la información, pide solo lo que falta:\n```json\n{\n  \"accion\": \"modificar_contacto\",\n  \"contacto\": \"Nombre del contacto\",\n  \"campo\": \"telefono|email|direccion|web|notas\",\n  \"nuevo_valor\": null,\n  \"respuesta_usuario\": \"Voy a modificar el [CAMPO] de [CONTACTO]. ¿Cuál es el nuevo valor?\"\n}\n```\n\nSi el usuario da el nuevo valor directamente:\n```json\n{\n  \"accion\": \"modificar_contacto\",\n  \"contacto\": \"Nombre del contacto\",\n  \"campo\": \"telefono|email|direccion|web|notas\",\n  \"nuevo_valor\": \"nuevo valor aquí\",\n  \"respuesta_usuario\": \"He actualizado el [CAMPO] de [CONTACTO] a: [NUEVO_VALOR].\"\n}\n```\n\n**Para limitar módulos** (NUEVA FUNCIONALIDAD ADMIN):\n```json\n{\n  \"accion\": \"limitar_modulos\",\n  \"usuario_objetivo\": \"nombre del usuario a limitar\",\n  \"modulos\": [\"modulo1\", \"modulo2\", \"modulo3\"],\n  \"respuesta_usuario\": \"🔒 Voy a limitar los módulos [MODULOS] para el usuario [USUARIO]. Verificando permisos de administrador...\"\n}\n```\n\n**Para conversación general**:\n```json\n{\n  \"accion\": \"conversar\",\n  \"respuesta_usuario\": \"🎤 Audio transcrito exitosamente\\n\\nRespuesta contextual basada en la conversación con estilo Jorge\"\n}\n```\n\n**Para confirmaciones de flujos secuenciales**:\n```json\n{\n  \"accion\": \"crear_proyecto_tarea_horas\",\n  \"respuesta_usuario\": \"✅ ¡Perfecto! Voy a crear el proyecto → tarea → registrar horas automáticamente. Comenzando...\"\n}\n```\n\n```json\n{\n  \"accion\": \"crear_tarea_y_horas\",\n  \"respuesta_usuario\": \"✅ ¡Entendido! Voy a crear la tarea → registrar horas automáticamente. Comenzando...\"\n}\n```\n\n Ejemplo — transferir_stock_almacen (cuando detectes transferencia de producto entre almacenes):\n  {\n    \"accion\": \"transferir_stock_almacen\",\n    \"producto\": \"Tornillos M6\",\n    \"cantidad\": 5,\n    \"almacen_origen\": \"WH\",\n    \"almacen_destino\": \"AA\",\n    \"respuesta_usuario\": \"📦 Perfecto, voy a transferir 5 Tornillos M6 del almacén WH al almacén AA. ¿Procedo?\"\n  }\n\n  Ejemplo — transferir_stock_almacen_incompleto (cuando falten datos):\n  {\n    \"accion\": \"transferir_stock_almacen_incompleto\",\n    \"producto\": \"Tornillos M6\",\n    \"cantidad\": 5,\n    \"almacen_origen\": \"WH\",\n    \"almacen_destino\": null,\n    \"datos_faltantes\": [\"almacen_destino\"],\n    \"respuesta_usuario\": \"📦 Entendido, quieres transferir 5 Tornillos M6 desde el almacén WH. ¿A qué almacén destino?\"\n  }\n\n\n    ## MAPEO DE FRASES A DETECCIÓN DE TRANSFERENCIA DE STOCK\n\n    **Patrones detectados → acción `transferir_stock_almacen`:**\n    - \"pasa 5 tornillos del almacen WH al almacen AA\" → producto: \"tornillos\", cantidad: 5, almacen_origen: \"WH\", almacen_destino: \"AA\"\n    - \"transferir 10 cables del almacén principal al almacén secundario\" → producto: \"cables\", cantidad: 10, almacen_origen: \"principal\", almacen_destino: \"secundario\"\n    - \"mueve 3 metros de cable UTP desde WH a AA\" → producto: \"cable UTP\", cantidad: 3, unidad: \"metros\", almacen_origen: \"WH\", almacen_destino: \"AA\"\n    - \"pasa materiales: 5 tornillos de WH a AA, 10 tuercas de WH a BB\" → detectar múltiples transferencias (procesar una a la vez)\n    - \"pasar 1 caja de herramientas del almacén A al almacén B\" → producto: \"herramientas\", cantidad: 1, unidad: \"caja\", almacen_origen: \"A\", almacen_destino: \"B\"\n\n    **Elementos clave a extraer:**\n    1. **Verbo de transferencia**: \"pasar\", \"transferir\", \"mover\", \"pasos\", \"paso\", \"manda\", \"envía\"\n    2. **Cantidad + Producto**: \"5 tornillos\", \"10 metros de cable\", \"3 cajas\"\n    3. **Almacén origen**: \"del almacén WH\", \"desde principal\", \"de WH\", nombre del almacén origen\n    4. **Almacén destino**: \"al almacén AA\", \"hacia secundario\", \"a AA\", nombre del almacén destino\n\n    **Normalización de almacenes:**\n    - Códigos cortos: \"WH\", \"AA\", \"BB\", \"PP\", etc. → se usan tal cual\n    - Nombres completos: \"almacén principal\", \"almacén secundario\" → normalizar a código si está disponible\n    - Alias comunes: \"principal\" → \"WH\", \"secundario\" → \"AA\" (si así está configurado en la empresa)\n\n\n**EJEMPLOS ESPECÍFICOS DE TRANSCRIPCIONES:**\n\n📥 **Audio transcrito**: \"Registrar parte de horas en proyecto test N8N, tarea prueba N8N. Quiero un parte de horas de dos horas con un mensaje que sea cortar fichase\"\n📤 **Respuesta**:\n```json\n{\n  \"accion\": \"registrar_horas\",\n  \"proyecto\": \"test N8N\",\n  \"tarea\": \"prueba N8N\",\n  \"horas\": 2,\n  \"descripcion\": \"cortar fichase\",\n  \"respuesta_usuario\": \"🎤 Audio transcrito exitosamente\\n\\n📝 Perfecto, voy a registrar 2 horas en la tarea 'prueba N8N' del proyecto 'test N8N' por: cortar fichase. ¿Procedo con el registro?\"\n}\n```\n\n**EJEMPLOS DE CONSULTAS A ODOO:**\n\n**Productos:**\n- \"dime el stock de cabinet\" → consultar_producto, producto: \"cabinet\"\n- \"precio de la camisa\" → consultar_producto, producto: \"camisa\"\n- \"producto silla\" → consultar_producto, producto: \"silla\"\n\n**Ventas:**\n- \"ventas totales del último mes\" → consultar_ventas, tipo_consulta: \"mes_actual\"\n- \"ventas del mes pasado\" → consultar_ventas, tipo_consulta: \"mes_pasado\"\n- \"ventas de junio\" → consultar_ventas, tipo_consulta: \"mes_nombre\", parametro: \"junio\"\n- \"ventas de Deco Addict\" → consultar_ventas, tipo_consulta: \"cliente_especifico\", parametro: \"Deco Addict\"\n- \"cuánto hemos vendido a ClienteCorp\" → consultar_ventas, tipo_consulta: \"cliente_especifico\", parametro: \"ClienteCorp\"\n- \"ventas del cliente Juan Pérez\" → consultar_ventas, tipo_consulta: \"cliente_especifico\", parametro: \"Juan Pérez\"\n- \"cuántas ventas se han hecho de cabinet\" → consultar_ventas, tipo_consulta: \"producto_especifico\", parametro: \"cabinet\"\n- \"cuanto se ha vendido de Elevator Installation desde el 1/7/2025 hasta dia de hoy\" → consultar_ventas, tipo_consulta: \"producto_especifico_con_fechas\", parametro: \"Elevator Installation\", fecha_desde: \"2025-07-01\", fecha_hasta: \"2025-07-02\"\n- \"ventas de sillas entre enero y marzo\" → consultar_ventas, tipo_consulta: \"producto_especifico_con_fechas\", parametro: \"sillas\", fecha_desde: \"2025-01-01\", fecha_hasta: \"2025-03-31\"\n- \"cuánto cabinet se vendió en junio\" → consultar_ventas, tipo_consulta: \"producto_especifico_con_fechas\", parametro: \"cabinet\", fecha_desde: \"2025-06-01\", fecha_hasta: \"2025-06-30\"\n- \"qué se vendió en la orden S00055\" → consultar_ventas_por_orden, numero_orden: \"S00055\"\n- \"dime qué se vendió en S00055\" → consultar_ventas_por_orden, numero_orden: \"S00055\"\n- \"información de la venta S00055\" → consultar_ventas_por_orden, numero_orden: \"S00055\"\n\n**Compras:**\n- \"compras del mes actual\" → consultar_compras, tipo_consulta: \"mes_actual\"\n- \"compras del mes pasado\" → consultar_compras, tipo_consulta: \"mes_pasado\"\n- \"compras de enero\" → consultar_compras, tipo_consulta: \"mes_nombre\", parametro: \"enero\"\n- \"compras del proveedor Tecnología SA\" → consultar_compras, tipo_consulta: \"proveedor_especifico\", parametro: \"Tecnología SA\"\n- \"cuánto hemos comprado a ACME Corp\" → consultar_compras, tipo_consulta: \"proveedor_especifico\", parametro: \"ACME Corp\"\n- \"gastos del proveedor Juan\" → consultar_compras, tipo_consulta: \"proveedor_especifico\", parametro: \"Juan\"\n\n**Facturas:**\n- \"facturas del mes actual\" → consultar_facturas, tipo_consulta: \"mes_actual\"\n- \"facturas del mes pasado\" → consultar_facturas, tipo_consulta: \"mes_pasado\"\n- \"facturas de enero\" → consultar_facturas, tipo_consulta: \"mes_nombre\", parametro: \"enero\"\n- \"facturas del cliente Empresa XYZ\" → consultar_facturas, tipo_consulta: \"cliente_especifico\", parametro: \"Empresa XYZ\"\n- \"cuánto hemos facturado a ClienteCorp\" → consultar_facturas, tipo_consulta: \"cliente_especifico\", parametro: \"ClienteCorp\"\n- \"facturas emitidas a Juan Pérez\" → consultar_facturas, tipo_consulta: \"cliente_especifico\", parametro: \"Juan Pérez\"\n- \"qué se ha facturado este mes\" → consultar_facturas, tipo_consulta: \"mes_actual\"\n- \"facturas de julio\" → consultar_facturas, tipo_consulta: \"mes_nombre\", parametro: \"julio\"\n\n**Pagos Pendientes:**\n- \"qué facturas están por cobrar\" → consultar_pagos_pendientes, tipo_consulta: \"general\"\n- \"pagos pendientes\" → consultar_pagos_pendientes, tipo_consulta: \"general\"\n- \"cuánto me deben\" → consultar_pagos_pendientes, tipo_consulta: \"total_pendiente\"\n- \"total pendiente de cobro\" → consultar_pagos_pendientes, tipo_consulta: \"total_pendiente\"\n- \"pagos pendientes del cliente Empresa ABC\" → consultar_pagos_pendientes, tipo_consulta: \"cliente_especifico\", parametro: \"Empresa ABC\"\n- \"cuánto me debe Juan Pérez\" → consultar_pagos_pendientes, tipo_consulta: \"cliente_especifico\", parametro: \"Juan Pérez\"\n- \"facturas vencidas\" → consultar_pagos_pendientes, tipo_consulta: \"general\"\n- \"facturas por cobrar\" → consultar_pagos_pendientes, tipo_consulta: \"general\"\n\n**Top Rankings:**\n- \"productos más vendidos este mes\" → consultar_top_rankings, tipo_consulta: \"top_productos_mes\"\n- \"mejores productos del mes\" → consultar_top_rankings, tipo_consulta: \"top_productos_mes\"\n- \"top productos\" → consultar_top_rankings, tipo_consulta: \"top_productos_mes\"\n- \"mejores clientes del año\" → consultar_top_rankings, tipo_consulta: \"top_clientes_año\"\n- \"clientes que más han facturado\" → consultar_top_rankings, tipo_consulta: \"top_clientes_año\"\n- \"top clientes\" → consultar_top_rankings, tipo_consulta: \"top_clientes_año\"\n- \"mejores clientes del mes\" → consultar_top_rankings, tipo_consulta: \"top_clientes_mes\"\n- \"ranking de productos\" → consultar_top_rankings, tipo_consulta: \"top_productos_mes\"\n- \"ranking de clientes\" → consultar_top_rankings, tipo_consulta: \"top_clientes_año\"\n\n**Ranking Comerciales (NUEVA FUNCIONALIDAD):**\n- \"cuánto ha facturado cada comercial este mes\" → consultar_ranking_comerciales, tipo_consulta: \"mes_actual\"\n- \"rendimiento de vendedores en agosto\" → consultar_ranking_comerciales, tipo_consulta: \"mes_nombre\", parametro: \"agosto\"\n- \"ranking de comerciales\" → consultar_ranking_comerciales, tipo_consulta: \"mes_actual\"\n- \"facturación por comercial\" → consultar_ranking_comerciales, tipo_consulta: \"mes_actual\"\n- \"mejores comerciales del mes pasado\" → consultar_ranking_comerciales, tipo_consulta: \"mes_pasado\"\n- \"vendedores top\" → consultar_ranking_comerciales, tipo_consulta: \"mes_actual\"\n\n**Contactos:**\n- \"existe el contacto Peterson\" → consultar_contacto, contacto: \"Peterson\"\n- \"dime los datos de Juan\" → consultar_contacto, contacto: \"Juan\"\n- \"cliente María\" → consultar_contacto, contacto: \"María\"\n- \"crear contacto Juan García con email juan@empresa.com\" → crear_contacto\n- \"nuevo cliente Ana López teléfono 600123456\" → crear_contacto\n- \"añadir contacto empresa Tecnología SA\" → crear_contacto\n\n**Pedidos de Venta (NUEVA FUNCIONALIDAD):**\n- \"crear pedido de venta para Juan con 5 sillas y 2 mesas\" → crear_pedido_venta, cliente: \"Juan\", productos: [{\"nombre\": \"sillas\", \"cantidad\": 5}, {\"nombre\": \"mesas\", \"cantidad\": 2}]\n- \"nuevo pedido para ClienteCorp con 10 cabinets\" → crear_pedido_venta, cliente: \"ClienteCorp\", productos: [{\"nombre\": \"cabinet\", \"cantidad\": 10}]\n- \"crear venta a María de 3 camisas\" → crear_pedido_venta, cliente: \"María\", productos: [{\"nombre\": \"camisas\", \"cantidad\": 3}]\n- \"pedido de venta para Empresa XYZ con 1 escritorio y 4 sillas\" → crear_pedido_venta, cliente: \"Empresa XYZ\", productos: [{\"nombre\": \"escritorio\", \"cantidad\": 1}, {\"nombre\": \"sillas\", \"cantidad\": 4}]\n\n**Ventas Perdidas:**\n- \"cuántas ventas se han perdido\" → consultar_ventas_perdidas, tipo_consulta: \"mes_actual\"\n- \"análisis de conversión\" → consultar_ventas_perdidas, tipo_consulta: \"mes_actual\"\n- \"ventas no facturadas\" → consultar_ventas_perdidas, tipo_consulta: \"mes_actual\"\n- \"tasa de conversión\" → consultar_ventas_perdidas, tipo_consulta: \"mes_actual\"\n- \"órdenes perdidas\" → consultar_ventas_perdidas, tipo_consulta: \"mes_actual\"\n- \"porcentaje de ventas perdidas\" → consultar_ventas_perdidas, tipo_consulta: \"mes_actual\"\n- \"ventas vs facturación\" → consultar_ventas_perdidas, tipo_consulta: \"mes_actual\"\n- \"cuántas ventas se perdieron en julio\" → consultar_ventas_perdidas, tipo_consulta: \"mes_nombre\", parametro: \"julio\"\n- \"ventas perdidas de julio de 2025\" → consultar_ventas_perdidas, tipo_consulta: \"mes_nombre\", parametro: \"julio\"\n- \"análisis de conversión en enero\" → consultar_ventas_perdidas, tipo_consulta: \"mes_nombre\", parametro: \"enero\"\n\n**Consultar Horas (NUEVA FUNCIONALIDAD):**\n- \"cuántas horas he dedicado al proyecto Marketing\" → consultar_horas_proyecto, proyecto: \"Marketing\"\n- \"horas invertidas en el proyecto test N8N\" → consultar_horas_proyecto, proyecto: \"test N8N\"\n- \"tiempo dedicado al proyecto Desarrollo Web\" → consultar_horas_proyecto, proyecto: \"Desarrollo Web\"\n- \"cuántas horas llevo en la tarea documentación del proyecto Marketing\" → consultar_horas_tarea, proyecto: \"Marketing\", tarea: \"documentación\"\n- \"tiempo invertido en la tarea pruebas del proyecto test N8N\" → consultar_horas_tarea, proyecto: \"test N8N\", tarea: \"pruebas\"\n- \"horas dedicadas a la tarea desarrollo del proyecto Web\" → consultar_horas_tarea, proyecto: \"Web\", tarea: \"desarrollo\"\n\n**Modificar Contactos (NUEVA FUNCIONALIDAD):**\n- \"modifica el contacto Juan\" → modificar_contacto, contacto: \"Juan\", campo: null, nuevo_valor: null (pide qué campo)\n- \"cambia el teléfono de Laura\" → modificar_contacto, contacto: \"Laura\", campo: \"telefono\", nuevo_valor: null (pide nuevo número)\n- \"pon el email de Pedro como pedro@nuevo.com\" → modificar_contacto, contacto: \"Pedro\", campo: \"email\", nuevo_valor: \"pedro@nuevo.com\"\n- \"actualiza la dirección de Ana\" → modificar_contacto, contacto: \"Ana\", campo: \"direccion\", nuevo_valor: null (pide nueva dirección)\n- \"añade una nota a Carlos: Cliente VIP\" → modificar_contacto, contacto: \"Carlos\", campo: \"notas\", nuevo_valor: \"Cliente VIP\"\n- \"quita el teléfono de María\" → modificar_contacto, contacto: \"María\", campo: \"telefono\", nuevo_valor: \"\"\n- \"elimina la web de Juan\" → modificar_contacto, contacto: \"Juan\", campo: \"web\", nuevo_valor: \"\"\n\n**Actividad Temporal por Usuario (NUEVA FUNCIONALIDAD):**\n- \"qué ha hecho Marco hoy\" → consultar_actividad_usuario, usuario: \"Marco\", periodo: \"hoy\"\n- \"qué hice ayer\" → consultar_actividad_usuario, usuario: \"Usuario actual\", periodo: \"ayer\"\n- \"actividad de Juan esta semana\" → consultar_actividad_usuario, usuario: \"Juan\", periodo: \"esta_semana\"\n- \"qué trabajó Ana la semana pasada\" → consultar_actividad_usuario, usuario: \"Ana\", periodo: \"semana_pasada\"\n- \"trabajo de Pedro este mes\" → consultar_actividad_usuario, usuario: \"Pedro\", periodo: \"este_mes\"\n- \"qué hizo María el mes pasado\" → consultar_actividad_usuario, usuario: \"María\", periodo: \"mes_pasado\"\n- \"mi actividad de hoy\" → consultar_actividad_usuario, usuario: \"Usuario actual\", periodo: \"hoy\"\n- \"mi trabajo esta semana\" → consultar_actividad_usuario, usuario: \"Usuario actual\", periodo: \"esta_semana\"\n\n**Ausencias (NUEVA FUNCIONALIDAD):**\n- \"quién está de ausencias hoy\" → consultar_ausencias, periodo: \"hoy\"\n- \"quién está de vacaciones esta semana\" → consultar_ausencias, periodo: \"esta_semana\"\n- \"ausencias de este mes\" → consultar_ausencias, periodo: \"este_mes\"\n- \"quién no está esta semana\" → consultar_ausencias, periodo: \"esta_semana\"\n- \"permisos de hoy\" → consultar_ausencias, periodo: \"hoy\"\n- \"quién está libre esta semana\" → consultar_ausencias, periodo: \"esta_semana\"\n- \"ausencias del equipo hoy\" → consultar_ausencias, periodo: \"hoy\"\n- \"quién está off este mes\" → consultar_ausencias, periodo: \"este_mes\"\n- \"consulta las ausencias de abigail peterson\" → consultar_ausencias, usuario: \"abigail peterson\", periodo: \"general\"\n- \"ausencias de juan esta semana\" → consultar_ausencias, usuario: \"juan\", periodo: \"esta_semana\"\n- \"está laura de vacaciones\" → consultar_ausencias, usuario: \"laura\", periodo: \"general\"\n- \"permisos de maria este mes\" → consultar_ausencias, usuario: \"maria\", periodo: \"este_mes\"\n- \"quién está libre hoy\" → consultar_ausencias, periodo: \"hoy\"\n- \"ausencias del equipo esta semana\" → consultar_ausencias, periodo: \"esta_semana\"\n- \"está pedro fuera esta semana\" → consultar_ausencias, usuario: \"pedro\", periodo: \"esta_semana\"\n\n**Eventos de Usuario (NUEVA FUNCIONALIDAD):**\n- \"qué tiene Juan hoy\" → consultar_eventos_usuario, usuario: \"Juan\", periodo: \"hoy\"\n- \"qué eventos tiene María esta semana\" → consultar_eventos_usuario, usuario: \"María\", periodo: \"esta_semana\"\n- \"agenda de Pedro este mes\" → consultar_eventos_usuario, usuario: \"Pedro\", periodo: \"este_mes\"\n- \"qué tiene programado Ana hoy\" → consultar_eventos_usuario, usuario: \"Ana\", periodo: \"hoy\"\n- \"calendario de Carlos esta semana\" → consultar_eventos_usuario, usuario: \"Carlos\", periodo: \"esta_semana\"\n- \"reuniones de Laura hoy\" → consultar_eventos_usuario, usuario: \"Laura\", periodo: \"hoy\"\n- \"citas de Miguel este mes\" → consultar_eventos_usuario, usuario: \"Miguel\", periodo: \"este_mes\"\n- \"qué tiene José esta semana\" → consultar_eventos_usuario, usuario: \"José\", periodo: \"esta_semana\"\n\n**Visitantes Web (NUEVA FUNCIONALIDAD):**\n- \"cuántos visitantes hemos tenido\" → consultar_visitantes_web, periodo: \"mes_actual\"\n- \"visitantes de la web este mes\" → consultar_visitantes_web, periodo: \"mes_actual\"\n- \"tráfico web del mes pasado\" → consultar_visitantes_web, periodo: \"mes_pasado\"\n- \"visitantes web de hoy\" → consultar_visitantes_web, periodo: \"hoy\"\n- \"cuánta gente visitó la página ayer\" → consultar_visitantes_web, periodo: \"ayer\"\n- \"estadísticas de visitantes esta semana\" → consultar_visitantes_web, periodo: \"esta_semana\"\n- \"análisis de tráfico web\" → consultar_visitantes_web, periodo: \"mes_actual\"\n- \"usuarios de la web\" → consultar_visitantes_web, periodo: \"mes_actual\"\n- \"cuántas visitas hemos tenido\" → consultar_visitantes_web, periodo: \"mes_actual\"\n\n**Estado de proyecto (NUEVA FUNCIONALIDAD):**\n- \"dime el estado del proyecto casa\" → consultar_estado_proyecto, proyecto: \"casa\", incluir_registros: true, dias: 90\n- \"cómo va el proyecto 'Reforma local' con registros\" → consultar_estado_proyecto, proyecto: \"Reforma local\", incluir_registros: true, dias: 90\n- \"situación de las tareas del proyecto marketing este mes\" → consultar_estado_proyecto, proyecto: \"marketing\", incluir_registros: true, dias: 31\n- \"avance del proyecto web con timesheets de los últimos 30 días\" → consultar_estado_proyecto, proyecto: \"web\", incluir_registros: true, dias: 30\n\n\n**RECONOCIMIENTO DE NÚMEROS EN TEXTO:**\n- \"uno\" / \"una hora\" = 1\n- \"dos horas\" = 2\n- \"tres horas\" = 3\n- \"cuatro horas\" = 4\n- \"cinco horas\" = 5\n- \"media hora\" = 0.5\n- \"hora y media\" = 1.5\n\n**REGLAS CRÍTICAS:**\n- SIEMPRE responde con JSON válido\n- Para audio transcripto, EXTRAE DATOS aunque el texto no sea perfecto\n- Si detectas \"registrar\", \"parte de horas\" o similar en audio → acción \"registrar_horas\"\n- Si detectas \"modificar\", \"cambiar\", \"editar\", \"actualizar\" + \"contacto\" → acción \"modificar_contacto\"\n- Nunca devuelvas \"conversar\" si detectas solicitud de modificar contacto, aunque sea incompleta\n- APLICA SIEMPRE EL ESTILO DE JORGE: directo, técnico pero cercano, sin jerga innecesaria\n- Si el usuario no indica año, en el campo \"fecha\" usa el AÑO_ACTUAL. Nunca asumas 2024 u otro año salvo que el usuario lo diga explícitamente.\n- Si hay horas + materiales → acción \"registrar_parte_y_stock\"\n- Si solo hay horas → \"registrar_horas\"\n- Si solo hay materiales → \"fsm_inventario\" (con tipo_accion según verbo: consumir/reponer)\n- Proyecto por defecto: \"Servicio de campo\" si no se indica\n- Si no se especifica cliente → pedirlo y devolver la acción \"falta_cliente_fsm\"\n- CLIENTE (FSM): Si el mensaje no especifica cliente (p. ej. \"para ClienteCorp\", \"cliente Juan\", \"de ACME\", \"para el cliente X\"), debes PEDIRLO.\n  - Si falta cliente → responde con la acción \"falta_cliente_fsm\".\n  - Si el cliente figura explícito en el mensaje, extrae el nombre exacto en el campo \"cliente\".\n- Si se detecta intención FSM (horas y/o materiales):\n  - Si NO hay cliente → acción \"falta_cliente_fsm\".\n  - Si hay cliente Y hay proyecto y tarea → acción \"crear_proyecto_tarea_horas_fsm\".\n  - Si hay cliente y proyecto, pero la tarea es incipiente o se debe crear → acción \"crear_tarea_y_horas_fsm\".\n  - En todos los casos, incluye siempre \"cliente\" cuando esté disponible.\n- Por defecto en stock: \"tipo_accion_stock\" = \"consumir\", \"warehouse_hint\" = \"principal\"\n- Para \"crear_pedido_venta\": si no se especifica cliente pero hay `cliente_perfil` o `user_name`, usa **CLIENTE_SUGERIDO** como cliente. No devuelvas *_incompleto en ese caso.\n- Si una acción necesita identificar al empleado/usuario por defecto (p. ej. crear ausencias, crear gasto), usa ODOO_USER si está disponible.\n- MODIFICACIÓN DE PEDIDOS DE VENTA (CRÍTICO):\n  - Si el mensaje habla de \"modificar\", \"cambiar\", \"quitar\", \"añadir\" y menciona \"pedido\" o un número tipo \"S00055\":\n    - Si NO hay flujo de modificación activo (`esperando_confirmacion` vacío o distinto de \"modificar_pedido_detalle\"):\n      → usa siempre `\"accion\": \"modificar_pedido_venta\"` (con `numero_pedido` si lo detectas, o `null` si no).\n    - Si `esperando_confirmacion == \"modificar_pedido_venta\"`:\n      → interpreta que el usuario te está dando ahora el número de pedido y devuelve `\"accion\": \"modificar_pedido_venta\"` con `numero_pedido` rellenado.\n    - Si `esperando_confirmacion == \"modificar_pedido_detalle\"`:\n      → usa SIEMPRE `\"accion\": \"modificar_pedido_detalle\"`, aunque el texto parezca crear un pedido nuevo. El detalle de líneas lo resuelve n8n.\n  - Nunca devuelvas `\"crear_pedido_venta\"` si el usuario habla de MODIFICAR un pedido. Para modificación usa únicamente `\"modificar_pedido_venta\"` o `\"modificar_pedido_detalle\"` según el contexto.\nREGLA FINAL OBLIGATORIA PARA `modificar_pedido_detalle`:\n\n- Si `esperando_confirmacion == \"modificar_pedido_detalle\"`:\n  - `\"lineas\"` DEBE SER siempre EXACTAMENTE igual a `datos_pendientes.lineas`.\n  - Si en `datos_pendientes.lineas` existe `\"product_id\"` o `\"price_unit\"`, NO LOS CAMBIES:\n    - NO los conviertas a null.\n    - NO los elimines.\n    - NO los conviertas a 0.\n  - Copia los valores tal cual aparecen (aunque sean strings como \"1\" o \"9\").\n\n\n\nResponde ÚNICAMENTE con el JSON requerido:",
        "options": {
          "systemMessage": "=MENSAJE ACTUAL: {{ $json.mensaje_usuario }}\n\n🎯 DETECTAR AUTOMÁTICAMENTE:\n- Contiene \"hola ¿quién eres?\" o \"quien eres\" o \"que eres\" → mensaje_bienvenida\n- Contiene \"mi usuario de odoo es\" seguido de cualquier texto → registrar_usuario\n- Contiene \"limitar modulos\" o \"restringir modulos\" o \"limitar módulos\" o \"restringir módulos\" seguido de usuario y módulos → limitar_modulos\n- Contiene \"registrar\" + \"horas\" → registrar_horas\n- Contiene \"registrar\" + (\"ausencia\"|\"vacaciones\"|\"permiso\"|\"baja\") → registrar_ausencia\n- Contiene \"registrar\" + \"gasto\" o \"expense\" o números con € o euros → registrar_gasto\n- Contiene \"crear proyecto\" → crear_proyecto  \n- Contiene \"crear tarea\" → crear_tarea\n- Contiene \"precio\" o \"stock\" → consultar_producto\n- Contiene \"ventas\" + \"orden\" o \"S\" + números → consultar_ventas_por_orden\n- Contiene \"ventas\" → consultar_ventas\n- Contiene \"compras\" → consultar_compras\n- Contiene \"facturas\" → consultar_facturas\n- Contiene \"pagos pendientes\" o \"cobrar\" o \"deben\" → consultar_pagos_pendientes\n- Contiene \"top\" o \"mejores\" o \"ranking\" o \"más vendidos\" → consultar_top_rankings\n- Contiene \"comerciales\" o \"vendedores\" o \"facturado cada\" o \"rendimiento comercial\" o \"ranking comerciales\" → consultar_ranking_comerciales\n- Contiene \"ventas perdidas\" o \"conversión\" o \"perdido\" o \"no facturadas\" o \"ventas pendientes\" o \"pendientes\" → consultar_ventas_perdidas\n- Contiene \"cuántas horas\" o \"horas dedicadas\" o \"tiempo dedicado\" o \"tiempo invertido\" → consultar_horas_proyecto o consultar_horas_tarea\n- Contiene \"qué ha hecho\" o \"qué hice\" o \"hoy\" o \"ayer\" o \"esta semana\" o \"este mes\" → consultar_actividad_usuario\n- Contiene \"ausencias\" o \"ausente\" o \"vacaciones\" or \"permisos\" or \"libre\" or \"off\" or \"no está\" or \"fuera\" (con o sin nombre de persona) → consultar_ausencias\n- Contiene \"consulta\" + \"ausencias\" + nombre de persona → consultar_ausencias\n- Contiene \"está\" + nombre + (\"libre\"|\"fuera\"|\"vacaciones\"|\"ausente\") → consultar_ausencias\n- Contiene \"eventos\" o \"evento\" o \"reuniones\" o \"reunión\" o \"calendario\" o \"qué tiene\" o \"agenda\" o \"citas\" → consultar_eventos_usuario\n- Contiene \"visitantes\" o \"visitas\" o \"tráfico web\" o \"web\" o \"página\" o \"usuarios web\" → consultar_visitantes_web\n- Contiene \"contacto\" → consultar_contacto\n- Contiene \"crear pedido\" o \"pedido de venta\" o \"crear venta\" o \"nuevo pedido\" → crear_pedido_venta\n- Contiene \"crear cita\" o \"crear evento\" o \"cita en el calendario\" o \"evento calendario\" o \"reunión\" o \"meeting\" o \"agendar\" → crear_evento_calendario\n- Contiene \"tickets\" o \"ticket\" o \"servicio de asistencia\" o \"soporte\" o \"incidencias\" o \"helpdesk\" → consultar_tickets\n- Contiene \"añadir mensaje\" o \"agregar mensaje\" o \"comentar\" o \"responder\" + \"ticket\" → anadir_mensaje_ticket\n- Contiene \"fabricaciones\" o \"fabricación\" o \"manufacturing\" o \"producción\" o \"estado fabricación\" o \"órdenes de fabricación\" → consultar_fabricaciones\n- Contiene \"crear pedido de compra\" o \"pedido de compra\" o \"crear compra\" o \"nueva compra\" o \"orden de compra\" → crear_pedido_compra\n- INVENTARIO FSM: Contiene verbos de consumo (\"consumir\", \"he gastado\", \"gasta\", \"resta\", \"descuenta\") + cantidad + producto → fsm_inventario (tipo_accion=\"consumir\")\n- INVENTARIO FSM: Contiene verbos de reposición (\"reponer\", \"repón\", \"añade\", \"suma\", \"he comprado\") + cantidad + producto → fsm_inventario (tipo_accion=\"reponer\")\n- Contiene (\"registrar\" o \"parte\" o \"horas\") + (\"material\"|\"materiales\"|\"producto\"|\"productos\"|\"stock\"|\"he usado\"|\"he consumido\"|\"utilicé\") → registrar_parte_y_stock\n- Contiene cantidades + productos (p.ej., \"10 tornillos\", \"3 metros de cable\") Y también horas → registrar_parte_y_stock\n- Contiene \"parte\" y (\"material\" | \"materiales\" | \"consumo\" | \"he gastado\" | \"usado\" | \"saco\" | \"tornillos\" | \"piezas\") → registrar_parte_y_stock\n- Contiene \"servicio de campo\" o \"fsm\" → registrar_parte_y_stock\n🧩 Si esperando_confirmacion == \"corregir_pedido_venta\":\n- Combina productos de la memoria (originales válidos + preconfirmados) con los corregidos del mensaje actual.\n- Quita duplicados normalizando nombre (minúsculas, sin tildes, un espacio).\n- Para nombres iguales, suma cantidades o prioriza la del mensaje si es la corrección del ambiguo.\n- Devuelve la acción \"crear_pedido_venta\" con el array \"productos\" resultante y el \"cliente\".\n- Contiene (\"estado\" OR \"situación\" OR \"progreso\" OR \"avance\" OR \"fases\" OR \"etapas\" OR \"tareas\")\n  + \"proyecto\" → consultar_estado_proyecto\n- Contiene \"cómo va\" + \"proyecto\" → consultar_estado_proyecto\n- Contiene \"resumen del proyecto\" OR \"detalles del proyecto\" OR \"dashboard del proyecto\" → consultar_estado_proyecto\n- Contiene \"proyectos\" + (\"en proceso\"|\"en progreso\"|\"en curso\"|\"hechos\"|\"finalizados\"|\"cerrados\"|\"nuevos\") → consultar_proyectos_por_etapa\n\n\n\n\nUSAR datos reales del mensaje, NUNCA valores fijos.\nResponder SOLO con JSON válido.",
          "maxIterations": 1,
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -4608,
        3344
      ],
      "id": "1d5609a7-329b-4b0a-b5d8-8e94baa9b081",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Crear Tarea').item.json.datos_tarea.chat_id }}",
        "text": "=✅ **¡Tarea creada exitosamente!**\n\n📝 **Tarea:** {{ $('Preparar Crear Tarea').item.json.datos_tarea.nombre_tarea }}\n🏗️ **Proyecto:** {{ $('Preparar Crear Tarea').item.json.datos_tarea.nombre_proyecto }}\n🆔 **ID:** {{ $json.result }}\n\nYa puedes registrar horas en esta tarea. ¿Necesitas ayuda con algo más? 😊",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -544,
        1168
      ],
      "id": "3724fd20-d701-4ec3-88d9-fff386b35287",
      "name": "Confirmar Tarea Creada",
      "webhookId": "8a6fbafc-57d3-4340-a8f0-a64d64e9ca56"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        1168
      ],
      "id": "b0e40207-0f34-4e0c-94de-95aff00bf938",
      "name": "Crear Tarea HTTP"
    },
    {
      "parameters": {
        "jsCode": "// Crear tarea en el proyecto encontrado\nconst datosOriginales = $('Buscar Proyecto para Tarea').item.json;\nconst proyectoData = $json.result[0];\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconst crearTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"create\",\n      [{\n        name: datosOriginales.tarea,\n        project_id: proyectoData.id,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearTarea,\n  datos_tarea: {\n    nombre_tarea: datosOriginales.tarea,\n    nombre_proyecto: proyectoData.name,\n    proyecto_id: proyectoData.id,\n    chat_id: datosOriginales.chat_id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -912,
        1168
      ],
      "id": "0b7fa872-dd14-46e6-9080-36524b95c247",
      "name": "Preparar Crear Tarea"
    },
    {
      "parameters": {
        "chatId": "={{ $('Buscar Proyecto para Tarea').item.json.chat_id }}",
        "text": "=❌ El proyecto \"{{ $('Buscar Proyecto para Tarea').item.json.proyecto }}\" no existe.\n\nDebes crear el proyecto primero antes de añadir tareas. ¿Quieres que lo cree? Responde:\n- **'sí'** para crear el proyecto\n- **'no'** para cancelar",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -912,
        1392
      ],
      "id": "8de518c8-3c0d-4d6a-8fba-d37df9e2bb5f",
      "name": "Proyecto No Existe para Tarea",
      "webhookId": "d09c3a3d-dbfe-4fec-87a9-66e64819d377"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.result && $json.result.length > 0 }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1120,
        1248
      ],
      "id": "4c9603cd-9290-481b-b9b3-186180acfdfa",
      "name": "¿Proyecto Existe para Tarea?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1280,
        1248
      ],
      "id": "edf188ff-de27-4e28-a12e-23d69b613c02",
      "name": "Consultar Proyecto para Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Crear nueva tarea en proyecto existente - BÚSQUEDA CASE-INSENSITIVE\n// Obtener uid de la fuente correcta\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreTarea = $json.tarea;\nconst nombreProyecto = $json.proyecto;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\n// Buscar el proyecto con ilike (case-insensitive)\nconst buscarProyecto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"project.project\",\n      \"search_read\",\n      [\n        [[\"name\", \"ilike\", nombreProyecto]],\n        [\"id\", \"name\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: buscarProyecto,\n  ...$json,\n  uid: uid // Asegurar que uid se pasa al siguiente nodo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        1248
      ],
      "id": "00c2638c-2e81-4df6-ab02-316073844590",
      "name": "Buscar Proyecto para Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Los estados se actualizarán automáticamente en PostgreSQL en la siguiente interacción\nconst datosRegistro = $('Preparar Registro Automático Completo').item.json.datos_registro_automatico;\nconsole.log('🧹 PostgreSQL manejará la actualización de estado automáticamente');\nconsole.log('✅ Proceso automático completado para:', datosRegistro.chat_id);\n\nreturn $json;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        800
      ],
      "id": "37414b85-9183-4632-b620-f39514324b21",
      "name": "Limpiar Memoria Completa"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Registro Automático Completo').item.json.datos_registro_automatico.chat_id }}",
        "text": "=🎉 **¡TODO COMPLETADO AUTOMÁTICAMENTE!**\n\n✅ **Proyecto creado:** {{ $('Preparar Registro Automático Completo').item.json.datos_registro_automatico.proyecto_nombre }}\n✅ **Tarea creada:** {{ $('Preparar Registro Automático Completo').item.json.datos_registro_automatico.tarea_nombre }}\n✅ **Horas registradas:** {{ $('Preparar Registro Automático Completo').item.json.datos_registro_automatico.horas }}\n📅 **Fecha:** {{ $('Preparar Registro Automático Completo').item.json.datos_registro_automatico.fecha }}\n💬 **Descripción:** {{ $('Preparar Registro Automático Completo').item.json.datos_registro_automatico.descripcion }}\n\n¡Increíble! He creado el proyecto, la tarea y registrado tus horas automáticamente. ¡Todo listo! 🚀",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        352,
        896
      ],
      "id": "2e64eeda-409e-449f-a9d3-47cf11482d2e",
      "name": "Confirmar Todo Automático",
      "webhookId": "67757f99-6f2e-4c39-bdd8-8b287b4269ac",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        160,
        896
      ],
      "id": "fed282b7-c455-4b58-a426-f009b35b0e6a",
      "name": "Registrar Horas Automático Completo"
    },
    {
      "parameters": {
        "jsCode": "// Preparar registro automático de horas tras crear proyecto y tarea\nconst datosTarea = $('Preparar Crear Tarea Automática').item.json.datos_tarea_automatica;\nconst tareaCreada = $json.result; // ID de la tarea recién creada\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\nconst crearHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosTarea.uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosTarea.descripcion,\n        unit_amount: parseFloat(datosTarea.horas),\n        project_id: parseInt(datosTarea.proyecto_id),\n        task_id: parseInt(tareaCreada),\n        date: fechaHoy\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearHoras,\n  datos_registro_automatico: {\n    proyecto_nombre: datosTarea.nombre_proyecto,\n    tarea_nombre: datosTarea.nombre_tarea,\n    horas: datosTarea.horas,\n    descripcion: datosTarea.descripcion,\n    fecha: fechaHoy,\n    chat_id: datosTarea.chat_id,\n    tarea_id: tareaCreada\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -112,
        896
      ],
      "id": "ef276f4e-e290-4e4c-9ad4-bf8e4e482a18",
      "name": "Preparar Registro Automático Completo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -304,
        880
      ],
      "id": "df6e3f10-7463-4cc6-ba7e-ee34ace2f268",
      "name": "Crear Tarea Automática HTTP"
    },
    {
      "parameters": {
        "jsCode": "// Crear tarea automáticamente después de crear proyecto\nconst datosProyecto = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconst crearTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"create\",\n      [{\n        name: datosProyecto.tarea,\n        project_id: parseInt(datosProyecto.proyecto_id),\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearTarea,\n  datos_tarea_automatica: {\n    nombre_tarea: datosProyecto.tarea,\n    nombre_proyecto: datosProyecto.proyecto_nombre,\n    proyecto_id: datosProyecto.proyecto_id,\n    horas: datosProyecto.horas,\n    descripcion: datosProyecto.descripcion,\n    chat_id: datosProyecto.chat_id,\n    uid: uid\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -512,
        880
      ],
      "id": "c2ab8401-56a5-47c7-9cba-f0595724d208",
      "name": "Preparar Crear Tarea Automática"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.mensaje_confirmacion }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -672,
        880
      ],
      "id": "021b44ee-53cc-49b9-ae27-1f9cb2f1d424",
      "name": "Confirmar Proyecto Creado",
      "webhookId": "1e1ee59b-a10f-4487-8b5e-79cf7902529d"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.accion === 'continuar_con_tarea' }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -880,
        880
      ],
      "id": "7f586c9f-6d4e-4302-8205-72212f837b3b",
      "name": "¿Continuar con Tarea?"
    },
    {
      "parameters": {
        "jsCode": "// Verificar PostgreSQL para continuación de flujo tras crear proyecto\nconst proyectoCreado = $json.result;\nconst datosProyecto = $('Preparar Crear Proyecto').item.json;\nconst chatId = datosProyecto.chat_id;\n\n// Función para acceso seguro sin memoria compleja\nfunction obtenerDatosSeguro(nombreNodo) {\n  try {\n    return $(nombreNodo).item.json;\n  } catch (e) {\n    console.log(`⚠️ Nodo \"${nombreNodo}\" no disponible:`, e.message);\n    return null;\n  }\n}\n\n// Obtener memoria desde PostgreSQL o usar memoria global simplificada\nconst memoriaGlobal = global[`memoria_${chatId}`] || {};\n\n// Verificar si hay datos pendientes en PostgreSQL o memoria global\nif (memoriaGlobal && memoriaGlobal.datos_pendientes && memoriaGlobal.datos_pendientes.accion_original === 'registrar_horas') {\n  const datosPendientes = memoriaGlobal.datos_pendientes;\n  \n  console.log('📋 Proyecto creado, continuando con tarea y horas desde PostgreSQL:', datosPendientes);\n  \n  return {\n    accion: 'continuar_con_tarea',\n    proyecto_id: proyectoCreado,\n    proyecto_nombre: datosProyecto.proyecto,\n    tarea: datosPendientes.tarea,\n    horas: datosPendientes.horas,\n    descripcion: datosPendientes.descripcion,\n    uid: datosProyecto.uid,\n    chat_id: chatId,\n    mensaje_confirmacion: `✅ **¡Proyecto creado exitosamente!**\\n\\n🏗️ **Proyecto:** ${datosProyecto.proyecto}\\n🆔 **ID:** ${proyectoCreado}\\n\\n🔄 Ahora voy a crear la tarea \"${datosPendientes.tarea}\" y registrar ${datosPendientes.horas} horas...`\n  };\n} else {\n  console.log('✅ Proyecto creado sin acciones pendientes en PostgreSQL');\n  return {\n    accion: 'solo_confirmar',\n    chat_id: chatId,\n    mensaje_confirmacion: `✅ **¡Proyecto creado exitosamente!**\\n\\n🏗️ **Proyecto:** ${datosProyecto.proyecto}\\n🆔 **ID:** ${proyectoCreado}\\n\\nYa puedes crear tareas en este proyecto y registrar tus horas. ¿Necesitas ayuda con algo más? 😊`\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1056,
        880
      ],
      "id": "283b8130-2193-4251-b8b5-ec801047ae54",
      "name": "Analizar Proyecto Creado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1264,
        880
      ],
      "id": "c00fcde1-8631-4e10-b02f-ec7cf7a631a0",
      "name": "Crear Proyecto HTTP"
    },
    {
      "parameters": {
        "jsCode": "// Crear nuevo proyecto en Odoo\n// Obtener uid de la fuente correcta\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreProyecto = $json.proyecto;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nconst crearProyecto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"project.project\",\n      \"create\",\n      [{\n        name: nombreProyecto,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearProyecto,\n  ...$json,\n  uid: uid // Asegurar que uid se pasa al siguiente nodo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1456,
        880
      ],
      "id": "671ecd03-fab7-42d8-ae82-71f5f7136036",
      "name": "Preparar Crear Proyecto"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.result && $json.result.length > 0 }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -240,
        144
      ],
      "id": "db940d00-fb40-41cd-ab66-ff542d6bbb2e",
      "name": "¿Tarea Existe?"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.result && $json.result.length > 0 }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1056,
        272
      ],
      "id": "229b6687-13ef-4d7a-bc1e-ecd23806d8e8",
      "name": "¿Proyecto Existe?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -880,
        2288
      ],
      "id": "5f505eb0-c595-4e94-81d8-9d2f7c2a0aa7",
      "name": "Enviar Respuesta Contacto",
      "webhookId": "9bb15153-75f4-42bd-9c53-8482b364c460"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de contactos para Telegram\nconst contactos = $json.result;\nconst datosConsulta = $('Preparar Consulta Contacto').item.json;\nlet texto = '';\n\nif (!Array.isArray(contactos) || contactos.length === 0) {\n  texto = '❌ No se encontró ningún contacto con ese nombre.';\n} else {\n  texto = `👤 *Contactos encontrados:*\\n`;\n  contactos.forEach((c, idx) => {\n    texto += `\\n${idx+1}. Nombre: ${c.name}\\n   📧 Email: ${c.email || 'No disponible'}\\n   📱 Teléfono: ${c.phone || 'No disponible'}\\n`;\n  });\n}\n\nreturn{\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        2288
      ],
      "id": "b0f00d60-5b77-4a23-aea9-59c205468358",
      "name": "Formatear Respuesta Contacto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1280,
        2288
      ],
      "id": "40f2c92e-a44d-4756-b640-344dd4c83379",
      "name": "HTTP Consulta Contacto"
    },
    {
      "parameters": {
        "jsCode": "// Procesar consulta de contacto desde AI Agent\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreContacto = datosAI.contacto;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\n// Validar que tenemos nombre del contacto\nif (!nombreContacto) {\n  throw new Error('No se encontró el nombre del contacto');\n}\n\n// BÚSQUEDA CASE-INSENSITIVE usando ilike\nconst palabras = nombreContacto.split(' ');\nconst condiciones = palabras.map(p => [\"name\", \"ilike\", p]);\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\", // DB\n      uid, \n      \"admin\", \n      \"res.partner\", \n      \"search_read\",\n      [\n        [[\"name\", \"ilike\", nombreContacto], ...condiciones],\n        [\"id\", \"name\", \"email\", \"phone\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  contacto: nombreContacto,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        2288
      ],
      "id": "48202ecd-3f91-408f-bbb9-5d07c0dc038f",
      "name": "Preparar Consulta Contacto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        864,
        1968
      ],
      "id": "e67e7002-5444-422a-a3bf-da1956877278",
      "name": "Enviar Respuesta Ventas",
      "webhookId": "0a08079b-ffc4-4a87-a55b-7a159cedb518"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de ventas para Telegram CON INFORMACIÓN COMPLETA DE FACTURAS\nconst datosPreparar = $json.datos_preparar || {};\n\n// Si no requiere información de facturas, usar formateo simple\nif (!datosPreparar.requiere_info_facturas) {\n  const ventas = datosPreparar.result || $json.result || $('HTTP Consulta Ventas').item.json.result;\n  const datosConsulta = datosPreparar.datos_consulta || $json.datos_consulta || $('Preparar Consulta Ventas').item.json;\n  let texto = '';\n  \n  console.log('📋 FORMATEO SIN INFO FACTURAS:');\n  console.log('   - Ventas encontradas:', ventas?.length || 0);\n  console.log('   - Tipo consulta:', datosConsulta?.tipo_consulta);\n  console.log('   - Parámetro:', datosConsulta?.parametro);\n  \n  if (datosConsulta.tipo_consulta === 'producto_especifico' || datosConsulta.tipo_consulta === 'producto_especifico_con_fechas') {\n    const nombreProducto = datosConsulta.parametro || 'el producto';\n    \n    if (!Array.isArray(ventas) || ventas.length === 0) {\n      // Mensaje específico con el nombre del producto y período si aplica\n      if (datosConsulta.tipo_consulta === 'producto_especifico_con_fechas') {\n        const fechaDesdeFormateada = new Date(datosConsulta.fecha_desde).toLocaleDateString('es-ES');\n        const fechaHastaFormateada = new Date(datosConsulta.fecha_hasta).toLocaleDateString('es-ES');\n        texto = `❌ **No se encontraron ventas de \"${nombreProducto}\"**\\n\\n📅 **Período consultado:** ${fechaDesdeFormateada} - ${fechaHastaFormateada}\\n\\n💡 *Verifica que el nombre del producto sea correcto o prueba con palabras clave más generales.*`;\n      } else {\n        texto = `❌ **No se encontraron ventas de \"${nombreProducto}\"**\\n\\n💡 *Verifica que el nombre del producto sea correcto o prueba con palabras clave más generales.*`;\n      }\n    } else {\n      const totalVentas = ventas.reduce((acc, v) => acc + (v.product_uom_qty || 0), 0);\n      texto = `🔢 Se han vendido *${totalVentas} unidades* de \"${nombreProducto}\".\\n\\n`;\n      ventas.forEach((v, idx) => {\n        texto += `${idx+1}. Cantidad: ${v.product_uom_qty}\\n   Total línea: ${v.price_total} €\\n`;\n      });\n    }\n  } else {\n    // Formateo para otros tipos de consulta\n    if (!Array.isArray(ventas) || ventas.length === 0) {\n      if (datosConsulta.tipo_consulta === 'cliente_especifico') {\n        texto = `❌ No se encontraron ventas del cliente \"${datosConsulta.parametro}\".`;\n      } else {\n        texto = '❌ No se encontró ninguna venta en ese período.';\n      }\n    } else {\n      const total = ventas.reduce((acc, v) => acc + (v.amount_total || 0), 0);\n      \n      // Verificar si hay datos de comparación disponibles\n      const comparacion = $json.comparacion;\n      \n      // Limitar a máximo 15 órdenes para evitar mensaje muy largo\n      const ventasLimitadas = ventas.slice(0, 15);\n      const hayMasVentas = ventas.length > 15;\n      \n      // Personalizar título según tipo de consulta\n      if (datosConsulta.tipo_consulta === 'cliente_especifico') {\n        texto = `👤 **Ventas del cliente \"${datosConsulta.parametro}\":**\\n\\n💰 Total: ${total.toFixed(2)} € | 📄 ${ventas.length} órdenes\\n\\n`;\n      } else if (datosConsulta.tipo_consulta === 'mes_actual' && comparacion) {\n        // Agregar información de comparación con mes anterior\n        const porcentajeCambio = comparacion.porcentaje_cambio;\n        const porcentajeTotal = comparacion.porcentaje_total;\n        const diferencia = comparacion.diferencia;\n        const totalAnterior = comparacion.total_mes_anterior;\n        \n        let iconoTendencia = '📊';\n        let textoComparacion = '';\n        \n        if (comparacion.tendencia === 'crecimiento') {\n          iconoTendencia = '📈';\n          textoComparacion = `+${porcentajeCambio.toFixed(1)}% vs mes anterior`;\n        } else if (comparacion.tendencia === 'decrecimiento') {\n          iconoTendencia = '📉';\n          textoComparacion = `${porcentajeCambio.toFixed(1)}% vs mes anterior`;\n        } else if (comparacion.tendencia === 'nuevo') {\n          iconoTendencia = '🆕';\n          textoComparacion = 'Nuevas ventas (mes anterior: €0)';\n        } else {\n          iconoTendencia = '➡️';\n          textoComparacion = 'Sin cambios vs mes anterior';\n        }\n        \n        texto = `📊 **Ventas del Mes Actual:**\\n\\n💰 Total: ${total.toFixed(2)} € | 📄 ${ventas.length} órdenes\\n\\n`;\n        texto += `${iconoTendencia} **${textoComparacion}**\\n`;\n        const signoEuro = diferencia >= 0 ? '+' : '';\n        texto += `📅 Mes anterior: ${totalAnterior.toFixed(2)} € | 💶 Diferencia: ${signoEuro}${diferencia.toFixed(2)} €\\n\\n`;\n      } else {\n        texto = `💰 Total: ${total.toFixed(2)} € | 📄 ${ventas.length} órdenes\\n\\n`;\n      }\n      ventasLimitadas.forEach((v, idx) => {\n        const fechaCorta = v.date_order ? new Date(v.date_order).toLocaleDateString('es-ES') : 'N/A';\n        const precioFormateado = (v.amount_total || 0).toFixed(2);\n        \n        // Información básica de la orden\n        texto += `${idx+1}. ${v.name}\\n   👤 ${v.partner_id?.[1] || 'N/A'} | 💰 ${precioFormateado} € | 📅 ${fechaCorta}\\n`;\n        \n        // Mostrar TODOS los productos (ya limitamos a 15 órdenes)\n        if (v.productos && Array.isArray(v.productos) && v.productos.length > 0) {\n          // Mostrar hasta 4 productos por orden para mantener legibilidad\n          const productosAMostrar = v.productos.slice(0, 4);\n          \n          productosAMostrar.forEach(prod => {\n            const cantidad = prod.cantidad > 0 ? `${prod.cantidad}x ` : '';\n            // Truncar nombre de producto si es muy largo\n            const nombreProducto = prod.producto.length > 30 ? \n              prod.producto.substring(0, 30) + '...' : prod.producto;\n            texto += `   🛍️ ${cantidad}${nombreProducto}\\n`;\n          });\n          \n          // Si hay más de 4 productos, mostrar nota compacta\n          if (v.productos.length > 4) {\n            const productosRestantes = v.productos.length - 4;\n            texto += `   📦 +${productosRestantes} producto${productosRestantes > 1 ? 's' : ''} más\\n`;\n          }\n        }\n        \n        texto += `\\n`;\n      });\n      \n      // Agregar nota si hay más órdenes\n      if (hayMasVentas) {\n        const ordenesRestantes = ventas.length - 15;\n        texto += `📊 _Mostrando las primeras 15 órdenes de ${ventas.length} totales_\\n`;\n        texto += `_Pregunta por un período más específico para ver menos resultados_`;\n      }\n    }\n  }\n  \n  return {\n    texto,\n    chat_id: datosConsulta.chat_id,\n    ventas: ventas,\n    datos_consulta: datosConsulta\n  };\n}\n\n// FORMATEO AVANZADO CON INFORMACIÓN COMPLETA DE FACTURAS\nconst ventasLineas = datosPreparar.ventas_lineas;\nconst facturas = $json.result || [];\nconst datosConsulta = datosPreparar.datos_consulta;\n\n// DEBUG CRÍTICO DEL FORMATEO FINAL\nconsole.log('📋 FORMATEAR RESPUESTA VENTAS - ANÁLISIS FINAL:');\nconsole.log('💾 Estructura completa $json:', JSON.stringify($json, null, 2));\nconsole.log('📊 Número de facturas obtenidas:', facturas?.length || 0);\nconsole.log('📝 Array de facturas:', facturas);\nif (facturas && facturas.length > 0) {\n  console.log('🔍 ANÁLISIS DETALLADO DE CADA FACTURA:');\n  facturas.forEach((factura, idx) => {\n    console.log(`   Factura ${idx + 1}:`);\n    console.log(`     - ID: ${factura.id}`);\n    console.log(`     - Nombre: ${factura.name}`);\n    console.log(`     - partner_id: ${JSON.stringify(factura.partner_id)}`);\n    console.log(`     - date_order: ${factura.date_order}`);\n    console.log(`     - state: ${factura.state}`);\n    console.log(`     - amount_total: ${factura.amount_total}`);\n    console.log(`     - Estructura completa:`, JSON.stringify(factura, null, 2));\n  });\n} else {\n  console.log('❌ NO HAY FACTURAS - Verificar respuesta HTTP');\n  console.log('   - $json.result:', $json.result);\n  console.log('   - $json.error:', $json.error);\n  console.log('   - Tipo de $json.result:', typeof $json.result);\n}\n\nif (!Array.isArray(ventasLineas) || ventasLineas.length === 0) {\n  const nombreProducto = datosConsulta?.parametro || 'el producto';\n  return {\n    texto: `❌ **No se encontraron ventas de \"${nombreProducto}\"**\\n\\n💡 *Verifica que el nombre del producto sea correcto o prueba con palabras clave más generales.*`,\n    chat_id: datosConsulta.chat_id,\n    ventas_lineas: ventasLineas,\n    facturas: facturas,\n    datos_consulta: datosConsulta\n  };\n}\n\n// Crear un mapa de facturas para acceso rápido\nconst facturasPorId = {};\nfacturas.forEach(factura => {\n  facturasPorId[factura.id] = factura;\n});\n\n// ANÁLISIS DETALLADO POR FACTURAS\nconst totalUnidades = ventasLineas.reduce((acc, v) => acc + (v.product_uom_qty || 0), 0);\nconst totalImporte = ventasLineas.reduce((acc, v) => acc + (v.price_total || 0), 0);\n\n// Agrupar por orden de venta (factura)\nconst ventasPorOrden = {};\nventasLineas.forEach(venta => {\n  const orderId = venta.order_id?.[0] || 'Sin ID';\n  const facturaInfo = facturasPorId[orderId];\n  \n  if (!ventasPorOrden[orderId]) {\n    ventasPorOrden[orderId] = {\n      id: orderId,\n      nombre: facturaInfo?.name || venta.order_id?.[1] || 'Orden desconocida',\n      cliente: facturaInfo?.partner_id?.[1] || 'Cliente no disponible',\n      fecha: facturaInfo?.date_order || 'Fecha no disponible',\n      estado: facturaInfo?.state || 'Estado no disponible',\n      totalFactura: facturaInfo?.amount_total || 0,\n      lineas: [],\n      totalUnidades: 0,\n      totalImporteProducto: 0\n    };\n  }\n  \n  ventasPorOrden[orderId].lineas.push(venta);\n  ventasPorOrden[orderId].totalUnidades += (venta.product_uom_qty || 0);\n  ventasPorOrden[orderId].totalImporteProducto += (venta.price_total || 0);\n});\n\nconst numeroFacturas = Object.keys(ventasPorOrden).length;\nconst nombreProducto = ventasLineas[0]?.product_id?.[1] || 'Producto no identificado';\n\n// GENERAR TEXTO FINAL - FORMATO COMPACTO\nlet texto = `📊 **VENTAS**\\n\\n`;\ntexto += `🛍️ ${nombreProducto}\\n`;\n\n// Añadir información del período si es una consulta con fechas\nif (datosConsulta.tipo_consulta === 'producto_especifico_con_fechas') {\n  const fechaDesdeFormateada = new Date(datosConsulta.fecha_desde).toLocaleDateString('es-ES');\n  const fechaHastaFormateada = new Date(datosConsulta.fecha_hasta).toLocaleDateString('es-ES');\n  texto += `📅 ${fechaDesdeFormateada} - ${fechaHastaFormateada}\\n`;\n}\n\ntexto += `🔢 ${totalUnidades} uds | 💰 ${totalImporte.toFixed(2)} € | 📄 ${numeroFacturas} facturas\\n\\n`;\n\n// DETALLE POR FACTURA - TODAS LAS FACTURAS\nlet contadorFactura = 1;\nObject.values(ventasPorOrden).forEach(orden => {\n  // Formatear fecha\n  const fechaFormateada = orden.fecha !== 'Fecha no disponible' ? \n    new Date(orden.fecha).toLocaleDateString('es-ES') : orden.fecha;\n  \n  // Estados en español\n  const estadoMap = {\n    'draft': 'Borrador',\n    'sent': 'Enviado',\n    'sale': 'Confirmado',\n    'done': 'Completado',\n    'cancel': 'Cancelado'\n  };\n  const estadoEspanol = estadoMap[orden.estado] || orden.estado;\n  \n  texto += `**${contadorFactura}. ${orden.nombre}**\\n`;\n  texto += `   👤 ${orden.cliente}\\n`;\n  texto += `   📅 ${fechaFormateada}\\n`;\n  texto += `   📦 ${orden.totalUnidades} uds | 💰 ${orden.totalImporteProducto.toFixed(2)} €\\n`;\n  \n  // Si hay múltiples líneas del mismo producto en la misma factura\n  if (orden.lineas.length > 1) {\n    texto += `   📝 Líneas del producto (${orden.lineas.length}):\\n`;\n    orden.lineas.forEach((linea, idx) => {\n      texto += `      ${idx + 1}. Cant: ${linea.product_uom_qty} | Precio unit: ${linea.price_unit?.toFixed(2) || 'N/A'} €\\n`;\n    });\n  } else {\n    const linea = orden.lineas[0];\n    texto += `   💶 Precio unitario: ${linea.price_unit?.toFixed(2) || 'N/A'} €\\n`;\n  }\n  \n  texto += `\\n`;\n  contadorFactura++;\n});\n\n// Ya no necesitamos mostrar nota porque mostramos todas las facturas\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        624,
        1968
      ],
      "id": "1cb67f2d-2eda-4694-b7f3-00b1788330d9",
      "name": "Formatear Respuesta Ventas"
    },
    {
      "parameters": {
        "jsCode": "// Generar estadísticas para gráfico donut de productos por cantidad vendida\n// Obtener datos de los nodos específicos (con líneas de productos combinadas)\nconst ventas = $('Combinar Ventas con Líneas').item.json.result;\nconst datosConsulta = $('Preparar Consulta Ventas').item.json;\nconst datosFormateados = $('Formatear Respuesta Ventas').item.json;\n\nconsole.log('📊 GENERAR ESTADÍSTICAS PRODUCTOS POR CANTIDAD - DEBUG COMPLETO:');\nconsole.log('   - Ventas encontradas:', ventas?.length || 0);\nconsole.log('   - Tipo consulta:', datosConsulta?.tipo_consulta);\n\n// Solo generar gráfico para consultas de período (no para productos específicos)\nconst tiposParaGrafico = ['mes_actual', 'mes_pasado', 'mes_nombre', 'cliente_especifico'];\nconst debeGenerarGrafico = true // Siempre generar gráfico si hay ventas;\n\nif (!Array.isArray(ventas) || ventas.length === 0) {\n  console.log('   ❌ No hay ventas para generar gráfico');\n  return {\n    chat_id: datosFormateados.chat_id,\n    generar_grafico: false,\n    motivo_no_grafico: 'No hay ventas'\n  };\n}\n\n// Agrupar ventas por productos (cantidad vendida)\nconst productosPorCantidad = {};\nlet totalUnidadesVendidas = 0;\n\nventas.forEach(venta => {\n  console.log('🔍 DEBUG VENTA:', JSON.stringify(venta, null, 2));\n  \n  // Usar la misma estructura que Formatear Respuesta Ventas\n  const productosVenta = venta.productos || [];\n  console.log('📦 Productos encontrados:', productosVenta.length);\n  \n  if (productosVenta.length === 0) {\n    console.log('⚠️ No se encontró productos, campos disponibles:', Object.keys(venta));\n    // Fallback: intentar con order_line si productos no existe\n    const lineasProductos = venta.order_line || [];\n    console.log('🔄 Fallback order_line:', lineasProductos.length);\n    \n    lineasProductos.forEach(linea => {\n      const nombreProducto = linea.product_id && linea.product_id[1] ? linea.product_id[1] : 'Producto sin nombre';\n      const cantidadVendida = parseFloat(linea.product_uom_qty || 0);\n      \n      if (!productosPorCantidad[nombreProducto]) {\n        productosPorCantidad[nombreProducto] = {\n          nombre: nombreProducto,\n          cantidad_total: 0,\n          ordenes: []\n        };\n      }\n      \n      productosPorCantidad[nombreProducto].cantidad_total += cantidadVendida;\n      productosPorCantidad[nombreProducto].ordenes.push(venta.name);\n      totalUnidadesVendidas += cantidadVendida;\n    });\n  } else {\n    // Usar estructura productos (igual que Formatear Respuesta Ventas)\n    productosVenta.forEach(prod => {\n      console.log('📄 DEBUG PRODUCTO:', JSON.stringify(prod, null, 2));\n      const nombreProducto = prod.producto || 'Producto sin nombre';\n      const cantidadVendida = parseFloat(prod.cantidad || 0);\n      \n      console.log(`🛍️ Producto: ${nombreProducto}, Cantidad: ${cantidadVendida}`);\n      \n      if (!productosPorCantidad[nombreProducto]) {\n        productosPorCantidad[nombreProducto] = {\n          nombre: nombreProducto,\n          cantidad_total: 0,\n          ordenes: []\n        };\n      }\n      \n      productosPorCantidad[nombreProducto].cantidad_total += cantidadVendida;\n      productosPorCantidad[nombreProducto].ordenes.push(venta.name);\n      totalUnidadesVendidas += cantidadVendida;\n    });\n  }\n});\n\n// Convertir a arrays y calcular porcentajes por cantidad de productos\nconst productos = Object.values(productosPorCantidad);\n// Ordenar productos por cantidad vendida (mayor a menor)\nproductos.sort((a, b) => b.cantidad_total - a.cantidad_total);\n\nconst labels = productos.map(p => p.nombre);\nconst valores = productos.map(p => p.cantidad_total); // CANTIDAD, no precio\nconst porcentajes = valores.map(v => totalUnidadesVendidas > 0 ? ((v / totalUnidadesVendidas) * 100).toFixed(1) : 0);\n\n// Preparar colores dinámicos\nconst colores = [\n  '#28a745', // Verde\n  '#007bff', // Azul\n  '#ffc107', // Amarillo\n  '#dc3545', // Rojo\n  '#6f42c1', // Morado\n  '#fd7e14', // Naranja\n  '#20c997', // Teal\n  '#e83e8c', // Rosa\n  '#17a2b8', // Cyan\n  '#6c757d'  // Gris\n];\n\nconst estadisticas = {\n  productos: productos.length,\n  total_unidades: totalUnidadesVendidas,\n  labels: labels,\n  valores: valores,\n  porcentajes: porcentajes,\n  colores: colores.slice(0, productos.length),\n  detalles: productos\n};\n\nconsole.log('✅ Estadísticas generadas:', estadisticas);\n\nreturn {\n  chat_id: datosFormateados.chat_id,\n  generar_grafico: true,\n  estadisticas: estadisticas,\n  tipo_grafico: 'productos_por_cantidad'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1216,
        1968
      ],
      "id": "730f419d-6229-4daf-a09b-83af5a54179e",
      "name": "Generar Estadísticas Ventas por Período"
    },
    {
      "parameters": {
        "jsCode": "// Generar URL de imagen con QuickChart.io para productos por cantidad\nconst estadisticas = $json.estadisticas;\n\nif (!$json.generar_grafico || !estadisticas) {\n  console.log('❌ No se debe generar gráfico');\n  return {\n    ...$json,\n    chart_url: null\n  };\n}\n\nconsole.log('🎨 Generando URL gráfico donut productos por cantidad');\n\n// Configuración del gráfico Chart.js\nconst configChart = {\n  type: 'doughnut',\n  data: {\n    labels: estadisticas.labels,\n    datasets: [{\n      data: estadisticas.valores,\n      backgroundColor: estadisticas.colores,\n      borderWidth: 3,\n      borderColor: '#ffffff'\n    }]\n  },\n  options: {\n    responsive: true,\n    plugins: {\n      title: {\n        display: true,\n        text: 'Productos más Vendidos',\n        font: {\n          size: 18,\n          weight: 'bold'\n        }\n      },\n      legend: {\n        position: 'bottom',\n        labels: {\n          padding: 20,\n          font: {\n            size: 12\n          },\n          generateLabels: function(chart) {\n            const data = chart.data;\n            if (data.labels.length && data.datasets.length) {\n              return data.labels.map((label, i) => {\n                const value = data.datasets[0].data[i];\n                const percentage = estadisticas.porcentajes[i];\n                return {\n                  text: `${label}: ${value} unidades (${percentage}%)`,\n                  fillStyle: data.datasets[0].backgroundColor[i],\n                  strokeStyle: data.datasets[0].borderColor,\n                  lineWidth: data.datasets[0].borderWidth,\n                  hidden: false,\n                  index: i\n                };\n              });\n            }\n            return [];\n          }\n        }\n      },\n      tooltip: {\n        callbacks: {\n          label: function(context) {\n            const label = context.label || '';\n            const value = context.parsed;\n            const percentage = estadisticas.porcentajes[context.dataIndex];\n            const cantidad = estadisticas.cantidades[context.dataIndex];\n            return `${label}: ${value} unidades (${percentage}%)`;\n          }\n        }\n      }\n    },\n    maintainAspectRatio: false\n  }\n};\n\n// Codificar configuración para URL\nconst chartConfigEncoded = encodeURIComponent(JSON.stringify(configChart));\nconst width = 600;\nconst height = 400;\n\n// Generar URL de QuickChart\nconst chartUrl = `https://quickchart.io/chart?c=${chartConfigEncoded}&w=${width}&h=${height}&f=png&backgroundColor=white`;\n\nconsole.log('📊 URL del gráfico generada');\n\nreturn {\n  ...$json,\n  chart_url: chartUrl\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1472,
        1968
      ],
      "id": "bd23b66a-412f-47b8-abd6-d983ac5dccae",
      "name": "Generar URL Gráfico Ventas"
    },
    {
      "parameters": {
        "url": "={{ $json.chart_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1760,
        1968
      ],
      "id": "c8853de9-bba5-484e-9e43-053168894bbf",
      "name": "Descargar Gráfico Ventas"
    },
    {
      "parameters": {
        "operation": "sendPhoto",
        "chatId": "={{ $('Formatear Respuesta Ventas').item.json.chat_id }}",
        "binaryData": true,
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2032,
        1968
      ],
      "id": "e7e3ec98-2bb1-4d13-8454-afbf555a4100",
      "name": "Enviar Gráfico Ventas",
      "webhookId": "grafico-ventas-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// DEBUGGING COMPLETO DEL PROCESO DE FACTURAS\nconst respuestaFacturas = $json.result || [];\nconst datosPreparar = $json.datos_preparar || {};\n\nconsole.log('🔬 DEBUGGING COMPLETO - ANÁLISIS DE FACTURAS:');\nconsole.log('=' .repeat(60));\n\n// 1. INFORMACIÓN DE ENTRADA\nconsole.log('📥 DATOS DE ENTRADA:');\nconsole.log('   - Respuesta HTTP facturas:', respuestaFacturas?.length || 0, 'facturas');\nconsole.log('   - Líneas de venta:', datosPreparar.ventas_lineas?.length || 0, 'líneas');\nconsole.log('   - Órdenes IDs esperadas:', datosPreparar.ordenes_ids?.length || 0, 'órdenes');\nconsole.log('   - Debug info:', JSON.stringify(datosPreparar.debug_info || {}, null, 2));\n\n// 2. ANÁLISIS DETALLADO DE RESPUESTA HTTP\nif (respuestaFacturas && respuestaFacturas.length > 0) {\n  console.log('\\n✅ FACTURAS OBTENIDAS DE ODOO:');\n  respuestaFacturas.forEach((factura, idx) => {\n    console.log(`   Factura ${idx + 1}:`);\n    console.log(`     - ID: ${factura.id}`);\n    console.log(`     - Nombre: ${factura.name || 'Sin nombre'}`);\n    console.log(`     - Cliente ID: ${factura.partner_id?.[0] || 'Sin ID'}`);\n    console.log(`     - Cliente Nombre: ${factura.partner_id?.[1] || 'Sin nombre'}`);\n    console.log(`     - Fecha: ${factura.date_order || 'Sin fecha'}`);\n    console.log(`     - Total: ${factura.amount_total || 0}`);\n    console.log(`     - Estado: ${factura.state || 'Sin estado'}`);\n    console.log(`     - Estructura completa:`, JSON.stringify(factura, null, 4));\n  });\n} else {\n  console.log('\\n❌ NO SE OBTUVIERON FACTURAS:');\n  console.log('   - Respuesta completa:', JSON.stringify($json, null, 2));\n  console.log('   - ¿Hubo error?:', $json.error || 'No hay error reportado');\n}\n\n// 3. ANÁLISIS DE LÍNEAS DE VENTA\nif (datosPreparar.ventas_lineas && datosPreparar.ventas_lineas.length > 0) {\n  console.log('\\n📊 ANÁLISIS DE LÍNEAS DE VENTA:');\n  const ordenesEnLineas = {};\n  \n  datosPreparar.ventas_lineas.forEach((linea, idx) => {\n    const orderId = linea.order_id?.[0];\n    const orderName = linea.order_id?.[1];\n    \n    if (!ordenesEnLineas[orderId]) {\n      ordenesEnLineas[orderId] = {\n        id: orderId,\n        nombre: orderName,\n        lineas: 0,\n        totalUnidades: 0,\n        totalImporte: 0\n      };\n    }\n    \n    ordenesEnLineas[orderId].lineas++;\n    ordenesEnLineas[orderId].totalUnidades += (linea.product_uom_qty || 0);\n    ordenesEnLineas[orderId].totalImporte += (linea.price_total || 0);\n    \n    console.log(`   Línea ${idx + 1}:`);\n    console.log(`     - Producto: ${linea.product_id?.[1] || 'N/A'}`);\n    console.log(`     - Orden ID: ${orderId}`);\n    console.log(`     - Orden Nombre: ${orderName}`);\n    console.log(`     - Cantidad: ${linea.product_uom_qty}`);\n    console.log(`     - Precio unitario: ${linea.price_unit}`);\n    console.log(`     - Total línea: ${linea.price_total}`);\n  });\n  \n  console.log('\\n📈 RESUMEN POR ÓRDENES:');\n  Object.values(ordenesEnLineas).forEach((orden, idx) => {\n    console.log(`   Orden ${idx + 1}:`);\n    console.log(`     - ID: ${orden.id}`);\n    console.log(`     - Nombre: ${orden.nombre}`);\n    console.log(`     - Líneas: ${orden.lineas}`);\n    console.log(`     - Total unidades: ${orden.totalUnidades}`);\n    console.log(`     - Total importe: ${orden.totalImporte}`);\n  });\n  \n  console.log(`\\n📊 TOTAL ÓRDENES ÚNICAS EN LÍNEAS: ${Object.keys(ordenesEnLineas).length}`);\n}\n\n// 4. VERIFICACIÓN DE CONCORDANCIA\nconsole.log('\\n🔍 VERIFICACIÓN DE CONCORDANCIA:');\nconst ordenesEsperadas = datosPreparar.ordenes_ids || [];\nconst ordenesObtenidas = respuestaFacturas.map(f => f.id) || [];\n\nconsole.log('   - IDs esperadas:', ordenesEsperadas);\nconsole.log('   - IDs obtenidas:', ordenesObtenidas);\n\nconst faltantes = ordenesEsperadas.filter(id => !ordenesObtenidas.includes(id));\nconst extras = ordenesObtenidas.filter(id => !ordenesEsperadas.includes(id));\n\nif (faltantes.length > 0) {\n  console.log('   ⚠️ Órdenes faltantes:', faltantes);\n}\nif (extras.length > 0) {\n  console.log('   ➕ Órdenes extras:', extras);\n}\nif (faltantes.length === 0 && extras.length === 0) {\n  console.log('   ✅ Concordancia perfecta');\n}\n\nconsole.log('\\n' + '=' .repeat(60));\n\n// COMBINAR DATOS PARA EL SIGUIENTE NODO\n// Intentar obtener datos del nodo anterior con fallback\nlet datosAnteriores = {};\ntry {\n  datosAnteriores = $('Debug Pre-HTTP').item.json;\n} catch (e) {\n  console.log('⚠️ No se pudieron obtener datos del nodo Debug Pre-HTTP:', e.message);\n}\n\nconst datosCombinados = {\n  ...$json, // Respuesta HTTP\n  datos_preparar: {\n    ventas_lineas: datosAnteriores.ventas_lineas || [],\n    datos_consulta: datosAnteriores.datos_consulta || {},\n    requiere_info_facturas: datosAnteriores.requiere_info_facturas || false,\n    ordenes_ids: datosAnteriores.ordenes_ids || [],\n    debug_info: datosAnteriores.debug_info || {}\n  }\n};\n\nconsole.log('🔄 DATOS COMBINADOS PARA FORMATEO:');\nconsole.log('   - Facturas HTTP:', datosCombinados.result?.length || 0);\nconsole.log('   - Líneas de venta:', datosCombinados.datos_preparar?.ventas_lineas?.length || 0);\nconsole.log('   - Requiere info facturas:', datosCombinados.datos_preparar?.requiere_info_facturas);\n\nreturn datosCombinados;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        1760
      ],
      "id": "c93e281d-9c4e-4a91-8ac1-973d615ec9f4",
      "name": "Debug Facturas Completo"
    },
    {
      "parameters": {
        "jsCode": "// DEBUG ADICIONAL: Verificar payload antes de envío HTTP\nconst payloadOrdenes = $json.payload_ordenes;\nconst debugInfo = $json.debug_info;\n\nconsole.log('🌐 DEBUG HTTP INFO FACTURAS - ANTES DEL ENVÍO:');\nconsole.log('=' .repeat(50));\nconsole.log('📤 Payload que se enviará:', JSON.stringify(payloadOrdenes, null, 2));\nconsole.log('🔍 Debug info recibido:', JSON.stringify(debugInfo, null, 2));\nconsole.log('📊 IDs que se buscarán:', debugInfo?.ordenes_ids);\nconsole.log('🔑 UID en uso:', debugInfo?.uid_usado);\nconsole.log('=' .repeat(50));\n\n// Pasar datos sin modificar\nreturn $json;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        288,
        1760
      ],
      "id": "2eb952f6-c213-4126-88ab-ab70d2cdbca0",
      "name": "Debug Pre-HTTP"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload_ordenes }}",
        "options": {
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        496,
        1760
      ],
      "id": "2055d3c6-34c7-4019-ac3d-71c717de58e2",
      "name": "HTTP Info Facturas"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.requiere_info_facturas }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        160,
        1952
      ],
      "id": "ae6529a1-f8a4-4b02-95ec-8627ebb606ab",
      "name": "¿Requiere Info Facturas?"
    },
    {
      "parameters": {
        "jsCode": "// Obtener información detallada de las facturas para productos específicos CON DEBUGGING MEJORADO\nconst ventas = $json.result;\nconst datosConsulta = $('Preparar Consulta Ventas').item.json;\n\nconsole.log('📊 PREPARAR INFO FACTURAS - DEBUG MEJORADO:');\nconsole.log('📄 Tipo consulta:', datosConsulta.tipo_consulta);\nconsole.log('📈 Número de líneas de venta:', ventas?.length || 0);\nconsole.log('🔍 Estructura completa respuesta Odoo:', JSON.stringify($json, null, 2));\n\n// Si no es una consulta de producto específico, pasar directamente al formateo\nif (datosConsulta.tipo_consulta !== 'producto_especifico' && datosConsulta.tipo_consulta !== 'producto_especifico_con_fechas') {\n  console.log('❌ No es consulta de producto específico');\n  return {\n    ...($json),\n    requiere_info_facturas: false,\n    datos_consulta: datosConsulta\n  };\n}\n\n// Si no hay ventas, pasar directamente\nif (!Array.isArray(ventas) || ventas.length === 0) {\n  console.log('❌ No hay ventas o no es array');\n  return {\n    ...($json),\n    requiere_info_facturas: false,\n    datos_consulta: datosConsulta\n  };\n}\n\n// DEBUGGING DETALLADO DE ÓRDENES\nconsole.log('🔍 ANALIZANDO ÓRDENES DE VENTA CON DETALLE:');\nventas.forEach((venta, idx) => {\n  console.log(`  Línea ${idx + 1}:`);\n  console.log(`    - Producto: ${venta.product_id?.[1] || 'N/A'}`);\n  console.log(`    - Order ID: ${venta.order_id?.[0] || 'N/A'}`);\n  console.log(`    - Order Name: ${venta.order_id?.[1] || 'N/A'}`);\n  console.log(`    - Cantidad: ${venta.product_uom_qty}`);\n  console.log(`    - Precio total: ${venta.price_total}`);\n  console.log(`    - Estructura order_id completa:`, JSON.stringify(venta.order_id, null, 2));\n});\n\n// Obtener IDs únicos de las órdenes de venta\nconst ordenesIds = [...new Set(ventas.map(v => v.order_id?.[0]).filter(id => id))];\n\nconsole.log('📋 ÓRDENES ÚNICAS ENCONTRADAS:');\nconsole.log('   IDs únicos:', ordenesIds);\nconsole.log('   Número de órdenes diferentes:', ordenesIds.length);\nconsole.log('   Tipo de IDs:', ordenesIds.map(id => typeof id));\n\nif (ordenesIds.length === 0) {\n  console.log('❌ No se encontraron IDs de órdenes válidas');\n  return {\n    ...($json),\n    requiere_info_facturas: false,\n    datos_consulta: datosConsulta\n  };\n}\n\n// Preparar consulta para obtener información de las órdenes de venta\nconst uid = datosConsulta.uid || 'user_uid_fallback';\nconsole.log('🔑 UID obtenido para consulta:', uid);\n\n// CONSULTA MEJORADA CON MÁS CAMPOS Y DEBUGGING\nconst consultaOrdenesMejorada = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"sale.order\",\n      \"search_read\",\n      [[[\"id\", \"in\", ordenesIds]]],\n      { \n        fields: [\n          \"id\", \"name\", \"partner_id\", \"date_order\", \"amount_total\", \n          \"state\", \"amount_untaxed\", \"amount_tax\"\n        ],\n        limit: 100\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🚀 CONSULTA MEJORADA A ÓRDENES DE VENTA:');\nconsole.log('   🔢 IDs a buscar:', ordenesIds);\nconsole.log('   📊 Cantidad de IDs:', ordenesIds.length);\nconsole.log('   🔑 UID usado:', uid);\nconsole.log('   📝 Consulta completa:', JSON.stringify(consultaOrdenesMejorada, null, 2));\n\nreturn {\n  payload_ordenes: consultaOrdenesMejorada,\n  ventas_lineas: ventas,\n  datos_consulta: datosConsulta,\n  requiere_info_facturas: true,\n  ordenes_ids: ordenesIds,\n  debug_info: {\n    total_lineas: ventas.length,\n    ordenes_unicas: ordenesIds.length,\n    ordenes_ids: ordenesIds,\n    uid_usado: uid,\n    consulta_preparada: new Date().toISOString(),\n    tipos_ids: ordenesIds.map(id => typeof id)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        1952
      ],
      "id": "9871278a-2212-437d-8d9e-1cedca84a1f8",
      "name": "Preparar Info Facturas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1344,
        1952
      ],
      "id": "ee59ad85-59f6-4adf-adbd-7ad69aeb8965",
      "name": "HTTP Consulta Ventas"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de líneas de productos para las órdenes obtenidas\nconst ventasResponse = $json.result;\nconst datosConsulta = $('Preparar Consulta Ventas').item.json;\n\nconsole.log('📦 PREPARAR CONSULTA LÍNEAS DE PRODUCTOS:');\nconsole.log('   - Ventas obtenidas:', ventasResponse?.length || 0);\nconsole.log('   - Tipo consulta:', datosConsulta.tipo_consulta);\n\n// Solo obtener líneas de productos para consultas generales (no para productos específicos)\nconst consultasQueNecesitanLineas = ['mes_actual', 'mes_pasado', 'mes_nombre', 'cliente_especifico'];\nconst necesitaLineas = consultasQueNecesitanLineas.includes(datosConsulta.tipo_consulta);\n\nif (!necesitaLineas || !Array.isArray(ventasResponse) || ventasResponse.length === 0) {\n  console.log('   ❌ No necesita líneas o no hay ventas');\n  return {\n    skip_lineas: true,\n    ventas_originales: $json,\n    datos_consulta: datosConsulta\n  };\n}\n\n// Obtener IDs de las órdenes para consultar sus líneas\nconst ordenIds = ventasResponse.map(venta => venta.id).filter(id => id);\nconsole.log('   📊 IDs de órdenes para consultar líneas:', ordenIds);\n\nif (ordenIds.length === 0) {\n  return {\n    skip_lineas: true,\n    ventas_originales: $json,\n    datos_consulta: datosConsulta\n  };\n}\n\n// Crear payload para obtener líneas de productos\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosConsulta.uid,\n      \"admin\",\n      \"sale.order.line\",\n      \"search_read\",\n      [[\n        [\"order_id\", \"in\", ordenIds]\n      ]],\n      { \n        fields: [\"order_id\", \"product_id\", \"product_uom_qty\", \"name\"],\n        limit: 1000 \n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Payload líneas de productos:', JSON.stringify(jsonRpcPayload, null, 2));\n\nreturn {\n  payload: jsonRpcPayload,\n  skip_lineas: false,\n  ventas_originales: $json,\n  datos_consulta: datosConsulta,\n  orden_ids: ordenIds\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        1952
      ],
      "id": "cd50653b-f3c0-4072-93c5-b2bcbc06cd8c",
      "name": "Preparar Consulta Líneas Productos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.skip_lineas ? '{\"jsonrpc\":\"2.0\",\"method\":\"call\",\"params\":{},\"id\":1}' : JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -912,
        1952
      ],
      "id": "3874c786-52ed-4c7b-85e3-c77c1b6f0da7",
      "name": "HTTP Consulta Líneas Productos"
    },
    {
      "parameters": {
        "jsCode": "// Combinar ventas con sus líneas de productos\nconst lineasResponse = $json;\nconst datosAnteriores = $('Preparar Consulta Líneas Productos').item.json;\n\nconsole.log('🔄 COMBINAR VENTAS CON LÍNEAS:');\nconsole.log('   - Skip líneas:', datosAnteriores.skip_lineas);\n\nif (datosAnteriores.skip_lineas) {\n  console.log('   ↩️ Saltando líneas, devolviendo ventas originales');\n  return datosAnteriores.ventas_originales;\n}\n\nconst lineasProductos = lineasResponse.result || [];\nconst ventasOriginales = datosAnteriores.ventas_originales.result || [];\n\nconsole.log('   - Líneas obtenidas:', lineasProductos.length);\nconsole.log('   - Ventas originales:', ventasOriginales.length);\n\n// Agrupar líneas por order_id\nconst lineasPorOrden = {};\nlineasProductos.forEach(linea => {\n  const orderId = linea.order_id?.[0];\n  if (orderId) {\n    if (!lineasPorOrden[orderId]) {\n      lineasPorOrden[orderId] = [];\n    }\n    lineasPorOrden[orderId].push({\n      producto: linea.product_id?.[1] || linea.name || 'Producto sin nombre',\n      cantidad: linea.product_uom_qty || 0\n    });\n  }\n});\n\n// Agregar líneas de productos a las ventas\nconst ventasConLineas = ventasOriginales.map(venta => {\n  const lineasDeEstaOrden = lineasPorOrden[venta.id] || [];\n  return {\n    ...venta,\n    productos: lineasDeEstaOrden\n  };\n});\n\nconsole.log('   ✅ Ventas combinadas con productos');\n\nreturn {\n  ...datosAnteriores.ventas_originales,\n  result: ventasConLineas\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        1952
      ],
      "id": "b4e0d67b-c2b8-4af8-abb4-cfd97a483293",
      "name": "Combinar Ventas con Líneas"
    },
    {
      "parameters": {
        "jsCode": "// Procesar consulta de ventas desde AI Agent\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst tipoConsulta = datosAI.tipo_consulta;\nconst parametro = datosAI.parametro;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nlet jsonRpcPayload;\n\n// VENTAS DEL MES ACTUAL\nif (tipoConsulta === 'mes_actual') {\n  const now = new Date();\n  const year = now.getFullYear();\n  const month = now.getMonth() + 1;\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"sale.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", primerDia],\n          [\"date_order\", \"<\", primerDiaSiguienteMes]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"order_line\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n} \n// VENTAS DEL MES PASADO\nelse if (tipoConsulta === 'mes_pasado') {\n  const now = new Date();\n  let year = now.getFullYear();\n  let month = now.getMonth();\n  if (month === 0) {\n    month = 12;\n    year = year - 1;\n  }\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"sale.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", primerDia],\n          [\"date_order\", \"<\", primerDiaSiguienteMes]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"order_line\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// VENTAS POR PRODUCTO\nelse if (tipoConsulta === 'producto_especifico') {\n  if (!parametro) {\n    throw new Error('Se requiere especificar un producto para buscar');\n  }\n  const palabras = parametro.split(' ');\n  const condiciones = palabras.map(p => [\"product_id\", \"ilike\", p]);\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"sale.order.line\",\n        \"search_read\",\n        [[[\"product_id\", \"ilike\", parametro], ...condiciones]],\n        { \"fields\": [\"order_id\", \"product_id\", \"product_uom_qty\", \"price_total\", \"price_unit\", \"name\"], \"limit\": 1000 }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// VENTAS POR PRODUCTO CON FILTROS DE FECHA\nelse if (tipoConsulta === 'producto_especifico_con_fechas') {\n  const fechaDesde = datosAI.fecha_desde;\n  const fechaHasta = datosAI.fecha_hasta;\n  \n  // Validar fechas\n  if (!fechaDesde || !fechaHasta) {\n    throw new Error('Se requieren fecha_desde y fecha_hasta para consultas con filtros de fecha');\n  }\n  \n  // Si no hay parámetro de producto, buscar todas las ventas en el rango de fechas\n  if (!parametro) {\n    console.log('⚠️ Consulta de ventas por fechas sin producto específico, buscando todas las ventas en el período');\n    jsonRpcPayload = {\n      jsonrpc: \"2.0\",\n      method: \"call\",\n      params: {\n        service: \"object\",\n        method: \"execute_kw\",\n        args: [\n          \"lsanchezgoshawk-n8npruebas-main-25736898\",\n          uid,\n          \"admin\",\n          \"sale.order\",\n          \"search_read\",\n          [[\n            [\"date_order\", \">=\", fechaDesde],\n            [\"date_order\", \"<=\", fechaHasta]\n          ]],\n          { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"order_line\"] }\n        ]\n      },\n      id: Math.floor(Math.random() * 1000000)\n    };\n  } else {\n    const palabras = parametro.split(' ');\n    const condicionesProducto = palabras.map(p => [\"product_id\", \"ilike\", p]);\n    \n    // Necesitamos hacer una consulta compleja:\n    // 1. Buscar líneas de venta del producto\n    // 2. Filtrar por fechas de las órdenes asociadas\n    // Para eso, usaremos una consulta con join implícito\n    \n    jsonRpcPayload = {\n      jsonrpc: \"2.0\",\n      method: \"call\",\n      params: {\n        service: \"object\",\n        method: \"execute_kw\",\n        args: [\n          \"lsanchezgoshawk-n8npruebas-main-25736898\",\n          uid,\n          \"admin\",\n          \"sale.order.line\",\n          \"search_read\",\n          [[\n            [\"product_id\", \"ilike\", parametro], \n            ...condicionesProducto,\n            [\"order_id.date_order\", \">=\", fechaDesde],\n            [\"order_id.date_order\", \"<=\", fechaHasta]\n          ]],\n          { \n            \"fields\": [\"order_id\", \"product_id\", \"product_uom_qty\", \"price_total\", \"price_unit\", \"name\"], \n            \"limit\": 1000 \n          }\n        ]\n      },\n      id: Math.floor(Math.random() * 1000000)\n    };\n  }\n}\n// VENTAS POR CLIENTE ESPECÍFICO\nelse if (tipoConsulta === 'cliente_especifico') {\n  if (!parametro) {\n    throw new Error('Se requiere especificar un cliente para buscar');\n  }\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"sale.order\",\n        \"search_read\",\n        [[\n          [\"partner_id\", \"ilike\", parametro]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"order_line\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// VENTAS POR MES ESPECÍFICO (nombre)\nelse if (tipoConsulta === 'mes_nombre') {\n  if (!parametro) {\n    throw new Error('Se requiere especificar un mes para buscar');\n  }\n  const meses = [\n    \"enero\", \"febrero\", \"marzo\", \"abril\", \"mayo\", \"junio\",\n    \"julio\", \"agosto\", \"septiembre\", \"octubre\", \"noviembre\", \"diciembre\"\n  ];\n  const mesIndex = meses.indexOf(parametro.toLowerCase());\n  if (mesIndex !== -1) {\n    const now = new Date();\n    let year = now.getFullYear();\n    if (mesIndex + 1 > (now.getMonth() + 1)) {\n      year = year - 1;\n    }\n    const mes = (mesIndex + 1) < 10 ? `0${mesIndex + 1}` : `${mesIndex + 1}`;\n    const primerDia = `${year}-${mes}-01`;\n    const siguienteMes = (mesIndex + 2) > 12 ? 1 : (mesIndex + 2);\n    const siguienteAnio = (mesIndex + 2) > 12 ? year + 1 : year;\n    const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n    const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n    jsonRpcPayload = {\n      jsonrpc: \"2.0\",\n      method: \"call\",\n      params: {\n        service: \"object\",\n        method: \"execute_kw\",\n        args: [\n          \"lsanchezgoshawk-n8npruebas-main-25736898\",\n          uid,\n          \"admin\",\n          \"sale.order\",\n          \"search_read\",\n          [[\n            [\"date_order\", \">=\", primerDia],\n            [\"date_order\", \"<\", primerDiaSiguienteMes]\n          ]],\n          { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"order_line\"] }\n        ]\n      },\n      id: Math.floor(Math.random() * 1000000)\n    };\n  }\n}\n\nreturn {\n  payload: jsonRpcPayload,\n  tipo_consulta: tipoConsulta,\n  parametro: parametro,\n  fecha_desde: datosAI.fecha_desde || null,\n  fecha_hasta: datosAI.fecha_hasta || null,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1536,
        1952
      ],
      "id": "1868cb07-40b7-401b-a888-fd2c5e7862c2",
      "name": "Preparar Consulta Ventas"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -176,
        1728
      ],
      "id": "af803d82-d65e-49a3-848a-b8b3deae0d89",
      "name": "Enviar Respuesta Producto",
      "webhookId": "da26a341-de8d-4525-8b4d-ef0b159fc4cf"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta completa de productos para Telegram\nconst datos = $('Combinar Info Completa').item.json;\n\nif (datos.error) {\n  return {\n    texto: datos.mensaje,\n    chat_id: datos.chat_id\n  };\n}\n\nconst productos = datos.productos;\nlet texto = `🔍 *Consulta de Producto: ${datos.producto_buscado}*\\n\\n`;\n\nif (productos.length === 0) {\n  texto += '❌ No se encontraron productos.';\n} else {\n  productos.forEach((p, idx) => {\n    texto += `*${idx + 1}. ${p.nombre}*\\n`;\n    texto += `📝 Código: \\`${p.codigo}\\`\\n`;\n    texto += `🏷️ Categoría: ${p.categoria}\\n`;\n    texto += `💰 Precio venta: €${p.precio_venta}\\n`;\n    texto += `💸 Precio costo: €${p.precio_costo}\\n`;\n    \n    texto += `\\n📦 *STOCK*\\n`;\n    texto += `• Stock actual: *${p.stock_actual}* ${p.unidad_medida}\\n`;\n    texto += `• Stock pronosticado: *${p.stock_pronosticado}* ${p.unidad_medida}\\n`;\n    \n    // Mostrar ubicaciones si hay stock\n    if (p.stock_por_ubicacion.length > 0) {\n      texto += `\\n📍 *UBICACIONES*\\n`;\n      p.stock_por_ubicacion.forEach(u => {\n        if (u.cantidad > 0) {\n          texto += `• ${u.ubicacion}: *${u.cantidad}* unidades\\n`;\n          if (u.reservado > 0) {\n            texto += `  └ Reservado: ${u.reservado}, Disponible: ${u.disponible}\\n`;\n          }\n        }\n      });\n    } else {\n      texto += `📍 *Sin stock en ubicaciones específicas*\\n`;\n    }\n    \n    texto += `\\n📈 *VENTAS (Últimos 6 meses)*\\n`;\n    texto += `• Total vendido: *${p.total_vendido_6meses}* unidades\\n`;\n    texto += `• Total facturado: *€${p.total_facturado_6meses}*\\n`;\n    texto += `• Número de órdenes: ${p.numero_ordenes}\\n`;\n    \n    // Análisis básico\n    texto += `\\n💡 *ANÁLISIS*\\n`;\n    if (p.stock_actual <= 0) {\n      texto += `⚠️ *SIN STOCK* - Requiere reposición urgente\\n`;\n    } else if (p.stock_actual < 10) {\n      texto += `🟡 *STOCK BAJO* - Considerar reposición\\n`;\n    } else {\n      texto += `✅ *STOCK DISPONIBLE*\\n`;\n    }\n    \n    if (p.total_vendido_6meses > 0) {\n      const promedioMensual = (p.total_vendido_6meses / 6).toFixed(1);\n      texto += `📊 Promedio mensual: ${promedioMensual} unidades\\n`;\n    }\n    \n    if (idx < productos.length - 1) {\n      texto += `\\n${'─'.repeat(30)}\\n\\n`;\n    }\n  });\n}\n\nreturn {\n  texto,\n  chat_id: datos.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        1728
      ],
      "id": "6446ac44-e548-4a0b-b269-411c0f06099b",
      "name": "Formatear Respuesta Producto"
    },
    {
      "parameters": {
        "jsCode": "// Consultar ubicaciones de stock del producto\nconst respuestaProducto = $('HTTP Consulta Producto').item.json.result || [];\nconst datosBase = $('Preparar Consulta Producto').item.json;\n\nif (respuestaProducto.length === 0) {\n  // Si no hay productos, pasar datos vacíos\n  return {\n    productos_ids: [],\n    payload_stock: null,\n    payload_ventas: null,\n    skip_queries: true,\n    chat_id: datosBase.chat_id,\n    producto_buscado: datosBase.producto\n  };\n}\n\n// Extraer IDs de productos encontrados\nconst productosIds = respuestaProducto.map(p => p.id);\n\nconsole.log('📦 PREPARAR CONSULTAS ADICIONALES:');\nconsole.log('   - Productos encontrados:', productosIds.length);\nconsole.log('   - IDs:', productosIds);\n\n// 2. CONSULTA DE STOCK POR UBICACIONES\nconst payloadStock = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosBase.uid,\n      \"admin\",\n      \"stock.quant\",\n      \"search_read\",\n      [[\n        [\"product_id\", \"in\", productosIds],\n        [\"quantity\", \">\", 0]\n      ]], // Domain (criterios de búsqueda)\n      {\"fields\": [\"product_id\", \"location_id\", \"quantity\", \"reserved_quantity\", \"available_quantity\"], \"limit\": 100} // Kwargs (campos y opciones)\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\n// 3. CONSULTA DE VENTAS (ÚLTIMOS 6 MESES)\nconst fechaDesde = new Date(Date.now() - 6*30*24*60*60*1000).toISOString().split('T')[0];\nconst payloadVentas = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosBase.uid,\n      \"admin\",\n      \"sale.order.line\",\n      \"search_read\",\n      [[\n        [\"product_id\", \"in\", productosIds],\n        [\"order_id.date_order\", \">=\", fechaDesde],\n        [\"order_id.state\", \"in\", [\"sale\", \"done\"]]\n      ]], // Domain (criterios de búsqueda)\n      {\"fields\": [\"product_id\", \"product_uom_qty\", \"qty_delivered\", \"price_total\", \"order_id\"], \"limit\": 200} // Kwargs (campos y opciones)\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  productos_info: respuestaProducto,\n  productos_ids: productosIds,\n  payload_stock: payloadStock,\n  payload_ventas: payloadVentas,\n  skip_queries: false,\n  chat_id: datosBase.chat_id,\n  producto_buscado: datosBase.producto,\n  uid: datosBase.uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1088,
        1616
      ],
      "id": "a117ee62-de8d-4ae8-831a-cbe48851d2a7",
      "name": "Preparar Consultas Adicionales"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.skip_queries ? JSON.stringify({\"jsonrpc\": \"2.0\", \"method\": \"call\", \"params\": {\"service\": \"object\", \"method\": \"execute_kw\", \"args\": [\"lsanchezgoshawk-n8npruebas-main-25736898\", 1, \"admin\", \"stock.quant\", \"search_read\", [[\"id\", \"=\", -1]], {\"fields\": [\"id\"], \"limit\": 0}]}, \"id\": 1}) : JSON.stringify($json.payload_stock) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -896,
        1568
      ],
      "id": "6af37cc7-16c3-4f10-9cdf-baecbe780730",
      "name": "HTTP Stock Ubicaciones"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.skip_queries ? JSON.stringify({\"jsonrpc\": \"2.0\", \"method\": \"call\", \"params\": {\"service\": \"object\", \"method\": \"execute_kw\", \"args\": [\"lsanchezgoshawk-n8npruebas-main-25736898\", 1, \"admin\", \"sale.order.line\", \"search_read\", [[\"id\", \"=\", -1]], {\"fields\": [\"id\"], \"limit\": 0}]}, \"id\": 2}) : JSON.stringify($json.payload_ventas) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -912,
        1728
      ],
      "id": "2088e403-8ec0-43e0-98eb-bdb347f0df15",
      "name": "HTTP Ventas Producto"
    },
    {
      "parameters": {
        "jsCode": "// Combinar toda la información del producto - MANEJO SEGURO DE NODOS\n\n// Función para obtener datos de nodos de manera segura\nfunction obtenerDatosSeguro(nombreNodo) {\n  try {\n    const nodo = $(nombreNodo);\n    if (nodo && nodo.item && nodo.item.json) {\n      return nodo.item.json;\n    }\n    return null;\n  } catch (error) {\n    console.log(`⚠️ Nodo \"${nombreNodo}\" no disponible:`, error.message);\n    return null;\n  }\n}\n\n// Obtener datos de forma segura\nconst datosBase = obtenerDatosSeguro('Preparar Consultas Adicionales');\nconst stockData = obtenerDatosSeguro('HTTP Stock Ubicaciones');\nconst ventasData = obtenerDatosSeguro('HTTP Ventas Producto');\n\nif (!datosBase) {\n  return {\n    error: true,\n    mensaje: '❌ Error interno: No se pudieron obtener los datos base del producto.',\n    chat_id: 'unknown'\n  };\n}\n\nif (datosBase.skip_queries) {\n  return {\n    error: true,\n    mensaje: `❌ No se encontró ningún producto con el nombre \"${datosBase.producto_buscado}\".`,\n    chat_id: datosBase.chat_id\n  };\n}\n\n// Extraer datos de stock y ventas\nconst stockUbicaciones = (stockData && stockData.result) ? stockData.result : [];\nconst ventasProducto = (ventasData && ventasData.result) ? ventasData.result : [];\nconst productosInfo = datosBase.productos_info || [];\n\nconsole.log('📊 COMBINANDO INFORMACIÓN COMPLETA:');\nconsole.log('   - Productos:', productosInfo.length);\nconsole.log('   - Stock ubicaciones:', stockUbicaciones.length);\nconsole.log('   - Ventas históricas:', ventasProducto.length);\n\n// Procesar cada producto encontrado\nconst productosCompletos = productosInfo.map(producto => {\n  const productId = producto.id;\n  \n  // Stock por ubicaciones de este producto\n  const stockDeEsteProducto = stockUbicaciones.filter(s => s.product_id && s.product_id[0] === productId);\n  \n  // Ventas de este producto\n  const ventasDeEsteProducto = ventasProducto.filter(v => v.product_id && v.product_id[0] === productId);\n  \n  // Calcular estadísticas de ventas\n  const totalVendido = ventasDeEsteProducto.reduce((sum, v) => sum + (v.product_uom_qty || 0), 0);\n  const totalFacturado = ventasDeEsteProducto.reduce((sum, v) => sum + (v.price_total || 0), 0);\n  \n  // Agrupar stock por ubicación\n  const stockPorUbicacion = stockDeEsteProducto.map(s => ({\n    ubicacion: s.location_id ? s.location_id[1] : 'Ubicación desconocida',\n    cantidad: s.quantity || 0,\n    reservado: s.reserved_quantity || 0,\n    disponible: s.available_quantity || 0\n  }));\n  \n  return {\n    id: productId,\n    nombre: producto.name,\n    codigo: producto.default_code || 'Sin código',\n    precio_venta: producto.list_price || 0,\n    precio_costo: producto.standard_price || 0,\n    categoria: producto.categ_id ? producto.categ_id[1] : 'Sin categoría',\n    unidad_medida: producto.uom_id ? producto.uom_id[1] : 'Unidad',\n    \n    // Stock\n    stock_actual: producto.qty_available || 0,\n    stock_pronosticado: producto.virtual_available || 0,\n    stock_por_ubicacion: stockPorUbicacion,\n    \n    // Ventas (últimos 6 meses)\n    total_vendido_6meses: totalVendido,\n    total_facturado_6meses: totalFacturado.toFixed(2),\n    numero_ordenes: ventasDeEsteProducto.length\n  };\n});\n\nreturn {\n  productos: productosCompletos,\n  chat_id: datosBase.chat_id,\n  producto_buscado: datosBase.producto_buscado\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -656,
        1728
      ],
      "id": "87fae92e-7042-4eac-afad-6c860d138b77",
      "name": "Combinar Info Completa"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1264,
        1616
      ],
      "id": "03706bed-a555-4cb1-a556-ef3b35168aa3",
      "name": "HTTP Consulta Producto"
    },
    {
      "parameters": {
        "jsCode": "// Procesar consulta avanzada de producto desde AI Agent\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreProducto = datosAI.producto;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\n// Validar que tenemos nombre del producto\nif (!nombreProducto) {\n  throw new Error('No se encontró el nombre del producto');\n}\n\nconsole.log('🔍 CONSULTA AVANZADA DE PRODUCTO:', nombreProducto);\n\n// 1. BÚSQUEDA DE INFORMACIÓN BÁSICA DEL PRODUCTO\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid, \n      \"admin\", \n      \"product.product\", // Cambio a product.product para obtener más detalles\n      \"search_read\",\n      [[[\"name\", \"ilike\", nombreProducto]]], // Domain (criterios de búsqueda)\n      {\"fields\": [\"id\", \"name\", \"default_code\", \"list_price\", \"standard_price\", \"qty_available\", \"virtual_available\", \"categ_id\", \"uom_id\"], \"limit\": 10} // Kwargs (campos y opciones)\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  producto: nombreProducto,\n  chat_id: datosAI.chat_id,\n  uid: uid,\n  paso: 1, // Indicador de que este es el primer paso\n  total_pasos: 3 // Total de consultas que haremos\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        1616
      ],
      "id": "d2c28a5e-f0b1-421e-9bc8-13bac03f1f11",
      "name": "Preparar Consulta Producto"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_horas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "db6b3a7e-1dbc-480b-9f19-140a5b475ff8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_horas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_gasto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "registrar-gasto-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_gasto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_proyecto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4d3b1b52-3a05-4db9-8e20-4a169f36c573"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_proyecto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_tarea",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7982d83f-173e-4fd4-8575-f14bbd738755"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_tarea"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_producto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "bdbcf283-8a52-450f-abdc-fd2b9c59118b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "b9532306-5919-48a0-999a-3241b8e558ed",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_ventas_por_orden",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_ventas_por_orden"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_ventas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f110a38e-bd19-44f9-b101-60d57a8d0c4c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_ventas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_compras",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f110a38e-bd19-44f9-b101-60d57a8d0c5c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_compras"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_facturas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f110a38e-bd19-44f9-b101-60d57a8d0c6d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_facturas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_pagos_pendientes",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f110a38e-bd19-44f9-b101-60d57a8d0c6e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_pagos_pendientes"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_top_rankings",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f110a38e-bd19-44f9-b101-60d57a8d0c6f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_top_rankings"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_ranking_comerciales",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ranking-comerciales-condition-v40-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_ranking_comerciales"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_ventas_perdidas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ventas-perdidas-condition-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_ventas_perdidas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_contacto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c4b58122-b0e0-44ad-8bb3-f518d674a40e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_contacto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_contacto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "23be78fa-e92c-45e1-a66e-023bd2a99a31"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_contacto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_proyecto_tarea_horas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e1a59b7b-5617-4db7-925b-f544943d2364"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_proyecto_tarea_horas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_tarea_y_horas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3720ebf9-3c0c-43ed-8c15-6c3e2abfb46f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_tarea_y_horas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "modificar_contacto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7e6cda34-8686-4a24-8f48-61870b29dbc8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "modificar_contacto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "mensaje_bienvenida",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8a7f2e5c-9d8e-4f1a-b2c3-456789abcdef"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mensaje_bienvenida"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_horas_proyecto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "9b8e3f6d-ae9f-5a2b-c3d4-567890abcdef"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_horas_proyecto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_horas_tarea",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "0c9f4g7e-bf0g-6b3c-d4e5-678901bcdefg"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_horas_tarea"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_actividad_usuario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1d0h5i8f-cg1h-7c4d-e5f6-789012cdefgh"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_actividad_usuario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_ausencias",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "2e1i6j9g-dh2i-8d5e-f6g7-890123defghi"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_ausencias"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_eventos_usuario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3f2j7k0h-ei3j-9e6f-g7h8-901234efghij"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_eventos_usuario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_visitantes_web",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "visitantes-web-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_visitantes_web"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_pedido_venta",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "crear-pedido-venta-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_pedido_venta"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_evento_calendario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "crear-evento-calendario-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_evento_calendario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_evento_calendario_incompleto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "crear-evento-calendario-incompleto-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_evento_calendario_incompleto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_usuario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "registrar-usuario-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_usuario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "limitar_modulos",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "limitar-modulos-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "limitar_modulos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "e58624f9-4c1e-47c1-ab70-d401337feac7",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_ausencia",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_ausencia"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_tickets",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "consultar-tickets-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_tickets"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "anadir_mensaje_ticket",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "anadir-mensaje-ticket-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "anadir_mensaje_ticket"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_fabricaciones",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "consultar-fabricaciones-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_fabricaciones"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_pedido_compra",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "crear-pedido-compra-001"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_pedido_compra"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "897c11f8-1141-4ed8-a242-1f7a8f179727",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "fsm_inventario",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "fsm_inventario"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "15e0a24c-9042-4117-91da-a9bdab893f2b",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_parte_y_stock",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_parte_y_stock"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "1c0e741a-8bdd-4fd6-81ba-1abec7b3f648",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_proyecto_tarea_horas_fsm",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_proyecto_tarea_horas_fsm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "f1201c8a-cbef-4d63-bba2-d9a45b5e1db1",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_tarea_y_horas_fsm",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_tarea_y_horas_fsm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "6c9618a4-66f8-4199-a2e2-96ae449915b6",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "falta_cliente_fsm",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "falta_cliente_fsm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "564d8b13-6045-4e29-ac6a-efb5965d9afe",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "fsm_inventario_reanudar",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "fsm_inventario_reanudar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "c2495ad0-d5d2-4a32-bf9f-b237d3db5813",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_estado_proyecto",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_estado_proyecto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "06459b24-aec5-4121-9d11-c858812be1d9",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_proyectos_por_etapa",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_proyectos_por_etapa"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "0f783140-f91a-43d1-846a-e8cfe806ee4e",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "transferir_stock_almacen",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "transferir_stock_almacen"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "6611ebc5-e1b4-4bee-8900-722cd8efc728",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "modificar_pedido_venta",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "modificar_pedido_venta"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "id": "4d130bb5-c7e0-4f66-9b39-ede2293ba93b",
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "modificar_pedido_detalle",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "modificar_pedido_detalle"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -3360,
        2864
      ],
      "id": "d5e11835-971a-41b6-b384-bbebc2d7c1c2",
      "name": "Switch Acciones"
    },
    {
      "parameters": {
        "jsCode": "// ROUTER INTELIGENTE - Detecta confirmaciones y consulta memoria\nconst respuestaAgent = $json;\nconst chatId = respuestaAgent.chat_id;\n\n// 🔥 USAR MEMORIA DE POSTGRESQL EN LUGAR DE GLOBAL\n// Obtener memoria desde el nodo anterior que consultó PostgreSQL\nconst datosConMemoria = $('Preparar Datos AI Agent').first().json;\nlet memoria = {\n  esperando_confirmacion: datosConMemoria.esperando_confirmacion,\n  datos_pendientes: datosConMemoria.datos_pendientes\n};\n\nconsole.log('🎯 === ROUTER INTELIGENTE ===');\nconsole.log('📥 Acción recibida:', respuestaAgent.accion);\nconsole.log('💬 Mensaje usuario:', respuestaAgent.mensaje_usuario || respuestaAgent.mensaje_original);\nconsole.log('🧠 Memoria PostgreSQL:', JSON.stringify(memoria, null, 2));\nconsole.log('📋 Datos completos AI Agent:', JSON.stringify(datosConMemoria, null, 2));\n\n// DETECTAR CONFIRMACIONES INTELIGENTES\nlet accionFinal = respuestaAgent.accion;\nlet datosFinales = { ...respuestaAgent };\n\n// Si el usuario está esperando confirmación y dice algo que parece confirmación\nif (memoria.esperando_confirmacion && memoria.datos_pendientes) {\n  const mensajeUsuario = (respuestaAgent.mensaje_usuario || '').toLowerCase();\n  const esConfirmacion = mensajeUsuario.includes('sí') || \n                        mensajeUsuario.includes('si') || \n                        mensajeUsuario.includes('crear') ||\n                        mensajeUsuario.includes('adelante') ||\n                        mensajeUsuario.includes('vale') ||\n                        respuestaAgent.accion === 'conversar' && mensajeUsuario.includes('sí');\n  \n  if (esConfirmacion) {\n    console.log('✅ CONFIRMACIÓN DETECTADA!');\n    console.log('🤔 Esperando confirmación de:', memoria.esperando_confirmacion);\n    console.log('📋 Datos pendientes:', memoria.datos_pendientes);\n    \n    // Determinar acción basándose en lo que está pendiente\n    if (memoria.esperando_confirmacion === 'crear_proyecto_completo' && \n        memoria.datos_pendientes.tipo_creacion === 'proyecto_tarea_horas') {\n      accionFinal = 'crear_proyecto_tarea_horas';\n      datosFinales = {\n        ...respuestaAgent,\n        accion: 'crear_proyecto_tarea_horas',\n        proyecto: memoria.datos_pendientes.proyecto,\n        tarea: memoria.datos_pendientes.tarea,\n        horas: memoria.datos_pendientes.horas,\n        descripcion: memoria.datos_pendientes.descripcion,\n        datos_pendientes: memoria.datos_pendientes\n      };\n      console.log('🏗️ Acción cambiada a: crear_proyecto_tarea_horas');\n    }\n    else if (memoria.esperando_confirmacion === 'crear_tarea_solamente' && \n             memoria.datos_pendientes.tipo_creacion === 'solo_tarea_horas') {\n      accionFinal = 'crear_tarea_y_horas';\n      datosFinales = {\n        ...respuestaAgent,\n        accion: 'crear_tarea_y_horas',\n        proyecto: memoria.datos_pendientes.proyecto,\n        proyecto_id: memoria.datos_pendientes.proyecto_id,\n        tarea: memoria.datos_pendientes.tarea,\n        horas: memoria.datos_pendientes.horas,\n        descripcion: memoria.datos_pendientes.descripcion,\n        datos_pendientes: memoria.datos_pendientes\n      };\n      console.log('✅ Acción cambiada a: crear_tarea_y_horas');\n    }\n    else if (memoria.esperando_confirmacion === 'crear_proyecto' && \n             memoria.datos_pendientes.accion_original === 'registrar_horas') {\n      // Mantener lógica existente para compatibilidad\n      accionFinal = 'crear_proyecto';\n      console.log('🏗️ Manteniendo lógica existente: crear_proyecto');\n    }\n    // Reanudar flujo: estábamos esperando el número de pedido para modificarlo\n    else if (memoria.esperando_confirmacion === 'modificar_pedido_pedir_numero') {\n      accionFinal = 'modificar_pedido_venta';\n\n      datosFinales = {\n    ...respuestaAgent, // por si quieres conservar texto del agente\n    accion: 'modificar_pedido_venta',\n    // mantenemos mensaje_original para que Detectar Número Pedido tenga el texto\n            mensaje_original: (respuestaAgent.mensaje_original || respuestaAgent.text |respuestaAgent.mensaje || ''),\n    datos_pendientes: memoria.datos_pendientes || {},\n      };\n\n  console.log('🛒 Reanudar: modificar_pedido_venta (estábamos esperando número)');\n   }\n    // Reanudar flujo: ya habíamos mostrado el pedido y estamos en modo \"modificar detalles\"\nelse if (memoria.esperando_confirmacion === 'modificar_pedido_detalle') {\n  accionFinal = 'modificar_pedido_detalle';\n\n  datosFinales = {\n    ...respuestaAgent,\n    accion: 'modificar_pedido_detalle',\n    mensaje_original: (\n      respuestaAgent.mensaje_original ||\n      respuestaAgent.text ||\n      respuestaAgent.mensaje ||\n      ''\n    ),\n    pedido_id: memoria.datos_pendientes?.pedido_id,\n    pedido_numero: memoria.datos_pendientes?.pedido_numero,\n    lineas: memoria.datos_pendientes?.lineas || [],\n  };\n\n  console.log('🛠️ Acción cambiada a: modificar_pedido_detalle');\n}\n    // NUEVO: confirmación de eliminar una línea entera\nelse if (memoria.esperando_confirmacion === 'modificar_pedido_confirmar_eliminacion_linea') {\n  accionFinal = 'modificar_pedido_confirmar_eliminacion_linea';\n  datosFinales = {\n    ...respuestaAgent,\n    accion: 'modificar_pedido_confirmar_eliminacion_linea',\n    mensaje_original: (\n      respuestaAgent.mensaje_original ||\n      respuestaAgent.text ||\n      respuestaAgent.mensaje ||\n      ''\n    ),\n    datos_pendientes: memoria.datos_pendientes || {},\n  };\n  console.log('🗑️ Reanudar: confirmar eliminación de línea');\n}\n\n// NUEVO: elegir línea cuando hay varias en el pedido que matchean (\"tarta grande\", \"tarta pequeña\"...)\nelse if (memoria.esperando_confirmacion === 'modificar_pedido_elegir_linea') {\n  accionFinal = 'modificar_pedido_elegir_linea';\n  datosFinales = {\n    ...respuestaAgent,\n    accion: 'modificar_pedido_elegir_linea',\n    mensaje_original: (\n      respuestaAgent.mensaje_original ||\n      respuestaAgent.text ||\n      respuestaAgent.mensaje ||\n      ''\n    ),\n    datos_pendientes: memoria.datos_pendientes || {},\n  };\n  console.log('🎯 Reanudar: elegir línea de producto');\n}\n\n// NUEVO: elegir producto destino en Odoo cuando hay varias coincidencias\nelse if (memoria.esperando_confirmacion === 'modificar_pedido_elegir_producto_nuevo') {\n  accionFinal = 'modificar_pedido_elegir_producto_nuevo';\n  datosFinales = {\n    ...respuestaAgent,\n    accion: 'modificar_pedido_elegir_producto_nuevo',\n    mensaje_original: (\n      respuestaAgent.mensaje_original ||\n      respuestaAgent.text ||\n      respuestaAgent.mensaje ||\n      ''\n    ),\n    datos_pendientes: memoria.datos_pendientes || {},\n  };\n  console.log('🧀 Reanudar: elegir producto nuevo en Odoo');\n}\n  }\n}\n\n// Actualizar memoria solo para acciones específicas\nif (accionFinal === 'registrar_horas') {\n  const contextoKey = `memoria_${chatId}`;\n  memoria.proyecto_anterior = respuestaAgent.proyecto;\n  memoria.tarea_anterior = respuestaAgent.tarea;\n  memoria.ultima_accion = 'registrar_horas';\n  global[contextoKey] = memoria;\n}\n\nconsole.log('🎯 ACCIÓN FINAL:', accionFinal);\nconsole.log('📊 DATOS FINALES:', JSON.stringify(datosFinales, null, 2));\n\nreturn datosFinales;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4000,
        3344
      ],
      "id": "a3f82d38-ead5-4e6e-bb76-24b264956988",
      "name": "Router de Acciones FIXED"
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta del AI Agent - SIMPLIFICADO\n\nlet respuestaAgent;\n\ntry {\n  // Obtener la respuesta del AI Agent\n  const textoRespuesta = $json.output || $json.response || $json.text || $json.message || '';\n  \n  // Intentar extraer JSON de la respuesta\n  const jsonMatch = textoRespuesta.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                   textoRespuesta.match(/{[\\s\\S]*}/);\n  \n  if (jsonMatch) {\n    respuestaAgent = JSON.parse(jsonMatch[1] || jsonMatch[0]);\n  } else {\n    try {\n      respuestaAgent = JSON.parse(textoRespuesta);\n    } catch {\n      respuestaAgent = {\n        accion: \"conversar\",\n        respuesta_usuario: textoRespuesta || \"Lo siento, no entendí tu mensaje. ¿Podrías reformularlo?\"\n      };\n    }\n  }\n} catch (error) {\n  console.error('Error parseando respuesta del AI Agent:', error);\n  respuestaAgent = {\n    accion: \"conversar\",\n    respuesta_usuario: \"Hubo un error procesando tu solicitud. ¿Podrías intentar de nuevo?\"\n  };\n}\n\n// OBTENER DATOS DEL USUARIO DESDE EL NODO ANTERIOR (PREPARAR DATOS AI AGENT)\n// El AI Agent solo devuelve su respuesta JSON, los datos del usuario están en el nodo anterior\nconst datosUsuario = $('Preparar Datos AI Agent').first().json;\n\nconst chatId = datosUsuario.chat_id || 'unknown';\nconst userId = datosUsuario.user_id || 'unknown';\nconst userName = datosUsuario.user_name || 'Usuario';\nconst mensajeUsuario = datosUsuario.mensaje_usuario || 'mensaje no disponible';\nconst uid = datosUsuario.uid || 'unknown';\n// PERFIL desde \"Preparar Datos AI Agent\"\nconst perfil = $('Preparar Datos AI Agent').first().json?.cliente_perfil || null;\n\nconsole.log('🔍 PROCESAR RESPUESTA - Datos recibidos:');\nconsole.log('   chat_id:', chatId);\nconsole.log('   user_name:', userName);\nconsole.log('   mensaje_usuario:', mensajeUsuario);\nconsole.log('   uid:', uid);\nconsole.log('📋 Datos del usuario completos:', JSON.stringify(datosUsuario, null, 2));\nconsole.log('🤖 Respuesta del AI Agent:', JSON.stringify(respuestaAgent, null, 2));\n\n// Actualizar memoria según la acción\nif (chatId !== 'unknown') {\n  const contextoKey = `memoria_${chatId}`;\n  let memoriaActualizada = global[contextoKey] || {};\n\n  if (respuestaAgent.accion === 'crear_tarea') {\n    memoriaActualizada = {\n      ...memoriaActualizada,\n      esperando_confirmacion: 'crear_tarea',\n      datos_pendientes: {\n        proyecto: respuestaAgent.proyecto,\n        tarea: respuestaAgent.tarea,\n        accion_original: 'crear_tarea_simple'\n      }\n    };\n    global[contextoKey] = memoriaActualizada;\n  } else if (respuestaAgent.accion === 'registrar_horas') {\n    memoriaActualizada = {\n      ...memoriaActualizada,\n      proyecto_anterior: respuestaAgent.proyecto,\n      tarea_anterior: respuestaAgent.tarea,\n      ultima_accion: 'registrar_horas'\n    };\n    global[contextoKey] = memoriaActualizada;\n  }\n}\n\nconst odooUser = datosUsuario.odoo_user || perfil?.email || null;\n\nreturn [{\n  ...respuestaAgent,\n  chat_id: chatId,\n  user_id: userId,\n  user_name: userName,\n  uid: uid,\n  mensaje_original: mensajeUsuario,\n  cliente_perfil: perfil,\n  odoo_user: odooUser,                      // 👈 login/email del usuario de Odoo\n  odoo_user_id: perfil?.user_id ?? null,    // 👈 opcional: id de res.users si lo tienes en el perfil\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4304,
        3344
      ],
      "id": "a03cf0e6-b49a-42aa-99fa-0c34055b6976",
      "name": "Procesar Respuesta"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS PARA AI AGENT CON MEMORIA + PERFIL CLIENTE (ventas)\n\n// Helper seguro para leer JSON de otro nodo (soporta .first() y .item)\nfunction getNodeJson(name) {\n  try {\n    const h = $(name);\n    if (typeof h.first === 'function') {\n      const f = h.first();\n      if (f && f.json) return f.json;\n    }\n    return h.item.json;\n  } catch {\n    return {};\n  }\n}\n\n// 🔤 NUEVO: helper para normalizar texto (quita tildes, minúsculas, trim)\nfunction normalizeText(raw) {\n  if (raw === undefined || raw === null) return '';\n  return String(raw)\n    .normalize('NFD')                  // separa letra + tilde\n    .replace(/[\\u0300-\\u036f]/g, '')   // elimina marcas diacríticas\n    .replace(/´/g, '')                 // elimina acentos sueltos\n    .toLowerCase()                     // minúsculas\n    .trim();\n}\n\n// 1) Datos del usuario (texto/audio) y autenticación\nconst datosUsuario = getNodeJson('Obtener Chat ID');\n\n// 🔤 NUEVO: decidir mensaje original y normalizado\n// - Si viene de audio, usamos transcripcion_original.\n// - Si es texto escrito, usamos mensaje_usuario.\nconst mensajeOriginal =\n  datosUsuario.transcripcion_original ||\n  datosUsuario.mensaje_usuario ||\n  '';\n\nconst mensajeNormalizado = normalizeText(mensajeOriginal);\n\nconsole.log('✅ CAMINO CONFIRMACIÓN - Obteniendo memoria PostgreSQL...');\nconsole.log('📝 Mensaje original:', mensajeOriginal);\nconsole.log('🔤 Mensaje normalizado:', mensajeNormalizado);\n\n// 2) Memoria desde PostgreSQL (si existe)\nlet memoriaUsuario = {\n  esperando_confirmacion: null,\n  ultimo_mensaje_bot: null,\n  datos_pendientes: null,\n};\n\ntry {\n  const registro = getNodeJson('Consultar Memoria PostgreSQL');\n  if (registro && (registro.esperando_confirmacion !== undefined || registro.ultimo_mensaje_bot !== undefined)) {\n    memoriaUsuario = {\n      esperando_confirmacion: registro.esperando_confirmacion ?? null,\n      ultimo_mensaje_bot:     registro.ultimo_mensaje_bot     ?? null,\n      datos_pendientes:       registro.datos_pendientes\n        ? (typeof registro.datos_pendientes === 'string'\n            ? JSON.parse(registro.datos_pendientes)\n            : registro.datos_pendientes)\n        : null,\n    };\n    console.log('✅ Memoria PostgreSQL encontrada:', memoriaUsuario);\n  } else {\n    console.log('📭 No se encontró memoria previa para este usuario');\n  }\n} catch (error) {\n  console.log('⚠️ Error obteniendo memoria PostgreSQL:', error.message);\n}\n\n// 3) Perfil del usuario para ventas (desde Postgres: Cargar Perfil Usuario (ventas))\nlet perfil = {};\ntry {\n  perfil = getNodeJson('Cargar Perfil Usuario') || {};\n  console.log('👤 Perfil cargado:', perfil);\n} catch (e) {\n  perfil = {};\n}\n\nconst odoo_user = (perfil.odoo_user ?? perfil.user_mail ?? datosUsuario.odoo_user ?? null);\n\nconst cliente_perfil = {\n  name:        (perfil.user_name        || '').trim(),\n  email:       (perfil.user_mail        || '').trim(),\n  street:      (perfil.direccion_calle  || '').trim(),\n  zip:         (perfil.codigo_postal    || '').trim(),\n  city:        (perfil.poblacion        || '').trim(),\n  state_name:  (perfil.provincia        || '').trim(),\n  country_name:(perfil.pais             || '').trim(),\n  // opcional: ids crudos por si luego los necesitas\n  user_id:     perfil.user_id ?? null,\n  chat_id:     perfil.chat_id ?? null,\n};\n\n// 4) Construir el payload final para el agente\nconst datosCompletos = {\n  // Datos del usuario\n  mensaje_usuario:         mensajeNormalizado,     // 🔤 lo que ve el AGENTE (sin tildes)\n  mensaje_usuario_original: mensajeOriginal,       // 🧾 versión tal cual la escribió/dijo el usuario\n\n  chat_id:                datosUsuario.chat_id,\n  user_id:                datosUsuario.user_id,\n  odoo_user,\n  user_name:              datosUsuario.user_name,\n  es_audio:               datosUsuario.es_audio || false,\n  timestamp:              datosUsuario.timestamp || new Date().toISOString(),\n\n  // Odoo auth\n  uid:                    datosUsuario.uid,\n\n  // Memoria actual\n  esperando_confirmacion: memoriaUsuario.esperando_confirmacion,\n  ultimo_mensaje_bot:     memoriaUsuario.ultimo_mensaje_bot,\n  datos_pendientes:       memoriaUsuario.datos_pendientes,\n\n  // Extras\n  file_id:                datosUsuario.file_id,\n  transcripcion_original: datosUsuario.transcripcion_original,\n  audio_transcrito:       datosUsuario.audio_transcrito,\n\n  // 💡 PERFIL PARA VENTAS\n  cliente_perfil,\n};\n\nconsole.log('📤 ENVIANDO AL AI AGENT CON MEMORIA + PERFIL');\nconsole.log('🎯 Datos:', {\n  mensaje_usuario: datosCompletos.mensaje_usuario,\n  mensaje_usuario_original: datosCompletos.mensaje_usuario_original,\n  user_name: datosCompletos.user_name,\n  chat_id: datosCompletos.chat_id,\n  odoo_user: datosCompletos.odoo_user,\n  tiene_memoria: !!datosCompletos.esperando_confirmacion,\n  tiene_perfil: !!cliente_perfil.name || !!cliente_perfil.email\n});\n\n// ✅ Devolver como ARRAY (un único item)\nreturn [ datosCompletos ];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4848,
        3424
      ],
      "id": "3505da91-8f0d-4816-8cfd-91372d39f24a",
      "name": "Preparar Datos AI Agent"
    },
    {
      "parameters": {
        "jsCode": "// Manejar acción no contemplada\nconst datos = $json;\nconst accion = datos.accion || 'accion_desconocida';\nconst mensajeUsuario = datos.mensaje_usuario || datos.mensaje_original || 'mensaje no disponible';\nconst chatId = Number(datos.chat_id);\n\n// Mensaje\nconst mensajeRespuesta = `Acción no contemplada. Prueba con:\n\n• 📋 Registrar partes de horas\n• 🏗️ Crear proyecto\n• ✅ Crear tarea\n• 🛍️ Consultar producto\n• 💰 Consultar ventas\n• 🛒 Consultar compras\n• 🧾 Consultar facturas\n• 🔴 Consultar pagos pendientes\n• 🏆 Consultar top rankings\n• 👔 Consultar ranking comerciales\n• 📊 Consultar ventas perdidas\n• 🔍 Consultar ventas por orden\n• 👤 Consultar contacto\n• 🆕 Crear contacto\n• ✏️ Modificar contacto\n• 🛒 Crear pedidos de venta\n• 📅 Crear eventos en calendario\n• ⏰ Consultar horas de proyecto\n• ⏰ Consultar horas de tarea\n• ⏰ Consultar actividad temporal por usuario\n• 🏖️ Consultar ausencias\n• 📅 Consultar eventos de usuario\n• 🌐 Consultar visitantes web\n• 🏖️ Registrar ausencias\n• 💰 Registrar gastos\n• 🎤 Transcribir audios\n\n¿En qué puedo ayudarte?`;\n\nreturn {\n  chat_id: chatId,\n  texto: mensajeRespuesta,\n  accion_no_contemplada: accion,\n  mensaje_original: mensajeUsuario,\n  es_fallback: true,          // <- FLAG para no contar\n  tipo_mensaje: 'fallback'    // opcional\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1552,
        4560
      ],
      "id": "50a0507b-7f0c-43aa-a6f3-0f3c8c4d98b5",
      "name": "Acción No Contemplada"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        4560
      ],
      "id": "46f561ca-82d0-4b24-bb0a-9c30045b7021",
      "name": "Enviar Respuesta Acción No Contemplada",
      "webhookId": "4486ac15-ad73-48cf-8494-2a00f1ff07a8"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=🤖 Hola {{ $json.user_name || 'Usuario' }}, soy **AzerionBot**, tu asistente de Odoo.\n\nPara ver los datos reales puedes acceder a una base de datos de odoo en https://lsanchezgoshawk-azorn8n.odoo.com/odoo\ncon user: azordata y contraseña :1234\n\n **Tengo la capacidad de:**\n• 📋 Registrar partes de horas\n• 🏗️ Crear proyecto\n• ✅ Crear tarea\n• 🛍️ Consultar producto\n• 💰 Consultar ventas\n• 🛒 Consultar compras\n• 🧾 Consultar facturas\n• 🔴 Consultar pagos pendientes\n• 🏆 Consultar top rankings\n• 👔 Consultar ranking comerciales\n• 📊 Consultar ventas perdidas\n• 🔍 Consultar ventas por orden\n• 👤 Consultar contacto\n• 🆕 Crear contacto\n• ✏️ Modificar contacto\n• 🛒 Crear pedidos de venta\n• 📅 Crear eventos en calendario\n• ⏰ Consultar horas de proyecto\n• ⏰ Consultar horas de tarea\n• ⏰ Consultar actividad temporal por usuario\n• 🏖️ Consultar ausencias\n• 📅 Consultar eventos de usuario\n• 🌐 Consultar visitantes web\n• 🏖️ Registrar ausencias\n• 💰 Registrar gastos\n• 🎤 Transcribir audios\n\n📱 Y además me tienes también en **WhatsApp**\n\n❓ **¿En qué puedo ayudarte?**",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1520,
        4160
      ],
      "id": "b8553adc-b1fd-4b87-8856-599e07ff0936",
      "name": "Enviar Mensaje Bienvenida",
      "webhookId": "bienvenida-webhook-12345"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de ventas por orden específica\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst numeroOrden = datosAI.numero_orden;\n\nconsole.log('🔍 CONSULTAR VENTAS POR ORDEN ESPECÍFICA:');\nconsole.log('📋 Número de orden:', numeroOrden);\nconsole.log('🔑 UID:', uid);\n\n// Validar que tenemos el número de orden\nif (!numeroOrden) {\n  throw new Error('No se proporcionó número de orden para la consulta');\n}\n\n// Preparar consulta para buscar la orden por número\nconst consultaOrden = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"sale.order\",\n      \"search_read\",\n      [[[\"name\", \"=\", numeroOrden]]],\n      { \n        fields: [\n          \"id\", \"name\", \"partner_id\", \"date_order\", \"amount_total\", \n          \"state\", \"amount_untaxed\", \"amount_tax\", \"order_line\"\n        ]\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🚀 CONSULTA PREPARADA:');\nconsole.log('   📋 Número de orden a buscar:', numeroOrden);\nconsole.log('   🔑 UID usado:', uid);\nconsole.log('   📝 Consulta completa:', JSON.stringify(consultaOrden, null, 2));\n\nreturn {\n  payload: consultaOrden,\n  numero_orden: numeroOrden,\n  chat_id: datosAI.chat_id,\n  uid: uid,\n  tipo_consulta: 'orden_especifica'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1584,
        4912
      ],
      "id": "19a786c4-048c-466c-8051-3be70ddee228",
      "name": "Preparar Consulta Ventas por Orden"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1280,
        4912
      ],
      "id": "8120ebf4-be9a-4d2a-834d-8a74523c5a50",
      "name": "HTTP Consulta Ventas por Orden"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de ventas por orden específica CON LÍNEAS DETALLADAS\nconst respuestaOdoo = $json.result;\nconst datosConsulta = $('Preparar Consulta Ventas por Orden').item.json;\nlet texto = '';\n\nconsole.log('📊 FORMATEAR RESPUESTA VENTAS POR ORDEN:');\nconsole.log('📋 Datos consulta:', datosConsulta);\nconsole.log('🔍 Respuesta Odoo:', JSON.stringify(respuestaOdoo, null, 2));\n\nif (!Array.isArray(respuestaOdoo) || respuestaOdoo.length === 0) {\n  texto = `❌ No se encontró ninguna orden con el número **${datosConsulta.numero_orden}**.\n\nVerifica que el número de orden sea correcto.`;\n} else {\n  const orden = respuestaOdoo[0];\n  const partner = orden.partner_id ? orden.partner_id[1] : 'Cliente no especificado';\n  const fecha = orden.date_order ? new Date(orden.date_order).toLocaleDateString('es-ES') : 'Fecha no disponible';\n  const estado = orden.state || 'Estado no disponible';\n  \n  texto = `✅ **Orden encontrada:**\\n\\n`;\n  texto += `📋 **Número de orden:** ${orden.name}\\n`;\n  texto += `👤 **Cliente:** ${partner}\\n`;\n  texto += `📅 **Fecha:** ${fecha}\\n`;\n  texto += `💰 **Total:** ${orden.amount_total?.toFixed(2) || '0.00'} €\\n`;\n  texto += `📊 **Estado:** ${estado}\\n`;\n  \n  if (orden.amount_untaxed) {\n    texto += `💵 **Subtotal:** ${orden.amount_untaxed.toFixed(2)} €\\n`;\n  }\n  if (orden.amount_tax) {\n    texto += `🏛️ **Impuestos:** ${orden.amount_tax.toFixed(2)} €\\n`;\n  }\n  \n  // INFORMACIÓN DE PRODUCTOS VENDIDOS\n  if (orden.order_line && Array.isArray(orden.order_line) && orden.order_line.length > 0) {\n    texto += `\\n🛍️ **PRODUCTOS VENDIDOS:**\\n\\n`;\n    \n    // Preparar payload para obtener detalles de las líneas\n    const lineasIds = orden.order_line;\n    \n    // Retornar datos para continuar con consulta de líneas\n    return {\n      paso: 'consultar_lineas',\n      orden_info: {\n        texto_basico: texto,\n        orden_id: orden.id,\n        lineas_ids: lineasIds\n      },\n      chat_id: datosConsulta.chat_id,\n      numero_orden: datosConsulta.numero_orden,\n      uid: datosConsulta.uid\n    };\n  } else {\n    texto += `\\n❓ **Esta orden no tiene líneas de productos registradas.**`;\n  }\n}\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id,\n  numero_orden: datosConsulta.numero_orden\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        4912
      ],
      "id": "6f91fc29-39ca-4f64-adcd-9c4efa7d8b39",
      "name": "Formatear Respuesta Ventas por Orden"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "verificar-paso-lineas",
              "leftValue": "={{ $json.paso }}",
              "rightValue": "consultar_lineas",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -880,
        4912
      ],
      "id": "46bb8c1a-d3b9-460d-ae31-3bb0616dbcc4",
      "name": "¿Consultar Líneas?"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta para obtener líneas de productos detalladas\nconst ordenInfo = $json.orden_info;\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconsole.log('📦 PREPARAR CONSULTA LÍNEAS ORDEN:');\nconsole.log('   - IDs líneas:', ordenInfo.lineas_ids);\nconsole.log('   - UID:', uid);\n\n// Crear payload para consultar sale.order.line\nconst consultaLineas = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"sale.order.line\",\n      \"search_read\",\n      [[\n        [\"id\", \"in\", ordenInfo.lineas_ids]\n      ]],\n      { \n        fields: [\n          \"id\", \"product_id\", \"name\", \"product_uom_qty\", \n          \"price_unit\", \"price_total\", \"product_uom\"\n        ]\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Payload líneas orden:', JSON.stringify(consultaLineas, null, 2));\n\nreturn {\n  payload: consultaLineas,\n  orden_info: ordenInfo,\n  chat_id: $json.chat_id,\n  numero_orden: $json.numero_orden\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -672,
        4720
      ],
      "id": "59965b16-fbbe-42de-a781-fa298eb4fcf4",
      "name": "Preparar Consulta Líneas Orden"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -480,
        4720
      ],
      "id": "2b520024-162e-4005-8c51-da6f587ffdb7",
      "name": "HTTP Consulta Líneas Orden"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta final con líneas de productos detalladas\nconst lineasResponse = $json.result;\nconst datosAnteriores = $('Preparar Consulta Líneas Orden').item.json;\nconst ordenInfo = datosAnteriores.orden_info;\n\nconsole.log('🎨 FORMATEAR RESPUESTA FINAL CON LÍNEAS:');\nconsole.log('   - Líneas obtenidas:', lineasResponse?.length || 0);\n\nlet texto = ordenInfo.texto_basico;\n\nif (Array.isArray(lineasResponse) && lineasResponse.length > 0) {\n  // Filtrar líneas válidas (con producto y cantidad)\n  const lineasValidas = lineasResponse.filter(linea => \n    linea.product_id && \n    linea.product_uom_qty > 0 &&\n    !linea.name?.includes('INV/') &&\n    linea.name?.length > 2\n  );\n  \n  console.log('   - Líneas válidas:', lineasValidas.length);\n  \n  if (lineasValidas.length > 0) {\n    lineasValidas.forEach((linea, idx) => {\n      const nombreProducto = linea.product_id?.[1] || linea.name || 'Producto sin nombre';\n      const cantidad = linea.product_uom_qty || 0;\n      const precioUnitario = linea.price_unit?.toFixed(2) || '0.00';\n      const precioTotal = linea.price_total?.toFixed(2) || '0.00';\n      const unidad = linea.product_uom?.[1] || 'uds';\n      \n      texto += `${idx + 1}. **${nombreProducto}**\\n`;\n      texto += `   📦 Cantidad: ${cantidad} ${unidad}\\n`;\n      texto += `   💰 Precio unitario: ${precioUnitario} €\\n`;\n      texto += `   💵 Precio total: ${precioTotal} €\\n\\n`;\n    });\n    \n    // Totales\n    const totalUnidades = lineasValidas.reduce((acc, l) => acc + (l.product_uom_qty || 0), 0);\n    const totalLineas = lineasValidas.reduce((acc, l) => acc + (l.price_total || 0), 0);\n    \n    texto += `📊 **RESUMEN:**\\n`;\n    texto += `🔢 Total unidades: ${totalUnidades}\\n`;\n    texto += `💰 Total líneas: ${totalLineas.toFixed(2)} €`;\n  } else {\n    texto += `❓ **No se encontraron líneas de productos válidas.**`;\n  }\n} else {\n  texto += `❌ **Error al obtener las líneas de productos.**`;\n}\n\nreturn {\n  texto,\n  chat_id: datosAnteriores.chat_id,\n  numero_orden: datosAnteriores.numero_orden\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -272,
        4720
      ],
      "id": "4a663542-4522-4aa8-afb2-a7b8bbe6fb04",
      "name": "Formatear Respuesta Final con Líneas"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -80,
        4720
      ],
      "id": "8748c229-d73f-4efa-b0d5-3bd40e007f93",
      "name": "Enviar Respuesta con Líneas",
      "webhookId": "respuesta-lineas-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -576,
        5072
      ],
      "id": "c68f680b-47c6-4316-ad37-968c86974f84",
      "name": "Enviar Respuesta Ventas por Orden",
      "webhookId": "ventas-por-orden-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// Procesar consulta de compras desde AI Agent\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst tipoConsulta = datosAI.tipo_consulta;\nconst parametro = datosAI.parametro;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nlet jsonRpcPayload;\n\n// COMPRAS DEL MES ACTUAL\nif (tipoConsulta === 'mes_actual') {\n  const now = new Date();\n  const year = now.getFullYear();\n  const month = now.getMonth() + 1;\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"purchase.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", primerDia],\n          [\"date_order\", \"<\", primerDiaSiguienteMes]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"state\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n} \n// COMPRAS DEL MES PASADO\nelse if (tipoConsulta === 'mes_pasado') {\n  const now = new Date();\n  let year = now.getFullYear();\n  let month = now.getMonth();\n  if (month === 0) {\n    month = 12;\n    year = year - 1;\n  }\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"purchase.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", primerDia],\n          [\"date_order\", \"<\", primerDiaSiguienteMes]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"state\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// COMPRAS POR PROVEEDOR\nelse if (tipoConsulta === 'proveedor_especifico') {\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"purchase.order\",\n        \"search_read\",\n        [[[\"partner_id\", \"ilike\", parametro]]],\n        { \"fields\": [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"state\"], \"limit\": 50 }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// COMPRAS POR MES ESPECÍFICO (nombre)\nelse if (tipoConsulta === 'mes_nombre') {\n  const meses = [\n    \"enero\", \"febrero\", \"marzo\", \"abril\", \"mayo\", \"junio\",\n    \"julio\", \"agosto\", \"septiembre\", \"octubre\", \"noviembre\", \"diciembre\"\n  ];\n  const mesIndex = meses.indexOf(parametro.toLowerCase());\n  if (mesIndex !== -1) {\n    const now = new Date();\n    let year = now.getFullYear();\n    if (mesIndex + 1 > (now.getMonth() + 1)) {\n      year = year - 1;\n    }\n    const mes = (mesIndex + 1) < 10 ? `0${mesIndex + 1}` : `${mesIndex + 1}`;\n    const primerDia = `${year}-${mes}-01`;\n    const siguienteMes = (mesIndex + 2) > 12 ? 1 : (mesIndex + 2);\n    const siguienteAnio = (mesIndex + 2) > 12 ? year + 1 : year;\n    const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n    const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n    jsonRpcPayload = {\n      jsonrpc: \"2.0\",\n      method: \"call\",\n      params: {\n        service: \"object\",\n        method: \"execute_kw\",\n        args: [\n          \"lsanchezgoshawk-n8npruebas-main-25736898\",\n          uid,\n          \"admin\",\n          \"purchase.order\",\n          \"search_read\",\n          [[\n            [\"date_order\", \">=\", primerDia],\n            [\"date_order\", \"<\", primerDiaSiguienteMes]\n          ]],\n          { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"state\"] }\n        ]\n      },\n      id: Math.floor(Math.random() * 1000000)\n    };\n  }\n}\n\n// COMPRAS DEL AÑO ACTUAL\nelse if (tipoConsulta === 'año_actual') {\n  const now = new Date();\n  const year = now.getFullYear();\n  const primerDia = `${year}-01-01`;\n  const primerDiaSiguienteAnio = `${year + 1}-01-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"purchase.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", primerDia],\n          [\"date_order\", \"<\", primerDiaSiguienteAnio]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\", \"state\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n\n// Al final, valida que haya payload\nif (!jsonRpcPayload) {\n  throw new Error(`Tipo de consulta no soportado: ${tipoConsulta}`);\n}\n\nreturn {\n  payload: jsonRpcPayload,\n  tipo_consulta: tipoConsulta,\n  parametro: parametro,\n  fecha_desde: datosAI.fecha_desde || null,\n  fecha_hasta: datosAI.fecha_hasta || null,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1600,
        5280
      ],
      "id": "d0483ea1-b21b-4c97-86e6-8457382a68c7",
      "name": "Preparar Consulta Compras"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1376,
        5280
      ],
      "id": "cc5ec729-b84b-452f-aef0-fd29e5ce587e",
      "name": "HTTP Consulta Compras"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de compras con productos para Telegram\nconst lineasCompra = $json.result || []; // Líneas de compra (productos)\nconst datosConsulta = $('Preparar Consulta Líneas Compras').item.json;\nconst ordenes = datosConsulta.ordenes || [];\n\nconsole.log('📄 DATOS FORMATEAR COMPRAS:');\nconsole.log('- Líneas compra:', Array.isArray(lineasCompra) ? lineasCompra.length : 'No es array');\nconsole.log('- Órdenes:', Array.isArray(ordenes) ? ordenes.length : 'No es array');\nconsole.log('- Chat ID:', datosConsulta.chat_id);\n\nlet texto = '';\n\n// Si no hay órdenes o el payload de líneas era null\nif (!Array.isArray(ordenes) || ordenes.length === 0 || datosConsulta.lineas_payload === null) {\n  const tipoConsulta = datosConsulta.tipo_consulta;\n  if (tipoConsulta === 'mes_actual') {\n    texto = '❌ No se encontraron compras en el mes actual.';\n  } else if (tipoConsulta === 'mes_pasado') {\n    texto = '❌ No se encontraron compras en el mes pasado.';\n  } else if (tipoConsulta === 'proveedor_especifico') {\n    texto = `❌ No se encontraron compras del proveedor \"${datosConsulta.parametro}\".`;\n  } else {\n    texto = '❌ No se encontraron compras con esos criterios.';\n  }\n} else {\n  const tipoConsulta = datosConsulta.tipo_consulta;\n  let total = 0;\n  \n  if (tipoConsulta === 'mes_actual') {\n    texto = `🛒 **Compras del mes actual:**\\n\\n`;\n  } else if (tipoConsulta === 'mes_pasado') {\n    texto = `🛒 **Compras del mes pasado:**\\n\\n`;\n  } else if (tipoConsulta === 'proveedor_especifico') {\n    texto = `🛒 **Compras del proveedor \"${datosConsulta.parametro}\":**\\n\\n`;\n  } else if (tipoConsulta === 'mes_nombre') {\n    texto = `🛒 **Compras de ${datosConsulta.parametro}:**\\n\\n`;\n  } else {\n    texto = `🛒 **Compras encontradas:**\\n\\n`;\n  }\n  \n  // Agrupar líneas por orden (solo si hay líneas de compra)\n  const lineasPorOrden = {};\n  if (Array.isArray(lineasCompra) && lineasCompra.length > 0) {\n    lineasCompra.forEach(linea => {\n      try {\n        const ordenId = linea.order_id && linea.order_id[0] ? linea.order_id[0] : null;\n        if (ordenId) {\n          if (!lineasPorOrden[ordenId]) {\n            lineasPorOrden[ordenId] = [];\n          }\n          lineasPorOrden[ordenId].push(linea);\n        }\n      } catch (error) {\n        console.log('❌ Error procesando línea:', linea);\n      }\n    });\n  }\n  \n  ordenes.forEach((compra, idx) => {\n    const fecha = new Date(compra.date_order).toLocaleDateString('es-ES');\n    const proveedor = compra.partner_id && compra.partner_id[1] ? compra.partner_id[1] : 'Proveedor desconocido';\n    const estado = compra.state === 'purchase' ? '✅ Confirmada' : \n                   compra.state === 'draft' ? '📝 Borrador' :\n                   compra.state === 'done' ? '✅ Finalizada' :\n                   compra.state === 'cancel' ? '❌ Cancelada' : compra.state;\n    \n    texto += `${idx + 1}. 📋 **${compra.name}**\\n`;\n    texto += `   🏢 Proveedor: ${proveedor}\\n`;\n    texto += `   💰 Total: ${compra.amount_total}€\\n`;\n    texto += `   📅 Fecha: ${fecha}\\n`;\n    texto += `   📊 Estado: ${estado}\\n`;\n    \n    // Añadir productos comprados en esta orden (solo si tenemos líneas)\n    const lineasDeEstaOrden = lineasPorOrden[compra.id] || [];\n    if (lineasDeEstaOrden.length > 0) {\n      texto += `   🛍️ **Productos:**\\n`;\n      lineasDeEstaOrden.forEach(linea => {\n        const nombreProducto = linea.product_id && linea.product_id[1] ? linea.product_id[1] : 'Producto desconocido';\n        const cantidad = linea.product_qty || 0;\n        const precioUnit = linea.price_unit || 0;\n        const precioTotal = linea.price_total || 0;\n        \n        texto += `      • ${nombreProducto}\\n`;\n        texto += `        Cantidad: ${cantidad} | Precio unit: ${precioUnit}€ | Subtotal: ${precioTotal}€\\n`;\n      });\n    } else if (Array.isArray(lineasCompra)) {\n      // Si no encontramos líneas específicas pero la consulta fue exitosa\n      texto += `   🛍️ **Productos:** Información de productos no disponible\\n`;\n    }\n    \n    texto += `\\n`;\n    \n    if (compra.state !== 'cancel') {\n      total += parseFloat(compra.amount_total || 0);\n    }\n  });\n  \n  texto += `**💰 TOTAL: ${total.toFixed(2)}€**\\n`;\n  texto += `📊 Total de órdenes: ${ordenes.length}`;\n}\n\nconsole.log('✅ Texto final generado:', texto.substring(0, 200) + '...');\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        5280
      ],
      "id": "08d42721-2d13-4419-9769-1b3cb79b65bf",
      "name": "Formatear Respuesta Compras"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta para obtener líneas de compra (productos)\nconst respuestaOrdenes = $json.result;\nconst datosConsulta = $('Preparar Consulta Compras').item.json;\n\nconsole.log('📊 RESPUESTA ÓRDENES:', JSON.stringify(respuestaOrdenes, null, 2));\n\nif (!Array.isArray(respuestaOrdenes) || respuestaOrdenes.length === 0) {\n  console.log('❌ No hay órdenes para consultar líneas');\n  // No hay órdenes, retornar datos para mostrar mensaje de \"no encontrado\"\n  return {\n    ordenes: [],\n    lineas_payload: null,\n    chat_id: datosConsulta.chat_id,\n    tipo_consulta: datosConsulta.tipo_consulta,\n    parametro: datosConsulta.parametro\n  };\n}\n\n// Extraer IDs de las órdenes de compra\nconst ordenIds = respuestaOrdenes\n  .map(orden => orden.id)\n  .filter(id => id && typeof id === 'number'); // Filtrar IDs válidos\n\nconsole.log('📋 IDs de órdenes extraídos:', ordenIds);\n\nif (ordenIds.length === 0) {\n  console.log('❌ No se encontraron IDs válidos de órdenes');\n  return {\n    ordenes: respuestaOrdenes,\n    lineas_payload: null,\n    chat_id: datosConsulta.chat_id,\n    tipo_consulta: datosConsulta.tipo_consulta,\n    parametro: datosConsulta.parametro\n  };\n}\n\n// Preparar consulta para obtener todas las líneas de estas órdenes\n// Usar formato correcto del dominio: lista de listas de 3 elementos\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosConsulta.uid,\n      \"admin\",\n      \"purchase.order.line\",\n      \"search_read\",\n      [[[\"order_id\", \"in\", ordenIds]]], // Nota: doble array para formato correcto\n      { \n        fields: [\"order_id\", \"product_id\", \"product_qty\", \"price_total\", \"price_unit\", \"name\"],\n        limit: 1000\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Payload para líneas:', JSON.stringify(jsonRpcPayload, null, 2));\n\nreturn {\n  ordenes: respuestaOrdenes,\n  lineas_payload: jsonRpcPayload,\n  chat_id: datosConsulta.chat_id,\n  tipo_consulta: datosConsulta.tipo_consulta,\n  parametro: datosConsulta.parametro,\n  uid: datosConsulta.uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        5280
      ],
      "id": "0000cecf-e13c-4067-b868-e117e9c754f0",
      "name": "Preparar Consulta Líneas Compras"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.lineas_payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        5280
      ],
      "id": "038df02d-2552-4c7c-a289-aecc279a3b66",
      "name": "HTTP Consulta Líneas Compras"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -464,
        5280
      ],
      "id": "750ae18f-a72d-4255-97cb-e70cf57ff1e2",
      "name": "Enviar Respuesta Compras",
      "webhookId": "compras-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// Procesar consulta de facturas desde AI Agent\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst tipoConsulta = datosAI.tipo_consulta;\nconst parametro = datosAI.parametro;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nlet jsonRpcPayload;\n\n// FACTURAS DEL MES ACTUAL\nif (tipoConsulta === 'mes_actual') {\n  const now = new Date();\n  const year = now.getFullYear();\n  const month = now.getMonth() + 1;\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"account.move\",\n        \"search_read\",\n        [[\n          [\"move_type\", \"=\", \"out_invoice\"],\n          [\"invoice_date\", \">=\", primerDia],\n          [\"invoice_date\", \"<\", primerDiaSiguienteMes],\n          [\"state\", \"in\", [\"posted\", \"payment\"]]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"invoice_date\", \"state\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n} \n// FACTURAS DEL MES PASADO\nelse if (tipoConsulta === 'mes_pasado') {\n  const now = new Date();\n  let year = now.getFullYear();\n  let month = now.getMonth();\n  if (month === 0) {\n    month = 12;\n    year = year - 1;\n  }\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"account.move\",\n        \"search_read\",\n        [[\n          [\"move_type\", \"=\", \"out_invoice\"],\n          [\"invoice_date\", \">=\", primerDia],\n          [\"invoice_date\", \"<\", primerDiaSiguienteMes],\n          [\"state\", \"in\", [\"posted\", \"payment\"]]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"invoice_date\", \"state\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// FACTURAS POR CLIENTE\nelse if (tipoConsulta === 'cliente_especifico') {\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"account.move\",\n        \"search_read\",\n        [[\n          [\"move_type\", \"=\", \"out_invoice\"],\n          [\"partner_id\", \"ilike\", parametro],\n          [\"state\", \"in\", [\"posted\", \"payment\"]]\n        ]],\n        { \"fields\": [\"name\", \"partner_id\", \"amount_total\", \"invoice_date\", \"state\"], \"limit\": 50 }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// FACTURAS POR MES ESPECÍFICO (nombre)\nelse if (tipoConsulta === 'mes_nombre') {\n  const meses = [\n    \"enero\", \"febrero\", \"marzo\", \"abril\", \"mayo\", \"junio\",\n    \"julio\", \"agosto\", \"septiembre\", \"octubre\", \"noviembre\", \"diciembre\"\n  ];\n  const mesIndex = meses.indexOf(parametro.toLowerCase());\n  if (mesIndex !== -1) {\n    const now = new Date();\n    let year = now.getFullYear();\n    if (mesIndex + 1 > (now.getMonth() + 1)) {\n      year = year - 1;\n    }\n    const mes = (mesIndex + 1) < 10 ? `0${mesIndex + 1}` : `${mesIndex + 1}`;\n    const primerDia = `${year}-${mes}-01`;\n    const siguienteMes = (mesIndex + 2) > 12 ? 1 : (mesIndex + 2);\n    const siguienteAnio = (mesIndex + 2) > 12 ? year + 1 : year;\n    const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n    const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n    jsonRpcPayload = {\n      jsonrpc: \"2.0\",\n      method: \"call\",\n      params: {\n        service: \"object\",\n        method: \"execute_kw\",\n        args: [\n          \"lsanchezgoshawk-n8npruebas-main-25736898\",\n          uid,\n          \"admin\",\n          \"account.move\",\n          \"search_read\",\n          [[\n            [\"move_type\", \"=\", \"out_invoice\"],\n            [\"invoice_date\", \">=\", primerDia],\n            [\"invoice_date\", \"<\", primerDiaSiguienteMes],\n            [\"state\", \"in\", [\"posted\", \"payment\"]]\n          ]],\n          { fields: [\"name\", \"partner_id\", \"amount_total\", \"invoice_date\", \"state\"] }\n        ]\n      },\n      id: Math.floor(Math.random() * 1000000)\n    };\n  }\n}\n\nreturn {\n  payload: jsonRpcPayload,\n  tipo_consulta: tipoConsulta,\n  parametro: parametro,\n  fecha_desde: datosAI.fecha_desde || null,\n  fecha_hasta: datosAI.fecha_hasta || null,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1616,
        5680
      ],
      "id": "7ffff99c-3403-4a07-9f08-fa05b6e4570c",
      "name": "Preparar Consulta Facturas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1392,
        5680
      ],
      "id": "94a3b176-7009-4026-a649-6516b46ef280",
      "name": "HTTP Consulta Facturas"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de facturas con productos FILTRADOS para Telegram\nconst lineasFactura = $json.result || []; // Líneas de factura (productos)\nconst datosConsulta = $('Preparar Consulta Líneas Facturas').item.json;\nconst facturas = datosConsulta.facturas || [];\n\nconsole.log('📄 DATOS FORMATEAR FACTURAS:');\nconsole.log('- Líneas factura:', Array.isArray(lineasFactura) ? lineasFactura.length : 'No es array');\nconsole.log('- Facturas:', Array.isArray(facturas) ? facturas.length : 'No es array');\nconsole.log('- Chat ID:', datosConsulta.chat_id);\n\nlet texto = '';\n\n// Si no hay facturas o el payload de líneas era null\nif (!Array.isArray(facturas) || facturas.length === 0 || datosConsulta.lineas_payload === null) {\n  const tipoConsulta = datosConsulta.tipo_consulta;\n  if (tipoConsulta === 'mes_actual') {\n    texto = '❌ No se encontraron facturas en el mes actual.';\n  } else if (tipoConsulta === 'mes_pasado') {\n    texto = '❌ No se encontraron facturas en el mes pasado.';\n  } else if (tipoConsulta === 'cliente_especifico') {\n    texto = `❌ No se encontraron facturas del cliente \"${datosConsulta.parametro}\".`;\n  } else {\n    texto = '❌ No se encontraron facturas con esos criterios.';\n  }\n} else {\n  const tipoConsulta = datosConsulta.tipo_consulta;\n  let total = 0;\n  \n  if (tipoConsulta === 'mes_actual') {\n    texto = `🧾 **Facturas del mes actual:**\\n\\n`;\n  } else if (tipoConsulta === 'mes_pasado') {\n    texto = `🧾 **Facturas del mes pasado:**\\n\\n`;\n  } else if (tipoConsulta === 'cliente_especifico') {\n    texto = `🧾 **Facturas del cliente \"${datosConsulta.parametro}\":**\\n\\n`;\n  } else if (tipoConsulta === 'mes_nombre') {\n    texto = `🧾 **Facturas de ${datosConsulta.parametro}:**\\n\\n`;\n  } else {\n    texto = `🧾 **Facturas encontradas:**\\n\\n`;\n  }\n  \n  // Agrupar líneas por factura (solo si hay líneas de factura)\n  const lineasPorFactura = {};\n  if (Array.isArray(lineasFactura) && lineasFactura.length > 0) {\n    lineasFactura.forEach(linea => {\n      try {\n        const facturaId = linea.move_id && linea.move_id[0] ? linea.move_id[0] : null;\n        if (facturaId) {\n          if (!lineasPorFactura[facturaId]) {\n            lineasPorFactura[facturaId] = [];\n          }\n          lineasPorFactura[facturaId].push(linea);\n        }\n      } catch (error) {\n        console.log('❌ Error procesando línea factura:', linea);\n      }\n    });\n  }\n  \n  facturas.forEach((factura, idx) => {\n    const fecha = new Date(factura.invoice_date).toLocaleDateString('es-ES');\n    const cliente = factura.partner_id && factura.partner_id[1] ? factura.partner_id[1] : 'Cliente desconocido';\n    const estado = factura.state === 'posted' ? '✅ Contabilizada' : \n                   factura.state === 'payment' ? '💰 Pagada' :\n                   factura.state === 'draft' ? '📝 Borrador' :\n                   factura.state === 'cancel' ? '❌ Cancelada' : factura.state;\n    \n    texto += `${idx + 1}. 🧾 **${factura.name}**\\n`;\n    texto += `   👤 Cliente: ${cliente}\\n`;\n    texto += `   💰 Total: ${factura.amount_total}€\\n`;\n    texto += `   📅 Fecha: ${fecha}\\n`;\n    texto += `   📊 Estado: ${estado}\\n`;\n    \n    // Añadir productos/servicios facturados en esta factura (FILTRADOS)\n    const lineasDeEstaFactura = lineasPorFactura[factura.id] || [];\n    if (lineasDeEstaFactura.length > 0) {\n      // FILTRAR líneas válidas: que tengan producto real y cantidad/precio válidos\n      const lineasValidas = lineasDeEstaFactura.filter(linea => {\n        const cantidad = parseFloat(linea.quantity || 0);\n        const precioUnit = parseFloat(linea.price_unit || 0);\n        const precioTotal = parseFloat(linea.price_total || 0);\n        const nombreProducto = linea.product_id && linea.product_id[1] ? linea.product_id[1] : (linea.name || '');\n        \n        // Filtrar líneas que:\n        // 1. Tengan cantidad mayor a 0 O precio total diferente de 0\n        // 2. No sean el número de factura como nombre\n        // 3. No sean solo porcentajes (como \"15%\")\n        // 4. Tengan un nombre de producto válido\n        // 5. No sean líneas de impuestos o descuentos automáticos\n        const esLineaValida = (cantidad > 0 || Math.abs(precioTotal) > 0.01) && \n                             nombreProducto && \n                             nombreProducto.length > 2 &&\n                             !nombreProducto.includes('INV/') &&\n                             !nombreProducto.match(/^\\d+%$/) &&\n                             nombreProducto !== factura.name &&\n                             !nombreProducto.match(/^\\d+\\.?\\d*%?$/);\n        \n        console.log(`🔍 Línea \"${nombreProducto}\": cantidad=${cantidad}, precio=${precioTotal}, válida=${esLineaValida}`);\n        return esLineaValida;\n      });\n      \n      if (lineasValidas.length > 0) {\n        texto += `   🛍️ **Productos/Servicios facturados:**\\n`;\n        lineasValidas.forEach(linea => {\n          const nombreProducto = linea.product_id && linea.product_id[1] ? linea.product_id[1] : (linea.name || 'Producto/Servicio');\n          const cantidad = parseFloat(linea.quantity || 0);\n          const precioUnit = parseFloat(linea.price_unit || 0);\n          const precioTotal = parseFloat(linea.price_total || 0);\n          \n          texto += `      • ${nombreProducto}\\n`;\n          texto += `        Cantidad: ${cantidad} | Precio unit: ${precioUnit}€ | Subtotal: ${precioTotal}€\\n`;\n        });\n      } else {\n        texto += `   🛍️ **Productos/Servicios:** (Sin líneas de producto válidas)\\n`;\n      }\n    } else if (Array.isArray(lineasFactura)) {\n      // Si no encontramos líneas específicas pero la consulta fue exitosa\n      texto += `   🛍️ **Productos/Servicios:** Información de líneas no disponible\\n`;\n    }\n    \n    texto += `\\n`;\n    \n    if (factura.state !== 'cancel') {\n      total += parseFloat(factura.amount_total || 0);\n    }\n  });\n  \n  texto += `**💰 TOTAL: ${total.toFixed(2)}€**\\n`;\n  texto += `📊 Total de facturas: ${facturas.length}`;\n}\n\nconsole.log('✅ Texto final facturas generado:', texto.substring(0, 200) + '...');\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        5680
      ],
      "id": "b653873a-14bb-415f-809f-3324a36bd2fd",
      "name": "Formatear Respuesta Facturas"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -432,
        5680
      ],
      "id": "94aafc63-3d8f-4503-9276-e473fa322fb0",
      "name": "Enviar Respuesta Facturas",
      "webhookId": "facturas-webhook-001"
    },
    {
      "parameters": {
        "content": "## Mensaje bienvenida"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3424,
        4000
      ],
      "typeVersion": 1,
      "id": "48eb66fa-ef07-4ab5-990e-d3adc00105a5",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "content": "## Mensaje Fallback"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3424,
        4400
      ],
      "typeVersion": 1,
      "id": "673889be-de28-43a7-ba17-e4351705a068",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "content": "## Mensaje ventas"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3456,
        4752
      ],
      "typeVersion": 1,
      "id": "0856d69b-e16a-4c15-bf5b-826da0364dac",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "content": "## Mensaje compras"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3472,
        5120
      ],
      "typeVersion": 1,
      "id": "4cdfe537-93fb-4a22-ad47-5d514b9dd819",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "content": "## Mensaje facturas"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3488,
        5520
      ],
      "typeVersion": 1,
      "id": "5fa0458b-8eae-4795-afae-a5870ab6baeb",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta para obtener líneas de factura (productos)\nconst respuestaFacturas = $json.result;\nconst datosConsulta = $('Preparar Consulta Facturas').item.json;\n\nconsole.log('📊 RESPUESTA FACTURAS:', JSON.stringify(respuestaFacturas, null, 2));\n\nif (!Array.isArray(respuestaFacturas) || respuestaFacturas.length === 0) {\n  console.log('❌ No hay facturas para consultar líneas');\n  // No hay facturas, retornar datos para mostrar mensaje de \"no encontrado\"\n  return {\n    facturas: [],\n    lineas_payload: null,\n    chat_id: datosConsulta.chat_id,\n    tipo_consulta: datosConsulta.tipo_consulta,\n    parametro: datosConsulta.parametro\n  };\n}\n\n// Extraer IDs de las facturas\nconst facturaIds = respuestaFacturas\n  .map(factura => factura.id)\n  .filter(id => id && typeof id === 'number'); // Filtrar IDs válidos\n\nconsole.log('📋 IDs de facturas extraídos:', facturaIds);\n\nif (facturaIds.length === 0) {\n  console.log('❌ No se encontraron IDs válidos de facturas');\n  return {\n    facturas: respuestaFacturas,\n    lineas_payload: null,\n    chat_id: datosConsulta.chat_id,\n    tipo_consulta: datosConsulta.tipo_consulta,\n    parametro: datosConsulta.parametro\n  };\n}\n\n// Preparar consulta para obtener todas las líneas de estas facturas\n// Usar formato correcto del dominio: lista de listas de 3 elementos\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosConsulta.uid,\n      \"admin\",\n      \"account.move.line\",\n      \"search_read\",\n      [[\n        [\"move_id\", \"in\", facturaIds],\n        [\"display_type\", \"not in\", [\"line_section\", \"line_note\"]]\n      ]], // Nota: formato correcto del dominio\n      { \n        fields: [\"move_id\", \"product_id\", \"quantity\", \"price_total\", \"price_unit\", \"name\"],\n        limit: 1000\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Payload para líneas facturas:', JSON.stringify(jsonRpcPayload, null, 2));\n\nreturn {\n  facturas: respuestaFacturas,\n  lineas_payload: jsonRpcPayload,\n  chat_id: datosConsulta.chat_id,\n  tipo_consulta: datosConsulta.tipo_consulta,\n  parametro: datosConsulta.parametro,\n  uid: datosConsulta.uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1200,
        5680
      ],
      "id": "71414623-c791-4bbc-b316-b27ea6e764b1",
      "name": "Preparar Consulta Líneas Facturas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.lineas_payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -976,
        5680
      ],
      "id": "1ce63164-188b-4500-a539-ba6cdaf74cf9",
      "name": "HTTP Consulta Líneas Facturas"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta para obtener facturas con pagos pendientes\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst tipoConsulta = datosAI.tipo_consulta;\nconst parametro = datosAI.parametro;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nlet jsonRpcPayload;\n\n// PAGOS PENDIENTES GENERALES\nif (tipoConsulta === 'general') {\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"account.move\",\n        \"search_read\",\n        [[\n          [\"move_type\", \"=\", \"out_invoice\"],\n          [\"state\", \"=\", \"posted\"],\n          [\"amount_residual\", \">\", 0]\n        ]],\n        { \n          fields: [\"name\", \"partner_id\", \"amount_total\", \"amount_residual\", \"invoice_date\", \"invoice_date_due\", \"state\"],\n          limit: 50,\n          order: \"invoice_date_due asc\"\n        }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n} \n// PAGOS PENDIENTES DE CLIENTE ESPECÍFICO\nelse if (tipoConsulta === 'cliente_especifico') {\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"account.move\",\n        \"search_read\",\n        [[\n          [\"move_type\", \"=\", \"out_invoice\"],\n          [\"state\", \"=\", \"posted\"],\n          [\"amount_residual\", \">\", 0],\n          [\"partner_id\", \"ilike\", parametro]\n        ]],\n        { \n          fields: [\"name\", \"partner_id\", \"amount_total\", \"amount_residual\", \"invoice_date\", \"invoice_date_due\", \"state\"],\n          limit: 50,\n          order: \"invoice_date_due asc\"\n        }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n} \n// TOTAL PENDIENTE\nelse if (tipoConsulta === 'total_pendiente') {\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"account.move\",\n        \"search_read\",\n        [[\n          [\"move_type\", \"=\", \"out_invoice\"],\n          [\"state\", \"=\", \"posted\"],\n          [\"amount_residual\", \">\", 0]\n        ]],\n        { \n          fields: [\"name\", \"partner_id\", \"amount_total\", \"amount_residual\", \"invoice_date\", \"invoice_date_due\", \"state\"]\n        }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n\nconsole.log('🔍 Payload pagos pendientes:', JSON.stringify(jsonRpcPayload, null, 2));\n\nreturn {\n  payload: jsonRpcPayload,\n  tipo_consulta: tipoConsulta,\n  parametro: parametro,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1664,
        6160
      ],
      "id": "ce191f37-1fdc-4abf-9674-ceda546ff7ff",
      "name": "Preparar Consulta Pagos Pendientes"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1424,
        6160
      ],
      "id": "947ae70c-ceff-491b-8a44-ed9f03261068",
      "name": "HTTP Consulta Pagos Pendientes"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de pagos pendientes para Telegram\nconst respuestaOdoo = $json.result;\nconst datosConsulta = $('Preparar Consulta Pagos Pendientes').item.json;\nlet texto = '';\n\nconsole.log('💳 DATOS FORMATEAR PAGOS PENDIENTES:');\nconsole.log('- Facturas pendientes:', Array.isArray(respuestaOdoo) ? respuestaOdoo.length : 'No es array');\nconsole.log('- Tipo consulta:', datosConsulta.tipo_consulta);\n\nif (!Array.isArray(respuestaOdoo) || respuestaOdoo.length === 0) {\n  const tipoConsulta = datosConsulta.tipo_consulta;\n  if (tipoConsulta === 'cliente_especifico') {\n    texto = `✅ El cliente \"${datosConsulta.parametro}\" no tiene facturas pendientes de pago.`;\n  } else {\n    texto = '✅ ¡Excelente! No hay facturas pendientes de pago.';\n  }\n} else {\n  const tipoConsulta = datosConsulta.tipo_consulta;\n  let totalPendiente = 0;\n  let facturasPendientes = 0;\n  let facturasVencidas = 0;\n  \n  if (tipoConsulta === 'total_pendiente') {\n    texto = `💰 **RESUMEN DE PAGOS PENDIENTES:**\\n\\n`;\n  } else if (tipoConsulta === 'cliente_especifico') {\n    texto = `💳 **Pagos pendientes del cliente \"${datosConsulta.parametro}\":**\\n\\n`;\n  } else {\n    texto = `🔴 **FACTURAS PENDIENTES DE COBRO:**\\n\\n`;\n  }\n  \n  const hoy = new Date();\n  \n  respuestaOdoo.forEach((factura, idx) => {\n    const fechaVencimiento = new Date(factura.invoice_date_due);\n    const fechaFactura = new Date(factura.invoice_date).toLocaleDateString('es-ES');\n    const fechaVence = fechaVencimiento.toLocaleDateString('es-ES');\n    const cliente = factura.partner_id && factura.partner_id[1] ? factura.partner_id[1] : 'Cliente desconocido';\n    const importeTotal = parseFloat(factura.amount_total || 0);\n    const importePendiente = parseFloat(factura.amount_residual || 0);\n    \n    // Calcular días de retraso\n    const diffTime = hoy - fechaVencimiento;\n    const diasRetraso = Math.floor(diffTime / (1000 * 60 * 60 * 24));\n    \n    let estadoPago = '';\n    if (diasRetraso > 0) {\n      estadoPago = `🔴 VENCIDA (${diasRetraso} días)`;\n      facturasVencidas++;\n    } else if (diasRetraso === 0) {\n      estadoPago = '⚠️ VENCE HOY';\n    } else {\n      const diasRestantes = Math.abs(diasRetraso);\n      estadoPago = `🟡 Vence en ${diasRestantes} días`;\n    }\n    \n    if (tipoConsulta !== 'total_pendiente') {\n      texto += `${idx + 1}. 💳 **${factura.name}**\\n`;\n      texto += `   👤 Cliente: ${cliente}\\n`;\n      texto += `   💰 Total factura: ${importeTotal}€\\n`;\n      texto += `   🔴 **Pendiente: ${importePendiente}€**\\n`;\n      texto += `   📅 Fecha factura: ${fechaFactura}\\n`;\n      texto += `   ⏰ Vencimiento: ${fechaVence}\\n`;\n      texto += `   📊 Estado: ${estadoPago}\\n\\n`;\n    }\n    \n    totalPendiente += importePendiente;\n    facturasPendientes++;\n  });\n  \n  if (tipoConsulta === 'total_pendiente') {\n    texto += `💰 **TOTAL PENDIENTE DE COBRO: ${totalPendiente.toFixed(2)}€**\\n`;\n    texto += `📊 Facturas pendientes: ${facturasPendientes}\\n`;\n    if (facturasVencidas > 0) {\n      texto += `🔴 Facturas vencidas: ${facturasVencidas}\\n`;\n    }\n  } else {\n    texto += `**💰 TOTAL PENDIENTE: ${totalPendiente.toFixed(2)}€**\\n`;\n    texto += `📊 Facturas: ${facturasPendientes}`;\n    if (facturasVencidas > 0) {\n      texto += ` (${facturasVencidas} vencidas)`;\n    }\n  }\n}\n\nconsole.log('✅ Texto pagos pendientes generado:', texto.substring(0, 200) + '...');\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1056,
        6160
      ],
      "id": "f5c91deb-dddc-43d3-a9b1-7b840962a20d",
      "name": "Formatear Respuesta Pagos Pendientes"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -624,
        6160
      ],
      "id": "1ec1b655-86c6-45d3-9498-286eea539f55",
      "name": "Enviar Respuesta Pagos Pendientes",
      "webhookId": "pagos-pendientes-webhook-001"
    },
    {
      "parameters": {
        "content": "## Mensaje pagos faltantes\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3536,
        6000
      ],
      "typeVersion": 1,
      "id": "cdca0a08-892d-4905-a53a-9c8af7ce1209",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta para obtener top productos/clientes\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst tipoConsulta = datosAI.tipo_consulta; // top_productos_mes | top_clientes_año | top_clientes_mes\nconst parametro = datosAI.parametro;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nlet jsonRpcPayload;\n\n// TOP PRODUCTOS MES ACTUAL O ESPECÍFICO - Usar sale.order.line con search_read\nif (tipoConsulta === 'top_productos_mes') {\n  let year, month;\n  \n  // Mapear nombres de meses a números\n  const mesesMap = {\n    'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4, 'mayo': 5, 'junio': 6,\n    'julio': 7, 'agosto': 8, 'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12\n  };\n  \n  // Intentar detectar mes específico en el parámetro\n  let mesDetectado = null;\n  if (parametro) {\n    const mesTexto = parametro.toString().toLowerCase();\n    console.log('🔍 DETECTANDO MES en:', mesTexto);\n    \n    // Buscar cualquier mes en el parámetro\n    for (const [nombreMes, numeroMes] of Object.entries(mesesMap)) {\n      if (mesTexto.includes(nombreMes)) {\n        mesDetectado = numeroMes;\n        console.log('✅ MES DETECTADO:', nombreMes, '=', numeroMes);\n        break;\n      }\n    }\n  }\n  \n  if (mesDetectado) {\n    // Usar mes detectado\n    month = mesDetectado;\n    year = new Date().getFullYear();\n    console.log('📅 USANDO MES ESPECÍFICO:', month, 'del año', year);\n  } else {\n    // Mes actual\n    const now = new Date();\n    year = now.getFullYear();\n    month = now.getMonth() + 1;\n    console.log('📅 USANDO MES ACTUAL:', month, 'del año', year);\n  }\n  \n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n  \n  console.log('🔍 DEBUG TOP PRODUCTOS:');\n  console.log('- Parámetro recibido:', parametro);\n  console.log('- Mes detectado:', mesDetectado);\n  console.log('- Año:', year, '| Mes:', month);\n  console.log('- Rango fecha:', primerDia, 'hasta', primerDiaSiguienteMes);\n  \n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"sale.order.line\",\n        \"search_read\",\n        [[\n          [\"order_id.date_order\", \">=\", primerDia],\n          [\"order_id.date_order\", \"<\", primerDiaSiguienteMes],\n          [\"order_id.state\", \"in\", [\"sale\", \"done\", \"draft\", \"sent\"]]\n        ]],\n        { \n          fields: [\"product_id\", \"product_uom_qty\", \"price_total\", \"name\"],\n          limit: 1000\n        }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// TOP CLIENTES AÑO ACTUAL - Usar sale.order con search_read\nelse if (tipoConsulta === 'top_clientes_año') {\n  const year = new Date().getFullYear();\n  \n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"sale.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", `${year}-01-01`],\n          [\"date_order\", \"<\", `${year + 1}-01-01`],\n          [\"state\", \"in\", [\"sale\", \"done\", \"draft\", \"sent\"]]\n        ]],\n        { \n          fields: [\"partner_id\", \"amount_total\", \"name\"],\n          limit: 1000\n        }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// TOP CLIENTES MES ACTUAL - Usar sale.order con search_read\nelse if (tipoConsulta === 'top_clientes_mes') {\n  const now = new Date();\n  const year = now.getFullYear();\n  const month = now.getMonth() + 1;\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n  \n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"sale.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", primerDia],\n          [\"date_order\", \"<\", primerDiaSiguienteMes],\n          [\"state\", \"in\", [\"sale\", \"done\", \"draft\", \"sent\"]]\n        ]],\n        { \n          fields: [\"partner_id\", \"amount_total\", \"name\"],\n          limit: 1000\n        }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n\n// TOP PRODUCTOS AÑO (por parámetro o año actual) - sale.order.line\nelse if (tipoConsulta === 'top_productos_año') {\n  let year = parseInt(parametro, 10);\n  if (Number.isNaN(year)) {\n    year = new Date().getFullYear();\n  }\n\n  const primerDia = `${year}-01-01`;\n  const primerDiaSiguienteAnio = `${year + 1}-01-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"sale.order.line\",\n        \"search_read\",\n        [[\n          [\"order_id.date_order\", \">=\", primerDia],\n          [\"order_id.date_order\", \"<\", primerDiaSiguienteAnio],\n          [\"order_id.state\", \"in\", [\"sale\", \"done\", \"draft\", \"sent\"]]\n        ]],\n        {\n          fields: [\"product_id\", \"product_uom_qty\", \"price_total\", \"name\"],\n          limit: 1000\n        }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n\nconsole.log('🏆 Payload top rankings:', JSON.stringify(jsonRpcPayload, null, 2));\n\nif (!jsonRpcPayload) {\n  throw new Error(`Tipo de consulta no soportado: ${tipoConsulta}`);\n}\n\nreturn {\n  payload: jsonRpcPayload,\n  tipo_consulta: tipoConsulta,\n  parametro: parametro,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1712,
        6608
      ],
      "id": "1ba25ab4-3fee-41fb-95cb-b2169b96cf2a",
      "name": "Preparar Consulta Top Rankings"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1440,
        6608
      ],
      "id": "9b78703c-b029-4a8c-bc9c-72301f35334a",
      "name": "HTTP Consulta Top Rankings"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de top rankings para Telegram\nconst respuestaOdoo = $json.result;\nconst datosConsulta = $('Preparar Consulta Top Rankings').item.json;\nlet texto = '';\n\nconsole.log('🏆 DATOS FORMATEAR TOP RANKINGS:');\nconsole.log('- Resultados:', Array.isArray(respuestaOdoo) ? respuestaOdoo.length : 'No es array');\nconsole.log('- Tipo consulta:', datosConsulta.tipo_consulta);\n\nif (!Array.isArray(respuestaOdoo) || respuestaOdoo.length === 0) {\n  const tipoConsulta = datosConsulta.tipo_consulta;\n  if (tipoConsulta === 'top_productos_mes') {\n    texto = '📊 No se encontraron productos vendidos este mes.';\n  } else if (tipoConsulta === 'top_productos_año') {\n    texto = '📊 No se encontraron productos vendidos este año.';\n  } else if (tipoConsulta === 'top_clientes_año') {\n    texto = '📊 No se encontraron clientes con ventas este año.';\n  } else if (tipoConsulta === 'top_clientes_mes') {\n    texto = '📊 No se encontraron clientes con ventas este mes.';\n  } else {\n    texto = '📊 No se encontraron datos para el ranking solicitado.';\n  }\n} else {\n  const tipoConsulta = datosConsulta.tipo_consulta;\n  \n  if (tipoConsulta === 'top_productos_mes') {\n    // Agrupar productos por product_id y sumar cantidades/totales\n    const productosAgrupados = {};\n    \n    respuestaOdoo.forEach(item => {\n      const productId = item.product_id && item.product_id[0] ? item.product_id[0] : 'unknown';\n      const nombreProducto = item.product_id && item.product_id[1] ? item.product_id[1] : 'Producto desconocido';\n      const cantidad = parseFloat(item.product_uom_qty || 0);\n      const totalVentas = parseFloat(item.price_total || 0);\n      \n      if (!productosAgrupados[productId]) {\n        productosAgrupados[productId] = {\n          nombre: nombreProducto,\n          cantidadTotal: 0,\n          ventasTotal: 0\n        };\n      }\n      \n      productosAgrupados[productId].cantidadTotal += cantidad;\n      productosAgrupados[productId].ventasTotal += totalVentas;\n    });\n    \n    // Convertir a array y ordenar por ventas\n    const productosOrdenados = Object.values(productosAgrupados)\n      .sort((a, b) => b.ventasTotal - a.ventasTotal)\n      .slice(0, 10); // Top 10\n    \n    texto = `🏆 **TOP PRODUCTOS MÁS VENDIDOS ESTE MES:**\\n\\n`;\n    \n    productosOrdenados.forEach((producto, idx) => {\n      let medalla = '';\n      if (idx === 0) medalla = '🥇';\n      else if (idx === 1) medalla = '🥈';\n      else if (idx === 2) medalla = '🥉';\n      else medalla = `${idx + 1}.`;\n      \n      texto += `${medalla} **${producto.nombre}**\\n`;\n      texto += `   📦 Cantidad vendida: ${producto.cantidadTotal.toFixed(0)}\\n`;\n      texto += `   💰 Ingresos: ${producto.ventasTotal.toFixed(2)}€\\n\\n`;\n    });\n    \n  } else if (tipoConsulta === 'top_productos_año') {\n    // Agrupar productos por product_id y sumar cantidades/totales\n    const productosAgrupados = {};\n    \n    respuestaOdoo.forEach(item => {\n      const productId = item.product_id && item.product_id[0] ? item.product_id[0] : 'unknown';\n      const nombreProducto = item.product_id && item.product_id[1] ? item.product_id[1] : 'Producto desconocido';\n      const cantidad = parseFloat(item.product_uom_qty || 0);\n      const totalVentas = parseFloat(item.price_total || 0);\n      \n      if (!productosAgrupados[productId]) {\n        productosAgrupados[productId] = {\n          nombre: nombreProducto,\n          cantidadTotal: 0,\n          ventasTotal: 0\n        };\n      }\n      \n      productosAgrupados[productId].cantidadTotal += cantidad;\n      productosAgrupados[productId].ventasTotal += totalVentas;\n    });\n    \n    // Convertir a array y ordenar por ventas\n    const productosOrdenados = Object.values(productosAgrupados)\n      .sort((a, b) => b.ventasTotal - a.ventasTotal)\n      .slice(0, 10); // Top 10\n    \n    texto = `🏆 **TOP PRODUCTOS MÁS VENDIDOS DEL AÑO:**\\n\\n`;\n    \n    productosOrdenados.forEach((producto, idx) => {\n      let medalla = '';\n      if (idx === 0) medalla = '🥇';\n      else if (idx === 1) medalla = '🥈';\n      else if (idx === 2) medalla = '🥉';\n      else medalla = `${idx + 1}.`;\n      \n      texto += `${medalla} **${producto.nombre}**\\n`;\n      texto += `   📦 Cantidad vendida: ${producto.cantidadTotal.toFixed(0)}\\n`;\n      texto += `   💰 Ingresos: ${producto.ventasTotal.toFixed(2)}€\\n\\n`;\n    });\n\n  } else if (tipoConsulta === 'top_clientes_año' || tipoConsulta === 'top_clientes_mes') {\n    // Agrupar clientes por partner_id y sumar totales\n    const clientesAgrupados = {};\n    \n    respuestaOdoo.forEach(item => {\n      const partnerId = item.partner_id && item.partner_id[0] ? item.partner_id[0] : 'unknown';\n      const nombreCliente = item.partner_id && item.partner_id[1] ? item.partner_id[1] : 'Cliente desconocido';\n      const totalVentas = parseFloat(item.amount_total || 0);\n      \n      if (!clientesAgrupados[partnerId]) {\n        clientesAgrupados[partnerId] = {\n          nombre: nombreCliente,\n          ventasTotal: 0\n        };\n      }\n      \n      clientesAgrupados[partnerId].ventasTotal += totalVentas;\n    });\n    \n    // Convertir a array y ordenar por ventas\n    const clientesOrdenados = Object.values(clientesAgrupados)\n      .sort((a, b) => b.ventasTotal - a.ventasTotal)\n      .slice(0, 10); // Top 10\n    \n    const periodo = tipoConsulta === 'top_clientes_año' ? 'AÑO' : 'MES';\n    texto = `🏆 **TOP CLIENTES DEL ${periodo}:**\\n\\n`;\n    \n    let totalGeneral = 0;\n    clientesOrdenados.forEach((cliente, idx) => {\n      let medalla = '';\n      if (idx === 0) medalla = '🥇';\n      else if (idx === 1) medalla = '🥈';\n      else if (idx === 2) medalla = '🥉';\n      else medalla = `${idx + 1}.`;\n      \n      texto += `${medalla} **${cliente.nombre}**\\n`;\n      texto += `   💰 Total facturado: ${cliente.ventasTotal.toFixed(2)}€\\n\\n`;\n      \n      totalGeneral += cliente.ventasTotal;\n    });\n    \n    texto += `**💎 TOTAL FACTURADO (TOP): ${totalGeneral.toFixed(2)}€**\\n`;\n    texto += `📊 Mostrando top ${clientesOrdenados.length} clientes`;\n  }\n}\n\nconsole.log('✅ Texto top rankings generado:', texto.substring(0, 200) + '...');\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        6608
      ],
      "id": "42f9bf53-8a18-4cc7-af1c-bee4c5fbd863",
      "name": "Formatear Respuesta Top Rankings"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -640,
        6608
      ],
      "id": "1a2c2d13-96ea-4fdc-a97b-2d7abbb16bd3",
      "name": "Enviar Respuesta Top Rankings",
      "webhookId": "top-rankings-webhook-001"
    },
    {
      "parameters": {
        "content": "## Rankings\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3584,
        6448
      ],
      "typeVersion": 1,
      "id": "9bcd73c4-4062-4b1e-82d9-30e789ea80d0",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta para análisis de ventas perdidas\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst tipoConsulta = datosAI.tipo_consulta || 'mes_actual';\nconst parametro = datosAI.parametro;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nlet year, month;\n\nif (tipoConsulta === 'mes_nombre' && parametro) {\n  // Mapear nombres de meses a números\n  const mesesMap = {\n    'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4, 'mayo': 5, 'junio': 6,\n    'julio': 7, 'agosto': 8, 'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12\n  };\n  \n  // Intentar detectar mes específico en el parámetro\n  let mesDetectado = null;\n  const mesTexto = parametro.toString().toLowerCase();\n  console.log('🔍 DETECTANDO MES VENTAS PERDIDAS en:', mesTexto);\n  \n  // Buscar cualquier mes en el parámetro\n  for (const [nombreMes, numeroMes] of Object.entries(mesesMap)) {\n    if (mesTexto.includes(nombreMes)) {\n      mesDetectado = numeroMes;\n      console.log('✅ MES DETECTADO VENTAS PERDIDAS:', nombreMes, '=', numeroMes);\n      break;\n    }\n  }\n  \n  if (mesDetectado) {\n    // Usar mes detectado\n    month = mesDetectado;\n    year = new Date().getFullYear();\n    console.log('📅 VENTAS PERDIDAS - USANDO MES ESPECÍFICO:', month, 'del año', year);\n  } else {\n    // Si no se detecta, usar mes actual\n    const now = new Date();\n    year = now.getFullYear();\n    month = now.getMonth() + 1;\n    console.log('📅 VENTAS PERDIDAS - USANDO MES ACTUAL:', month, 'del año', year);\n  }\n} else {\n  // Mes actual por defecto\n  const now = new Date();\n  year = now.getFullYear();\n  month = now.getMonth() + 1;\n  console.log('📅 VENTAS PERDIDAS - USANDO MES ACTUAL:', month, 'del año', year);\n}\n\n// Construir fechas\nconst mes = month < 10 ? `0${month}` : `${month}`;\nconst primerDia = `${year}-${mes}-01`;\nconst siguienteMes = month === 12 ? 1 : month + 1;\nconst siguienteAnio = month === 12 ? year + 1 : year;\nconst mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\nconst primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\nconsole.log('🔍 DEBUG VENTAS PERDIDAS:');\nconsole.log('- Parámetro recibido:', parametro);\nconsole.log('- Tipo consulta:', tipoConsulta);\nconsole.log('- Año:', year, '| Mes:', month);\nconsole.log('- Rango fecha:', primerDia, 'hasta', primerDiaSiguienteMes);\n\n// Query para obtener todas las órdenes de venta del período\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"sale.order\",\n      \"search_read\",\n      [[\n        [\"date_order\", \">=\", primerDia],\n        [\"date_order\", \"<\", primerDiaSiguienteMes]\n      ]],\n      { \n        fields: [\"id\", \"name\", \"state\", \"amount_total\", \"partner_id\", \"date_order\", \"invoice_status\"],\n        limit: 1000\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📊 Payload ventas perdidas:', JSON.stringify(jsonRpcPayload, null, 2));\n\nreturn {\n  payload: jsonRpcPayload,\n  chat_id: datosAI.chat_id,\n  uid: uid,\n  tipo_consulta: tipoConsulta,\n  parametro: parametro,\n  periodo_inicio: primerDia,\n  periodo_fin: primerDiaSiguienteMes\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1792,
        7056
      ],
      "id": "bf68e044-e30d-4203-a148-9dbaa548c925",
      "name": "Preparar Consulta Ventas Perdidas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1552,
        7056
      ],
      "id": "2dce42ac-cc37-47ff-9a75-c8320bde2a40",
      "name": "HTTP Consulta Ventas Perdidas"
    },
    {
      "parameters": {
        "jsCode": "// Analizar ventas perdidas y generar estadísticas\nconst respuestaOdoo = $json.result;\nconst datosConsulta = $('Preparar Consulta Ventas Perdidas').item.json;\n\nconsole.log('📊 ANÁLISIS VENTAS PERDIDAS:', Array.isArray(respuestaOdoo) ? respuestaOdoo.length : 0, 'órdenes');\n\nif (!Array.isArray(respuestaOdoo) || respuestaOdoo.length === 0) {\n  return {\n    texto: '📊 No se encontraron órdenes de venta en el período analizado.',\n    chat_id: datosConsulta.chat_id\n  };\n}\n\n// Clasificar órdenes - PENDIENTES Y PERDIDAS (incluye confirmadas no facturadas)\nlet ventasPendientes = 0; // Estado: draft, sent, sale no facturadas\nlet ventasPerdidas = 0;   // Estado: cancel\nlet montoPendiente = 0;\nlet montoPerdido = 0;\n\nrespuestaOdoo.forEach(orden => {\n  const estado = orden.state;\n  const estadoFacturacion = orden.invoice_status;\n  const monto = parseFloat(orden.amount_total || 0);\n  \n  // PENDIENTES incluye: cotizaciones + confirmadas no facturadas\n  if (estado === 'draft' || estado === 'sent') {\n    // Cotizaciones pendientes de confirmar\n    ventasPendientes++;\n    montoPendiente += monto;\n  } else if (estado === 'sale' || estado === 'done') {\n    // Confirmadas pero verificar si están facturadas\n    if (estadoFacturacion === 'invoiced') {\n      // Ya facturadas = ignorar (proceso completado)\n    } else {\n      // Confirmadas pero NO facturadas = son relevantes como pendientes\n      ventasPendientes++;\n      montoPendiente += monto;\n    }\n  } else if (estado === 'cancel') {\n    ventasPerdidas++;\n    montoPerdido += monto;\n  }\n});\n\nconst totalRelevantes = ventasPendientes + ventasPerdidas;\nconst porcentajePendientes = totalRelevantes > 0 ? ((ventasPendientes / totalRelevantes) * 100).toFixed(1) : 0;\nconst porcentajePerdidas = totalRelevantes > 0 ? ((ventasPerdidas / totalRelevantes) * 100).toFixed(1) : 0;\n\n// Generar reporte - SOLO PENDIENTES + PERDIDAS\nlet texto = `📊 **ANÁLISIS: VENTAS PENDIENTES Y PERDIDAS**\\n\\n`;\ntexto += `📈 **RESUMEN:**\\n`;\ntexto += `• Órdenes relevantes: **${totalRelevantes}**\\n\\n`;\ntexto += `⏳ **PENDIENTES:** ${ventasPendientes} (${porcentajePendientes}%) - €${montoPendiente.toFixed(2)}\\n`;\ntexto += `❌ **PERDIDAS:** ${ventasPerdidas} (${porcentajePerdidas}%) - €${montoPerdido.toFixed(2)}\\n\\n`;\n\nif (totalRelevantes > 0) {\n  const montoTotal = montoPendiente + montoPerdido;\n  texto += `💰 **Total en riesgo:** €${montoTotal.toFixed(2)}\\n`;\n  \n  if (ventasPendientes > 0) {\n    texto += `🎯 **Oportunidad:** ${ventasPendientes} órdenes por €${montoPendiente.toFixed(2)} esperan confirmación\\n`;\n  }\n}\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id,\n  estadisticas: {\n    pendientes: ventasPendientes,\n    perdidas: ventasPerdidas,\n    total_relevantes: totalRelevantes,\n    monto_pendiente: montoPendiente,\n    monto_perdido: montoPerdido,\n    porcentajes: { pendientes: porcentajePendientes, perdidas: porcentajePerdidas }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1312,
        7056
      ],
      "id": "06cb5e17-603d-4a75-bccc-4990f0a35d2c",
      "name": "Formatear Análisis Ventas Perdidas"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1072,
        7056
      ],
      "id": "6b26c6cb-23f7-4959-b13e-f00f115f0364",
      "name": "Enviar Análisis Ventas Perdidas",
      "webhookId": "ventas-perdidas-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// Generar gráfico donut con ChartJS y convertir a imagen\n// Obtener datos del nodo Formatear Análisis Ventas Perdidas\nconst datos = $('Formatear Análisis Ventas Perdidas').item.json;\nconst estadisticas = datos.estadisticas;\n\nif (!estadisticas) {\n  console.log('❌ No hay estadísticas para generar gráfico');\n  return {\n    ...datos,\n    grafico_html: null,\n    tiene_grafico: false\n  };\n}\n\nconsole.log('🎨 Generando gráfico donut con datos:', estadisticas);\n\n// Preparar datos para el gráfico - SOLO PENDIENTES Y PERDIDAS\nconst labels = ['Pendientes', 'Perdidas'];\nconst valores = [estadisticas.pendientes, estadisticas.perdidas];\nconst colores = ['#ffc107', '#dc3545']; // Amarillo, Rojo\nconst porcentajes = [\n  estadisticas.porcentajes.pendientes,\n  estadisticas.porcentajes.perdidas\n];\n\nconsole.log('📊 Valores gráfico:', valores);\nconsole.log('🎨 Colores gráfico:', colores);\nconsole.log('📈 Porcentajes gráfico:', porcentajes);\n\n// Crear HTML con Chart.js para renderizar\nconst htmlChart = `\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"utf-8\">\n    <title>Análisis Ventas Perdidas</title>\n    <script src=\"https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js\"></script>\n    <style>\n        body {\n            margin: 0;\n            padding: 20px;\n            font-family: 'Segoe UI', Arial, sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            min-height: 100vh;\n        }\n        .container {\n            background: white;\n            border-radius: 20px;\n            padding: 30px;\n            box-shadow: 0 20px 40px rgba(0,0,0,0.1);\n            text-align: center;\n            max-width: 500px;\n            width: 100%;\n        }\n        .title {\n            color: #2c3e50;\n            font-size: 24px;\n            font-weight: bold;\n            margin-bottom: 10px;\n        }\n        .subtitle {\n            color: #7f8c8d;\n            font-size: 14px;\n            margin-bottom: 30px;\n        }\n        .chart-container {\n            position: relative;\n            height: 300px;\n            margin: 20px 0;\n        }\n        .stats-grid {\n            display: grid;\n            grid-template-columns: repeat(2, 1fr);\n            gap: 15px;\n            margin-top: 25px;\n        }\n        .stat-card {\n            background: #f8f9fa;\n            border-radius: 12px;\n            padding: 15px;\n            text-align: center;\n        }\n        .stat-value {\n            font-size: 20px;\n            font-weight: bold;\n            margin-bottom: 5px;\n        }\n        .stat-label {\n            font-size: 12px;\n            color: #6c757d;\n            font-weight: 500;\n        }\n\n        .pendientes .stat-value { color: #ffc107; }\n        .perdidas .stat-value { color: #dc3545; }\n        .total-info {\n            background: #e9ecef;\n            border-radius: 10px;\n            padding: 15px;\n            margin-top: 20px;\n            font-weight: 500;\n            color: #495057;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"title\">📊 Ventas Pendientes y Perdidas</div>\n        <div class=\"subtitle\">Análisis enfocado en oportunidades y riesgos</div>\n        \n        <div class=\"chart-container\">\n            <canvas id=\"donutChart\"></canvas>\n        </div>\n        \n        <div class=\"stats-grid\">\n            <div class=\"stat-card pendientes\">\n                <div class=\"stat-value\">${valores[0]}</div>\n                <div class=\"stat-label\">PENDIENTES<br/>${porcentajes[0]}%</div>\n            </div>\n            <div class=\"stat-card perdidas\">\n                <div class=\"stat-value\">${valores[1]}</div>\n                <div class=\"stat-label\">PERDIDAS<br/>${porcentajes[1]}%</div>\n            </div>\n        </div>\n        \n        <div class=\"total-info\">\n            📈 Órdenes relevantes: <strong>${estadisticas.total_relevantes}</strong><br/>\n            💰 Monto total en riesgo: <strong>€${(estadisticas.monto_pendiente + estadisticas.monto_perdido).toFixed(2)}</strong>\n        </div>\n    </div>\n    \n    <script>\n        console.log('🎨 DEBUG GRÁFICO:');\n        console.log('📊 Labels:', ${JSON.stringify(labels)});\n        console.log('📊 Values:', ${JSON.stringify(valores)});\n        console.log('🎨 Colors:', ${JSON.stringify(colores)});\n        \n        const ctx = document.getElementById('donutChart').getContext('2d');\n        \n        new Chart(ctx, {\n            type: 'doughnut',\n            data: {\n                labels: ${JSON.stringify(labels)},\n                datasets: [{\n                    data: ${JSON.stringify(valores)},\n                    backgroundColor: ${JSON.stringify(colores)},\n                    borderWidth: 3,\n                    borderColor: '#ffffff',\n                    hoverBorderWidth: 5,\n                    hoverBorderColor: '#ffffff'\n                }]\n            },\n            options: {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    legend: {\n                        display: false\n                    },\n                    tooltip: {\n                        callbacks: {\n                            label: function(context) {\n                                const label = context.label;\n                                const value = context.parsed;\n                                const percentage = ${JSON.stringify(porcentajes)}[context.dataIndex];\n                                return label + ': ' + value + ' (' + percentage + '%)';\n                            }\n                        },\n                        backgroundColor: 'rgba(0,0,0,0.8)',\n                        titleColor: '#ffffff',\n                        bodyColor: '#ffffff',\n                        borderColor: '#ffffff',\n                        borderWidth: 1\n                    }\n                },\n                cutout: '60%'\n            }\n        });\n    </script>\n</body>\n</html>\n`;\n\nconsole.log('✅ HTML del gráfico generado, caracteres:', htmlChart.length);\n\n// Agregar la información del gráfico al objeto de retorno\nreturn {\n  ...datos,\n  grafico_html: htmlChart,\n  tiene_grafico: true\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -832,
        7056
      ],
      "id": "43de3552-3490-4f9e-842e-d42e44d13bb3",
      "name": "Generar Gráfico Donut Ventas Perdidas"
    },
    {
      "parameters": {
        "jsCode": "// Generar URL de imagen con QuickChart.io\n// Obtener datos del nodo anterior\nconst datos = $('Formatear Análisis Ventas Perdidas').item.json;\nconst estadisticas = datos.estadisticas;\n\nif (!estadisticas) {\n  console.log('❌ No hay estadísticas para generar gráfico');\n  return {\n    ...datos,\n    chart_url: null\n  };\n}\n\n// Datos para el gráfico donut - SOLO PENDIENTES Y PERDIDAS\nconst labels = ['Pendientes', 'Perdidas'];\nconst valores = [estadisticas.pendientes, estadisticas.perdidas];\nconst colores = ['#ffc107', '#dc3545']; // Amarillo, Rojo\nconst porcentajes = [\n  estadisticas.porcentajes.pendientes,\n  estadisticas.porcentajes.perdidas\n];\n\n// Configuración del gráfico Chart.js\nconst configChart = {\n  type: 'doughnut',\n  data: {\n    labels: labels,\n    datasets: [{\n      data: valores,\n      backgroundColor: colores,\n      borderWidth: 3,\n      borderColor: '#ffffff'\n    }]\n  },\n  options: {\n    responsive: true,\n    plugins: {\n      title: {\n        display: true,\n        text: '📊 Ventas Pendientes y Perdidas',\n        font: {\n          size: 18,\n          weight: 'bold'\n        },\n        color: '#2c3e50'\n      },\n      legend: {\n        position: 'bottom',\n        labels: {\n          padding: 20,\n          usePointStyle: true,\n          font: {\n            size: 12,\n            weight: 'bold'\n          }\n        }\n      },\n      tooltip: {\n        callbacks: {\n          label: function(context) {\n            const label = context.label;\n            const value = context.parsed;\n            const percentage = porcentajes[context.dataIndex];\n            return label + ': ' + value + ' (' + percentage + '%)';\n          }\n        }\n      }\n    },\n    cutout: '60%'\n  }\n};\n\n// Crear URL codificada para QuickChart\nconst chartConfig = encodeURIComponent(JSON.stringify(configChart));\nconst backgroundColorParam = encodeURIComponent('rgba(255,255,255,1)');\nconst chartUrl = `https://quickchart.io/chart?c=${chartConfig}&backgroundColor=${backgroundColorParam}&width=600&height=400&devicePixelRatio=2`;\n\nconsole.log('🎨 URL del gráfico generada:');\nconsole.log('🔗 URL completa:', chartUrl);\nconsole.log('🔗 Primeros 150 caracteres:', chartUrl.substring(0, 150) + '...');\n\nreturn {\n  ...datos,\n  chart_url: chartUrl,\n  tiene_grafico: true\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        7056
      ],
      "id": "3854dc78-fcd2-451a-a128-fdffba407f0a",
      "name": "Generar URL Gráfico"
    },
    {
      "parameters": {
        "url": "={{ $json.chart_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -352,
        7056
      ],
      "id": "178bbc0a-d651-489c-b35b-1efa7cdd1a96",
      "name": "Descargar Imagen Gráfico"
    },
    {
      "parameters": {
        "content": "## Análisis Ventas Perdidas"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3664,
        6896
      ],
      "typeVersion": 1,
      "id": "560dc5a3-d827-4dd9-9daa-880796cd143a",
      "name": "Sticky Note - Ventas Perdidas"
    },
    {
      "parameters": {
        "operation": "sendPhoto",
        "chatId": "={{ $('Formatear Análisis Ventas Perdidas').item.json.chat_id }}",
        "binaryData": true,
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        64,
        7056
      ],
      "id": "389ad6af-d492-4d0c-b0d9-aa0a6326dc00",
      "name": "Envio grafico",
      "webhookId": "336efb20-4094-4b75-9f44-6c0770c69e6f"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de horas por proyecto\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreProyecto = datosAI.proyecto;\n\nconsole.log('🔍 Consultando horas del proyecto:', nombreProyecto);\n\n// Validar datos\nif (!uid) throw new Error('No se pudo obtener el UID de autenticación');\nif (!nombreProyecto) throw new Error('No se encontró el nombre del proyecto');\n\n// Buscar proyecto y sus horas en una sola consulta\nconst consultarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"search_read\",\n      [\n        [[\"project_id.name\", \"ilike\", nombreProyecto]],\n        [\"id\", \"name\", \"date\", \"unit_amount\", \"task_id\", \"user_id\", \"project_id\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultarHoras,\n  proyecto: nombreProyecto,\n  chat_id: datosAI.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1936,
        7456
      ],
      "id": "5a5fb56b-f007-4378-a306-6d2789948b5b",
      "name": "Preparar Consulta Horas Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de horas por tarea específica\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreProyecto = datosAI.proyecto || null;\nconst nombreTarea = datosAI.tarea;\n\nconsole.log('🔍 Consultando horas de tarea:', nombreTarea, nombreProyecto ? 'en proyecto: ' + nombreProyecto : '(en cualquier proyecto)');\n\n// Validar datos esenciales\nif (!uid) throw new Error('No se pudo obtener el UID de autenticación');\nif (!nombreTarea) throw new Error('No se encontró el nombre de la tarea');\n\n// Construir filtros - solo por tarea, sin filtrar por proyecto\nconst filtros = [[\"task_id.name\", \"ilike\", nombreTarea]];\n\n// Buscar horas de la tarea específica\nconst consultarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"search_read\",\n      [\n        filtros,\n        [\"id\", \"name\", \"date\", \"unit_amount\", \"task_id\", \"user_id\", \"project_id\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultarHoras,\n  proyecto: nombreProyecto,\n  tarea: nombreTarea,\n  chat_id: datosAI.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1984,
        7840
      ],
      "id": "ce03bdcd-5e32-42b0-bce0-f2f2ea09859d",
      "name": "Preparar Consulta Horas Tarea"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1616,
        7472
      ],
      "id": "9ecd0afe-df3c-4bf0-b1b6-3ed9990d41ef",
      "name": "HTTP Consulta Horas Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de horas por proyecto\nconst datosOriginales = $('Preparar Consulta Horas Proyecto').item.json;\nconst horasData = $json.result || [];\n\nconst nombreProyecto = datosOriginales.proyecto;\n\nif (!horasData || horasData.length === 0) {\n  let textoError = `❌ **Proyecto no encontrado**\\n\\n`;\n  textoError += `🏗️ **Proyecto buscado:** \"${nombreProyecto}\"\\n\\n`;\n  textoError += `No se encontraron registros de horas para un proyecto con ese nombre.\\n\\n`;\n  textoError += `💡 **Sugerencias:**\\n`;\n  textoError += `• Verifica que el nombre del proyecto sea correcto\\n`;\n  textoError += `• Intenta con un nombre más corto o parcial\\n`;\n  textoError += `• Usa /listar proyectos para ver los proyectos disponibles`;\n  \n  return {\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\n// Calcular estadísticas\nlet totalHoras = 0;\nconst registrosPorTarea = {};\nconst registrosPorUsuario = {};\nconst proyectosEncontrados = new Set();\n\nhorasData.forEach(registro => {\n  totalHoras += parseFloat(registro.unit_amount || 0);\n  proyectosEncontrados.add(registro.project_id[1]);\n  \n  // Agrupar por tarea\n  const tarea = registro.task_id ? registro.task_id[1] : 'Sin tarea específica';\n  if (!registrosPorTarea[tarea]) {\n    registrosPorTarea[tarea] = { horas: 0, registros: 0 };\n  }\n  registrosPorTarea[tarea].horas += parseFloat(registro.unit_amount || 0);\n  registrosPorTarea[tarea].registros++;\n  \n  // Agrupar por usuario\n  const usuario = registro.user_id ? registro.user_id[1] : 'Usuario desconocido';\n  if (!registrosPorUsuario[usuario]) {\n    registrosPorUsuario[usuario] = { horas: 0, registros: 0 };\n  }\n  registrosPorUsuario[usuario].horas += parseFloat(registro.unit_amount || 0);\n  registrosPorUsuario[usuario].registros++;\n});\n\n// Obtener el nombre real del proyecto\nconst proyectoReal = Array.from(proyectosEncontrados)[0] || nombreProyecto;\n\n// Formatear respuesta\nlet texto = `⏰ **Horas del Proyecto:** ${proyectoReal}\\n\\n`;\ntexto += `📊 **Total de horas:** ${totalHoras.toFixed(2)}h\\n`;\ntexto += `📄 **Registros:** ${horasData.length}\\n\\n`;\n\n// Mostrar horas por usuario\nconst usuarios = Object.entries(registrosPorUsuario)\n  .sort(([,a], [,b]) => b.horas - a.horas);\n\nif (usuarios.length > 0) {\n  texto += `👥 **Horas por usuario:**\\n`;\n  usuarios.forEach(([usuario, datos]) => {\n    texto += `• ${usuario}: ${datos.horas.toFixed(2)}h (${datos.registros} registros)\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar top 5 tareas con más horas\nconst topTareas = Object.entries(registrosPorTarea)\n  .sort(([,a], [,b]) => b.horas - a.horas)\n  .slice(0, 5);\n\nif (topTareas.length > 0) {\n  texto += `🎯 **Top Tareas:**\\n`;\n  topTareas.forEach(([tarea, datos], index) => {\n    texto += `${index + 1}. ${tarea}: ${datos.horas.toFixed(2)}h\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar últimos 5 registros\nconst ultimosRegistros = horasData\n  .sort((a, b) => new Date(b.date) - new Date(a.date))\n  .slice(0, 5);\n\nif (ultimosRegistros.length > 0) {\n  texto += `📅 **Últimos registros:**\\n`;\n  ultimosRegistros.forEach(registro => {\n    const fecha = new Date(registro.date).toLocaleDateString('es-ES');\n    const tarea = registro.task_id ? registro.task_id[1] : 'Sin tarea';\n    const usuario = registro.user_id ? registro.user_id[1] : 'Usuario desconocido';\n    texto += `• ${fecha}: ${parseFloat(registro.unit_amount).toFixed(2)}h - ${tarea} (${usuario})\\n`;\n  });\n}\n\nreturn {\n  chat_id: datosOriginales.chat_id,\n  texto: texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1392,
        7472
      ],
      "id": "0a8aed25-a2b2-4b7d-903f-d7b781838a5a",
      "name": "Formatear Respuesta Horas Proyecto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -400,
        7472
      ],
      "id": "67500b57-b4df-4182-a094-a36bb410829e",
      "name": "Enviar Respuesta Horas Proyecto",
      "webhookId": "webhook-horas-proyecto-001"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1664,
        7840
      ],
      "id": "c3d38fcc-2cd4-4434-968b-f32e89040df0",
      "name": "HTTP Consulta Horas Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de horas por tarea específica\nconst datosOriginales = $('Preparar Consulta Horas Tarea').item.json;\nconst horasData = $json.result || [];\n\nconst nombreProyecto = datosOriginales.proyecto;\nconst nombreTarea = datosOriginales.tarea;\n\n// Verificar si no se encontraron resultados\nif (!horasData || horasData.length === 0) {\n  let textoError = `❌ **Tarea no encontrada**\\n\\n`;\n  textoError += `🎯 **Tarea buscada:** \"${nombreTarea}\"\\n\\n`;\n  textoError += `No se encontraron registros de horas para una tarea con ese nombre.\\n\\n`;\n  textoError += `💡 **Sugerencias:**\\n`;\n  textoError += `• Verifica que el nombre de la tarea sea correcto\\n`;\n  textoError += `• Intenta con un nombre más corto o parcial\\n`;\n  textoError += `• Usa /listar tareas para ver las tareas disponibles`;\n  \n  return {\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\n// Calcular estadísticas\nlet totalHoras = 0;\nconst registrosPorUsuario = {};\nconst registrosPorProyecto = {};\nconst proyectoReal = horasData[0].project_id[1];\nconst tareaReal = horasData[0].task_id[1];\n\nhorasData.forEach(registro => {\n  totalHoras += parseFloat(registro.unit_amount || 0);\n  \n  // Agrupar por usuario\n  const usuario = registro.user_id ? registro.user_id[1] : 'Usuario desconocido';\n  if (!registrosPorUsuario[usuario]) {\n    registrosPorUsuario[usuario] = { horas: 0, registros: 0 };\n  }\n  registrosPorUsuario[usuario].horas += parseFloat(registro.unit_amount || 0);\n  registrosPorUsuario[usuario].registros++;\n  \n  // Agrupar por proyecto (en caso de que la tarea esté en múltiples proyectos)\n  const proyecto = registro.project_id[1];\n  if (!registrosPorProyecto[proyecto]) {\n    registrosPorProyecto[proyecto] = { horas: 0, registros: 0 };\n  }\n  registrosPorProyecto[proyecto].horas += parseFloat(registro.unit_amount || 0);\n  registrosPorProyecto[proyecto].registros++;\n});\n\n// Formatear respuesta\nlet texto = `⏰ **Horas de Tarea:** ${tareaReal}\\n`;\n\n// Mostrar proyecto(s) donde se encontró la tarea\nconst proyectos = Object.keys(registrosPorProyecto);\nif (proyectos.length === 1) {\n  texto += `🏗️ **Proyecto:** ${proyectos[0]}\\n\\n`;\n} else if (proyectos.length > 1) {\n  texto += `🏗️ **Proyectos:** ${proyectos.join(', ')}\\n\\n`;\n}\n\ntexto += `📊 **Total de horas:** ${totalHoras.toFixed(2)}h\\n`;\ntexto += `📄 **Registros:** ${horasData.length}\\n\\n`;\n\n// Mostrar horas por proyecto si hay múltiples\nif (proyectos.length > 1) {\n  texto += `🏗️ **Horas por proyecto:**\\n`;\n  Object.entries(registrosPorProyecto).forEach(([proyecto, datos]) => {\n    texto += `• ${proyecto}: ${datos.horas.toFixed(2)}h\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar horas por usuario si hay múltiples usuarios\nconst usuarios = Object.entries(registrosPorUsuario);\nif (usuarios.length > 1) {\n  texto += `👥 **Horas por usuario:**\\n`;\n  usuarios.forEach(([usuario, datos]) => {\n    texto += `• ${usuario}: ${datos.horas.toFixed(2)}h\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar todos los registros (limitado a 10)\nconst registrosOrdenados = horasData\n  .sort((a, b) => new Date(b.date) - new Date(a.date))\n  .slice(0, 10);\n\nif (registrosOrdenados.length > 0) {\n  texto += `📅 **Registros de tiempo:**\\n`;\n  registrosOrdenados.forEach(registro => {\n    const fecha = new Date(registro.date).toLocaleDateString('es-ES');\n    const usuario = registro.user_id ? registro.user_id[1] : 'Usuario';\n    const proyecto = registro.project_id[1];\n    const descripcion = registro.name || 'Sin descripción';\n    texto += `• ${fecha}: ${parseFloat(registro.unit_amount).toFixed(2)}h - ${usuario}`;\n    if (proyectos.length > 1) {\n      texto += ` (${proyecto})`;\n    }\n    texto += `\\n`;\n    if (descripcion && descripcion !== 'Sin descripción') {\n      texto += `  📝 ${descripcion}\\n`;\n    }\n  });\n}\n\nif (horasData.length > 10) {\n  texto += `\\n... y ${horasData.length - 10} registros más.`;\n}\n\nreturn {\n  chat_id: datosOriginales.chat_id,\n  texto: texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        7840
      ],
      "id": "dfbdeb08-2927-451b-872c-7124144aa3a3",
      "name": "Formatear Respuesta Horas Tarea"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -432,
        7840
      ],
      "id": "376c36ab-dee5-42c2-bef0-5cc3dcef0c42",
      "name": "Enviar Respuesta Horas Tarea",
      "webhookId": "webhook-horas-tarea-001"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de actividad temporal por usuario\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreUsuario = datosAI.usuario;\nconst periodo = datosAI.periodo;\n\nconsole.log('🔍 Consultando actividad de usuario:', nombreUsuario, 'en período:', periodo);\n\n// Validar datos\nif (!uid) throw new Error('No se pudo obtener el UID de autenticación');\nif (!nombreUsuario) throw new Error('No se encontró el nombre del usuario');\n\n// Si no hay período, enviar mensaje de ayuda por Telegram\nif (!periodo) {\n  const mensajeAyuda = `❌ **Período no especificado**\\n\\n` +\n    `👤 **Usuario:** \"${nombreUsuario}\"\\n\\n` +\n    `Para consultar la actividad de un usuario, necesitas especificar el período de tiempo.\\n\\n` +\n    `📅 **Períodos disponibles:**\\n` +\n    `• **hoy** - actividad de hoy\\n` +\n    `• **ayer** - actividad de ayer\\n` +\n    `• **esta semana** - actividad de esta semana\\n` +\n    `• **semana pasada** - actividad de la semana pasada\\n` +\n    `• **este mes** - actividad de este mes\\n` +\n    `• **mes pasado** - actividad del mes pasado\\n\\n` +\n    `💡 **Ejemplos:**\\n` +\n    `• \"¿qué ha hecho ${nombreUsuario} hoy?\"\\n` +\n    `• \"actividad de ${nombreUsuario} esta semana\"\\n` +\n    `• \"¿cuántas horas trabajó ${nombreUsuario} este mes?\"`;\n  \n  return {\n    accion: 'enviar_mensaje_directo',\n    chat_id: datosAI.chat_id,\n    texto: mensajeAyuda\n  };\n}\n\n// Calcular fechas según el período\nconst ahora = new Date();\nlet fechaInicio, fechaFin;\n\nswitch(periodo) {\n  case 'hoy':\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() + 1);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'ayer':\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() - 1);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'esta_semana':\n    // Calcular el lunes de esta semana (getDay(): 0=domingo, 1=lunes, etc.)\n    const diasDesdeInicioSemana = ahora.getDay() === 0 ? 6 : ahora.getDay() - 1; // Si es domingo, retroceder 6 días\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() - diasDesdeInicioSemana);\n    fechaInicio.setHours(0, 0, 0, 0); // Inicio del día\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() + 1);\n    fechaFin.setHours(0, 0, 0, 0); // Inicio del día siguiente\n    break;\n  case 'semana_pasada':\n    // Calcular el lunes de la semana pasada\n    const diasDesdeInicioSemanaAnterior = ahora.getDay() === 0 ? 6 : ahora.getDay() - 1;\n    const lunesSemanaAnterior = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() - diasDesdeInicioSemanaAnterior - 7);\n    fechaInicio = new Date(lunesSemanaAnterior);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(lunesSemanaAnterior.getFullYear(), lunesSemanaAnterior.getMonth(), lunesSemanaAnterior.getDate() + 7);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'este_mes':\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 1);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'mes_pasado':\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth() - 1, 1);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth(), 1);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  case 'mes_nombre':\n    // Para consultas de mes específico por nombre (ej: \"enero\", \"febrero\", etc.)\n    // Por defecto usar el mes actual si no se puede determinar el mes específico\n    fechaInicio = new Date(ahora.getFullYear(), ahora.getMonth(), 1);\n    fechaInicio.setHours(0, 0, 0, 0);\n    fechaFin = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 1);\n    fechaFin.setHours(0, 0, 0, 0);\n    break;\n  default:\n    throw new Error('Período no válido: ' + periodo);\n}\n\n// Formatear fechas para Odoo (YYYY-MM-DD)\nconst formatearFecha = (fecha) => {\n  return fecha.toISOString().split('T')[0];\n};\n\nconst fechaInicioStr = formatearFecha(fechaInicio);\nconst fechaFinStr = formatearFecha(fechaFin);\n\nconsole.log('📅 Fecha actual:', ahora.toISOString());\nconsole.log('📅 Día de la semana:', ahora.getDay(), '(0=domingo)');\nconsole.log('📅 Rango de fechas calculado:', fechaInicioStr, 'a', fechaFinStr);\nconsole.log('📅 FechaInicio completa:', fechaInicio.toISOString());\nconsole.log('📅 FechaFin completa:', fechaFin.toISOString());\n\n// Determinar el mejor término de búsqueda\nlet terminoBusqueda = nombreUsuario;\n\n// Mapeo específico para palabras clave comunes\nconst mapeoNombres = {\n  'administrador': 'administrator',\n  'admin': 'administrator',\n  'gerente': 'manager',\n  'desarrollador': 'developer',\n  'consultor': 'consultant',\n  'diseñador': 'designer'\n};\n\nconst nombreLower = nombreUsuario.toLowerCase();\nif (mapeoNombres[nombreLower]) {\n  terminoBusqueda = mapeoNombres[nombreLower];\n  console.log('🔄 Mapeando:', nombreUsuario, '→', terminoBusqueda);\n}\n\nconsole.log('🔍 Término de búsqueda final:', terminoBusqueda);\n\n// Buscar usando el término más apropiado con búsqueda flexible\nconst buscarUsuario = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"hr.employee\",\n      \"search_read\",\n      [\n        [\n          [\"name\", \"ilike\", `%${terminoBusqueda}%`]\n        ]\n      ],\n      {\n        fields: [\"id\", \"name\", \"user_id\"],\n        limit: 20\n      }\n    ]\n  }\n};\n\nconsole.log('🔍 Primero buscando usuario exacto:', JSON.stringify(buscarUsuario, null, 2));\n\nreturn {\n  ...datosAI,\n  payload: JSON.stringify(buscarUsuario),\n  fechaInicio: fechaInicioStr,\n  fechaFin: fechaFinStr,\n  periodoTexto: periodo.replace('_', ' '),\n  paso: 'buscar_usuario'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2000,
        8208
      ],
      "id": "bfefbcd7-6dcc-468b-972f-83a455a49249",
      "name": "Preparar Consulta Actividad Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1680,
        8208
      ],
      "id": "efc1fb69-a385-4e40-b154-510be4ccfec4",
      "name": "HTTP Consulta Actividad Usuario"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de actividad temporal por usuario\nconst datosOriginales = $('Procesar Búsqueda Usuario').item.json;\nconst actividadData = $json.result || [];\n\nconst nombreUsuario = datosOriginales.usuario;\nconst usuarioEncontrado = datosOriginales.usuarioEncontrado || nombreUsuario;\nconst periodo = datosOriginales.periodoTexto;\nconst fechaInicio = datosOriginales.fechaInicio;\nconst fechaFin = datosOriginales.fechaFin;\n\nconsole.log('📊 Formateando respuesta para usuario:', usuarioEncontrado);\nconsole.log('📊 Registros encontrados:', actividadData.length);\n\nif (!actividadData || actividadData.length === 0) {\n  let textoError = `❌ **Sin actividad registrada**\\n\\n`;\n  textoError += `👤 **Usuario:** \"${usuarioEncontrado}\"\\n`;\n  textoError += `📅 **Período:** ${periodo} (${fechaInicio} a ${fechaFin})\\n\\n`;\n  textoError += `No se encontraron registros de tiempo para este usuario en el período especificado.\\n\\n`;\n  textoError += `💡 **Sugerencias:**\\n`;\n  textoError += `• Verifica que el nombre del usuario sea correcto\\n`;\n  textoError += `• Intenta con un período más amplio\\n`;\n  textoError += `• Usa /listar usuarios para ver los usuarios disponibles`;\n  \n  return {\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\n// Calcular estadísticas\nlet totalHoras = 0;\nconst actividadPorProyecto = {};\nconst actividadPorTarea = {};\nconst actividadPorDia = {};\nconst usuarioReal = actividadData[0].user_id[1];\n\nactividadData.forEach(registro => {\n  const horas = parseFloat(registro.unit_amount || 0);\n  totalHoras += horas;\n  \n  // Agrupar por proyecto\n  const proyecto = registro.project_id ? registro.project_id[1] : 'Sin proyecto';\n  if (!actividadPorProyecto[proyecto]) {\n    actividadPorProyecto[proyecto] = { horas: 0, registros: 0 };\n  }\n  actividadPorProyecto[proyecto].horas += horas;\n  actividadPorProyecto[proyecto].registros++;\n  \n  // Agrupar por tarea\n  const tarea = registro.task_id ? registro.task_id[1] : 'Sin tarea específica';\n  if (!actividadPorTarea[tarea]) {\n    actividadPorTarea[tarea] = { horas: 0, registros: 0 };\n  }\n  actividadPorTarea[tarea].horas += horas;\n  actividadPorTarea[tarea].registros++;\n  \n  // Agrupar por día\n  const dia = registro.date;\n  if (!actividadPorDia[dia]) {\n    actividadPorDia[dia] = { horas: 0, registros: 0 };\n  }\n  actividadPorDia[dia].horas += horas;\n  actividadPorDia[dia].registros++;\n});\n\n// Construir respuesta\nlet texto = `⏰ **Actividad de ${usuarioReal}**\\n\\n`;\ntexto += `📅 **Período:** ${periodo} (${fechaInicio} a ${fechaFin})\\n\\n`;\ntexto += `📊 **Resumen:**\\n`;\ntexto += `• Total de horas: ${totalHoras.toFixed(2)}h\\n`;\ntexto += `• Registros: ${actividadData.length}\\n`;\ntexto += `• Promedio diario: ${(totalHoras / Object.keys(actividadPorDia).length).toFixed(2)}h\\n\\n`;\n\n// Mostrar proyectos trabajados\nconst proyectos = Object.entries(actividadPorProyecto)\n  .sort(([,a], [,b]) => b.horas - a.horas);\n\nif (proyectos.length > 0) {\n  texto += `🏗️ **Proyectos trabajados:**\\n`;\n  proyectos.forEach(([proyecto, datos]) => {\n    texto += `• ${proyecto}: ${datos.horas.toFixed(2)}h (${datos.registros} registros)\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar tareas principales\nconst tareas = Object.entries(actividadPorTarea)\n  .sort(([,a], [,b]) => b.horas - a.horas)\n  .slice(0, 5);\n\nif (tareas.length > 0) {\n  texto += `🎯 **Principales tareas:**\\n`;\n  tareas.forEach(([tarea, datos], index) => {\n    texto += `${index + 1}. ${tarea}: ${datos.horas.toFixed(2)}h\\n`;\n  });\n  texto += `\\n`;\n}\n\n// Mostrar actividad por días\nconst dias = Object.entries(actividadPorDia)\n  .sort(([a], [b]) => new Date(b) - new Date(a))\n  .slice(0, 7);\n\nif (dias.length > 0) {\n  texto += `📅 **Actividad diaria:**\\n`;\n  dias.forEach(([dia, datos]) => {\n    const fecha = new Date(dia).toLocaleDateString('es-ES');\n    texto += `• ${fecha}: ${datos.horas.toFixed(2)}h (${datos.registros} registros)\\n`;\n  });\n}\n\nreturn {\n  chat_id: datosOriginales.chat_id,\n  texto: texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -832,
        8208
      ],
      "id": "e9142b4f-a521-411f-a11a-b22514de67c3",
      "name": "Formatear Respuesta Actividad Usuario"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -400,
        8208
      ],
      "id": "df82dbef-bd27-4061-afa4-3b9019f3bbcb",
      "name": "Enviar Respuesta Actividad Usuario",
      "webhookId": "webhook-actividad-usuario-001"
    },
    {
      "parameters": {
        "jsCode": "// Procesar resultado de búsqueda de usuarios y preparar consulta de actividad\nconst datosOriginales = $('Preparar Consulta Actividad Usuario').item.json;\nconst usuariosBuscados = $json.result || [];\n\nconst nombreUsuario = datosOriginales.usuario;\nconst fechaInicio = datosOriginales.fechaInicio;\nconst fechaFin = datosOriginales.fechaFin;\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconsole.log('👥 Usuarios encontrados:', usuariosBuscados.length);\nconsole.log('👥 Lista de usuarios:', usuariosBuscados.map(u => u.name));\n\nif (!usuariosBuscados || usuariosBuscados.length === 0) {\n  // No se encontró el usuario\n  const textoError = `❌ **Usuario no encontrado**\\n\\n` +\n    `👤 **Usuario buscado:** \"${nombreUsuario}\"\\n\\n` +\n    `No se encontró ningún usuario con ese nombre.\\n\\n` +\n    `💡 **Sugerencias:**\\n` +\n    `• Verifica que el nombre del usuario sea correcto\\n` +\n    `• Intenta con solo el nombre sin apellidos\\n` +\n    `• Intenta con variaciones como \"admin\", \"administrador\", etc.`;\n  \n  return {\n    accion: 'enviar_mensaje_directo',\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\n// Buscar la mejor coincidencia\nlet usuarioSeleccionado = usuariosBuscados[0];\n\n// Buscar coincidencia exacta (sin distinguir mayúsculas/minúsculas)\nconst coincidenciaExacta = usuariosBuscados.find(user => \n  user.name.toLowerCase() === nombreUsuario.toLowerCase()\n);\n\nif (coincidenciaExacta) {\n  usuarioSeleccionado = coincidenciaExacta;\n  console.log('✅ Coincidencia exacta encontrada:', usuarioSeleccionado.name);\n} else {\n  console.log('⚠️ No hay coincidencia exacta, usando primera opción:', usuarioSeleccionado.name);\n}\n\nconsole.log('👤 Empleado seleccionado:', usuarioSeleccionado.name, 'Employee ID:', usuarioSeleccionado.id, 'User ID:', usuarioSeleccionado.user_id);\n\n// Verificar que el empleado tenga un user_id asociado\nif (!usuarioSeleccionado.user_id) {\n  const textoError = `❌ **Empleado sin usuario asociado**\\n\\n` +\n    `👤 **Empleado encontrado:** \"${usuarioSeleccionado.name}\"\\n\\n` +\n    `Este empleado no tiene un usuario de sistema asociado para registrar horas.\\n\\n` +\n    `💡 **Sugerencia:**\\n` +\n    `• Contacta al administrador para asociar un usuario a este empleado`;\n  \n  return {\n    accion: 'enviar_mensaje_directo',\n    chat_id: datosOriginales.chat_id,\n    texto: textoError\n  };\n}\n\nconst userIdDelEmpleado = usuarioSeleccionado.user_id[0]; // user_id es un array [id, \"nombre\"]\n\n// Ahora buscar actividad del usuario usando su user_id exacto\nconst consultarActividad = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"search_read\",\n      [\n        [\n          [\"user_id\", \"=\", userIdDelEmpleado],\n          [\"date\", \">=\", fechaInicio],\n          [\"date\", \"<\", fechaFin]\n        ]\n      ],\n      {\n        fields: [\n          \"date\", \"unit_amount\", \"name\", \"task_id\", \"project_id\", \"user_id\"\n        ],\n        order: \"date desc\"\n      }\n    ]\n  }\n};\n\nconsole.log('🔍 Consultando actividad con User ID exacto:', userIdDelEmpleado);\nconsole.log('📅 Filtros:', `[\"user_id\", \"=\", ${userIdDelEmpleado}], [\"date\", \">=\", \"${fechaInicio}\"], [\"date\", \"<\", \"${fechaFin}\"]`);\n\nreturn {\n  ...datosOriginales,\n  payload: JSON.stringify(consultarActividad),\n  usuarioEncontrado: usuarioSeleccionado.name,\n  usuarioId: usuarioSeleccionado.id,\n  paso: 'consultar_actividad'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1392,
        8208
      ],
      "id": "e443bf71-c78c-47fd-b52d-95532df77182",
      "name": "Procesar Búsqueda Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1104,
        8208
      ],
      "id": "1ab04001-8f8d-4a4d-9972-62b3c6d0936d",
      "name": "HTTP Consulta Actividad Usuario Final"
    },
    {
      "parameters": {
        "content": "## Consulta proyecto horas\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3808,
        7280
      ],
      "typeVersion": 1,
      "id": "8f635f71-588e-4c1f-8bac-a21ed051b2fd",
      "name": "Sticky Note - Ventas Perdidas1"
    },
    {
      "parameters": {
        "content": "## Consulta tareas horas\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3856,
        7680
      ],
      "typeVersion": 1,
      "id": "c61606c5-e851-4c0f-8ba3-70fffa35bdde",
      "name": "Sticky Note - Ventas Perdidas2"
    },
    {
      "parameters": {
        "content": "## Consulta horas empleado\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3872,
        8080
      ],
      "typeVersion": 1,
      "id": "e9819926-4527-4fde-a2cd-242dfd3bcafb",
      "name": "Sticky Note - Ventas Perdidas3"
    },
    {
      "parameters": {
        "content": "## Consulta ausencias\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3872,
        8480
      ],
      "typeVersion": 1,
      "id": "f5bab38e-549c-4d81-a65d-e2e1efbea74f",
      "name": "Sticky Note - Ausencias"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de eventos de usuario desde AI Agent — con soporte de meses y año actual\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreUsuario = datosAI.usuario;\nconst periodoEntrada = datosAI.periodo || 'hoy';\nconst fechaEspecifica = datosAI.fecha_especifica;\nconst mensajeOriginal = (\n  datosAI.mensaje_ia ||\n  datosAI.mensaje_original ||\n  datosAI.mensaje ||\n  ''\n).toString().toLowerCase();\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\n// Validar que tenemos nombre del usuario\nif (!nombreUsuario) {\n  throw new Error('No se encontró el nombre del usuario');\n}\n\n// Mapa de meses en español\nconst meses = {\n  'enero':1,'ene':1,\n  'febrero':2,'feb':2,\n  'marzo':3,'mar':3,\n  'abril':4,'abr':4,\n  'mayo':5,'may':5,\n  'junio':6,'jun':6,\n  'julio':7,'jul':7,\n  'agosto':8,'ago':8,\n  'septiembre':9,'setiembre':9,'septiebre':9,'sept':9,'sep':9,\n  'octubre':10,'oct':10,\n  'noviembre':11,'nov':11,\n  'diciembre':12,'dic':12,\n};\n\nconst hoy = new Date();\nconst curY = hoy.getFullYear();\nconst pad = (n) => String(n).padStart(2, '0');\nconst toISO = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;\nconst lastDay = (y,m) => new Date(y, m, 0).getDate();\nconst normYear = (y) => (y < 100 ? 2000 + y : y);\n\nlet fechaInicio = null;\nlet fechaFin = null;\n\n// --- Detectar mes específico en el mensaje ---\nconst msgNorm = mensajeOriginal\n  .normalize('NFD')\n  .replace(/[\\u0300-\\u036f]/g, '')\n  .replace(/\\s+/g, ' ')\n  .trim();\n\nlet mesMatch = null;\nfor (const [nombreMes, numeroMes] of Object.entries(meses)) {\n  const regex = new RegExp(`\\\\b${nombreMes}\\\\b`, 'i');\n  if (msgNorm.match(regex)) {\n    mesMatch = numeroMes;\n    console.log(`📅 Mes detectado: ${nombreMes} (${numeroMes})`);\n    break;\n  }\n}\n\n// Si detectamos un mes, procesar todo el mes del año actual\nif (mesMatch) {\n  const ld = lastDay(curY, mesMatch);\n  fechaInicio = toISO(curY, mesMatch, 1);\n  fechaFin = toISO(curY, mesMatch, ld);\n  console.log(`📆 Periodo del mes completo: ${fechaInicio} - ${fechaFin}`);\n}\n\n// Si no hay mes detectado, usar switch tradicional\nif (!fechaInicio) {\n  switch (periodoEntrada) {\n    case 'hoy':\n      fechaInicio = hoy.toISOString().split('T')[0];\n      fechaFin = hoy.toISOString().split('T')[0];\n      break;\n      \n    case 'esta_semana':\n      const inicioSemana = new Date(hoy);\n      inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1); // Lunes\n      const finSemana = new Date(inicioSemana);\n      finSemana.setDate(inicioSemana.getDate() + 6); // Domingo\n      \n      fechaInicio = inicioSemana.toISOString().split('T')[0];\n      fechaFin = finSemana.toISOString().split('T')[0];\n      break;\n      \n    case 'este_mes':\n      const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);\n      const finMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);\n      \n      fechaInicio = inicioMes.toISOString().split('T')[0];\n      fechaFin = finMes.toISOString().split('T')[0];\n      break;\n      \n    default:\n      // Revisar si el periodo es un mes directamente\n      if (meses[periodoEntrada]) {\n        const mNum = meses[periodoEntrada];\n        const ld = lastDay(curY, mNum);\n        fechaInicio = toISO(curY, mNum, 1);\n        fechaFin = toISO(curY, mNum, ld);\n      }\n      // Para fechas específicas\n      else if (fechaEspecifica) {\n        fechaInicio = fechaEspecifica;\n        fechaFin = fechaEspecifica;\n      } else {\n        // Default a hoy\n        fechaInicio = hoy.toISOString().split('T')[0];\n        fechaFin = hoy.toISOString().split('T')[0];\n      }\n  }\n}\n\nconsole.log('📅 Preparando consulta de eventos:');\nconsole.log('👤 Usuario:', nombreUsuario);\nconsole.log('📅 Período entrada:', periodoEntrada);\nconsole.log('📅 Fecha inicio:', fechaInicio);\nconsole.log('📅 Fecha fin:', fechaFin);\n\n// Primero buscar el usuario por nombre\nconst buscarUsuario = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.users\",\n      \"search_read\",\n      [\n        [[\"name\", \"ilike\", nombreUsuario]]\n      ],\n      {\n        fields: [\"id\", \"name\", \"partner_id\"],\n        limit: 10\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: buscarUsuario,\n  usuario: nombreUsuario,\n  periodo: periodoEntrada,\n  fechaInicio: fechaInicio,\n  fechaFin: fechaFin,\n  chat_id: datosAI.chat_id,\n  uid: uid,\n  paso: 'buscar_usuario'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2000,
        9056
      ],
      "id": "91eaaead-ed83-4d09-9482-9bd9282ee025",
      "name": "Preparar Consulta Eventos Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1696,
        9056
      ],
      "id": "070ee1ce-fb2f-407e-bb98-c8652b8ac4ea",
      "name": "HTTP Buscar Usuario Eventos"
    },
    {
      "parameters": {
        "jsCode": "// Procesar resultado de búsqueda de usuario y preparar consulta de eventos\nconst resultadoBusqueda = $json.result || [];\nconst datosConsulta = $('Preparar Consulta Eventos Usuario').item.json;\nconst uid = datosConsulta.uid;\nconst fechaInicio = datosConsulta.fechaInicio;\nconst fechaFin = datosConsulta.fechaFin;\n\nconsole.log('👤 Resultado búsqueda usuario:', resultadoBusqueda.length, 'usuarios encontrados');\n\nif (resultadoBusqueda.length === 0) {\n  return {\n    chat_id: datosConsulta.chat_id,\n    error: true,\n    mensaje: `❌ **Usuario no encontrado**\\n\\nNo se encontró ningún usuario con el nombre \"${datosConsulta.usuario}\".\\n\\n💡 **Sugerencia:** Verifica que el nombre esté escrito correctamente.`\n  };\n}\n\n// Tomar el primer usuario encontrado\nconst usuario = resultadoBusqueda[0];\nconst userId = usuario.id;\nconst userName = usuario.name;\nconst partnerId = usuario.partner_id[0];\n\nconsole.log('✅ Usuario encontrado:', userName, 'ID:', userId, 'Partner ID:', partnerId);\n\n// Preparar consulta de eventos del calendario\n// Buscar en calendar.event filtrando por partner_id del usuario\nconst consultaEventos = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"calendar.event\",\n      \"search_read\",\n      [\n        [\n          \"&\",\n          \"&\",\n          [\"partner_ids\", \"in\", [partnerId]],\n          [\"start\", \">=\", fechaInicio + \" 00:00:00\"],\n          [\"stop\", \"<=\", fechaFin + \" 23:59:59\"]\n        ]\n      ],\n      {\n        fields: [\n          \"id\", \"name\", \"description\", \"start\", \"stop\", \n          \"duration\", \"partner_ids\", \"user_id\", \"location\",\n          \"privacy\", \"show_as\"\n        ],\n        order: \"start asc\"\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultaEventos,\n  usuario: userName,\n  userId: userId,\n  partnerId: partnerId,\n  periodo: datosConsulta.periodo,\n  fechaInicio: fechaInicio,\n  fechaFin: fechaFin,\n  chat_id: datosConsulta.chat_id,\n  paso: 'consultar_eventos'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1392,
        9056
      ],
      "id": "655af408-49e1-4419-978c-ac291d5b89d6",
      "name": "Procesar Usuario y Consultar Eventos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1104,
        9056
      ],
      "id": "d46f0027-62f6-488c-9712-f085dd7ac4fb",
      "name": "HTTP Consulta Eventos Final"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de eventos de usuario\nconst eventos = $json.result || [];\nconst datosConsulta = $('Procesar Usuario y Consultar Eventos').item.json;\nconst usuario = datosConsulta.usuario;\nconst periodo = datosConsulta.periodo;\nconst fechaInicio = datosConsulta.fechaInicio;\nconst fechaFin = datosConsulta.fechaFin;\n\n// Verificar si hay error\nif (datosConsulta.error) {\n  return {\n    chat_id: datosConsulta.chat_id,\n    texto: datosConsulta.mensaje\n  };\n}\n\nconsole.log('📅 Eventos encontrados:', eventos.length);\nconsole.log('📋 Lista de eventos:', eventos.map(e => `${e.name} - ${e.start}`));\n\nlet titulo = '';\nlet icono = '📅';\n\nswitch (periodo) {\n  case 'hoy':\n    titulo = `Agenda de ${usuario} para Hoy`;\n    icono = '📅';\n    break;\n  case 'esta_semana':\n    titulo = `Eventos de ${usuario} Esta Semana`;\n    icono = '📆';\n    break;\n  case 'este_mes':\n    titulo = `Calendario de ${usuario} Este Mes`;\n    icono = '🗓️';\n    break;\n  default:\n    titulo = `Eventos de ${usuario} del ${fechaInicio} al ${fechaFin}`;\n    icono = '📋';\n}\n\nlet texto = `${icono} **${titulo}**\\n\\n`;\n\nif (eventos.length === 0) {\n  texto += `✅ **¡Agenda libre!**\\n\\n`;\n  texto += `${usuario} no tiene eventos programados para ${periodo === 'hoy' ? 'hoy' : 'este período'}.\\n`;\n  texto += `${periodo === 'hoy' ? '🎯 Día perfecto para enfocarse en tareas pendientes.' : '⚡ Período disponible para nuevos compromisos.'}`;\n} else {\n  texto += `📋 **${eventos.length} evento${eventos.length > 1 ? 's' : ''} programado${eventos.length > 1 ? 's' : ''}:**\\n\\n`;\n  \n  // Agrupar eventos por día\n  const eventosPorDia = {};\n  \n  eventos.forEach(evento => {\n    const fechaEvento = new Date(evento.start);\n    const fechaStr = fechaEvento.toLocaleDateString('es-ES', {\n      weekday: 'long',\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric'\n    });\n    \n    if (!eventosPorDia[fechaStr]) {\n      eventosPorDia[fechaStr] = [];\n    }\n    eventosPorDia[fechaStr].push(evento);\n  });\n  \n  // Formatear cada día\n  Object.keys(eventosPorDia).forEach((fecha, indexDia) => {\n    const eventosDelDia = eventosPorDia[fecha];\n    \n    texto += `**📅 ${fecha.charAt(0).toUpperCase() + fecha.slice(1)}**\\n`;\n    \n    eventosDelDia.forEach((evento, index) => {\n      const fechaInicio = new Date(evento.start);\n      const fechaFin = new Date(evento.stop);\n      const horaInicio = fechaInicio.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });\n      const horaFin = fechaFin.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });\n      \n      let iconoEvento = '🕐';\n      if (evento.name.toLowerCase().includes('reunion')) iconoEvento = '👥';\n      else if (evento.name.toLowerCase().includes('cita')) iconoEvento = '🤝';\n      else if (evento.name.toLowerCase().includes('llamada')) iconoEvento = '📞';\n      else if (evento.name.toLowerCase().includes('demo')) iconoEvento = '💻';\n      else if (evento.name.toLowerCase().includes('formacion')) iconoEvento = '📚';\n      \n      texto += `   ${iconoEvento} **${horaInicio} - ${horaFin}** | ${evento.name}`;\n      \n      if (evento.location) {\n        texto += ` 📍 ${evento.location}`;\n      }\n      \n      if (evento.description && evento.description.trim() !== '') {\n        const descripcionCorta = evento.description.length > 50 \n          ? evento.description.substring(0, 50) + '...' \n          : evento.description;\n        texto += `\\n      💬 _${descripcionCorta}_`;\n      }\n      \n      const duracionMinutos = Math.round(evento.duration * 60);\n      const horas = Math.floor(duracionMinutos / 60);\n      const minutos = duracionMinutos % 60;\n      let duracionTexto = '';\n      if (horas > 0) duracionTexto += `${horas}h`;\n      if (minutos > 0) duracionTexto += `${minutos}m`;\n      if (duracionTexto) texto += ` ⏱️ ${duracionTexto}`;\n      \n      texto += '\\n\\n';\n    });\n  });\n  \n  // Agregar resumen\n  const totalDuracion = eventos.reduce((total, e) => total + e.duration, 0);\n  const horasTotal = Math.floor(totalDuracion);\n  const minutosTotal = Math.round((totalDuracion - horasTotal) * 60);\n  \n  let tiempoTotal = '';\n  if (horasTotal > 0) tiempoTotal += `${horasTotal}h`;\n  if (minutosTotal > 0) tiempoTotal += `${minutosTotal}m`;\n  \n  texto += `📊 **Resumen:** ${eventos.length} evento${eventos.length > 1 ? 's' : ''}`;\n  if (tiempoTotal) texto += ` | ${tiempoTotal} de duración total`;\n}\n\ntexto += `\\n\\n📅 **Período consultado:** ${fechaInicio}${fechaInicio !== fechaFin ? ` al ${fechaFin}` : ''}`;\n\nreturn {\n  chat_id: datosConsulta.chat_id,\n  texto: texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -800,
        9056
      ],
      "id": "716b242d-3a9e-43ff-bddb-3784d3208260",
      "name": "Formatear Respuesta Eventos"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -496,
        9056
      ],
      "id": "a24b5e44-0d80-4212-9f4a-e64984ddbb68",
      "name": "Enviar Respuesta Eventos",
      "webhookId": "webhook-eventos-001"
    },
    {
      "parameters": {
        "content": "## Consulta eventos usuario\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3872,
        8880
      ],
      "typeVersion": 1,
      "id": "1a4d8877-b1ca-4539-bf17-e27d4f570fb0",
      "name": "Sticky Note - Eventos Usuario"
    },
    {
      "parameters": {
        "jsCode": "// Calcular ventas del mes anterior para comparación porcentual\nconst ventasActuales = $json.result || [];\nconst datosConsulta = $('Preparar Consulta Ventas').item.json;\nconst uid = datosConsulta.uid;\nconst tipoConsulta = datosConsulta.tipo_consulta;\n\n// Solo calcular comparación para consultas de mes actual\nif (tipoConsulta !== 'mes_actual') {\n  console.log('📊 No es consulta de mes actual, saltando comparación');\n  return {\n    ...arguments[0],\n    skip_comparacion: true,\n    ventas_actuales: ventasActuales,\n    total_actual: ventasActuales.reduce((acc, v) => acc + (v.amount_total || 0), 0)\n  };\n}\n\nconsole.log('📊 Calculando comparación con mes anterior');\n\n// Calcular fechas del mes anterior\nconst now = new Date();\nlet yearAnterior = now.getFullYear();\nlet monthAnterior = now.getMonth(); // getMonth() devuelve 0-11\n\nif (monthAnterior === 0) {\n  monthAnterior = 12;\n  yearAnterior = yearAnterior - 1;\n}\n\nconst mesAnterior = monthAnterior < 10 ? `0${monthAnterior}` : `${monthAnterior}`;\nconst primerDiaAnterior = `${yearAnterior}-${mesAnterior}-01`;\n\nconst siguienteMesAnterior = monthAnterior === 12 ? 1 : monthAnterior + 1;\nconst siguienteAnioAnterior = monthAnterior === 12 ? yearAnterior + 1 : yearAnterior;\nconst mesSiguienteAnterior = siguienteMesAnterior < 10 ? `0${siguienteMesAnterior}` : `${siguienteMesAnterior}`;\nconst primerDiaSiguienteMesAnterior = `${siguienteAnioAnterior}-${mesSiguienteAnterior}-01`;\n\nconsole.log('📅 Rango mes anterior:', primerDiaAnterior, 'a', primerDiaSiguienteMesAnterior);\n\n// Preparar consulta para mes anterior\nconst consultaMesAnterior = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"sale.order\",\n      \"search_read\",\n      [[\n        [\"date_order\", \">=\", primerDiaAnterior],\n        [\"date_order\", \"<\", primerDiaSiguienteMesAnterior]\n      ]],\n      { fields: [\"amount_total\"] }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\n// Calcular total del mes actual\nconst totalActual = ventasActuales.reduce((acc, v) => acc + (v.amount_total || 0), 0);\n\nreturn {\n  payload: consultaMesAnterior,\n  ventas_actuales: ventasActuales,\n  total_actual: totalActual,\n  datos_consulta: datosConsulta,\n  fecha_mes_anterior: {\n    inicio: primerDiaAnterior,\n    fin: primerDiaSiguienteMesAnterior\n  },\n  skip_comparacion: false\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        1952
      ],
      "id": "8ea50650-c80e-4801-a3fb-457db45e9081",
      "name": "Calcular Comparación Mes Anterior"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.skip_comparacion ? JSON.stringify({ jsonrpc: \"2.0\", method: \"call\", params: {}, id: 1 }) : JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -352,
        1952
      ],
      "id": "95f5349e-e056-4149-8dfb-c83cce500d01",
      "name": "HTTP Consultar Mes Anterior"
    },
    {
      "parameters": {
        "jsCode": "// Procesar resultado y calcular porcentaje de comparación\nconst ventasMesAnterior = $json.result || [];\nconst datosComparacion = $('Calcular Comparación Mes Anterior').item.json;\n\n// Si se saltó la comparación, devolver datos originales\nif (datosComparacion.skip_comparacion) {\n  console.log('📊 Saltando procesamiento de comparación');\n  return {\n    result: datosComparacion.ventas_actuales,\n    total_actual: datosComparacion.total_actual,\n    comparacion: null\n  };\n}\n\n// Calcular total del mes anterior\nconst totalMesAnterior = ventasMesAnterior.reduce((acc, v) => acc + (v.amount_total || 0), 0);\nconst totalActual = datosComparacion.total_actual;\n\nconsole.log('💰 Total mes actual:', totalActual);\nconsole.log('💰 Total mes anterior:', totalMesAnterior);\n\n// Calcular porcentaje de comparación (crecimiento/decrecimiento)\nlet porcentajeCambio = 0;\nlet porcentajeTotal = 0;\nlet tendencia = 'igual';\nlet diferencia = totalActual - totalMesAnterior;\n\nif (totalMesAnterior > 0) {\n  // Porcentaje de cambio respecto al mes anterior\n  porcentajeCambio = ((diferencia / totalMesAnterior) * 100);\n  // Porcentaje total (para referencia)\n  porcentajeTotal = ((totalActual / totalMesAnterior) * 100);\n  \n  if (totalActual > totalMesAnterior) {\n    tendencia = 'crecimiento';\n  } else if (totalActual < totalMesAnterior) {\n    tendencia = 'decrecimiento';\n  }\n} else if (totalActual > 0) {\n  // Si el mes anterior fue 0 pero este mes hay ventas\n  porcentajeCambio = Infinity;\n  porcentajeTotal = Infinity;\n  tendencia = 'nuevo';\n}\n\nconst comparacion = {\n  total_mes_anterior: totalMesAnterior,\n  total_mes_actual: totalActual,\n  diferencia: diferencia,\n  porcentaje_cambio: porcentajeCambio,\n  porcentaje_total: porcentajeTotal,\n  tendencia: tendencia,\n  fecha_comparacion: datosComparacion.fecha_mes_anterior\n};\n\nconsole.log('📈 Comparación calculada:', comparacion);\n\nreturn {\n  result: datosComparacion.ventas_actuales,\n  total_actual: totalActual,\n  comparacion: comparacion,\n  datos_consulta: datosComparacion.datos_consulta\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -192,
        1952
      ],
      "id": "05a713d8-d553-42a3-9de3-0c7e0ed68a24",
      "name": "Procesar Comparación Porcentual"
    },
    {
      "parameters": {
        "jsCode": "// Extraer usuario de Odoo del mensaje 'mi usuario de odoo es xxx'\nconst mensaje = $json.mensaje_usuario || $json.mensaje_original || '';\nconst chatId = $json.chat_id;\nconst userId = $json.user_id;\nconst userName = $json.user_name;\n\nconsole.log('🔍 === EXTRAER USUARIO ODOO ===');\nconsole.log('📝 Mensaje:', mensaje);\n\n// Buscar patrón 'mi usuario de odoo es xxx'\nconst regex = /mi\\s+usuario\\s+de\\s+odoo\\s+es\\s+([^\\s]+)/i;\nconst match = mensaje.match(regex);\n\nlet usuarioOdoo = null;\nif (match && match[1]) {\n  usuarioOdoo = match[1].trim();\n  console.log('✅ Usuario extraído:', usuarioOdoo);\n} else {\n  console.log('❌ No se encontró patrón de usuario');\n  throw new Error('No se pudo extraer el usuario de Odoo del mensaje');\n}\n\nreturn {\n  chat_id: chatId,\n  user_id: userId,\n  user_name: userName,\n  usuario_odoo: usuarioOdoo,\n  mensaje_original: mensaje\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2128,
        12176
      ],
      "id": "03bcfb84-5273-4e43-a81e-0f7c4cc244f2",
      "name": "Extraer Usuario Odoo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\"jsonrpc\": \"2.0\", \"method\": \"call\", \"params\": {\"service\": \"common\", \"method\": \"authenticate\", \"args\": [\"lsanchezgoshawk-n8npruebas-main-25736898\", \"admin\", \"admin\", {}]}, \"id\": 1}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1920,
        12176
      ],
      "id": "d4c5fcf1-1a5d-45b4-9ea5-b0c9736ef1ec",
      "name": "Autenticar Odoo Registro"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta para verificar si el usuario existe en Odoo\nconst datosUsuario = $('Extraer Usuario Odoo').item.json;\nconst uid = $json.result;\nconst usuarioOdoo = datosUsuario.usuario_odoo;\n\nif (!uid) {\n  throw new Error('Error en autenticación de Odoo');\n}\n\nconsole.log('🔍 === VERIFICAR USUARIO EN ODOO ===');\nconsole.log('🔑 UID:', uid);\nconsole.log('👤 Usuario a verificar:', usuarioOdoo);\n\n// Consultar si el usuario existe en res.users\nconst consultaUsuario = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.users\",\n      \"search_read\",\n      [\n        [\n          [\"login\", \"=\", usuarioOdoo]\n        ]\n      ],\n      {\n        fields: [\"id\", \"login\", \"name\"],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultaUsuario,\n  usuario_odoo: usuarioOdoo,\n  chat_id: datosUsuario.chat_id,\n  user_id: datosUsuario.user_id,\n  user_name: datosUsuario.user_name,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1696,
        12176
      ],
      "id": "2360926a-cae6-4d82-bfc1-dbca28641691",
      "name": "Preparar Verificar Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1488,
        12176
      ],
      "id": "6c25fe16-31f0-4734-a537-b70fb1e89ac6",
      "name": "HTTP Verificar Usuario Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Evaluar si el usuario existe en Odoo y devolver true/false\nconst respuestaOdoo = $('HTTP Verificar Usuario Odoo').item.json;\nconst datosUsuario = $('Preparar Verificar Usuario').item.json;\n\nconsole.log('🔍 === EVALUAR EXISTENCIA USUARIO ===');\nconsole.log('📋 Respuesta Odoo:', JSON.stringify(respuestaOdoo, null, 2));\nconsole.log('👤 Usuario buscado:', datosUsuario.usuario_odoo);\n\n// Verificar si existe resultado\nconst usuarioExiste = respuestaOdoo.result && \n                     Array.isArray(respuestaOdoo.result) && \n                     respuestaOdoo.result.length > 0;\n\nconsole.log('✅ Usuario existe:', usuarioExiste);\n\nif (usuarioExiste) {\n  console.log('👍 Usuario encontrado:', respuestaOdoo.result[0]);\n} else {\n  console.log('❌ Usuario no encontrado en Odoo');\n}\n\n// Devolver todos los datos necesarios + el resultado booleano\nreturn {\n  usuario_existe: usuarioExiste,\n  usuario_odoo: datosUsuario.usuario_odoo,\n  chat_id: datosUsuario.chat_id,\n  user_id: datosUsuario.user_id,\n  user_name: datosUsuario.user_name,\n  uid: datosUsuario.uid,\n  respuesta_odoo: respuestaOdoo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1392,
        12176
      ],
      "id": "ab116f9b-1c47-44c4-8d15-64042f1fd80c",
      "name": "Evaluar Existencia Usuario"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": "telegram_users",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "user_id": "={{ $json.user_id }}",
            "user_name": "={{ $json.user_name }}",
            "chat_id": "={{ $json.chat_id }}",
            "odoo_user": "={{ $json.usuario_odoo }}",
            "first_seen": "={{ new Date().toISOString() }}",
            "last_seen": "={{ new Date().toISOString() }}",
            "is_active": true
          },
          "matchingColumns": [
            "user_id"
          ],
          "schema": [
            {
              "id": "user_id",
              "displayName": "user_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "user_name",
              "displayName": "user_name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "first_seen",
              "displayName": "first_seen",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "last_seen",
              "displayName": "last_seen",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "odoo_user",
              "displayName": "odoo_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "restricted_modules",
              "displayName": "restricted_modules",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "is_admin",
              "displayName": "is_admin",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -800,
        12064
      ],
      "id": "e2901ca1-c9c0-49d3-aba2-3a546009c852",
      "name": "Actualizar Usuario Telegram"
    },
    {
      "parameters": {
        "chatId": "={{ $('Evaluar Existencia Usuario').item.json.chat_id }}",
        "text": "✅ ¡Perfecto! Tu usuario de Odoo *{{ $('Evaluar Existencia Usuario').item.json.usuario_odoo }}* ha sido registrado correctamente.\n\nYa puedes usar todas las funciones del bot sin problemas 🚀\n\n¡Gracias por configurar tu cuenta!",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -592,
        12064
      ],
      "id": "310c16be-d96e-4e2f-93ed-3f33a0f72bcd",
      "name": "Mensaje Usuario Registrado",
      "webhookId": "2a404676-1111-4ebc-952a-b85a6cfe2f42"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Usuario Odoo').item.json.chat_id }}",
        "text": "❌ El usuario *{{ $('Extraer Usuario Odoo').item.json.usuario_odoo }}* no existe en nuestro sistema Odoo.\n\nPor favor, verifica que:\n• El nombre de usuario sea correcto\n• Tengas acceso al sistema\n• No haya espacios adicionales\n\nIntenta de nuevo con:\n*Mi usuario de Odoo es usuario_correcto*",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1008,
        12368
      ],
      "id": "bac11938-5206-46c4-978c-1146e64205ee",
      "name": "Mensaje Usuario No Existe",
      "webhookId": "3fd407f5-6b77-40b8-9332-7bc0470e6b2b"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta para ranking de comerciales\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst tipoConsulta = datosAI.tipo_consulta;\nconst parametro = datosAI.parametro;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nlet fechaDesde, fechaHasta;\nconst ahora = new Date();\n\n// Calcular fechas según el tipo de consulta\nif (tipoConsulta === 'mes_actual') {\n  const year = ahora.getFullYear();\n  const month = ahora.getMonth() + 1;\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  fechaDesde = `${year}-${mes}-01`;\n  fechaHasta = `${year}-${mes}-${new Date(year, month, 0).getDate()}`;\n} \nelse if (tipoConsulta === 'mes_pasado') {\n  let year = ahora.getFullYear();\n  let month = ahora.getMonth();\n  if (month === 0) {\n    month = 12;\n    year = year - 1;\n  }\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  fechaDesde = `${year}-${mes}-01`;\n  fechaHasta = `${year}-${mes}-${new Date(year, month, 0).getDate()}`;\n}\nelse if (tipoConsulta === 'mes_nombre') {\n  const meses = [\n    \"enero\", \"febrero\", \"marzo\", \"abril\", \"mayo\", \"junio\",\n    \"julio\", \"agosto\", \"septiembre\", \"octubre\", \"noviembre\", \"diciembre\"\n  ];\n  const mesIndex = meses.indexOf(parametro.toLowerCase());\n  if (mesIndex !== -1) {\n    let year = ahora.getFullYear();\n    // Si el mes es futuro, usar año anterior\n    if (mesIndex + 1 > (ahora.getMonth() + 1)) {\n      year = year - 1;\n    }\n    const mes = (mesIndex + 1) < 10 ? `0${mesIndex + 1}` : `${mesIndex + 1}`;\n    fechaDesde = `${year}-${mes}-01`;\n    fechaHasta = `${year}-${mes}-${new Date(year, mesIndex + 1, 0).getDate()}`;\n  }\n}\n\nconsole.log('📊 RANKING COMERCIALES - Preparando consulta:');\nconsole.log('   📅 Período:', tipoConsulta, parametro);\nconsole.log('   📅 Desde:', fechaDesde);\nconsole.log('   📅 Hasta:', fechaHasta);\n\n// Consulta para obtener facturas con comercial (invoice_user_id)\nconst consultaFacturas = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"account.move\",\n      \"search_read\",\n      [[\n        [\"move_type\", \"=\", \"out_invoice\"],\n        [\"invoice_date\", \">=\", fechaDesde],\n        [\"invoice_date\", \"<=\", fechaHasta],\n        [\"state\", \"in\", [\"draft\", \"posted\"]],  // Facturas pendientes Y facturadas\n        [\"invoice_user_id\", \"!=\", false]  // Debe tener comercial asignado\n      ]],\n      { \n        fields: [\n          \"name\", \"partner_id\", \"amount_total\", \"invoice_date\", \n          \"state\", \"invoice_user_id\"\n        ],\n        order: \"amount_total desc\",\n        limit: 1000\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultaFacturas,\n  tipo_consulta: tipoConsulta,\n  parametro: parametro,\n  fecha_desde: fechaDesde,\n  fecha_hasta: fechaHasta,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2016,
        9472
      ],
      "id": "08e403a1-329f-4b75-9c8e-3e599e6d1967",
      "name": "Preparar Consulta Ranking Comerciales"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1744,
        9472
      ],
      "id": "1c4142d4-1bdf-47a8-bb10-fc00708c84fe",
      "name": "HTTP Consultar Facturas Comerciales"
    },
    {
      "parameters": {
        "jsCode": "// Formatear ranking de comerciales\nconst respuestaOdoo = $json.result || [];\nconst datosConsulta = $('Preparar Consulta Ranking Comerciales').item.json;\n\nconsole.log('👔 FORMATEAR RANKING COMERCIALES:');\nconsole.log('   📊 Facturas recibidas:', respuestaOdoo.length);\nconsole.log('   📅 Período:', datosConsulta.tipo_consulta, datosConsulta.parametro);\n\nif (!Array.isArray(respuestaOdoo) || respuestaOdoo.length === 0) {\n  return {\n    texto: `👔 **RANKING COMERCIALES**\\n\\n❌ No se encontraron facturas en el período solicitado.`,\n    chat_id: datosConsulta.chat_id\n  };\n}\n\n// Agrupar por comercial y calcular totales\nconst comerciales = {};\n\nrespuestaOdoo.forEach(factura => {\n  const comercialId = factura.invoice_user_id?.[0];\n  const comercialNombre = factura.invoice_user_id?.[1] || 'Sin asignar';\n  const monto = parseFloat(factura.amount_total || 0);\n  const estado = factura.state;\n  \n  if (!comerciales[comercialId]) {\n    comerciales[comercialId] = {\n      nombre: comercialNombre,\n      total_facturado: 0,\n      facturas_pendientes: 0,\n      facturas_cobradas: 0,\n      monto_pendiente: 0,\n      monto_cobrado: 0,\n      total_facturas: 0\n    };\n  }\n  \n  comerciales[comercialId].total_facturado += monto;\n  comerciales[comercialId].total_facturas += 1;\n  \n  if (estado === 'draft') {\n    comerciales[comercialId].facturas_pendientes += 1;\n    comerciales[comercialId].monto_pendiente += monto;\n  } else if (estado === 'posted') {\n    comerciales[comercialId].facturas_cobradas += 1;\n    comerciales[comercialId].monto_cobrado += monto;\n  }\n});\n\n// Convertir a array y ordenar por facturación total\nconst rankingArray = Object.values(comerciales)\n  .sort((a, b) => b.total_facturado - a.total_facturado);\n\nconsole.log('🏆 RANKING CALCULADO:');\nconsole.log('   👥 Comerciales únicos:', rankingArray.length);\nconsole.log('   💰 Top comercial:', rankingArray[0]?.nombre, rankingArray[0]?.total_facturado);\n\n// Formatear mensaje\nlet periodo = '';\nif (datosConsulta.tipo_consulta === 'mes_actual') {\n  periodo = 'este mes';\n} else if (datosConsulta.tipo_consulta === 'mes_pasado') {\n  periodo = 'el mes pasado';\n} else if (datosConsulta.tipo_consulta === 'mes_nombre') {\n  periodo = `en ${datosConsulta.parametro}`;\n}\n\nlet texto = `👔 **RANKING COMERCIALES - ${periodo.toUpperCase()}**\\n\\n`;\ntexto += `📊 **RESUMEN GENERAL:**\\n`;\ntexto += `• Comerciales activos: ${rankingArray.length}\\n`;\ntexto += `• Total facturas: ${respuestaOdoo.length}\\n`;\ntexto += `• Facturación total: €${rankingArray.reduce((sum, c) => sum + c.total_facturado, 0).toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\\n\\n`;\n\ntexto += `🏆 **TOP COMERCIALES:**\\n\\n`;\n\nrankingArray.slice(0, 10).forEach((comercial, index) => {\n  let emoji = '';\n  if (index === 0) emoji = '🥇';\n  else if (index === 1) emoji = '🥈';\n  else if (index === 2) emoji = '🥉';\n  else emoji = `${index + 1}️⃣`;\n  \n  const porcentajeCobrado = comercial.total_facturado > 0 \n    ? ((comercial.monto_cobrado / comercial.total_facturado) * 100).toFixed(1)\n    : 0;\n  \n  texto += `${emoji} **${comercial.nombre}**\\n`;\n  texto += `   💰 Total: €${comercial.total_facturado.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\\n`;\n  texto += `   📋 Facturas: ${comercial.total_facturas} (${comercial.facturas_cobradas} cobradas, ${comercial.facturas_pendientes} pendientes)\\n`;\n  texto += `   ✅ Tasa cobro: ${porcentajeCobrado}%\\n\\n`;\n});\n\nif (rankingArray.length > 10) {\n  texto += `📋 *... y ${rankingArray.length - 10} comerciales más*\\n\\n`;\n}\n\ntexto += `📈 **ANÁLISIS:**\\n`;\nconst promedioFacturacion = rankingArray.reduce((sum, c) => sum + c.total_facturado, 0) / rankingArray.length;\ntexto += `• Promedio por comercial: €${promedioFacturacion.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\\n`;\n\nconst mejorComercial = rankingArray[0];\nif (mejorComercial) {\n  texto += `• Mejor rendimiento: ${mejorComercial.nombre} con €${mejorComercial.total_facturado.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2})}\\n`;\n}\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id,\n  ranking_comerciales: rankingArray,\n  resumen: {\n    total_comerciales: rankingArray.length,\n    total_facturas: respuestaOdoo.length,\n    facturacion_total: rankingArray.reduce((sum, c) => sum + c.total_facturado, 0),\n    promedio_comercial: promedioFacturacion\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        9472
      ],
      "id": "90191757-1a9d-4dc4-9946-a84634f207bb",
      "name": "Formatear Ranking Comerciales"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -784,
        9472
      ],
      "id": "f6a7d6ba-f4b0-4035-982b-c94af7fa5624",
      "name": "Enviar Ranking Comerciales",
      "webhookId": "ranking-comerciales-webhook-v40-001"
    },
    {
      "parameters": {
        "content": "## ranking comerciales\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3888,
        9312
      ],
      "typeVersion": 1,
      "id": "262690fd-1c6f-46c9-99aa-da498e0b93d2",
      "name": "Sticky Note - Eventos Usuario1"
    },
    {
      "parameters": {
        "jsCode": "// Preparar consulta de visitantes web desde AI Agent\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst periodo = datosAI.periodo || 'mes_actual';\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\nconsole.log('🌐 CONSULTA VISITANTES WEB:', periodo);\n\n// Calcular fechas según el período\nlet fechaDesde, fechaHasta;\nconst ahora = new Date();\n\nswitch(periodo) {\n  case 'hoy':\n    fechaDesde = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate()).toISOString().split('T')[0];\n    fechaHasta = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate() + 1).toISOString().split('T')[0];\n    break;\n  case 'ayer':\n    const ayer = new Date(ahora.getTime() - 24*60*60*1000);\n    fechaDesde = new Date(ayer.getFullYear(), ayer.getMonth(), ayer.getDate()).toISOString().split('T')[0];\n    fechaHasta = new Date(ayer.getFullYear(), ayer.getMonth(), ayer.getDate() + 1).toISOString().split('T')[0];\n    break;\n  case 'esta_semana':\n    const inicioSemana = new Date(ahora.getTime() - (ahora.getDay() * 24*60*60*1000));\n    fechaDesde = new Date(inicioSemana.getFullYear(), inicioSemana.getMonth(), inicioSemana.getDate()).toISOString().split('T')[0];\n    fechaHasta = ahora.toISOString().split('T')[0];\n    break;\n  case 'mes_pasado':\n    const mesAnterior = new Date(ahora.getFullYear(), ahora.getMonth() - 1, 1);\n    const finMesAnterior = new Date(ahora.getFullYear(), ahora.getMonth(), 0);\n    fechaDesde = mesAnterior.toISOString().split('T')[0];\n    fechaHasta = finMesAnterior.toISOString().split('T')[0];\n    break;\n  case 'mes_actual':\n  default:\n    fechaDesde = new Date(ahora.getFullYear(), ahora.getMonth(), 1).toISOString().split('T')[0];\n    fechaHasta = ahora.toISOString().split('T')[0];\n    break;\n}\n\nconsole.log('📅 Rango de fechas:', fechaDesde, 'a', fechaHasta);\n\n// Consulta para obtener visitantes web desde website.visitor\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"website.visitor\",\n      \"search_read\",\n      [[\n        [\"create_date\", \">=\", fechaDesde + \" 00:00:00\"],\n        [\"create_date\", \"<=\", fechaHasta + \" 23:59:59\"]\n      ]],\n      {\n        fields: [\"id\", \"name\", \"country_id\", \"lang_id\", \"timezone\", \"visit_count\", \"page_count\", \"create_date\", \"last_connection_datetime\", \"time_since_last_action\"],\n        limit: 1000\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  periodo: periodo,\n  fecha_desde: fechaDesde,\n  fecha_hasta: fechaHasta,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2080,
        10448
      ],
      "id": "8f2c935a-cb60-43bb-b08f-ab4e9f55b1cc",
      "name": "Preparar Consulta Visitantes Web"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1872,
        10448
      ],
      "id": "bf142c7c-422f-485d-8748-02aca42100e9",
      "name": "HTTP Visitantes Web"
    },
    {
      "parameters": {
        "jsCode": "// Procesar y formatear datos de visitantes web\nconst respuestaOdoo = $json.result || [];\nconst datosConsulta = $('Preparar Consulta Visitantes Web').item.json;\n\nconsole.log('📊 PROCESANDO VISITANTES WEB:');\nconsole.log('   - Visitantes encontrados:', respuestaOdoo.length);\nconsole.log('   - Período:', datosConsulta.periodo);\nconsole.log('   - Fechas:', datosConsulta.fecha_desde, 'a', datosConsulta.fecha_hasta);\n\nif (respuestaOdoo.length === 0) {\n  // Escapar caracteres especiales de Markdown\n  const periodoEscapado = datosConsulta.periodo.replace(/_/g, '\\\\_');\n  return {\n    error: true,\n    mensaje: `❌ No se encontraron visitantes web para el período ${periodoEscapado}.`,\n    chat_id: datosConsulta.chat_id\n  };\n}\n\n// Procesar datos de visitantes\nconst estadisticas = {\n  total_visitantes: respuestaOdoo.length,\n  visitantes_unicos: new Set(respuestaOdoo.map(v => v.name || v.id)).size,\n  total_visitas: respuestaOdoo.reduce((sum, v) => sum + (v.visit_count || 1), 0),\n  total_paginas_vistas: respuestaOdoo.reduce((sum, v) => sum + (v.page_count || 0), 0),\n  promedio_paginas_por_visita: 0,\n  tiempo_promedio_sesion: 0,\n  paises: {},\n  idiomas: {},\n  zonas_horarias: {},\n  visitantes_con_multiple_visitas: 0\n};\n\n// Calcular promedios\nif (estadisticas.total_visitas > 0) {\n  estadisticas.promedio_paginas_por_visita = (estadisticas.total_paginas_vistas / estadisticas.total_visitas).toFixed(1);\n}\n\n// Procesar países, idiomas y zonas horarias\nrespuestaOdoo.forEach(visitante => {\n  // Países\n  const pais = visitante.country_id ? visitante.country_id[1] : 'Desconocido';\n  estadisticas.paises[pais] = (estadisticas.paises[pais] || 0) + 1;\n  \n  // Idiomas\n  const idioma = visitante.lang_id ? visitante.lang_id[1] : 'Desconocido';\n  estadisticas.idiomas[idioma] = (estadisticas.idiomas[idioma] || 0) + 1;\n  \n  // Zonas horarias\n  const timezone = visitante.timezone || 'Desconocido';\n  estadisticas.zonas_horarias[timezone] = (estadisticas.zonas_horarias[timezone] || 0) + 1;\n  \n  // Visitantes con múltiples visitas\n  if ((visitante.visit_count || 1) > 1) {\n    estadisticas.visitantes_con_multiple_visitas++;\n  }\n  \n  // Calcular tiempo promedio de sesión (aproximado)\n  if (visitante.time_since_last_action) {\n    estadisticas.tiempo_promedio_sesion += visitante.time_since_last_action;\n  }\n});\n\n// Finalizar cálculo de tiempo promedio\nif (respuestaOdoo.length > 0) {\n  estadisticas.tiempo_promedio_sesion = Math.round(estadisticas.tiempo_promedio_sesion / respuestaOdoo.length);\n}\n\n// Ordenar países por cantidad de visitantes\nconst paisesSorted = Object.entries(estadisticas.paises)\n  .sort(([,a], [,b]) => b - a)\n  .slice(0, 5); // Top 5 países\n\n// Ordenar idiomas\nconst idiomasSorted = Object.entries(estadisticas.idiomas)\n  .sort(([,a], [,b]) => b - a)\n  .slice(0, 3); // Top 3 idiomas\n\nreturn {\n  estadisticas: {\n    ...estadisticas,\n    top_paises: paisesSorted,\n    top_idiomas: idiomasSorted\n  },\n  periodo: datosConsulta.periodo,\n  fecha_desde: datosConsulta.fecha_desde,\n  fecha_hasta: datosConsulta.fecha_hasta,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1680,
        10448
      ],
      "id": "f359295a-488c-4d6a-88db-f5a86b74c250",
      "name": "Procesar Visitantes Web"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de visitantes web para Telegram\nconst datos = $json;\n\n// Función para escapar caracteres especiales de Markdown\nfunction escapeMarkdown(text) {\n  return text.toString().replace(/[_*\\[\\]()~`>#+=|{}.!-]/g, '\\\\$&');\n}\n\nif (datos.error) {\n  return {\n    texto: datos.mensaje,\n    chat_id: datos.chat_id\n  };\n}\n\nconst stats = datos.estadisticas;\nconst periodoTexto = {\n  'hoy': 'hoy',\n  'ayer': 'ayer', \n  'esta_semana': 'esta semana',\n  'mes_actual': 'este mes',\n  'mes_pasado': 'el mes pasado'\n}[datos.periodo] || datos.periodo;\n\nlet texto = `🌐 *Estadísticas de Visitantes Web - ${periodoTexto}*\\n`;\ntexto += `📅 Período: ${datos.fecha_desde} a ${datos.fecha_hasta}\\n\\n`;\n\n// Estadísticas generales\ntexto += `📊 *RESUMEN GENERAL*\\n`;\ntexto += `• Total visitantes: *${stats.total_visitantes}*\\n`;\ntexto += `• Visitantes únicos: *${stats.visitantes_unicos}*\\n`;\ntexto += `• Total visitas: *${stats.total_visitas}*\\n`;\ntexto += `• Páginas vistas: *${stats.total_paginas_vistas}*\\n`;\ntexto += `• Promedio páginas/visita: *${stats.promedio_paginas_por_visita}*\\n`;\n\nif (stats.tiempo_promedio_sesion > 0) {\n  const minutos = Math.floor(stats.tiempo_promedio_sesion / 60);\n  const segundos = stats.tiempo_promedio_sesion % 60;\n  texto += `• Tiempo promedio sesión: *${minutos}m ${segundos}s*\\n`;\n}\n\n// Visitantes recurrentes\nif (stats.visitantes_con_multiple_visitas > 0) {\n  const porcentajeRecurrentes = ((stats.visitantes_con_multiple_visitas / stats.total_visitantes) * 100).toFixed(1);\n  texto += `• Visitantes recurrentes: *${stats.visitantes_con_multiple_visitas}* (${porcentajeRecurrentes}%)\\n`;\n}\n\n// Top países\nif (stats.top_paises.length > 0) {\n  texto += `\\n🌍 *TOP PAÍSES*\\n`;\n  stats.top_paises.forEach(([pais, cantidad], idx) => {\n    const porcentaje = ((cantidad / stats.total_visitantes) * 100).toFixed(1);\n    texto += `${idx + 1}. ${escapeMarkdown(pais)}: *${cantidad}* (${porcentaje}%)\\n`;\n  });\n}\n\n// Top idiomas\nif (stats.top_idiomas.length > 0) {\n  texto += `\\n🗣️ *TOP IDIOMAS*\\n`;\n  stats.top_idiomas.forEach(([idioma, cantidad], idx) => {\n    const porcentaje = ((cantidad / stats.total_visitantes) * 100).toFixed(1);\n    texto += `${idx + 1}. ${escapeMarkdown(idioma)}: *${cantidad}* (${porcentaje}%)\\n`;\n  });\n}\n\n// Análisis\ntexto += `\\n💡 *ANÁLISIS*\\n`;\nif (stats.promedio_paginas_por_visita > 3) {\n  texto += `✅ *Buen engagement* - Los visitantes ven múltiples páginas\\n`;\n} else if (stats.promedio_paginas_por_visita < 2) {\n  texto += `⚠️ *Bajo engagement* - Pocos visitantes exploran el sitio\\n`;\n} else {\n  texto += `🟡 *Engagement moderado* - Hay margen de mejora\\n`;\n}\n\nconst tasaRecurrencia = (stats.visitantes_con_multiple_visitas / stats.total_visitantes) * 100;\nif (tasaRecurrencia > 30) {\n  texto += `✅ *Alta fidelidad* - Muchos visitantes regresan\\n`;\n} else if (tasaRecurrencia < 10) {\n  texto += `⚠️ *Baja fidelidad* - Pocos visitantes regresan\\n`;\n} else {\n  texto += `🟡 *Fidelidad moderada* - Algunos visitantes regresan\\n`;\n}\n\nreturn {\n  texto,\n  chat_id: datos.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        10448
      ],
      "id": "9459cbda-363d-4a78-a5b0-bc190a2d90fe",
      "name": "Formatear Visitantes Web"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1280,
        10448
      ],
      "id": "a55362cd-704d-4191-94e7-561f26eba9b5",
      "name": "Enviar Respuesta Visitantes Web",
      "webhookId": "da26a341-de8d-4525-8b4d-ef0b159fc4cf"
    },
    {
      "parameters": {
        "jsCode": "// PROCESAR DATOS DE GASTO DEL AI AGENT — empleado_nombre = user_name + odoo_user para desambiguar\n// Los datos ya vienen procesados del AI Agent\nconst datos = $json;\n\nconsole.log('💰 === PROCESAR DATOS GASTO DEL AI AGENT ===');\nconsole.log('📥 Datos recibidos:', JSON.stringify(datos, null, 2));\n\n// Extraer datos del AI Agent\nlet importe = parseFloat(datos.importe) || 0;\nconst descripcionAI = datos.descripcion || 'Gasto registrado';\nconst fechaAI = datos.fecha || 'hoy';\nconst chatId = datos.chat_id;\nconst userName = (datos.user_name || 'Usuario').toString().trim(); // empleado_nombre = user_name\nconst userId = datos.user_id;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst mensajeOriginal = datos.mensaje_original || '';\n\n// Resolver odoo_user con fallbacks (lo usaremos para desambiguar empleados con mismo nombre)\nconst odooUser = (\n  datos.odoo_user\n  || datos.cliente_perfil?.login\n  || datos.cliente_perfil?.email\n  || datos.user_mail\n  || null\n)?.toString().trim() || null;\n\nconsole.log('💰 Importe del AI:', importe);\nconsole.log('📝 Descripción del AI:', descripcionAI);\nconsole.log('📅 Fecha del AI:', fechaAI);\nconsole.log('👤 empleado_nombre (user_name):', userName);\nconsole.log('📧 odoo_user (login/email para desambiguar):', odooUser);\n\n// 🔧 BACKUP: Si el AI Agent no detectó el importe, extraerlo del mensaje\nif (importe === 0 || !importe) {\n  console.log('⚠️ AI Agent no detectó importe, extrayendo del mensaje...');\n  const mensajeCompleto = mensajeOriginal;\n\n  // Patrones para detectar importes: 25€, 25 €, 25 euros, €25, etc.\n  const patronesImporte = [\n    /([0-9]+(?:[.,][0-9]{1,2})?)\\s*€/i,\n    /([0-9]+(?:[.,][0-9]{1,2})?)\\s*euros?/i,\n    /€\\s*([0-9]+(?:[.,][0-9]{1,2})?)/i,\n    /([0-9]+(?:[.,][0-9]{1,2})?)\\s*eur/i\n  ];\n\n  for (const patron of patronesImporte) {\n    const match = mensajeCompleto.match(patron);\n    if (match) {\n      const importeStr = match[1].replace(',', '.'); // Normalizar decimales\n      importe = parseFloat(importeStr);\n      console.log('✅ Importe extraído del mensaje:', importe, '€');\n      break;\n    }\n  }\n\n  if (importe === 0) {\n    console.log('❌ No se pudo extraer importe del mensaje');\n  }\n}\n\n// Procesar fecha\nlet fecha = new Date().toISOString().split('T')[0]; // Por defecto hoy\nif (fechaAI === 'ayer' || /\\bayer\\b/i.test(mensajeOriginal)) {\n  const ayer = new Date();\n  ayer.setDate(ayer.getDate() - 1);\n  fecha = ayer.toISOString().split('T')[0];\n}\n\n// ===== EMPLEADO =====\n// Requisito: empleado_nombre debe ser SIEMPRE el user_name.\n// Usaremos odoo_user por separado para desambiguar en la búsqueda (email/login).\nconst empleadoNombre = userName;\n\n// === Imagen/recibo adjunto ===\nlet tieneImagen = false;\nlet imagenFileId = null;\nlet imgData = null;\ntry {\n  // Obtener desde 'Extraer Datos' usando el nuevo campo img_data\n  const datosOriginales = $('Extraer Datos').first().json;\n  imgData = datosOriginales.img_data || null;\n  tieneImagen = datosOriginales.tiene_imagen || false;\n  imagenFileId = datosOriginales.imagen_file_id || null;\n\n  console.log('=== INFO IMAGEN DESDE EXTRAER DATOS ===');\n  console.log('Tiene imagen:', tieneImagen);\n  console.log('File ID:', imagenFileId);\n  console.log('Datos imagen completos (img_data):', imgData ? 'PRESENTE' : 'NO DISPONIBLE');\n\n  if (imgData) {\n    console.log('Detalles img_data:', JSON.stringify(imgData, null, 2));\n    console.log('File ID desde img_data:', imgData.file_id);\n    console.log('Tamaño archivo:', imgData.file_size);\n    console.log('Dimensiones:', imgData.width + 'x' + imgData.height);\n    console.log('Timestamp captura:', imgData.timestamp);\n  }\n} catch (e) {\n  console.log('ERROR: No se pudo obtener info de imagen desde Extraer Datos:', e.message);\n  // Fallback: intentar desde datos actuales si están disponibles\n  tieneImagen = datos.tiene_imagen || false;\n  imagenFileId = datos.imagen_file_id || null;\n  imgData = null;\n}\n\nconsole.log('📊 DATOS PROCESADOS:');\nconsole.log('💰 Importe:', importe);\nconsole.log('📅 Fecha:', fecha);\nconsole.log('📝 Descripción:', descripcionAI);\nconsole.log('👤 Empleado (por nombre):', empleadoNombre);\nconsole.log('📧 Empleado (odoo_user para desambiguar):', odooUser);\nconsole.log('📸 Imagen adjunta:', tieneImagen ? 'SÍ' : 'NO');\n\n// Validación mínima\nif (!importe || importe <= 0) {\n  throw new Error('❌ No se pudo extraer el importe del gasto. Importe recibido: ' + importe);\n}\n\nreturn {\n  datos_gasto: {\n    importe: importe,\n    descripcion: descripcionAI,\n    fecha: fecha,\n    chat_id: chatId,\n    user_name: userName,     // lo mantenemos\n    odoo_user: odooUser,     // ✅ clave para desambiguar en la búsqueda\n    user_id: userId,\n    empleado_nombre: empleadoNombre, // ✅ SIEMPRE el user_name\n    tiene_imagen: tieneImagen,\n    imagen_file_id: imagenFileId,\n    img_data: imgData        // campo completo de la imagen\n  },\n  uid: uid,\n  mensaje_usuario: mensajeOriginal\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2064,
        9888
      ],
      "id": "55e48d32-c785-4394-ae6f-0d3249360990",
      "name": "Procesar Datos Gasto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id \n   || $json.datos_gasto?.chat_id\n   || $('Crear Gasto Simplificado').item.json.datos_gasto?.chat_id\n}}",
        "text": "=✅ **¡Gasto registrado exitosamente!**\n💰 **Importe:** {{ $('Crear Gasto Simplificado').item.json.datos_gasto.importe }}€\n📝 **Descripción:** {{ $('Crear Gasto Simplificado').item.json.datos_gasto.descripcion }}\n📅 **Fecha:** {{ $('Crear Gasto Simplificado').item.json.datos_gasto.fecha }}\n👤 **Empleado:** {{ $('Crear Gasto Simplificado').item.json.empleado.name }}\n🆔 **ID Gasto:** {{ $('Crear Gasto Odoo').item.json.result }}\n🔗 **Gasto:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $('Crear Gasto Odoo').item.json.result }}&model=hr.expense&view_type=form)\n\n¡Tu gasto ha sido registrado en Odoo! 😊\n\n📸 **{{ $json.imagen_adjuntada ? 'Foto adjunta procesada correctamente' : 'Gasto registrado sin foto' }}** ",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1168,
        9888
      ],
      "id": "1faaf0ea-c143-4a13-adc8-75b2279889a6",
      "name": "Confirmar Gasto Creado",
      "webhookId": "confirmar-gasto-creado-001"
    },
    {
      "parameters": {
        "content": "## subida gasto, error subir imagen\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3968,
        9728
      ],
      "typeVersion": 1,
      "id": "2482908e-2032-4e3c-b196-546a108f9bc1",
      "name": "Sticky Note - Eventos Usuario2"
    },
    {
      "parameters": {
        "content": "## visitantes de la web\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3952,
        10288
      ],
      "typeVersion": 1,
      "id": "fdacd23e-29d1-4669-b21c-8e4421ceed0d",
      "name": "Sticky Note - Eventos Usuario3"
    },
    {
      "parameters": {
        "content": "## Crear pedido de venta"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3408,
        5120
      ],
      "typeVersion": 1,
      "id": "1c9cb7dd-a66d-412f-826a-2df88ca3b87e",
      "name": "Sticky Note - Crear Pedido Venta"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  user_id,\n  user_name,\n  restricted_modules,\n  user_mail,\n  direccion_calle,\n  codigo_postal,\n  poblacion,\n  provincia,\n  pais\nFROM telegram_users\nWHERE user_id = $1;\n",
        "options": {
          "queryReplacement": "={{ $json.user_id }}\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -2336,
        10864
      ],
      "id": "80746435-5d45-4082-8f54-76775027ad8c",
      "name": "Verificar Restricciones Usuario Venta"
    },
    {
      "parameters": {
        "chatId": "={{ $('Router de Acciones FIXED').item.json.chat_id }}",
        "text": "🚫 **Acceso Denegado**\n\nNo tienes permisos para acceder al módulo de **Ventas**.\n\nPor favor, contacta con un administrador para obtener los permisos necesarios.\n\n🔒 Restricción activa en tu cuenta.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1456,
        10848
      ],
      "id": "b3d64ac1-b229-4a47-8ccc-299a78d0f503",
      "name": "Mensaje Sin Acceso Ventas",
      "webhookId": "5cc7271b-bb4a-4907-8d2b-0cff3a2fafd1"
    },
    {
      "parameters": {
        "jsCode": "// Preparar creación de pedido de venta en Odoo\nconst datosDirectos = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\n\n// Obtener datos desde Router de Acciones FIXED (seguro)\nconst datosCompletos = $('Router de Acciones FIXED').first()?.json || {};\n\n// Intentar obtener el perfil del usuario (primero del router, luego del preparador)\nconst perfil =\n  datosCompletos.cliente_perfil ||\n  $('Preparar Datos AI Agent').first()?.json?.cliente_perfil ||\n  null;\n\nconsole.log('🛒 === PREPARAR CREAR PEDIDO VENTA ===');\nconsole.log('📊 Datos directos recibidos:', JSON.stringify(datosDirectos, null, 2));\nconsole.log('📊 Datos completos del router:', JSON.stringify(datosCompletos, null, 2));\nconsole.log('👤 Perfil detectado:', JSON.stringify(perfil, null, 2));\n\n// Cliente: 1) el que venga en la intención  2) el nombre del perfil del usuario\nconst clienteNombre =\n  datosCompletos.cliente ||\n  datosDirectos.cliente ||\n  (perfil?.name || null);\n\nconst productos = datosCompletos.productos || datosDirectos.productos || [];\nconst chatId = datosCompletos.chat_id || datosDirectos.chat_id;\n\nconsole.log('👤 Cliente extraído:', clienteNombre);\nconsole.log('📦 Productos extraídos:', JSON.stringify(productos, null, 2));\nconsole.log('💬 Chat ID:', chatId);\nconsole.log('🔑 UID:', uid);\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticación');\n}\n\n// Validar cliente (nombre o perfil)\nif (!clienteNombre && !perfil) {\n  console.log('❌ Error: No se encontró cliente ni perfil en los datos');\n  console.log('📊 Datos disponibles:', { datosDirectos, datosCompletos, perfil });\n  throw new Error('No se encontró el cliente (ni nombre ni perfil disponible)');\n}\n\n// Validar que tenemos productos\nif (!productos || productos.length === 0) {\n  throw new Error('No se encontraron productos para el pedido');\n}\n\nconsole.log('✅ Validación exitosa - Preparando datos para búsqueda/creación de cliente');\n\nreturn {\n  cliente_nombre: clienteNombre,    // puede venir de la intención o del perfil\n  cliente_perfil: perfil,           // ← se arrastra para creación si no existe en Odoo\n  productos: productos,\n  chat_id: chatId,\n  uid: uid,\n  datos_originales: datosCompletos\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1760,
        11040
      ],
      "id": "428a5254-0b50-4e36-bdc3-f8a8ad1fb801",
      "name": "Preparar Crear Pedido Venta"
    },
    {
      "parameters": {
        "jsCode": "// Buscar cliente específico en Odoo por nombre\nconst datos = $json;\nconst uid = Number(datos.uid);\nconst perfil = datos.cliente_perfil || null;\n\n// Prioridad: nombre de intención → nombre del perfil\nconst clienteNombre = (datos.cliente_nombre || perfil?.name || '').toString().trim();\n\nconsole.log('🔍 === BUSCAR CLIENTE ESPECÍFICO EN ODOO ===');\nconsole.log('👤 Buscando cliente:', clienteNombre || '(vacío, usar perfil)');\nconsole.log('🔑 UID:', uid);\nif (!uid) throw new Error('UID inválido para Odoo');\n\n// Si no hay nombre, saltamos búsqueda y preparamos creación directa con el perfil\nif (!clienteNombre) {\n  const clienteDatos = {\n    name: perfil?.name || '',\n    email: perfil?.email || '',\n    street: perfil?.street || '',\n    zip: perfil?.zip || '',\n    city: perfil?.city || '',\n    state_name: perfil?.state_name || '',\n    country_name: perfil?.country_name || '',\n    customer_rank: 1,\n    is_company: false,\n  };\n\n  return {\n    skip_search: true,\n    crear_cliente: true,\n    cliente_datos: clienteDatos,\n    cliente_nombre: '',   // vacío a propósito\n    uid,\n    busqueda_tipo: 'sin_nombre_usa_perfil',\n    cliente_perfil: perfil,\n    ...datos,\n  };\n}\n\n// Dominio para “solo clientes”\nconst domain = [\n  ['customer_rank', '>', 0],\n];\n\n// ✅ CORRECCIÓN CLAVE: pasar el dominio SIN anidar (args: domain)\nconst rpcPayload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'res.partner',\n      'name_search',\n      [clienteNombre],                 // name\n      { args: domain, operator: 'ilike', limit: 5 } // <- aquí va directo\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nconst payload = JSON.stringify(rpcPayload);\n\nconsole.log('📋 Usando name_search para buscar específicamente \"' + clienteNombre + '\"');\nconsole.log('📋 Payload:', payload);\n\nreturn {\n  payload,\n  cliente_nombre: clienteNombre,\n  uid,\n  busqueda_tipo: 'name_search_especifico',\n  cliente_perfil: perfil,\n  ...datos,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1552,
        11040
      ],
      "id": "7a46a850-e0db-4d60-8ad5-d3df1c2d4151",
      "name": "Buscar Cliente"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1360,
        11040
      ],
      "id": "d7dfbee1-6fca-48b2-a081-d016c69dc17b",
      "name": "HTTP Buscar Cliente"
    },
    {
      "parameters": {
        "jsCode": "// Procesar resultado de name_search de cliente\nconst datos = $('Buscar Cliente').item.json;\nconst resultadoBusqueda = $json.result;\nconst nombreBuscado = datos.cliente_nombre;\n\nconsole.log('📋 === PROCESAR RESULTADO NAME_SEARCH ===');\nconsole.log('👤 Cliente buscado:', nombreBuscado);\nconsole.log('🔍 Tipo de búsqueda:', datos.busqueda_tipo);\nconsole.log('📊 Resultado completo:', JSON.stringify(resultadoBusqueda, null, 2));\n\nlet clienteId = null;\nlet clienteEncontrado = false;\nlet clienteDatos = null;\n\nif (resultadoBusqueda && resultadoBusqueda.length > 0) {\n  // name_search devuelve arrays de [id, nombre]\n  console.log('✅ Clientes encontrados con name_search:');\n  resultadoBusqueda.forEach((cliente, index) => {\n    // cliente es un array [id, nombre]\n    const id = cliente[0];\n    const nombre = cliente[1];\n    console.log(`   ${index + 1}. ID: ${id}, Nombre: \"${nombre}\"`);\n  });\n  \n  // Tomar el primer resultado (el más relevante según Odoo)\n  const primerResultado = resultadoBusqueda[0];\n  clienteId = primerResultado[0];  // ID\n  const clienteNombre = primerResultado[1];  // Nombre\n  \n  clienteEncontrado = true;\n  clienteDatos = {\n    id: clienteId,\n    name: clienteNombre\n  };\n  \n  console.log('✅ Cliente seleccionado:');\n  console.log('   ID:', clienteId);\n  console.log('   Nombre:', clienteNombre);\n  \n} else {\n  console.log('ℹ️ No se encontró cliente \"' + nombreBuscado + '\" con name_search');\n  clienteEncontrado = false;\n  \n  // Crear un cliente básico con el nombre proporcionado\n  clienteDatos = {\n    name: nombreBuscado,\n    customer_rank: 1,\n    is_company: false\n  };\n  \n  console.log('🆕 Preparando creación de cliente:', JSON.stringify(clienteDatos, null, 2));\n}\n\n// Si venimos sin búsqueda (skip_search), pasamos a creación con los datos del perfil\nif ($json.skip_search === true) {\n  return {\n    cliente_id: null,\n    cliente_encontrado: false,\n    cliente_datos: $json.cliente_datos,\n    crear_cliente: true,\n    total_resultados: 0,\n    metodo_busqueda: 'sin_busqueda_perfil',\n    ...$json,\n  };\n}\n\n\nreturn {\n  cliente_id: clienteId,\n  cliente_encontrado: clienteEncontrado,\n  cliente_datos: clienteDatos,\n  crear_cliente: !clienteEncontrado,\n  total_resultados: resultadoBusqueda ? resultadoBusqueda.length : 0,\n  metodo_busqueda: 'name_search',\n  ...datos\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1152,
        11040
      ],
      "id": "e7832ee8-c7c1-4c39-ab6e-b193ed1af1d5",
      "name": "Procesar Cliente Encontrado"
    },
    {
      "parameters": {
        "jsCode": "// === CREAR PEDIDO VENTA (tolerante a ramas no ejecutadas) ===\n\n// Helper seguro: lee .json de otro nodo sin petar si no se ejecutó\nfunction safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) { return null; }\n}\n\n// Datos inmediatos de la rama actual\nconst cur = $json || {};\n\n// Posibles fuentes (algunas no existirán según la rama)\nconst desdeFusion = safeJson('Fusionar Correcciones con Original') || {};\nconst prepBusq    = safeJson('Preparar Búsqueda Productos') || {};\nconst httpFixed   = safeJson('HTTP Buscar Productos FIXED') || {};\nconst httpFixed1  = safeJson('HTTP Buscar Productos FIXED1') || {};\nconst auth        = safeJson('Autenticar Odoo') || {};\n\n// UID / Cliente / Chat\nconst uid       = cur.uid || prepBusq.uid || desdeFusion.uid || auth.result;\nconst clienteId = cur.cliente_id ?? prepBusq.cliente_id ?? desdeFusion.cliente_id ?? null;\nconst clienteDt = cur.cliente_datos || prepBusq.cliente_datos || desdeFusion.cliente_datos || {};\nconst chatId    = cur.chat_id || prepBusq.chat_id || desdeFusion.chat_id;\n\n// 1) Si venimos de la rama SIN correcciones, ya tenemos matching hecho:\n//    \"Preparar Productos\" dejó lineas_preconfirmadas listas para crear el pedido.\nlet lineasPedido = [];\nif (Array.isArray(cur.lineas_preconfirmadas) && cur.lineas_preconfirmadas.length > 0) {\n  lineasPedido = cur.lineas_preconfirmadas.map(l => ({\n    product_id: l.product_id,\n    product_uom_qty: Number(l.product_uom_qty || 0),\n    price_unit: Number(l.price_unit || 0),\n    name: l.name,\n  }));\n}\n\n// 2) Si no tenemos líneas aún (p. ej. venimos por la rama con correcciones),\n//    armamos el pool y resolvemos contra productos solicitados/fusionados.\nif (lineasPedido.length === 0) {\n  const pool = Array.isArray(cur.result) ? cur.result\n             : Array.isArray(httpFixed1?.result) ? httpFixed1.result\n             : Array.isArray(httpFixed?.result)  ? httpFixed.result\n             : [];\n\n  // Productos priorizando los fusionados; si no, los que vengan en esta rama\n  const productosSolicitados =\n    (Array.isArray(desdeFusion.productos) && desdeFusion.productos.length > 0)\n      ? desdeFusion.productos\n      : (cur.productos || prepBusq.productos || []);\n\n  if (!Array.isArray(productosSolicitados) || productosSolicitados.length === 0) {\n    throw new Error('No se recibieron productos para el pedido');\n  }\n\n  // Normalización y matching\n  const normalize = (s) => (s || '')\n    .toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .toLowerCase()\n    .replace(/(\\d)\\s+(kg|g|mg|l|ml|cl|cm|mm|m|u|uds?)/g, '$1$2')\n    .replace(/\\s+/g, ' ')\n    .trim();\n\n  const STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\n  const tokens = (s) => {\n    const n = normalize(s);\n    if (!n) return [];\n    return n.split(/[ \\-_/]+/).filter(t => t && !STOP.has(t));\n  };\n  const jaccard = (a,b) => {\n    const A = new Set(tokens(a)), B = new Set(tokens(b));\n    const inter = [...A].filter(x=>B.has(x)).length;\n    const uni = new Set([...A,...B]).size;\n    return uni === 0 ? 0 : inter/uni;\n  };\n\n  const byNorm = new Map(pool.map(p => [normalize(p.name), p]));\n  const ambiguos = [];\n\n  for (const sol of productosSolicitados) {\n    const nombre = (sol?.nombre || '').toString();\n    const cant   = Number(sol?.cantidad || 1);\n    const ns     = normalize(nombre);\n\n    if (byNorm.has(ns)) {\n      const p = byNorm.get(ns);\n      lineasPedido.push({\n        product_id: p.id,\n        product_uom_qty: cant,\n        price_unit: p.list_price,\n        name: p.name,\n      });\n      continue;\n    }\n\n    // Fuzzy por tokens (suave)\n    let best = null, bestScore = 0;\n    for (const p of pool) {\n      const s = jaccard(nombre, p.name);\n      if (s > bestScore) { best = p; bestScore = s; }\n    }\n    if (best && bestScore >= 0.85) {\n      lineasPedido.push({\n        product_id: best.id,\n        product_uom_qty: cant,\n        price_unit: best.list_price,\n        name: best.name,\n      });\n    } else {\n      ambiguos.push({ solicitado: nombre, cantidad: cant });\n    }\n  }\n\n  if (ambiguos.length > 0 && lineasPedido.length === 0) {\n    // Si por alguna razón seguimos con ambigüedad aquí, pedimos corrección\n    return {\n      requiere_correccion: true,\n      texto_correccion: '🔎 Algunos productos necesitan corrección. Envíalos como: Nombre x Cantidad, separados por comas.',\n      productos_ambiguos: ambiguos,\n      productos_solicitados: productosSolicitados,\n      cliente_id: clienteId,\n      cliente_datos: clienteDt,\n      chat_id: chatId,\n      uid,\n    };\n  }\n}\n\n// Validaciones finales\nif (!uid) throw new Error('No se pudo obtener el UID de autenticación');\nif (!clienteId) throw new Error('No se encontró el ID del cliente');\nif (lineasPedido.length === 0) throw new Error('No hay líneas válidas para crear el pedido');\n\n// Payload Odoo\nconst datosPedido = {\n  partner_id: clienteId,\n  state: 'draft',\n  order_line: lineasPedido.map(l => [0,0,l]),\n};\n\nconst jsonRpcPayload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'sale.order',\n      'create',\n      [datosPedido]\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  lineas_pedido: lineasPedido,\n  productos_no_encontrados: [], // ya resueltos arriba\n  datos_pedido: datosPedido,\n  cliente_id: clienteId,\n  cliente_datos: clienteDt,\n  chat_id: chatId,\n  uid\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        544,
        10784
      ],
      "id": "8698f08b-b023-4293-bfaa-9c0271ca2caf",
      "name": "Crear Pedido Venta"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "req-corr-venta",
              "leftValue": "={{ $json.requiere_correccion === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -240,
        11136
      ],
      "id": "929c06e4-0f94-424e-909e-4ae7c88153dc",
      "name": "¿Requiere Corrección Pedido?"
    },
    {
      "parameters": {
        "jsCode": "// Preparar memoria para corrección de pedido de venta (alimentado desde \"Preparar Productos\")\nconst d = $('Preparar Productos').item.json;\n\nreturn {\n  chat_id: Number(d.chat_id) || 0,\n  esperando_confirmacion: 'corregir_pedido_venta',\n  ultimo_mensaje_bot: d.texto_correccion || 'Indica los productos correctos en un solo mensaje (nombre x cantidad, separados por comas).',\n  datos_pendientes: {\n    accion_original: 'crear_pedido_venta',\n    cliente: d.cliente_datos?.name || '',\n    cliente_id: d.cliente_id || null,\n    productos_originales: Array.isArray($('Preparar Búsqueda Productos').item.json.productos) ? $('Preparar Búsqueda Productos').item.json.productos : [],\n    productos_ambiguos: d.productos_ambiguos || [],\n    lineas_preconfirmadas: d.lineas_preconfirmadas || []\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        11152
      ],
      "id": "b1723c31-e60b-481c-9613-8870ca144c4d",
      "name": "Preparar Memoria Corrección Pedido"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Usuario',\n  'corregir_pedido_venta',\n  $json.ultimo_mensaje_bot,\n  JSON.stringify($json.datos_pendientes || {}),\n  'Corrección productos pedido',\n  JSON.stringify([]),\n  JSON.stringify([{ tipo: 'bot', contenido: $json.ultimo_mensaje_bot, timestamp: new Date().toISOString() }])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        96,
        11152
      ],
      "id": "ec6dcba0-f178-483c-bad1-97d84924c4f8",
      "name": "Guardar Memoria Corrección Pedido"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Memoria Corrección Pedido').item.json.chat_id }}",
        "text": "={{ $('Preparar Memoria Corrección Pedido').item.json.ultimo_mensaje_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        272,
        11152
      ],
      "id": "5976d1f3-cf25-46cd-a11d-a5a3dca2d5ee",
      "name": "Enviar Correcciones Pedido",
      "webhookId": "86c2fc4b-a829-4c80-b1d6-ba10d9a7c9a4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "confirmar-pedido-venta-cond",
              "leftValue": "={{ (\n  $('Switch Acciones').item.json.mensaje_original ||\n  $('Router de Acciones FIXED').item.json.respuesta ||\n  $('Router de Acciones FIXED').item.json.text ||\n  ''\n).toString().toLowerCase().trim() }}",
              "rightValue": "si",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        720,
        10784
      ],
      "id": "742c9239-b1ee-41a8-8884-588500289e8e",
      "name": "¿Confirmación Sí?"
    },
    {
      "parameters": {
        "jsCode": "// Construir mensaje de confirmación o corrección para pedido de venta\nconst datos = $('Crear Pedido Venta').item.json;\nconst cliente = datos.cliente_datos?.name || 'Cliente';\nconst lineas = Array.isArray(datos.lineas_pedido) ? datos.lineas_pedido : [];\n\nlet esperando_confirmacion = 'crear_pedido_venta';\nlet texto = '';\nlet datosPendientes;\n\nif (datos.requiere_correccion) {\n  // Pedir corrección masiva de productos ambiguos o no encontrados\n  texto = (datos.texto_correccion || '🔎 Necesito que corrijas algunos productos. Envía todos en un solo mensaje con formato: nombre x cantidad').toString();\n  esperando_confirmacion = 'corregir_pedido_venta';\n  datosPendientes = {\n    accion_original: 'crear_pedido_venta',\n    cliente: cliente,\n    cliente_id: datos.cliente_id || null,\n    productos_originales: Array.isArray($('Preparar Búsqueda Productos').item.json.productos) ? $('Preparar Búsqueda Productos').item.json.productos : (datos.productos || []),\n    productos_ambiguos: datos.productos_ambiguos || [],\n  };\n} else {\n  // Mensaje de confirmación normal\n  texto = `📝 **Resumen del pedido de venta**\\n\\n`;\n  texto += `👤 **Cliente:** ${cliente}\\n`;\n  texto += `📦 **Productos:**\\n`;\n  for (const l of lineas) {\n    texto += `• ${l.name} - Cantidad: ${l.product_uom_qty} - Precio: €${l.price_unit}\\n`;\n  }\n  if (Array.isArray(datos.productos_no_encontrados) && datos.productos_no_encontrados.length > 0) {\n    texto += `\\n⚠️ **No encontrados:** ${datos.productos_no_encontrados.join(', ')}\\n`;\n  }\n  texto += `\\n❓ **¿Confirmo este pedido de venta?** Responde *si* para continuar.`;\n\n  datosPendientes = {\n    accion_original: 'crear_pedido_venta',\n    cliente: cliente,\n    cliente_id: datos.cliente_id || null,\n    productos: Array.isArray($('Preparar Búsqueda Productos').item.json.productos) ? $('Preparar Búsqueda Productos').item.json.productos : (datos.productos || []),\n  };\n}\n\nreturn {\n  chat_id: datos.chat_id,\n  texto_confirmacion: texto,\n  ultimo_mensaje_bot: texto,\n  esperando_confirmacion,\n  datos_pendientes: datosPendientes,\n  payload: datos.payload,\n  lineas_pedido: datos.lineas_pedido,\n  productos_no_encontrados: datos.productos_no_encontrados,\n  datos_pedido: datos.datos_pedido,\n  cliente_id: datos.cliente_id,\n  cliente_datos: datos.cliente_datos,\n  uid: datos.uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        10928
      ],
      "id": "1bc3de2e-a326-445a-8e46-a1f68bb03cde",
      "name": "Formatear Confirmación Pedido"
    },
    {
      "parameters": {
        "chatId": "={{ $('Formatear Confirmación Pedido').item.json.chat_id }}",
        "text": "={{ $('Formatear Confirmación Pedido').item.json.texto_confirmacion }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1312,
        10928
      ],
      "id": "2aded0eb-4208-4cfa-be9c-12b34b9a2d1f",
      "name": "Enviar Confirmación Pedido",
      "webhookId": "c1a5e9bb-3f3a-4d2a-bc5e-1c2d3e4f5a6b"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n\nSET esperando_confirmacion = NULL,\n    updated_at = NOW()\nWHERE esperando_confirmacion = 'corregir_pedido_venta'\n  AND chat_id = ANY($1::bigint[]);\n",
        "options": {
          "queryReplacement": "=={{ [ $('Fusionar Correcciones con Original').item.json.chat_id_list ] }}\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        256,
        10976
      ],
      "id": "9599df25-d257-4aae-892f-fd56972d4af4",
      "name": "Limpiar Espera Corrección Pedido"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Usuario',\n  ($json.esperando_confirmacion || 'crear_pedido_venta'),\n  $json.ultimo_mensaje_bot || $json.texto_confirmacion,\n  JSON.stringify($json.datos_pendientes || {}),\n  'Confirmación pedido de venta',\n  JSON.stringify([]),\n  JSON.stringify([\n    { tipo: 'bot', contenido: ($json.ultimo_mensaje_bot || $json.texto_confirmacion), timestamp: new Date().toISOString() }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1072,
        10928
      ],
      "id": "52519b86-673d-4e6b-b583-d9436560b63b",
      "name": "Guardar Memoria PostgreSQL Pedido Venta"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        928,
        10640
      ],
      "id": "c64f09de-2431-4192-8e5c-49eb74cc57fe",
      "name": "HTTP Crear Pedido"
    },
    {
      "parameters": {
        "chatId": "={{ $('Formatear Respuesta Pedido').item.json.chat_id }}",
        "text": "={{ $('Formatear Respuesta Pedido').item.json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2176,
        10544
      ],
      "id": "5f7e1f12-ac3c-49af-906e-b4343b0e24d8",
      "name": "Enviar Respuesta Pedido",
      "webhookId": "86c2fc4b-a829-4c80-b1d6-ba10d9a7c9a4"
    },
    {
      "parameters": {
        "jsCode": "// Input del nodo = item ORIGINAL (no el SELECT)\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst chatId = datosAI.chat_id;\n\nif (!uid) throw new Error('No se pudo obtener UID de Odoo');\n\n// Leer memoria SIN usarla como input del nodo\nconst memRow = $('Leer Memoria Antes De Validar').first()?.json || {};\nconst memRaw = memRow.datos_pendientes;\nconst mem = memRaw ? (typeof memRaw === 'string' ? JSON.parse(memRaw) : memRaw) : {};\n\n// ===================== Normalizaciones =====================\nconst normalizarHora = (txt) => {\n  if (!txt) return '';\n  const m = String(txt).match(/(\\d{1,2})[:h\\.–-]?(\\d{2})?/i);\n  if (!m) return '';\n  const hh = String(m[1]).padStart(2, '0');\n  const mm = String(m[2] ?? '00').padStart(2, '0');\n  return `${hh}:${mm}`;\n};\n\nconst normalizarFecha = (txt) => {\n  if (!txt) return '';\n  const s = String(txt).trim().toLowerCase();\n\n  // 1) Ya viene como YYYY-MM-DD\n  if (/^\\d{4}-\\d{2}-\\d{2}$/.test(s)) return s;\n\n  // 2) Limpiar día de la semana y cortar partes de hora/frases accesorias\n  const soloFecha = s\n    .replace(/^(lunes|martes|miércoles|miercoles|jueves|viernes|sábado|sabado|domingo)\\s*,?\\s+/i, '')\n    .replace(/\\s+a las\\s+.*$/i, '')\n    .replace(/\\s+de\\s+\\d{1,2}[:h\\.–-]\\d{2}.*/i, '')\n    .replace(/\\s+\\d{1,2}[:h\\.–-]\\d{2}.*/i, '')\n    .trim();\n\n  const mesesLargos = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];\n  const mesAbrevMap = {\n    ene:'enero', feb:'febrero', mar:'marzo', abr:'abril', may:'mayo', jun:'junio',\n    jul:'julio', ago:'agosto', sep:'septiembre', oct:'octubre', nov:'noviembre', dic:'diciembre'\n  };\n  const normalizarMes = (m) => {\n    const base = m.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\n    if (mesesLargos.includes(base)) return base;\n    const ab = base.slice(0,3);\n    return mesAbrevMap[ab] || '';\n  };\n\n  const yearNow = new Date().getFullYear();\n\n  // 3) “6 de octubre” o “6 de oct” con año opcional “de 2025”\n  let m = soloFecha.match(/(\\d{1,2})\\s*de\\s*([a-záéíóú]+)(?:\\s*de\\s*(\\d{4}))?/i);\n  if (m) {\n    const d = String(m[1]).padStart(2, '0');\n    const mesNorm = normalizarMes(m[2]);\n    if (mesNorm) {\n      const mm = String(mesesLargos.indexOf(mesNorm) + 1).padStart(2, '0');\n      const y = m[3] ? m[3] : String(yearNow); // si falta año → año actual\n      return `${y}-${mm}-${d}`;\n    }\n  }\n\n  // 4) “06/10[/2025]” o “06-10[-2025]”. Si falta año → año actual\n  m = soloFecha.match(/^(\\d{1,2})[\\/\\-](\\d{1,2})(?:[\\/\\-](\\d{2,4}))?$/);\n  if (m) {\n    const d  = String(m[1]).padStart(2, '0');\n    const mo = String(m[2]).padStart(2, '0');\n    const y  = m[3] ? (String(m[3]).length === 2 ? `20${m[3]}` : m[3]) : String(yearNow);\n    return `${y}-${mo}-${d}`;\n  }\n\n  // 5) “6 oct[ 2025]”\n  m = soloFecha.match(/(\\d{1,2})\\s+([a-záéíóú]+)(?:\\s+(\\d{4}))?/i);\n  if (m) {\n    const d = String(m[1]).padStart(2, '0');\n    const mesNorm = normalizarMes(m[2]);\n    if (mesNorm) {\n      const mm = String(mesesLargos.indexOf(mesNorm) + 1).padStart(2, '0');\n      const y  = m[3] ? m[3] : String(yearNow);\n      return `${y}-${mm}-${d}`;\n    }\n  }\n\n  return '';\n};\n// ===================== Fin normalizaciones =====================\n\n// Nuevos del mensaje\nconst tituloNuevo      = (datosAI.titulo || '').trim();\nconst fechaNueva       = normalizarFecha(datosAI.fecha);\nconst horaInicioNueva  = normalizarHora(datosAI.hora_inicio);\nconst horaFinNueva     = normalizarHora(datosAI.hora_fin);\nconst descripcionNueva = (datosAI.descripcion || '').trim();\n\n// Participantes entrantes (lista o usuario)\nconst participantesEntrada = Array.isArray(datosAI.participantes)\n  ? datosAI.participantes\n  : (datosAI.usuario ? [String(datosAI.usuario).trim()] : []);\n\n// Fusionar con memoria (no perder previos)\nconst participantesMem = Array.isArray(mem.participantes) ? mem.participantes : [];\nconst participantes = Array.from(new Set(\n  [...participantesMem, ...participantesEntrada]\n    .map(p => String(p || '').trim())\n    .filter(Boolean)\n));\n\nconst titulo      = tituloNuevo      || mem.titulo      || '';\nconst fecha       = fechaNueva       || mem.fecha       || '';\nconst hora_inicio = horaInicioNueva  || mem.hora_inicio || '';\nconst hora_fin    = horaFinNueva     || mem.hora_fin    || '';\nconst descripcion = descripcionNueva || mem.descripcion || '';\n\nlet datosCompletos = true;\nconst errores = [];\nif (!titulo)      { datosCompletos = false; errores.push('título del evento'); }\nif (!fecha)       { datosCompletos = false; errores.push('fecha'); }\nif (!hora_inicio) { datosCompletos = false; errores.push('hora de inicio'); }\nif (participantes.length === 0) { datosCompletos = false; errores.push('participantes'); }\n\nconst resultado = {\n  datos_completos: datosCompletos,\n  titulo, fecha, hora_inicio, hora_fin,\n  participantes, descripcion,\n  chat_id: chatId,\n  uid,\n  datos_originales: datosAI,\n};\n\nif (!datosCompletos) {\n  const faltantes = participantes.length > 0\n    ? errores.filter(f => f.toLowerCase() !== 'participantes')\n    : errores;\n\n  const datosPendientes = {\n    accion_original: 'crear_evento_calendario',\n    titulo, fecha, hora_inicio, hora_fin,\n    participantes, descripcion,\n    datos_faltantes: faltantes,\n    timestamp: new Date().toISOString(),\n  };\n\n  const piezas = [];\n  if (titulo)       piezas.push(`📝 **Título:** ${titulo}`);\n  if (fecha)        piezas.push(`📆 **Fecha:** ${fecha}`);\n  if (hora_inicio)  piezas.push(`🕐 **Hora:** ${hora_inicio}${hora_fin && hora_fin !== hora_inicio ? ` - ${hora_fin}` : ''}`);\n  if (participantes.length > 0) piezas.push(`👥 **Participantes:** ${participantes.join(', ')}`);\n  if (descripcion)  piezas.push(`📄 **Descripción:** ${descripcion}`);\n\n  const mensaje = `📅 **Creando evento de calendario**\\n\\n${piezas.length ? piezas.join('\\n') + '\\n\\n' : ''}❓ **Me faltan estos datos:**\\n${faltantes.join(', ')}\\n\\n💬 Por favor, proporciona la información faltante y yo completaré el evento automáticamente.`;\n\n  resultado.datos_pendientes = datosPendientes;\n  resultado.esperando_confirmacion = 'crear_evento_calendario';\n  resultado.ultimo_mensaje_bot = mensaje;\n  resultado.mensaje_usuario = mensaje;\n}\n\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1984,
        11520
      ],
      "id": "0498e310-cdaf-46f3-be82-9a1b213d2c47",
      "name": "Preparar Crear Evento Calendario"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.datos_completos === true }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1776,
        11520
      ],
      "id": "f76e495f-7aff-4a37-990c-847382821309",
      "name": "¿Datos Completos?"
    },
    {
      "parameters": {
        "jsCode": "// Buscar participantes del evento en Odoo\nconst datos = $json;\nconst uid = datos.uid;\nconst participantesEntrada = Array.isArray(datos.participantes) ? datos.participantes : [];\n\nconsole.log('👥 === BUSCAR PARTICIPANTES EN ODOO ===');\nconsole.log('📋 Participantes a buscar (raw):', participantesEntrada);\n\n// Normalizar: quitar vacíos/espacios, case-insensitive y sin duplicados\nconst participantes = Array.from(\n  new Set(\n    participantesEntrada\n      .map((p) => (p ?? '').toString().trim())\n      .filter((p) => p.length > 0)\n      .map((p) => p.toLowerCase())\n  )\n);\n\nconsole.log('📋 Participantes a buscar (normalizados):', participantes);\n\n// Hojas del dominio\nconst hojas = participantes.map((p) => ['name', 'ilike', p]);\n\n// Construir dominio OR PLANO (sin anidar):\n// - 0 hojas: [['id','=',-1]] (sin resultados)\n// - 1 hoja: [ ['name','ilike','laura'] ]\n// - 2 hojas: [ '|', ['name','ilike','a'], ['name','ilike','b'] ]\n// - 3 hojas: [ '|','|', ['name','ilike','a'], ['name','ilike','b'], ['name','ilike','c'] ]\nlet domain;\nif (hojas.length === 0) {\n  domain = [['id', '=', -1]];\n} else if (hojas.length === 1) {\n  domain = [hojas[0]];\n} else {\n  const pipes = Array(hojas.length - 1).fill('|');\n  domain = [...pipes, ...hojas];\n}\n\nconsole.log('🔍 Dominio OR PLANO (final):', JSON.stringify(domain, null, 2));\n\n// En execute_kw, ARGS = [domain]\nconst jsonRpcPayload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'res.partner',\n      'search_read',\n      [domain],\n      {\n        fields: ['id', 'name', 'email'],\n        limit: 50,\n      },\n    ],\n  },\n  id: Math.floor(Math.random() * 1000000),\n};\n\nconsole.log('🚀 Payload participantes generado:', JSON.stringify(jsonRpcPayload, null, 2));\n\nreturn {\n  payload: jsonRpcPayload,\n  participantes_solicitados: participantesEntrada,\n  titulo: datos.titulo,\n  fecha: datos.fecha,\n  hora_inicio: datos.hora_inicio,\n  hora_fin: datos.hora_fin,\n  descripcion: datos.descripcion,\n  chat_id: datos.chat_id,\n  uid: datos.uid,\n  datos_originales: datos.datos_originales,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1360,
        11520
      ],
      "id": "7127e38c-8959-421e-bcc7-4c0abaa2810e",
      "name": "Buscar Participantes Evento"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1152,
        11520
      ],
      "id": "9a1dfdd9-642e-40a9-ae77-07d576a1a544",
      "name": "HTTP Buscar Participantes"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -704,
        11520
      ],
      "id": "7012e89c-dba0-4875-bcff-ae047decd66c",
      "name": "HTTP Crear Evento"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta del evento creado (con enlace a Odoo)\nconst resultado = $json; // respuesta del HTTP Crear Evento\nconst datosEvento = $('Preparar Datos').item.json;\n\n// ⚙️ Cambia esto si tu URL base es distinta\nconst baseUrl = 'https://lsanchezgoshawk-n8npruebas.odoo.com';\n\nconsole.log('📅 === FORMATEAR RESPUESTA EVENTO ===');\nconsole.log('📋 Resultado Odoo:', JSON.stringify(resultado, null, 2));\nconsole.log('📋 Datos evento:', JSON.stringify(datosEvento, null, 2));\n\nlet mensaje;\nlet enlaceOdoo = null;\n\nif (resultado.error) {\n  // Error al crear el evento\n  console.error('❌ Error al crear evento:', resultado.error);\n  mensaje = `❌ **Error al crear el evento**\\n\\n🚫 ${resultado.error.data?.message || resultado.error.message || 'Error desconocido'}\\n\\nPor favor, verifica los datos e intenta de nuevo.`;\n} else if (resultado.result) {\n  // Evento creado exitosamente\n  const eventoId = resultado.result;\n  enlaceOdoo = `${baseUrl}/web#id=${eventoId}&model=calendar.event&view_type=form`;\n\n  const participantesTexto = Array.isArray(datosEvento.participantes_encontrados) && datosEvento.participantes_encontrados.length > 0\n    ? `👥 **Participantes:** ${datosEvento.participantes_encontrados.length} persona(s) invitada(s)`\n    : '';\n\n  const participantesNoEncontrados = Array.isArray(datosEvento.participantes_no_encontrados) && datosEvento.participantes_no_encontrados.length > 0\n    ? `\\n⚠️ **Nota:** No se encontraron: ${datosEvento.participantes_no_encontrados.join(', ')}`\n    : '';\n\n  mensaje =\n    `✅ **¡Evento creado exitosamente!**\\n\\n` +\n    `📅 **Evento:** ${datosEvento.titulo}\\n` +\n    `📆 **Fecha:** ${datosEvento.fecha}\\n` +\n    `🕐 **Hora:** ${datosEvento.hora_inicio}${datosEvento.hora_fin && datosEvento.hora_fin !== datosEvento.hora_inicio ? ` - ${datosEvento.hora_fin}` : ''}\\n` +\n    `${participantesTexto}${participantesNoEncontrados}\\n` +\n    `🆔 **ID:** ${eventoId}\\n\\n` +\n    `🔗 **[Abrir en Odoo](${enlaceOdoo})**\\n\\n` +\n    `¿Necesitas ayuda con algo más? 😊`;\n} else {\n  // Respuesta inesperada\n  mensaje = `⚠️ **Respuesta inesperada**\\n\\nSe procesó la solicitud pero la respuesta no es la esperada. Por favor, verifica el calendario en Odoo.`;\n}\n\nreturn {\n  chat_id: datosEvento.chat_id,\n  mensaje,\n  evento_id: resultado.result || null,\n  enlace_odoo: enlaceOdoo,\n  success: !resultado.error\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        11520
      ],
      "id": "25f89a4f-7ac9-496f-9c3f-455f59916b09",
      "name": "Formatear Respuesta Evento"
    },
    {
      "parameters": {
        "chatId": "={{ $item(0).$node[\"Formatear Respuesta Evento\"].json.chat_id }}",
        "text": "={{ $item(0).$node[\"Formatear Respuesta Evento\"].json.mensaje }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        304,
        11520
      ],
      "id": "1663999b-406f-47aa-bfce-23487edd2c47",
      "name": "Enviar Respuesta Evento",
      "webhookId": "eb2e6fa9-35ee-409e-8f95-c9bf748ecad1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Evento Incompleto').item.json.chat_id }}",
        "text": "={{ $('Guardar Memoria Evento Incompleto').item.json.mensaje_ia }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -912,
        11824
      ],
      "id": "6398dec3-5fe7-47bc-b852-f2dd3bb1745f",
      "name": "Enviar Mensaje Evento Incompleto",
      "webhookId": "ee8fedb2-85c0-4f28-94e8-f4db2485d715"
    },
    {
      "parameters": {
        "content": "## Crear ventta\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4032,
        10688
      ],
      "typeVersion": 1,
      "id": "8ce9e2ba-e38a-48c4-b084-4472aefcbeaf",
      "name": "Sticky Note - Eventos Usuario4"
    },
    {
      "parameters": {
        "content": "## Evento calendario"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3888,
        11248
      ],
      "typeVersion": 1,
      "id": "40821392-c3ba-4769-a347-16cf51b64fde",
      "name": "Sticky Note - Eventos Usuario5"
    },
    {
      "parameters": {
        "jsCode": "// Extraer datos del mensaje para limitar módulos\nconst mensaje = ($json.mensaje_usuario || $json.mensaje_original || '').toString().trim();\nconst chatId = $json.chat_id;\nconst userId = $json.user_id;\nconst userName = $json.user_name;\n\n// 1) Priorizar datos estructurados si vienen en el payload\nlet usuarioObjetivo = ($json.usuario_objetivo || '').toString().trim();\nlet modulosEntrada = Array.isArray($json.modulos) ? $json.modulos : [];\n\n// Normalizador de módulos (array o string → array limpia)\nfunction normalizarModulos(mods) {\n  if (!mods) return [];\n  if (Array.isArray(mods)) return mods.map(m => m?.toString().trim()).filter(Boolean);\n  // dividir por coma o “ y ”\n  return mods\n    .toString()\n    .split(/,| y /i)\n    .map(s => s.trim())\n    .filter(Boolean);\n}\n\n// Si faltan estructurados, intentar parsear el mensaje\nif (!usuarioObjetivo || modulosEntrada.length === 0) {\n  // Patrones típicos:\n  //  a) \"limitar el modulo <mods> a <user>\"\n  //  b) \"limitar el módulo <mods> para <user>\"\n  //  c) \"limitar modulos <mods> a <user>\"\n  //  d) \"limitar modulos a <user> <mods>\"\n  // Usamos Unicode y nombres con espacios\n  const patterns = [\n    // singular: modulo ... a|para user\n    /limitar\\s+(?:el\\s+)?m[oó]dulo\\s+(?<mods>[\\p{L}\\d\\s,_-]+?)\\s+(?:a|para)\\s+(?:usuario\\s+)?(?<user>[\\p{L}\\d\\s'.-]+)$/iu,\n    // plural: modulos ... a|para user\n    /limitar\\s+m[oó]dulos?\\s+(?<mods>[\\p{L}\\d\\s,_-]+?)\\s+(?:a|para)\\s+(?:usuario\\s+)?(?<user>[\\p{L}\\d\\s'.-]+)$/iu,\n    // plural invertido: limitar modulos a user mods\n    /limitar\\s+m[oó]dulos?\\s+(?:a|para)\\s+(?:usuario\\s+)?(?<user>[\\p{L}\\d\\s'.-]+)\\s+(?<mods>[\\p{L}\\d\\s,_-]+)$/iu,\n  ];\n\n  for (const re of patterns) {\n    const m = mensaje.match(re);\n    if (m?.groups) {\n      const modsStr = (m.groups.mods || '').trim();\n      const userStr = (m.groups.user || '').trim();\n      if (!usuarioObjetivo && userStr) usuarioObjetivo = userStr;\n      if (modulosEntrada.length === 0 && modsStr) modulosEntrada = normalizarModulos(modsStr);\n      break;\n    }\n  }\n}\n\n// Limpieza final\nusuarioObjetivo = usuarioObjetivo || '';\nconst modulos = normalizarModulos(modulosEntrada).map(m => m.toLowerCase());\n\n// Validaciones\nif (!usuarioObjetivo) {\n  throw new Error('No se pudo extraer el usuario objetivo.');\n}\nif (modulos.length === 0) {\n  throw new Error('No se pudieron extraer los módulos a limitar.');\n}\n\nreturn {\n  chat_id: chatId,\n  user_id: userId,\n  user_name: userName,\n  usuario_ejecutor: userId,\n  usuario_objetivo: usuarioObjetivo,\n  modulos: modulos,\n  mensaje_original: mensaje\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2240,
        13008
      ],
      "id": "d0b19a79-4005-4af8-bdb4-026bac6cfb89",
      "name": "Extraer Datos Limitar Módulos"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, user_name, is_admin FROM telegram_users WHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ parseInt($json.usuario_ejecutor) }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -2016,
        13008
      ],
      "id": "e3314964-b05d-4c26-9303-b314e17b38c0",
      "name": "Verificar Admin Ejecutor"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, user_name\nFROM telegram_users\nWHERE user_name ILIKE $1\n   OR CAST(user_id AS TEXT) = $2",
        "options": {
          "queryReplacement": "={{ '%' + String($('Extraer Datos Limitar Módulos').item.json.usuario_objetivo || '').trim() + '%' }} {{ String($('Extraer Datos Limitar Módulos').item.json.usuario_objetivo || '').trim() }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1280,
        12848
      ],
      "id": "b63fac3c-5340-4f67-aaa8-3dc74b5d0375",
      "name": "Buscar Usuario Objetivo",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Validación simple de auto-limitación\nconst datosExtraccion = $('Extraer Datos Limitar Módulos').item.json;\nconst datosBusqueda = $('Buscar Usuario Objetivo').item.json;\n\nconsole.log('🔒 === VALIDAR AUTO-LIMITACIÓN ===');\nconsole.log('📊 Datos extracción:', JSON.stringify(datosExtraccion, null, 2));\nconsole.log('🔍 Datos búsqueda:', JSON.stringify(datosBusqueda, null, 2));\n\nconst adminUserId = datosExtraccion.user_id;\nconst modulos = datosExtraccion.modulos;\n\n// El resultado puede ser un objeto directo o un array\nlet usuarioObjetivoId, usuarioObjetivoName;\n\nif (Array.isArray(datosBusqueda)) {\n  // Si es array, tomar el primer elemento\n  usuarioObjetivoId = datosBusqueda[0]?.user_id;\n  usuarioObjetivoName = datosBusqueda[0]?.user_name;\n} else {\n  // Si es objeto directo\n  usuarioObjetivoId = datosBusqueda.user_id;\n  usuarioObjetivoName = datosBusqueda.user_name;\n}\n\nconsole.log('👤 Admin ID:', adminUserId);\nconsole.log('🎯 Usuario objetivo ID:', usuarioObjetivoId);\nconsole.log('👤 Usuario objetivo nombre:', usuarioObjetivoName);\n\nif (!usuarioObjetivoId) {\n  throw new Error('❌ No se pudo obtener el ID del usuario objetivo');\n}\n\n// Verificar auto-limitación\nif (adminUserId.toString() === usuarioObjetivoId.toString()) {\n  throw new Error('❌ No puedes limitar tus propios permisos por seguridad.');\n}\n\nconsole.log('✅ Validación exitosa - Procediendo con la limitación');\n\n// Pasar todos los datos necesarios\nreturn {\n  admin_user_id: adminUserId,\n  usuario_objetivo_id: usuarioObjetivoId,\n  usuario_objetivo_name: usuarioObjetivoName,\n  modulos: modulos,\n  modulos_string: modulos.join(',')\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -736,
        12736
      ],
      "id": "f034ae29-4eba-42fa-8248-e615c1de3a11",
      "name": "Validar Auto-Limitación Simple"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE telegram_users SET restricted_modules = $1 WHERE user_id = $2",
        "options": {
          "queryReplacement": [
            "={{ $json.modulos_string }}",
            "={{ $json.usuario_objetivo_id }}"
          ]
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -528,
        12736
      ],
      "id": "0ab69402-7324-4bcd-90be-97a77402bdba",
      "name": "Actualizar Módulos Restringidos"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos Limitar Módulos').item.json.chat_id }}",
        "text": "={{ \n  (() => {\n    const src = $('Validar Auto-Limitación Simple').item.json;\n    const esc = (s) => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');\n    const usuario = esc(src.usuario_objetivo_name || '');\n    const mods = Array.isArray(src.modulos) ? src.modulos.map(esc).join(', ') : esc(String(src.modulos||''));\n    const ejecutor = esc($('Extraer Datos Limitar Módulos').item.json.user_name || '');\n    return `✅ <b>Módulos limitados exitosamente</b>\\n\\n👤 <b>Usuario:</b> ${usuario}\\n🔒 <b>Módulos restringidos:</b> ${mods}\\n\\n⚠️ El usuario ya no podrá acceder a estos módulos.\\n\\n<i>Acción ejecutada por:</i> ${ejecutor}`;\n  })()\n}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -304,
        12736
      ],
      "id": "8f053ac7-bcb4-43b1-a695-fc971d1e2c5b",
      "name": "Mensaje Limitación Exitosa",
      "webhookId": "430ca9ce-5e04-4b9c-9847-d52c26d3344e"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos Limitar Módulos').item.json.chat_id }}",
        "text": "❌ **No tienes permisos de administrador**\n\nSolo los administradores pueden limitar módulos a otros usuarios.\n\n🔒 Esta acción requiere permisos especiales que tu cuenta no posee.\n\nContacta con un administrador si necesitas realizar esta operación.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1504,
        13168
      ],
      "id": "75bd4b69-7ff1-4908-9fd7-91457a79c4e3",
      "name": "Mensaje Error No Admin",
      "webhookId": "64a1a268-d209-4a2c-88b0-cca0a1790d4d"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos Limitar Módulos').item.json.chat_id }}",
        "text": "❌ **Usuario no encontrado**\n\n👤 El usuario **{{ $('Extraer Datos Limitar Módulos').item.json.usuario_objetivo }}** no existe en la base de datos.\n\nVerifica que:\n• El nombre de usuario sea correcto\n• El usuario esté registrado en el sistema\n• No haya errores de escritura\n\nIntenta de nuevo con el nombre correcto.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -752,
        13072
      ],
      "id": "45cdae76-7f4e-4d2d-bd36-76a351666e27",
      "name": "Mensaje Usuario No Encontrado",
      "webhookId": "4f876561-332e-4d4b-a2b8-c2c635d18735"
    },
    {
      "parameters": {
        "content": "## vincular usuario a db"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4000,
        12016
      ],
      "typeVersion": 1,
      "id": "4bf0f144-22a5-4f6a-9e4f-8164bf98ab17",
      "name": "Sticky Note - Eventos Usuario7"
    },
    {
      "parameters": {
        "content": "## Admin pueda dar permisos"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4128,
        12848
      ],
      "typeVersion": 1,
      "id": "bb9e7c35-1441-41f7-8ce4-d0e64e11f04e",
      "name": "Sticky Note - Eventos Usuario8"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "56530085-fe75-48e9-bbb8-f44e1641e9c2",
              "leftValue": "={{ $json.usuario_existe }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1184,
        12176
      ],
      "id": "115bc7ae-8cee-4c01-bc49-6b5a18d10878",
      "name": "If1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e5f53a60-65ee-4d33-965f-455575dbaacf",
              "leftValue": "={{ $json.is_admin }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1808,
        13008
      ],
      "id": "28c24831-6ae0-415f-b224-f41791e2a183",
      "name": "If3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6ad8f613-e817-4eb2-8ed5-cbaa4a61df81",
              "leftValue": "={{ $json.user_name }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1072,
        12848
      ],
      "id": "8d1fda7e-0937-4ea1-bc9f-6688e5458b6e",
      "name": "If4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "32abb5c0-25aa-4144-aeef-9b757b57c79b",
              "leftValue": "={{ $json.restricted_modules }}",
              "rightValue": "ventas",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2128,
        10864
      ],
      "id": "df9f262b-69d3-4150-a65a-72b8753633d4",
      "name": "If5"
    },
    {
      "parameters": {
        "jsCode": "// PROCESAR DATOS DE AUSENCIA DEL AI AGENT (con odoo_user para desambiguar)\nconst datos = $json;\n\nconst chatId = datos.chat_id;\nconst userName = (datos.user_name || 'Usuario').toString().trim();\nconst userId = datos.user_id;\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconst mensajeOriginal = (datos.mensaje_original || '').trim();\nconst descripcionEntrada = (datos.descripcion || '').trim();\n\n// 🔹 Nombre de empleado que viene del switch/AI (si lo hay)\nconst empleadoEntrada = (datos.empleado || '').toString().trim();\n\n// 🔹 Determinar a quién se le registra la ausencia:\n//    - Si el agente ha extraído \"empleado\" → usarlo\n//    - Si no, usar el nombre del usuario de Telegram\nconst empleadoNombre = empleadoEntrada || userName;\n\n// 🔹 Saber si se ha especificado un empleado distinto del usuario\nconst esEmpleadoDistintoUsuario =\n  empleadoEntrada &&\n  empleadoEntrada.toLowerCase() !== userName.toLowerCase();\n\nlet tipo = (datos.tipo || datos.tipo_ausencia || '').toString().trim();\nlet fechaInicio = (datos.fecha_inicio || '').toString().trim();\nlet fechaFin = (datos.fecha_fin || fechaInicio || '').toString().trim();\nlet descripcion = descripcionEntrada || 'Solicitud de ausencia';\n\n// 🔹 Resolver odoo_user con fallbacks (login/email del empleado DEL PERFIL)\nlet odooUser = (\n  datos.odoo_user\n  || datos.cliente_perfil?.login\n  || datos.cliente_perfil?.email\n  || datos.user_mail\n  || null\n);\nodooUser = odooUser ? odooUser.toString().trim() : null;\n\n// 🔹 Si la ausencia es para OTRA PERSONA (ej: \"para abigail peterson\"),\n//    NO usamos el email del usuario de Telegram para desambiguar,\n//    porque eso forzaría a escoger siempre a Laura.\nif (esEmpleadoDistintoUsuario) {\n  odooUser = null;\n}\n\nconsole.log('🔧 AUSENCIA → empleado ENTRADA:', empleadoEntrada || '(no especificado)');\nconsole.log('🔧 AUSENCIA → empleado USADO:', empleadoNombre);\nconsole.log('🔧 AUSENCIA → user_name (Telegram):', userName);\nconsole.log('🔧 AUSENCIA → odoo_user (login/email):', odooUser);\n\n// Utilidades datetime Odoo\nfunction toOdooDateTimeUTC(d) {\n  const pad = (n) => String(n).padStart(2, '0');\n  const z = new Date(d);\n  return `${z.getUTCFullYear()}-${pad(z.getUTCMonth() + 1)}-${pad(z.getUTCDate())} ${pad(z.getUTCHours())}:${pad(z.getUTCMinutes())}:${pad(z.getUTCSeconds())}`;\n}\n\n// Imagen\nlet tieneImagen = false;\nlet imagenFileId = null;\nlet imgData = null;\ntry {\n  const datosOriginales = $('Extraer Datos').first().json;\n  imgData = datosOriginales.img_data || null;\n  if (imgData && Array.isArray(imgData.photo) && imgData.photo.length) {\n    imagenFileId = imgData.photo[imgData.photo.length - 1].file_id;\n  } else if (imgData && imgData.document && imgData.document.file_id) {\n    imagenFileId = imgData.document.file_id;\n  } else if (datosOriginales.imagen_file_id) {\n    imagenFileId = datosOriginales.imagen_file_id;\n  }\n  tieneImagen = Boolean(imagenFileId);\n} catch (_) {\n  imagenFileId = datos.imagen_file_id || null;\n  tieneImagen = Boolean(imagenFileId);\n  imgData = null;\n}\n\n// Inferir tipo si no viene\nconst msgLower = (mensajeOriginal + ' ' + descripcion).toLowerCase();\nif (!tipo) {\n  if (/(m[eé]dic|doctor|cita m[eé]dica)/i.test(msgLower)) tipo = 'Permiso Médico';\n  else if (/vacaciones?/i.test(msgLower)) tipo = 'Vacaciones';\n  else if (/permiso/i.test(msgLower)) tipo = 'Permiso';\n  else if (/baja|enfermedad/i.test(msgLower)) tipo = 'Baja';\n  else tipo = 'Permiso';\n}\n\n// Parsear rango horario SOLO desde texto\nfunction parseHora(h) {\n  const mm = String(h).match(/^(\\d{1,2})(?::|\\.|h)?(\\d{2})?$/);\n  if (!mm) return null;\n  const hh = Math.min(23, parseInt(mm[1], 10));\n  const mi = Math.min(59, mm[2] ? parseInt(mm[2], 10) : 0);\n  return { hh, mi };\n}\n\nconst textoHoras = `${descripcion} ${mensajeOriginal}`;\nlet horas = 0;\nlet rangoInicio = null;\nlet rangoFin = null;\n\n// “12-13”, “12 a 13”, “12:00 a 13:00”\nconst mRango = textoHoras.match(/(\\d{1,2}(?::\\d{2})?)\\s*(?:a|hasta|-)\\s*(\\d{1,2}(?::\\d{2})?)/i);\nif (mRango) {\n  const h1 = parseHora(mRango[1]);\n  const h2 = parseHora(mRango[2]);\n  if (h1 && h2) {\n    rangoInicio = h1; rangoFin = h2;\n    const diff = (h2.hh + h2.mi/60) - (h1.hh + h1.mi/60);\n    horas = diff > 0 ? diff : 0;\n  }\n}\nif (!mRango) {\n  const mHoras = textoHoras.match(/(\\d+(?:[.,]\\d+)?)\\s*h(?:oras?)?/i) || textoHoras.match(/(\\d+(?:[.,]\\d+)?)\\s*horas?/i);\n  if (mHoras) {\n    horas = parseFloat(mHoras[1].replace(',', '.'));\n  } else if (/hora y media/i.test(textoHoras)) {\n    horas = 1.5;\n  } else if (/media hora/i.test(textoHoras)) {\n    horas = 0.5;\n  } else if (/\\buna hora\\b/i.test(textoHoras)) {\n    horas = 1;\n  }\n}\n\n// Construir date_from/date_to\nlet usaDateTime = false;\nlet date_from = null;\nlet date_to = null;\n\nif (rangoInicio && rangoFin && fechaInicio) {\n  usaDateTime = true;\n  const base = new Date(`${fechaInicio}T00:00:00`);\n  const ini = new Date(base);  ini.setHours(rangoInicio.hh, rangoInicio.mi, 0, 0);\n  const fin = new Date(base);  fin.setHours(rangoFin.hh, rangoFin.mi, 0, 0);\n  date_from = toOdooDateTimeUTC(ini);\n  date_to   = toOdooDateTimeUTC(fin);\n} else if (horas > 0 && fechaInicio) {\n  usaDateTime = true;\n  const ini = new Date(`${fechaInicio}T09:00:00`); // por defecto 09:00\n  const fin = new Date(ini.getTime() + horas * 3600000);\n  date_from = toOdooDateTimeUTC(ini);\n  date_to   = toOdooDateTimeUTC(fin);\n}\n\n// Validaciones mínimas\nconst errores = [];\nif (!tipo) errores.push('Tipo de ausencia');\nif (!fechaInicio) errores.push('Fecha inicio');\nif (!fechaFin) errores.push('Fecha fin');\nif (errores.length) throw new Error('Faltan campos obligatorios: ' + errores.join(', '));\n\n// 🔹 Aquí ya usamos empleadoNombre calculado arriba\nreturn {\n  datos_ausencia: {\n    tipo,\n    fecha_inicio: fechaInicio,\n    fecha_fin: fechaFin,\n    date_from: usaDateTime ? date_from : null,\n    date_to: usaDateTime ? date_to : null,\n    horas: horas || null,\n    descripcion,\n    chat_id: chatId,\n    user_name: userName,          // quién lo pide por Telegram\n    odoo_user: odooUser,          // solo cuando es para él/ella\n    user_id: userId,\n    empleado_nombre: empleadoNombre, // para quién es la ausencia (Laura o Abigail)\n    empleado_origen: empleadoEntrada || null, // opcional, por si quieres loguearlo\n    tiene_imagen: tieneImagen,\n    imagen_file_id: imagenFileId,\n    img_data: imgData\n  },\n  uid,\n  mensaje_usuario: mensajeOriginal\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2352,
        13616
      ],
      "id": "ccf0ab68-e345-4f25-a7cf-373e6b523369",
      "name": "Procesar Datos Ausencia"
    },
    {
      "parameters": {
        "content": "## subida ausencia, error subir imagen\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4128,
        13440
      ],
      "typeVersion": 1,
      "id": "894b383d-a073-4611-8e75-1f3862bf2b5f",
      "name": "Sticky Note - Eventos Usuario6"
    },
    {
      "parameters": {
        "chatId": "={{ $json.datos_ausencia.chat_id }}",
        "text": "=✅ **¡Ausencia registrada exitosamente!**\n\n🗒️ **Tipo:** {{ $json.datos_ausencia.tipo }}\n📅 **Desde:** {{ $json.datos_ausencia.fecha_inicio }}\n📅 **Hasta:** {{ $json.datos_ausencia.fecha_fin }}\n📝 **Descripción:** {{ $json.datos_ausencia.descripcion }}\n👤 **Empleado:** {{ $json.datos_ausencia.empleado_nombre }}\n🆔 **ID Ausencia:** {{ $json.leave_id }}\n\n🔗 **[Abrir en Odoo]({{ $json.enlace_odoo }})**\n📸 **{{ $json.imagen_adjuntada ? 'Justificante adjunto procesado correctamente' : 'Ausencia registrada sin justificante' }}**\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1040,
        13728
      ],
      "id": "7bd4c036-2a01-49ba-af71-4a4f10a519b0",
      "name": "Confirmar Ausencia Creada",
      "webhookId": "confirmar-gasto-creado-001"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR CONSULTA DE TICKETS DEL SERVICIO DE ASISTENCIA\nconst datosUsuario = $json;\nconst chatId = datosUsuario.chat_id;\nconst uid = datosUsuario.uid;\n\nconsole.log('🎫 === PREPARAR CONSULTA TICKETS ===');\nconsole.log('💬 Chat ID:', chatId);\nconsole.log('🔑 UID:', uid);\n\n// -----------------------------\n// 1) Normalizar intención/inputs\n// -----------------------------\nconst rawMsg = (typeof datosUsuario.mensaje_original === 'string' ? datosUsuario.mensaje_original : '');\nconst msg = rawMsg.toLowerCase().replace(/\\s+/g, ' ').trim();\n\nlet intencion = datosUsuario.intencion || 'resumen';\nlet ticketId = datosUsuario.ticket_id ?? null;\nlet ticketNombre = (typeof datosUsuario.ticket_nombre === 'string' ? datosUsuario.ticket_nombre : '').trim();\nlet ticketExact = !!datosUsuario.ticket_exact;\n\n// 🚩 PRIORIDAD: si llega nombre_ticket en el input, forzamos estado_ticket\nconst nombreTicketInput = (typeof datosUsuario.nombre_ticket === 'string' ? datosUsuario.nombre_ticket : '').trim();\nif (nombreTicketInput) {\n  intencion = 'estado_ticket';\n  ticketNombre = nombreTicketInput;\n  // Si viene textual sin comillas, lo tratamos como parcial; si quieres exacto, pon ticketExact = true\n  ticketExact = false;\n}\n\n// Si no vino nombre_ticket pero el mensaje dice \"ticket <texto>\", intentamos extraer:\nif (!ticketNombre && /\\bticket(?!s)\\b/.test(msg)) {\n  // entre comillas → exacto\n  const quoted = msg.match(/\\bticket(?!s)\\b\\s+[\"“]([^\"”]+)[\"”]/i);\n  if (quoted && quoted[1]) {\n    intencion = 'estado_ticket';\n    ticketNombre = quoted[1].trim();\n    ticketExact = true;\n  } else {\n    // sin comillas → coge lo que sigue a \"ticket \"\n    const after = msg.match(/\\bticket(?!s)\\b\\s+(.+?)$/i);\n    if (after && after[1]) {\n      intencion = 'estado_ticket';\n      ticketNombre = after[1].trim();\n      ticketExact = false;\n    }\n  }\n}\n\n// Forzar \"listar_abiertos\" si nos lo dicen explícitamente\nif (datosUsuario.tipo_consulta === 'abiertos' || (msg.includes('listado') && msg.includes('abiertos'))) {\n  intencion = 'listar_abiertos';\n  ticketId = null;\n  ticketNombre = null;\n  ticketExact = false;\n}\n\n// Detectar \"cerrados\" (listado)\nconst pideCerrados = /(cerrad[oa]s?)/.test(msg) || datosUsuario.tipo_consulta === 'cerrados';\nconst ultimos7 = /(últimos?\\s*7\\s*días?|7\\s*días|ultima\\s*semana|última\\s*semana)/.test(msg);\nlet cerradosPeriodo = datosUsuario.cerrados_periodo || (ultimos7 ? 'ultimos_7' : 'todos');\n\nif (pideCerrados) {\n  intencion = 'listar_cerrados';\n  cerradosPeriodo = ultimos7 ? 'ultimos_7' : cerradosPeriodo;\n  ticketId = null;\n  ticketNombre = null;\n  ticketExact = false;\n}\n\n// Si la intención es listar_abiertos o listar_cerrados, no arrastrar nombres\nif (intencion === 'listar_abiertos' || intencion === 'listar_cerrados') {\n  ticketId = null;\n  ticketNombre = null;\n  ticketExact = false;\n}\n\n// Si la intención es estado_ticket, limpia nombres genéricos\nif (intencion === 'estado_ticket') {\n  const tooGeneric = ['abierto','abiertos','cerrado','cerrados','tickets','listado','s abiertos','los abiertos'];\n  if (!ticketId && (!ticketNombre || tooGeneric.some(w => ticketNombre.toLowerCase().includes(w)))) {\n    console.log('ℹ️ Nombre genérico; cambiamos a listar_abiertos');\n    intencion = 'listar_abiertos';\n    ticketNombre = null;\n    ticketExact = false;\n  }\n}\n\nconsole.log('🧭 INTENCION:', intencion, '| ticket_id:', ticketId, '| ticket_nombre:', ticketNombre, '| exact:', ticketExact, '| cerrados_periodo:', cerradosPeriodo);\n\n// -----------------------------\n// 2) Fechas (local) YYYY-MM-DD\n// -----------------------------\nfunction formatDateLocal(d) {\n  const year = d.getFullYear();\n  const month = String(d.getMonth() + 1).padStart(2, '0');\n  const day = String(d.getDate()).padStart(2, '0');\n  return `${year}-${month}-${day}`;\n}\nconst hoy = new Date();\nconst hace7Dias = new Date();\nhace7Dias.setDate(hoy.getDate() - 7);\nconst fechaHoy = formatDateLocal(hoy);\nconst fechaHace7Dias = formatDateLocal(hace7Dias);\n\n// -----------------------------\n// 3) Dominios base + filtro por equipo (opcional)\n// -----------------------------\nconst teamId = datosUsuario.team_id || null;\nconst addTeamFilter = (domain) => {\n  const d = Array.isArray(domain) ? [...domain] : [];\n  if (teamId) d.push(['team_id', '=', teamId]);\n  return d;\n};\n\n// Abiertos = etapas NO plegadas\nconst dominioAbiertos = addTeamFilter([['stage_id.fold', '=', false]]);\n\n// Cerrados base = etapa plegada\nconst dominioCerradosBase = addTeamFilter([['stage_id.fold', '=', true]]);\n\n// Cerrados últimos 7 días\nconst dominioCerradosUlt7 = addTeamFilter([\n  ['stage_id.fold', '=', true],\n  ['close_date', '>=', fechaHace7Dias],\n  ['close_date', '<=', fechaHoy],\n]);\n\n// Abiertos creados en últimos 7 días\nconst dominioAbiertosUlt7 = addTeamFilter([\n  ['create_date', '>=', fechaHace7Dias],\n  ['create_date', '<=', fechaHoy],\n  ['stage_id.fold', '=', false],\n]);\n\n// --- helper: limpia el nombre\nfunction cleanName(s) {\n  return (s || '').toString().replace(/\\s+/g, ' ').trim();\n}\nconst nameClean = cleanName(ticketNombre);\n\n// Construye un dominio OR robusto por nombre\nfunction buildNameDomain(name, exact) {\n  if (!name) return [['id', '=', -1]];\n  if (exact) return [['name', '=', name]]; // exacto\n  const collapsed = name.replace(/\\s+/g, '%'); // 'Wood Treatment' -> 'Wood%Treatment'\n  return ['|','|',\n    ['name', '=', name],\n    ['name', 'ilike', name],\n    ['name', 'ilike', collapsed]\n  ];\n}\n\n// Dominio ticket concreto (id tiene prioridad)\nlet dominioTicketConcreto;\nif (ticketId) {\n  dominioTicketConcreto = addTeamFilter([['id', '=', Number(ticketId)]]);\n} else if (nameClean) {\n  const nameDomain = buildNameDomain(nameClean, ticketExact);\n  // AND(team) con OR(name)\n  dominioTicketConcreto = teamId ? [['team_id', '=', teamId], nameDomain] : nameDomain;\n} else {\n  dominioTicketConcreto = addTeamFilter([['id', '=', -1]]);\n}\n\n// -----------------------------\n// 4) Parámetros Odoo\n// -----------------------------\nconst DB = 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst PASSWORD = 'admin'; // tu token/clave\n\nfunction rpcCount(model, domain) {\n  return {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [DB, uid, PASSWORD, model, 'search_count', [domain]],\n    },\n    id: Math.floor(Math.random() * 1_000_000),\n  };\n}\nfunction rpcRead(model, domain, fields, extra = {}) {\n  return {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [DB, uid, PASSWORD, model, 'search_read', [domain], { fields, ...extra }],\n    },\n    id: Math.floor(Math.random() * 1_000_000),\n  };\n}\n\n// -----------------------------\n// 5) Consultas\n// -----------------------------\nconst consultaTicketsAbiertos = rpcCount('helpdesk.ticket', dominioAbiertos);\nconst consultaTicketsCerradosUltimos7Dias = rpcCount('helpdesk.ticket', dominioCerradosUlt7);\nconst consultaTicketsAbiertosUltimos7Dias = rpcCount('helpdesk.ticket', dominioAbiertosUlt7);\n\n// Todos (para desglose)\nconst domainTodos = teamId ? addTeamFilter([]) : [];\nconst consultaTodosTicketsConEstados = rpcRead(\n  'helpdesk.ticket',\n  domainTodos,\n  ['id', 'name', 'stage_id', 'create_date', 'close_date'],\n  { limit: 1000 }\n);\n\n// Listado de tickets abiertos\nconst consultaListadoAbiertos = rpcRead(\n  'helpdesk.ticket',\n  dominioAbiertos,\n  ['id', 'name', 'stage_id', 'partner_id', 'user_id', 'priority', 'create_date', 'close_date'],\n  { limit: 50, order: 'create_date desc' }\n);\n\n// Listado de tickets cerrados\nconst dominioCerradosListar = (cerradosPeriodo === 'ultimos_7') ? dominioCerradosUlt7 : dominioCerradosBase;\nconst consultaListadoCerrados = rpcRead(\n  'helpdesk.ticket',\n  dominioCerradosListar,\n  ['id', 'name', 'stage_id', 'partner_id', 'user_id', 'priority', 'create_date', 'close_date'],\n  { limit: 50, order: 'close_date desc, create_date desc' }\n);\n\n// Estado de un ticket concreto\nconst consultaEstadoTicket = rpcRead(\n  'helpdesk.ticket',\n  dominioTicketConcreto,\n  ['id','name','stage_id','partner_id','user_id','priority','create_date','close_date'],\n  { limit: ticketExact ? 1 : 5, order: 'create_date desc' }\n);\n\nconsole.log('🧭 Final INTENCION:', intencion);\nconsole.log('🧪 Dominio estado_ticket:', JSON.stringify(dominioTicketConcreto));\nconsole.log('🧪 Payload consulta_estado_ticket:', JSON.stringify(consultaEstadoTicket, null, 2));\nconsole.log('🚀 Consultas preparadas para tickets');\n\n// -----------------------------\n// 6) Devolver todo para los HTTP\n// -----------------------------\nreturn {\n  chat_id: chatId,\n  uid,\n  intencion,\n  team_id: teamId,\n  ticket_id: ticketId || null,\n  ticket_nombre: nameClean || null,\n  ticket_exact: ticketExact,\n  cerrados_periodo: cerradosPeriodo,\n  fecha_hoy: fechaHoy,\n  fecha_hace_7_dias: fechaHace7Dias,\n\n  // Resumen\n  consulta_abiertos: consultaTicketsAbiertos,\n  consulta_cerrados_7_dias: consultaTicketsCerradosUltimos7Dias,\n  consulta_abiertos_7_dias: consultaTicketsAbiertosUltimos7Dias,\n  consulta_todos_estados: consultaTodosTicketsConEstados,\n\n  // Listados\n  consulta_listado_abiertos: consultaListadoAbiertos,\n  consulta_listado_cerrados: consultaListadoCerrados,\n\n  // Estado concreto\n  consulta_estado_ticket: consultaEstadoTicket,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2016,
        14080
      ],
      "id": "96b65b7f-4df9-45b3-b5ba-5b50cdfc16fd",
      "name": "Preparar Consulta Tickets"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_abiertos }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1824,
        14080
      ],
      "id": "91117674-dc6d-4e16-a0dd-42b9fcc38948",
      "name": "HTTP Tickets Abiertos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Preparar Consulta Tickets').item.json.consulta_cerrados_7_dias }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1632,
        14080
      ],
      "id": "ed82fa94-af98-4058-80e4-c3e797e2162a",
      "name": "HTTP Tickets Cerrados 7 Días"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Preparar Consulta Tickets').item.json.consulta_abiertos_7_dias }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1408,
        14080
      ],
      "id": "ab4a592e-af89-4459-b767-641e301d1dd7",
      "name": "HTTP Tickets Abiertos 7 Días"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Preparar Consulta Tickets').item.json.consulta_todos_estados }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1200,
        14080
      ],
      "id": "7d6a8249-eed5-4538-97d7-56a40944dc5c",
      "name": "HTTP Tickets Todos Estados"
    },
    {
      "parameters": {
        "jsCode": "// CONSOLIDAR RESULTADOS DE CONSULTAS DE TICKETS\nconst prep = $('Preparar Consulta Tickets').item.json;\n\nconst resAbiertosCount = $('HTTP Tickets Abiertos').item.json.result || 0;\nconst resCerrados7Count = $('HTTP Tickets Cerrados 7 Días').item.json.result || 0;\nconst resAbiertos7Count = $('HTTP Tickets Abiertos 7 Días').item.json.result || 0;\nconst resTodos = $('HTTP Tickets Todos Estados').item.json.result || [];\n\nconst resListadoAbiertos = $('HTTP Listado Abiertos').item.json.result || [];\nlet resListadoCerrados = [];\ntry { resListadoCerrados = $('HTTP Listado Cerrados').item.json.result || []; } catch(e) { /* si aún no lo conectaste */ }\n\nlet resEstadoTicket = [];\ntry { resEstadoTicket = $('HTTP Estado Ticket').item.json.result || []; } catch(e) { /* idem */ }\n\nfunction fmtM2O(val) { return Array.isArray(val) ? val[1] : (val || '—'); }\n\nconst intent = prep.intencion || 'resumen';\n\n// ====== INTENCION: LISTAR ABIERTOS ======\nif (intent === 'listar_abiertos') {\n  if (!resListadoAbiertos.length) {\n    return { chat_id: prep.chat_id, texto: '📂 No hay tickets abiertos en este momento.' };\n  }\n  const max = 25;\n  const lines = resListadoAbiertos.slice(0, max).map(t =>\n    `• #${t.id} — ${t.name}  |  Estado: ${fmtM2O(t.stage_id)}`\n  );\n  const extra = resListadoAbiertos.length > max ? `\\n… y ${resListadoAbiertos.length - max} más.` : '';\n  return {\n    chat_id: prep.chat_id,\n    texto: `🟢 **Tickets abiertos (${resListadoAbiertos.length})**\\n\\n${lines.join('\\n')}${extra}`\n  };\n}\n\n// ====== INTENCION: LISTAR CERRADOS ======\nif (intent === 'listar_cerrados') {\n  const periodo = prep.cerrados_periodo === 'ultimos_7' ? ` (últimos 7 días)` : '';\n  if (!resListadoCerrados.length) {\n    return { chat_id: prep.chat_id, texto: `📁 No hay tickets cerrados${periodo}.` };\n  }\n  const max = 25;\n  const lines = resListadoCerrados.slice(0, max).map(t =>\n    `• #${t.id} — ${t.name}  |  Estado: ${fmtM2O(t.stage_id)}  |  Cerrado: ${t.close_date || '—'}`\n  );\n  const extra = resListadoCerrados.length > max ? `\\n… y ${resListadoCerrados.length - max} más.` : '';\n  return {\n    chat_id: prep.chat_id,\n    texto: `🔒 **Tickets cerrados${periodo} (${resListadoCerrados.length})**\\n\\n${lines.join('\\n')}${extra}`\n  };\n}\n\n// ====== INTENCION: ESTADO TICKET ======\nif (intent === 'estado_ticket') {\n  const id = prep.ticket_id;\n  const name = prep.ticket_nombre;\n  if (!id && !name) {\n    return {\n      chat_id: prep.chat_id,\n      texto: 'ℹ️ Para ver el estado de un ticket, dime el **número** (p. ej., `ticket 24`) o el **nombre exacto entre comillas** (p. ej., `ticket \"Install High-speed Internet\"`).'\n    };\n  }\n  if (!resEstadoTicket.length) {\n    const ref = id ? `#${id}` : `\"${name}\"`;\n    return { chat_id: prep.chat_id, texto: `❓ No encontré el ticket ${ref}.` };\n  }\n  if (resEstadoTicket.length > 1 && !prep.ticket_exact) {\n    const max = 5;\n    const lines = resEstadoTicket.slice(0, max).map(t =>\n      `• #${t.id} — ${t.name}  |  Estado: ${fmtM2O(t.stage_id)}`\n    );\n    const extra = resEstadoTicket.length > max ? `\\n… y ${resEstadoTicket.length - max} más.` : '';\n    return {\n      chat_id: prep.chat_id,\n      texto: `🔎 Encontré varias coincidencias:\\n\\n${lines.join('\\n')}${extra}\\n\\nEscribe el **número** de ticket o el **nombre exacto entre comillas**.`\n    };\n  }\n  const t = resEstadoTicket[0];\n  const detalle =\n    `🧾 **Ticket #${t.id} — ${t.name}**\\n` +\n    `• Estado: ${fmtM2O(t.stage_id)}\\n` +\n    `• Cliente: ${fmtM2O(t.partner_id)}\\n` +\n    `• Asignado a: ${fmtM2O(t.user_id)}\\n` +\n    `• Prioridad: ${t.priority || '—'}\\n` +\n    `• Creado: ${t.create_date || '—'}\\n` +\n    `• Cerrado: ${t.close_date || '—'}`;\n  return { chat_id: prep.chat_id, texto: detalle };\n}\n\n// ====== RESUMEN (por defecto) ======\nconst estados = {};\nresTodos.forEach(t => {\n  const s = fmtM2O(t.stage_id);\n  estados[s] = (estados[s] || 0) + 1;\n});\nconst total = resTodos.length;\n\nlet texto = `🎫 **ESTADO DEL SERVICIO DE ASISTENCIA**\\n\\n` +\n  `📊 **RESUMEN GENERAL:**\\n` +\n  `• **Tickets abiertos:** ${resAbiertosCount}\\n` +\n  `• **Tickets cerrados (últimos 7 días):** ${resCerrados7Count}\\n` +\n  `• **Tickets abiertos (últimos 7 días):** ${resAbiertos7Count}\\n` +\n  `• **Total de tickets en sistema:** ${total}\\n\\n`;\n\nif (Object.keys(estados).length) {\n  texto += `🏷️ **DESGLOSE POR ESTADOS:**\\n`;\n  Object.entries(estados)\n    .sort((a,b) => b[1]-a[1])\n    .forEach(([estado, n]) => {\n      const p = total ? ((n/total)*100).toFixed(1) : '0.0';\n      texto += `  • **${estado}:** ${n} (${p}%)\\n`;\n    });\n}\ntexto += `\\n📅 Período: ${prep.fecha_hace_7_dias} → ${prep.fecha_hoy}`;\n\nreturn { chat_id: prep.chat_id, texto };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        14080
      ],
      "id": "20805306-7078-443e-a6ea-c548619efe41",
      "name": "Consolidar Resultados Tickets"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -64,
        14080
      ],
      "id": "a62f08bf-439f-4614-aef3-f1563f59ef63",
      "name": "Enviar Respuesta Tickets",
      "webhookId": "tickets-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// BUSCAR TICKET ESPECÍFICO PARA AÑADIR MENSAJE\nconst datosUsuario = $json;\nconst chatId = datosUsuario.chat_id;\nconst uid = datosUsuario.uid;\nconst ticketId = datosUsuario.ticket_id || datosUsuario.ticket || datosUsuario.ticket_nombre || datosUsuario.ticket_id_o_nombre || datosUsuario.ticket_identificador;\nconst mensaje = datosUsuario.mensaje;\n\nconsole.log('🎫 === BUSCAR TICKET PARA MENSAJE ===');\nconsole.log('💬 Chat ID:', chatId);\nconsole.log('🔑 UID:', uid);\nconsole.log('🎫 Ticket ID/Nombre:', ticketId);\nconsole.log('💬 Mensaje a añadir:', mensaje);\n\nif (!ticketId) {\n  console.error('❌ No se proporcionó ID o nombre del ticket');\n  return {\n    error: true,\n    mensaje_error: 'No se especificó el ticket al que añadir el mensaje',\n    chat_id: chatId\n  };\n}\n\nif (!mensaje) {\n  console.error('❌ No se proporcionó mensaje para añadir');\n  return {\n    error: true,\n    mensaje_error: 'No se especificó el mensaje a añadir al ticket',\n    chat_id: chatId\n  };\n}\n\n// Preparar consulta para buscar el ticket\n// Buscar por ID numérico o por nombre\nlet filtrosBusqueda;\nif (/^\\d+$/.test(ticketId)) {\n  // Es un ID numérico\n  filtrosBusqueda = [[\"id\", \"=\", parseInt(ticketId)]];\n} else {\n  // Es un nombre, buscar por nombre o referencia\n  filtrosBusqueda = [\n    \"|\",\n    [\"name\", \"ilike\", ticketId],\n    [\"ticket_ref\", \"ilike\", ticketId]\n  ];\n}\n\nconst consultaBuscarTicket = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"helpdesk.ticket\",\n      \"search_read\",\n      [filtrosBusqueda],\n      {\n        fields: [\"id\", \"name\", \"ticket_ref\", \"stage_id\", \"partner_id\", \"create_date\"],\n        limit: 5\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Consulta preparada para buscar ticket:', JSON.stringify(consultaBuscarTicket, null, 2));\n\nreturn {\n  chat_id: chatId,\n  uid: uid,\n  ticket_buscado: ticketId,\n  mensaje_anadir: mensaje,\n  consulta_buscar_ticket: consultaBuscarTicket\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2624,
        14624
      ],
      "id": "b5f08d34-bf50-40db-a1bf-2f8b0309dcb7",
      "name": "Buscar Ticket para Mensaje"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_buscar_ticket }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2384,
        14624
      ],
      "id": "72e0cfad-51aa-459e-a76c-734806c83ca2",
      "name": "HTTP Buscar Ticket"
    },
    {
      "parameters": {
        "jsCode": "// VALIDAR TICKET ENCONTRADO Y PREPARAR MENSAJE\nconst datosBusqueda = $('Buscar Ticket para Mensaje').item.json;\nconst resultadoBusqueda = $json.result || [];\n\nconsole.log('🎫 === VALIDAR TICKET ENCONTRADO ===');\nconsole.log('🔍 Tickets encontrados:', resultadoBusqueda.length);\nconsole.log('📋 Resultados:', JSON.stringify(resultadoBusqueda, null, 2));\n\n// OBTENER DATOS DEL USUARIO DE ODOO DESDE CONSULTAR USUARIO TELEGRAM\nlet odooUser = null;\ntry {\n  const datosUsuarioTelegram = $('Consultar Usuario Telegram').item.json;\n  odooUser = datosUsuarioTelegram.odoo_user;\n  console.log('👤 Usuario Odoo obtenido:', odooUser);\n} catch (error) {\n  console.log('⚠️ No se pudo obtener usuario Odoo:', error.message);\n}\n\nif (resultadoBusqueda.length === 0) {\n  console.log('❌ Ticket no encontrado');\n  return {\n    error: true,\n    ticket_encontrado: false,\n    mensaje_error: `No se encontró ningún ticket con el identificador \"${datosBusqueda.ticket_buscado}\". Verifica que el ID o nombre del ticket sea correcto.`,\n    chat_id: datosBusqueda.chat_id\n  };\n}\n\nif (resultadoBusqueda.length > 1) {\n  console.log('⚠️ Múltiples tickets encontrados');\n  let listaTickets = resultadoBusqueda.map((ticket, index) => \n    `${index + 1}. **${ticket.name}** (ID: ${ticket.id})${ticket.ticket_ref ? ` - Ref: ${ticket.ticket_ref}` : ''}`\n  ).join('\\n');\n  \n  return {\n    error: true,\n    tickets_multiples: true,\n    mensaje_error: `Se encontraron múltiples tickets. Por favor, especifica cuál:\\n\\n${listaTickets}\\n\\nUsa el ID exacto del ticket que deseas.`,\n    chat_id: datosBusqueda.chat_id,\n    tickets_encontrados: resultadoBusqueda\n  };\n}\n\n// Ticket único encontrado\nconst ticket = resultadoBusqueda[0];\nconsole.log('✅ Ticket único encontrado:', ticket);\n\n// CONSTRUIR MENSAJE CON FORMATO: \"mensaje -- usuario_odoo\"\nlet mensajeCompleto = datosBusqueda.mensaje_anadir;\nif (odooUser && odooUser.trim()) {\n  mensajeCompleto = `${datosBusqueda.mensaje_anadir} -- ${odooUser}`;\n  console.log('✅ Mensaje formateado con usuario Odoo:', mensajeCompleto);\n} else {\n  console.log('⚠️ Sin usuario Odoo, usando mensaje original');\n}\n\n// Preparar mensaje para el chatter\nconst mensajeChatter = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      datosBusqueda.uid,\n      \"admin\",\n      \"mail.message\",\n      \"create\",\n      [{\n        res_id: ticket.id,\n        model: \"helpdesk.ticket\",\n        message_type: \"comment\",\n        body: `<p>${mensajeCompleto}</p>`,\n        subtype_id: 1  // mt_comment\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('💬 Mensaje preparado para chatter:', JSON.stringify(mensajeChatter, null, 2));\n\nreturn {\n  ticket_encontrado: true,\n  ticket: ticket,\n  chat_id: datosBusqueda.chat_id,\n  uid: datosBusqueda.uid,\n  mensaje_original: datosBusqueda.mensaje_anadir,\n  mensaje_completo: mensajeCompleto,\n  odoo_user: odooUser,\n  consulta_mensaje_chatter: mensajeChatter\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2144,
        14624
      ],
      "id": "96dda100-040e-46a8-a88a-f9e2419f3354",
      "name": "Validar Ticket y Preparar Mensaje"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_mensaje_chatter }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1456,
        14528
      ],
      "id": "1e967e9b-3f10-4e9e-8316-bc18cfdc82da",
      "name": "HTTP Añadir Mensaje Chatter"
    },
    {
      "parameters": {
        "chatId": "={{ $('Validar Ticket y Preparar Mensaje').item.json.chat_id }}",
        "text": "=✅ ¡Mensaje añadido exitosamente al ticket!\n\n🎫 Ticket: {{ $('Validar Ticket y Preparar Mensaje').item.json.ticket.name }}\n🆔 ID: {{ $('Validar Ticket y Preparar Mensaje').item.json.ticket.id }}\n💬 Mensaje añadido: {{ $('Validar Ticket y Preparar Mensaje').item.json.mensaje_original }}\n\n📝 El mensaje se ha registrado en el historial del ticket y será visible para todos los usuarios con acceso.\n\n💡 ¿Necesitas añadir algún mensaje más o realizar otra consulta? 😊",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1216,
        14528
      ],
      "id": "dabd894e-9c0c-4206-b0d1-d317b90969eb",
      "name": "Confirmar Mensaje Añadido",
      "webhookId": "mensaje-ticket-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=❌ **Error al buscar ticket**\n\n{{ $json.mensaje_error }}\n\n💡 **Ejemplos de uso:**\n• \"añadir mensaje al ticket 123: Problema resuelto\"\n• \"comentar en ticket Soporte técnico: Cliente satisfecho\"\n• \"responder al ticket 456: Pendiente de revisión\"\n\n🔍 **Consejos:**\n• Usa el ID numérico exacto del ticket\n• O usa parte del nombre del ticket\n• Asegúrate de incluir el mensaje a añadir",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1664,
        14720
      ],
      "id": "047f1cb8-9685-416e-9e2f-19d6dbbb295e",
      "name": "Error Ticket No Encontrado",
      "webhookId": "error-ticket-webhook-001"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "550fbe53-6926-4985-a304-9e2a7999516d",
              "leftValue": "={{ $json.ticket_encontrado }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1936,
        14624
      ],
      "id": "019367a2-0731-4542-8cfd-540371d78720",
      "name": "If6"
    },
    {
      "parameters": {
        "content": "## resumen tickets\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4192,
        14032
      ],
      "typeVersion": 1,
      "id": "ac92a106-a00a-4105-aa77-aa0d30e6c261",
      "name": "Sticky Note - Eventos Usuario9"
    },
    {
      "parameters": {
        "content": "## añadior nota a ticket\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4224,
        14560
      ],
      "typeVersion": 1,
      "id": "515b3e11-bb97-46b4-930b-d400f3dd7879",
      "name": "Sticky Note - Eventos Usuario10"
    },
    {
      "parameters": {
        "jsCode": "// CONSULTAR FABRICACIONES CON FILTROS POR PERÍODO\nconst datosUsuario = $json;\nconst chatId = datosUsuario.chat_id;\nconst uid = datosUsuario.uid;\nconst mensajeUsuario = datosUsuario.mensaje_original || datosUsuario.mensaje_usuario || '';\n\nconsole.log('🏭 === CONSULTAR FABRICACIONES ===');\nconsole.log('💬 Chat ID:', chatId);\nconsole.log('🔑 UID:', uid);\nconsole.log('📝 Mensaje usuario:', mensajeUsuario);\n\n// DETECTAR FILTROS DE PERÍODO EN EL MENSAJE\nlet filtroFecha = [];\nlet descripcionPeriodo = 'todas las fabricaciones';\nconst ahora = new Date();\nconst hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());\n\n// Detectar períodos específicos\nif (mensajeUsuario.includes('hoy') || mensajeUsuario.includes('día')) {\n  const fechaHoy = hoy.toISOString().split('T')[0];\n  filtroFecha = [['create_date', '>=', fechaHoy + ' 00:00:00'], ['create_date', '<=', fechaHoy + ' 23:59:59']];\n  descripcionPeriodo = 'de hoy';\n} else if (mensajeUsuario.includes('ayer')) {\n  const ayer = new Date(hoy);\n  ayer.setDate(hoy.getDate() - 1);\n  const fechaAyer = ayer.toISOString().split('T')[0];\n  filtroFecha = [['create_date', '>=', fechaAyer + ' 00:00:00'], ['create_date', '<=', fechaAyer + ' 23:59:59']];\n  descripcionPeriodo = 'de ayer';\n} else if (mensajeUsuario.includes('esta semana') || mensajeUsuario.includes('semana actual')) {\n  const inicioSemana = new Date(hoy);\n  inicioSemana.setDate(hoy.getDate() - hoy.getDay());\n  const finSemana = new Date(inicioSemana);\n  finSemana.setDate(inicioSemana.getDate() + 6);\n  filtroFecha = [['create_date', '>=', inicioSemana.toISOString().split('T')[0] + ' 00:00:00'], ['create_date', '<=', finSemana.toISOString().split('T')[0] + ' 23:59:59']];\n  descripcionPeriodo = 'de esta semana';\n} else if (mensajeUsuario.includes('este mes') || mensajeUsuario.includes('mes actual')) {\n  const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);\n  const finMes = new Date(ahora.getFullYear(), ahora.getMonth() + 1, 0);\n  filtroFecha = [['create_date', '>=', inicioMes.toISOString().split('T')[0] + ' 00:00:00'], ['create_date', '<=', finMes.toISOString().split('T')[0] + ' 23:59:59']];\n  descripcionPeriodo = 'de este mes';\n} else if (mensajeUsuario.includes('mes pasado') || mensajeUsuario.includes('último mes')) {\n  const inicioMesPasado = new Date(ahora.getFullYear(), ahora.getMonth() - 1, 1);\n  const finMesPasado = new Date(ahora.getFullYear(), ahora.getMonth(), 0);\n  filtroFecha = [['create_date', '>=', inicioMesPasado.toISOString().split('T')[0] + ' 00:00:00'], ['create_date', '<=', finMesPasado.toISOString().split('T')[0] + ' 23:59:59']];\n  descripcionPeriodo = 'del mes pasado';\n}\n\n// DETECTAR FILTROS DE ESTADO\nlet filtroEstado = [];\nlet descripcionEstado = '';\nif (mensajeUsuario.includes('pendiente') || mensajeUsuario.includes('por hacer')) {\n  filtroEstado = [['state', 'in', ['draft', 'confirmed', 'progress']]];\n  descripcionEstado = ' pendientes';\n} else if (mensajeUsuario.includes('en progreso') || mensajeUsuario.includes('en curso')) {\n  filtroEstado = [['state', '=', 'progress']];\n  descripcionEstado = ' en progreso';\n} else if (mensajeUsuario.includes('terminada') || mensajeUsuario.includes('completada') || mensajeUsuario.includes('hecha')) {\n  filtroEstado = [['state', '=', 'done']];\n  descripcionEstado = ' terminadas';\n} else if (mensajeUsuario.includes('cancelada') || mensajeUsuario.includes('cancelado')) {\n  filtroEstado = [['state', '=', 'cancel']];\n  descripcionEstado = ' canceladas';\n}\n\n// COMBINAR FILTROS\nlet filtrosCombinados = [];\nif (filtroFecha.length > 0 && filtroEstado.length > 0) {\n  filtrosCombinados = [...filtroFecha, ...filtroEstado];\n} else if (filtroFecha.length > 0) {\n  filtrosCombinados = filtroFecha;\n} else if (filtroEstado.length > 0) {\n  filtrosCombinados = filtroEstado;\n} else {\n  // Sin filtros específicos, mostrar las últimas 10\n  filtrosCombinados = [];\n}\n\nconsole.log('🔍 Filtros aplicados:', JSON.stringify(filtrosCombinados, null, 2));\nconsole.log('📅 Descripción período:', descripcionPeriodo);\nconsole.log('📊 Descripción estado:', descripcionEstado);\n\n// CONSULTA A ODOO PARA ÓRDENES DE FABRICACIÓN\nconst consultaFabricaciones = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"mrp.production\",\n      \"search_read\",\n      [filtrosCombinados],\n      {\n        fields: [\"id\", \"name\", \"product_id\", \"product_qty\", \"product_uom_id\", \"state\", \"date_planned_start\", \"date_planned_finished\", \"date_finished\", \"user_id\", \"company_id\", \"priority\"],\n        limit: 20,\n        order: \"date_planned_start desc\"\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Consulta preparada para fabricaciones:', JSON.stringify(consultaFabricaciones, null, 2));\n\nreturn {\n  chat_id: chatId,\n  uid: uid,\n  descripcion_periodo: descripcionPeriodo,\n  descripcion_estado: descripcionEstado,\n  mensaje_usuario: mensajeUsuario,\n  consulta_fabricaciones: consultaFabricaciones\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2688,
        15136
      ],
      "id": "69357698-ff86-4517-b44d-a6decf1866d5",
      "name": "Consultar Fabricaciones"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_fabricaciones }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2288,
        15136
      ],
      "id": "f5f9cadf-4e3f-457a-9b1e-fffbdc0b6a0c",
      "name": "HTTP Fabricaciones"
    },
    {
      "parameters": {
        "jsCode": "// PROCESAR RESULTADOS DE FABRICACIONES\nconst datosBusqueda = $('Consultar Fabricaciones').item.json;\nconst resultadoFabricaciones = $json.result || [];\n\nconsole.log('🏭 === PROCESAR FABRICACIONES ===');\nconsole.log('📊 Fabricaciones encontradas:', resultadoFabricaciones.length);\nconsole.log('📋 Resultados:', JSON.stringify(resultadoFabricaciones, null, 2));\n\nif (resultadoFabricaciones.length === 0) {\n  console.log('❌ No se encontraron fabricaciones');\n  return {\n    chat_id: datosBusqueda.chat_id,\n    mensaje_telegram: `❌ No se encontraron órdenes de fabricación${datosBusqueda.descripcion_estado} ${datosBusqueda.descripcion_periodo}.\\n\\n💡 **Sugerencias:**\\n• Prueba con un período más amplio\\n• Verifica si hay fabricaciones en el sistema\\n• Usa términos como \"fabricaciones de este mes\" o \"producción en progreso\"`\n  };\n}\n\n// MAPEAR ESTADOS A EMOJIS Y TEXTO\nconst estadosMap = {\n  'draft': '📝 Borrador',\n  'confirmed': '✅ Confirmada',\n  'progress': '🔄 En Progreso',\n  'to_close': '⏳ Por Cerrar',\n  'done': '✅ Terminada',\n  'cancel': '❌ Cancelada'\n};\n\n// FORMATEAR RESULTADOS\nlet mensaje = `🏭 **Órdenes de Fabricación${datosBusqueda.descripcion_estado} ${datosBusqueda.descripcion_periodo}**\\n\\n`;\nmensaje += `📊 **Total encontradas:** ${resultadoFabricaciones.length}\\n\\n`;\n\n// ESTADÍSTICAS POR ESTADO\nconst estadisticas = {};\nresultadoFabricaciones.forEach(fab => {\n  const estado = fab.state || 'unknown';\n  estadisticas[estado] = (estadisticas[estado] || 0) + 1;\n});\n\nmensaje += `📈 **Resumen por estado:**\\n`;\nObject.entries(estadisticas).forEach(([estado, cantidad]) => {\n  const estadoTexto = estadosMap[estado] || `❓ ${estado}`;\n  mensaje += `${estadoTexto}: ${cantidad}\\n`;\n});\nmensaje += `\\n`;\n\n// LISTADO DETALLADO (máximo 10 para no saturar)\nconst fabricacionesMostrar = resultadoFabricaciones.slice(0, 10);\nmensaje += `📋 **Detalle de fabricaciones:**\\n`;\n\nfabricacionesMostrar.forEach((fab, index) => {\n  const estadoEmoji = estadosMap[fab.state] || `❓ ${fab.state}`;\n  const producto = fab.product_id ? fab.product_id[1] : 'Producto no especificado';\n  const cantidad = fab.product_qty || 0;\n  const unidad = fab.product_uom_id ? fab.product_uom_id[1] : 'uds';\n  const fechaInicio = fab.date_planned_start ? new Date(fab.date_planned_start).toLocaleDateString('es-ES') : 'No programada';\n  const fechaFin = fab.date_planned_finished ? new Date(fab.date_planned_finished).toLocaleDateString('es-ES') : 'No programada';\n  \n  mensaje += `\\n${index + 1}. **${fab.name || 'Sin nombre'}**\\n`;\n  mensaje += `   📦 Producto: ${producto}\\n`;\n  mensaje += `   📊 Cantidad: ${cantidad} ${unidad}\\n`;\n  mensaje += `   ${estadoEmoji}\\n`;\n  mensaje += `   📅 Inicio: ${fechaInicio}\\n`;\n  mensaje += `   🏁 Fin: ${fechaFin}\\n`;\n});\n\nif (resultadoFabricaciones.length > 10) {\n  mensaje += `\\n... y ${resultadoFabricaciones.length - 10} más.\\n`;\n}\n\nmensaje += `\\n💡 **Filtros disponibles:**\\n• \"fabricaciones pendientes\"\\n• \"fabricaciones en progreso\"\\n• \"fabricaciones terminadas\"\\n• \"fabricaciones de hoy/ayer/esta semana/este mes\"`;\n\nconsole.log('✅ Mensaje formateado para Telegram:', mensaje);\n\nreturn {\n  chat_id: datosBusqueda.chat_id,\n  mensaje_telegram: mensaje,\n  total_fabricaciones: resultadoFabricaciones.length,\n  fabricaciones: resultadoFabricaciones\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1888,
        15136
      ],
      "id": "ea6c5402-9b1c-43d8-b81b-0eb8f07ac9a7",
      "name": "Procesar Fabricaciones"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.mensaje_telegram }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1488,
        15136
      ],
      "id": "a0d8909e-f1b4-47fb-bd0d-5c16d1c41704",
      "name": "Telegram Fabricaciones",
      "webhookId": "fabricaciones-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// CREAR PEDIDO DE COMPRA - SIMILAR A CREAR PEDIDO DE VENTA\nconst datosUsuario = $json;\nconst chatId = datosUsuario.chat_id;\nconst uid = datosUsuario.uid;\n\nconsole.log('🛒 === CREAR PEDIDO DE COMPRA ===');\nconsole.log('💬 Chat ID:', chatId);\nconsole.log('🔑 UID:', uid);\nconsole.log('📋 Datos recibidos:', JSON.stringify(datosUsuario, null, 2));\n\n// EXTRAER INFORMACIÓN DEL PEDIDO\nconst proveedor = datosUsuario.proveedor || 'Proveedor no especificado';\nconst productos = datosUsuario.productos || [];\n\nconsole.log('🏢 Proveedor:', proveedor);\nconsole.log('📦 Productos:', productos);\n\n// VALIDAR DATOS MÍNIMOS\nif (!proveedor || proveedor === 'Proveedor no especificado') {\n  return {\n    error: true,\n    mensaje_error: 'No se especificó el proveedor para el pedido de compra. Por favor, indica el nombre del proveedor.',\n    chat_id: chatId\n  };\n}\n\nif (!productos || productos.length === 0) {\n  return {\n    error: true,\n    mensaje_error: 'No se especificaron productos para el pedido de compra. Por favor, indica qué productos y cantidades quieres comprar.',\n    chat_id: chatId\n  };\n}\n\n// BUSCAR PROVEEDOR\nconst consultaBuscarProveedor = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.partner\",\n      \"search_read\",\n      [[\"name\", \"ilike\", proveedor], [\"supplier_rank\", \">\", 0]],\n      {\n        fields: [\"id\", \"name\", \"email\", \"phone\"],\n        limit: 5\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  chat_id: chatId,\n  uid: uid,\n  proveedor_buscado: proveedor,\n  productos_pedido: productos,\n  consulta_buscar_proveedor: consultaBuscarProveedor\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2768,
        15648
      ],
      "id": "edefca07-e4c0-4801-b693-9c4d4e924e28",
      "name": "Preparar Pedido Compra"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.consulta_buscar_proveedor }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2560,
        15648
      ],
      "id": "c7da38e1-de94-4ec5-a14e-8f1023136674",
      "name": "HTTP Buscar Proveedor Compra"
    },
    {
      "parameters": {
        "jsCode": "// Validar proveedor y preparar búsqueda de productos para compra (purchase_ok)\nconst respProveedor = $json.result || [];\nconst datosPrep = $('Preparar Pedido Compra').item.json;\n\nconst chatId = datosPrep.chat_id;\nconst uid = datosPrep.uid;\nconst productosSolicitados = datosPrep.productos_pedido || [];\nconst proveedorNombre = datosPrep.proveedor_buscado;\n\n// Si faltan productos, pedimos al usuario\nif (!Array.isArray(productosSolicitados) || productosSolicitados.length === 0) {\n  return {\n    error: true,\n    mensaje_error: 'No se especificaron productos para el pedido de compra. Indica productos y cantidades.',\n    chat_id: chatId\n  };\n}\n\n// Validar proveedor\nif (!Array.isArray(respProveedor) || respProveedor.length === 0) {\n  return {\n    error: true,\n    mensaje_error: `No encontré proveedor que coincida con \"${proveedorNombre}\". Dime el nombre exacto del proveedor.`,\n    chat_id: chatId\n  };\n}\n\n// Si hay múltiples, tomamos el mejor por nombre exacto si existe, si no el primero\nlet proveedorElegido = respProveedor[0];\nfor (const p of respProveedor) {\n  if ((p.name || '').toLowerCase() === (proveedorNombre || '').toLowerCase()) {\n    proveedorElegido = p;\n    break;\n  }\n}\n\n// Construir dominio para productos (purchase_ok)\nconst condicionesProductos = [];\nfor (const prod of productosSolicitados) {\n  if (prod && prod.nombre) condicionesProductos.push(['name','ilike', prod.nombre]);\n}\n\nlet dominio;\nif (condicionesProductos.length === 1) {\n  dominio = [condicionesProductos[0], ['purchase_ok', '=', true]];\n} else if (condicionesProductos.length === 2) {\n  dominio = ['|', condicionesProductos[0], condicionesProductos[1], ['purchase_ok', '=', true]];\n} else {\n  let dominioOr = ['|', condicionesProductos[0], condicionesProductos[1]];\n  for (let i = 2; i < condicionesProductos.length; i++) {\n    dominioOr = ['|', dominioOr, condicionesProductos[i]];\n  }\n  dominio = [dominioOr, ['purchase_ok', '=', true]];\n}\n\nconst payloadProductos = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'product.product',\n      'search_read',\n      [dominio],\n      { fields: ['id','name','uom_id','standard_price'], limit: 50 }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn {\n  chat_id: chatId,\n  uid,\n  proveedor: proveedorElegido,\n  productos_solicitados: productosSolicitados,\n  payload_productos_compra: payloadProductos\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2256,
        15648
      ],
      "id": "c84ee725-ae53-4856-aa5d-36eaf11a575b",
      "name": "Procesar Proveedor y Preparar Productos Compra"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload_productos_compra }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1600,
        15632
      ],
      "id": "77be227c-36e3-468b-b70b-d989bf7ef0fa",
      "name": "HTTP Buscar Productos Compra"
    },
    {
      "parameters": {
        "jsCode": "// Crear pedido de compra en borrador\nconst productosEncontrados = $json.result || [];\nconst datos = $('Procesar Proveedor y Preparar Productos Compra').item.json;\nconst uid = datos.uid;\nconst chatId = datos.chat_id;\nconst proveedor = datos.proveedor;\nconst solicitados = datos.productos_solicitados || [];\n\n// Mapear líneas\nconst lineas = [];\nconst noEncontrados = [];\nfor (const req of solicitados) {\n  const p = productosEncontrados.find(x => (x.name||'').toLowerCase().includes((req.nombre||'').toLowerCase()) || (req.nombre||'').toLowerCase().includes((x.name||'').toLowerCase()));\n  if (p) {\n    lineas.push({\n      product_id: p.id,\n      product_qty: req.cantidad || 1,\n      price_unit: typeof p.standard_price === 'number' ? p.standard_price : 0,\n      name: p.name\n    });\n  } else {\n    noEncontrados.push(req.nombre);\n  }\n}\n\nif (lineas.length === 0) {\n  return {\n    error: true,\n    mensaje_error: 'No encontré productos válidos para compra en Odoo. Revisa los nombres.',\n    chat_id: chatId\n  };\n}\n\nconst datosPedido = {\n  partner_id: proveedor.id,\n  state: 'draft',\n  order_line: lineas.map(l => [0,0,l])\n};\n\nconst payloadCreate = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'purchase.order',\n      'create',\n      [datosPedido]\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn {\n  chat_id: chatId,\n  uid,\n  proveedor,\n  lineas_pedido: lineas,\n  productos_no_encontrados: noEncontrados,\n  payload_crear_pedido_compra: payloadCreate\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1392,
        15632
      ],
      "id": "2a87740a-12fd-484d-bf81-0e73cca808a5",
      "name": "Crear Pedido Compra"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload_crear_pedido_compra }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1184,
        15632
      ],
      "id": "1e24accf-9b36-4db7-8cca-fb386c53b60f",
      "name": "HTTP Crear Pedido Compra"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta creación compra\nconst pedidoId = $json.result;\nconst datos = $('Crear Pedido Compra').item.json;\nconst proveedor = datos.proveedor;\nconst lineas = datos.lineas_pedido || [];\nconst noEncontrados = datos.productos_no_encontrados || [];\n\nlet texto = '';\nif (!pedidoId) {\n  texto = '❌ Error al crear el pedido de compra. Inténtalo de nuevo.';\n} else {\n  const header = '✅ Pedido de compra creado (ID: ' + pedidoId + ')\\n\\n';\n  const prov = '🏢 Proveedor: ' + (proveedor && proveedor.name ? proveedor.name : '-') + '\\n';\n  const productos = '📦 Productos: \\n' + lineas.map(function(l){\n    const qty = (typeof l.product_qty === 'number' ? l.product_qty : 1);\n    const price = (typeof l.price_unit === 'number' ? l.price_unit : Number(l.price_unit) || 0);\n    return '• ' + (l.name || '-') + ' — Cant: ' + qty + ' — Precio: €' + price.toFixed(2);\n  }).join('\\n');\n  texto = header + prov + productos;\n  if (noEncontrados.length > 0) {\n    texto += '\\n\\n⚠️ No encontrados: ' + noEncontrados.join(', ');\n  }\n  texto += '\\n\\n📝 El pedido está en borrador en Odoo.';\n}\n\nreturn { chat_id: datos.chat_id, texto: texto, pedido_compra_id: pedidoId };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        15632
      ],
      "id": "dfbb169d-0766-434e-9364-ec50336d0a1d",
      "name": "Formatear Respuesta Pedido Compra"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -768,
        15632
      ],
      "id": "8b43032d-3919-42db-868d-bfc1f870584d",
      "name": "Enviar Respuesta Pedido Compra",
      "webhookId": "compra-ok-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "const esFallback = $json.es_fallback === true;\nconst userId = Number($json.user_id || 0);\n\n// Si es fallback, no descontar\nreturn {\n  ...$json,\n  descuento_necesario: !esFallback,\n  user_id_descuento: userId\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7776,
        4368
      ],
      "id": "6a943404-6c37-4cc8-b886-6a5ffa6a106b",
      "name": "Marcar Descuento Final"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "36c84a69-10d6-4d07-9c9c-fd7b8b89bbc2",
              "leftValue": "={{ ($json.descuento_necesario ?? false) === true && $json.es_fallback !== true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7952,
        4368
      ],
      "id": "2992bcf0-a8d4-4e62-a9e2-b5295a8a2983",
      "name": "¿Descontar Ahora?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": " UPDATE telegram_users\n        SET consultas_restantes = GREATEST(consultas_restantes - 1, 0),\n            last_seen = NOW()\n        WHERE user_id = $1\n  AND COALESCE(is_admin, false) = false\n  AND COALESCE(usuario_valido, false) = true;",
        "options": {
          "queryReplacement": "={{ [ Number($json.user_id_descuento || $json.user_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        8128,
        4256
      ],
      "id": "33e1aa50-f866-4823-b10a-b5c4f8c9ed2e",
      "name": "Descontar Consulta Final"
    },
    {
      "parameters": {
        "jsCode": "// Preparar payload JSON-RPC para crear calendar.event en Odoo (con TZ Europe/Madrid → UTC)\nconst resp = $json; // respuesta de HTTP Buscar Participantes: { jsonrpc, id, result: [...] }\nconst encontrados = Array.isArray(resp.result) ? resp.result : [];\n\n// Datos previos desde el nodo \"Buscar Participantes Evento\"\nconst prev = $('Buscar Participantes Evento').item.json;\n\n// IDs de partners\nconst partnerIds = encontrados.map((p) => p.id);\n\n// Calcular no encontrados (opcional, para mensaje)\nconst solicitados = Array.isArray(prev.participantes_solicitados) ? prev.participantes_solicitados : [];\nconst solicitadosNorm = solicitados.map((s) => s.toString().trim().toLowerCase());\nconst encontradosNorm = encontrados.map((p) => (p.name || '').toString().trim().toLowerCase());\nconst noEncontrados = solicitadosNorm.filter((s) => !encontradosNorm.includes(s));\n\n// Conversión Europe/Madrid → UTC respetando DST\nfunction tzOffsetFor(dateUtcMs, timeZone) {\n  const f = new Intl.DateTimeFormat('en-US', {\n    timeZone, hour12: false,\n    year: 'numeric', month: '2-digit', day: '2-digit',\n    hour: '2-digit', minute: '2-digit', second: '2-digit',\n  });\n  const parts = Object.fromEntries(f.formatToParts(new Date(dateUtcMs)).map(p => [p.type, p.value]));\n  const asUTCms = Date.UTC(parts.year, Number(parts.month) - 1, parts.day, parts.hour, parts.minute, parts.second);\n  return asUTCms - dateUtcMs;\n}\n\nfunction localTzToUtcString(fechaYmd, horaHm, timeZone) {\n  const [Y, M, D] = fechaYmd.split('-').map(Number);\n  const [h, m] = horaHm.split(':').map(Number);\n  const localAsUTCms = Date.UTC(Y, M - 1, D, h, m, 0);\n  const offset = tzOffsetFor(localAsUTCms, timeZone);\n  const utcMs = localAsUTCms - offset;\n  return new Date(utcMs).toISOString().slice(0, 19).replace('T', ' ');\n}\n\nconst TZ = 'Europe/Madrid';\nconst fecha = prev.fecha;              // \"YYYY-MM-DD\"\nconst horaInicio = prev.hora_inicio;   // \"HH:MM\"\nconst horaFin = prev.hora_fin;         // \"HH:MM\"\n\n// Si faltara hora_fin, usa misma hora de inicio (evento 0 min)\nconst start = localTzToUtcString(fecha, horaInicio, TZ);\nconst stop  = localTzToUtcString(fecha, horaFin || horaInicio, TZ);\n\n// Valores del evento\nconst vals = {\n  name: prev.titulo || 'Evento',\n  start,\n  stop,\n  description: prev.descripcion || '',\n  partner_ids: [[6, 0, partnerIds]],\n};\n\nconst jsonRpcPayload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      prev.uid,\n      'admin',\n      'calendar.event',\n      'create',\n      [vals],\n    ],\n  },\n  id: Math.floor(Math.random() * 1000000),\n};\n\nconsole.log('🧩 Crear evento - vals:', JSON.stringify(vals, null, 2));\nconsole.log('🚀 Payload crear evento:', JSON.stringify(jsonRpcPayload, null, 2));\n\nreturn {\n  payload: jsonRpcPayload,\n  chat_id: prev.chat_id,\n  participantes_encontrados: encontrados.map((p) => p.name),\n  participantes_no_encontrados: noEncontrados,\n  titulo: prev.titulo,\n  fecha: prev.fecha,\n  hora_inicio: prev.hora_inicio,\n  hora_fin: prev.hora_fin,\n  descripcion: prev.descripcion,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -896,
        11520
      ],
      "id": "8b2f6e8a-b7de-42cf-b0c9-29e09c937c15",
      "name": "Preparar Datos"
    },
    {
      "parameters": {
        "jsCode": "// CONTACTO ENCONTRADO PERO FALTA NUEVO VALOR - Guardar en memoria\nconst datos = $('Preparar Modificar Contacto').first().json;\nconst contactoData = $('Buscar Contacto').first().json.result[0];\nconst chatId = datos.chat_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconsole.log('✅ CONTACTO ENCONTRADO, ❌ FALTA NUEVO VALOR');\nconsole.log('📋 Contacto:', contactoData.name, 'ID:', contactoData.id);\nconsole.log('🔧 Campo a modificar:', datos.campo);\n\n// Guardar datos para modificar contacto\nmemoria.esperando_confirmacion = 'nuevo_valor_contacto';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  contacto: datos.contacto,\n  contacto_id: contactoData.id,\n  contacto_data: contactoData,\n  campo: datos.campo,\n  accion_original: 'modificar_contacto',\n  tipo_modificacion: 'actualizar_campo',\n  uid: datos.uid\n};\n\n// Actualizar historial\nconst entradaHistorial = {\n  timestamp: new Date().toISOString(),\n  usuario: `Modificar ${datos.campo} del contacto ${datos.contacto}`,\n  bot: `Contacto encontrado. Esperando nuevo valor para ${datos.campo}`,\n  accion: 'esperando_nuevo_valor_contacto',\n  chat_id: chatId\n};\n\nif (!memoria.historial) memoria.historial = [];\nmemoria.historial.push(entradaHistorial);\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  chat_id: chatId,\n  contacto: datos.contacto,\n  contacto_id: contactoData.id,\n  campo: datos.campo,\n  contacto_nombre_completo: contactoData.name,\n  tipo_respuesta: 'esperando_nuevo_valor',\n  memoria_actualizada: memoria\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        3712
      ],
      "id": "4b231401-1bb2-4b3c-93d9-0aa689b724b0",
      "name": "Guardar Memoria Modificar Contacto"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Usuario',\n  'nuevo_valor_contacto',\n  `¿Qué nuevo valor quieres poner en el campo ${$json.campo} del contacto ${$json.contacto_nombre_completo}?`,\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),\n  `Modificar ${$json.campo} del contacto: ${$json.contacto}`,\n  JSON.stringify($json.memoria_actualizada?.historial || []),\n  JSON.stringify([{\n    tipo: 'usuario',\n    contenido: `Modificar ${$json.campo} del contacto ${$json.contacto}`,\n    timestamp: new Date().toISOString()\n  },\n  {\n    tipo: 'bot',\n    contenido: `Contacto \"${$json.contacto_nombre_completo}\" encontrado. Esperando nuevo valor para ${$json.campo}.`,\n    timestamp: new Date().toISOString()\n  }])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -704,
        3712
      ],
      "id": "4c85f85c-5bd3-46cd-bdfb-8b3e4b53505d",
      "name": "Guardar Memoria PostgreSQL Modificar Contacto"
    },
    {
      "parameters": {
        "jsCode": "// Pide el nuevo valor al usuario\nconst datos = $node[\"Preparar Modificar Contacto\"].json;\nreturn {\n  chat_id: datos.chat_id,\n  texto: `¿Qué *nuevo valor* quieres poner en el campo *${datos.campo}* del contacto *${datos.contacto}*?`\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        3712
      ],
      "id": "db62efce-3356-47ec-8928-3ea62a60eade",
      "name": "Pedir Nuevo Valor"
    },
    {
      "parameters": {
        "jsCode": "// ✅ Validador de parámetros para CONSULTAR AUSENCIAS\n// - Permite usuario = null para listados globales por periodo o rango de fechas\n// - Soporta: hoy, ayer, esta_semana, semana_pasada, este_mes, mes_pasado, general, rango_fechas, fecha_especifica\n\nconst datosAI = $json || {};\nconst chatId  = datosAI.chat_id;\n\n// Normalización de usuario (acepta string, número, objeto con .name)\nconst usuarioNorm = (() => {\n  const u = datosAI.usuario;\n  if (typeof u === 'string') return u.trim();\n  if (typeof u === 'number') return String(u).trim();\n  if (u && typeof u === 'object' && u.name) return String(u.name).trim();\n  return '';\n})();\n\nlet periodo = (datosAI.periodo && datosAI.periodo !== 'no_especificado') ? String(datosAI.periodo).trim() : '';\n\n// Soporte de fechas\nconst fechaEspecifica = datosAI.fecha_especifica ? String(datosAI.fecha_especifica).trim() : '';\nconst fechaInicio     = datosAI.fecha_inicio     ? String(datosAI.fecha_inicio).trim()     : '';\nconst fechaFin        = datosAI.fecha_fin        ? String(datosAI.fecha_fin).trim()        : '';\n\nconst mensajeIA = datosAI.mensaje || datosAI.response || datosAI.text || '';\n\nconst log = (...a) => console.log('[AUSENCIAS]', ...a);\nlog('🔍 === VERIFICACIÓN DATOS AUSENCIAS ===');\nlog('👤 Usuario específico:', usuarioNorm || '(TODOS)');\nlog('📅 Periodo recibido:', periodo || '(no especificado)');\nlog('📅 Fecha específica:', fechaEspecifica || '(no especificada)');\nlog('📅 Rango:', (fechaInicio && fechaFin) ? `${fechaInicio} → ${fechaFin}` : '(sin rango)');\nlog('💬 Mensaje IA:', mensajeIA || '(sin mensaje)');\n\n// Helpers\nconst isYYYYMMDD = (s) => /^\\d{4}-\\d{2}-\\d{2}$/.test(String(s || ''));\nconst cmpDates = (a, b) => new Date(a).getTime() - new Date(b).getTime();\n\nconst PERIODOS_VALIDOS = new Set([\n  'hoy', 'ayer',\n  'esta_semana', 'semana_pasada',\n  'este_mes', 'mes_pasado',\n  'general',\n  'rango_fechas',\n  'fecha_especifica'\n]);\n\n// Autocompletar periodo si no viene:\n// - Si trae fecha_especifica => periodo = 'fecha_especifica'\n// - Si trae fecha_inicio y fecha_fin => periodo = 'rango_fechas'\nif (!periodo) {\n  if (fechaEspecifica) periodo = 'fecha_especifica';\n  else if (fechaInicio && fechaFin) periodo = 'rango_fechas';\n  else periodo = 'general'; // por defecto listado general\n}\n\n// Validaciones\nlet datosCompletos = false;\nlet razonIncompleta = null;\n\n// Validación de periodo\nif (!PERIODOS_VALIDOS.has(periodo)) {\n  razonIncompleta = 'periodo_no_valido';\n} else {\n  // Validación de fechas según tipo de periodo\n  let fechasOK = true;\n\n  if (periodo === 'fecha_especifica') {\n    fechasOK = isYYYYMMDD(fechaEspecifica);\n    if (!fechasOK) razonIncompleta = 'fecha_especifica_invalida';\n  }\n\n  if (periodo === 'rango_fechas') {\n    fechasOK = isYYYYMMDD(fechaInicio) && isYYYYMMDD(fechaFin);\n    if (!fechasOK) {\n      razonIncompleta = 'fechas_incompletas';\n    } else if (cmpDates(fechaFin, fechaInicio) < 0) {\n      fechasOK = false;\n      razonIncompleta = 'rango_invertido';\n    }\n  }\n\n  // 🔑 Usuario es OPCIONAL para listados generales por periodo/fecha\n  // Si quieres hacerlo obligatorio en algún periodo, cambia aquí.\n  const usuarioOK = true;\n\n  datosCompletos = fechasOK && usuarioOK;\n}\n\n// Logs\nlog('✅ Datos completos:', datosCompletos);\nlog('❌ Razón incompleta:', razonIncompleta || '(ninguna)');\n\n// Salida normalizada\nreturn {\n  datos_completos: datosCompletos,\n  razon_incompleta: razonIncompleta,\n  periodo,                          // 'general' | 'hoy' | ... | 'rango_fechas' | 'fecha_especifica'\n  fecha_especifica: fechaEspecifica || null,\n  fecha_inicio: fechaInicio || null,\n  fecha_fin: fechaFin || null,\n  // usuario puede ser null => TODOS\n  usuario: usuarioNorm || null,\n  chat_id: chatId,\n  mensaje_ia: mensajeIA,\n  datos_originales: datosAI\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2000,
        8672
      ],
      "id": "4bf76fa0-8d62-42a4-b026-5e5589cb5284",
      "name": "Verificar Datos Ausencias Completos"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.datos_completos === true }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1680,
        8656
      ],
      "id": "0d119e72-472d-4396-a487-c8ad3d461019",
      "name": "¿Datos Ausencias Completos?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Ausencias Incompletas').item.json.chat_id }}",
        "text": "={{ $('Guardar Memoria Ausencias Incompletas').item.json.mensaje_ia }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1120,
        8896
      ],
      "id": "b840a357-066e-40b5-974a-766fcafef001",
      "name": "Telegram Solicitar Datos Ausencias",
      "webhookId": "solicitar-datos-ausencias-001"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Usuario',\n  'completar_datos_ausencias',\n  $json.mensaje_ia,\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),\n  `Consultar ausencias - datos incompletos: ${$json.razon_incompleta}`,\n  JSON.stringify($json.memoria_actualizada?.historial || []),\n  JSON.stringify([{\n    tipo: 'usuario',\n    contenido: `Consultar ausencias - período: ${$json.periodo_parcial || 'no especificado'}`,\n    timestamp: new Date().toISOString()\n  },\n  {\n    tipo: 'bot',\n    contenido: `Faltan datos para consultar ausencias. Solicitando información adicional.`,\n    timestamp: new Date().toISOString()\n  }])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1360,
        8896
      ],
      "id": "2aba85bc-de1c-4546-900b-3b1600b777ae",
      "name": "Guardar Memoria PostgreSQL Ausencias"
    },
    {
      "parameters": {
        "jsCode": "// DATOS INCOMPLETOS PARA AUSENCIAS - Guardar en memoria\nconst datosVerificacion = $('Verificar Datos Ausencias Completos').first().json;\nconst chatId = datosVerificacion.chat_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconsole.log('❌ DATOS INCOMPLETOS PARA CONSULTA DE AUSENCIAS');\nconsole.log('📅 Período:', datosVerificacion.periodo);\nconsole.log('❌ Razón:', datosVerificacion.razon_incompleta);\n\n// Guardar datos para completar consulta de ausencias\nmemoria.esperando_confirmacion = 'completar_datos_ausencias';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  accion_original: 'consultar_ausencias',\n  periodo_parcial: datosVerificacion.periodo,\n  fecha_especifica: datosVerificacion.fecha_especifica,\n  razon_incompleta: datosVerificacion.razon_incompleta,\n  mensaje_ia_original: datosVerificacion.mensaje_ia,\n  datos_originales: datosVerificacion.datos_originales,\n  uid: null // Se obtendrá cuando se complete\n};\n\n// Actualizar historial\nconst entradaHistorial = {\n  timestamp: new Date().toISOString(),\n  usuario: `Consultar ausencias - datos incompletos`,\n  bot: `Faltan datos para consulta de ausencias: ${datosVerificacion.razon_incompleta}`,\n  accion: 'ausencias_datos_incompletos',\n  chat_id: chatId\n};\n\nif (!memoria.historial) memoria.historial = [];\nmemoria.historial.push(entradaHistorial);\n\nglobal[contextoKey] = memoria;\n\n// Determinar mensaje apropiado\nlet mensajeParaUsuario = datosVerificacion.mensaje_ia;\n\nif (!mensajeParaUsuario || mensajeParaUsuario.trim() === '') {\n  // Mensaje por defecto si la IA no proporcionó uno\n  switch (datosVerificacion.razon_incompleta) {\n    case 'falta_periodo':\n      mensajeParaUsuario = '📅 **Para consultar las ausencias necesito que especifiques el período.**\\n\\n¿Qué período quieres consultar?\\n\\n• **\"hoy\"** - ausencias de hoy\\n• **\"esta semana\"** - ausencias de esta semana\\n• **\"este mes\"** - ausencias de este mes\\n• **Una fecha específica** (ej: \"2024-10-15\")\\n• **Un rango** (ej: \"del 1 al 15 de octubre\")';\n      break;\n    case 'periodo_no_valido':\n      mensajeParaUsuario = '❌ **El período especificado no es válido.**\\n\\nPor favor, especifica:\\n• **\"hoy\"**, **\"esta semana\"**, **\"este mes\"**\\n• **Una fecha específica** (ej: \"15 de octubre\")\\n• **Un rango de fechas** (ej: \"del 1 al 15 de octubre\")';\n      break;\n    default:\n      mensajeParaUsuario = '📅 **Necesito más información para consultar las ausencias.**\\n\\n¿Qué período quieres consultar?';\n  }\n}\n\nreturn {\n  chat_id: chatId,\n  mensaje_ia: mensajeParaUsuario,\n  razon_incompleta: datosVerificacion.razon_incompleta,\n  periodo_parcial: datosVerificacion.periodo,\n  tipo_respuesta: 'ausencias_datos_incompletos',\n  memoria_actualizada: memoria\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1600,
        8896
      ],
      "id": "322e1e59-8503-481c-994b-c39a905d16d8",
      "name": "Guardar Memoria Ausencias Incompletas"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Consulta Ausencias1 — versión estable\n// - Lee datos_originales.mensaje_original\n// - Entiende meses (septiembre/setiembre/septiebre/sep/…),\n//   fechas únicas y rangos (incl. entre meses)\n// - Dominio Odoo bien formado (sin listas sueltas):\n//     (state in Aprobados) AND ( (date_* solapa) OR (request_date_* solapa) ) [AND filtro empleado]\n\nconst datos = $('Verificar Datos Ausencias Completos').first().json;\nconst uid = $('Autenticar Odoo').item.json.result;\nif (!uid) throw new Error('No se pudo obtener el UID de autenticación');\n\nconst usuario = (datos.usuario || '').trim();\nconst periodoEntrada = (datos.periodo || 'no_especificado').toString().toLowerCase();\nconst fechaEspecificaEntrada = datos.fecha_especifica || null;\n\n// Mensaje original\nconst rawMsg = (\n  datos.mensaje_ia ||\n  datos.datos_originales?.mensaje_original ||\n  datos.datos_originales?.mensaje ||\n  datos.datos_originales?.text ||\n  ''\n).toString();\n\nconst msg = rawMsg\n  .toLowerCase()\n  .normalize('NFD')\n  .replace(/[\\u0300-\\u036f]/g, ' ')\n  .replace(/\\s+/g, ' ')\n  .trim();\n\nconst hoy = new Date();\nconst curY = hoy.getFullYear();\nconst pad = (n) => String(n).padStart(2, '0');\nconst toISO = (y,m,d) => `${y}-${pad(m)}-${pad(d)}`;\nconst lastDay = (y,m) => new Date(y, m, 0).getDate();\nconst normYear = (y) => (y < 100 ? 2000 + y : y);\n\nconst meses = {\n  'enero':1,'ene':1,\n  'febrero':2,'feb':2,\n  'marzo':3,'mar':3,\n  'abril':4,'abr':4,\n  'mayo':5,'may':5,\n  'junio':6,'jun':6,\n  'julio':7,'jul':7,\n  'agosto':8,'ago':8,\n  'septiembre':9,'setiembre':9,'septiebre':9,'sept':9,'sep':9,\n  'octubre':10,'oct':10,\n  'noviembre':11,'nov':11,\n  'diciembre':12,'dic':12,\n};\n\nlet fechaInicio = null;\nlet fechaFin = null;\n\n// --- Rangos ---\nlet r = msg.match(/\\bdel\\s+(\\d{1,2})\\s+al\\s+(\\d{1,2})\\s+de\\s+(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|setiembre|septiebre|sept|sep|octubre|noviembre|diciembre|ene|feb|mar|abr|may|jun|jul|ago|oct|nov|dic)(?:\\s+de\\s+(\\d{2,4}))?\\b/);\nif (r) {\n  const d1 = +r[1], d2 = +r[2], mNum = meses[r[3]], y = r[4] ? normYear(+r[4]) : curY;\n  fechaInicio = toISO(y, mNum, Math.min(d1,d2));\n  fechaFin    = toISO(y, mNum, Math.max(d1,d2));\n}\n\nif (!fechaInicio) {\n  r = msg.match(/\\bdel\\s+(\\d{1,2})[\\/\\-](\\d{1,2})(?:[\\/\\-](\\d{2,4}))?\\s+al\\s+(\\d{1,2})[\\/\\-](\\d{1,2})(?:[\\/\\-](\\d{2,4}))?\\b/);\n  if (r) {\n    const d1 = +r[1], m1 = +r[2], y1 = r[3] ? normYear(+r[3]) : curY;\n    const d2 = +r[4], m2 = +r[5], y2 = r[6] ? normYear(+r[6]) : (r[3] ? y1 : curY);\n    const f1 = new Date(y1, m1-1, d1), f2 = new Date(y2, m2-1, d2);\n    const a = f1 <= f2 ? f1 : f2, b = f1 <= f2 ? f2 : f1;\n    fechaInicio = toISO(a.getFullYear(), a.getMonth()+1, a.getDate());\n    fechaFin    = toISO(b.getFullYear(), b.getMonth()+1, b.getDate());\n  }\n}\n\nif (!fechaInicio) {\n  r = msg.match(/\\bdel\\s+(\\d{1,2})\\s+de\\s+(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|setiembre|septiebre|sept|sep|octubre|noviembre|diciembre|ene|feb|mar|abr|may|jun|jul|ago|oct|nov|dic)(?:\\s+de\\s+(\\d{2,4}))?\\s+al\\s+(\\d{1,2})\\s+de\\s+(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|setiembre|septiebre|sept|sep|octubre|noviembre|diciembre|ene|feb|mar|abr|may|jun|jul|ago|oct|nov|dic)(?:\\s+de\\s+(\\d{2,4}))?\\b/);\n  if (r) {\n    const d1 = +r[1], m1 = meses[r[2]], y1 = r[3] ? normYear(+r[3]) : null;\n    const d2 = +r[4], m2 = meses[r[5]], y2 = r[6] ? normYear(+r[6]) : null;\n    const Y1 = y1 ?? y2 ?? curY;\n    const Y2 = y2 ?? y1 ?? curY;\n    const f1 = new Date(Y1, m1-1, d1), f2 = new Date(Y2, m2-1, d2);\n    const a = f1 <= f2 ? f1 : f2, b = f1 <= f2 ? f2 : f1;\n    fechaInicio = toISO(a.getFullYear(), a.getMonth()+1, a.getDate());\n    fechaFin    = toISO(b.getFullYear(), b.getMonth()+1, b.getDate());\n  }\n}\n\n// --- Fechas únicas ---\nif (!fechaInicio) {\n  r = msg.match(/\\b(\\d{1,2})[\\/\\-](\\d{1,2})(?:[\\/\\-](\\d{2,4}))?\\b/);\n  if (r) {\n    const d = +r[1], m = +r[2], y = r[3] ? normYear(+r[3]) : curY;\n    fechaInicio = fechaFin = toISO(y,m,d);\n  }\n}\nif (!fechaInicio) {\n  r = msg.match(/\\b(\\d{1,2})\\s+de\\s+(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|setiembre|septiebre|sept|sep|octubre|noviembre|diciembre|ene|feb|mar|abr|may|jun|jul|ago|oct|nov|dic)(?:\\s+de\\s+(\\d{2,4}))?\\b/);\n  if (r) {\n    const d = +r[1], mNum = meses[r[2]], y = r[3] ? normYear(+r[3]) : curY;\n    fechaInicio = fechaFin = toISO(y,mNum,d);\n  }\n}\n\n// --- Solo mes (desde mensaje o desde periodo) ---\nif (!fechaInicio) {\n  r = msg.match(/\\b(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|setiembre|septiebre|sept|sep|octubre|noviembre|diciembre|ene|feb|mar|abr|may|jun|jul|ago|oct|nov|dic)(?:\\s+de\\s+(\\d{2,4}))?\\b/);\n  if (r) {\n    const mNum = meses[r[1]], y = r[2] ? normYear(+r[2]) : curY;\n    const ld = lastDay(y, mNum);\n    fechaInicio = toISO(y, mNum, 1);\n    fechaFin    = toISO(y, mNum, ld);\n  }\n}\nif (!fechaInicio && meses[periodoEntrada]) {\n  const mNum = meses[periodoEntrada], y = curY, ld = lastDay(y, mNum);\n  fechaInicio = toISO(y, mNum, 1);\n  fechaFin    = toISO(y, mNum, ld);\n}\n\n// --- Fallbacks ---\nif (!fechaInicio && fechaEspecificaEntrada) {\n  fechaInicio = fechaEspecificaEntrada;\n  fechaFin = fechaEspecificaEntrada;\n}\nif (!fechaInicio) {\n  const first = new Date(hoy.getFullYear(), hoy.getMonth(), 1);\n  const last  = new Date(hoy.getFullYear(), hoy.getMonth()+1, 0);\n  fechaInicio = toISO(first.getFullYear(), first.getMonth()+1, first.getDate());\n  fechaFin    = toISO(last.getFullYear(),  last.getMonth()+1,  last.getDate());\n}\n\nconst inicioDT = `${fechaInicio} 00:00:00`;\nconst finDT    = `${fechaFin} 23:59:59`;\n\nconsole.log('💬 Mensaje (raw):', rawMsg);\nconsole.log('📦 Periodo entrada:', periodoEntrada);\nconsole.log('👤 Empleado filtro:', usuario || '(todos)');\nconsole.log('📅 Fecha inicio:', fechaInicio);\nconsole.log('📅 Fecha fin:', fechaFin);\n\n// Construir dominio base de fechas y estado\nconst domainFechasYEstado = [\n  \"&\",\n  [\"state\", \"in\", [\"confirm\", \"validate1\", \"validate\"]],\n  \"|\",\n  \"&\", [\"date_from\", \"<=\", finDT], [\"date_to\", \">=\", inicioDT],\n  \"&\", [\"request_date_from\", \"<=\", fechaFin], [\"request_date_to\", \">=\", fechaInicio],\n];\n\n// Construir dominio final con o sin filtro de empleado\nlet domain;\nif (usuario && usuario.trim().length >= 2 && usuario.toLowerCase() !== 'todos') {\n  // Si hay filtro de empleado, agregamos un AND que une el dominio base con el filtro de empleado\n  domain = [\n    \"&\",\n    ...domainFechasYEstado,\n    \"|\",\n    [\"employee_id.name\", \"ilike\", usuario],\n    [\"employee_id.work_email\", \"ilike\", usuario]\n  ];\n} else {\n  // Sin filtro de empleado, usamos solo el dominio base\n  domain = domainFechasYEstado;\n}\n\nconsole.log(\"✅ Dominio final Odoo:\", JSON.stringify(domain, null, 2));\n\n// -------------------- JSON-RPC limpio --------------------\nconst payload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"hr.leave\",\n      \"search_read\",\n      [domain], // OJO: aquí solo va [domain], no [[domain]]\n      {\n        fields: [\n          \"employee_id\", \"date_from\", \"date_to\", \"name\",\n          \"holiday_status_id\", \"number_of_days\", \"state\",\n          \"request_date_from\", \"request_date_to\"\n        ],\n        order: \"date_from asc\"\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload,\n  periodo: periodoEntrada,\n  fechaInicio,\n  fechaFin,\n  chat_id: datos.chat_id,\n  uid,\n  usuario: usuario || null,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        8656
      ],
      "id": "f7754713-180d-47b6-bde0-d06990e1264b",
      "name": "Preparar Consulta Ausencias1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1136,
        8656
      ],
      "id": "bb7d1f9c-b8ce-439e-9380-3c719c099afa",
      "name": "HTTP Consulta Ausencias1"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de ausencias (mejorado)\n// - Muestra rango consultado (o fecha única)\n// - Indica el empleado filtrado si aplica\n// - Agrupa por empleado y lista todas sus ausencias en el periodo\n// - Añade resumen total y por tipo de ausencia\n\nconst ausencias = $json.result || [];\nconst datosConsulta = $('Preparar Consulta Ausencias1').item.json;\n\nconst periodo = datosConsulta.periodo;\nconst fechaInicio = datosConsulta.fechaInicio;\nconst fechaFin = datosConsulta.fechaFin;\nconst empleadoFiltro = (datosConsulta.usuario || '').trim();\n\nconst toES = (isoDateStr) => {\n  // Acepta 'YYYY-MM-DD HH:mm:ss' o ISO\n  const safe = isoDateStr.includes('T') ? isoDateStr : isoDateStr.replace(' ', 'T');\n  const d = new Date(safe);\n  if (Number.isNaN(d.getTime())) return isoDateStr; // fallback\n  return d.toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric' });\n};\n\nconst plural = (n, uno, muchos) => (n === 1 ? uno : muchos);\nconst round1 = (n) => Math.round(n * 10) / 10;\n\nconsole.log('🏖️ Ausencias encontradas:', ausencias.length);\nconsole.log('📋 Lista de ausencias:', ausencias.map(a => `${a.employee_id?.[1]} - ${a.holiday_status_id?.[1]} (${a.date_from} → ${a.date_to})`));\n\nlet titulo = '';\nlet icono = '🏖️';\n\nif (fechaInicio === fechaFin) {\n  titulo = `Ausencias del ${toES(`${fechaInicio} 00:00:00`)}`;\n  icono = '📅';\n} else {\n  titulo = `Ausencias del ${fechaInicio} al ${fechaFin}`;\n  icono = '📋';\n}\n\nlet texto = `${icono} **${titulo}**\\n`;\nif (empleadoFiltro) {\n  texto += `🔎 **Empleado:** ${empleadoFiltro}\\n\\n`;\n} else {\n  texto += `\\n`;\n}\n\nif (ausencias.length === 0) {\n  texto += `✅ **Sin ausencias registradas** en el periodo consultado.\\n`;\n  texto += `Todo el equipo está disponible. 💪\\n`;\n} else {\n  // Agrupar por empleado\n  const ausenciasPorEmpleado = {};\n  for (const a of ausencias) {\n    const empleado = (a.employee_id && a.employee_id[1]) ? a.employee_id[1] : '— sin nombre —';\n    if (!ausenciasPorEmpleado[empleado]) ausenciasPorEmpleado[empleado] = [];\n    ausenciasPorEmpleado[empleado].push(a);\n  }\n\n  const empleados = Object.keys(ausenciasPorEmpleado);\n  texto += `👥 **${empleados.length} ${plural(empleados.length, 'empleado con ausencia', 'empleados con ausencias')}**:\\n\\n`;\n\n  const iconoTipoDe = (tipo) => {\n    const t = (tipo || '').toLowerCase();\n    if (t.includes('vacacion')) return '🏖️';\n    if (t.includes('enferm')) return '🤒';\n    if (t.includes('permiso') || t.includes('ausencia')) return '📋';\n    if (t.includes('matern') || t.includes('patern')) return '👶';\n    return '🏷️';\n    };\n\n  // Cálculo de resumen global y por tipo\n  let totalRegistros = 0;\n  let totalDias = 0;\n  const porTipo = new Map(); // tipo -> {count, days}\n\n  empleados.forEach((empleado, idx) => {\n    const lista = ausenciasPorEmpleado[empleado] || [];\n    texto += `**${idx + 1}. ${empleado}**\\n`;\n    lista.forEach(a => {\n      const tipo = a.holiday_status_id?.[1] || 'Tipo no especificado';\n      const desde = toES(a.date_from);\n      const hasta = toES(a.date_to);\n      const dias = round1(Number(a.number_of_days || 0));\n      const icon = iconoTipoDe(tipo);\n\n      if (desde === hasta) {\n        texto += `   ${icon} ${tipo} — ${desde} (${dias} ${plural(dias, 'día', 'días')})\\n`;\n      } else {\n        texto += `   ${icon} ${tipo} — ${desde} a ${hasta} (${dias} ${plural(dias, 'día', 'días')})\\n`;\n      }\n\n      totalRegistros += 1;\n      totalDias += dias;\n\n      const prev = porTipo.get(tipo) || { count: 0, days: 0 };\n      prev.count += 1;\n      prev.days = round1(prev.days + dias);\n      porTipo.set(tipo, prev);\n    });\n    texto += `\\n`;\n  });\n\n  texto += `📊 **Resumen:** ${totalRegistros} ${plural(totalRegistros, 'ausencia', 'ausencias')} `;\n  texto += `que suman ${round1(totalDias)} ${plural(totalDias, 'día', 'días')}.\\n`;\n\n  if (porTipo.size > 1) {\n    texto += `• Por tipo: `;\n    const partes = [];\n    for (const [tipo, v] of porTipo.entries()) {\n      partes.push(`${tipo} (${v.count}/${round1(v.days)} ${plural(v.days, 'día', 'días')})`);\n    }\n    texto += partes.join(' · ') + '\\n';\n  }\n}\n\ntexto += `\\n\\n📅 **Período consultado:** ${fechaInicio}${fechaInicio !== fechaFin ? ` al ${fechaFin}` : ''}`;\n\nreturn {\n  chat_id: datosConsulta.chat_id,\n  texto\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -832,
        8656
      ],
      "id": "b4de9c60-e0e4-49b3-9122-634939032f98",
      "name": "Formatear Respuesta Ausencias1"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -576,
        8656
      ],
      "id": "de81dbca-9090-4523-a17f-72eae750689a",
      "name": "Enviar Respuesta Ausencias1",
      "webhookId": "webhook-ausencias-001"
    },
    {
      "parameters": {
        "jsCode": "// EVENTO INCOMPLETO - Guardar en memoria (global + payload para Postgres)\nconst prev = $('Preparar Crear Evento Calendario').first().json;\nconst chatId = prev.chat_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nmemoria.esperando_confirmacion = 'crear_evento_calendario';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  accion_original: 'crear_evento_calendario',\n  titulo: prev.titulo || '',\n  fecha: prev.fecha || '',\n  hora_inicio: prev.hora_inicio || '',\n  hora_fin: prev.hora_fin || '',\n  participantes: Array.isArray(prev.participantes) ? prev.participantes : [],\n  descripcion: prev.descripcion || '',\n  datos_faltantes: Array.isArray(prev.datos_pendientes?.datos_faltantes) ? prev.datos_pendientes.datos_faltantes : (prev.datos_pendientes?.datos_faltantes ? [prev.datos_pendientes.datos_faltantes] : []),\n  timestamp: new Date().toISOString()\n};\n\n// Mensaje a enviar (usa el ya generado por tu nodo anterior)\nconst mensaje = prev.ultimo_mensaje_bot || (\n  '📅 Para crear el evento necesito algunos datos. Indica título, fecha (YYYY-MM-DD), hora (HH:MM) y participantes.'\n);\n\n// Historial\nif (!memoria.historial) memoria.historial = [];\nmemoria.historial.push({\n  timestamp: new Date().toISOString(),\n  accion: 'crear_evento_calendario_incompleto',\n  bot: 'Solicitando datos faltantes para crear evento',\n  chat_id: chatId\n});\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  chat_id: chatId,\n  mensaje_ia: mensaje,\n  memoria_actualizada: memoria,\n  // Para Postgres\n  esperando_confirmacion: 'crear_evento_calendario',\n  ultimo_mensaje_bot: mensaje,\n  datos_pendientes: memoria.datos_pendientes\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1568,
        11616
      ],
      "id": "738686ee-3851-4b71-a507-3aca58c4d1ea",
      "name": "Guardar Memoria Evento Incompleto"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [parseInt($json.chat_id) || 0, parseInt($json.chat_id) || 0,  'Usuario', 'crear_evento_calendario', $json.mensaje_ia, JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),  `Crear evento - datos incompletos: ${($json.memoria_actualizada?.datos_pendientes?.datos_faltantes || []).join(', ') || 'no especificado'}`,  JSON.stringify($json.memoria_actualizada?.historial || []), JSON.stringify([    {     tipo: 'usuario',     contenido: `Crear evento: ${$json.memoria_actualizada?.datos_pendientes?.titulo || '(sin título)'} | Fecha: ${$json.memoria_actualizada?.datos_pendientes?.fecha || '(sin fecha)'} | Hora: ${$json.memoria_actualizada?.datos_pendientes?.hora_inicio || '(sin hora)'}`,    timestamp: new Date().toISOString()    },   {     tipo: 'bot',     contenido: $json.mensaje_ia,     timestamp: new Date().toISOString()   }  ])] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1312,
        11664
      ],
      "id": "78eb10c9-a587-4bd1-b422-55d9f28ec153",
      "name": "Guardar Memoria PostgreSQL Evento"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT datos_pendientes\nFROM public.n8n\nWHERE chat_id = $1\n  AND esperando_confirmacion = 'crear_evento_calendario'\n  AND COALESCE(esperando_respuesta, true) = true\nORDER BY updated_at DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ [ parseInt($json.chat_id) || 0 ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2240,
        11504
      ],
      "id": "b36a0150-fa96-4d2e-a49f-296780482d25",
      "name": "Leer Memoria Antes De Validar"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7ed3d091-4b27-4966-837d-86cea02e0166",
              "leftValue": "={{ $json.success === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -288,
        11520
      ],
      "id": "e567bff0-0807-4f23-ab73-6a4cdfe51140",
      "name": "¿Evento creado?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE public.n8n\nSET esperando_confirmacion = NULL,\n    esperando_respuesta   = false,\n    datos_pendientes      = NULL,\n    ultimo_mensaje_bot    = NULL,\n    updated_at            = NOW()\nWHERE chat_id = $1;",
        "options": {
          "queryReplacement": "={{ [ parseInt($json.chat_id) || 0 ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -64,
        11504
      ],
      "id": "6f0d631c-b7b1-4e01-a017-ae98e970c4fe",
      "name": "Limpiar Memoria Evento"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT datos_pendientes\nFROM public.n8n\nWHERE chat_id = $1\n  AND esperando_confirmacion = 'filtro_tickets'\n  AND COALESCE(esperando_respuesta, true) = true\nORDER BY updated_at DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ [ parseInt($json.chat_id) || 0 ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2384,
        14064
      ],
      "id": "e02e3094-001c-4b41-8a9b-e307675ad695",
      "name": "Leer Memoria Tickets"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Preparar Consulta Tickets').item.json.consulta_listado_abiertos }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -992,
        14080
      ],
      "id": "ae5d0049-515c-4fe2-8c02-3928ca9f9a1c",
      "name": "HTTP Listado Abiertos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Preparar Consulta Tickets').item.json.consulta_estado_ticket }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -592,
        14080
      ],
      "id": "6bbd5009-7fab-4a3d-beee-2ac1346c586e",
      "name": "HTTP Estado Ticket"
    },
    {
      "parameters": {
        "jsCode": "const raw = ($json.mensaje_original || '');\nconst msg = raw.toLowerCase().replace(/\\s+/g, ' ').trim();\n\nlet intencion = 'resumen';\nlet ticket_id = null;\nlet ticket_nombre = null;\nlet ticket_exact = false;\nlet cerrados_periodo = 'todos';\n\nif ($json.tipo_consulta === 'abiertos' || (msg.includes('listado') && msg.includes('abiertos'))) {\n  intencion = 'listar_abiertos';\n}\n\nif (/(cerrad[oa]s?)/.test(msg) || $json.tipo_consulta === 'cerrados') {\n  intencion = 'listar_cerrados';\n  if (/(últimos?\\s*7\\s*días?|7\\s*días|ultima\\s*semana|última\\s*semana)/.test(msg)) {\n    cerrados_periodo = 'ultimos_7';\n  }\n}\n\nconst idMatch = msg.match(/\\b(?:ticket(?!s)|n[ºo]|num(?:ero)?)\\b\\s*#?(\\d+)\\b/i);\nif (idMatch) {\n  intencion = 'estado_ticket';\n  ticket_id = Number(idMatch[1]);\n}\n\nif (!ticket_id && /\\bticket(?!s)\\b/.test(msg)) {\n  const quoted = msg.match(/\\bticket(?!s)\\b\\s+[\"“]([^\"”]+)[\"”]/i);\n  if (quoted && quoted[1]) {\n    intencion = 'estado_ticket';\n    ticket_nombre = quoted[1].trim();\n    ticket_exact = true;\n  }\n}\n\nif (!ticket_id && !ticket_nombre) {\n  const nameAfterWord = msg.match(/\\bticket(?!s)\\b\\s+(?:llamado|con nombre|titulado)\\s+(.+?)$/i);\n  if (nameAfterWord && nameAfterWord[1]) {\n    intencion = 'estado_ticket';\n    ticket_nombre = nameAfterWord[1].trim();\n  }\n}\n\nconst tooGeneric = ['abierto','abiertos','cerrado','cerrados','tickets','listado','s abiertos','los abiertos'];\nif (ticket_nombre && tooGeneric.some(w => ticket_nombre.includes(w))) {\n  ticket_nombre = null;\n}\n\nif (intencion === 'estado_ticket' && !ticket_id && !ticket_nombre) {\n  intencion = 'listar_abiertos'; // o 'resumen'\n}\n\nreturn {\n  ...$json,\n  intencion,\n  ticket_id,\n  ticket_nombre,\n  ticket_exact,\n  cerrados_periodo,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2192,
        14080
      ],
      "id": "c5669849-0976-4518-a62b-d11962909058",
      "name": "Detectar Intención Tickets"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $('Preparar Consulta Tickets').item.json.consulta_listado_cerrados }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -800,
        14080
      ],
      "id": "e0514b63-3153-4765-99a6-45de895166a5",
      "name": "HTTP Listado Cerrados"
    },
    {
      "parameters": {
        "jsCode": "const inData = $json || {};\nconst productos = Array.isArray(inData.productos) ? inData.productos : [];\nif (productos.length === 0) throw new Error('No se recibieron productos');\n\nconst S = (v) => (v == null ? '' : String(v));\nconst norm = (s) => S(s).normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').toLowerCase();\n\nconst rawAction =\n  S(inData.tipo_accion_stock) ||\n  S(inData.tipo_accion) ||\n  S(inData.action);\n\nconst msg = norm(inData.mensaje_original || inData.respuesta_usuario || '');\n\n// Normaliza a {consumir|reponer}\nlet action;\nconst a = norm(rawAction);\nif (/^(consumir|gastar|salida|baja|consumo)$/.test(a)) {\n  action = 'consumir';\n} else if (/^(reponer|entrada|reposicion|reabastecer|abon)$/.test(a)) {\n  action = 'reponer';\n} else {\n  // Fallback por el mensaje del usuario\n  action = /(consum|gast|salid|baja)/.test(msg)\n    ? 'consumir'\n    : (/(rep|entrad|abon|repos)/.test(msg) ? 'reponer' : 'consumir');\n}\n\n// warehouse_hint (acepta “almacén central/principal” desde el mensaje)\nlet warehouseHint = S(inData.warehouse_hint || inData.almacen || inData['almacén']).trim();\nif (!warehouseHint) {\n  warehouseHint = /\\balmacen\\s+(central|principal)\\b/.test(msg) ? 'principal' : 'principal';\n}\n\nconst base = {\n  base_url: inData.base_url || 'https://lsanchezgoshawk-n8npruebas.odoo.com',\n  db: inData.db || 'lsanchezgoshawk-n8npruebas-main-25736898',\n  uid: Number(inData.uid || 2),\n  admin_password: inData.admin_password || 'admin',\n  chat_id: inData.chat_id,\n  user_id: inData.user_id,\n  user_name: inData.user_name,\n  action,                // <-- ya normalizado\n  warehouse_hint: warehouseHint,\n};\n\nreturn productos.map(p => {\n  const nombre = typeof p.nombre === 'string' ? p.nombre.trim() : S(p.producto || p.name).trim();\n  const cantidad = Number(p.cantidad ?? p.quantity ?? 1) || 1;\n  if (!nombre) throw new Error('Producto sin nombre');\n  return { ...base, product_name: nombre, quantity: cantidad };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        16080
      ],
      "id": "681080d6-cb52-464a-a92c-ff7db0e7cea4",
      "name": "Preparar FSM Inventario"
    },
    {
      "parameters": {
        "content": "## Gestionar Inventario"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4128,
        16064
      ],
      "id": "9df6ed88-e8d5-4d1d-b629-b61f92475aee",
      "name": "Sticky - FSM1"
    },
    {
      "parameters": {
        "jsCode": "const x = $json;\n\nconst asStr = (v) => (v == null ? '' : String(v).trim());\nconst asNum = (v, d = 0) => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : d;\n};\n\n// Materiales/productos\nconst productos = Array.isArray(x.productos) ? x.productos : [];\nconst items = productos\n  .map((p) => ({\n    nombre: asStr(p.nombre),\n    cantidad: asNum(p.cantidad, 1),\n  }))\n  .filter((p) => p.nombre);\n\n// Proyecto FSM por defecto\nconst proyecto = asStr(x.proyecto) || 'Servicio de campo';\nconst tareaSugerida =\n  asStr(x.tarea) || `Intervención - ${new Date().toLocaleDateString('es-ES')}`;\n\n// UID técnico (admin)\nconst uid = x.uid || ($('Autenticar Odoo')?.item?.json?.result);\n\n// DB\nconst db = x.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\n\n// 👇 nuevo: usuario funcional de Odoo\nconst odoo_user = asStr(x.odoo_user || x.cliente_perfil?.email || '');\nconst odoo_user_id = x.odoo_user_id || x.cliente_perfil?.user_id || null;\n\nreturn {\n  // Datos de trabajo\n  proyecto,\n  tarea: tareaSugerida,\n  horas: asNum(x.horas, 0),\n  descripcion: asStr(x.descripcion) || 'Trabajo realizado',\n  productos: items,\n  cliente: asStr(x.cliente || ''),\n\n  // Usuario Odoo funcional\n  odoo_user,\n  odoo_user_id,\n\n  // Credenciales/contexto\n  db,\n  uid,\n  chat_id: x.chat_id,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3056,
        17440
      ],
      "id": "3489855f-0399-42d8-9cc4-936e60a3e7af",
      "name": "Normalizar Parte+Materiales FSM"
    },
    {
      "parameters": {
        "content": "## Crear Parte de Trabajo\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4304,
        17200
      ],
      "id": "2a56729b-76ad-454f-969b-c5a0a1534916",
      "name": "Sticky Note24"
    },
    {
      "parameters": {
        "content": "## Crear Proyecto y Tarea en Parte de Trabajo si No Existe\n\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4272,
        17984
      ],
      "id": "f41c4f4c-8231-4e96-a455-19cd6a41a7c8",
      "name": "Sticky Note25"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS COMPLETOS PARA FSM (industry_fsm)\nlet datos = $json;\nconst x = $json;\n\n// Enriquecer desde AI Agent si existe\ntry {\n  const ai = $('Preparar Datos AI Agent')?.first()?.json;\n  if (ai) datos = Array.isArray(ai) ? ai[0] : ai;\n} catch {}\n\n// Arrastrar desde router si existe\nlet router = {};\ntry { router = $('Router de Acciones FIXED')?.first()?.json || {}; } catch {}\n\n// Preferir datos_pendientes si existen\nconst dp = (datos.datos_pendientes && Object.keys(datos.datos_pendientes).length) ? datos.datos_pendientes : {};\n\nfunction s(v){ return v==null ? '' : String(v).trim(); }\nfunction n(v,d=0){ const x = Number(v); return Number.isFinite(x) ? x : d; }\n\nconst proyecto = s(dp.proyecto || datos.proyecto || router.proyecto) || 'Servicio de campo';\nconst tarea = s(dp.tarea || datos.tarea || router.tarea) || `Intervención - ${new Date().toLocaleDateString('es-ES')}`;\nconst horas = n(dp.horas || datos.horas || router.horas, 0);\nconst descripcion = s(dp.descripcion || datos.descripcion || router.descripcion) || `Registro de ${horas} horas`;\nconst chat_id = datos.chat_id || router.chat_id || 0;\nconst productos = Array.isArray(dp.productos || datos.productos || router.productos) ? (dp.productos || datos.productos || router.productos) : [];\n\n// Cliente OBLIGATORIO: NO poner 'interno' por defecto\nconst rawCliente = dp.cliente ?? datos.cliente ?? router.cliente;\nconst cliente = s(rawCliente);\nconst cliente_faltante = cliente === '';\n\n// Credenciales\nlet db = dp.db || datos.db || router.db || $('Autenticar Odoo')?.item?.json?.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nlet uid = dp.uid || datos.uid || router.uid || $('Autenticar Odoo')?.item?.json?.result;\nif (!uid) throw new Error('Falta uid (Autenticar Odoo)');\n\nconst asStr = (v) => (v == null ? '' : String(v).trim());\n\n// 👇 nuevo: usuario funcional de Odoo\nconst odoo_user = asStr(x.odoo_user || x.cliente_perfil?.email || '');\nconst odoo_user_id = x.odoo_user_id || x.cliente_perfil?.user_id || null;\n\nreturn {\n  chat_id, db, uid,\n   // Usuario Odoo funcional\n  odoo_user,\n  odoo_user_id,\n  proyecto, tarea, horas, descripcion,\n  productos, cliente, cliente_faltante,\n  fecha_hoy: new Date().toISOString().split('T')[0]\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3136,
        18112
      ],
      "id": "156273f2-cc23-48a3-a528-c813a31d9979",
      "name": "FSM ▸ Preparar Datos Completos"
    },
    {
      "parameters": {
        "jsCode": "// Usa company_id y fija privacy_visibility='employees' + is_fsm=true\nconst base = $json;\n\n// Rehidratar desde el primer nodo (por si el HTTP anterior no arrastra contexto)\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\nconst db = base.db || seed.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid = base.uid || $('Autenticar Odoo')?.first()?.json?.result;\nif (!uid) throw new Error('Falta uid (Autenticar Odoo)');\n\n// --- 📌 REHIDRATAR company_id DESDE \"FSM ▸ HTTP Leer Compañía\" ---\nconst getJson = (name) => { try { return $(name)?.first()?.json || null; } catch { return null; } };\nconst httpCompany = getJson('FSM ▸ HTTP Leer Compañía') || {};\nconst compList = httpCompany.result || httpCompany.body?.result || httpCompany.json?.result || [];\n\nlet companyId = null;\nif (Array.isArray(compList) && compList[0]?.company_id) {\n  const c = compList[0].company_id;\n  companyId = Array.isArray(c) ? Number(c[0]) : Number(c);\n}\n\n// fallback suave a cualquier company_id que venga en seed/base\nif (!Number.isFinite(companyId)) {\n  const cSeed = base.company_id ?? seed.company_id;\n  if (Array.isArray(cSeed)) companyId = Number(cSeed[0]);\n  else if (cSeed != null) companyId = Number(cSeed);\n}\n\n// Si aún no hay company_id, no abortes: Odoo usará la del usuario por defecto.\n// Si prefieres forzar, descomenta la siguiente línea:\n// if (!Number.isFinite(companyId)) throw new Error('No se pudo resolver company_id del usuario');\n\n// Rehidratar partner_id si existe desde el contexto o el resolver de cliente\nconst partnerId = Number(\n  base.partner_id ??\n  $('FSM ▸ Validar Cliente')?.first()?.json?.partner_id\n);\n\nconst vals = {\n  name: base.proyecto || seed.proyecto || 'Servicio de campo',\n  is_fsm: true,\n  allow_timesheets: true,\n  privacy_visibility: 'employees',\n  ...(Number.isFinite(companyId) ? { company_id: companyId } : {}),\n  ...(Number.isFinite(partnerId) ? { partner_id: partnerId } : {}),\n};\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [ db, uid, 'admin', 'project.project', 'create', [ vals ] ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\n// Mantén en el contexto todos los datos que usaremos después\nreturn {\n  ...seed,\n  ...base,\n  db, uid,\n  company_id: Number.isFinite(companyId) ? companyId : null,\n  proyecto: vals.name,\n  payload\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        18128
      ],
      "id": "88645f2a-920b-41bc-bf30-01e75ffae6dd",
      "name": "FSM ▸ Flujo Crear Proyecto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1104,
        18128
      ],
      "id": "2ecaabf7-15e0-402b-939b-cdfaa5fdf30a",
      "name": "FSM ▸ HTTP Crear Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// PASO 2: CREAR TAREA dentro del proyecto\nconst ctx  = $json;\nconst seed = $('FSM ▸ Preparar Datos Completos').first().json;\nconst db   = ctx.db || seed.db;\nconst uid  = ctx.uid || $('Autenticar Odoo').first().json?.result;\nif (!uid) throw new Error('Falta uid (Autenticar Odoo)');\n\n// ✅ FUENTES ROBUSTAS para proyecto_id\nconst asNum = v => { const n = Number(v); return Number.isFinite(n) ? n : null; };\nconst get = n => { try { return $(n)?.first()?.json || null; } catch { return null; } };\n\nlet proyecto_id =\n  asNum(ctx.proyecto_id) ||\n  asNum(get('FSM ▸ Resolver Tarea ID')?.proyecto_id) || // ← si venimos de \"buscar tarea\"\n  asNum(get('FSM ▸ Resolver Proyecto ID')?.proyecto_id) || // ← si el proyecto existía\n  asNum(get('Proyecto ID')?.proyecto_id) || // ← si acabas de crear proyecto\n  asNum(ctx.result || ctx.body?.result); // ← solo justo tras crear proyecto (HTTP)\n\nif (!Number.isFinite(proyecto_id)) {\n  throw new Error('No se obtuvo proyecto_id (FSM)');\n}\n\nconst proyecto    = ctx.proyecto || seed.proyecto || 'Servicio de campo';\nconst tarea       = ctx.tarea    || seed.tarea    || `Intervención - ${new Date().toLocaleDateString('es-ES')}`;\nconst horas       = Number(ctx.horas ?? seed.horas ?? 0);\nconst descripcion = ctx.descripcion || seed.descripcion || `Registro de ${horas} horas`;\n\nconst vals = { name: tarea, project_id: proyecto_id, ...(Number.isFinite(ctx.partner_id) ? { partner_id: ctx.partner_id } : {}) };\nconst payload = { jsonrpc:'2.0', method:'call', params:{ service:'object', method:'execute_kw', args:[db, uid, 'admin', 'project.task', 'create', [ [vals] ]] }, id: Math.floor(Math.random()*1e6) };\n\nreturn { ...ctx, db, uid, proyecto, proyecto_id, tarea, horas, descripcion, payload };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        18128
      ],
      "id": "726b3c3e-709e-4918-b7b9-a7506482c1a7",
      "name": "FSM ▸ Preparar Crear Tarea"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -144,
        18128
      ],
      "id": "2d3996ed-80d5-425e-994a-8c0264ceae8a",
      "name": "FSM ▸ HTTP Crear Tarea"
    },
    {
      "parameters": {
        "jsCode": "// PASO 3: REGISTRAR HORAS en la tarea creada\nconst ctx = $json;\n\n// Rehidratar desde el primer nodo\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\nconst db = ctx.db || seed.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid = ctx.uid || $('Autenticar Odoo')?.first()?.json?.result;\nif (!uid) throw new Error('Falta uid (Autenticar Odoo)');\n\nconst r = ctx.result || ctx.body?.result;\nif (!r) throw new Error('No se obtuvo ID de tarea (FSM)');\nconst task_id = Number(r);\n\n// 👇 NUEVO: Extraer odoo_user_id desde 'Propagar Usuario Odoo'\nlet odoo_user_id = null;\ntry {\n  const propagarUsuario = $('Propagar Usuario Odoo')?.first()?.json;\n  if (propagarUsuario) {\n    // El nodo devuelve [{ ..., odoo_user_id: X, ... }]\n    const usuarioData = Array.isArray(propagarUsuario) ? propagarUsuario[0] : propagarUsuario;\n    odoo_user_id = usuarioData?.odoo_user_id;\n  }\n} catch (e) {\n  console.log('⚠️ No se pudo extraer odoo_user_id:', e.message);\n}\n\n// Rehidratar negocio\nconst proyecto_id = ctx.proyecto_id || seed.proyecto_id;\nconst tarea = ctx.tarea || seed.tarea;\nconst horas = Number(ctx.horas ?? seed.horas ?? 0);\nconst descripcion = ctx.descripcion || seed.descripcion || `Trabajo en ${tarea}`;\nconst fecha_hoy = ctx.fecha_hoy || seed.fecha_hoy || new Date().toISOString().split('T')[0];\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'account.analytic.line', 'create',\n      [[{\n        name: descripcion,\n        project_id: proyecto_id,\n        task_id: task_id,\n        unit_amount: horas,\n        date: fecha_hoy,\n        ...(Number.isFinite(odoo_user_id) ? { user_id: odoo_user_id } : {})\n      }]]\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn {\n  ...ctx,\n  db, uid,\n  proyecto_id, tarea, horas, descripcion, fecha_hoy,\n  task_id,\n  odoo_user_id,\n  payload\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        18128
      ],
      "id": "5d25a5e2-e3ed-4f8b-ba3d-204077bac1e7",
      "name": "FSM ▸ Preparar Registrar Horas"
    },
    {
      "parameters": {
        "jsCode": "// PASO 4: PUBLICAR NOTA DE MATERIALES en la tarea (si hay)\nconst ctx = $json;\n\n// Rehidratar contexto base\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\nconst db = ctx.db || seed.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid = ctx.uid || $('Autenticar Odoo')?.first()?.json?.result;\nif (!uid) throw new Error('Falta uid (Autenticar Odoo)');\n\n// Rehidratar materiales (prioridad: ctx → seed)\nconst productosSeed = Array.isArray(seed.productos) ? seed.productos : [];\nconst productos = Array.isArray(ctx.productos) ? ctx.productos : productosSeed;\n\n// Si no hay materiales, no publicamos nota\nif (!Array.isArray(productos) || productos.length === 0) {\n  return {\n    ...ctx,\n    db,\n    uid,\n    productos: [],\n    hay_materiales: false,\n    skip_nota: true,\n    motivo: 'Sin materiales',\n  };\n}\n\n// Texto plano\nconst lineas = (Array.isArray(productos) ? productos : [])\n  .map(p => `• ${Number(p.cantidad || 1)} × ${String(p.nombre || '').trim()}`)\n  .join('\\n');\n\nconst texto = [\n  '🧰 Material utilizado:',\n  lineas,\n  'Contexto: Servicio de campo (FSM)',\n].join('\\n');\n\n// Resolver task_id SOLO con nodos de la rama FSM\nconst taskId =\n  ctx.task_id ??\n  $('FSM ▸ Preparar Registrar Horas (final)')?.first()?.json?.task_id ??\n  $('FSM ▸ HTTP Crear Tarea')?.first()?.json?.result;\n\nif (!taskId) {\n  return {\n    ...ctx,\n    db,\n    uid,\n    productos,\n    hay_materiales: true,\n    skip_nota: true,\n    motivo: 'Sin task_id',\n  };\n}\n\n// 👇 NUEVO: sacar author_id desde \"Propagar Usuario Odoo\" → \"Buscar Usuario Odoo\" o desde seed\nlet authorId = null;\n\n// Intento 1: Desde \"Propagar Usuario Odoo\" (nueva fuente)\ntry {\n  const propagarUsuario = $('Propagar Usuario Odoo')?.first()?.json;\n  if (propagarUsuario) {\n    const usuarioData = Array.isArray(propagarUsuario) ? propagarUsuario[0] : propagarUsuario;\n    // odoo_partner_id es el partner_id del usuario en Odoo\n    if (Number.isFinite(usuarioData?.odoo_partner_id)) {\n      authorId = Number(usuarioData.odoo_partner_id);\n    }\n  }\n} catch (e) {\n  console.log('⚠️ No se pudo extraer partner_id desde Propagar Usuario Odoo:', e.message);\n}\n\n// Intento 2: Fallback a \"Buscar Usuario Odoo\"\nif (!Number.isFinite(authorId)) {\n  try {\n    const buo = $('Buscar Usuario Odoo')?.first()?.json;\n    const lista = buo?.json?.result ?? buo?.result ?? buo?.body?.result ?? [];\n    const u = Array.isArray(lista) && lista[0] ? lista[0] : null;\n    if (u?.partner_id) {\n      authorId = Array.isArray(u.partner_id)\n        ? Number(u.partner_id[0])\n        : Number(u.partner_id);\n    }\n  } catch {}\n}\n\n// Intento 3: Fallback a seed\nif (!Number.isFinite(authorId) && Number.isFinite(seed.odoo_partner_id)) {\n  authorId = Number(seed.odoo_partner_id);\n}\n\n// Valores de la nota\nconst valsMessage = {\n  body: texto,\n  message_type: 'comment',\n  subtype_xmlid: 'mail.mt_comment',\n};\n\nif (Number.isFinite(authorId)) {\n  valsMessage.author_id = authorId;  // 👈 autor real de la nota\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'project.task',\n      'message_post',\n      [ taskId ],\n      valsMessage,\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...ctx,\n  db,\n  uid,\n  task_id: taskId,\n  productos,\n  hay_materiales: true,\n  payload,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1632,
        18128
      ],
      "id": "db1e1165-8582-4261-a11e-1923bfdc8eb6",
      "name": "FSM ▸ Preparar Nota Materiales"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.hay_materiales === true }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1824,
        18128
      ],
      "id": "ac6edc16-8aa5-4987-8a68-89a9d168ce09",
      "name": "FSM ▸ ¿Hay materiales?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2144,
        17984
      ],
      "id": "2b3b9f9b-5369-4dac-890f-1fef3ce9627a",
      "name": "FSM ▸ HTTP Nota Materiales"
    },
    {
      "parameters": {
        "jsCode": "// Construir salida como ARRAY y asegurar chat_id y horas_id correctos\nconst items = $input.all();\n\nreturn items.map(({ json: ctx }) => {\n  // horas_id desde el HTTP que crea horas (directo o FSM), con fallbacks\n  const horasId =\n    $('FSM ▸ HTTP Registrar Horas')?.first()?.json?.result ??\n    $('FSM ▸ HTTP Registrar Horas')?.first()?.json?.body?.result ??\n    ctx.result ?? ctx.body?.result ?? null;\n\n  // chat_id robusto\n  const chatId =\n    ctx.chat_id ??\n    $('FSM ▸ Preparar Datos Completos')?.first()?.json?.chat_id ??\n    $('FSM ▸ HTTP Registrar Horas')?.first()?.json?.registro?.chat_id ??\n    0;\n\n  return {\n    json: {\n      chat_id: chatId,\n      resumen_creado: {\n        proyecto: ctx.proyecto ?? $('FSM ▸ Preparar Datos Completos')?.first()?.json?.proyecto,\n        proyecto_id: ctx.proyecto_id,\n        tarea: ctx.tarea ?? $('FSM ▸ Preparar Datos Completos')?.first()?.json?.tarea,\n        tarea_id: ctx.task_id,\n        horas: ctx.horas ?? $('FSM ▸ Preparar Datos Completos')?.first()?.json?.horas ?? 0,\n        horas_id: horasId,\n        descripcion: ctx.descripcion ?? $('FSM ▸ Preparar Datos Completos')?.first()?.json?.descripcion,\n        fecha: ctx.fecha_hoy ?? $('FSM ▸ Preparar Datos Completos')?.first()?.json?.fecha_hoy\n      }\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2320,
        18512
      ],
      "id": "83baaf4c-05ae-499d-b138-310cb0d3c1cf",
      "name": "FSM ▸ Limpiar & Resumen"
    },
    {
      "parameters": {
        "chatId": "={{ $('FSM ▸ Limpiar & Resumen').item.json.chat_id }} ",
        "text": "=✅ ¡Parte de horas registrado exitosamente!\n\n📋 Detalles del registro:\n• Proyecto: {{ $('FSM ▸ Limpiar & Resumen').item.json.resumen_creado.proyecto }}\n• Tarea: {{ $('FSM ▸ Limpiar & Resumen').item.json.resumen_creado.tarea }}\n• Horas: {{ $('FSM ▸ Limpiar & Resumen').item.json.resumen_creado.horas }}\n• Descripción: {{ $('FSM ▸ Limpiar & Resumen').item.json.resumen_creado.descripcion }}\n• Fecha: {{ $('FSM ▸ Limpiar & Resumen').item.json.resumen_creado.fecha }}\n• ID del registro: {{ $('FSM ▸ Limpiar & Resumen').item.json.resumen_creado.horas_id }}\n🔗 Registro de horas: [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id={{ $('FSM ▸ Limpiar & Resumen').item.json.resumen_creado.horas_id }}&model=account.analytic.line&view_type=form)\n\n🎉 ¡Listo! ¿Necesitas registrar más horas? 😊",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2720,
        18512
      ],
      "id": "5b7c6b54-0523-403f-a764-844d00a3fc39",
      "name": "FSM ▸ Confirmar Flujo",
      "webhookId": "e99a7f75-c964-40eb-be55-943594a16829"
    },
    {
      "parameters": {
        "jsCode": "// Lee la compañía del usuario (uid) para usarla al crear el proyecto FSM\nconst ctx = $json;\n\n// Rehidratar\nconst db = ctx.db\n  || $('FSM ▸ Preparar Datos Completos')?.first()?.json?.db\n  || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid = ctx.uid\n  || $('Autenticar Odoo')?.first()?.json?.result;\nif (!uid) throw new Error('Falta uid (Autenticar Odoo)');\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'res.users',\n      'read',\n      [[uid], ['company_id']]\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn { ...ctx, db, uid, payload };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2544,
        18112
      ],
      "id": "ac88b938-edaf-49af-bd34-a1b32ab67e7b",
      "name": "FSM ▸ Preparar Leer Compañía"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2384,
        18112
      ],
      "id": "2a346d59-8426-4647-8777-93a4bab95bf6",
      "name": "FSM ▸ HTTP Leer Compañía"
    },
    {
      "parameters": {
        "jsCode": "// Validar que haya cliente antes de seguir el flujo FSM\nconst ctx = $json;\n\nif (ctx.cliente_faltante === true) {\n  const chatId = Number(ctx.chat_id || 0);\n  const contextoKey = `memoria_${chatId}`;\n\n  // Guardar datos pendientes en memoria global (puedes además persistir en Postgres si quieres)\n  let memoria = global[contextoKey] || {};\n  memoria.esperando_confirmacion = 'solicitar_cliente_fsm';\n  memoria.esperando_respuesta = true;\n  memoria.datos_pendientes = {\n    accion_original: 'registrar_parte_y_stock',\n    proyecto: ctx.proyecto,\n    tarea: ctx.tarea,\n    horas: Number(ctx.horas || 0),\n    descripcion: ctx.descripcion || '',\n    productos: Array.isArray(ctx.productos) ? ctx.productos : [],\n    cliente: '', // faltante\n    db: ctx.db,\n    uid: ctx.uid,\n    fecha: ctx.fecha_hoy,\n  };\n  global[contextoKey] = memoria;\n\n  return {\n    accion: 'falta_cliente_fsm',\n    chat_id: chatId,\n    mensaje_bot: 'Falta cliente para el parte de trabajo (FSM). ¿A qué cliente va dirigido?',\n    memoria_actualizada: memoria,\n  };\n}\n\n// Cliente OK → continuar\nreturn { ...ctx, accion: 'continuar_fsm' };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2912,
        18112
      ],
      "id": "738456b2-3fcb-4034-8614-dfb51871a484",
      "name": "FSM ▸ Validar Cliente"
    },
    {
      "parameters": {
        "jsCode": "// Busca el partner por nombre (si hay cliente). Si no hay cliente, saltar búsqueda.\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\nconst ctx = $json;\n\nconst db = ctx.db || seed.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid = ctx.uid || $('Autenticar Odoo')?.first()?.json?.result;\nif (!uid) throw new Error('Falta uid (Autenticar Odoo)');\n\nconst cliente = String(ctx.cliente || seed.cliente || '').trim();\nif (!cliente) {\n  // No hay cliente → saltar búsqueda, pero NO montes el payload de create aquí\n  return { ...ctx, db, uid, skip_cliente_search: true };\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'res.partner', 'search_read',\n      [[['name', 'ilike', cliente]]],\n      { fields: ['id','name'], limit: 1 }\n    ],\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn { ...ctx, db, uid, cliente, skip_cliente_search: false, payload };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        256,
        18128
      ],
      "id": "0bf1d79b-02ff-4968-9570-e64f412e5e21",
      "name": "FSM ▸ Preparar Buscar Clientee"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        416,
        18128
      ],
      "id": "b0a1aa23-41d9-4196-b10f-25460984f1a9",
      "name": "FSM ▸ HTTP Buscar Cliente"
    },
    {
      "parameters": {
        "jsCode": "const ctx = $json;\n\nlet partnerId = null;\nlet partnerName = null;\n\nif (!ctx.skip_cliente_search) {\n  const r = ctx.result || ctx.body?.result || [];\n  if (Array.isArray(r) && r[0]?.id) {\n    partnerId = Number(r[0].id);\n    partnerName = String(r[0].name || '').trim();\n  }\n}\n\nreturn { ...ctx, partner_id: partnerId, partner_name: partnerName };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        592,
        18128
      ],
      "id": "a7325f31-f25c-4162-8074-fc4f0d1b0b21",
      "name": "FSM ▸ Resolver Cliente ID"
    },
    {
      "parameters": {
        "jsCode": "// Asignar cliente (partner_id) a la tarea SIN IF: siempre retorna un payload válido\nconst ctx = $json;\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\n\nconst db  = ctx.db || seed.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid = ctx.uid || $('Autenticar Odoo')?.first()?.json?.result;\n\n// Rehidratar task_id de forma robusta\nlet taskId =\n  Number(ctx.task_id) ||\n  Number($('FSM ▸ Preparar Registrar Horas')?.first()?.json?.task_id) ||\n  Number($('FSM ▸ HTTP Crear Tarea')?.first()?.json?.result);\n\nif (!taskId) {\n  const ht = $('HTTP Buscar Tarea FSM')?.first()?.json;\n  const rr = ht?.result || ht?.body?.result || [];\n  if (Array.isArray(rr) && rr[0]?.id) taskId = Number(rr[0].id);\n}\n\n// Rehidratar partner_id\nconst partnerId = Number(\n  ctx.partner_id ?? $('FSM ▸ Resolver Cliente ID')?.first()?.json?.partner_id\n);\n\n// Construir args del JSON-RPC: si tenemos taskId/partnerId → write; si no, un no-op seguro\nlet args;\nif (uid && Number.isFinite(taskId) && Number.isFinite(partnerId)) {\n  args = [\n    db, uid, 'admin',\n    'project.task', 'write',\n    [[ taskId ], { partner_id: partnerId }]\n  ];\n} else {\n  // No-op seguro para evitar 400 cuando falte algún dato (sin IF)\n  args = [\n    db, uid || 1, 'admin',\n    'res.partner', 'search_read',\n    [[['id', '=', 0]]],\n    { fields: ['id'], limit: 0 }\n  ];\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: { service: 'object', method: 'execute_kw', args },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...ctx,\n  db, uid,\n  task_id: Number.isFinite(taskId) ? taskId : null,\n  partner_id: Number.isFinite(partnerId) ? partnerId : null,\n  payload\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        18128
      ],
      "id": "e5a0ed9c-6032-4991-9677-8475e6c98595",
      "name": "FSM ▸ Preparar Asignar Cliente a Tarea (FSM)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1040,
        18128
      ],
      "id": "4d3a05d3-10ad-4cee-b875-4103d5355954",
      "name": "FSM ▸ HTTP Asignar Cliente a Tarea (FSM)"
    },
    {
      "parameters": {
        "jsCode": "// Construye el create final incluyendo partner_id y user_id si existen (robusto)\nconst ctx  = $json;\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\n\nconst db  = ctx.db || seed.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid = ctx.uid || $('Autenticar Odoo')?.first()?.json?.result;\nif (!uid) throw new Error('Falta uid (Autenticar Odoo)');\n\n// Helpers\nconst asNum = v => {\n  const n = Number(v);\n  return Number.isFinite(n) ? n : null;\n};\nconst getJson = (name) => {\n  try { return $(name)?.first()?.json || null; } catch { return null; }\n};\nconst httpOut = (name) => {\n  const h = getJson(name) || {};\n  return h.result ?? h.body?.result ?? h.json?.result ?? null;\n};\n\n// Recolectar candidatos de proyecto_id\nconst candProyecto = [\n  ctx.proyecto_id,\n  seed.proyecto_id,\n  getJson('FSM ▸ Preparar Crear Tarea')?.proyecto_id,\n  httpOut('FSM ▸ HTTP Crear Proyecto'),\n  getJson('FSM ▸ Resolver Proyecto ID')?.proyecto_id,\n  getJson('FSM ▸ Resolver Tarea ID')?.proyecto_id,\n  (() => {\n    const ht = getJson('FSM ▸ HTTP Buscar Tarea');\n    const rr = ht?.result || ht?.body?.result || ht?.json?.result || [];\n    return Array.isArray(rr) && rr[0]?.project_id\n      ? (Array.isArray(rr[0].project_id) ? rr[0].project_id[0] : rr[0].project_id)\n      : null;\n  })(),\n].map(asNum).filter(Number.isFinite);\n\nconst proyectoId = candProyecto[0] || null;\n\n// Recolectar candidatos de task_id\nconst candTask = [\n  ctx.task_id,\n  getJson('FSM ▸ Preparar Registrar Horas')?.task_id,\n  httpOut('FSM ▸ HTTP Crear Tarea'),\n  getJson('FSM ▸ Resolver Tarea ID')?.task_id,\n  (() => {\n    const ht2 = getJson('FSM ▸ HTTP Buscar Tarea');\n    const rr2 = ht2?.result || ht2?.body?.result || ht2?.json?.result || [];\n    return Array.isArray(rr2) && rr2[0]?.id ? rr2[0].id : null;\n  })(),\n].map(asNum).filter(Number.isFinite);\n\nconst taskId = candTask[0] || null;\n\nif (!proyectoId || !taskId) {\n  throw new Error(`Faltan ids de proyecto o tarea (proyecto_id=${proyectoId ?? 'null'}, task_id=${taskId ?? 'null'})`);\n}\n\n// partner_id opcional\nlet partnerId = null;\nif (typeof ctx.partner_id === 'number') partnerId = ctx.partner_id;\nconst resolvedPartner = getJson('FSM ▸ Resolver Cliente ID')?.partner_id;\nif (partnerId === null && typeof resolvedPartner === 'number') partnerId = resolvedPartner;\n\n// 👇 NUEVO: Extraer odoo_user_id desde 'Propagar Usuario Odoo'\nlet odoo_user_id = null;\ntry {\n  const propagarUsuario = $('Propagar Usuario Odoo')?.first()?.json;\n  if (propagarUsuario) {\n    const usuarioData = Array.isArray(propagarUsuario) ? propagarUsuario[0] : propagarUsuario;\n    odoo_user_id = usuarioData?.odoo_user_id;\n  }\n} catch (e) {\n  console.log('⚠️ No se pudo extraer odoo_user_id:', e.message);\n}\n\n// Datos de la línea\nconst horas      = asNum(ctx.horas ?? seed.horas) ?? 0;\nconst fecha_hoy  = ctx.fecha_hoy || seed.fecha_hoy || new Date().toISOString().split('T')[0];\nconst descripcion= ctx.descripcion || seed.descripcion || `Trabajo en ${ctx.tarea || ''}`;\n\nconst lineVals = {\n  name: descripcion,\n  project_id: proyectoId,\n  task_id: taskId,\n  unit_amount: horas,\n  date: fecha_hoy,\n  ...(Number.isFinite(partnerId) ? { partner_id: partnerId } : {}),\n  ...(Number.isFinite(odoo_user_id) ? { user_id: odoo_user_id } : {}),\n};\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'account.analytic.line', 'create',\n      [[ lineVals ]]\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn { ...ctx, db, uid, proyecto_id: proyectoId, task_id: taskId, partner_id: partnerId ?? null, odoo_user_id, payload };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        18128
      ],
      "id": "29b9265a-0df4-45a6-b028-7d01e3202671",
      "name": "FSM ▸ Preparar Registrar Horas (final)"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1424,
        18128
      ],
      "id": "2d999fc4-41c1-4321-b1ac-971397ea2274",
      "name": "FSM ▸ HTTP Registrar Horas"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR BÚSQUEDA PRODUCTOS (tokens + default_code + AND sale_ok)\n// Objetivo: conseguir un pool amplio y relevante para que el fuzzy sugiera\n// \"hamburguesa con queso\" y \"azucar 10 kg\", etc.\n\nconst datos = $json;\nconst uid = datos.uid;\nconst productos = Array.isArray(datos.productos) ? datos.productos : [];\n\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\nconst normalize = (s) =>\n  (s || '')\n    .toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .toLowerCase()\n    .replace(/[^a-z0-9%\\. ]+/g,' ')\n    .replace(/\\s+/g,' ')\n    .trim();\n\n// genera variantes útiles: singular/plural básico y número+unidad\nfunction variants(tok) {\n  const out = new Set([tok]);\n  // singularización sencilla\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s'))  out.add(tok.slice(0, -1));\n\n  // número+unidad: 5kg -> 5 , kg , 5kg\n  const m = tok.match(/^(\\d+(?:\\.\\d+)?)(kg|g|mg|l|ml|cm|mm|m|u|uds?)$/);\n  if (m) { out.add(m[1]); out.add(m[2]); }\n\n  return [...out];\n}\n\nfunction tokens(nombre) {\n  const base = normalize(nombre);\n  if (!base) return [];\n  const raw = base.split(' ').filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) for (const v of variants(tk)) if (v.length >= 2) uniq.add(v);\n  return [...uniq];\n}\n\n// 1) Construir hojas (leaves) para OR global: name ilike tk  OR  default_code ilike tk\nlet leaves = [];\nfor (const p of productos) {\n  if (!p || typeof p.nombre !== 'string') continue;\n  const tks = tokens(p.nombre);\n  for (const tk of tks) {\n    leaves.push(['name', 'ilike', tk]);\n    leaves.push(['default_code', 'ilike', tk]);\n  }\n}\n\n// deduplicar leaves\nconst seen = new Set();\nleaves = leaves.filter(l => {\n  const k = JSON.stringify(l);\n  if (seen.has(k)) return false;\n  seen.add(k);\n  return true;\n});\n\n// --- construir dominio correcto (plano) ---\n\nlet domain;\n\nif (leaves.length === 0) {\n  // sin términos -> dominio imposible (evita resultados)\n  domain = [['id', '=', -1]];\n} else {\n  // OR de todas las hojas:  [ '|', '|', ..., hoja1, hoja2, ..., hojaN ]\n  const orTokens = (leaves.length === 1)\n    ? [leaves[0]]\n    : [...Array(leaves.length - 1).fill('|'), ...leaves];\n\n  // AND con sale_ok:  ['&', ['sale_ok','=',true],  ...orTokens ]\n  domain = ['&', ['sale_ok', '=', true], ...orTokens];\n}\n\nconsole.log('🔍 Dominio construido (plano):', JSON.stringify(domain));\n\n\n// 2) Payload a Odoo\nconst payloadId = Math.floor(Math.random() * 1e6);\nconst jsonRpcPayload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'product.product',\n      'search_read',\n      [domain],\n      {\n        fields: ['id', 'name', 'list_price', 'uom_id', 'default_code'],\n        limit: 300  // un poco más amplio para que el fuzzy tenga material\n      }\n    ]\n  },\n  id: payloadId\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  productos_solicitados: productos,\n  cliente_id: datos.cliente_id,\n  cliente_encontrado: datos.cliente_encontrado,\n  cliente_datos: datos.cliente_datos,\n  cliente_nombre: datos.cliente_nombre,\n  productos: datos.productos,\n  chat_id: datos.chat_id,\n  uid: datos.uid,\n  datos_originales: datos.datos_originales\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -960,
        11040
      ],
      "id": "f05737eb-0355-4fb4-847f-2112d4b93400",
      "name": "Preparar Búsqueda Productos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -800,
        11040
      ],
      "id": "99df32e2-749b-4cc5-9368-d967fecd72bd",
      "name": "HTTP Buscar Productos FIXED"
    },
    {
      "parameters": {
        "jsCode": "// Formatear aviso para admins tras crear el pedido (borrador)\nconst pedidoCreado = $json.result; // ID devuelto por Odoo JSON-RPC al crear sale.order\nconst datos = $('Crear Pedido Venta').item.json || {};\nconst clienteDatos = datos.cliente_datos || {};\nconst lineasPedido = Array.isArray(datos.lineas_pedido) ? datos.lineas_pedido : [];\nconst baseUrl = 'https://lsanchezgoshawk-n8npruebas.odoo.com';\n\nconst saleId = typeof pedidoCreado === 'number' ? pedidoCreado : null;\nconst enlace = saleId ? `${baseUrl}/web#id=${saleId}&model=sale.order&view_type=form` : '';\nconst cliente = clienteDatos.name || 'Cliente';\n\nlet texto = '🔔 **Nuevo pedido creado**\\n\\n';\nif (saleId) texto += `🆔 **ID:** ${saleId}\\n`;\nif (enlace) texto += `🔗 **Pedido:** [Abrir en Odoo](${enlace})\\n`;\ntexto += `👤 **Cliente:** ${cliente}\\n`;\n\nif (lineasPedido.length > 0) {\n  texto += `\\n📦 **Productos:**\\n`;\n  for (const l of lineasPedido) {\n    texto += `• ${l.name} - Cantidad: ${l.product_uom_qty} - Precio: €${l.price_unit}\\n`;\n  }\n}\n\nreturn {\n  texto,\n  sale_id: saleId,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        10736
      ],
      "id": "79d5725e-a4f0-41e9-9465-624a7e4ecfaf",
      "name": "Mensaje para Admins de Nuevo Pedido"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT chat_id FROM telegram_users WHERE is_admin = true",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1520,
        10752
      ],
      "id": "c82386d7-3435-4aba-85c6-ae1379f87913",
      "name": "Listar Admins Para Mandar Pedido"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $('Mensaje para Admins de Nuevo Pedido').item.json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1696,
        10752
      ],
      "id": "42e74218-c827-48f0-9d19-df2311dfb3cd",
      "name": "Avisar Admin Nuevo Pedido",
      "webhookId": "86c2fc4b-a829-4c80-b1d6-ba10d9a7c9a4"
    },
    {
      "parameters": {
        "jsCode": "// Adaptar reanudación → input de FSM Inventario\nconst d = $json || {};\nconst r = d.reanudacion || {};\nconst productos = Array.isArray(r.productos) ? r.productos : [];\n\nif (!productos.length) {\n  throw new Error('Reanudación sin productos');\n}\n\nreturn {\n  // acción/finalidad\n  accion: 'fsm_inventario',\n  tipo_accion: (r.tipo_accion || 'reponer'),\n  warehouse_hint: (r.warehouse_hint || 'principal'),\n\n  // lote de productos (tal como espera tu FSM Inventario)\n  productos: productos.map(p => ({\n    nombre: String(p?.nombre || '').trim(),\n    cantidad: Number(p?.cantidad || 1) || 1,\n  })),\n\n  // credenciales/base\n  base_url: r.base_url || d.base_url,\n  db: r.db || d.db,\n  uid: r.uid || d.uid,\n  admin_password: r.admin_password || d.admin_password || 'admin',\n\n  // usuario\n  chat_id: d.chat_id,\n  user_id: d.user_id,\n  user_name: d.user_name,\n\n  // bandera opcional para limpiar memoria al terminar\n  limpiar_memoria: true,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3136,
        16096
      ],
      "id": "12ce8b88-3ba7-4013-96dc-e4c05ac8bbb8",
      "name": "Reformatear Reanudación FSM"
    },
    {
      "parameters": {
        "jsCode": "const pedidoCreado = $('HTTP Crear Pedido').item.json.result; // ID\nconst readResult = $json.result; // resultado de Leer Pedido\nconst orderName = Array.isArray(readResult) && readResult[0]?.name\n  ? readResult[0].name\n  : pedidoCreado.toString();\n\nconst datos = $('Crear Pedido Venta').item.json;\nconst clienteDatos = datos.cliente_datos;\nconst lineasPedido = datos.lineas_pedido;\nconst productosNoEncontrados = datos.productos_no_encontrados;\nconst baseUrl = 'https://lsanchezgoshawk-n8npruebas.odoo.com';\n\nlet texto = '';\n\nif (!pedidoCreado) {\n  texto = '❌ Error al crear el pedido de venta. Por favor, intenta de nuevo.';\n} else {\n  texto = `✅ **¡Pedido de venta creado exitosamente!**\\n\\n`;\n  texto += `🧾 **Nº Pedido:** ${orderName}\\n`;\n  texto += `🛒 **ID Interno:** ${pedidoCreado}\\n`;\n  const enlace = `${baseUrl}/web#id=${pedidoCreado}&model=sale.order&view_type=form`;\n  texto += `🔗 **Pedido:** [Abrir en Odoo](${enlace})\\n`;\n  texto += `👤 **Cliente:** ${clienteDatos.name}\\n\\n`;\n\n  texto += `📦 **Productos incluidos:**\\n`;\n  for (const linea of lineasPedido) {\n    texto += `• ${linea.name} - Cantidad: ${linea.product_uom_qty} - Precio: €${linea.price_unit}\\n`;\n  }\n\n  if (productosNoEncontrados.length > 0) {\n    texto += `\\n⚠️ **Productos no encontrados:**\\n`;\n    for (const producto of productosNoEncontrados) {\n      texto += `• ${producto}\\n`;\n    }\n  }\n\n  texto += `\\n🎉 ¡El pedido está listo!`;\n}\n\nreturn {\n  texto,\n  chat_id: datos.chat_id,\n  pedido_id: pedidoCreado,\n  pedido_numero: orderName,\n  cliente_id: datos.cliente_id,\n  productos_incluidos: lineasPedido.length,\n  productos_no_encontrados: productosNoEncontrados.length\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1440,
        10544
      ],
      "id": "4159774a-fb09-4125-903e-9df125556245",
      "name": "Formatear Respuesta Pedido"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR PRODUCTOS (detección fuzzy + parser de correcciones con filtrado por tokens)\n\nconst httpResult = $json.result; // de HTTP Buscar Productos FIXED\nconst datosBusqueda = $('Preparar Búsqueda Productos').item?.json || {};\nconst productosSolicitados = Array.isArray(datosBusqueda.productos_solicitados) ? datosBusqueda.productos_solicitados : [];\nconst chatId = datosBusqueda.chat_id || $('Router de Acciones FIXED').item?.json?.chat_id;\nconst uid = datosBusqueda.uid || $('Autenticar Odoo').item?.json?.result;\nconst clienteId = datosBusqueda.cliente_id ?? $('Procesar Cliente Encontrado').item?.json?.cliente_id ?? null;\nconst clienteDatos = datosBusqueda.cliente_datos || $('Procesar Cliente Encontrado').item?.json?.cliente_datos || {};\nconst clienteNombre = clienteDatos?.name || datosBusqueda.cliente_nombre || '';\n\n// ================== 0) Parser de correcciones (nombre x cantidad) ==================\nconst mensaje = (\n  $('Router de Acciones FIXED').item?.json?.mensaje_original ||\n  $('Router de Acciones FIXED').item?.json?.text ||\n  $('Switch Acciones').item?.json?.mensaje_original ||\n  $json.mensaje || $json.text || ''\n).toString();\n\nfunction parseCorrecciones(texto) {\n  const partes = texto.split(/[,;\\n]+/);\n  const res = [];\n  for (const p of partes) {\n    const t = p.trim();\n    if (!t) continue;\n    const m = t.match(/(.+?)\\s*x\\s*([\\d]+(?:[.,]\\d+)?)/i);\n    if (m) {\n      const nombre = m[1].trim();\n      const cantidad = parseFloat(m[2].replace(',', '.'));\n      if (nombre && !Number.isNaN(cantidad)) res.push({ nombre, cantidad });\n    }\n  }\n  return res;\n}\n\nconst productosCorregidos = parseCorrecciones(mensaje);\nif (productosCorregidos.length > 0) {\n  return {\n    correcciones_recibidas: true,\n    productos_corregidos: productosCorregidos,\n    chat_id: chatId,\n    uid,\n    cliente_id: clienteId,\n    cliente: clienteNombre\n  };\n}\n\n// ================== 1) Detección inicial + fuzzy ==================\nconst pool = Array.isArray(httpResult) ? httpResult : [];\n\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\nconst normalize = (s) =>\n  (s || '')\n    .toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .replace(/\\s+/g,' ')\n    .toLowerCase()\n    .trim();\n\nfunction tokenVariants(tok) {\n  const out = new Set([tok]);\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s'))  out.add(tok.slice(0, -1));\n  const m = tok.match(/^(\\d+(?:\\.\\d+)?)(kg|g|mg|l|ml|cm|mm|m|u|uds?)$/);\n  if (m) { out.add(m[1]); out.add(m[2]); }\n  return [...out];\n}\n\nfunction tokens(s) {\n  const base = normalize(s);\n  if (!base) return [];\n  const raw = base.split(/[ \\-_/]+/).filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) for (const v of tokenVariants(tk)) if (v.length >= 2 || /^\\d+(?:\\.\\d+)?$/.test(v)) uniq.add(v);\n  return [...uniq];\n}\n\nfunction levenshtein(a, b) {\n  a = normalize(a); b = normalize(b);\n  const m = a.length, n = b.length;\n  if (m === 0) return n;\n  if (n === 0) return m;\n  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));\n  for (let i = 0; i <= m; i++) dp[i][0] = i;\n  for (let j = 0; j <= n; j++) dp[0][j] = j;\n  for (let i = 1; i <= m; i++) {\n    for (let j = 1; j <= n; j++) {\n      const cost = a[i - 1] === b[j - 1] ? 0 : 1;\n      dp[i][j] = Math.min(\n        dp[i - 1][j] + 1,\n        dp[i][j - 1] + 1,\n        dp[i - 1][j - 1] + cost\n      );\n    }\n  }\n  return dp[m][n];\n}\n\nfunction jaccardToken(a, b) {\n  const A = new Set(tokens(a));\n  const B = new Set(tokens(b));\n  const inter = [...A].filter(x => B.has(x)).length;\n  const uni = new Set([...A, ...B]).size;\n  return uni === 0 ? 0 : inter / uni;\n}\n\nfunction similarity(a, b) {\n  const la = normalize(a), lb = normalize(b);\n  if (!la || !lb) return 0;\n  if (la === lb) return 1;\n  const maxLen = Math.max(la.length, lb.length);\n  const ld = levenshtein(la, lb);\n  const levScore = 1 - (ld / Math.max(1, maxLen));\n  const jac = jaccardToken(a, b);\n  return (levScore * 0.7) + (jac * 0.3);\n}\n\n// Umbrales\nconst THRESHOLD_HIGH = 0.88;    // aceptar automáticamente\nconst MIN_SUGGESTION = 0.35;    // descartar ruido de muy baja similitud\n\nconst byName = new Map(pool.map(p => [normalize(p.name), p]));\nconst lineasPreconfirmadas = [];\nconst productosAmbiguos = [];\nconst productosNoEncontrados = [];\n\nfor (const sol of productosSolicitados) {\n  const nombreSolicitado = (sol?.nombre || '').toString();\n  const cant = Number(sol?.cantidad || 1);\n  if (!nombreSolicitado) continue;\n\n  const qNorm = normalize(nombreSolicitado);\n  const qTokens = new Set(tokens(nombreSolicitado));\n\n  // 1) Exacto por nombre normalizado\n  if (byName.has(qNorm)) {\n    const p = byName.get(qNorm);\n    lineasPreconfirmadas.push({\n      product_id: p.id,\n      product_uom_qty: cant,\n      price_unit: p.list_price,\n      name: p.name\n    });\n    continue;\n  }\n\n  // 2) Prefiltro: solo candidatos que compartan tokens con la consulta\n  const candidates = [];\n  for (const p of pool) {\n    const cName = p.name || '';\n    const cTokens = new Set(tokens(cName));\n    const overlap = [...qTokens].some(t => cTokens.has(t));  // ¿comparte algún token?\n    const score = similarity(nombreSolicitado, cName);\n\n    // Mantén candidatos si comparten token o tienen un mínimo de similitud\n    if (overlap || score >= MIN_SUGGESTION) {\n      candidates.push({\n        id: p.id,\n        name: cName,\n        price: p.list_price,\n        score\n      });\n    }\n  }\n\n  // Ordenar por puntuación\n  candidates.sort((a, b) => b.score - a.score);\n\n  const best = candidates[0];\n  const top = candidates.slice(0, 7); // sugerencias por ESTE producto\n\n  if (best && best.score >= THRESHOLD_HIGH) {\n    lineasPreconfirmadas.push({\n      product_id: best.id,\n      product_uom_qty: cant,\n      price_unit: best.price,\n      name: best.name\n    });\n  } else if (top.length > 0) {\n    productosAmbiguos.push({\n      solicitado: nombreSolicitado,\n      cantidad: cant,\n      candidatos: top.map(x => ({ id: x.id, name: x.name, price: x.price, score: Number(x.score.toFixed(2)) }))\n    });\n  } else {\n    productosNoEncontrados.push(nombreSolicitado);\n    productosAmbiguos.push({ solicitado: nombreSolicitado, cantidad: cant, candidatos: [] });\n  }\n}\n\n// 3) Si hay ambigüedad → mensaje por producto con SUS sugerencias\nif (productosAmbiguos.length > 0) {\n  const instrucciones = [\n    '🔎 Algunos productos necesitan corrección.',\n    '',\n    'Envía **TODAS** las correcciones en **un solo** mensaje con el formato:',\n    '`Nombre correcto x cantidad`, separados por comas.',\n    ''\n  ];\n  for (const amb of productosAmbiguos) {\n    const sug = amb.candidatos.length\n      ? amb.candidatos.map((c,i) => `${i+1}. ${c.name}`).join('\\n')\n      : '— Sin sugerencias —';\n    instrucciones.push(`• **${amb.solicitado}** x ${amb.cantidad}`);\n    instrucciones.push(`  Sugerencias:\\n${sug}`);\n    instrucciones.push('');\n  }\n  instrucciones.push(\"Ej.: `Tarta de queso x 2, Galletas con caramelo x 1, Saco de azucar 10kg x 5`\");\n\n  return {\n    requiere_correccion: true,\n    texto_correccion: instrucciones.join('\\n'),\n    productos_ambiguos: productosAmbiguos,\n    productos_solicitados: productosSolicitados,\n    lineas_preconfirmadas: lineasPreconfirmadas,\n    productos_no_encontrados: productosNoEncontrados,\n    chat_id: chatId,\n    uid,\n    cliente_id: clienteId,\n    cliente_datos: clienteDatos\n  };\n}\n\n// 4) Sin ambigüedad → seguir flujo normal\nreturn {\n  requiere_correccion: false,\n  productos_solicitados: productosSolicitados,\n  lineas_preconfirmadas: lineasPreconfirmadas,\n  productos_no_encontrados: productosNoEncontrados,\n  chat_id: chatId,\n  uid,\n  cliente_id: clienteId,\n  cliente_datos: clienteDatos\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -592,
        11040
      ],
      "id": "49cea2d8-7880-403f-b369-95d01250fb30",
      "name": "Preparar Productos"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "28926475-a68f-4409-a7c1-21b68234cd3f",
              "leftValue": "={{ $json.correcciones_recibidas === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -432,
        10944
      ],
      "id": "469ebf2b-c3e0-4e46-b16c-7422d2a68ed9",
      "name": "¿Correcciones Recibidas?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT datos_pendientes\nFROM n8n\nWHERE esperando_confirmacion = 'corregir_pedido_venta'\n  AND chat_id = ANY($1::bigint[])\nORDER BY created_at DESC\nLIMIT 1;\n",
        "options": {
          "queryReplacement": "=={{ [ $('Normalizar Memoria').item.json.chat_id_list ] }}\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -112,
        10800
      ],
      "id": "49ffd3eb-c621-4e2c-9a1b-669aa0d43799",
      "name": "Leer Memoria Corrección Pedido"
    },
    {
      "parameters": {
        "jsCode": "// Fusionar: originales válidos + preconfirmados + correcciones del usuario\n\n// 1) Cargar y parsear la memoria de forma robusta\nlet row = $('Leer Memoria Corrección Pedido').item?.json;\nlet datos = {};\nif (row) {\n  // Puede venir como { datos_pendientes: { ... } } o como string JSON\n  let dp = row.datos_pendientes ?? row[0]?.datos_pendientes ?? {};\n  if (typeof dp === 'string') {\n    try { datos = JSON.parse(dp); } catch { datos = {}; }\n  } else {\n    datos = dp || {};\n  }\n}\n\nconst corregidos = $('Preparar Productos').item?.json?.productos_corregidos || [];\nconst originales = Array.isArray(datos.productos_originales) ? datos.productos_originales : [];\nconst ambiguos   = Array.isArray(datos.productos_ambiguos)   ? datos.productos_ambiguos   : [];\nconst preOk      = Array.isArray(datos.lineas_preconfirmadas)? datos.lineas_preconfirmadas: [];\n\n// 2) Normalizadores y sets de ayuda\nconst norm = s => (s||'').toString()\n  .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n  .toLowerCase().replace(/\\s+/g,' ').trim();\n\nconst ambiguoSet = new Set(ambiguos.map(a => norm(a.solicitado)));\n\n// 3) Pasar preconfirmadas a formato {nombre, cantidad}\nconst preOkSolicitados = preOk.map(l => ({\n  nombre: l.name,\n  cantidad: Number(l.product_uom_qty || 0) || 0,\n}));\n\nconst preOkSet = new Set(preOkSolicitados.map(p => norm(p.nombre)));\n\n// 4) Filtrar originales válidos (los que NO eran ambiguos) y que no estén ya como preconfirmados\nconst originalesValidos = originales\n  .filter(p => !ambiguoSet.has(norm(p.nombre)))\n  .filter(p => !preOkSet.has(norm(p.nombre)));\n\n// 5) Construir mapa final (dedup por nombre normalizado)\nconst resultMap = new Map();\n\n// primero los preconfirmados (prioridad alta)\nfor (const p of preOkSolicitados) {\n  const k = norm(p.nombre);\n  resultMap.set(k, { nombre: p.nombre, cantidad: Number(p.cantidad || 0) || 0 });\n}\n\n// luego originales válidos (solo si no existen; si existen, suma)\nfor (const p of originalesValidos) {\n  const k = norm(p.nombre);\n  const qty = Number(p.cantidad || 0) || 0;\n  if (!resultMap.has(k)) {\n    resultMap.set(k, { nombre: p.nombre, cantidad: qty });\n  } else {\n    const cur = resultMap.get(k);\n    cur.cantidad = Number(cur.cantidad || 0) + qty;\n    resultMap.set(k, cur);\n  }\n}\n\n// por último, las correcciones del usuario (sustituyen a ambiguos; si coincide nombre, suma)\nfor (const p of corregidos) {\n  const k = norm(p.nombre);\n  const qty = Number(p.cantidad || 0) || 0;\n  if (!resultMap.has(k)) {\n    resultMap.set(k, { nombre: p.nombre, cantidad: qty });\n  } else {\n    const cur = resultMap.get(k);\n    cur.cantidad = Number(cur.cantidad || 0) + qty;\n    // Conservamos el nombre “más reciente” (el de la corrección, normalmente el bueno)\n    cur.nombre = p.nombre || cur.nombre;\n    resultMap.set(k, cur);\n  }\n}\n\n// 6) Array final de productos sin duplicados\nconst productosFinales = Array.from(resultMap.values())\n  .filter(p => p && p.nombre && (Number(p.cantidad) || 0) > 0);\n\n// 7) Normalizar chat_id para SQL (lista y escalar)\nconst chat_id_raw = $('Preparar Productos').item?.json?.chat_id\n  ?? $('Router de Acciones FIXED').item?.json?.chat_id;\n\nconst arr = Array.isArray(chat_id_raw) ? chat_id_raw : [ chat_id_raw ];\nconst chat_id_list = arr.map(v => parseInt(v, 10)).filter(Number.isFinite);\nconst chat_id_scalar = chat_id_list[0] || 0;\n\nconst uid = $('Preparar Productos').item?.json?.uid;\n\nreturn {\n  productos: productosFinales,                   // <- Esto incluirá “galletas con chocolate” (bien escrita)\n  cliente_id: datos.cliente_id || null,\n  cliente_encontrado: true,\n  cliente_datos: { name: datos.cliente || '' },\n  cliente_nombre: datos.cliente || '',\n  chat_id: chat_id_raw,\n  chat_id_list,\n  chat_id_scalar,\n  uid,\n  fusion_hecha: true\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        10800
      ],
      "id": "5ce84ad6-cdc8-4637-8b6f-9d9d2b3fe126",
      "name": "Fusionar Correcciones con Original"
    },
    {
      "parameters": {
        "jsCode": "// Lee el chat_id desde \"Preparar Productos\" y devuélvelo siempre como array de BIGINT\nconst raw = $('Preparar Productos').item.json.chat_id;\nconst arr = Array.isArray(raw) ? raw : [ raw ];\nconst list = arr\n  .map(v => parseInt(v, 10))\n  .filter(v => Number.isFinite(v));\n\nreturn {\n  chat_id_list: list,              // p.ej. [6428316696]\n  chat_id_scalar: list[0] || 0     // p.ej. 6428316696\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -288,
        10800
      ],
      "id": "0b0047f9-c63b-49ed-9039-4348ed41a001",
      "name": "Normalizar Memoria"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        400,
        10800
      ],
      "id": "e4ca6e7d-0e02-469d-a349-d2fcfed51a84",
      "name": "HTTP Buscar Productos FIXED1"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR BÚSQUEDA PRODUCTOS (tokens + default_code + AND sale_ok)\n// Objetivo: conseguir un pool amplio y relevante para que el fuzzy sugiera\n// \"hamburguesa con queso\" y \"azucar 10 kg\", etc.\n\nconst datos = $json;\nconst uid = datos.uid;\nconst productos = Array.isArray(datos.productos) ? datos.productos : [];\n\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\nconst normalize = (s) =>\n  (s || '')\n    .toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .toLowerCase()\n    .replace(/[^a-z0-9%\\. ]+/g,' ')\n    .replace(/\\s+/g,' ')\n    .trim();\n\n// genera variantes útiles: singular/plural básico y número+unidad\nfunction variants(tok) {\n  const out = new Set([tok]);\n  // singularización sencilla\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s'))  out.add(tok.slice(0, -1));\n\n  // número+unidad: 5kg -> 5 , kg , 5kg\n  const m = tok.match(/^(\\d+(?:\\.\\d+)?)(kg|g|mg|l|ml|cm|mm|m|u|uds?)$/);\n  if (m) { out.add(m[1]); out.add(m[2]); }\n\n  return [...out];\n}\n\nfunction tokens(nombre) {\n  const base = normalize(nombre);\n  if (!base) return [];\n  const raw = base.split(' ').filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) for (const v of variants(tk)) if (v.length >= 2) uniq.add(v);\n  return [...uniq];\n}\n\n// 1) Construir hojas (leaves) para OR global: name ilike tk  OR  default_code ilike tk\nlet leaves = [];\nfor (const p of productos) {\n  if (!p || typeof p.nombre !== 'string') continue;\n  const tks = tokens(p.nombre);\n  for (const tk of tks) {\n    leaves.push(['name', 'ilike', tk]);\n    leaves.push(['default_code', 'ilike', tk]);\n  }\n}\n\n// deduplicar leaves\nconst seen = new Set();\nleaves = leaves.filter(l => {\n  const k = JSON.stringify(l);\n  if (seen.has(k)) return false;\n  seen.add(k);\n  return true;\n});\n\n// --- construir dominio correcto (plano) ---\n\nlet domain;\n\nif (leaves.length === 0) {\n  // sin términos -> dominio imposible (evita resultados)\n  domain = [['id', '=', -1]];\n} else {\n  // OR de todas las hojas:  [ '|', '|', ..., hoja1, hoja2, ..., hojaN ]\n  const orTokens = (leaves.length === 1)\n    ? [leaves[0]]\n    : [...Array(leaves.length - 1).fill('|'), ...leaves];\n\n  // AND con sale_ok:  ['&', ['sale_ok','=',true],  ...orTokens ]\n  domain = ['&', ['sale_ok', '=', true], ...orTokens];\n}\n\nconsole.log('🔍 Dominio construido (plano):', JSON.stringify(domain));\n\n\n// 2) Payload a Odoo\nconst payloadId = Math.floor(Math.random() * 1e6);\nconst jsonRpcPayload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'product.product',\n      'search_read',\n      [domain],\n      {\n        fields: ['id', 'name', 'list_price', 'uom_id', 'default_code'],\n        limit: 300  // un poco más amplio para que el fuzzy tenga material\n      }\n    ]\n  },\n  id: payloadId\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  productos_solicitados: productos,\n  cliente_id: datos.cliente_id,\n  cliente_encontrado: datos.cliente_encontrado,\n  cliente_datos: datos.cliente_datos,\n  cliente_nombre: datos.cliente_nombre,\n  productos: datos.productos,\n  chat_id: datos.chat_id,\n  uid: datos.uid,\n  datos_originales: datos.datos_originales\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        240,
        10800
      ],
      "id": "00407c13-4ab5-4198-93d4-92c874802c23",
      "name": "Volver A Búsqueda Productos"
    },
    {
      "parameters": {
        "content": "## Trasncriptor de audio a texto\n",
        "width": 1900,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -11536,
        4400
      ],
      "typeVersion": 1,
      "id": "9004baf5-f9cd-4341-b0df-e3828ee6ef67",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// Combinar datos de transcripción para que lleguen correctamente al AI Agent\nconst datosTranscripcion = $('Procesar Transcripción').item.json;\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('🔄 Combinando datos para AI Agent:');\nconsole.log('📄 Datos originales:', JSON.stringify(datosOriginales, null, 2));\nconsole.log('🎤 Datos transcripción:', JSON.stringify(datosTranscripcion, null, 2));\n\n// Usar los datos de transcripción que ya tienen el mensaje_usuario actualizado\nconst datosFinales = {\n  ...datosTranscripcion,\n  // Asegurar que tenemos todos los campos necesarios\n  chat_id: datosTranscripcion.chat_id || datosOriginales.chat_id,\n  user_id: datosTranscripcion.user_id || datosOriginales.user_id,\n  user_name: datosTranscripcion.user_name || datosOriginales.user_name,\n  timestamp: datosTranscripcion.timestamp || datosOriginales.timestamp,\n  es_audio: true,\n  audio_transcrito: true,\n  file_id: datosTranscripcion.file_id || datosOriginales.file_id\n};\n\nconsole.log('✅ Datos finales para AI Agent:', JSON.stringify(datosFinales, null, 2));\nconsole.log('💬 Mensaje que recibirá AI Agent:', datosFinales.mensaje_usuario);\n\nreturn datosFinales;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9568,
        4464
      ],
      "id": "d01c53a1-8426-4435-9d03-b86a782229bc",
      "name": "Actualizar Datos Transcripción"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=🎤 **Audio transcrito exitosamente:**\n\n\"{{ $json.transcripcion_original }}\"\n\n✅ Procesando tu solicitud...",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -9744,
        4464
      ],
      "id": "0fdcf8b4-19c6-4ceb-9fce-295887667b5d",
      "name": "Confirmar Transcripción",
      "webhookId": "237a0319-b9b0-4c5f-8561-1aef1c7c9116"
    },
    {
      "parameters": {
        "jsCode": "// Procesar transcripción de AssemblyAI y combinar con datos originales\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('📄 Respuesta completa de AssemblyAI:', JSON.stringify($json, null, 2));\n\n// AssemblyAI devuelve la transcripción en el campo 'text'\nlet transcripcion = '';\n\n// Verificar si el proceso se completó exitosamente\nif ($json.status === 'completed' && $json.text) {\n  transcripcion = $json.text;\n} else if ($json.status === 'error') {\n  transcripcion = '[Error en transcripción: ' + ($json.error || 'Error desconocido') + ']';\n  console.error('❌ Error en AssemblyAI:', $json.error);\n} else if ($json.status === 'processing') {\n  transcripcion = '[Transcripción aún en proceso, espera un momento más]';\n  console.log('⏳ AssemblyAI aún está procesando');\n} else if ($json.status === 'queued') {\n  transcripcion = '[Transcripción en cola, espera un momento]';\n  console.log('⏳ AssemblyAI en cola');\n} else {\n  // Fallback: intentar obtener texto de otras posibles ubicaciones\n  transcripcion = $json.text || $json.transcript || '[Error: no se pudo obtener transcripción]';\n}\n\n// Limpiar la transcripción\ntranscripcion = String(transcripcion).trim();\n\nif (!transcripcion || transcripcion === '' || transcripcion === 'undefined') {\n  transcripcion = '[Error: transcripción vacía]';\n  console.error('❌ Error: No se pudo obtener transcripción válida');\n  console.error('📄 Estado:', $json.status);\n  console.error('📄 Datos recibidos:', JSON.stringify($json, null, 2));\n}\n\nconsole.log('🎤 Transcripción obtenida de AssemblyAI (ES):', transcripcion);\nconsole.log('📊 Estado AssemblyAI:', $json.status);\nconsole.log('🌍 Idioma detectado:', $json.language_code);\nconsole.log('🎯 Confianza:', $json.confidence);\n\n// 🔤 NUEVO: generar una versión normalizada SIN tildes para la lógica del agente\nconst transcripcionNormalizada = transcripcion\n  .normalize('NFD')                  // separa letra + tilde\n  .replace(/[\\u0300-\\u036f]/g, '')   // elimina marcas diacríticas\n  .replace(/´/g, '')                 // elimina acentos sueltos\n  .toLowerCase();                    // minúsculas para comparar mejor\n\nconsole.log('🎤 Transcripción normalizada (sin tildes):', transcripcionNormalizada);\n\n// Actualizar el mensaje usuario con la transcripción\nreturn {\n  ...datosOriginales,\n\n  // 👇 Lo que verá el AGENTE (sin tildes, minúsculas)\n  mensaje_usuario: transcripcionNormalizada,\n\n  // 👇 Lo que verás tú en Telegram (con tildes, intacto)\n  transcripcion_original: transcripcion,\n  mensaje_usuario_original: transcripcion,\n\n  es_audio: true,\n  audio_transcrito: true,\n  assemblyai_response: $json,\n  transcriptor: 'assemblyai',\n  estado_transcripcion: $json.status,\n  confidence: $json.confidence,\n  audio_duration: $json.audio_duration\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9936,
        4464
      ],
      "id": "b89b3bcd-5ba9-4ce8-a108-d6912c6454da",
      "name": "Procesar Transcripción"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -10848,
        4464
      ],
      "id": "eafa4d95-0073-4c65-94f3-0658b48bc280",
      "name": "Descargar Audio",
      "webhookId": "1f9d320a-2e58-48ab-bf94-f02ee44a09d2"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos del archivo de voz para descarga via Telegram\nconst datosArchivo = $json;\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('📄 Datos del archivo obtenidos:', JSON.stringify(datosArchivo, null, 2));\nconsole.log('📄 Datos originales:', JSON.stringify(datosOriginales, null, 2));\n\n// Obtener file_id desde los datos originales (es lo que necesita el nodo Telegram)\nlet fileId = datosOriginales.file_id;\n\n// También intentar obtener file_path si está disponible para referencia\nlet filePath = null;\nif (datosArchivo.file_path) {\n  filePath = datosArchivo.file_path;\n} else if (datosArchivo.result && datosArchivo.result.file_path) {\n  filePath = datosArchivo.result.file_path;\n} else if (datosArchivo.body && datosArchivo.body.result && datosArchivo.body.result.file_path) {\n  filePath = datosArchivo.body.result.file_path;\n}\n\nif (!fileId) {\n  console.error('❌ No se encontró file_id. Estructura completa:', JSON.stringify(datosArchivo, null, 2));\n  throw new Error('No se obtuvo file_id del archivo de voz. Revisa la estructura de datos en los logs.');\n}\n\nconsole.log('✅ file_id obtenido:', fileId);\nif (filePath) {\n  console.log('📁 file_path obtenido:', filePath);\n}\n\n// Usar file_id que es lo que requiere el nodo Telegram\nreturn {\n  ...datosArchivo,\n  ...datosOriginales,\n  file_id: fileId,\n  file_path: filePath,\n  voice_file_ready: true,\n  processing_method: 'telegram_file_id',\n  // Información para debug\n  download_info: {\n    file_id: fileId,\n    file_path: filePath,\n    method: 'telegram_get_file'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11056,
        4464
      ],
      "id": "7ba86cee-8d6a-415d-9d25-67747589c607",
      "name": "Preparar Descarga"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -11296,
        4464
      ],
      "id": "26fc8d04-0d7d-4b55-a030-926160ac9957",
      "name": "Obtener Archivo de Voz",
      "webhookId": "7f3270c4-aed6-4c93-8195-10f4a570cb3b"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.es_audio }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -10704,
        3776
      ],
      "id": "ecfa847e-0c99-4d1d-9e87-ce1fdfa97081",
      "name": "¿Es Audio?"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS PARA VERIFICACIÓN DE BD\nconst datosUsuario = $json;\nconst mensajeUsuario = (datosUsuario.mensaje_usuario || '').toLowerCase().trim();\nconst chatId = datosUsuario.chat_id;\n\nconsole.log('🔍 === PREPARAR VERIFICACIÓN BD ===');\nconsole.log('📝 Mensaje usuario:', mensajeUsuario);\nconsole.log('💬 Chat ID:', chatId);\n\n// Simplemente pasar los datos para consultar la BD\nreturn {\n  ...datosUsuario\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6960,
        3632
      ],
      "id": "d5db1f08-df88-4a09-8217-b8fbdddb99bc",
      "name": "Preparar Verificación BD"
    },
    {
      "parameters": {
        "jsCode": "// OBTENER CHAT_ID DEL USUARIO\nconst uid = $json.result;\n\n// Función para obtener datos de nodos anteriores con manejo de errores\nfunction obtenerDatosSeguro(nombreNodo) {\n  try {\n    return $(nombreNodo).item.json;\n  } catch (e) {\n    console.log(`⚠️ Nodo \"${nombreNodo}\" no disponible:`, e.message);\n    return null;\n  }\n}\n\n// Intentar obtener datos del usuario desde diferentes fuentes\nlet datosUsuario = null;\n\n// Primero intentar desde \"Actualizar Datos Transcripción\" (para audio)\ndatosUsuario = obtenerDatosSeguro('Actualizar Datos Transcripción');\n\n// Si no existe, intentar desde \"Extraer Datos\" (para texto)\nif (!datosUsuario) {\n  datosUsuario = obtenerDatosSeguro('Extraer Datos');\n}\n\n// Si aún no tenemos datos, usar valores por defecto\nif (!datosUsuario) {\n  console.error('❌ GRAVE: No se encontraron datos del usuario en ningún nodo');\n  datosUsuario = {\n    mensaje_usuario: 'ERROR: No se encontró mensaje del usuario',\n    chat_id: 'unknown',\n    user_id: 'unknown',\n    user_name: 'Usuario',\n    odoo_user: 'User',\n    es_audio: false\n  };\n}\n\nconsole.log('🔍 OBTENER CHAT ID - Datos obtenidos:', {\n  mensaje_usuario: datosUsuario.mensaje_usuario,\n  chat_id: datosUsuario.chat_id,\n  user_name: datosUsuario.user_name,\n  odoo_user: datosUsuario.odoo_user,\n  \n});\n\nreturn {\n  ...datosUsuario,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7232,
        3632
      ],
      "id": "34fac73c-2954-4876-970d-4e9ba670ce75",
      "name": "Obtener Chat ID"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT COUNT(*) as total_mensajes FROM n8n WHERE chat_id = $1",
        "options": {
          "queryReplacement": "={{ [$json.chat_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -6736,
        3632
      ],
      "id": "fa4f43a0-84c2-401d-af94-70da09129e08",
      "name": "Verificar Historial Usuario"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "leftValue": "={{ parseInt($json.total_mensajes) }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              },
              "id": "af90a793-a413-4a98-8e3b-7d0d6527bed6"
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -6512,
        3632
      ],
      "id": "d1ba494a-7d86-49ce-8349-324d15117f8c",
      "name": "IF Tiene Historial"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT ultimo_mensaje_bot, esperando_confirmacion FROM n8n WHERE chat_id = $1 ORDER BY created_at DESC LIMIT 1",
        "options": {
          "queryReplacement": "={{ $('Preparar Verificación BD').item.json.chat_id }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -6144,
        3360
      ],
      "id": "ccda7b1c-3a49-4632-a884-dfc0d75c4970",
      "name": "Verificar Último Mensaje Bot"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS PARA IF - VERIFICAR SI DEBE ACCEDER A MEMORIA\nconst datosUsuario = $('Preparar Verificación BD').item.json;\nconst consultaDB = $json; // $json viene directamente del nodo 'Verificar Último Mensaje Bot'\n\nconsole.log('🔍 === PREPARAR DATOS PARA IF ===');\nconsole.log('📋 Datos usuario:', datosUsuario);\nconsole.log('🗄️ Consulta DB (directa):', consultaDB);\nconsole.log('🗄️ Estructura consultaDB:', JSON.stringify(consultaDB, null, 2));\n\n// Extraer información de la BD - CORREGIDO: acceder directamente a los campos\nlet ultimoMensajeBot = null;\nlet esperandoConfirmacion = null;\n\n// Los datos vienen directamente del nodo PostgreSQL, no como array\nif (consultaDB) {\n  ultimoMensajeBot = consultaDB.ultimo_mensaje_bot;\n  esperandoConfirmacion = consultaDB.esperando_confirmacion;\n}\n\nconsole.log('🤖 Último mensaje bot:', ultimoMensajeBot);\nconsole.log('⏳ Esperando confirmación:', esperandoConfirmacion);\n\n// LÓGICA CORREGIDA: Si es 'Respuesta procesada' → FALSE (no acceder a memoria)\n// Si es cualquier otro mensaje → TRUE (acceder a memoria)\nconst debeAccederMemoria = (ultimoMensajeBot !== 'Respuesta procesada' && ultimoMensajeBot !== null);\n\nconsole.log('🎯 Lógica de decisión:');\nconsole.log('   - Último mensaje bot:', ultimoMensajeBot);\nconsole.log('   - Es \"Respuesta procesada\"?:', ultimoMensajeBot === 'Respuesta procesada');\nconsole.log('   - Es null?:', ultimoMensajeBot === null);\nconsole.log('   - Debe acceder a memoria?:', debeAccederMemoria);\n\n// Combinar toda la información para el IF\nconst datosCompletos = {\n  ...datosUsuario,\n  ultimo_mensaje_bot: ultimoMensajeBot,\n  esperando_confirmacion: esperandoConfirmacion,\n  debe_acceder_memoria: debeAccederMemoria\n};\n\nconsole.log('📤 Datos completos preparados para IF');\nconsole.log('   - debe_acceder_memoria:', datosCompletos.debe_acceder_memoria);\nconsole.log('   - Ruta que seguirá:', debeAccederMemoria ? 'TRUE (acceder memoria)' : 'FALSE (no acceder memoria)');\n\nreturn datosCompletos;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5952,
        3360
      ],
      "id": "7a2e2b95-e673-4a98-9964-5aeb078385b5",
      "name": "Preparar Datos para IF"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, created_at FROM n8n WHERE chat_id = $1 AND esperando_confirmacion IS NOT NULL AND esperando_confirmacion != '' ORDER BY created_at DESC LIMIT 1",
        "options": {
          "queryReplacement": "={{ [$('Obtener Chat ID').item.json.chat_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -5456,
        3216
      ],
      "id": "d10cd8a8-4c0f-4155-91fb-628665a04f53",
      "name": "Consultar Memoria PostgreSQL"
    },
    {
      "parameters": {
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -7440,
        3632
      ],
      "id": "bdd4025c-f9f6-42b8-9fe3-8512074fc39c",
      "name": "Autenticar Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Extraer información básica del mensaje de Telegram con soporte completo para fotos\nlet mensaje = '';\nlet esAudio = false;\nlet tieneImagen = false;\nlet fileId = null;\nlet imagenFileId = null;\nlet imgData = null;\nconst chatId = $json.message.chat.id;\nconst userId = $json.message.from.id;\nconst userName = $json.message.from.first_name || 'Usuario';\n\nconsole.log('📱 === EXTRAER DATOS TELEGRAM ===');\nconsole.log('📥 Mensaje completo:', JSON.stringify($json.message, null, 2));\n\n// Detectar si es un mensaje de texto\nif ($json.message.text) {\n  mensaje = $json.message.text;\n  console.log('📝 Mensaje de texto:', mensaje);\n} \n// Detectar si es un mensaje de voz\nelse if ($json.message.voice) {\n  esAudio = true;\n  fileId = $json.message.voice.file_id;\n  mensaje = '[Mensaje de voz recibido. Transcribiendo...]';\n  console.log('🎤 Mensaje de voz detectado');\n}\n// Detectar si es una imagen con caption (texto)\nelse if ($json.message.photo && $json.message.caption) {\n  console.log('🔍 DEBUG - Detectado: imagen CON caption');\n  mensaje = $json.message.caption;\n  tieneImagen = true;\n  // Tomar la imagen de mayor resolución (última en el array)\n  const photoData = $json.message.photo[$json.message.photo.length - 1];\n  imagenFileId = photoData.file_id;\n  \n  // NUEVO: Crear objeto img_data completo con toda la info necesaria\n  imgData = {\n    file_id: photoData.file_id,\n    file_unique_id: photoData.file_unique_id,\n    file_size: photoData.file_size,\n    width: photoData.width,\n    height: photoData.height,\n    all_sizes: $json.message.photo, // Todas las resoluciones disponibles\n    caption: $json.message.caption,\n    message_id: $json.message.message_id,\n    timestamp: new Date().toISOString(),\n    from_chat_id: chatId,\n    from_user_id: userId\n  };\n  \n  console.log('📸 Imagen con texto detectada:', mensaje);\n  console.log('🖼️ File ID imagen:', imagenFileId);\n  console.log('📊 Datos completos imagen:', JSON.stringify(imgData, null, 2));\n}\n// Solo imagen sin texto\nelse if ($json.message.photo) {\n  mensaje = '[Imagen recibida sin texto]';\n  tieneImagen = true;\n  const photoData = $json.message.photo[$json.message.photo.length - 1];\n  imagenFileId = photoData.file_id;\n  \n  // NUEVO: Crear objeto img_data completo\n  imgData = {\n    file_id: photoData.file_id,\n    file_unique_id: photoData.file_unique_id,\n    file_size: photoData.file_size,\n    width: photoData.width,\n    height: photoData.height,\n    all_sizes: $json.message.photo,\n    caption: null,\n    message_id: $json.message.message_id,\n    timestamp: new Date().toISOString(),\n    from_chat_id: chatId,\n    from_user_id: userId\n  };\n  \n  console.log('📸 Solo imagen detectada');\n  console.log('📊 Datos completos imagen:', JSON.stringify(imgData, null, 2));\n}\n// Mensaje vacío o no soportado\nelse {\n  mensaje = '[Mensaje no soportado]';\n  console.log('❌ Tipo de mensaje no soportado');\n}\n\nconst resultado = {\n  mensaje_usuario: mensaje,\n  chat_id: chatId,\n  user_id: userId,\n  user_name: userName,\n  timestamp: new Date().toISOString(),\n  es_audio: esAudio,\n  tiene_imagen: tieneImagen,\n  file_id: fileId,\n  imagen_file_id: imagenFileId,\n  img_data: imgData  // NUEVO CAMPO COMPLETO\n};\n\nconsole.log('✅ Datos extraídos:', JSON.stringify(resultado, null, 2));\nconsole.log('🔍 Campo img_data:', imgData ? 'PRESENTE' : 'NO HAY IMAGEN');\n\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -13264,
        3360
      ],
      "id": "62c05b3b-a3be-444e-a341-00c17fd93cf9",
      "name": "Extraer Datos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.assemblyai.com/v2/upload",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10624,
        4464
      ],
      "id": "f1baac68-16e4-4d78-8095-f457df4e2a39",
      "name": "HTTP Request - Upload Audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.assemblyai.com/v2/transcript",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify({audio_url: $json.upload_url, language_code: 'es', punctuate: true}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10416,
        4464
      ],
      "id": "b95ea5db-5bfc-491c-8f45-54efd4e5ea40",
      "name": "HTTP Request - Create Transcript (ES)"
    },
    {
      "parameters": {
        "url": "=https://api.assemblyai.com/v2/transcript/{{ $json.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10128,
        4464
      ],
      "id": "161aaaa9-de30-423a-9a79-d24bd58173e7",
      "name": "HTTP Request - Get Transcript"
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -10304,
        4464
      ],
      "id": "a3f02ad2-5d29-43fb-8266-6db6f517f9f5",
      "name": "Esperar Transcripción",
      "webhookId": "931d9a97-c65b-4acc-9c80-67d8efa0b7f4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "verificar-acceso-memoria",
              "leftValue": "={{ $json.ultimo_mensaje_bot }}",
              "rightValue": "Respuesta procesada",
              "operator": {
                "type": "string",
                "operation": "notEquals",
                "name": "filter.operator.notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5744,
        3360
      ],
      "id": "544236ef-b09c-4a5a-811e-248719d8ca8c",
      "name": "Acceso a memoria"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 3 * * *"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -11552,
        4800
      ],
      "id": "b91d8446-1ce6-44a5-a4ed-5985aea6ee14",
      "name": "Trigger Resumen Diario 8:00 AM"
    },
    {
      "parameters": {
        "jsCode": "// Preparar resumen diario automático para las 8:00 AM\nconst hoy = new Date();\nconst fechaHoy = hoy.toISOString().split('T')[0];\n\nconsole.log('🌅 Iniciando resumen diario automático para:', fechaHoy);\nconsole.log('👥 Consultando usuarios registrados para envío masivo...');\n\n// Preparar consulta para obtener todos los usuarios activos registrados\nconst queryUsuarios = `\n  SELECT user_id, user_name, chat_id \n  FROM telegram_users \n  WHERE is_active = true \n  ORDER BY last_seen DESC\n`;\n\nreturn {\n  fecha: fechaHoy,\n  tipo_resumen: 'diario_automatico',\n  timestamp: new Date().toISOString(),\n  query_usuarios: queryUsuarios\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11360,
        4800
      ],
      "id": "584ed3b3-5d2a-4b5a-947b-8773c3cef5d8",
      "name": "Preparar Resumen Diario"
    },
    {
      "parameters": {
        "jsCode": "// Verificar si el usuario ya existe antes de registrar\nconst userId = $json.user_id;\nconst userName = $json.user_name;\nconst chatId = $json.chat_id;\n\nconsole.log('🔍 === VERIFICAR EXISTENCIA USUARIO ===');\nconsole.log('🆔 User ID a verificar:', userId);\nconsole.log('👤 User Name:', userName);\nconsole.log('💬 Chat ID:', chatId);\nconsole.log('📋 Datos completos recibidos:', JSON.stringify($json, null, 2));\n\n// Si no tenemos user_id, no podemos verificar - tratar como usuario nuevo\nif (!userId) {\n  console.warn('⚠️ No hay user_id disponible, tratando como usuario nuevo');\n  return {\n    json: {\n      ...arguments[0],\n      usuario_existe: false,\n      verificacion_usuario: {\n        query: null,\n        params: [],\n        usuario_info: {\n          user_id: userId,\n          user_name: userName,\n          chat_id: chatId\n        }\n      }\n    }\n  };\n}\n\n// Preparar consulta para verificar si el usuario existe\n// Usamos COALESCE para siempre devolver al menos una fila\nconst queryVerificar = `\n  SELECT \n    COALESCE(user_id, 0) as user_id,\n    COALESCE(user_name, '') as user_name,\n    COALESCE(chat_id, 0) as chat_id,\n    COALESCE(is_active, false) as is_active,\n    COALESCE(last_seen, NOW()) as last_seen,\n    CASE WHEN user_id IS NOT NULL THEN 1 ELSE 0 END as existe\n  FROM (\n    SELECT user_id, user_name, chat_id, is_active, last_seen\n    FROM telegram_users \n    WHERE user_id = $1\n    UNION ALL\n    SELECT NULL::BIGINT, NULL::VARCHAR, NULL::BIGINT, NULL::BOOLEAN, NULL::TIMESTAMP\n    WHERE NOT EXISTS (SELECT 1 FROM telegram_users WHERE user_id = $1)\n  ) t\n  LIMIT 1\n`;\n\nconsole.log('📋 Query a ejecutar:', queryVerificar);\nconsole.log('🔍 Parámetros:', [userId]);\n\nreturn {\n  json: {\n    ...arguments[0], // Pasar todos los datos originales\n    verificacion_usuario: {\n      query: queryVerificar,\n      params: [userId],\n      usuario_info: {\n        user_id: userId,\n        user_name: userName,\n        chat_id: chatId\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10384,
        3792
      ],
      "id": "94f1a104-b46e-4512-a22e-6dfe2a5721df",
      "name": "Verificar Usuario Existente"
    },
    {
      "parameters": {
        "jsCode": "console.log('🔍 === PROCESAR RESULTADO VERIFICACIÓN ==='); let datosOriginales = {}; try { const nodoVerificar = $('Verificar Usuario Existente').first().json; console.log('📋 Datos desde Verificar Usuario Existente:', JSON.stringify(nodoVerificar, null, 2)); if (nodoVerificar && nodoVerificar.usuario_info) { datosOriginales = { user_id: nodoVerificar.usuario_info.user_id, user_name: nodoVerificar.usuario_info.user_name, chat_id: nodoVerificar.usuario_info.chat_id, timestamp: new Date().toISOString() }; console.log('✅ Datos extraídos de usuario_info:', datosOriginales); } else if (nodoVerificar) { datosOriginales = { user_id: nodoVerificar.user_id, user_name: nodoVerificar.user_name, chat_id: nodoVerificar.chat_id, timestamp: nodoVerificar.timestamp || new Date().toISOString() }; console.log('✅ Datos extraídos directamente:', datosOriginales); } } catch (e) { console.error('❌ Error obteniendo datos originales:', e.message); } if (!datosOriginales.user_id || !datosOriginales.chat_id) { console.warn('⚠️ Datos originales incompletos, intentando obtener desde otros nodos...'); try { const nodos = ['Extraer Datos', 'Actualizar Datos Transcripción']; for (const nombreNodo of nodos) { try { const nodo = $(nombreNodo).first().json; if (nodo && nodo.user_id && nodo.chat_id) { datosOriginales = { user_id: nodo.user_id, user_name: nodo.user_name, chat_id: nodo.chat_id, timestamp: nodo.timestamp || new Date().toISOString() }; console.log(`✅ Datos encontrados en ${nombreNodo}:`, datosOriginales); break; } } catch (e2) { console.log(`⚠️ No se pudo obtener datos de ${nombreNodo}`); } } } catch (e3) { console.error('❌ Error buscando en nodos alternativos:', e3.message); } } const resultadoPostgreSQL = $json; console.log('🗃️ Resultado PostgreSQL:', JSON.stringify(resultadoPostgreSQL, null, 2)); let usuarioExiste = false; let datosUsuario = null; let longitudResultado = 0; if (Array.isArray(resultadoPostgreSQL) && resultadoPostgreSQL.length > 0) { const primerResultado = resultadoPostgreSQL[0]; console.log('📊 Analizando resultado array:', primerResultado); const existeCampo = primerResultado.existe === 1 || primerResultado.existe === '1'; const userIdValido = primerResultado.user_id && primerResultado.user_id !== '0' && primerResultado.user_id !== 0; if (existeCampo && userIdValido) { usuarioExiste = true; datosUsuario = primerResultado; longitudResultado = 1; console.log('✅ Usuario EXISTE'); } else { usuarioExiste = false; longitudResultado = 0; console.log('❌ Usuario NO EXISTE'); } } else if (resultadoPostgreSQL && typeof resultadoPostgreSQL === 'object') { console.log('📊 Analizando resultado objeto:', resultadoPostgreSQL); const existeCampo = resultadoPostgreSQL.existe === 1 || resultadoPostgreSQL.existe === '1'; const userIdValido = resultadoPostgreSQL.user_id && resultadoPostgreSQL.user_id !== '0' && resultadoPostgreSQL.user_id !== 0; if (existeCampo && userIdValido) { usuarioExiste = true; datosUsuario = resultadoPostgreSQL; longitudResultado = 1; console.log('✅ Usuario EXISTE (objeto)'); } else { usuarioExiste = false; longitudResultado = 0; console.log('❌ Usuario NO EXISTE (objeto)'); } } else { console.log('❌ Sin resultados válidos'); longitudResultado = 0; } const resultadoFinal = { user_id: datosOriginales.user_id, user_name: datosOriginales.user_name, chat_id: datosOriginales.chat_id, timestamp: datosOriginales.timestamp, usuario_existe: usuarioExiste, datos_usuario_existente: datosUsuario, length: longitudResultado, resultado_original: resultadoPostgreSQL }; console.log('📏 Length final para IF:', longitudResultado); console.log('🔍 Verificando datos finales - user_id:', resultadoFinal.user_id, 'chat_id:', resultadoFinal.chat_id); console.log('📤 Resultado final:', JSON.stringify(resultadoFinal, null, 2)); return { json: resultadoFinal };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10064,
        3792
      ],
      "id": "e84a991b-8673-42ab-ad8f-0f20e1178fb6",
      "name": "Procesar Resultado Verificación"
    },
    {
      "parameters": {
        "jsCode": "// Usuario ya existe - actualizar última actividad sin duplicar\nconst datosOriginales = $('Verificar Usuario Existente').first().json;\nconst usuarioExistente = $json[0] || $json; // Puede venir como array o objeto\n\nconsole.log('✅ === USUARIO YA REGISTRADO ===');\nconsole.log('👤 Usuario existente:', usuarioExistente);\nconsole.log('📋 Datos originales:', datosOriginales);\n\n// Preparar query para actualizar solo el last_seen\nconst queryActualizar = `\n  UPDATE telegram_users \n  SET last_seen = $1, \n      user_name = $2,\n      chat_id = $3,\n      is_active = true\n  WHERE user_id = $4\n`;\n\nconst timestamp = new Date().toISOString();\nconst params = [\n  timestamp,\n  datosOriginales.user_name,\n  datosOriginales.chat_id,\n  datosOriginales.user_id\n];\n\nconsole.log('🔄 Actualizando last_seen del usuario existente');\nconsole.log('📋 Query:', queryActualizar);\nconsole.log('🔍 Params:', params);\n\nreturn {\n  json: {\n    ...datosOriginales, // Pasar datos originales\n    actualizacion_usuario: {\n      query: queryActualizar,\n      params: params,\n      usuario_existente: true,\n      mensaje: `Usuario ${datosOriginales.user_name} ya estaba registrado - actualizando actividad`\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9632,
        3792
      ],
      "id": "d0824aa1-a4b6-4eb9-a7de-28f7695c0f11",
      "name": "Usuario Ya Existe"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.actualizacion_usuario.query }}",
        "options": {
          "queryReplacement": "={{ $json.actualizacion_usuario.params }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -9424,
        3792
      ],
      "id": "e643afc9-7917-47e4-a028-36e145a9ace0",
      "name": "PostgreSQL Actualizar Usuario"
    },
    {
      "parameters": {
        "jsCode": "const datosRecibidos = $json;\n\nconsole.log('👤 === PREPARAR REGISTRO USUARIO ===');\nconsole.log('📋 Datos recibidos completos:', JSON.stringify(datosRecibidos, null, 2));\n\nconst userId = datosRecibidos.user_id;\nconst userName = datosRecibidos.user_name || 'Usuario';\nconst chatId = datosRecibidos.chat_id;\nconst timestamp = datosRecibidos.timestamp || new Date().toISOString();\n\nconsole.log('🔍 Datos extraídos:', { userId, userName, chatId, timestamp });\n\nif (!userId || !chatId) {\n  console.error('❌ Error: user_id o chat_id faltantes');\n  console.error('📋 Datos disponibles:', datosRecibidos);\n  throw new Error(`Datos insuficientes para registrar usuario: user_id=${userId}, chat_id=${chatId}`);\n}\n\n// Inserta por defecto consultas_restantes=5 y usuario_valido=false al crear.\n// En updates NO modifica estos campos (no resetea contadores ni flags).\nconst queryUpsert = `\n  INSERT INTO telegram_users (\n    user_id, user_name, chat_id, first_seen, last_seen, is_active,\n    consultas_restantes, usuario_valido\n  ) VALUES (\n    $1, $2, $3, $4, $5, true,\n    5, false\n  )\n  ON CONFLICT (user_id) DO UPDATE SET\n    user_name = EXCLUDED.user_name,\n    chat_id = EXCLUDED.chat_id,\n    last_seen = EXCLUDED.last_seen,\n    is_active = true\n`;\n\nconst params = [userId, userName, chatId, timestamp, timestamp];\n\nconsole.log('✅ Query preparada correctamente');\nconsole.log('📊 Params:', params);\n\nreturn {\n  json: {\n    ...datosRecibidos,\n    registro_usuario: {\n      query: queryUpsert,\n      params,\n      usuario_info: {\n        user_id: userId,\n        user_name: userName,\n        chat_id: chatId,\n        timestamp\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9488,
        3248
      ],
      "id": "0dc46e92-dfd6-4b1d-8862-355e7feac463",
      "name": "Preparar Registro Usuario"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.registro_usuario.query }}",
        "options": {
          "queryReplacement": "={{ $json.registro_usuario.params }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -9280,
        3248
      ],
      "id": "96b3fadf-ed29-486d-9502-acc51495a2cd",
      "name": "PostgreSQL Registrar Usuario"
    },
    {
      "parameters": {
        "jsCode": "// Continuar con el flujo normal después del registro\n// Eliminar datos internos de registro y continuar\nconst { registro_usuario, ...datosOriginales } = $json;\n\nconsole.log('✅ Usuario registrado correctamente');\n\nreturn { json: datosOriginales };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9216,
        3792
      ],
      "id": "3bf261ad-9889-472a-8bda-056f578b0cbe",
      "name": "Limpiar Datos Registro"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, odoo_user FROM telegram_users WHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ [parseInt($('Procesar Resultado Verificación').item.json.user_id)] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -8352,
        3648
      ],
      "id": "cd8c8434-fa34-4ee9-9e71-8195c15c1edc",
      "name": "Consultar Usuario Telegram"
    },
    {
      "parameters": {
        "chatId": "={{ $('Procesar Resultado Verificación').item.json.chat_id }}",
        "text": "❌ No tienes configurado tu usuario de Odoo.\n\nPor favor, envía tu usuario de Odoo para un correcto funcionamiento:\n\n*Mi usuario de Odoo es: _________*\n\nGracias 🙏",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -7712,
        3856
      ],
      "id": "79f4324c-0c68-4ac9-aa15-5971f18fafed",
      "name": "Mensaje Sin Usuario Odoo",
      "webhookId": "2f96c558-e814-43c3-99be-34048ccca5fa"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\"jsonrpc\": \"2.0\", \"method\": \"call\", \"params\": {\"service\": \"common\", \"method\": \"authenticate\", \"args\": [\"lsanchezgoshawk-n8npruebas-main-25736898\", \"admin\", \"admin\", {}]}, \"id\": 1}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10976,
        4800
      ],
      "id": "4bcde3b4-ac30-45bb-a751-e4e4ae046747",
      "name": "Autenticar Odoo para Resumen"
    },
    {
      "parameters": {
        "jsCode": "// Consultar eventos del calendario para HOY de todos los usuarios\nconst datosPreparacion = $('Preparar Resumen Diario').item.json;\nconst uid = $json.result;\nconst fechaHoy = datosPreparacion.fecha;\n\n// Validar autenticación\nif (!uid) {\n  throw new Error('Error en autenticación de Odoo para resumen diario');\n}\n\nconsole.log('📅 Consultando eventos del día:', fechaHoy);\n\n// Consultar todos los eventos del día (calendar.event)\nconst consultaEventos = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"calendar.event\",\n      \"search_read\",\n      [\n        [\n          [\"start\", \">=\", fechaHoy + \" 00:00:00\"],\n          [\"stop\", \"<=\", fechaHoy + \" 23:59:59\"]\n        ]\n      ],\n      {\n        fields: [\n          \"name\", \"description\", \"start\", \"stop\", \"duration\", \n          \"partner_ids\", \"user_id\", \"location\", \"privacy\", \"show_as\"\n        ],\n        order: \"start asc\"\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultaEventos,\n  fecha: fechaHoy,\n  uid: uid,\n  paso: 'consultar_eventos'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10800,
        4800
      ],
      "id": "8372ee38-3211-4f6c-9138-b2dce7162f57",
      "name": "Preparar Consulta Eventos Diarios"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10592,
        4800
      ],
      "id": "7910f5dd-0ded-402f-94c5-b50190315333",
      "name": "HTTP Consultar Eventos Diarios"
    },
    {
      "parameters": {
        "jsCode": "// Consultar órdenes de venta pendientes de confirmar\nconst eventosRespuesta = $json.result || [];\n\n// Obtener UID de la autenticación (tomar el primer item válido)\nconst autenticacionData = $('Autenticar Odoo para Resumen').all();\nlet uid = null;\nfor (const item of autenticacionData) {\n  if (item.json && item.json.result) {\n    uid = item.json.result;\n    break;\n  }\n}\n\n// Obtener fecha del resumen diario\nconst fechaHoy = $('Preparar Resumen Diario').first().json.fecha;\n\nif (!uid) {\n  throw new Error('Error: UID no disponible para consulta de órdenes pendientes');\n}\n\nconsole.log('📋 Eventos encontrados:', eventosRespuesta.length);\nconsole.log('🛒 Preparando consulta de órdenes pendientes...');\nconsole.log('🔑 UID obtenido:', uid);\nconsole.log('📅 Fecha:', fechaHoy);\n\n// Consultar órdenes de venta en estado 'draft' (pendientes de confirmar)\nconst consultaOrdenesPendientes = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"sale.order\",\n      \"search_read\",\n      [\n        [\n          [\"state\", \"in\", [\"draft\", \"sent\"]]\n        ]\n      ],\n      {\n        fields: [\n          \"name\", \"partner_id\", \"amount_total\", \"date_order\", \n          \"state\", \"validity_date\", \"user_id\"\n        ],\n        order: \"date_order desc\",\n        limit: 20\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: consultaOrdenesPendientes,\n  eventos_del_dia: eventosRespuesta,\n  fecha: fechaHoy,\n  uid: uid,\n  paso: 'consultar_ordenes_pendientes'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10400,
        4800
      ],
      "id": "23528f41-464a-4277-b139-c1a30c94b39e",
      "name": "Preparar Consulta Órdenes Pendientes"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10192,
        4800
      ],
      "id": "66f62981-10a5-4258-8b8e-3808e3d9550f",
      "name": "HTTP Consultar Órdenes Pendientes"
    },
    {
      "parameters": {
        "jsCode": "// Formatear resumen diario completo\nconst ordenesPendientes = $json.result || [];\n\n// Obtener datos usando métodos robustos para manejar múltiples items\nconst eventosData = $('HTTP Consultar Eventos Diarios').all();\nlet eventosDelDia = [];\nfor (const item of eventosData) {\n  if (item.json && item.json.result) {\n    eventosDelDia = item.json.result;\n    break;\n  }\n}\n\n// Obtener fecha del primer item del nodo preparación\nconst fecha = $('Preparar Resumen Diario').first().json.fecha;\n\nconsole.log('📊 Generando resumen diario...');\nconsole.log('   - Eventos:', eventosDelDia.length);\nconsole.log('   - Órdenes pendientes:', ordenesPendientes.length);\n\n// FUNCIÓN PARA CONVERTIR UTC A HORA LOCAL ESPAÑOLA\nconst convertirUTCaHoraLocal = (fechaString) => {\n  if (!fechaString) return '00:00';\n  \n  try {\n    // Crear fecha UTC desde el string de Odoo\n    const fechaUTC = new Date(fechaString + 'Z'); // Agregar Z para forzar UTC\n    \n    // Convertir a hora española (UTC+1 en invierno, UTC+2 en verano)\n    const horaLocal = fechaUTC.toLocaleTimeString('es-ES', {\n      hour: '2-digit',\n      minute: '2-digit',\n      timeZone: 'Europe/Madrid'\n    });\n    \n    console.log(`🕐 Conversión: ${fechaString} (UTC) → ${horaLocal} (Madrid)`);\n    return horaLocal;\n    \n  } catch (error) {\n    console.log('❌ Error convirtiendo hora:', error);\n    return '00:00';\n  }\n};\n\n// Formatear fecha\nconst fechaFormateada = new Date(fecha).toLocaleDateString('es-ES', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\n\n// Generar mensaje de resumen\nlet resumen = `🌅 **Buenos días! Resumen para ${fechaFormateada}**\\n\\n`;\n\n// SECCIÓN: EVENTOS DEL DÍA\nresumen += `📅 **AGENDA DEL DÍA**\\n`;\nif (eventosDelDia.length === 0) {\n  resumen += `✅ No hay eventos programados para hoy\\n\\n`;\n} else {\n  // Agrupar eventos por usuario\n  const eventosPorUsuario = {};\n  \n  eventosDelDia.forEach(evento => {\n    const usuario = evento.user_id?.[1] || 'Sin asignar';\n    if (!eventosPorUsuario[usuario]) {\n      eventosPorUsuario[usuario] = [];\n    }\n    eventosPorUsuario[usuario].push(evento);\n  });\n  \n  Object.keys(eventosPorUsuario).forEach(usuario => {\n    resumen += `👤 **${usuario}:**\\n`;\n    eventosPorUsuario[usuario].forEach(evento => {\n      // CONVERTIR UTC A HORA LOCAL ESPAÑOLA\n      const horaInicio = convertirUTCaHoraLocal(evento.start);\n      const horaFin = convertirUTCaHoraLocal(evento.stop);\n      \n      resumen += `   🕐 ${horaInicio}-${horaFin}: ${evento.name}`;\n      if (evento.location) {\n        resumen += ` 📍 ${evento.location}`;\n      }\n      resumen += `\\n`;\n    });\n    resumen += `\\n`;\n  });\n}\n\n// SECCIÓN: ÓRDENES PENDIENTES\nresumen += `🛒 **ÓRDENES PENDIENTES DE CONFIRMAR**\\n`;\nif (ordenesPendientes.length === 0) {\n  resumen += `✅ No hay órdenes pendientes\\n\\n`;\n} else {\n  const totalPendiente = ordenesPendientes.reduce((acc, orden) => acc + (orden.amount_total || 0), 0);\n  resumen += `📊 **${ordenesPendientes.length} órdenes** por €${totalPendiente.toFixed(2)}\\n\\n`;\n  \n  // Mostrar máximo 10 órdenes para no hacer el mensaje muy largo\n  const ordenesAMostrar = ordenesPendientes.slice(0, 10);\n  \n  ordenesAMostrar.forEach((orden, idx) => {\n    const fechaOrden = new Date(orden.date_order).toLocaleDateString('es-ES');\n    const estadoTexto = orden.state === 'draft' ? '📝 Borrador' : '📨 Enviado';\n    \n    resumen += `${idx + 1}. **${orden.name}**\\n`;\n    resumen += `   👤 ${orden.partner_id?.[1] || 'Cliente no identificado'}\\n`;\n    resumen += `   💰 €${orden.amount_total?.toFixed(2) || '0.00'} | ${estadoTexto} | 📅 ${fechaOrden}\\n`;\n    \n    // Mostrar fecha de validez si existe\n    if (orden.validity_date) {\n      const fechaValidez = new Date(orden.validity_date).toLocaleDateString('es-ES');\n      resumen += `   ⏰ Válido hasta: ${fechaValidez}\\n`;\n    }\n    \n    resumen += `\\n`;\n  });\n  \n  if (ordenesPendientes.length > 10) {\n    resumen += `📋 _Y ${ordenesPendientes.length - 10} órdenes más..._\\n\\n`;\n  }\n}\n\n// FOOTER\nresumen += `⚡ _Resumen automático generado a las ${new Date().toLocaleTimeString('es-ES')}_`;\n\nreturn {\n  texto: resumen,\n  eventos_count: eventosDelDia.length,\n  ordenes_count: ordenesPendientes.length,\n  fecha: fecha\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10000,
        4800
      ],
      "id": "f62c981c-4e0b-4063-910e-47601771ace7",
      "name": "Formatear Resumen Diario"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos para el bucle de envío masivo\nconst resumenFormateado = $json.texto;\n\n// Obtener TODOS los usuarios registrados usando método robusto\nconst usuariosData = $('Consultar Usuarios Registrados y Validados').all();\nlet usuariosRegistrados = [];\n\nconsole.log('📨 Preparando envío masivo del resumen diario...');\nconsole.log('📊 Datos recibidos de PostgreSQL:', usuariosData.length, 'items');\n\n// PostgreSQL devuelve cada registro como un item separado\n// Necesitamos recopilar todos los usuarios de todos los items\nfor (const item of usuariosData) {\n  if (item.json) {\n    // Si el item tiene propiedades de usuario directamente\n    if (item.json.user_id && item.json.user_name && item.json.chat_id) {\n      usuariosRegistrados.push(item.json);\n      console.log('👤 Usuario encontrado:', item.json.user_name, '(ID:', item.json.user_id, ')');\n    }\n    // Si el item tiene un array result (formato alternativo)\n    else if (Array.isArray(item.json.result)) {\n      usuariosRegistrados.push(...item.json.result);\n      console.log('👥 Usuarios en result:', item.json.result.length);\n    }\n    // Si es un array directo\n    else if (Array.isArray(item.json)) {\n      usuariosRegistrados.push(...item.json);\n      console.log('👥 Usuarios en array:', item.json.length);\n    }\n  }\n}\n\nconsole.log('👥 Usuarios registrados encontrados:', usuariosRegistrados.length);\nconsole.log('👥 Lista de usuarios:', usuariosRegistrados);\n\n// Verificar que hay usuarios registrados\nif (!Array.isArray(usuariosRegistrados) || usuariosRegistrados.length === 0) {\n  console.log('⚠️ No se encontraron usuarios registrados para enviar el resumen');\n  return {\n    json: {\n      error: true,\n      mensaje: 'No hay usuarios registrados para enviar el resumen diario',\n      debug_data: usuariosData\n    }\n  };\n}\n\nconsole.log('📋 === PREPARANDO ITEMS PARA SPLITINBATCHES ===');\nconsole.log('🔄 Total de usuarios a procesar:', usuariosRegistrados.length);\n\n// Crear items individuales para splitInBatches con formato N8N correcto\nconst itemsParaBucle = usuariosRegistrados.map((usuario, index) => {\n  const item = {\n    json: {\n      usuario: usuario,\n      resumen_texto: resumenFormateado,\n      index: index,\n      total: usuariosRegistrados.length\n    }\n  };\n  \n  console.log(`📝 Item ${index + 1}: ${usuario.user_name} (${usuario.chat_id})`);\n  return item;\n});\n\nconsole.log('✅ Items preparados para splitInBatches:', itemsParaBucle.length);\nconsole.log('📊 Primer item ejemplo:', JSON.stringify(itemsParaBucle[0], null, 2));\n\n// Retornar array de objetos con formato N8N correcto\nreturn itemsParaBucle;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9792,
        4800
      ],
      "id": "68c1be0d-7b7c-4ad4-be8b-55be922e4a8d",
      "name": "Preparar Envío Masivo"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -9504,
        4800
      ],
      "id": "0a914dd1-32df-46bd-b077-51d3a5a186da",
      "name": "Bucle por Usuario"
    },
    {
      "parameters": {
        "jsCode": "// Procesar item individual del bucle\nconst itemActual = $json;\n\nconsole.log('🔍 === PREPARAR MENSAJE INDIVIDUAL ===');\nconsole.log('🔍 Datos recibidos:', JSON.stringify(itemActual, null, 2));\n\n// Si son datos de respuesta de Telegram, pasar sin procesar para que el bucle continúe\nif (itemActual.ok && itemActual.result) {\n  console.log('⚠️ Respuesta de Telegram detectada - saltando procesamiento');\n  // Retornar datos marcados para saltar en Control de Envío\n  return {\n    json: {\n      skip: true,\n      reason: 'telegram_response'\n    }\n  };\n}\n\n// Verificar si tenemos los datos correctos del usuario\nif (!itemActual.usuario || !itemActual.usuario.user_name) {\n  console.log('⚠️ Datos sin estructura de usuario válida - saltando');\n  return {\n    json: {\n      skip: true,\n      reason: 'invalid_user_data',\n      received_data: itemActual\n    }\n  };\n}\n\nconst usuario = itemActual.usuario;\nconst resumenTexto = itemActual.resumen_texto;\nconst index = itemActual.index;\nconst total = itemActual.total;\n\nconsole.log(`📤 ✅ PROCESANDO USUARIO VÁLIDO ${index + 1}/${total}: ${usuario.user_name} (${usuario.chat_id})`);\n\n// Retornar datos formateados para Telegram en formato correcto de n8n\nreturn {\n  json: {\n    chat_id: usuario.chat_id,\n    texto: resumenTexto,\n    user_name: usuario.user_name,\n    user_id: usuario.user_id,\n    mensaje_numero: index + 1,\n    total_usuarios: total,\n    skip: false\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9232,
        4832
      ],
      "id": "72f87416-fdf8-410b-ac76-4c053c3c7c0c",
      "name": "Preparar Mensaje Individual"
    },
    {
      "parameters": {
        "jsCode": "// Consultar eventos personalizados para el usuario actual\nconst itemActual = $json;\n\nconsole.log('📅 === CONSULTA EVENTOS PERSONALIZADA ===');\nconsole.log('📋 Datos recibidos:', JSON.stringify(itemActual, null, 2));\n\n// Los datos llegan directamente del nodo \"Preparar Mensaje Individual\"\n// Estructura: { chat_id, texto, user_name, user_id, mensaje_numero, total_usuarios, skip }\nconst userName = itemActual.user_name;\nconst userId = itemActual.user_id;\nconst chatId = itemActual.chat_id;\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\nconsole.log('👤 Usuario:', userName);\nconsole.log('🆔 User ID:', userId);\nconsole.log('💬 Chat ID:', chatId);\nconsole.log('📅 Fecha:', fechaHoy);\n\n// Obtener UID de autenticación de Odoo\nconst autenticacionData = $('Autenticar Odoo para Resumen').all();\nlet uid = null;\nfor (const item of autenticacionData) {\n  if (item.json && item.json.result) {\n    uid = item.json.result;\n    break;\n  }\n}\n\nif (!uid) {\n  console.log('❌ No se pudo obtener UID para consulta personalizada');\n  // Continuar con resumen general sin eventos personalizados\n  return {\n    json: {\n      ...itemActual,\n      eventos_personalizados: [],\n      mensaje_eventos: '📅 **TU AGENDA DEL DÍA**\\n⚠️ No se pudieron cargar tus eventos personalizados\\n'\n    }\n  };\n}\n\n// Consultar eventos donde el usuario sea participante o responsable\n// Usamos LIKE para comparar nombre de Telegram con usuarios de Odoo\nconst consultaEventosPersonalizados = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"calendar.event\",\n      \"search_read\",\n      [\n        [\n          [\"start\", \">=\", fechaHoy + \" 00:00:00\"],\n          [\"stop\", \"<=\", fechaHoy + \" 23:59:59\"],\n          \"|\",\n          [\"user_id.name\", \"ilike\", userName],\n          [\"partner_ids.name\", \"ilike\", userName]\n        ]\n      ],\n      {\n        fields: [\n          \"name\", \"description\", \"start\", \"stop\", \"duration\", \n          \"partner_ids\", \"user_id\", \"location\", \"privacy\", \"show_as\"\n        ],\n        order: \"start asc\"\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Consulta personalizada preparada para:', userName);\n\nreturn {\n  json: {\n    ...itemActual,\n    consulta_eventos: consultaEventosPersonalizados,\n    fecha: fechaHoy,\n    uid: uid,\n    usuario_actual: userName\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9056,
        4832
      ],
      "id": "8b77f233-c755-4ebd-bd75-a86947435f5d",
      "name": "Consultar Eventos Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.consulta_eventos) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -8864,
        4832
      ],
      "id": "0aa12fc9-a72d-4c5c-9284-b23067189e1b",
      "name": "HTTP Eventos Personalizados"
    },
    {
      "parameters": {
        "jsCode": "// Consultar tareas del día anterior del usuario (simplificado)\nconst eventosRespuesta = $json.result || [];\nconst datosUsuario = $('Consultar Eventos Usuario').first().json;\nconst userName = datosUsuario.usuario_actual || datosUsuario.user_name;\nconst uid = datosUsuario.uid;\n\nconsole.log('📊 === CONSULTA TAREAS AYER ===');\nconsole.log('👤 Usuario:', userName);\nconsole.log('🔑 UID:', uid);\n\nif (!uid) {\n  console.log('❌ No hay UID válido, omitiendo consulta de tareas');\n  return {\n    json: {\n      ...datosUsuario,\n      eventos_personalizados: eventosRespuesta,\n      tareas_ayer: [],\n      usuario_encontrado: false,\n      error_uid: true\n    }\n  };\n}\n\n// Calcular fecha de tareas (ayer o viernes si hoy es lunes)\nconst hoy = new Date();\nconst diaSemana = hoy.getDay(); // 0=domingo, 1=lunes, 2=martes, etc.\nlet fechaTareas;\nlet descripcionDia;\n\nif (diaSemana === 1) { // Si hoy es lunes\n  // Buscar tareas del viernes (3 días atrás)\n  fechaTareas = new Date(hoy);\n  fechaTareas.setDate(hoy.getDate() - 3);\n  descripcionDia = 'viernes';\n  console.log('🗓️ Hoy es lunes, buscando tareas del viernes anterior');\n} else {\n  // Buscar tareas de ayer\n  fechaTareas = new Date(hoy);\n  fechaTareas.setDate(hoy.getDate() - 1);\n  descripcionDia = 'ayer';\n  console.log('📅 Buscando tareas del día anterior');\n}\n\nconst fechaTareasStr = fechaTareas.toISOString().split('T')[0];\n\nconsole.log('📅 Fecha tareas:', fechaTareasStr, '(' + descripcionDia + ')');\nconsole.log('📅 Día de la semana actual:', diaSemana, '(1=lunes)');\n\n// Consulta simplificada: buscar tareas directamente por nombre de usuario\nconst consultaTareasAyer = {\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"search_read\",\n      [\n        [\n          [\"date\", \"=\", fechaTareasStr],\n          \"|\",\n          [\"user_id.name\", \"ilike\", userName],\n          [\"employee_id.name\", \"ilike\", userName]\n        ]\n      ],\n      {\n        \"fields\": [\n          \"name\", \"project_id\", \"task_id\", \"unit_amount\", \n          \"date\", \"employee_id\", \"user_id\"\n        ],\n        \"order\": \"unit_amount desc\",\n        \"limit\": 20\n      }\n    ]\n  },\n  \"id\": Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Consulta directa de tareas para:', userName, 'en fecha:', fechaTareasStr, '(' + descripcionDia + ')');\n\nreturn {\n  json: {\n    ...datosUsuario,\n    eventos_personalizados: eventosRespuesta,\n    consulta_tareas: consultaTareasAyer,\n    fecha_tareas: fechaTareasStr,\n    descripcion_dia: descripcionDia,\n    es_lunes: diaSemana === 1,\n    paso: 'consultar_tareas_directa'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8656,
        4832
      ],
      "id": "5018256c-3d8a-4b7b-a863-78b44c79e709",
      "name": "Preparar Consulta Tareas Ayer"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.consulta_tareas) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -8416,
        4832
      ],
      "id": "1d5e0773-37a6-4393-bfac-9c06bd74448a",
      "name": "HTTP Consultar Tareas Ayer"
    },
    {
      "parameters": {
        "jsCode": "// Formatear resumen personalizado: calendario hoy + tareas ayer\nconst tareasAyerRespuesta = $json.result || [];\nconst datosTareas = $('Preparar Consulta Tareas Ayer').first().json;\nconst eventosPersonalizados = datosTareas.eventos_personalizados || [];\n\nconsole.log('📊 === FORMATEAR RESUMEN PERSONALIZADO ===');\nconsole.log('📋 Datos tareas:', JSON.stringify(datosTareas, null, 2));\n\n// Obtener datos del usuario correctamente\nconst userName = datosTareas.usuario_actual || datosTareas.user_name;\nconst userId = datosTareas.user_id;\nconst chatId = datosTareas.chat_id;\nconst fechaHoy = datosTareas.fecha;\nconst fechaTareas = datosTareas.fecha_tareas;\nconst descripcionDia = datosTareas.descripcion_dia;\nconst esLunes = datosTareas.es_lunes;\nconst mensajeNumero = datosTareas.mensaje_numero;\nconst totalUsuarios = datosTareas.total_usuarios;\nconst errorUid = datosTareas.error_uid;\n\nconsole.log('👤 Usuario:', userName);\nconsole.log('📅 Eventos personalizados:', eventosPersonalizados.length);\nconsole.log('📊 Tareas encontradas:', tareasAyerRespuesta.length);\nconsole.log('📅 Fecha tareas:', fechaTareas, '(' + descripcionDia + ')');\nconsole.log('🗓️ Es lunes:', esLunes);\n\n// Formatear fecha de hoy\nconst fechaFormateada = new Date(fechaHoy).toLocaleDateString('es-ES', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\n\n// Formatear fecha de tareas (ayer o viernes)\nconst fechaTareasFormateada = new Date(fechaTareas).toLocaleDateString('es-ES', {\n  weekday: 'long',\n  year: 'numeric',\n  month: 'long',\n  day: 'numeric'\n});\n\n// FUNCIÓN PARA CONVERTIR UTC A HORA LOCAL ESPAÑOLA\nconst convertirUTCaHoraLocal = (fechaString) => {\n  console.log('🔍 Procesando fecha UTC:', fechaString);\n  \n  if (!fechaString) return '00:00';\n  \n  try {\n    // Crear fecha UTC desde el string de Odoo\n    const fechaUTC = new Date(fechaString + 'Z'); // Agregar Z para forzar UTC\n    \n    // Convertir a hora española (UTC+1 en invierno, UTC+2 en verano)\n    const horaLocal = fechaUTC.toLocaleTimeString('es-ES', {\n      hour: '2-digit',\n      minute: '2-digit',\n      timeZone: 'Europe/Madrid'\n    });\n    \n    console.log(`🕐 Conversión: ${fechaString} (UTC) → ${horaLocal} (Madrid)`);\n    return horaLocal;\n    \n  } catch (error) {\n    console.log('❌ Error convirtiendo hora:', error);\n    return '00:00';\n  }\n};\n\n// FUNCIÓN PARA LIMPIAR HTML DE DESCRIPCIONES\nconst limpiarHTML = (texto) => {\n  if (!texto) return '';\n  \n  // Remover todas las etiquetas HTML\n  return texto\n    .replace(/<[^>]*>/g, '') // Eliminar todas las etiquetas HTML\n    .replace(/&nbsp;/g, ' ') // Reemplazar &nbsp; con espacios\n    .replace(/&amp;/g, '&')  // Reemplazar &amp; con &\n    .replace(/&lt;/g, '<')   // Reemplazar &lt; con <\n    .replace(/&gt;/g, '>')   // Reemplazar &gt; con >\n    .trim(); // Eliminar espacios al inicio y final\n};\n\n// Crear sección personalizada de eventos\nlet seccionEventos = `📅 **TU AGENDA PARA ${fechaFormateada.toUpperCase()}**\\n\\n`;\n\nif (eventosPersonalizados.length === 0) {\n  seccionEventos += '🌟 **¡Día libre!** No tienes eventos programados\\n\\n';\n} else {\n  seccionEventos += `📋 **Tienes ${eventosPersonalizados.length} evento(s) programado(s):**\\n\\n`;\n  \n  eventosPersonalizados.forEach((evento, index) => {\n    console.log('🔍 Procesando evento:', evento.name, 'Start:', evento.start, 'Stop:', evento.stop);\n    \n    // CONVERTIR UTC A HORA LOCAL ESPAÑOLA\n    const inicio = convertirUTCaHoraLocal(evento.start);\n    const fin = convertirUTCaHoraLocal(evento.stop);\n    \n    seccionEventos += `${index + 1}. **${evento.name}**\\n`;\n    seccionEventos += `   🕐 ${inicio} - ${fin}`;\n    \n    if (evento.location) {\n      seccionEventos += ` | 📍 ${evento.location}`;\n    }\n    \n    // LIMPIAR HTML DE LA DESCRIPCIÓN\n    if (evento.description) {\n      const descripcionLimpia = limpiarHTML(evento.description);\n      if (descripcionLimpia && descripcionLimpia !== evento.name) {\n        const descripcionCorta = descripcionLimpia.length > 100 \n          ? descripcionLimpia.substring(0, 100) + '...' \n          : descripcionLimpia;\n        seccionEventos += `\\n   📝 ${descripcionCorta}`;\n      }\n    }\n    \n    seccionEventos += '\\n\\n';\n  });\n}\n\n// Crear sección de tareas (título dinámico según el día)\nconst tituloTareas = esLunes \n  ? `📊 **TUS TAREAS DEL ${fechaTareasFormateada.toUpperCase()}** 📅 (último día laboral)`\n  : `📊 **TUS TAREAS DEL ${fechaTareasFormateada.toUpperCase()}**`;\n\nlet seccionTareas = `${tituloTareas}\\n\\n`;\n\nif (errorUid || tareasAyerRespuesta.length === 0) {\n  seccionTareas += '⚠️ **No se encontraron tareas registradas**\\n\\n';\n} else {\n  // Agrupar tareas por proyecto\n  const tareasPorProyecto = {};\n  let totalHoras = 0;\n  \n  tareasAyerRespuesta.forEach(tarea => {\n    const proyectoNombre = tarea.project_id ? tarea.project_id[1] : 'Sin proyecto';\n    const tareaInfo = tarea.task_id ? ` - ${tarea.task_id[1]}` : '';\n    const descripcion = tarea.name || 'Sin descripción';\n    const horas = tarea.unit_amount || 0;\n    \n    totalHoras += horas;\n    \n    if (!tareasPorProyecto[proyectoNombre]) {\n      tareasPorProyecto[proyectoNombre] = [];\n    }\n    \n    tareasPorProyecto[proyectoNombre].push({\n      tarea: tareaInfo,\n      descripcion: descripcion,\n      horas: horas\n    });\n  });\n  \n  seccionTareas += `⏱️ **Total: ${totalHoras.toFixed(2)} horas registradas**\\n\\n`;\n  \n  Object.keys(tareasPorProyecto).forEach((proyecto, index) => {\n    const tareas = tareasPorProyecto[proyecto];\n    const horasProyecto = tareas.reduce((sum, t) => sum + t.horas, 0);\n    \n    seccionTareas += `${index + 1}. **${proyecto}** (${horasProyecto.toFixed(2)}h)\\n`;\n    \n    tareas.forEach(tarea => {\n      seccionTareas += `   • ${tarea.descripcion}${tarea.tarea} - ${tarea.horas}h\\n`;\n    });\n    \n    seccionTareas += '\\n';\n  });\n}\n\n// Generar resumen personalizado completo (SIN hora de generación)\nconst resumenPersonalizado = `🌅 **¡Buenos días, ${userName}!**\\n\\n` +\n  seccionEventos +\n  seccionTareas;\n\nconsole.log('✅ Resumen personalizado generado para:', userName);\n\nreturn {\n  json: {\n    chat_id: chatId,\n    texto: resumenPersonalizado,\n    user_name: userName,\n    user_id: userId,\n    mensaje_numero: mensajeNumero,\n    total_usuarios: totalUsuarios,\n    eventos_personalizados: eventosPersonalizados.length,\n    tareas_ayer: tareasAyerRespuesta.length,\n    skip: false\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8176,
        4832
      ],
      "id": "b65a0774-c412-4685-9f35-ab84c3cd69cf",
      "name": "Formatear Resumen Personalizado"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -7952,
        4832
      ],
      "id": "da1b682c-0b25-4856-8be0-60abfe1ac386",
      "name": "Telegram Envío Individual",
      "webhookId": "a059deb7-eb6b-491f-98ad-58d8100219de"
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta de Telegram y continuar bucle\nconst telegramResponse = $json;\n\nconsole.log('🧹 === NODO VACIAR - CONTINUAR BUCLE ===');\nconsole.log('📥 Respuesta de Telegram:', telegramResponse.ok ? '✅ Éxito' : '❌ Error');\n\n// Obtener datos del contexto del bucle desde el nodo de resumen personalizado\nconst datosDelBucle = $('Formatear Resumen Personalizado').first().json;\nconst mensajeNumero = datosDelBucle.mensaje_numero || 1;\nconst totalUsuarios = datosDelBucle.total_usuarios || 0;\nconst userName = datosDelBucle.user_name || 'Usuario';\n\nconsole.log(`📊 ✅ Iteración ${mensajeNumero}/${totalUsuarios} completada`);\nconsole.log(`👤 Usuario procesado: ${userName} (${datosDelBucle.chat_id})`);\nconsole.log(`📅 Eventos personalizados: ${datosDelBucle.eventos_personalizados || 0}`);\n\nif (telegramResponse.ok) {\n  console.log('📤 ✅ Mensaje enviado exitosamente');\n} else {\n  console.log('📤 ❌ Error en envío:', telegramResponse.description || 'Error desconocido');\n}\n\n// Verificar si es la última iteración\nif (mensajeNumero >= totalUsuarios) {\n  console.log('🎉 ¡Última iteración completada! Bucle terminado.');\n  console.log(`✅ Resumen personalizado enviado a ${totalUsuarios} usuarios`);\n} else {\n  console.log(`➡️ Preparando siguiente iteración (${mensajeNumero + 1}/${totalUsuarios})`);\n}\n\n// CLAVE: Enviar señal vacía para que splitInBatches continúe\n// pero sin datos que interfieran con el siguiente elemento del array\nreturn {\n  json: {}\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7760,
        4832
      ],
      "id": "a927def7-f00b-4666-a44c-200ecfcce918",
      "name": "Vaciar"
    },
    {
      "parameters": {
        "content": "## Mensaje diario resumen",
        "height": 80,
        "width": 380,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -11552,
        4704
      ],
      "id": "7fd44c4a-17fb-49a1-82c1-8f6fade818e9",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "",
        "width": 3940,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -11552,
        4784
      ],
      "typeVersion": 1,
      "id": "394a0a9b-3592-4a55-9d05-1d0bcb5bd917",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "={{ $json.verificacion_usuario.query }}",
        "options": {
          "queryReplacement": "={{ $json.verificacion_usuario.params }}",
          "largeNumbersOutput": "text"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -10224,
        3792
      ],
      "id": "30235128-34af-4db5-b3a0-78f3398418f1",
      "name": "PostgreSQL Verificar Usuario",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "es-correo-condition",
              "leftValue": "={{ String($json.mensaje_usuario || '').trim().toLowerCase().match(/^mi\\s+correo\\s+(es|:)\\s*(.+)$/i) !== null }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -12272,
        3936
      ],
      "id": "daedbf80-5649-4948-a286-29e61e8856c7",
      "name": "¿Es Usuario Pasando Mail?"
    },
    {
      "parameters": {
        "jsCode": "// Extraer SOLO el correo del mensaje\nconst datosExtraer = $('Extraer Datos').item.json;\nconst mensaje = String(datosExtraer.mensaje_usuario || '').trim();\n\n// Patrón: mi correo es X\nconst regex = /^mi\\s+correo\\s+(?:es|:)\\s*([^ \\t@]+@[^ \\t@]+\\.[^ \\t@]+)\\s*$/i;\n\nconst match = mensaje.match(regex);\n\nif (!match) {\n  console.log('❌ No coincide con el patrón de correo simple');\n  console.log('Mensaje recibido:', mensaje);\n  return {\n    ...datosExtraer,\n    correo_invalido: true,\n    correo_valido: false,\n    error_mensaje: 'Formato inválido. Usa: mi correo es tu@email.com',\n  };\n}\n\nconst correo = match[1].trim();\n\nconsole.log('✅ Correo extraído:', correo);\n\n// Validación básica de correo\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(correo)) {\n  console.log('❌ Formato de correo inválido:', correo);\n  return {\n    ...datosExtraer,\n    correo_invalido: true,\n    correo_texto: correo,\n    correo_valido: false,\n    error_mensaje: 'El correo no tiene un formato válido',\n  };\n}\n\n// Verificar si hay memoria de solicitud de correo para notificar al admin\nconst chatId = datosExtraer.chat_id || datosExtraer.user_id;\nconst userId = datosExtraer.user_id;\nconst userName = datosExtraer.user_name;\nconst contextoKey = `memoria_${chatId}`;\nconst memoria = global[contextoKey] || {};\n\nlet hayAdminEsperando = false;\nlet adminChatId = null;\n\nif (memoria.esperando_correo) {\n  console.log('✅ Hay un admin esperando este correo');\n  hayAdminEsperando = true;\n  adminChatId = memoria.admin_chat_id;\n}\n\nreturn {\n  ...datosExtraer,\n  correo_extraido: correo,\n  // el resto ya no nos interesa, pero dejamos los campos sin usar\n  user_id_actualizar: userId,\n  user_name_actualizar: userName,\n  admin_esperando: hayAdminEsperando,\n  admin_chat_id: adminChatId,\n  correo_valido: true\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -12176,
        3488
      ],
      "id": "be80a501-baa4-488e-92ed-66989332e7cc",
      "name": "Extraer y Validar Correo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "correo-valido-check",
              "leftValue": "={{ $json.correo_valido === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -11984,
        3504
      ],
      "id": "b6477aae-386e-479b-8d91-9c07464b5de4",
      "name": "¿Correo Válido?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE telegram_users\nSET user_mail = $1\nWHERE user_id = $2\n",
        "options": {
          "queryReplacement": "={{ [ $json.correo_extraido, parseInt($json.user_id_actualizar) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -11776,
        3408
      ],
      "id": "611ed4ef-ad5e-4c4c-addd-680982ca44a6",
      "name": "Actualizar Correo en BD"
    },
    {
      "parameters": {
        "jsCode": "// Limpiar memoria si había admin esperando y preservar todos los datos\n// IMPORTANTE: Tomar datos del nodo anterior al UPDATE porque UPDATE solo devuelve success\nconst datosCompletos = $('¿Correo Válido?').item.json;\nconst chatId = datosCompletos.chat_id || datosCompletos.user_id;\nconst contextoKey = `memoria_${chatId}`;\n\n// Limpiar memoria solo si había solicitud pendiente\nif (global[contextoKey] && global[contextoKey].esperando_correo) {\n  console.log('🧹 Limpiando memoria de solicitud de correo');\n  delete global[contextoKey].esperando_correo;\n  delete global[contextoKey].user_id_validar;\n  delete global[contextoKey].user_name_validar;\n  delete global[contextoKey].chat_id_validar;\n  delete global[contextoKey].admin_chat_id;\n}\n\nconsole.log('✅ === CORREO ACTUALIZADO ===');\nconsole.log('Usuario:', datosCompletos.user_name_actualizar);\nconsole.log('Correo:', datosCompletos.correo_extraido);\n\n// Preservar todos los datos necesarios para el siguiente nodo\nreturn {\n  chat_id: datosCompletos.chat_id,\n  user_id: datosCompletos.user_id,\n  user_name: datosCompletos.user_name,\n  user_id_actualizar: datosCompletos.user_id_actualizar,\n  user_name_actualizar: datosCompletos.user_name_actualizar,\n  correo_extraido: datosCompletos.correo_extraido,\n  admin_esperando: datosCompletos.admin_esperando,\n  admin_chat_id: datosCompletos.admin_chat_id,\n  correo_guardado: true,\n  success: $json.success || true\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11600,
        3408
      ],
      "id": "593c05a7-84e7-4e1f-9f82-ee668e1be94b",
      "name": "Limpiar Memoria Correo"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id && $json.chat_id !== 'null' && $json.chat_id !== '' ? Number($json.chat_id) : Number($json.user_id || $json.user_id_actualizar) }}",
        "text": "=✅ **Correo actualizado correctamente**\n\n📧 **Correo:** `{{ $json.correo_extraido }}`\n\n⏳ Ahora el administrador podrá completar tu validación.\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -11424,
        3408
      ],
      "id": "0a75f192-cff2-46f3-8df8-1f52634ab02b",
      "name": "Confirmar Correo al Usuario",
      "webhookId": "confirmar-correo-usuario-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "=✅ **Usuario ha enviado su correo**\n\n👤 **Usuario:** {{$node[\"Limpiar Memoria Correo\"].json[\"user_name_actualizar\"]}}\n📧 **Correo:** `{{$node[\"Limpiar Memoria Correo\"].json[\"correo_extraido\"]}}`\n\n✅ Ahora puedes validarlo con:\n`validar {{$node[\"Limpiar Memoria Correo\"].json[\"user_name_actualizar\"]}}`\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -11168,
        3360
      ],
      "id": "b9474fb6-782d-4e70-a8ce-77a6bccdb64c",
      "name": "Notificar Admin Correo Recibido",
      "webhookId": "notificar-admin-correo-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=❌ **Datos inválidos**\n\n⚠️ {{ $json.error_mensaje || 'El formato que enviaste no es válido.' }}\n\n✉️ **Por favor, envía tus datos con el siguiente formato:**\n\n`mi correo es pepe@gmail.com`\n\n📝 **Recuerda incluir:**\n• Correo electrónico válid",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -11552,
        3568
      ],
      "id": "48179ce5-6cc6-4414-a166-12b37109c813",
      "name": "Error Correo Inválido",
      "webhookId": "error-correo-invalido-webhook-001"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "has_image_condition",
              "leftValue": "={{ $json.tiene_imagen }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -11408,
        3760
      ],
      "id": "b8071534-81ec-43b8-8904-f82df22467fc",
      "name": "¿Tiene Imagen?"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.img_data.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -11168,
        3552
      ],
      "id": "20dd3357-cea0-4cd3-845d-579ba3dbe9d2",
      "name": "Descargar Imagen Inmediatamente",
      "webhookId": "112bd982-9aa8-409c-88ac-1c3c956c0c09",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// PROCESAR IMAGEN DESCARGADA INMEDIATAMENTE Y CONVERTIR A BASE64\nconst datosOriginales = $('Extraer Datos').item.json;\nconst imgData = datosOriginales.img_data;\n\nconsole.log('🖼️ === PROCESAR IMAGEN INMEDIATAMENTE ===');\nconsole.log('📊 Datos originales presentes:', !!datosOriginales);\nconsole.log('🖼️ Datos imagen presentes:', !!imgData);\n\n// Buscar datos binarios\nlet archivoBinario = null;\nlet archivoBase64 = null;\n\nif ($binary && $binary.data && Buffer.isBuffer($binary.data)) {\n  archivoBinario = $binary.data;\n  console.log('✅ Imagen descargada:', archivoBinario.length, 'bytes');\n  \n  // Convertir a base64 inmediatamente\n  archivoBase64 = archivoBinario.toString('base64');\n  console.log('✅ Convertido a base64:', archivoBase64.length, 'caracteres');\n} else {\n  console.log('❌ No se pudo descargar la imagen');\n}\n\n// Devolver datos originales + imagen en base64\nreturn {\n  ...datosOriginales,\n  imagen_base64: archivoBase64,\n  imagen_descargada: !!archivoBase64\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10992,
        3552
      ],
      "id": "8bec5ec5-b80b-4ad8-8dd2-fbe56fd9df68",
      "name": "Procesar Imagen Descargada"
    },
    {
      "parameters": {
        "content": "## Registra usuario, avisa a admin del nuevo registro y revisa el limite de consultas realizadas",
        "height": 864,
        "width": 1552
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -9936,
        3136
      ],
      "typeVersion": 1,
      "id": "f99ff6bd-e39d-4b7d-b079-ec571d9b751d",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Registro Usuario').item.json.chat_id }}",
        "text": "Hola, soy tu asistente AzerionBot 🤖. Tu usuario aún está pendiente de validación.|📋 **¿Ya enviaste tu correo electrónico?**Si no lo has hecho, envía un mensaje con este formato:`mi correo es tu@email.com`⏳ En cuanto un administrador lo active, podrás continuar sin problema 🚀. ¡Gracias por tu paciencia!",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -9056,
        3184
      ],
      "id": "40e4f60e-fa55-4524-9605-5530e79f1971",
      "name": "Mensaje nuevo registro sin user",
      "webhookId": "a60338e6-2cca-4589-90ce-e811f19111be"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "76440ca2-83c3-4912-81d9-b4a5353324c4",
              "leftValue": "={{ $json.odoo_user }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "80c36466-afdc-49c6-89af-744df0e95892",
              "leftValue": "={{ $('Extraer Datos').item.json.mensaje_usuario }}",
              "rightValue": "usuario es",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8032,
        3648
      ],
      "id": "98d46004-aaa3-4d27-bec2-617e2b47a2ad",
      "name": "If2"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 4 * * 1"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -11536,
        5232
      ],
      "id": "b46688d5-3792-42fb-a85e-2cc18a2dd88b",
      "name": "Trigger Informe Semanal Lunes 10:00"
    },
    {
      "parameters": {
        "jsCode": "function formatDate(d){ return d.toISOString().split('T')[0]; }\nconst hoy = new Date();\nconst day = hoy.getDay(); // 0=Dom, 1=Lun\nconst diffToMonday = ((day + 6) % 7);\nconst lunesActual = new Date(hoy);\nlunesActual.setDate(hoy.getDate() - diffToMonday);\nconst lunesAnterior = new Date(lunesActual);\nlunesAnterior.setDate(lunesActual.getDate() - 7);\nconst domingoAnterior = new Date(lunesAnterior);\ndomingoAnterior.setDate(lunesAnterior.getDate() + 6);\n\nreturn {\n  rango: { desde: formatDate(lunesAnterior), hasta: formatDate(domingoAnterior) }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11328,
        5232
      ],
      "id": "7db580d0-76f9-481f-a4a8-37f1846c8a54",
      "name": "Preparar Informe Semanal"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\"jsonrpc\": \"2.0\", \"method\": \"call\", \"params\": {\"service\": \"common\", \"method\": \"authenticate\", \"args\": [\"lsanchezgoshawk-n8npruebas-main-25736898\", \"admin\", \"admin\", {}]}, \"id\": 1}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10928,
        5232
      ],
      "id": "fe7ca841-4f29-4131-bf68-ab184af0c616",
      "name": "Autenticar Odoo para Resumen Semanal"
    },
    {
      "parameters": {
        "jsCode": "const uid = $item(0).$node[\"Autenticar Odoo para Resumen Semanal\"].json.result;\nif (!uid) throw new Error(\"No UID de Odoo\");\n\nconst rango = $item(0).$node[\"Preparar Informe Semanal\"].json.rango;\nconst { desde, hasta } = rango;\n\nconst desdeTS = `${desde} 00:00:00`;\nconst hastaTS = `${hasta} 23:59:59`;\n\nconst db = \"lsanchezgoshawk-n8npruebas-main-25736898\";\nconst password = \"admin\";\nconst ctx = { tz: \"Europe/Madrid\" };\n\nconst ventas_domain = [\n  [\"state\",\"in\",[\"sale\",\"done\"]],\n  [\"date_order\",\">=\",desdeTS],\n  [\"date_order\",\"<=\",hastaTS],\n];\n\n\nconst payload_ventas = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      db, uid, password,\n      \"sale.order\", \"search_read\",\n      [ventas_domain],\n      { fields: [\"id\",\"name\",\"state\",\"amount_total\",\"currency_id\",\"date_order\"], context: ctx }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\n/** ---------- LEADS ---------- */\nconst payload_leads = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      db, uid, password,\n      \"crm.lead\", \"search_read\",\n      [[\n        [\"type\",\"=\",\"opportunity\"],\n        [\"create_date\",\">=\",desdeTS],\n        [\"create_date\",\"<=\",hastaTS],\n      ]],\n      { fields: [\"id\",\"name\",\"create_date\",\"stage_id\"], context: ctx }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\n/** ---------- TICKETS ----------\n * En tu instancia no existe helpdesk.stage.is_close (lo indica el error).\n * Muchas instancias usan stage.fold para “cerrado/colapsado”.\n */\nconst tickets_domain = [\n  \"&\",\n  [\"stage_id.fold\",\"=\",true],\n  \"&\", [\"write_date\",\">=\",desdeTS], [\"write_date\",\"<=\",hastaTS],\n];\n\nconst payload_tickets = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      db, uid, password,\n      \"helpdesk.ticket\", \"search_read\",\n      [tickets_domain],\n      { fields: [\"id\",\"name\",\"stage_id\",\"write_date\"], context: ctx }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn { rango, payload_ventas, payload_leads, payload_tickets };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10720,
        5232
      ],
      "id": "44645ba1-7941-4f91-94dc-e9102555030d",
      "name": "Preparar Consultas Semanales"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload_ventas }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10512,
        5232
      ],
      "id": "980faa96-9f8f-489c-926c-dc63c191a6c4",
      "name": "HTTP Ventas Semana"
    },
    {
      "parameters": {
        "jsCode": "const ventas = $json.result || [];\nconst total = Array.isArray(ventas) ? ventas.length : 0;\nconst importe = Array.isArray(ventas) ? ventas.reduce((a,v)=> a + (v.amount_total || 0), 0) : 0;\nreturn { total_ventas: total, importe_ventas: importe };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10304,
        5232
      ],
      "id": "6e855d15-97d8-44af-b6db-ae3409760b6d",
      "name": "Guardar Ventas Semana"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $item(0).$node[\"Preparar Consultas Semanales\"].json.payload_leads }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10112,
        5232
      ],
      "id": "5192b2ed-314c-47de-bdf7-e246e2f56d08",
      "name": "HTTP Leads Semana"
    },
    {
      "parameters": {
        "jsCode": "const leads = $json.result || [];\nreturn { total_leads: Array.isArray(leads) ? leads.length : 0 };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9904,
        5232
      ],
      "id": "d5b9b55d-ad75-4ecc-b73f-75bd467b66d9",
      "name": "Guardar Leads Semana"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $item(0).$node[\"Preparar Consultas Semanales\"].json.payload_tickets }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -9712,
        5232
      ],
      "id": "f4666e5d-9419-4204-92b7-ab4bee26f883",
      "name": "HTTP Tickets Semana"
    },
    {
      "parameters": {
        "jsCode": "const tickets = $json.result || [];\nreturn { total_tickets: Array.isArray(tickets) ? tickets.length : 0 };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9504,
        5232
      ],
      "id": "305016f1-bb4f-4b41-96b8-a2bad3d2138b",
      "name": "Guardar Tickets Semana"
    },
    {
      "parameters": {
        "jsCode": "// Datos agregados\nconst rango = $item(0).$node[\"Preparar Consultas Semanales\"]?.json.rango\n  || $item(0).$node[\"Preparar Informe Semanal\"]?.json.rango;\n\nconst totalVentas   = $item(0).$node[\"Guardar Ventas Semana\"]?.json.total_ventas || 0;\nconst importeVentas = $item(0).$node[\"Guardar Ventas Semana\"]?.json.importe_ventas || 0;\nconst totalLeads    = $item(0).$node[\"Guardar Leads Semana\"]?.json.total_leads || 0;\nconst totalTickets  = $item(0).$node[\"Guardar Tickets Semana\"]?.json.total_tickets || 0;\n\n// Trae todos los usuarios del nodo Postgres\nconst usuarios = $(\"Consultar Usuarios Registrados y Validados Semanal\").all().map(i => i.json);\n\n// Mensaje en HTML (evitamos MarkdownV2)\nconst titulo = `📊 Informe semanal (${rango.desde} a ${rango.hasta})`;\nconst textoBase =\n  `<b>${titulo}</b>\\n\\n` +\n  `• <b>Ventas</b>: ${totalVentas} (importe total: €${importeVentas.toFixed(2)})\\n` +\n  `• <b>Leads</b>: ${totalLeads}\\n` +\n  `• <b>Tickets cerrados</b>: ${totalTickets}\\n\\n` +\n  `⏰ Enviado automáticamente cada lunes a las 10:00 (Europe/Madrid)`;\n\n// Devuelve un item por usuario\nreturn usuarios.map(u => ({\n  json: {\n    chat_id: u.chat_id,\n    texto: textoBase\n  }\n}));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9296,
        5232
      ],
      "id": "ddc9cd68-ec71-4900-be96-23050c94f68c",
      "name": "Formatear Informe Semanal"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -9088,
        5232
      ],
      "id": "50432228-b603-4efb-b7a8-b2d700e7416c",
      "name": "Enviar Informe Semanal Telegram",
      "webhookId": "f708491c-63bc-4dc9-a6c1-6494a91fb7c2"
    },
    {
      "parameters": {
        "content": "## Mensaje Informe Semanal \n",
        "height": 256,
        "width": 2688,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -11568,
        5120
      ],
      "id": "44709c88-7c14-46a9-8d81-ef736338bc99",
      "name": "Sticky Note22"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT consultas_restantes, usuario_valido, is_admin\nFROM telegram_users\nWHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ [parseInt($('Procesar Resultado Verificación').item.json.user_id)] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -9008,
        3792
      ],
      "id": "f8d695cb-dacf-4e1f-a7ae-ae776d8ab08c",
      "name": "Consultar Límite Usuario"
    },
    {
      "parameters": {
        "jsCode": "const base = $('Limpiar Datos Registro').first().json;\nconst fila = $json || {};\n\nif ($json.es_fallback === true || base.es_fallback === true) {\n  return { ...base, puede_continuar: true, es_fallback: true };\n}\n\nconst isAdmin = fila.is_admin === true || fila.is_admin === 'true';\nconst usuarioValido = fila.usuario_valido === true || fila.usuario_valido === 'true';\nconst restantes = parseInt(fila.consultas_restantes ?? 0, 10);\n\nif (isAdmin) return { ...base, puede_continuar: true };\nif (!usuarioValido) return { ...base, puede_continuar: false, texto_bloqueo: 'Hola, soy tu asistente AzerionBot 🤖. Tu usuario aún está pendiente de validación.\\n\\n📋 **¿Ya enviaste tu correo electrónico?**\\nSi no lo has hecho, envía un mensaje con este formato:\\n\\n`mi correo es tu@email.com`\\n\\n⏳ En cuanto un administrador lo active, podrás continuar sin problema 🚀. ¡Gracias por tu paciencia!' };\nif (!Number.isFinite(restantes) || restantes <= 0) {\n  return { ...base, puede_continuar: false, texto_bloqueo: `Has alcanzado el límite de consultas disponibles.\\n\nSi deseas seguir utilizando el servicio o resolver tus dudas, puedes ponerte en contacto con nuestros profesionales en:\\n\n📧 laura.sanchez@goshawkanalytics.com \\n \n📧 marcos.checa@goshawkanalytics.com` };\n}\nreturn { ...base, puede_continuar: true };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8800,
        3792
      ],
      "id": "981a4466-7450-41a7-9b3f-91998b77b7fe",
      "name": "Aplicar Límite Consultas"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "196f8ea7-508c-42be-8db3-1ffa1505c489",
              "leftValue": "={{ $json.puede_continuar }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8592,
        3792
      ],
      "id": "e71f5b36-de7c-4488-9493-1dd563af1f80",
      "name": "¿Puede Continuar?"
    },
    {
      "parameters": {
        "chatId": "={{ Number($('Extraer Datos').first().json.chat_id || $('Limpiar Datos Registro').first().json.chat_id || $json.chat_id) }}",
        "text": "={{$json.texto_bloqueo}}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -8352,
        3920
      ],
      "id": "9b7401d8-6d23-43ae-8434-4dc357a57589",
      "name": "Aviso Bloqueo",
      "webhookId": "0b44b88f-28dc-4008-a15b-5a9af5d6d273"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT chat_id FROM telegram_users WHERE is_admin = true",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -8912,
        3408
      ],
      "id": "7c1bdaff-5d5c-4a6d-a188-4a69dac31172",
      "name": "Listar Admins"
    },
    {
      "parameters": {
        "jsCode": "const u = $('Preparar Registro Usuario').first().json;\nconst texto = `Un nuevo usuario de nombre \"${u.user_name}\" quiere registrarse. Valídalo para que pueda continuar (comando: validar ${u.user_name}).`;\nreturn { texto, nuevo_user_chat_id: u.chat_id, nuevo_user_name: u.user_name };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9104,
        3408
      ],
      "id": "149175cf-99d6-446f-9442-c2bed9f140f1",
      "name": "Mensaje para Admins de Nuevo Usuario"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $('Mensaje para Admins de Nuevo Usuario').item.json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -8736,
        3408
      ],
      "id": "51f403d3-3af6-46c4-90e7-397260f680cd",
      "name": "Avisar Admin Nuevo Usuario",
      "webhookId": "bc709e5b-d58d-4af8-87fb-33732614c610"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "78dccaed-58f8-4e23-a645-5f2340600a0e",
              "leftValue": "={{ $json.usuario_existe }}",
              "rightValue": "=false",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -9872,
        3792
      ],
      "id": "3dc73172-9971-4d13-ab00-9d41543d2875",
      "name": "¿Usuario Existe?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "82a258a6-ba2d-422c-80f3-2c3fce01ef03",
              "leftValue": "={{ String(($json.mensaje_usuario || '')).trim().toLowerCase().startsWith('validar ') || String(($json.mensaje_usuario || '')).trim().toLowerCase().startsWith('/validar ') }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -12560,
        3360
      ],
      "id": "42a0bbfb-9ce1-45dc-99fb-6e2c8aa78f12",
      "name": "¿Es Comando Validar?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT is_admin\nFROM telegram_users\nWHERE user_id = $1",
        "options": {
          "queryReplacement": "={{ [ parseInt($('Extraer Datos').item.json.user_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -12352,
        3264
      ],
      "id": "1b71c657-1e82-4b70-8015-5bf3d01d9210",
      "name": "¿Es Admin?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b071b90c-f7bf-425c-b01f-f2c17272c3d6",
              "leftValue": "={{ $json.is_admin === true || $json.is_admin === 'true' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -12208,
        3168
      ],
      "id": "5e571df2-bad9-4067-b0d4-335a1af83d37",
      "name": "¿Admin Autorizado?"
    },
    {
      "parameters": {
        "jsCode": "const msg = ($('Extraer Datos').first().json.mensaje_usuario || '').trim();\nconst m = msg.match(/^validar\\s+(.+)$/i);\nif (!m) {\n  throw new Error('Formato inválido. Usa: validar <nombre>');\n}\nconst nombre = m[1].trim();\nreturn { nombre };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -12000,
        3072
      ],
      "id": "2be96b7f-1c92-4b4c-bf27-d11d68ccd14e",
      "name": "Parsear Objetivo"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, chat_id, user_name, usuario_valido, user_mail, direccion_calle, codigo_postal, poblacion, provincia, pais\nFROM telegram_users\nWHERE user_name ILIKE $1\nORDER BY first_seen ASC\nLIMIT 1",
        "options": {
          "queryReplacement": "={{ [ '%' + String($json.nombre || '').trim() + '%' ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -11840,
        3072
      ],
      "id": "49ac95c1-daa3-4a9a-93d9-889801409372",
      "name": "Buscar Usuario Por Nombre",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "Solo los administradores pueden validar usuarios.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -12000,
        3248
      ],
      "id": "12f79aae-e78a-4155-a989-1be4f397f961",
      "name": "No autorizado",
      "webhookId": "8639f06d-9611-4667-ad53-778547c73de0"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dc4e2f2e-f2bb-455f-b0e3-80a64a51ee9b",
              "leftValue": "={{ !!$json.user_id }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -11664,
        3072
      ],
      "id": "3d0261e1-234c-4874-b4be-36e9b074105b",
      "name": "¿Encontrado?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "No se encontró un usuario con ese nombre.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -11456,
        3248
      ],
      "id": "a6e5f993-1ed4-48ae-ba34-3363e34f101c",
      "name": "Error Validar Usuario",
      "webhookId": "194a93f7-e0f3-4370-9277-126cb270ad2e"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "tiene-mail-check-001",
              "leftValue": "={{ $json.user_mail && $json.user_mail !== null && String($json.user_mail).trim() !== '' }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -11472,
        2976
      ],
      "id": "95f0c88d-545f-4120-a003-44addc7d3227",
      "name": "¿Tiene Mail?"
    },
    {
      "parameters": {
        "jsCode": "// Guardar en memoria que el usuario debe enviar su correo\nconst userData = $json;\nconst chatId = userData.chat_id;\nconst userId = userData.user_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconsole.log('📧 === SOLICITAR CORREO AL USUARIO ===');\nconsole.log('Usuario:', userData.user_name);\nconsole.log('User ID:', userId);\n\n// Guardar en memoria que estamos esperando el correo\nmemoria.esperando_correo = true;\nmemoria.user_id_validar = userId;\nmemoria.user_name_validar = userData.user_name;\nmemoria.chat_id_validar = chatId;\nmemoria.admin_chat_id = $('Extraer Datos').item.json.chat_id; // Chat del admin que ejecutó el comando\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  ...userData,\n  solicitar_mail: true\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11232,
        3072
      ],
      "id": "1029454f-7bc9-4427-8e49-a2e5e995e1cd",
      "name": "Preparar Solicitar Mail"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=📧 Hola {{ $json.user_name }},\n\nPara completar tu validación y crear el acceso a Odoo necesitamos tu correo electrónico.\n\n✉️ Por favor, envía un mensaje con el siguiente formato:\n\n`mi correo es pepe@gmail.com`\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -11056,
        3072
      ],
      "id": "0327ef09-f173-4b1f-a2d9-7cf9ce9b77f9",
      "name": "Solicitar Mail Usuario",
      "webhookId": "solicitar-mail-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "=✅ Se ha solicitado el correo electrónico al usuario {{ $json.user_name }}.\n\n⏳ Esperando respuesta...",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -10880,
        3072
      ],
      "id": "382e5a2c-c9a7-4f29-8862-d23738ae973e",
      "name": "Confirmar Solicitud Mail al Admin",
      "webhookId": "confirmar-solicitud-mail-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// Generar login único para Odoo basado en el correo del usuario\nconst userData = $('Buscar Usuario Por Nombre').first().json;\nconst userMail = userData.user_mail;\nconst userName = userData.user_name || 'usuario';\n\nlet baseLogin;\n\n// Si tiene correo, usar el correo completo como login\nif (userMail && userMail.includes('@')) {\n  baseLogin = userMail.toLowerCase().trim();\n  console.log('✅ Usando correo completo como login:', baseLogin);\n} else {\n  // Fallback: usar el nombre de usuario de Telegram\n  baseLogin = userName.toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '') // Eliminar acentos\n    .replace(/[^a-z0-9]/g, '_') // Reemplazar caracteres especiales con guión bajo\n    .replace(/_+/g, '_') // Evitar múltiples guiones bajos consecutivos\n    .replace(/^_|_$/g, ''); // Eliminar guiones bajos al inicio y final\n  \n  // Si el login queda vacío, usar 'usuario'\n  if (!baseLogin) {\n    baseLogin = 'usuario';\n  }\n  console.log('⚠️ No hay correo, usando nombre de usuario:', baseLogin);\n}\n\n// Generar una contraseña aleatoria segura\nconst chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';\nlet password = '';\nfor (let i = 0; i < 12; i++) {\n  password += chars.charAt(Math.floor(Math.random() * chars.length));\n}\n\nconsole.log('📧 Correo:', userMail || 'No disponible');\nconsole.log('🔐 Contraseña generada (temporal)');\n\nreturn {\n  ...userData,\n  odoo_user: baseLogin,\n  odoo_password: password,\n  login_attempt: 0 // Para el control de unicidad\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10384,
        2912
      ],
      "id": "5eee40f3-76a2-4bba-a71f-b6ea31c69559",
      "name": "Generar Login Odoo"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT odoo_user FROM telegram_users WHERE odoo_user = $1",
        "options": {
          "queryReplacement": "={{ [ $json.odoo_user + ($json.login_attempt > 0 ? $json.login_attempt : '') ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -10192,
        2912
      ],
      "id": "a814a37c-b8ee-45fc-abfb-84c80dbff40a",
      "name": "Verificar Login Existe",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Verificar si el login ya existe y ajustar si es necesario\nconst userData = $('Generar Login Odoo').item.json;\nconst queryResult = $input.all();\n\nlet loginFinal = userData.odoo_user;\nlet loginAttempt = userData.login_attempt || 0;\n\n// Si el login existe, añadir un número\nif (queryResult && queryResult.length > 0 && queryResult[0].json.odoo_user) {\n  loginAttempt++;\n  loginFinal = userData.odoo_user + loginAttempt;\n  \n  // Si hemos intentado más de 100 veces, añadir un timestamp\n  if (loginAttempt > 100) {\n    loginFinal = userData.odoo_user + '_' + Date.now();\n  }\n  \n  console.log('⚠️ Login ya existe, intentando:', loginFinal);\n  \n  // Si aún no hemos encontrado uno único, necesitamos reintentar\n  if (loginAttempt < 100) {\n    return {\n      ...userData,\n      odoo_user: userData.odoo_user,\n      login_attempt: loginAttempt,\n      needs_retry: true\n    };\n  }\n}\n\nconsole.log('✅ Login único encontrado:', loginFinal);\n\nreturn {\n  ...userData,\n  odoo_user_final: loginFinal,\n  odoo_password: userData.odoo_password,\n  needs_retry: false\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10016,
        2912
      ],
      "id": "33e2871e-8848-4550-ac0d-472df0cca182",
      "name": "Ajustar Login Si Necesario"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE telegram_users\nSET usuario_valido = true,\n    odoo_user = $2\nWHERE user_id = $1\nRETURNING *",
        "options": {
          "queryReplacement": "={{ [ parseInt($json.user_id), $json.odoo_user_final ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -9840,
        2912
      ],
      "id": "e79a9884-d61c-46c2-9b04-27db2e64303d",
      "name": "Validar Usuario",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Preservar datos del nodo anterior para pasar al flujo de creación de Odoo\nconst datosAjustados = $('Ajustar Login Si Necesario').item.json;\n\nreturn {\n  ...datosAjustados,\n  user_id: datosAjustados.user_id,\n  user_name: datosAjustados.user_name,\n  user_mail: datosAjustados.user_mail,\n  direccion_calle: datosAjustados.direccion_calle,\n  codigo_postal: datosAjustados.codigo_postal,\n  poblacion: datosAjustados.poblacion,\n  provincia: datosAjustados.provincia,\n  pais: datosAjustados.pais,\n  chat_id: datosAjustados.chat_id,\n  odoo_user_final: datosAjustados.odoo_user_final,\n  odoo_password: datosAjustados.odoo_password\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -9664,
        2912
      ],
      "id": "22489434-21f8-4de0-920e-e2afa82e3813",
      "name": "Preservar Datos Usuario"
    },
    {
      "parameters": {
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -11216,
        2832
      ],
      "id": "53bc5e9b-da9e-4491-820b-54848899fef0",
      "name": "Autenticar Odoo Validación"
    },
    {
      "parameters": {
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -9456,
        2912
      ],
      "id": "2ac2f18a-35ef-4d04-9dda-67f56d7fdb43",
      "name": "Autenticar Odoo Creación"
    },
    {
      "parameters": {
        "jsCode": "// Verificar si el usuario ya existe en Odoo antes de crearlo\n// Ahora buscamos ANTES de generar el login, usando el correo electrónico\nconst userData = $('Buscar Usuario Por Nombre').first().json;\nconst uid = $json.result;\n\n// Usar el correo electrónico para buscar\nconst correoUsuario = userData.user_mail;\n\nconsole.log('🔍 Verificando si el usuario ya existe en Odoo por correo:', correoUsuario);\nconsole.log('📋 Datos usuario completos:', JSON.stringify(userData, null, 2));\n\nif (!correoUsuario || correoUsuario === '') {\n  console.error('❌ No hay correo para verificar');\n  throw new Error('No se pudo obtener el correo del usuario para verificar en Odoo');\n}\n\n// Buscar en res.users si el correo (login) ya existe\nconst verificarUsuario = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.users\",\n      \"search_read\",\n      [\n        [[\"login\", \"=\", correoUsuario]]\n      ],\n      {\n        fields: [\"id\", \"login\", \"name\"],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Búsqueda preparada para correo:', correoUsuario);\n\nreturn {\n  url: 'https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: verificarUsuario,\n  method: 'POST',\n  uid: uid,\n  user_data: userData,\n  correo_buscado: correoUsuario\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11040,
        2832
      ],
      "id": "0f17d2d1-74d6-4b64-a7b5-44d525b7017e",
      "name": "Verificar Usuario Existe Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -10848,
        2832
      ],
      "id": "3931cea5-fb4d-4ed3-a618-129faafbdb61",
      "name": "Ejecutar Verificación Usuario",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "usuario-existe-check",
              "leftValue": "={{ $json.result && $json.result.length > 0 }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -10672,
        2832
      ],
      "id": "d1d660b5-d945-4e0a-8edc-3f64073da0e0",
      "name": "¿Usuario Ya Existe?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Verificar Usuario Existe Odoo').item.json.user_data.chat_id || $('Verificar Usuario Existe Odoo').item.json.user_data.user_id }}",
        "text": "=⚠️ **Usuario ya registrado en Odoo**\n\n👤 El usuario con correo `{{ $('Verificar Usuario Existe Odoo').item.json.user_data.user_mail }}` ya está registrado en Odoo.\n\n✅ Puedes utilizar el bot sin problemas.\n\n💡 Si necesitas ayuda, contacta con el administrador.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -10384,
        2656
      ],
      "id": "aa2bd3a8-0f4c-45df-af7d-f3633497904d",
      "name": "Notificar Usuario Ya Existe",
      "webhookId": "usuario-ya-existe-webhook-001"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "=⚠️ **Intento de registro duplicado**\n\n👤 **Usuario:** {{ $('Verificar Usuario Existe Odoo').item.json.user_data.user_name }}\n📧 **Correo:** `{{ $('Verificar Usuario Existe Odoo').item.json.user_data.user_mail }}`\n\n✅ El usuario ya existe en Odoo, no se creó de nuevo.\n\n💡 Se le ha notificado que su usuario ya está registrado.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -10208,
        2656
      ],
      "id": "05954baa-1a2d-4de7-a908-d1df3e171572",
      "name": "Notificar Admin Usuario Existe",
      "webhookId": "admin-usuario-existe-webhook-001"
    },
    {
      "parameters": {
        "jsCode": "// Crear partner solo con nombre + email\nconst userData = $('Preservar Datos Usuario').item.json;\nconst uid = $json.result;  // viene de Autenticar Odoo Creación\n\nconst nombreCompleto = userData.user_name || 'Usuario Telegram';\nconst login = userData.odoo_user_final;\nconst password = userData.odoo_password;\nconst userMail = userData.user_mail;\n\n// Si por lo que sea no hubiera correo, usamos el login como pseudo-email\nconst emailPartner = (userMail && userMail.trim() !== '')\n  ? userMail.trim()\n  : `${login}@telegram.user`;\n\nconst partnerData = {\n  name: nombreCompleto,\n  email: emailPartner,\n  customer_rank: 1,\n  // si en el futuro quieres meter más campos (street, city, etc.), se añaden aquí\n};\n\nconsole.log('📧 Creando partner mínimo con:');\nconsole.log('  Nombre:', nombreCompleto);\nconsole.log('  Email:', emailPartner);\n\nconst crearPartner = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.partner\",\n      \"create\",\n      [partnerData]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  url: 'https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: crearPartner,\n  method: 'POST',\n  uid: uid,\n  login: login,\n  password: password,\n  user_data: userData\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8512,
        2912
      ],
      "id": "3b248fd0-7b57-4539-b613-8fb1b06747d8",
      "name": "Preparar Crear Partner"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -8320,
        2912
      ],
      "id": "9ea61ef6-23f5-4bb9-b417-b24ff60cf6bc",
      "name": "Crear Partner Odoo",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Crear usuario de Odoo con el partner creado\nconst prepData = $('Preparar Crear Partner').item.json;\nconst partnerId = $json.result;\nconst uid = prepData.uid;\nconst login = prepData.login;\nconst password = prepData.password;\n\n// Buscar el grupo de portal\nconst buscarGrupoPortal = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.groups\",\n      \"search\",\n      [[[\"name\", \"=\", \"Portal\"]]]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  url: 'https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: buscarGrupoPortal,\n  method: 'POST',\n  uid: uid,\n  login: login,\n  password: password,\n  partner_id: partnerId,\n  user_data: prepData.user_data\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8080,
        2912
      ],
      "id": "30eceda8-34bb-43e0-a014-21bc8b255dca",
      "name": "Buscar Grupo Portal"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -7856,
        2912
      ],
      "id": "80b2140a-85ca-4390-9db1-ee67455c7a73",
      "name": "Obtener Grupo Portal"
    },
    {
      "parameters": {
        "jsCode": "// Combinar resultado del HTTP con datos previos\nconst grupoPortalIds = $json.result || [];\nconst datosOriginales = $('Buscar Grupo Portal').item.json;\n\nconsole.log('🔍 Grupos Portal encontrados:', grupoPortalIds);\nconsole.log('📋 Login a usar:', datosOriginales.login);\nconsole.log('🔐 Password disponible:', datosOriginales.password ? 'Sí' : 'No');\n\nreturn {\n  ...datosOriginales,\n  grupo_portal_ids: grupoPortalIds\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7664,
        2912
      ],
      "id": "b1c90213-746e-451d-be07-8fa1b2812983",
      "name": "Combinar Datos Grupo Portal"
    },
    {
      "parameters": {
        "jsCode": "// Crear el usuario con permisos de portal\nconst prepData = $json;\nconst grupoPortalIds = prepData.grupo_portal_ids || [];\nconst uid = prepData.uid;\nconst login = prepData.login;\nconst password = prepData.password;\nconst partnerId = prepData.partner_id;\n\n// ⚠️ VALIDACIÓN CRÍTICA: Verificar que login esté definido\nif (!login || login === 'undefined' || login === 'null' || login.trim() === '') {\n  console.error('❌ ERROR CRÍTICO: Login no definido');\n  console.error('prepData completo:', JSON.stringify(prepData, null, 2));\n  throw new Error(`Login no puede ser vacío. Valor recibido: \"${login}\"`);\n}\n\nconsole.log('✅ Login validado:', login);\nconsole.log('🔐 Password:', password ? 'Definido' : 'NO DEFINIDO');\nconsole.log('👤 Partner ID:', partnerId);\n\n// Si no encontramos el grupo Portal exacto, buscar \"Portal\" en category_id\nlet groupsToAssign = [];\nif (grupoPortalIds && grupoPortalIds.length > 0) {\n  groupsToAssign = [[6, 0, grupoPortalIds]];\n} else {\n  // Usar el ID estándar del grupo portal (normalmente es 8 o 9)\n  groupsToAssign = [[6, 0, [9]]];\n}\n\nconst crearUsuario = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.users\",\n      \"create\",\n      [{\n        login: login,\n        password: password,\n        partner_id: partnerId,\n        groups_id: groupsToAssign\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Usuario a crear:', JSON.stringify(crearUsuario.params.args[5][0], null, 2));\n\nreturn {\n  url: 'https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: crearUsuario,\n  method: 'POST',\n  uid: uid,\n  login: login,\n  password: password,\n  partner_id: partnerId,\n  user_data: prepData.user_data\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7456,
        2912
      ],
      "id": "f3ad5144-1f52-471c-9926-f62071c200e7",
      "name": "Preparar Crear Usuario Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -7248,
        2912
      ],
      "id": "f353407f-b5b7-47a1-bdcc-bbfc113251ec",
      "name": "Crear Usuario Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos para el mensaje final\nconst prepData = $('Preparar Crear Usuario Odoo').item.json;\nconst odooUserId = $json.result;\n\nreturn {\n  ...prepData.user_data,\n  odoo_user_id: odooUserId,\n  odoo_user: prepData.login,\n  odoo_password: prepData.password\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7040,
        2912
      ],
      "id": "1fc1c5c5-c41a-49ac-aaee-b2eea5cc7d95",
      "name": "Preparar Datos Finales"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id && $json.chat_id !== 'null' && $json.chat_id !== '' ? Number($json.chat_id) : Number($json.user_id) }}",
        "text": "=✅ **¡Tu usuario ha sido validado exitosamente!**\n\n👤 **Usuario de Odoo creado:**\n🔑 **Login:** `{{ $json.odoo_user }}`\n🔐 **Contraseña temporal:** `{{ $json.odoo_password }}`\n\n⚠️ **IMPORTANTE:** Por razones de seguridad, te recomendamos cambiar tu contraseña inmediatamente después de iniciar sesión en Odoo.\n\n🌐 **Acceso a Odoo:**\nhttps://lsanchezgoshawk-azorn8n2.odoo.com/\n\n📱 Ahora tienes acceso completo al portal y puedes usar todas las funciones del bot.\n\n💡 **Tienes 5 consultas de prueba disponibles.**",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -6864,
        2912
      ],
      "id": "a718c653-1fef-401c-8fe6-770d9aa418e2",
      "name": "Avisar Usuario Validado",
      "webhookId": "c5da80f0-323b-4b98-940b-224cd076a242"
    },
    {
      "parameters": {
        "chatId": "={{ Number($('Buscar Usuario Por Nombre').first().json.chat_id || $('Buscar Usuario Por Nombre').first().json.user_id) }}",
        "text": "=🤖 Hola {{ $('Buscar Usuario Por Nombre').first().json.user_name || 'Usuario' }}, soy **AzerionBot**, tu asistente de Odoo.\n\nPara ver los datos reales puedes acceder a una base de datos de odoo en https://lsanchezgoshawk-azorn8n2.odoo.com/ \ncon user: azordata y contraseña :1234\n\n **Tengo la capacidad de:**\n• 📋 Registrar partes de horas\n• 🏗️ Crear proyecto\n• ✅ Crear tarea\n• 🛍️ Consultar producto\n• 💰 Consultar ventas\n• 🛒 Consultar compras\n• 🧾 Consultar facturas\n• 🔴 Consultar pagos pendientes\n• 🏆 Consultar top rankings\n• 👔 Consultar ranking comerciales\n• 📊 Consultar ventas perdidas\n• 🔍 Consultar ventas por orden\n• 👤 Consultar contacto\n• 🆕 Crear contacto\n• ✏️ Modificar contacto\n• 🛒 Crear pedidos de venta\n• 📅 Crear eventos en calendario\n• ⏰ Consultar horas de proyecto\n• ⏰ Consultar horas de tarea\n• ⏰ Consultar actividad temporal por usuario\n• 🏖️ Consultar ausencias\n• 📅 Consultar eventos de usuario\n• 🌐 Consultar visitantes web\n• 🏖️ Registrar ausencias\n• 💰 Registrar gastos\n• 🎤 Transcribir audios\n\n📱 Y además me tienes también en **WhatsApp**\n\n❓ **¿En qué puedo ayudarte?**",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -6688,
        2912
      ],
      "id": "1bb324eb-1cc3-4562-985e-5a6b865d13ab",
      "name": "Mensaje de Inicio",
      "webhookId": "bienvenida-webhook-12345"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Datos').item.json.chat_id }}",
        "text": "=✅ Usuario \"{{ $('Ajustar Login Si Necesario').item.json.user_name || 'Usuario' }}\" validado correctamente.\n\n👤 **Usuario Odoo creado:**\n🔑 Login: `{{ $('Ajustar Login Si Necesario').item.json.odoo_user_final }}`\n\n✅ Se le ha enviado sus credenciales y se ha creado su acceso al portal.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -9664,
        2752
      ],
      "id": "8b9ef756-26db-4e49-bc09-6ae5c767d140",
      "name": "Confirmar al Admin",
      "webhookId": "5ceb27f3-034e-44b8-bf0e-3cb33700551f"
    },
    {
      "parameters": {
        "content": "## Comprobar que es Admin y validar usuarios mediante el comando \"validar (nombre usuario)\"",
        "height": 496,
        "width": 1488,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -12384,
        2736
      ],
      "id": "5a567d8e-ba88-4874-b814-ad4e0d266798",
      "name": "Sticky Note23"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, user_name, chat_id\nFROM public.telegram_users\nWHERE is_active = true\n  AND COALESCE(usuario_valido, false) = true\nORDER BY last_seen DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -11184,
        4800
      ],
      "id": "324272e4-050e-4b9c-824a-298a9966f99b",
      "name": "Consultar Usuarios Registrados y Validados",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT user_id, user_name, chat_id\nFROM public.telegram_users\nWHERE is_active = true\n  AND COALESCE(usuario_valido, false) = true\nORDER BY last_seen DESC;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -11120,
        5232
      ],
      "id": "87cbbd34-8b0c-4a4e-907d-18207aaa0121",
      "name": "Consultar Usuarios Registrados y Validados Semanal"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  user_id,\n  user_name,\n  chat_id,\n  odoo_user,\n  user_mail,\n  direccion_calle,\n  codigo_postal,\n  poblacion,\n  provincia,\n  pais\nFROM telegram_users\nWHERE (chat_id = $1 OR user_id = $1)\nLIMIT 1;\n",
        "options": {
          "queryReplacement": "={{ [ parseInt($('Obtener Chat ID').item.json.chat_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -5120,
        3376
      ],
      "id": "930a6278-c4ee-473f-8c81-1319c2a7fe1c",
      "name": "Cargar Perfil Usuario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1904,
        16080
      ],
      "id": "7e1683ce-27c3-4883-930f-22a982d24661",
      "name": "HTTP Buscar Plantilla"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1520,
        16080
      ],
      "id": "0b87333f-af7a-4998-bc22-0919910a86cb",
      "name": "HTTP Buscar Variante por Plantilla"
    },
    {
      "parameters": {
        "jsCode": "// Recorre todos los items de entrada y empareja por índice con \"Preparar Operación\"\nconst bases = $items('Preparar Operación', 0);\n\nreturn items.map((it, idx) => {\n  const base = bases[idx]?.json;\n  if (!base) {\n    return { json: { error: true, mensaje_error: `No hay base emparejada en índice ${idx} desde \"Preparar Operación\"` } };\n  }\n\n  let pickingId = it.json?.result ?? it.json?.body?.result;\n  if (Array.isArray(pickingId)) pickingId = pickingId[0];\n\n  // Si no es un picking (p.ej. stock.scrap), no requiere validación\n  if (String(base.modelo) !== 'stock.picking') {\n    return { json: { ...base, creado_id: pickingId, requiere_validacion: false } };\n  }\n\n  const confirm_payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [ base.db, base.uid, base.admin_password || 'admin', 'stock.picking', 'action_confirm', [[pickingId]] ],\n    },\n    id: Math.floor(Math.random() * 1e6),\n  };\n\n  const validate_payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [ base.db, base.uid, base.admin_password || 'admin', 'stock.picking', 'button_validate', [[pickingId]] ],\n    },\n    id: Math.floor(Math.random() * 1e6),\n  };\n\n  return {\n    json: {\n      ...base,\n      creado_id: pickingId,\n      requiere_validacion: true,\n      confirm_payload,\n      validate_payload,\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        16544
      ],
      "id": "bdc6db91-d8ab-4e25-bb51-d4874f79bbfb",
      "name": "Preparar Validación Picking"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.confirm_payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        608,
        16432
      ],
      "id": "0ab350a0-13cd-42b4-8aa4-f1b42e0d66bc",
      "name": "HTTP Confirmar Picking"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1040,
        16432
      ],
      "id": "edac50db-8027-4772-bfc8-b3443569baf1",
      "name": "HTTP Validar Picking"
    },
    {
      "parameters": {
        "jsCode": "// Por item, emparejado con \"Preparar Validación Picking\"\nconst base = $items('Preparar Validación Picking', 0)[$itemIndex]?.json;\nif (!base) throw new Error('No hay base emparejada desde Preparar Validación Picking');\n\nconst res = $json;\nconst action = res.body?.result || res.result || null;\n\nif (action && action.res_model === 'stock.immediate.transfer' && action.res_id) {\n  const process_payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [ base.db, base.uid, base.admin_password || 'admin', 'stock.immediate.transfer', 'process', [[action.res_id]] ],\n    },\n    id: Math.floor(Math.random()*1e6),\n  };\n  return { ...base, requiere_process: true, process_payload, creado_id: base.creado_id };\n}\n\nreturn { ...base, requiere_process: false, creado_id: base.creado_id };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1264,
        16432
      ],
      "id": "ee0ce836-0920-494e-92d8-dd768981102c",
      "name": "Resolver Validación1"
    },
    {
      "parameters": {
        "jsCode": "// Ejecutar \"Run Once for All Items\"\n\n// Items emparejados por índice\nconst bases   = $items('Preparar Operación', 0);                // contexto de cada producto\nconst creados = ($items('HTTP Crear Operación', 0) || []);      // respuestas de create\nconst ins     = items;                                          // entrada inmediata (p.ej. de \"Preparar Validación Picking\")\n\nfunction getIdFinal(i) {\n  let id = ins[i]?.json?.creado_id ?? ins[i]?.json?.result ?? creados[i]?.json?.result;\n  if (Array.isArray(id)) id = id[0];\n  return id;\n}\n\nconst out = bases.map((bIt, i) => {\n  const b = bIt?.json;\n  if (!b) throw new Error(`Sin base en índice ${i} desde \"Preparar Operación\"`);\n\n  const idFinal = getIdFinal(i);\n\n  const productLink = `${b.base_url}/web#id=${b.producto.id}&model=product.product&view_type=form`;\n  const opLink      = `${b.base_url}/web#id=${idFinal}&model=${b.modelo}&view_type=form`;\n\n  const esConsumo = /^(consumir|gastar|salida)$/.test(String(b.action||'').toLowerCase());\n\n  const texto = esConsumo\n    ? `✅ Consumo registrado: -${b.quantity} de ${b.producto.name}\\n🧩 Operación: stock.scrap (ID: ${idFinal})\\n🔗 Operación: [Abrir](${opLink})\\n🧾 Producto: [Abrir](${productLink})`\n    : `✅ Reposición registrada: +${b.quantity} de ${b.producto.name}\\n📦 Picking entrada (ID: ${idFinal})\\n🔗 Picking: [Abrir](${opLink})\\n🧾 Producto: [Abrir](${productLink})`;\n\n  return {\n    json: {\n      chat_id: b.chat_id,\n      texto,\n      producto_id: b.producto.id,\n      operacion_id: idFinal,\n      modelo: b.modelo,\n    }\n  };\n});\n\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2016,
        16432
      ],
      "id": "22d3ed08-750f-4b25-891d-14cc50f86bc5",
      "name": "Formatear Respuesta1"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2224,
        16432
      ],
      "id": "bffb57d4-cde9-46ba-9abc-bc5c9b4570bc",
      "name": "Confirmar FSM1",
      "webhookId": "bbd35f7a-560a-48ef-b8b4-c1103287982b"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "6b92a03b-9590-4f24-9257-a6e01055bc4b",
              "leftValue": "={{ $json.requiere_validacion }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        368,
        16544
      ],
      "id": "f2648cdd-6820-46db-acc6-b33ad70ecbc7",
      "name": "¿Requiere Validación?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "57b2f6b1-ff06-4bed-986e-38e61d440589",
              "leftValue": "={{ $json.requiere_process }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1472,
        16432
      ],
      "id": "e9353848-c5e9-45ce-b532-976640f703f8",
      "name": "¿Hay Wizard De Transferencia?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1120,
        16080
      ],
      "id": "e6b7f878-2d29-4b4b-97d4-68a286cb9c3b",
      "name": "HTTP Buscar Producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ ({ jsonrpc:'2.0', method:'call', params:{ service:'object', method:'execute_kw', args:[ $json.db, $json.uid, 'admin', 'stock.location', 'search_read', [ [ ['usage','=','internal'] ] ], { fields:['id','complete_name'], limit:1 } ] }, id: Math.floor(Math.random()*1e6) }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -864,
        16320
      ],
      "id": "d8dcf61b-4858-4f6c-9e0b-e6ac2c70cc35",
      "name": "HTTP Ubicación Interna"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ ({ jsonrpc:'2.0', method:'call', params:{ service:'object', method:'execute_kw', args:[ $json.db, $json.uid, 'admin', 'stock.location', 'search_read', [ [ ['usage','=','supplier'] ] ], { fields:['id','complete_name'], limit:1 } ] }, id: Math.floor(Math.random()*1e6) }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -864,
        16496
      ],
      "id": "5c6ae49b-9511-4f40-9495-6e98d9001c8c",
      "name": "HTTP Ubicación Proveedor"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ ({ jsonrpc:'2.0', method:'call', params:{ service:'object', method:'execute_kw', args:[ $json.db, $json.uid, 'admin', 'stock.picking.type', 'search_read', [ [ ['code','=','incoming'] ] ], { fields:['id','name'], limit:1 } ] }, id: Math.floor(Math.random()*1e6) }) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -864,
        16688
      ],
      "id": "9f18c76f-56c6-4735-975c-3426f94836ef",
      "name": "HTTP PickingType Entrada"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        0,
        16384
      ],
      "id": "b0cde51e-737f-4a15-b9c9-b19d2ac67f1f",
      "name": "HTTP Crear Operación"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.process_payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1680,
        16416
      ],
      "id": "361fcb06-dd6c-45a8-b69e-2e81f2b445d7",
      "name": "HTTP Procesar Transfer"
    },
    {
      "parameters": {
        "jsCode": "// RUN ONCE FOR ALL ITEMS — fan-out desde Preparar FSM Inventario (o Preparar FSM)\nconst S = v => v == null ? '' : String(v);\nconst getFSMItems = () => {\n  const a = $items('Preparar FSM Inventario', 0).map(i => i.json);\n  if (a.length) return a;\n  return $items('Preparar FSM', 0).map(i => i.json);\n};\nconst fsmItems = getFSMItems();\n\nfunction buildDomain(nameRaw){\n  const name = S(nameRaw).trim();\n  if (!name) return [['id','=',-1]]; // evita búsquedas vacías\n  const tokens = name.toLowerCase().split(/\\s+/).filter(Boolean);\n  const singular = w => w.endsWith('es') ? w.slice(0,-2) : (w.endsWith('s') ? w.slice(0,-1) : w);\n  const tokensSing = tokens.map(singular);\n  const andFlat = arr => arr.length<=1 ? arr.slice() : Array(arr.length-1).fill('&').concat(arr);\n  const orFlat  = arrs => arrs.length<=1 ? (arrs[0]||[]) : Array(arrs.length-1).fill('|').concat(...arrs);\n  const leavesTokens = tokens.map(t => ['name','ilike', t]);\n  const leavesSing   = tokensSing.map(t => ['name','ilike', t]);\n  const domainFlat = orFlat([\n    andFlat(leavesTokens).length ? [ ...andFlat(leavesTokens) ] : [],\n    andFlat(leavesSing).length   ? [ ...andFlat(leavesSing) ]   : [],\n    [ ['name','ilike', name] ],\n    [ ['default_code','ilike', name] ],\n    [ ['product_variant_ids.default_code','ilike', name] ],\n    [ ['product_variant_ids.barcode','ilike', name] ],\n  ].filter(a => a.length));\n  return domainFlat.length ? domainFlat : [['id','=',-1]];\n}\n\nfunction buildPayload(fsm){\n  const db = S(fsm.db);\n  const uid = Number(fsm.uid);\n  const admin = fsm.admin_password || 'admin';\n  const domain = buildDomain(fsm.product_name);\n  return {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        db || '', Number.isFinite(uid) ? uid : 0, admin,\n        'product.template','search_read',\n        [ domain ],\n        { fields: ['id','name'], limit: 10, context: { lang: 'es_ES' } }\n      ]\n    },\n    id: Math.floor(Math.random()*1e6),\n  };\n}\n\n// Emitimos un item por cada producto (con passthrough del contexto bueno)\nreturn fsmItems.map(fsm => ({ ...fsm, payload: buildPayload(fsm) }));\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2096,
        16080
      ],
      "id": "32eff351-538f-40ae-8b1a-ff9462f40503",
      "name": "Payload Buscar Plantilla"
    },
    {
      "parameters": {
        "jsCode": "// PER-ITEM: por cada resultado de \"HTTP Buscar Plantilla\" genera su payload a product.product\nconst S = v => v == null ? '' : String(v);\n\nreturn items.map((item, i) => {\n  // Resultado del HTTP Buscar Plantilla para ESTE item\n  const httpRes = item.json;\n  const tmplRes = Array.isArray(httpRes.result) ? httpRes.result : [];\n  const tmplIds = tmplRes.map(r => Number(r.id)).filter(Number.isFinite);\n\n  // Contexto del FSM alineado por índice\n  const fsm = $items('Preparar FSM Inventario', 0)[i]?.json\n           || $items('Preparar FSM', 0)[i]?.json\n           || {};\n  const db    = S(fsm.db);\n  const uid   = Number(fsm.uid);\n  const admin = fsm.admin_password || 'admin';\n\n  // Dominio: product_tmpl_id = id (o OR en prefija)\n  let domain;\n  if (tmplIds.length === 0) {\n    domain = [['id','=',-1]]; // dominio imposible: no hay plantillas\n  } else if (tmplIds.length === 1) {\n    domain = [['product_tmpl_id','=', tmplIds[0]]];\n  } else {\n    let expr = ['product_tmpl_id','=', tmplIds[0]];\n    for (let j = 1; j < tmplIds.length; j++) expr = ['|', expr, ['product_tmpl_id','=', tmplIds[j]]];\n    domain = [expr];\n  }\n\n  const payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        db || '', Number.isFinite(uid) ? uid : 0, admin,\n        'product.product', 'search_read',\n        [ domain ],\n        { fields: ['id','name','uom_id','default_code','barcode','product_tmpl_id'], limit: 50, context: { lang: 'es_ES' } }\n      ]\n    },\n    id: Math.floor(Math.random() * 1e6),\n  };\n\n  // Passthrough del contexto para los siguientes nodos\n  return { ...fsm, payload, skip_search: tmplIds.length === 0 };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1696,
        16080
      ],
      "id": "0f1e1e19-06dd-4c7a-ba68-71cc9b3e0c4b",
      "name": "Payload Buscar Variante por Plantilla"
    },
    {
      "parameters": {
        "jsCode": "// Soporta: múltiples items de entrada y/o un item con \"productos\"[]\n// Genera SIEMPRE 1 item por producto\n\nconst S = (v) => (v == null ? '' : String(v));\nconst norm = (s) => S(s).normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').toLowerCase();\n\n// Entradas (uno o varios items)\nconst inItems = (Array.isArray(items) && items.length) ? items.map(i => i.json) : [$json];\n\nfunction computeForOne(d0){\n  const d = d0 || {};\n  const msg = norm(d.mensaje_usuario || d.mensaje_original || d.respuesta_usuario || '');\n\n  // Acción → {consumir|reponer}\n  const rawAct = S(d.action);\n  const detected = rawAct || (/(consum|gast|salid|descuent|baja)/.test(msg) ? 'consumir' : (/(rep|entrad|abon|repos)/.test(msg) ? 'reponer' : ''));\n  const actionNorm = /^(consumir|gastar|salida|consumo|baja)$/i.test(detected) ? 'consumir' : 'reponer';\n\n  // Horas\n  let hours = null;\n  { const m = msg.match(/(\\d+(?:[.,]\\d+)?)\\s*(?:h|hora|horas)\\b/); if (m) hours = parseFloat(m[1].replace(',', '.')); }\n\n  // Obra\n  let work_label = '';\n  { let m = msg.match(/\\bobra(?:\\s+de(?:l| la)?)?\\s+([a-z0-9\\s\\-_.]+)/);\n    if (m) work_label = m[1].trim();\n    if (!work_label) { const m2 = msg.match(/\\ben\\s+la\\s+([a-z0-9\\s\\-_.]+)/); if (m2) work_label = m2[1].trim(); } }\n\n  // Warehouse hint\n  const sw = $('Switch Acciones'); // si existe\n  const swJson = (sw && sw.item && sw.item.json) ? sw.item.json : {};\n  let force_loc_id = null;\n  if (swJson.location_id != null) { const n = Number(swJson.location_id); if (Number.isFinite(n) && n > 0) force_loc_id = n; }\n\n  let warehouse_hint = S(d.warehouse_hint || d.almacen || d['almacén'] || swJson.warehouse_hint || swJson.almacen || swJson.code || swJson.name).trim();\n  if (!warehouse_hint) {\n    if (/\\balmacen\\s+(principal|central)\\b/.test(msg)) warehouse_hint = 'principal';\n    else {\n      const rawText = S(d.mensaje_original || d.respuesta_usuario || d.mensaje_usuario || '');\n      const codeMatch = rawText.match(/\\balmac[eé]n\\s+([A-Za-z0-9/_-]{1,15})\\b/) ||\n                        rawText.match(/\\b(?:del|desde|de|en)\\s+([A-Za-z0-9/_-]{1,15})\\b/) ||\n                        rawText.match(/\\b(WH[0-9A-Za-z/]*)\\b/i);\n      if (codeMatch) warehouse_hint = codeMatch[1].trim();\n    }\n  }\n  if (!warehouse_hint) warehouse_hint = 'principal';\n\n  // Productos de este d: (1) usar d.productos[] si existe; (2) si no, usar product_name/cantidad; (3) si no, intentar parseo básico del texto\n  let productos = Array.isArray(d.productos) ? d.productos.slice() : [];\n  if (!productos.length) {\n    const pn = S(d.product_name || d.producto || d.product).trim();\n    const qty = Number(d.quantity ?? d.cantidad ?? d.unidades ?? 1) || 1;\n    if (pn) productos.push({ nombre: pn, cantidad: qty });\n  }\n  if (!productos.length && S(d.mensaje_original || d.mensaje_usuario || '').trim()) {\n    const raw = S(d.mensaje_original || d.mensaje_usuario || '').trim();\n    const partes = raw.split(/\\s*(?:,|;|\\by\\b|\\be\\b)\\s*/i).filter(Boolean);\n    for (const parte of partes) {\n      let m = parte.match(/^\\s*(\\d+(?:[.,]\\d+)?)\\s+(.+?)\\s*$/i);\n      if (m) { const cantidad = Number(m[1].replace(',', '.')) || 1; const nombre = m[2].replace(/^de\\s+/i,'').trim(); if (nombre) productos.push({ nombre, cantidad }); continue; }\n      m = parte.match(/\\b(?:un|una|1)?\\s*(\\w+)\\s+de\\s+(.+)$/i);\n      if (m) { const nombre = `${m[1]} ${m[2]}`.trim(); if (nombre) productos.push({ nombre, cantidad: 1 }); continue; }\n      const nombreSolo = parte.trim(); if (nombreSolo) productos.push({ nombre: nombreSolo, cantidad: 1 });\n    }\n  }\n\n  if (!d.base_url || !d.db || !d.uid) throw new Error('Faltan credenciales/base_url/db/uid');\n  if (!productos.length) throw new Error('No se recibieron productos');\n\n  // Base común para este item d\n  const base = {\n    base_url: d.base_url,\n    db: d.db,\n    uid: d.uid,\n    chat_id: d.chat_id,\n    has_time: Number.isFinite(hours) && hours > 0,\n    hours: Number.isFinite(hours) ? hours : 0,\n    work_label,\n    action: actionNorm,\n    warehouse_hint,\n    force_loc_id,\n    admin_password: d.admin_password || 'admin',\n    user_id: d.user_id,\n    user_name: d.user_name,\n  };\n\n  // Emitir 1 salida por producto\n  return productos.map(p => {\n    const nombre = S(p.nombre || p.producto || p.name).trim();\n    const cantidad = Number(p.cantidad ?? p.quantity ?? 1) || 1;\n    if (!nombre) throw new Error('Producto sin nombre');\n    return { ...base, has_stock: true, product_name: nombre, quantity: cantidad };\n  });\n}\n\n// Aplanar todos los productos de todos los items de entrada\nconst out = inItems.flatMap(d => computeForOne(d));\n\n// Devolver un ARRAY de objetos (uno por producto)\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2736,
        16080
      ],
      "id": "1eb0d86d-e58f-4515-9985-4d97f0544121",
      "name": "Preparar FSM"
    },
    {
      "parameters": {
        "jsCode": "// Genera UN payload por item y conserva el contexto bueno (db/uid/etc) desde el FSM por índice\nconst S = v => v == null ? '' : String(v);\n\nreturn items.map(({ json }, idx) => {\n  // ← Contexto correcto alineado por índice\n  const fsm = ($items('Preparar FSM Inventario', 0)[idx]?.json)\n           || ($items('Preparar FSM', 0)[idx]?.json)\n           || {};\n  const base = { ...fsm }; // usamos el FSM como base (no el json del HTTP)\n\n  const db   = S(base.db);\n  const uid  = Number(base.uid);\n  const admin_password = base.admin_password || 'admin';\n  const raw  = S(base.product_name).trim();\n\n  if (!db || !Number.isFinite(uid)) throw new Error(`Faltan db/uid en Payload Buscar Producto [idx ${idx}]`);\n  if (!raw) return { ...base, error: true, mensaje_error: 'Nombre de producto vacío' };\n\n  // Leer plantillas emparejadas por índice desde \"HTTP Buscar Plantilla\"\n  let tmplIds = [];\n  try {\n    const hp = $items('HTTP Buscar Plantilla', 0)[idx]?.json?.result;\n    if (Array.isArray(hp) && hp.length) {\n      tmplIds = hp.map(r => Number(r.id)).filter(n => Number.isFinite(n));\n    }\n  } catch (_) {}\n\n  // Helper OR '=' plano\n  const buildOrEquals = (field, values) => {\n    if (!values.length) return [];\n    let expr = [field, '=', values[0]];\n    for (let i = 1; i < values.length; i++) expr = ['|', expr, [field, '=', values[i]]];\n    return expr;\n  };\n\n  // Si hay plantillas → variantes por product_tmpl_id\n  if (tmplIds.length) {\n    const domain = [ buildOrEquals('product_tmpl_id', tmplIds) ];\n    const payload = {\n      jsonrpc: '2.0',\n      method: 'call',\n      params: {\n        service: 'object',\n        method: 'execute_kw',\n        args: [\n          db, uid, admin_password,\n          'product.product', 'search_read',\n          [ domain ],\n          { fields: ['id','name','uom_id','default_code','barcode','product_tmpl_id'], limit: 50, context: { lang: 'es_ES' } }\n        ],\n      },\n      id: Math.floor(Math.random()*1e6),\n    };\n    return { ...base, payload };\n  }\n\n  // Si NO hay plantillas → dominio por tokens/ilike\n  const term   = raw;\n  const tokens = term.toLowerCase().split(/\\s+/).filter(Boolean);\n  const singular = w => w.endsWith('es') ? w.slice(0,-2) : (w.endsWith('s') ? w.slice(0,-1) : w);\n  const tokensSing = tokens.map(singular);\n\n  const buildAndFlat = (conds) => conds.length <= 1 ? conds.slice() : Array(conds.length - 1).fill('&').concat(conds);\n  const buildOrFlat  = (ops)   => ops.length <= 1 ? (ops[0] || []) : Array(ops.length - 1).fill('|').concat(...(ops));\n\n  const leavesTokens = tokens.map(t => ['name','ilike', t]);\n  const leavesSing   = tokensSing.map(t => ['name','ilike', t]);\n\n  const andTokensFlat = buildAndFlat(leavesTokens);\n  const andSingFlat   = buildAndFlat(leavesSing);\n\n  const codeLeaf     = ['default_code','ilike', term];\n  const barcodeLeaf  = ['barcode','ilike', term];\n  const fullNameLeaf = ['name','ilike', term];\n\n  const domainFlat = buildOrFlat([\n    andTokensFlat.length ? [ ...andTokensFlat ] : [],\n    andSingFlat.length   ? [ ...andSingFlat ]   : [],\n    [ codeLeaf ],\n    [ barcodeLeaf ],\n    [ fullNameLeaf ],\n  ].filter(a => a.length));\n\n  const finalDomain = domainFlat.length ? domainFlat : [['id','=',-1]];\n\n  const payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        db, uid, admin_password,\n        'product.product', 'search_read',\n        [ finalDomain ],\n        { fields: ['id','name','uom_id','default_code','barcode','product_tmpl_id'], limit: 20, context: { lang: 'es_ES' } }\n      ],\n    },\n    id: Math.floor(Math.random()*1e6),\n  };\n\n  return { ...base, payload };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1312,
        16080
      ],
      "id": "578be864-c0d9-4a16-a73e-d533adeb85c6",
      "name": "Payload Buscar Producto"
    },
    {
      "parameters": {
        "jsCode": "// Ejecutar este nodo en \"Run once for all items\"\n\n// 1) Trae TODOS los items de productos resueltos\nconst bases = $items('Resolver Coincidencias Producto', 0).map(i => i.json);\n\n// 2) Las ubicaciones suelen venir como 1 solo item por nodo HTTP → toma la primera\nconst hInt  = $items('HTTP Ubicación Interna', 0)[0]?.json?.result?.[0] || null;\nconst hSup  = $items('HTTP Ubicación Proveedor', 0)[0]?.json?.result?.[0] || null;\nconst hPick = $items('HTTP PickingType Entrada', 0)[0]?.json?.result?.[0] || null;\nconst hWh   = $items('HTTP Buscar Almacén', 0)[0]?.json?.result?.[0] || null;\nconst hScr  = $items('HTTP Ubicación Scrap', 0)[0]?.json?.result?.[0] || null;\n\n// 3) Calcula la ubicación interna (WH/Stock) priorizando el lot_stock_id del almacén\nlet locInt = hInt;\nif (hWh && Array.isArray(hWh.lot_stock_id)) {\n  locInt = { id: hWh.lot_stock_id[0], complete_name: 'Almacén principal' };\n}\n\nconst locSup   = hSup;\nconst pickIn   = hPick;\nconst locScrap = hScr;\n\n// 4) Validación mínima\nif (!locInt) throw new Error('No se encontró ubicación interna (WH/Stock)');\n\n// 5) Construye una salida por CADA producto (item) alineando por índice\nconst out = bases.map((base) => {\n  const action = String(base.action || '').toLowerCase();\n  const isConsumo = /(consumir|gastar|salida)/.test(action);\n\n  if (!base?.producto?.id) {\n    return {\n      ...base,\n      error: true,\n      mensaje_error: 'Producto no resuelto en Resolver Coincidencias Producto',\n    };\n  }\n\n  if (isConsumo) {\n    if (!locScrap) {\n      return { ...base, error: true, mensaje_error: 'No se encontró ubicación Scrap (Virtual Locations/Scrap)' };\n    }\n    const payload = {\n      jsonrpc: '2.0',\n      method: 'call',\n      params: {\n        service: 'object',\n        method: 'execute_kw',\n        args: [\n          base.db,\n          base.uid,\n          base.admin_password || 'admin',\n          'stock.scrap',\n          'create',\n          [[{\n            product_id: base.producto.id,\n            scrap_qty: base.quantity,\n            location_id: locInt.id,        // ORIGEN: WH/Stock\n            scrap_location_id: locScrap.id // DESTINO: Virtual Locations/Scrap\n          }]]\n        ]\n      },\n      id: Math.floor(Math.random()*1e6)\n    };\n    return { ...base, locInt, locScrap, payload, modelo: 'stock.scrap' };\n  }\n\n  // Reposición (entrada)\n  if (!locSup || !pickIn) {\n    return { ...base, error: true, mensaje_error: 'No se encontró ubicación proveedor o picking de entrada' };\n  }\n\n  const pickingVals = {\n    picking_type_id: pickIn.id,\n    location_id: locSup.id,\n    location_dest_id: locInt.id,\n    move_ids_without_package: [\n      [0,0,{\n        name: base.producto.name,\n        product_id: base.producto.id,\n        product_uom: Array.isArray(base.producto.uom_id) ? base.producto.uom_id[0] : base.producto.uom_id,\n        product_uom_qty: base.quantity,\n        location_id: locSup.id,\n        location_dest_id: locInt.id\n      }]]\n  };\n\n  const payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        base.db,\n        base.uid,\n        base.admin_password || 'admin',\n        'stock.picking',\n        'create',\n        [[pickingVals]]\n      ]\n    },\n    id: Math.floor(Math.random()*1e6)\n  };\n\n  return { ...base, locInt, locSup, pickIn, payload, modelo: 'stock.picking' };\n});\n\n// 6) SIEMPRE devolver array (un item por producto)\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        16384
      ],
      "id": "5429cb50-6bdd-4f85-b5b8-ceb3156d4c9a",
      "name": "Preparar Operación"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "numberInputs": 5,
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -416,
        16368
      ],
      "id": "8f7d5099-1c4f-4fa5-862c-ea281c0faa71",
      "name": "Merge Ubicaciones"
    },
    {
      "parameters": {
        "jsCode": "// Genera UN payload por item de entrada y conserva el contexto en cada item (passthrough)\nconst S = v => v == null ? '' : String(v);\n\nreturn items.map(({ json }) => {\n  const fsm = json;                         // item actual de \"Preparar FSM\"\n  const hint = S(fsm.warehouse_hint || 'principal').trim();\n  const domain = ['|', ['name','ilike', hint], ['code','ilike', hint]];\n\n  const body = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        fsm.db, fsm.uid, (fsm.admin_password || 'admin'),\n        'stock.warehouse', 'search_read',\n        [ domain ],\n        { fields: ['id','name','code','lot_stock_id'], limit: 1 }\n      ]\n    },\n    id: Math.floor(Math.random() * 1e6),\n  };\n\n  return { ...fsm, payload: body };        // ⬅️ mantenemos db/uid/product_name/etc.\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2512,
        16080
      ],
      "id": "54b1ce2f-b31a-4b80-9a46-dbe31c0226ab",
      "name": "Payload Buscar Almacén"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2304,
        16080
      ],
      "id": "ff8e2a58-101f-4834-bdb4-cf788b7d7549",
      "name": "HTTP Buscar Almacén"
    },
    {
      "parameters": {
        "jsCode": "// Toma el item emparejado que salió de \"Preparar Validación Picking\"\nconst base = $items('Preparar Validación Picking', 0)[$itemIndex]?.json;\nif (!base) throw new Error(`No hay item emparejado desde \"Preparar Validación Picking\" en índice ${$itemIndex}`);\n\nconst validate = base.validate_payload;\nif (!validate) throw new Error('No se encontró validate_payload en este item');\n\nreturn { payload: validate };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        816,
        16432
      ],
      "id": "ce713505-89ec-4a71-a989-1cdf9743aba4",
      "name": "Pasar a Validar Picking"
    },
    {
      "parameters": {
        "jsCode": "// Procesa TODOS los items que llegan del \"HTTP Buscar Producto\" y alinea por índice\nconst norm = (s) => (s || '').normalize('NFD').replace(/[\\u0300-\\u036f]/g, '').toLowerCase();\n\n// Items de entrada (cada uno es la respuesta de Odoo para un producto)\nconst inItems = $items();  // los items que llegan a este nodo\n\n// Contexto emparejado por índice desde \"Payload Buscar Producto\"\nconst ctxItems = $items('Payload Buscar Producto', 0);\n\n// Por cada item de entrada, resolvemos el producto y devolvemos un item de salida\nconst out = inItems.map((it, i) => {\n  const base = ctxItems[i]?.json || {};\n  const results = Array.isArray(it.json.result) ? it.json.result : [];\n  const buscado = String(base.product_name || '').trim();\n  const nb = norm(buscado);\n\n  // Scoring simple\n  const scored = results.map(p => {\n    const n = norm(p.name);\n    let score = 0;\n    if (n === nb) score = 100;\n    else if (n.startsWith(nb)) score = 70;\n    else if (n.includes(nb)) score = 50;\n    return { p, score };\n  }).sort((a,b) => b.score - a.score);\n\n  const top   = scored.filter(s => s.score > 0).map(s => s.p);\n  const exact = scored.find(s => s.score === 100)?.p || null;\n\n  if (exact) {\n    return { ...base, producto: exact, coincidencias: [], requiere_correccion: false };\n  }\n  if (top.length === 1) {\n    return { ...base, producto: top[0], coincidencias: [], requiere_correccion: false };\n  }\n\n  const sugerencias = results.slice(0, 5).map((p, idx) => `${idx+1}. ${p.name}`);\n  const texto = results.length === 0\n    ? `❌ No encontré \"${buscado}\".\\nEscribe el nombre correcto del producto.`\n    : `🔎 No encontré coincidencia exacta para \"${buscado}\".\\nPosibles:\\n${sugerencias.join('\\n')}\\n\\nResponde con el nombre correcto (o copia/pega una sugerencia).`;\n\n  return {\n    ...base,\n    requiere_correccion: true,\n    coincidencias: results.slice(0, 10),\n    mensaje_sugerencias: texto,\n    producto_buscado: buscado,\n  };\n});\n\n// SIEMPRE devolver un array (un item por producto)\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -880,
        16080
      ],
      "id": "2bab44a1-7f91-4aed-834f-073ecc58b5c1",
      "name": "Resolver Coincidencias Producto"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c635ad67-5cc2-49f3-b62e-7b5de2f47d0a",
              "leftValue": "={{ $json.requiere_correccion }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -704,
        16080
      ],
      "id": "8ba6281a-f80d-41bc-aa9b-3ee5c76632dd",
      "name": "¿Requiere Corrección Producto?"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Memoria FSM Inventario para corrección de producto\n// Lee user_name y user_id desde 'Preparar FSM Inventario'\nconst src = $('Preparar FSM Inventario').first()?.json || {};\nconst d = { ...src, ...$json };\n\nconst esperando_confirmacion = 'fsm_inventario_correccion_producto';\nconst ultimo_mensaje_bot = d.mensaje_sugerencias || 'Indica el nombre correcto del producto.';\n\n// Compactar coincidencias a nombres\nconst coincidenciasNombres = Array.isArray(d.coincidencias)\n  ? d.coincidencias.map(c => (typeof c === 'string' ? c : (c?.name || ''))).filter(Boolean)\n  : [];\n\nconst datos_pendientes = {\n  contexto: 'fsm_inventario',\n  action: d.action || 'reponer',\n  warehouse_hint: d.warehouse_hint || 'principal',\n  producto_buscado: d.producto_buscado || d.product_name || '',\n  coincidencias: coincidenciasNombres.slice(0, 10),\n  base_url: d.base_url,\n  db: d.db,\n  uid: d.uid,\n  admin_password: d.admin_password || 'admin',\n  quantity: Number(d.quantity || 1) || 1,\n  timestamp: new Date().toISOString(),\n};\n\nreturn {\n  chat_id: Number(d.chat_id) || 0,\n  user_id: Number(d.user_id || src.user_id) || 0,\n  user_name: (d.user_name || src.user_name || 'Usuario'),\n  esperando_confirmacion,\n  ultimo_mensaje_bot,\n  datos_pendientes,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        15984
      ],
      "id": "9c74d939-9f08-4892-897a-40109b7b8fca",
      "name": "Preparar Memoria FSM Inventario"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Usuario',\n  'fsm_inventario_correccion_producto',\n  $json.ultimo_mensaje_bot || $json.texto_confirmacion,\n  JSON.stringify($json.datos_pendientes || {}),\n  'Confirmación pedido de venta',\n  JSON.stringify([]),\n  JSON.stringify([\n    { tipo: 'bot', contenido: ($json.ultimo_mensaje_bot || $json.texto_confirmacion), timestamp: new Date().toISOString() }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -288,
        15984
      ],
      "id": "27dfbcfe-a543-48f0-9075-2f0ec2b65adb",
      "name": "Guardar Memoria FSM Inventario"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Memoria FSM Inventario').item.json.chat_id }}",
        "text": "={{ $('Preparar Memoria FSM Inventario').item.json.ultimo_mensaje_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -64,
        15984
      ],
      "id": "813275cc-0101-4aca-9586-8238a76b6e24",
      "name": "Sugerencia Productos Encontrados",
      "webhookId": "bbd35f7a-560a-48ef-b8b4-c1103287982b"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "  UPDATE n8n SET esperando_confirmacion=NULL, datos_pendientes=NULL, updated_at=NOW()\n  WHERE chat_id=$1 AND esperando_confirmacion='fsm_inventario_correccion_producto'",
        "options": {
          "queryReplacement": "={{ [ Number($json.chat_id) || 0 ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2480,
        16432
      ],
      "id": "e3cfa37d-8716-483f-a0bb-be347e77084e",
      "name": "Limpiar Memoria FSM Inventario"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{JSON.stringify({jsonrpc:'2.0',method:'call',params:{service:'object',method:'execute_kw',args:[$json.db,$json.uid,($json.admin_password||'admin'),'stock.location','search_read',[[['scrap_location','=',true]]],{fields:['id','complete_name'],limit:1}]},id:Math.floor(Math.random()*1e6)})}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -864,
        16864
      ],
      "id": "a3e7cb28-c195-4d29-aff1-37151da3b965",
      "name": "HTTP Ubicación Scrap"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5a227c45-8686-4b8c-9a43-5fa9f8371fd1",
              "leftValue": "={{ Array.isArray($json.result) && $json.result.length > 0 }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1408,
        17456
      ],
      "id": "31a006bf-e5e6-4835-af98-80ce31c7a485",
      "name": "¿Existe Proyecto?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Tarea No Existe FSM').item.json.chat_id }}",
        "text": "=✅ **El proyecto \"{{ $('Guardar Memoria Tarea No Existe FSM').item.json.proyecto }}\" existe.**\n❌ **Pero la tarea \"{{ $('Guardar Memoria Tarea No Existe FSM').item.json.tarea }}\" no existe.**\n\n📋 **Parte de horas pendiente:**\n• **Proyecto:** {{ $('Guardar Memoria Tarea No Existe FSM').item.json.proyecto }} ✅\n• **Tarea:** {{ $('Guardar Memoria Tarea No Existe FSM').item.json.tarea }} ❌\n• **Horas:** {{ $('Guardar Memoria Tarea No Existe FSM').item.json.horas }}\n• **Descripción:** {{ $('Guardar Memoria Tarea No Existe FSM').item.json.descripcion }}\n\n🤔 **¿Quieres que cree la tarea?**\n\nSi dices **\"sí\"**, crearé:\n1️⃣ La tarea \"{{ $('Guardar Memoria Tarea No Existe FSM').item.json.tarea }}\" en el proyecto existente\n2️⃣ El parte de horas automáticamente\n\n**Responde:**\n• **'sí'** para crear la tarea y registrar horas\n• **'no'** para cancelar",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        144,
        17664
      ],
      "id": "82d687bc-fb41-42e7-aea6-cf8a06f508de",
      "name": "Preguntar Crear Tarea Solamente1",
      "webhookId": "1f3260aa-6777-49ea-8879-00370d53e7a4"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Proyecto No Existe FSM').item.json.chat_id }}",
        "text": "=❌ **El proyecto \"{{ $('Guardar Memoria Proyecto No Existe FSM').item.json.proyecto }}\" no existe.**\n\n📋 **Parte de horas pendiente:**\n• **Proyecto:** {{ $('Guardar Memoria Proyecto No Existe FSM').item.json.proyecto }}\n• **Tarea:** {{ $('Guardar Memoria Proyecto No Existe FSM').item.json.tarea }}\n• **Horas:** {{ $('Guardar Memoria Proyecto No Existe FSM').item.json.horas }}\n• **Descripción:** {{ $('Guardar Memoria Proyecto No Existe FSM').item.json.descripcion }}\n\n🤔 **¿Quieres que cree el proyecto completo?**\n\nSi dices **\"sí\"**, crearé:\n1️⃣ El proyecto \"{{ $('Guardar Memoria Proyecto No Existe FSM').item.json.proyecto }}\"\n2️⃣ La tarea \"{{ $('Guardar Memoria Proyecto No Existe FSM').item.json.tarea }}\"\n3️⃣ El parte de horas automáticamente\n\n**Responde:**\n• **'sí'** para crear todo\n• **'no'** para cancelar",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -704,
        17696
      ],
      "id": "70411722-3762-423e-bef0-e99b7b96ca90",
      "name": "Preguntar Crear Proyecto Completo1",
      "webhookId": "c0796c6c-0854-41cc-b48d-6a1fd2478d8a"
    },
    {
      "parameters": {
        "jsCode": "const base = $('Normalizar Parte+Materiales FSM').item.json;\n\n// Recuperar el registro (devuelto por el Code anterior a su HTTP)\nconst reg = $('Registrar Horas Directo FSM')?.item?.json?.registro;\n\n// Fallback: si no hubiera reg, usar la tarea leída por HTTP\nlet taskId = reg?.task_id;\nif (!taskId) {\n  const ht = $('HTTP Buscar Tarea FSM')?.item?.json;\n  const rr = ht?.json?.result ?? ht?.result ?? ht?.body?.result ?? [];\n  if (Array.isArray(rr) && rr[0]) taskId = rr[0].id;\n}\nif (!taskId) return { skip_nota: true, motivo: 'Sin task_id' };\n\n// Si no hay materiales, no publiques nada\nconst productos = Array.isArray(base.productos) ? base.productos : [];\nif (!productos.length) return { skip_nota: true, motivo: 'Sin materiales' };\n\nconst lineas = (Array.isArray(productos) ? productos : [])\n  .map(p => `• ${Number(p.cantidad ?? 1)} × ${String(p.nombre ?? '').trim()}`)\n  .join('\\n');\n\nconst texto = `Materiales usados:\n${lineas}`;\n\n// 🔎 NUEVO: obtener el partner del usuario Odoo (para que el autor sea el usuario correcto)\nlet authorId = null;\nconst respUsuario = $('Buscar Usuario Odoo')?.item?.json;\nif (respUsuario) {\n  const listaUsuarios = respUsuario.result || respUsuario;\n  const usuario = Array.isArray(listaUsuarios) && listaUsuarios.length > 0 ? listaUsuarios[0] : null;\n  if (usuario && Array.isArray(usuario.partner_id) && usuario.partner_id.length > 0) {\n    authorId = usuario.partner_id[0];   // partner_id es [id, \"Nombre\"]\n  }\n}\n\n// uid robusto (seguimos ejecutando como admin)\nlet uid = base.uid;\nconst auth = $('Autenticar Odoo')?.item;\nif (auth?.json?.result) uid = auth.json.result;\n\n// Construimos kwargs para message_post\nconst kwargs = { \n  body: texto, \n  message_type: 'comment', \n  subtype_xmlid: 'mail.mt_note',\n};\n\n// Si tenemos authorId, lo usamos para que la nota aparezca con ese usuario\nif (authorId) {\n  kwargs.author_id = authorId;    // 👈 clave para que el “autor” sea el usuario del perfil\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      base.db, uid, 'admin',\n      'project.task', 'message_post',\n      [[taskId]],   // lista de ids\n      kwargs,       // 👈 usamos el objeto con author_id (si existe)\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn { payload };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        17280
      ],
      "id": "56758475-b50c-4bd6-b807-3fa25225f106",
      "name": "Registrar Materiales"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1152,
        17440
      ],
      "id": "e20822a6-400b-4032-901d-ba648b7034e8",
      "name": "HTTP Registrar Nota Materiales"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        4176,
        17120
      ],
      "id": "fcc2183f-84ba-41b1-a876-a24e0912f1a4",
      "name": "Confirmar Todo",
      "webhookId": "1dadcc74-c513-44a1-88b9-c7aa71c7ec47"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.payload}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1616,
        17456
      ],
      "id": "7966cdd5-e6ef-45a1-8869-e2c250ff47d4",
      "name": "HTTP Buscar Proyecto FSM"
    },
    {
      "parameters": {
        "jsCode": "// Si venimos de buscar proyecto\nconst datosNorm = $('Normalizar Parte+Materiales FSM').item.json;\n\nlet proyecto = null;\n\n// ✅ LEER del HTTP real, no del payload\nconst httpProj = $('HTTP Buscar Proyecto FSM').item?.json;\nif (httpProj && Array.isArray(httpProj.result) && httpProj.result[0]) {\n  proyecto = httpProj.result[0];\n}\n\n// O bien (opcional) si se creó en otro flujo de confirmación\nif (!proyecto) {\n  const created = $('Payload Crear Proyecto FSM')?.tryjson;\n  if (created && Number.isFinite(created.result)) {\n    proyecto = { id: created.result, name: datosNorm.proyecto, is_fsm: true };\n  }\n}\n\nif (!proyecto) {\n  return { error: true, mensaje: 'No hay proyecto FSM', datos_verificacion: datosNorm };\n}\n\n// Fallbacks robustos para DB y UID\nconst DB  = datosNorm.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst UID = datosNorm.uid || ($('Autenticar Odoo')?.item?.json?.result);\nif (!UID) throw new Error('Falta uid (Autenticar Odoo)');\n\n// Normalizar nombre de tarea para búsqueda más flexible\nconst nombreTarea = (datosNorm.tarea || '').trim();\n\nconsole.log('🔍 Buscando tarea FSM en TODAS las compañías:');\nconsole.log('  Nombre a buscar:', nombreTarea);\nconsole.log('  Proyecto ID:', proyecto.id);\nconsole.log('  Proyecto:', proyecto.name);\n\n// Buscar tarea por nombre dentro del proyecto FSM EN TODAS LAS COMPAÑÍAS\nconst body = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      DB, UID, 'admin',\n      'project.task', 'search_read',\n      [[\n        ['name', 'ilike', nombreTarea],\n        ['project_id', '=', proyecto.id],\n        '|',\n        ['company_id', '=', false],  // Sin compañía\n        ['company_id', '!=', false]  // O cualquier compañía\n      ]],\n      { \n        fields: ['id', 'name', 'project_id', 'company_id'], \n        limit: 1,\n        context: { 'allowed_company_ids': [] }  // Buscar en todas las compañías\n      },\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nconsole.log('📋 Buscando tarea en todas las compañías');\nconsole.log('📋 Dominio de búsqueda:', JSON.stringify(body.params.args[4]));\n\nreturn {\n  payload: body,\n  proyecto,\n  datos_verificacion: {\n    ...datosNorm,\n    db: DB,\n    uid: UID,\n    proyecto_id: proyecto.id,\n    proyecto_nombre: proyecto.name,\n    tarea_buscada: nombreTarea\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1120,
        17456
      ],
      "id": "ab88f50e-2ac1-46f3-8521-0d985d575fa4",
      "name": "Preparar Buscar Tarea FSM"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO NO EXISTE (FSM) — Guardar memoria y pedir confirmación\n// Toma datos desde el payload que construiste antes\nconst datos = $('Payload Buscar Proyecto FSM').item.json.datos\n          || $('Normalizar Parte+Materiales FSM').item.json\n          || {};\n\nconst chatId = Number(datos.chat_id || $json.chat_id || 0);\nconst ctxKey = `memoria_${chatId}`;\nconst uid = $('Autenticar Odoo')?.item?.json?.result || datos.uid;\n\nlet memoria = global[ctxKey] || {};\nmemoria.esperando_confirmacion = 'crear_proyecto_completo_fsm';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  accion_original: 'registrar_parte_y_stock',\n  proyecto: datos.proyecto || 'Servicio de campo',\n  tarea: datos.tarea || '',\n  horas: Number(datos.horas || 0),\n  descripcion: datos.descripcion || '',\n  productos: Array.isArray(datos.productos) ? datos.productos : [],\n  cliente: datos.cliente || 'interno',\n  uid\n};\n\nglobal[ctxKey] = memoria;\n\nreturn {\n  chat_id: chatId,\n  proyecto: memoria.datos_pendientes.proyecto,\n  tarea: memoria.datos_pendientes.tarea,\n  horas: memoria.datos_pendientes.horas,\n  descripcion: memoria.datos_pendientes.descripcion,\n  tipo_respuesta: 'proyecto_no_existe_fsm',\n  memoria_actualizada: memoria\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1216,
        17696
      ],
      "id": "1a4639a9-57bc-4183-bbec-5755c42ec38f",
      "name": "Guardar Memoria Proyecto No Existe FSM"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -864,
        17456
      ],
      "id": "1bc1414d-a042-4982-a554-2496d64766c6",
      "name": "HTTP Buscar Tarea FSM"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Marcos',\n  'crear_proyecto_completo_fsm',\n  `❌ El proyecto \"${$json.proyecto}\" no existe. ¿Quieres que cree el proyecto completo?`,\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),\n  `Registro de horas (FSM) en proyecto inexistente: ${$json.proyecto}`,\n  JSON.stringify($json.memoria_actualizada?.historial || []),\n  JSON.stringify([{\n    tipo: 'usuario',\n    contenido: `Registrar ${$json.horas}h en ${$json.proyecto}/${$json.tarea}`,\n    timestamp: new Date().toISOString()\n  },\n  {\n    tipo: 'bot',\n    contenido: `Proyecto \"${$json.proyecto}\" no existe. Esperando confirmación para crear.`,\n    timestamp: new Date().toISOString()\n  }])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -928,
        17696
      ],
      "id": "62b577c9-155d-40ed-b058-b5daacb5073a",
      "name": "Guardar Memoria PostgreSQL Proyecto No Existe FSM"
    },
    {
      "parameters": {
        "jsCode": "// Leer la tarea desde ¿Existe Tarea?\nconst existeTarea = $('¿Existe Tarea?').item.json;\nconst r = existeTarea.result || [];\nconst tarea = Array.isArray(r) && r.length > 0 ? r[0] : null;\n\nif (!tarea) {\n  console.error('ERROR: No se encontro la tarea en nodo Existe Tarea');\n  console.error('Resultado de Existe Tarea:', JSON.stringify(existeTarea, null, 2));\n  throw new Error('No se encontro la tarea para registrar horas');\n}\n\nconsole.log('Tarea encontrada:', tarea);\n\nconst datosNorm = $('Normalizar Parte+Materiales FSM').item.json;\nconst preparaBusqueda = $('Preparar Buscar Tarea FSM').item.json;\nconst proyecto = preparaBusqueda.proyecto;\n\nif (!proyecto) {\n  throw new Error('No se encontro el proyecto');\n}\n\n// Fallbacks robustos\nconst DB  = datosNorm.db || preparaBusqueda.datos_verificacion?.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst UID = datosNorm.uid || preparaBusqueda.datos_verificacion?.uid || ($('Autenticar Odoo')?.item?.json?.result);\n\nif (!UID) throw new Error('Falta uid (Autenticar Odoo)');\n\nconst hoy = new Date().toISOString().split('T')[0];\n\n// 🔎 NUEVO: leer el usuario de Odoo buscado por email\nconst respUsuario = $('Buscar Usuario Odoo').item.json;\nconst listaUsuarios = respUsuario.result || respUsuario;\nconst usuario = Array.isArray(listaUsuarios) && listaUsuarios.length > 0 ? listaUsuarios[0] : null;\n\n// id del res.users (user_id para el parte)\nconst userIdFromPerfil = usuario ? usuario.id : null;\n\n// Construimos el diccionario de valores del parte\nconst valoresParte = {\n  name: datosNorm.descripcion || `Trabajo en ${tarea.name}`,\n  project_id: proyecto.id,\n  task_id: tarea.id,\n  unit_amount: Number(datosNorm.horas || 0),\n  date: hoy,\n};\n\n// Si tenemos user_id de Odoo, lo añadimos\nif (userIdFromPerfil) {\n  valoresParte.user_id = userIdFromPerfil;  // <-- este será el usuario que se verá en Odoo\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      DB, UID, 'admin',           // seguimos autenticando como admin\n      'account.analytic.line', 'create',\n      [[ valoresParte ]],         // 👈 aquí usamos valoresParte (NO cambia la lógica, solo el objeto)\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  payload,\n  registro: {\n    chat_id: datosNorm.chat_id,\n    proyecto: proyecto.name,\n    tarea: tarea.name,\n    horas: Number(datosNorm.horas || 0),\n    descripcion: datosNorm.descripcion || '',\n    task_id: tarea.id,\n    odoo_user: datosNorm.odoo_user || null,\n    odoo_user_id: userIdFromPerfil || null,\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        560,
        17280
      ],
      "id": "e01981cc-fd52-4eee-83f8-1a01ecd01840",
      "name": "Registrar Horas Directo FSM"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        800,
        17280
      ],
      "id": "92ef6d43-3324-46ce-bb08-be4f402cba9b",
      "name": "HTTP Registrar Horas Directo FSM"
    },
    {
      "parameters": {
        "jsCode": "// TAREA NO EXISTE (FSM) — Guardar memoria y pedir confirmación\nconst ref = $('Preparar Buscar Tarea FSM').item.json;\nconst datos = ref?.datos_verificacion || $('Normalizar Parte+Materiales FSM').item.json || {};\nconst chatId = Number(datos.chat_id || 0);\nconst ctxKey = `memoria_${chatId}`;\n\nlet memoria = global[ctxKey] || {};\nmemoria.esperando_confirmacion = 'crear_tarea_solamente_fsm';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  accion_original: 'registrar_parte_y_stock',\n  proyecto: datos.proyecto_nombre || datos.proyecto || 'Servicio de campo',\n  proyecto_id: datos.proyecto_id,\n  tarea: datos.tarea || '',\n  horas: Number(datos.horas || 0),\n  descripcion: datos.descripcion || '',\n  productos: Array.isArray(datos.productos) ? datos.productos : [],\n  cliente: datos.cliente || 'interno'\n};\n\nglobal[ctxKey] = memoria;\n\nreturn {\n  chat_id: chatId,\n  proyecto: memoria.datos_pendientes.proyecto,\n  proyecto_id: memoria.datos_pendientes.proyecto_id,\n  tarea: memoria.datos_pendientes.tarea,\n  horas: memoria.datos_pendientes.horas,\n  descripcion: memoria.datos_pendientes.descripcion,\n  tipo_respuesta: 'tarea_no_existe_fsm',\n  memoria_actualizada: memoria\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        17664
      ],
      "id": "1fd892b3-9c26-4ba8-bc8d-d01958198f87",
      "name": "Guardar Memoria Tarea No Existe FSM"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Marcos',\n  'crear_tarea_solamente_fsm',\n  `El proyecto \"${$json.proyecto}\" existe en Servicio de campo (FSM), pero la tarea \"${$json.tarea}\" no existe. ¿Quieres que cree la tarea?`,\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),\n  `Registro de horas en tarea inexistente: ${$json.tarea}`,\n  JSON.stringify($json.memoria_actualizada?.historial || []),\n  JSON.stringify([{\n    tipo: 'usuario',\n    contenido: `Registrar ${$json.horas}h en ${$json.proyecto}/${$json.tarea}`,\n    timestamp: new Date().toISOString()\n  },\n    {\n      tipo: 'bot',\n      contenido: `Tarea \"${$json.tarea}\" no existe en proyecto existente. Esperando confirmación para crear.`,\n      timestamp: new Date().toISOString()\n    }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -96,
        17664
      ],
      "id": "f5a1acc5-3858-49fe-a732-117f7638b4b9",
      "name": "Guardar Memoria PostgreSQL Tarea No Existe FSM"
    },
    {
      "parameters": {
        "jsCode": "// Trae datos del item anterior\nconst ctx = $json;\n\n// Fallbacks robustos\nconst DB  = ctx.db  || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst UID = ctx.uid || ($('Autenticar Odoo')?.item?.json?.result);\n\nif (!DB)  throw new Error('DB no definida');\nif (!UID) throw new Error('UID no definido');\n\n// Nombre a buscar (por defecto \"Servicio de campo\")\nconst nombreProyecto = (ctx.proyecto || 'Servicio de campo').trim();\n\nconsole.log('🔍 Buscando proyecto FSM en TODAS las compañías:', nombreProyecto);\n\nconst body = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      DB, UID, 'admin',\n      'project.project', 'search_read',\n      [[ \n        ['is_fsm', '=', true], \n        ['name', 'ilike', nombreProyecto],\n        '|',\n        ['company_id', '=', false],  // Sin compañía\n        ['company_id', '!=', false]  // O cualquier compañía\n      ]],\n      { \n        fields: ['id','name','is_fsm','company_id'], \n        limit: 1,\n        context: { 'allowed_company_ids': [] }  // Buscar en todas las compañías\n      },\n    ],\n  },\n  id: Math.floor(Math.random()*1e6),\n};\n\nconsole.log('📋 Buscando en todas las compañías');\n\n// Devuelve el payload + los datos ya normalizados con los fallbacks\nreturn { payload: body, datos: { ...ctx, db: DB, uid: UID } };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1776,
        17456
      ],
      "id": "145771e3-9aa6-4396-83ad-7cc20d831e90",
      "name": "Payload Buscar Proyecto FSM"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5a227c45-8686-4b8c-9a43-5fa9f8371fd1",
              "leftValue": "={{ \n  (Array.isArray($json.json?.result) && $json.json.result.length > 0)\n  || (Array.isArray($json.result) && $json.result.length > 0)\n  || (Array.isArray($json.body?.result) && $json.body.result.length > 0)\n}}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -608,
        17456
      ],
      "id": "5d90bd66-fac5-4bed-bc0c-a35446e8eee7",
      "name": "¿Existe Tarea?"
    },
    {
      "parameters": {
        "jsCode": "\n// 1) Lee SIEMPRE del nodo \"Normalizar Parte+Materiales FSM\"\n//\nconst norm =\n  $('Normalizar Parte+Materiales FSM')?.first()?.json ||\n  $('Normalizar Parte+Materiales FSM')?.item?.json ||\n  {};\n\nconst db  = String(norm.db || 'lsanchezgoshawk-n8npruebas-main-25736898');\nconst uid = Number(norm.uid);\nconst clienteNombre = String(norm.cliente || '').trim();\n\n//\n// 2) Saca el task_id del item actual (HTTP Buscar Tarea FSM)\n//\nconst http = $json;\nconst tareas = http.json?.result ?? http.result ?? http.body?.result ?? [];\nconst tarea = Array.isArray(tareas) && tareas[0] ? tareas[0] : null;\nconst taskId = Number(tarea?.id);\n\n//\n// 3) Si falta algo -> NO dispares el HTTP siguiente\n//\nif (!uid || !taskId || !clienteNombre) {\n  return {\n    skip_partner_lookup: true,\n    motivo: `faltan_datos uid:${!!uid}, taskId:${!!taskId}, cliente:${!!clienteNombre}`,\n    db, uid, task_id: taskId, cliente: clienteNombre,\n  };\n}\n\n//\n// 4) Payload para buscar el partner por nombre (res.partner)\n//   - Usamos ilike + limit:1\n//\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'res.partner', 'search_read',\n      [[ ['name', 'ilike', clienteNombre] ]],\n      { fields: ['id','name'], limit: 1 },\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  payload,\n  db,\n  uid,\n  task_id: taskId,\n  cliente: clienteNombre,\n  skip_partner_lookup: false,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -304,
        17280
      ],
      "id": "d57e41cf-2411-4947-b133-8e6b4aa657aa",
      "name": "Preparar Asignar Cliente a Tareade"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -112,
        17280
      ],
      "id": "c73c902f-3363-4a77-98d8-4f948bee8c85",
      "name": "HTTP Asignar Cliente a Tarea"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ae951486-7c0a-400e-a6bc-229107f668e1",
              "leftValue": "={{ !($json.cliente) }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2096,
        17440
      ],
      "id": "2346eb51-d2af-470e-888b-b47deb950ed1",
      "name": "¿Falta Cliente?"
    },
    {
      "parameters": {
        "jsCode": "    const ref = $json.datos_verificacion || $json;\n    const chatId = Number(ref.chat_id || 0);\n    const ctxKey = `memoria_${chatId}`;\n\n    let memoria = global[ctxKey] || {};\n    memoria.esperando_confirmacion = 'solicitar_cliente_fsm';\n    memoria.esperando_respuesta = true;\n    memoria.datos_pendientes = {\n      accion_original: 'registrar_parte_y_stock',\n      proyecto: ref.proyecto || '',\n      proyecto_id: ref.proyecto_id,\n      tarea: ref.tarea || '',\n      horas: Number(ref.horas || 0),\n      descripcion: ref.descripcion || '',\n      productos: Array.isArray(ref.productos) ? ref.productos : [],\n      cliente: '',               // faltante\n      db: ref.db || 'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid: ref.uid,\n      fecha: new Date().toISOString().split('T')[0],\n    };\n    global[ctxKey] = memoria;\n\n    return {\n      chat_id: chatId,\n      accion: 'falta_cliente_fsm',\n      mensaje_bot: 'Falta cliente para el parte de trabajo (FSM). ¿A qué cliente va dirigido?',\n      memoria_actualizada: memoria,\n    };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1920,
        17248
      ],
      "id": "994c9f02-893d-4eba-a512-4493cecc4bb6",
      "name": "Guardar Memoria Falta Cliente"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id ?? $('Guardar Memoria Falta Cliente').first()?.json?.chat_id ?? $('Normalizar Parte+Materiales FSM').first()?.json?.chat_id ?? 0 }}",
        "text": "=  ⚠️ Falta el cliente para el parte de trabajo.\n\n    Por favor, indica el cliente al que va dirigido este parte (nombre del cliente).",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1552,
        17248
      ],
      "id": "33e14241-c54b-49f9-84dd-053c4f711ae6",
      "name": "Preguntar Cliente",
      "webhookId": "1f3260aa-6777-49ea-8879-00370d53e7a4"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  Number($json.chat_id) || 0,\n  Number($json.chat_id) || 0,\n  'Marcos',\n  'solicitar_cliente_fsm',\n  'Falta el cliente para el parte (FSM). Solicitado al usuario.',\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes ?? {}),\n  `Pendiente de cliente para proyecto \"${$json.memoria_actualizada?.datos_pendientes?.proyecto || ''}\"`,\n  JSON.stringify($json.memoria_actualizada?.historial ?? []),\n  JSON.stringify([\n    { tipo:'bot', contenido:'Falta cliente. Solicitado al usuario.', timestamp:new Date().toISOString() }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1728,
        17248
      ],
      "id": "c02b544b-59ec-4469-bc8d-7e913d3ef40b",
      "name": "Guardar Memoria PostgreSQL Falta Cliente FSM"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR BÚSQUEDA PRODUCTOS FSM (basado en la lógica de ventas)\nconst datos = $('Normalizar Parte+Materiales FSM').item.json;\nconst uid = datos.uid;\nconst productos = Array.isArray(datos.productos) ? datos.productos : [];\n\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\n\n// Normalización ligera pensada para Odoo (NO tocamos ll/y ni h aquí)\nconst normalize = (s) =>\n  (s || '')\n    .toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'') // sin acentos\n    .toLowerCase()\n    .replace(/[^a-z0-9%\\. ]+/g,' ')\n    .replace(/\\s+/g,' ')\n    .trim();\n\n// genera variantes útiles: singular/plural, número+unidad y variantes \"fuzzy\" (h, ll/y, prefijos/sufijos)\nfunction variants(tok) {\n  const out = new Set();\n  const vowels = 'aeiou';\n\n  if (!tok) return [];\n\n  // token base\n  out.add(tok);\n\n  // singularización sencilla\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s'))  out.add(tok.slice(0, -1));\n\n  // número+unidad: 5kg -> 5 , kg , 5kg\n  const m = tok.match(/^(\\d+(?:\\.\\d+)?)(kg|g|mg|l|ml|cm|mm|m|u|uds?)$/);\n  if (m) {\n    out.add(m[1]); // número\n    out.add(m[2]); // unidad\n  }\n\n  // --- Prefijos y sufijos para tolerar faltas de ortografía ---\n  // Ej.: torniyo -> \"torni\" (match con \"tornillos\"), \"orño\"/\"iyo\" etc.\n  if (tok.length >= 4) {\n    // prefijos\n    out.add(tok.slice(0, 4));          // primeros 4\n    if (tok.length >= 5) out.add(tok.slice(0, 5)); // primeros 5\n    // sufijos\n    out.add(tok.slice(-4));            // últimos 4\n    if (tok.length >= 5) out.add(tok.slice(-5));   // últimos 5\n  }\n\n  // --- Varianten con/ sin h inicial ---\n  // orno -> horno  (falta h)\n  if (vowels.includes(tok[0])) {\n    out.add('h' + tok);\n  }\n  // horno -> orno  (h de más)\n  if (tok.startsWith('h') && tok.length > 1 && vowels.includes(tok[1])) {\n    out.add(tok.slice(1));\n  }\n\n  // --- Variantes típicas ll / y ---\n  // yave -> llave\n  if (tok.startsWith('y') && tok.length > 1 && vowels.includes(tok[1])) {\n    out.add('ll' + tok.slice(1));\n  }\n\n  // torniyo -> tornillo (yo final -> llo)\n  if (tok.endsWith('yo') && tok.length > 2) {\n    out.add(tok.slice(0, -2) + 'llo');\n  }\n\n  return [...out];\n}\n\nfunction tokens(nombre) {\n  const base = normalize(nombre);\n  if (!base) return [];\n  const raw = base.split(' ').filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) {\n    for (const v of variants(tk)) {\n      if (v.length >= 2) {\n        uniq.add(v);\n      }\n    }\n  }\n  return [...uniq];\n}\n\n// 1) Construir hojas (leaves) para OR global: name ilike tk  OR  default_code ilike tk\nlet leaves = [];\nfor (const p of productos) {\n  if (!p || typeof p.nombre !== 'string') continue;\n  const tks = tokens(p.nombre);\n  for (const tk of tks) {\n    leaves.push(['name', 'ilike', tk]);\n    leaves.push(['default_code', 'ilike', tk]);\n  }\n}\n\n// deduplicar leaves\nconst seen = new Set();\nleaves = leaves.filter(l => {\n  const k = JSON.stringify(l);\n  if (seen.has(k)) return false;\n  seen.add(k);\n  return true;\n});\n\nlet domain;\n\nif (leaves.length === 0) {\n  // sin términos -> dominio imposible (evita resultados)\n  domain = [['id', '=', -1]];\n} else {\n  // OR de todas las hojas:  [ '|', '|', ..., hoja1, hoja2, ..., hojaN ]\n  const orTokens = (leaves.length === 1)\n    ? [leaves[0]]\n    : [...Array(leaves.length - 1).fill('|'), ...leaves];\n\n  // AND con sale_ok:  ['&', ['sale_ok','=',true],  ...orTokens ]\n  domain = ['&', ['sale_ok', '=', true], ...orTokens];\n}\n\nconsole.log('🔍 Dominio construido (plano):', JSON.stringify(domain));\n\n// 2) Payload a Odoo\nconst payloadId = Math.floor(Math.random() * 1e6);\nconst jsonRpcPayload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'product.product',\n      'search_read',\n      [domain],\n      {\n        fields: ['id', 'name', 'list_price', 'uom_id', 'default_code'],\n        limit: 300\n      }\n    ]\n  },\n  id: payloadId\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  productos_solicitados: productos,\n  ...datos\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2864,
        17440
      ],
      "id": "e3efeb27-cb0b-499d-9628-a05e668771b3",
      "name": "Preparar Búsqueda Productos FSM"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2688,
        17440
      ],
      "id": "29d6687b-8786-4712-8667-d26ecaa8205d",
      "name": "HTTP Buscar Productos FSM"
    },
    {
      "parameters": {
        "jsCode": "// VALIDAR PRODUCTOS FSM (matching fuzzy entre productos solicitados y encontrados)\n\nconst httpResult = $json.result;\nconst datosBusqueda = $('Preparar Búsqueda Productos FSM').item?.json || {};\nconst productosSolicitados = Array.isArray(datosBusqueda.productos_solicitados) ? datosBusqueda.productos_solicitados : [];\nconst chatId = datosBusqueda.chat_id;\nconst uid = datosBusqueda.uid;\n\nconst pool = Array.isArray(httpResult) ? httpResult : [];\n\n// Palabras vacías\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\n\n// 🔤 Normalización básica + ortográfica/fonética en español\nconst normalize = (s) => {\n  let out = (s || '')\n    .toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'') // quitar acentos\n    .toLowerCase()\n    .replace(/\\s+/g,' ')\n    .trim();\n\n  // Normalización fonética / ortográfica típica en español\n  out = out\n    .replace(/h/g, '')          // quitar h mudas (hacha ↔ acha)\n    .replace(/ll/g, 'y')        // ll ↔ y (tornillo ↔ torniyo)\n    .replace(/v/g, 'b')         // v ↔ b (tubo ↔ tuvo)\n    .replace(/qu/g, 'k')        // qu ↔ k (quimico ↔ kimico)\n    .replace(/c(?=[ei])/g, 's') // ce/ci ↔ se/si (cemento ↔ semento)\n    .replace(/z/g, 's')         // z ↔ s (plaza ↔ plasa)\n    .replace(/ge/g, 'je')       // ge/gi ↔ je/ji\n    .replace(/gi/g, 'ji');\n\n  return out;\n};\n\nfunction tokenVariants(tok) {\n  const out = new Set([tok]);\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s'))  out.add(tok.slice(0, -1));\n\n  // separar unidades tipo 5kg, 3m, etc.\n  const m = tok.match(/^(\\d+(?:\\.\\d+)?)(kg|g|mg|l|ml|cm|mm|m|u|uds?)$/);\n  if (m) { out.add(m[1]); out.add(m[2]); }\n\n  return [...out];\n}\n\nfunction tokens(s) {\n  const base = normalize(s);\n  if (!base) return [];\n  const raw = base.split(/[ \\-_/]+/).filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) {\n    for (const v of tokenVariants(tk)) {\n      if (v.length >= 2 || /^\\d+(?:\\.\\d+)?$/.test(v)) {\n        uniq.add(v);\n      }\n    }\n  }\n  return [...uniq];\n}\n\nfunction levenshtein(a, b) {\n  a = normalize(a); \n  b = normalize(b);\n  const m = a.length, n = b.length;\n  if (m === 0) return n;\n  if (n === 0) return m;\n  const dp = Array.from({ length: m + 1 }, () => Array(n + 1).fill(0));\n  for (let i = 0; i <= m; i++) dp[i][0] = i;\n  for (let j = 0; j <= n; j++) dp[0][j] = j;\n  for (let i = 1; i <= m; i++) {\n    for (let j = 1; j <= n; j++) {\n      const cost = a[i - 1] === b[j - 1] ? 0 : 1;\n      dp[i][j] = Math.min(\n        dp[i - 1][j] + 1,\n        dp[i][j - 1] + 1,\n        dp[i - 1][j - 1] + cost\n      );\n    }\n  }\n  return dp[m][n];\n}\n\nfunction jaccardToken(a, b) {\n  const A = new Set(tokens(a));\n  const B = new Set(tokens(b));\n  const inter = [...A].filter(x => B.has(x)).length;\n  const uni = new Set([...A, ...B]).size;\n  return uni === 0 ? 0 : inter / uni;\n}\n\nfunction similarity(a, b) {\n  const la = normalize(a), lb = normalize(b);\n  if (!la || !lb) return 0;\n  if (la === lb) return 1;\n\n  const maxLen = Math.max(la.length, lb.length);\n  const ld = levenshtein(la, lb);\n  const levScore = 1 - (ld / Math.max(1, maxLen));\n  const jac = jaccardToken(a, b);\n\n  // combinamos Levenshtein (pesado) + Jaccard de tokens\n  return (levScore * 0.7) + (jac * 0.3);\n}\n\n// Umbrales\nconst THRESHOLD_HIGH = 0.88;  // match muy seguro → se valida directo\nconst MIN_SUGGESTION = 0.35;  // por debajo de esto no mostramos ni sugerencias\n\n// Índice rápido por nombre normalizado\nconst byName = new Map(pool.map(p => [normalize(p.name), p]));\n\nconst productosValidados = [];\nconst productosAmbiguos = [];\n\nfor (const sol of productosSolicitados) {\n  const nombreSolicitado = (sol?.nombre || '').toString();\n  const cant = Number(sol?.cantidad || 1);\n  if (!nombreSolicitado) continue;\n\n  const qNorm = normalize(nombreSolicitado);\n  const qTokens = new Set(tokens(nombreSolicitado));\n\n  // 1) Exacto por nombre normalizado (ya con corrección ortográfica)\n  if (byName.has(qNorm)) {\n    const p = byName.get(qNorm);\n    productosValidados.push({\n      product_id: p.id,\n      product_name: p.name,\n      quantity: cant,\n      price_unit: p.list_price\n    });\n    continue;\n  }\n\n  // 2) Prefiltro: solo candidatos que compartan tokens o tengan similitud suficiente\n  const candidates = [];\n  for (const p of pool) {\n    const cName = p.name || '';\n    const cTokens = new Set(tokens(cName));\n    const overlap = [...qTokens].some(t => cTokens.has(t));\n    const score = similarity(nombreSolicitado, cName);\n\n    if (overlap || score >= MIN_SUGGESTION) {\n      candidates.push({\n        id: p.id,\n        name: cName,\n        price: p.list_price,\n        score\n      });\n    }\n  }\n\n  candidates.sort((a, b) => b.score - a.score);\n\n  const best = candidates[0];\n  const top = candidates.slice(0, 7);\n\n  if (best && best.score >= THRESHOLD_HIGH) {\n    // Match muy claro → lo damos por bueno\n    productosValidados.push({\n      product_id: best.id,\n      product_name: best.name,\n      quantity: cant,\n      price_unit: best.price\n    });\n  } else if (top.length > 0) {\n    // Ambiguo → pedimos corrección al usuario\n    productosAmbiguos.push({\n      solicitado: nombreSolicitado,\n      cantidad: cant,\n      candidatos: top.map(x => ({\n        id: x.id,\n        name: x.name,\n        price: x.price,\n        score: Number(x.score.toFixed(2))\n      }))\n    });\n  } else {\n    // Nada parecido → sin sugerencias\n    productosAmbiguos.push({\n      solicitado: nombreSolicitado,\n      cantidad: cant,\n      candidatos: []\n    });\n  }\n}\n\n// Si hay ambigüedad → mensaje para corregir\nif (productosAmbiguos.length > 0) {\n  const instrucciones = [\n    '🔎 Hemos detectado algunos **productos con errores** en la descripción.',\n    '',\n    'Por favor, envía **TODAS** las correcciones en **un solo** mensaje con el formato:',\n    '`Nombre correcto x cantidad`,  `Nombre correcto x cantidad`... .',\n    ''\n  ];\n\n  for (const amb of productosAmbiguos) {\n    const sug = amb.candidatos.length\n      ? amb.candidatos.map((c, i) => `${i + 1}. ${c.name}`).join('\\n')\n      : '— Sin sugerencias —';\n\n    instrucciones.push(`Productos con errores (como lo has escrito): **${amb.solicitado}** x ${amb.cantidad}`);\n    instrucciones.push('Sugerencias:');\n    instrucciones.push(sug);\n    instrucciones.push('');\n  }\n\n  instrucciones.push('Ejemplo: `Tornillo M6 x 12, Cable UTP Cat6 5m x 5`.');\n\n  return {\n    requiere_correccion: true,\n    texto_correccion: instrucciones.join('\\n'),\n    productos_ambiguos: productosAmbiguos,\n    productos_validados: productosValidados,\n    ...datosBusqueda\n  };\n}\n\n// Sin ambigüedad → seguir flujo\nreturn {\n  requiere_correccion: false,\n  productos_validados: productosValidados,\n  ...datosBusqueda\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2528,
        17440
      ],
      "id": "f7e5c662-87a5-4f21-a470-d2f4fb9a2e8f",
      "name": "Validar Productos FSM"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "afcc19bd-7c62-4c22-9150-c73dab6a89ce",
              "leftValue": "={{ $json.requiere_correccion === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2336,
        17440
      ],
      "id": "5cf13336-2c18-4cf8-bb28-bbef324c0a61",
      "name": "¿Requiere Corrección Productos FSM?"
    },
    {
      "parameters": {
        "jsCode": "// Preparar memoria para corrección de productos FSM\nconst d = $('Validar Productos FSM').item.json;\n\nreturn {\n  chat_id: Number(d.chat_id) || 0,\n  esperando_confirmacion: 'corregir_productos_fsm',\n  ultimo_mensaje_bot: d.texto_correccion || 'Indica los productos correctos en un solo mensaje (nombre x cantidad, separados por comas).',\n  datos_pendientes: {\n    accion_original: 'registrar_parte_y_stock',\n    proyecto: d.proyecto,\n    tarea: d.tarea,\n    horas: d.horas,\n    descripcion: d.descripcion,\n    cliente: d.cliente,\n    productos_ambiguos: d.productos_ambiguos || [],\n    productos_validados: d.productos_validados || [],\n    db: d.db,\n    uid: d.uid\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2128,
        17040
      ],
      "id": "ac6c169a-45e1-4815-987a-f1eeebba1d03",
      "name": "Guardar Memoria Corrección Productos FSM"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Usuario',\n  'corregir_productos_fsm',\n  $json.ultimo_mensaje_bot,\n  JSON.stringify($json.datos_pendientes || {}),\n  'Corrección productos FSM',\n  JSON.stringify([]),\n  JSON.stringify([{ tipo: 'bot', contenido: $json.ultimo_mensaje_bot, timestamp: new Date().toISOString() }])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1920,
        17040
      ],
      "id": "522025a9-72c5-4225-94ef-7ea686da1305",
      "name": "Guardar Memoria PostgreSQL Corrección FSM"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Corrección Productos FSM').item.json.chat_id }}",
        "text": "={{ $('Guardar Memoria Corrección Productos FSM').item.json.ultimo_mensaje_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1712,
        17040
      ],
      "id": "668c8970-c683-4b60-b96f-70746cb875b7",
      "name": "Telegram Pedir Corrección Productos FSM",
      "webhookId": "0f5e6c39-253f-4ec9-9bfc-28489d714efd"
    },
    {
      "parameters": {
        "jsCode": "const base = $('Validar Productos FSM')?.item?.json || {};\nconst locs = $json;  // ← salida de \"Fijar IDs de Ubicaciones\"\n\nconst productosValidados = Array.isArray(base.productos_validados) ? base.productos_validados : [];\nif (!productosValidados.length) {\n  return [{ json: { skip_scrap:true, chat_id: base.chat_id, total_productos:0 } }];\n}\n\nconst lineas_desecho = productosValidados.map(p => ({\n  product_id: p.product_id,\n  product_name: p.product_name,\n  scrap_qty: p.quantity\n}));\n\nreturn {\n  lineas_desecho,\n  productos_validados: productosValidados,\n  skip_scrap: false,\n  chat_id: base.chat_id,\n  db: locs.db,\n  uid: Number(locs.uid),\n  company_id: locs.company_id,\n  location_id: locs.location_id,             // ✅ WH/Stock (origen)\n  scrap_location_id: locs.scrap_location_id, // ✅ Virtual/Scrap (destino)\n  total_productos: productosValidados.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2416,
        17264
      ],
      "id": "7b1e4b84-6aae-448a-b005-123c9673e0eb",
      "name": "Preparar Orden Desecho"
    },
    {
      "parameters": {
        "jsCode": "const d = $json;\n\nif (\n  d.skip_scrap ||\n  !Array.isArray(d.lineas_desecho) || !d.lineas_desecho.length ||\n  !d.db || !Number.isFinite(Number(d.uid)) ||\n  !d.location_id || !d.scrap_location_id\n) {\n  return [{\n    json: {\n      error: true,\n      motivo: 'Faltan datos para scrap',\n      db: d.db, uid: d.uid, location_id: d.location_id, scrap_location_id: d.scrap_location_id\n    }\n  }];\n}\n\nconst items = [];\nconst fecha = new Date().toISOString().split('T')[0]; // fecha sin hora\n\nfor (const l of d.lineas_desecho) {\n  const payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        d.db,                      // ✅ db\n        Number(d.uid),             // ✅ uid\n        'admin',\n        'stock.scrap', 'create',\n        [[{\n          product_id: l.product_id,\n          scrap_qty: l.scrap_qty,\n          location_id: d.location_id,             // ✅ ORIGEN = WH/Stock\n          scrap_location_id: d.scrap_location_id, // ✅ DESTINO = Virtual/Scrap\n          date_done: fecha,                        // <-- fecha (sin hora)\n          origin: `Parte FSM - ${fecha}`\n        }]],\n        { context: { allowed_company_ids: d.company_id ? [d.company_id] : [] } }\n      ]\n    },\n    id: Math.floor(Math.random()*1e6)\n  };\n\n  items.push({ json: { payload, db:d.db, uid:d.uid, chat_id:d.chat_id, total_productos:d.total_productos } });\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2800,
        17264
      ],
      "id": "29127dd8-f264-4126-817a-dcc35557537e",
      "name": "Crear Órdenes de Desecho"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3312,
        17328
      ],
      "id": "201f09cf-0d98-4e42-b60f-6fbe78102cfa",
      "name": "HTTP Crear Desecho"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3040,
        17264
      ],
      "id": "930a3244-1aa8-40e7-b043-dba5f7073995",
      "name": "Loop Over Items para Desecho"
    },
    {
      "parameters": {
        "jsCode": "// Ejecutar en la rama \"Done\" del SplitInBatches\nconst reg = $items('Registrar Horas Directo FSM', 0)[0]?.json?.registro || {};\nconst horasIdRaw = $items('HTTP Registrar Horas Directo FSM', 0)[0]?.json;\nconst horasId = horasIdRaw?.result ?? horasIdRaw?.body?.result ?? null;\n\n// total de productos/desechos procesados (los que generó \"Crear Órdenes de Desecho\")\nconst createdItems = $items('Crear Órdenes de Desecho', 0) || [];\nconst totalDesechos = createdItems.length;\n\n// usa el chat_id del registro de horas, o el del primer item de scrap\nconst chatFromScrap = createdItems[0]?.json?.chat_id;\nconst chatId = reg.chat_id || chatFromScrap;\n\n// mensaje\nlet texto = '✅ **¡Parte de horas registrado exitosamente!**\\n\\n';\ntexto += '📋 **Detalles del registro:**\\n';\ntexto += `• **Proyecto:** ${reg.proyecto || '-'}\\n`;\ntexto += `• **Tarea:** ${reg.tarea || '-'}\\n`;\ntexto += `• **Horas:** ${reg.horas ?? 0}\\n`;\ntexto += `• **Descripción:** ${reg.descripcion || '-'}\\n`;\ntexto += `• **Fecha:** ${new Date().toLocaleDateString('es-ES')}\\n`;\nif (horasId) {\n  texto += `• **ID del registro:** ${horasId}\\n`;\n  texto += `🔗 **Registro de horas:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id=${horasId}&model=account.analytic.line&view_type=form)\\n`;\n}\ntexto += `\\n🗑️ **Órdenes de desecho creadas:** ${totalDesechos}\\n`;\ntexto += '🎉 **¡Listo!** ¿Necesitas registrar más horas? 😊';\n\nreturn { chat_id: chatId, texto };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3936,
        17120
      ],
      "id": "5190cf63-5ab1-44f5-bbb4-b36c36f5310c",
      "name": "Formatear Confirmación Desecho"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Validación Scrap — EXTRAER scrapId directamente del HTTP Crear Desecho\n// Asegura que usamos la respuesta del nodo HTTP Crear Desecho para el mismo itemIndex.\n\nconst httpCreateNode = 'HTTP Crear Desecho';\n\n// Intentar extraer la respuesta exactamente del nodo HTTP Crear Desecho (mismo itemIndex)\nconst createResp = $items(httpCreateNode, 0)[$itemIndex]?.json ?? null;\n\nlet scrapId = null;\nif (createResp) {\n  // createResp puede venir en distintas formas: { result: [id] }, { result: id }, { body: { result: ... } }, etc.\n  const candidate = createResp.result ?? createResp.body?.result ?? createResp.json?.result ?? createResp;\n  if (candidate !== null && candidate !== undefined) {\n    if (Array.isArray(candidate) && candidate.length) scrapId = Number(candidate[0]);\n    else if (typeof candidate === 'number' || (typeof candidate === 'string' && /^\\d+$/.test(candidate))) scrapId = Number(candidate);\n    else if (typeof candidate === 'object' && typeof candidate.id !== 'undefined') scrapId = Number(candidate.id);\n  }\n}\n\n// Si no conseguimos scrapId desde HTTP Crear Desecho, intentar fallback con la respuesta del nodo actual\nif (!Number.isFinite(scrapId)) {\n  const res = $json.json?.result ?? $json.result ?? $json.body?.result ?? null;\n  if (res !== null && res !== undefined) {\n    if (Array.isArray(res) && res.length) scrapId = Number(res[0]);\n    else if (typeof res === 'number' || (typeof res === 'string' && /^\\d+$/.test(res))) scrapId = Number(res);\n    else if (typeof res === 'object' && typeof res.id !== 'undefined') scrapId = Number(res.id);\n  }\n}\n\nif (!Number.isFinite(scrapId)) {\n  // Debug útil: devuelve lo que encontró para que podamos ver la respuesta real del create\n  return [{ json: { error: true, motivo: 'No se pudo determinar scrapId desde HTTP Crear Desecho', createRespSnapshot: createResp ?? null, currentJson: $json } }];\n}\n\n// Obtener db/uid desde el item generado por Crear Órdenes de Desecho (preferible) o desde el item del HTTP create\nconst originItem = $items('Crear Órdenes de Desecho', 0)[$itemIndex]?.json || $items(httpCreateNode, 0)[$itemIndex]?.json || $json || {};\nconst db = originItem.db ?? originItem.json?.db ?? $json.db ?? null;\nconst uidCandidate = originItem.uid ?? originItem.json?.uid ?? $json.uid ?? null;\nconst uid = Number(uidCandidate);\n\nif (!db || !Number.isFinite(uid)) {\n  return [{ json: { error: true, motivo: 'Faltan db/uid para validar', db, uid, scrapId } }];\n}\n\n// Construir payload correcto para action_validate\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'stock.scrap',\n      'action_validate',\n      [[ Number(scrapId) ]] // lista de ids como único argumento posicional\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn [{ json: { payload, db, uid, scrap_id: scrapId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3936,
        17328
      ],
      "id": "b3afaa21-a2dd-4323-9ef3-65ae5a2f6e82",
      "name": "Preparar Validación Scrap"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4160,
        17328
      ],
      "id": "60630222-d40b-42d8-8d69-d2b37d76f9d8",
      "name": "HTTP Validar Scrap",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Resolver almacén y ubicaciones a partir de warehouse_hint\n\nconst base = $('Validar Productos FSM')?.item?.json || {};\nconst db   = base.db  || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid  = base.uid;\n\nconst hint = (base.warehouse_hint || 'principal').toString().toLowerCase();\n\n// Mapea tu hint a un dominio del warehouse (ajusta a tu caso)\nlet domainWH;\nif (hint === 'principal') {\n  // por código WH o por nombre que contenga \"Principal\"\n  domainWH = ['|', ['code', '=', 'WH'], ['name', 'ilike', 'Principal']];\n} else if (hint === 'secundario') {\n  domainWH = ['|', ['code', '=', 'WH2'], ['name', 'ilike', 'Secundario']];\n} else {\n  // fallback por código WH\n  domainWH = [['code', '=', 'WH']];\n}\n\n// payload para stock.warehouse\nconst payloadWH = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'stock.warehouse', 'search_read',\n      [ [domainWH].flat() ],\n      { fields: ['id','name','code','company_id','lot_stock_id'], limit: 1 }\n    ],\n  },\n  id: Math.floor(Math.random()*1e6),\n};\n\nreturn { payloadWH, db, uid };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1360,
        17440
      ],
      "id": "81c977d0-1dbf-47eb-91c3-fbf472064842",
      "name": "Buscar Almacén"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payloadWH }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1568,
        17440
      ],
      "id": "b5c15ac6-29f6-47f5-9947-4b625afe326d",
      "name": "HTTP Buscar Warehouse"
    },
    {
      "parameters": {
        "jsCode": "// Resolver Ubicaciones WH (usar contexto del nodo \"Buscar Almacén\")\nconst httpWH = $json;\nconst list = httpWH.json?.result || httpWH.result || httpWH.body?.result || [];\nconst wh = Array.isArray(list) && list[0] ? list[0] : null;\nif (!wh) throw new Error('No se encontró warehouse');\n\n// ← contexto original con db/uid viene de \"Buscar Almacén\"\nconst ctx = $items('Buscar Almacén', 0)[0]?.json || {};\nconst db  = String(ctx.db || 'lsanchezgoshawk-n8npruebas-main-25736898');\nconst uid = Number(ctx.uid);\n\nconst company_id   = Array.isArray(wh.company_id)   ? wh.company_id[0]   : wh.company_id;\nconst lot_stock_id = Array.isArray(wh.lot_stock_id) ? wh.lot_stock_id[0] : wh.lot_stock_id;\n\nconst payloadScrapLoc = {\n  jsonrpc: '2.0', method: 'call',\n  params: { service:'object', method:'execute_kw',\n    args: [ db, uid, 'admin',\n      'stock.location','search_read',\n      [[ ['scrap_location','=',true], '|', ['company_id','=',false], ['company_id','=',company_id] ]],\n      { fields:['id','complete_name'], limit:1 }\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn { db, uid, company_id, location_id: lot_stock_id, payloadScrapLoc };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        17440
      ],
      "id": "f5cad24b-a290-4ef4-8ed8-2be553c62c50",
      "name": "Resolver Ubicaciones WH"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payloadScrapLoc }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1984,
        17440
      ],
      "id": "a5c0882c-851e-4d8e-9c8e-f9ef675ff507",
      "name": "HTTP Buscar Ubicación Scrap"
    },
    {
      "parameters": {
        "jsCode": "// Fijar IDs de Ubicaciones\nconst res = $json.json?.result || $json.result || $json.body?.result || [];\nconst scrap = Array.isArray(res) && res[0] ? res[0] : null;\nif (!scrap) throw new Error('No se encontró Virtual/Scrap');\n\n// Recupera el contexto del nodo \"Resolver Ubicaciones WH\"\nlet ctx = {};\ntry { ctx = $items('Resolver Ubicaciones WH', 0)[0]?.json || {}; } catch(e) {}\n\nconst db          = ctx.db ?? $json.db;\nconst uid         = Number(ctx.uid ?? $json.uid);\nconst company_id  = ctx.company_id ?? $json.company_id;\nconst location_id = ctx.location_id ?? $json.location_id;\n\nif (!db || !Number.isFinite(uid)) {\n  return { error:true, motivo:'sin db/uid en contexto', db, uid };\n}\n\nreturn { db, uid, company_id, location_id, scrap_location_id: scrap.id };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2192,
        17440
      ],
      "id": "08050b59-95c0-47ea-a9ff-aeb5e2c89884",
      "name": "Fijar IDs de Ubicaciones"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "⏳ <b>Tu solicitud se está procesando…</b> En breve te envío la respuesta.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4704,
        3152
      ],
      "id": "e163b8d7-71c7-4ef5-b7ab-599faf832f9a",
      "name": "Procesando Respuesta",
      "webhookId": "9b411b17-88a5-4ee8-8ab0-bf1401062624",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE n8n\nSET\n  esperando_confirmacion = NULL,\n  ultimo_mensaje_bot     = NULL,\n  datos_pendientes       = NULL,\n  updated_at             = NOW()\nWHERE chat_id = $1;\n",
        "options": {
          "queryReplacement": "={{ [ parseInt($('FSM ▸ Limpiar & Resumen').first().json.chat_id) ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        2528,
        18512
      ],
      "id": "e4e4e95e-949b-4993-ba0c-f55cddaf3ea2",
      "name": "Limpiar Memoria"
    },
    {
      "parameters": {
        "jsCode": "// Busca proyecto por nombre (exacto primero) y empresa\nconst seed = $('FSM ▸ Preparar Datos Completos').first().json;\nconst leerComp = $('FSM ▸ HTTP Leer Compañía').first().json;\nconst db  = seed.db;\nconst uid = seed.uid;\nconst proyecto = String(seed.proyecto || 'Servicio de campo').trim();\n\nlet companyId = null;\ntry {\n  const r = leerComp.result || leerComp.body?.result;\n  if (Array.isArray(r) && r[0]?.company_id) companyId = Number(r[0].company_id[0]);\n} catch {}\n\nconst domainExact = companyId\n  ? [[['name','=', proyecto], ['company_id','=', companyId]]]\n  : [[['name','=', proyecto]]];\n\nreturn {\n  db, uid, proyecto, companyId,\n  payload: {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [db, uid, 'admin', 'project.project', 'search_read', domainExact, {fields:['id','name','company_id'], limit:1}]\n    },\n    id: Math.floor(Math.random()*1e6)\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2176,
        18112
      ],
      "id": "7fe93319-8a60-443c-b698-f03bdad867be",
      "name": "FSM ▸ Preparar Buscar Proyecto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1968,
        18112
      ],
      "id": "2bb1a16f-621a-42c1-80f5-725846956b97",
      "name": "FSM ▸ HTTP Buscar Proyecto"
    },
    {
      "parameters": {
        "jsCode": "const r = $json.result || $json.body?.result || [];\nconst existe = Array.isArray(r) && r.length > 0;\nconst proyecto_id = existe ? Number(r[0].id) : null;\n\nreturn {\n  ...$json,\n  proyecto_existe: existe,\n  proyecto_id,               // 👈 PROPAGA AQUÍ\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1792,
        18112
      ],
      "id": "172900f5-38c1-4434-861a-b8fee03549c8",
      "name": "FSM ▸ Resolver Proyecto ID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aa8ab327-1a7a-4e0c-a1c7-2048adf6a156",
              "leftValue": "={{ $json.proyecto_existe === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1568,
        18112
      ],
      "id": "94b75f89-52d7-4b13-86d3-81fd18ba211a",
      "name": "¿Proyecto existe?"
    },
    {
      "parameters": {
        "jsCode": "// Busca tarea por nombre dentro del proyecto_id\nconst base = $json;\nconst seed = $('FSM ▸ Preparar Datos Completos').first().json;\n\nconst db = base.db || seed.db;\nconst uid = base.uid || seed.uid;\nconst tarea = String(seed.tarea || `Intervención - ${new Date().toLocaleDateString('es-ES')}`).trim();\n\n// proyecto_id puede venir de Resolver Proyecto ID o de la creación\nconst proyecto_id =\n  Number(base.proyecto_id) ||\n  Number($('FSM ▸ Resolver Proyecto ID').first()?.json?.proyecto_id) ||\n  Number($('FSM ▸ HTTP Crear Proyecto').first()?.json?.result);\n\nif (!Number.isFinite(proyecto_id)) {\n  throw new Error('No se resolvió proyecto_id para buscar la tarea');\n}\n\nconst domain = [[['name','=', tarea], ['project_id','=', proyecto_id]]];\nreturn {\n  ...base, db, uid, tarea, proyecto_id,\n  payload: {\n    jsonrpc:'2.0', method:'call',\n    params:{ service:'object', method:'execute_kw',\n      args:[db, uid, 'admin', 'project.task', 'search_read', domain, {fields:['id','name','project_id'], limit:1}]\n    },\n    id: Math.floor(Math.random()*1e6)\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1392,
        17888
      ],
      "id": "ec181904-4091-4b37-91e7-dcaae540988d",
      "name": "FSM ▸ Preparar Buscar Tarea"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1184,
        17888
      ],
      "id": "90b96f19-014d-4e26-a4f6-5ff239bb5b17",
      "name": "FSM ▸ HTTP Buscar Tarea"
    },
    {
      "parameters": {
        "jsCode": "const r = $json.result || $json.body?.result || [];\nconst tarea_existe = Array.isArray(r) && r.length > 0;\nconst task_id = tarea_existe ? Number(r[0].id) : null;\n\nlet proyecto_id = null;\nif (tarea_existe) {\n  const pj = r[0].project_id;\n  if (Array.isArray(pj)) proyecto_id = Number(pj[0]);\n  else if (typeof pj === 'number') proyecto_id = pj;\n}\n\n// ✅ si NO existe tarea, arrastra el proyecto_id que ya tenías al preparar la búsqueda\nif (!tarea_existe) {\n  try {\n    const prev = $items('FSM ▸ Preparar Buscar Tarea', 0)[0]?.json;\n    if (Number.isFinite(Number(prev?.proyecto_id))) {\n      proyecto_id = Number(prev.proyecto_id);\n    }\n  } catch {}\n}\n\nreturn { ...$json, tarea_existe, task_id, proyecto_id };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        17888
      ],
      "id": "b71c2e19-e6af-4848-b27f-3fc43559780a",
      "name": "FSM ▸ Resolver Tarea ID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d0ff9a22-8a28-4f6a-bf8b-2a4870804479",
              "leftValue": "={{ $json.tarea_existe === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -768,
        17888
      ],
      "id": "35d45c2d-f182-43f8-8755-85ec01188b9d",
      "name": "FSM ▸ ¿Tarea existe?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        5264,
        17680
      ],
      "id": "f746f9a8-8996-42a7-99de-7db520d37837",
      "name": "Confirmar Todo1",
      "webhookId": "1dadcc74-c513-44a1-88b9-c7aa71c7ec47"
    },
    {
      "parameters": {
        "jsCode": "// ✅ ACTUALIZADO: Extrae usuario desde \"Propagar Usuario Odoo\"\n\nconst val  = $('Validar Productos')?.first()?.json || {};\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\nconst locs = $json; // viene de \"Fijar IDs de Ubicaciones1\"\n\nconst productosValidados = Array.isArray(val.productos_validados) ? val.productos_validados : [];\n\nif (!productosValidados.length) {\n  return [{ json: { skip_scrap: true, motivo: 'sin productos validados', total_productos: 0 } }];\n}\n\nconst faltantes = productosValidados.filter(p => !Number.isFinite(Number(p.product_id)));\nif (faltantes.length) {\n  return [{\n    json: {\n      skip_scrap: true,\n      motivo: 'Productos sin product_id (validación)',\n      faltantes: faltantes.map(p => p.product_name || p.name || '(sin nombre)'),\n    }\n  }];\n}\n\nconst lineas_desecho = productosValidados.map(p => ({\n  product_id: Number(p.product_id),\n  product_name: p.product_name || p.name || '',\n  scrap_qty: Number(p.quantity || 1),\n}));\n\nconst db  = locs.db;\nconst location_id = locs.location_id;\nconst scrap_location_id = locs.scrap_location_id;\n\n// 👇 NUEVO: Extraer usuario real desde \"Propagar Usuario Odoo\"\nlet usuarioId = null;\nlet usuarioNombre = null;\n\ntry {\n  const propagarUsuario = $('Propagar Usuario Odoo')?.first()?.json;\n  if (propagarUsuario) {\n    const usuarioData = Array.isArray(propagarUsuario) ? propagarUsuario[0] : propagarUsuario;\n    if (Number.isFinite(usuarioData?.odoo_user_id)) {\n      usuarioId = Number(usuarioData.odoo_user_id);\n      usuarioNombre = usuarioData?.name || `Usuario ${usuarioId}`;\n    }\n  }\n} catch (e) {\n  console.log('⚠️ No se pudo extraer usuario desde Propagar Usuario Odoo:', e.message);\n}\n\n// Fallback a seed si no se encontró\nif (!Number.isFinite(usuarioId) && Number.isFinite(seed.odoo_user_id)) {\n  usuarioId = Number(seed.odoo_user_id);\n  usuarioNombre = seed.nombre_usuario || `Usuario ${usuarioId}`;\n}\n\n// Fallback final: si aún no hay usuario, usar uid del locs\nconst uid = Number.isFinite(usuarioId) ? usuarioId : (seed.uid || locs.uid || 2);\n\nreturn {\n  lineas_desecho,\n  productos_validados: productosValidados,\n  skip_scrap: false,\n  db,\n  uid,  // 👈 Ahora con usuario real o fallback\n  usuarioId,\n  usuarioNombre,\n  company_id: locs.company_id,\n  location_id,\n  scrap_location_id,\n  total_productos: productosValidados.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4048,
        17824
      ],
      "id": "7ba2a98a-71cf-4a41-a7e1-dba656f2f828",
      "name": "Preparar Orden Desecho1"
    },
    {
      "parameters": {
        "jsCode": "// ✅ ACTUALIZADO: Usa el usuario real (Laura) en lugar de admin\n\nconst val  = $('Validar Productos')?.first()?.json || {};\nconst locs = $json;\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\n\nlet locSeed = {};\ntry {\n  locSeed = $items('Fijar IDs de Ubicaciones1', 0)[0]?.json || {};\n} catch {}\n\nconst productosValidados = Array.isArray(val.productos_validados) ? val.productos_validados : [];\nif (!productosValidados.length) {\n  return [{ json: { skip_scrap: true, motivo: 'sin productos validados', total_productos: 0 } }];\n}\n\nconst faltantes = productosValidados.filter(p => !Number.isFinite(Number(p.product_id)));\nif (faltantes.length) {\n  return [{\n    json: {\n      skip_scrap: true,\n      motivo: 'Productos sin product_id',\n      faltantes: faltantes.map(p => p.product_name || p.name || '(sin nombre)'),\n      total_productos: productosValidados.length\n    }\n  }];\n}\n\nconst lineas_desecho = productosValidados.map(p => ({\n  product_id: Number(p.product_id),\n  product_name: p.product_name || p.name || '',\n  scrap_qty: Number(p.quantity || 1),\n}));\n\nconst db  = locs.db  || val.db  || seed.db  || 'lsanchezgoshawk-n8npruebas-main-25736898';\n\n// 👇 NUEVO: Extraer usuario real desde \"Propagar Usuario Odoo\" PRIMERO\nlet usuarioId = null;\nlet usuarioNombre = null;\n\ntry {\n  const propagarUsuario = $('Propagar Usuario Odoo')?.first()?.json;\n  if (propagarUsuario) {\n    const usuarioData = Array.isArray(propagarUsuario) ? propagarUsuario[0] : propagarUsuario;\n    if (Number.isFinite(usuarioData?.odoo_user_id)) {\n      usuarioId = Number(usuarioData.odoo_user_id);\n      usuarioNombre = usuarioData?.name || `Usuario ${usuarioId}`;\n    }\n  }\n} catch (e) {\n  console.log('⚠️ No se pudo extraer usuario:', e.message);\n}\n\n// Fallback a seed si no se encontró\nif (!Number.isFinite(usuarioId) && Number.isFinite(seed.odoo_user_id)) {\n  usuarioId = Number(seed.odoo_user_id);\n  usuarioNombre = seed.nombre_usuario || `Usuario ${usuarioId}`;\n}\n\n// 👇 IMPORTANTE: Usar usuarioId en lugar de uid para que aparezca como creador\nconst uid = Number.isFinite(usuarioId) ? usuarioId : Number(locs.uid || val.uid || seed.uid);\n\nif (!uid) throw new Error('Falta uid para scrap');\n\nconst company_id        = (locs.company_id ?? locSeed.company_id ?? seed.company_id ?? null);\nconst location_id       = (locs.location_id ?? locSeed.location_id ?? null);\nconst scrap_location_id = (locs.scrap_location_id ?? locSeed.scrap_location_id ?? null);\n\nif (!location_id || !scrap_location_id) {\n  return [{\n    json: {\n      error: true,\n      motivo: 'Faltan location_id/scrap_location_id',\n      company_id, location_id, scrap_location_id\n    }\n  }];\n}\n\nconst fecha = new Date().toISOString().split('T')[0];\nconst items = [];\n\nfor (const l of lineas_desecho) {\n  const payload = {\n    jsonrpc: '2.0',\n    method: 'call',\n    params: {\n      service: 'object',\n      method: 'execute_kw',\n      args: [\n        db,\n        uid,  // 👈 Ahora es usuarioId (30 = Laura)\n        'admin',\n        'stock.scrap',\n        'create',\n        [[{\n          product_id: Number(l.product_id),\n          scrap_qty: Number(l.scrap_qty),\n          location_id: Number(location_id),\n          scrap_location_id: Number(scrap_location_id),\n          date_done: fecha,\n          origin: `Parte FSM - ${fecha}`\n        }]],\n        { context: { allowed_company_ids: (company_id ? [Number(company_id)] : []) } }\n      ]\n    },\n    id: Math.floor(Math.random() * 1e6)\n  };\n\n  items.push({\n    json: {\n      payload,\n      db,\n      uid,  \n      usuarioId,\n      usuarioNombre,\n      company_id,\n      location_id,\n      scrap_location_id,\n      total_productos: productosValidados.length,\n      productos_validados: productosValidados,\n      lineas_desecho,\n      product_id: Number(l.product_id),\n      product_name: l.product_name || '',\n      scrap_qty: Number(l.scrap_qty),\n      fecha\n    }\n  });\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4304,
        17824
      ],
      "id": "6ed43ba6-22e2-46dd-b703-b24c2ffb8726",
      "name": "Crear Órdenes de Desecho1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4816,
        17888
      ],
      "id": "5b7ff10e-280c-4edc-8d36-3c4c0a8499f0",
      "name": "HTTP Crear Desecho1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4544,
        17824
      ],
      "id": "119b9a8b-a5d7-4181-8840-09f35f0b3146",
      "name": "Loop Over Items para Desecho1"
    },
    {
      "parameters": {
        "jsCode": "// Ejecutar en la rama \"Done\" del SplitInBatches\n\n// Seed y nodos con posibles fuentes de chat_id\nconst seed   = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\nconst validar= $('Validar Productos')?.first()?.json || {};\n\n// Registro/hours id\nconst reg = seed.registro || {};\nconst horasHttp = $items('FSM ▸ HTTP Registrar Horas', 0)[0]?.json;\nconst horasId = horasHttp?.result ?? horasHttp?.body?.result ?? null;\n\n// Totales desecho (los que generó \"Crear Órdenes de Desecho1\")\nconst createdItems = $items('Crear Órdenes de Desecho1', 0) || [];\nconst totalDesechos = createdItems.length;\n\n// Posibles fuentes de chat_id\nconst chatFromReg      = reg.chat_id;\nconst chatFromValidar  = validar.chat_id;\nconst chatFromSeed     = seed.chat_id;\nconst chatFromScrap    = createdItems[0]?.json?.chat_id;\n\n// Fallback robusto (prioridad: registro → validar productos → seed → scrap)\nconst chatId = chatFromReg ?? chatFromValidar ?? chatFromSeed ?? chatFromScrap ?? 0;\n\n// Mensaje\nlet texto = '✅ **¡Parte de horas registrado exitosamente!**\\n\\n';\ntexto += '📋 **Detalles del registro:**\\n';\ntexto += `• **Proyecto:** ${reg.proyecto || seed.proyecto || '-'}\\n`;\ntexto += `• **Tarea:** ${reg.tarea || seed.tarea || '-'}\\n`;\ntexto += `• **Horas:** ${reg.horas ?? seed.horas ?? 0}\\n`;\ntexto += `• **Descripción:** ${reg.descripcion || seed.descripcion || '-'}\\n`;\ntexto += `• **Fecha:** ${new Date().toLocaleDateString('es-ES')}\\n`;\nif (horasId) {\n  texto += `• **ID del registro:** ${horasId}\\n`;\n  texto += `🔗 **Registro de horas:** [Abrir en Odoo](https://lsanchezgoshawk-n8npruebas.odoo.com/web#id=${horasId}&model=account.analytic.line&view_type=form)\\n`;\n}\ntexto += `\\n🗑️ **Órdenes de desecho creadas:** ${totalDesechos}\\n`;\ntexto += '🎉 **¡Listo!** ¿Necesitas registrar más horas? 😊';\n\nreturn { chat_id: chatId, texto };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5024,
        17680
      ],
      "id": "36e8ff3a-b3af-4efd-9301-fbfa9d655c86",
      "name": "Formatear Confirmación Desecho1"
    },
    {
      "parameters": {
        "jsCode": "// ✅ ACTUALIZADO: Valida el scrap sin pasar user_id\n\nconst res = $json.json?.result ?? $json.result ?? $json.body?.result;\nconst scrapId = Array.isArray(res) ? res[0] : res;\n\nconst prev = $items('Crear Órdenes de Desecho1', 0)[$itemIndex]?.json || {};\nconst db  = prev.db;\nconst uid = Number(prev.uid);\n\nif (!scrapId)  return [{ json: { skip_validate: true, motivo: 'sin scrapId' } }];\nif (!db || !Number.isFinite(uid)) {\n  return [{ json: { error: true, motivo: 'sin db/uid para validar', scrap_id: scrapId, db, uid } }];\n}\n\n// ✅ SIN pasar user_id en validación (no existe en stock.scrap)\n// Solo ejecutar action_validate sin parámetros adicionales\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [ \n      db, \n      uid, \n      'admin', \n      'stock.scrap', \n      'action_validate', \n      [[ scrapId ]] \n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn [{ json: { payload, db, uid, scrap_id: scrapId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5024,
        17888
      ],
      "id": "f0d909a8-3600-4169-8888-d26a7fb49ae2",
      "name": "Preparar Validación Scrap1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5248,
        17888
      ],
      "id": "a0407fd4-013b-4516-a6b7-e57a419305d3",
      "name": "HTTP Validar Scrap1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Contexto de tu rama\nconst base = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\nconst db   = base.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst uid  = base.uid;\n\n// Hint de almacén\nconst hint = String(base.warehouse_hint || 'principal').toLowerCase();\n\n// Dominio del warehouse\nlet domainWH;\nif (hint === 'principal') {\n  domainWH = ['|', ['code', '=', 'WH'], ['name', 'ilike', 'Principal']];\n} else if (hint === 'secundario') {\n  domainWH = ['|', ['code', '=', 'WH2'], ['name', 'ilike', 'Secundario']];\n} else {\n  domainWH = [['code', '=', 'WH']];\n}\n\n// payload para stock.warehouse\nconst payloadWH = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'stock.warehouse', 'search_read',\n      [ [domainWH].flat() ],\n      { fields: ['id','name','code','company_id','lot_stock_id'], limit: 1 }\n    ],\n  },\n  id: Math.floor(Math.random()*1e6),\n};\n\nreturn { payloadWH, db, uid };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2448,
        18000
      ],
      "id": "2581408c-f292-4473-a1a3-705c31e748b7",
      "name": "Buscar Almacén1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payloadWH }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2656,
        18000
      ],
      "id": "3529ffa3-01fc-4874-9784-b893f1e802a4",
      "name": "HTTP Buscar Warehouse1"
    },
    {
      "parameters": {
        "jsCode": "const httpWH = $json;\nconst list = httpWH.json?.result || httpWH.result || httpWH.body?.result || [];\nconst wh = Array.isArray(list) && list[0] ? list[0] : null;\nif (!wh) throw new Error('No se encontró warehouse');\n\nconst ctx = $items('Buscar Almacén1', 0)[0]?.json || {};\nconst db  = String(ctx.db);\nconst uid = Number(ctx.uid);\n\nconst company_id   = Array.isArray(wh.company_id)   ? wh.company_id[0]   : wh.company_id;\nconst lot_stock_id = Array.isArray(wh.lot_stock_id) ? wh.lot_stock_id[0] : wh.lot_stock_id;\n\nconst payloadScrapLoc = {\n  jsonrpc: '2.0', method: 'call',\n  params: { service:'object', method:'execute_kw',\n    args: [ db, uid, 'admin',\n      'stock.location','search_read',\n      [[ ['scrap_location','=',true], '|', ['company_id','=',false], ['company_id','=',company_id] ]],\n      { fields:['id','complete_name'], limit:1 }\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn { db, uid, company_id, location_id: lot_stock_id, payloadScrapLoc };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2864,
        18000
      ],
      "id": "e5718eac-46ce-4ef5-8d19-7be450636f23",
      "name": "Resolver Ubicaciones WH1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payloadScrapLoc }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3072,
        18000
      ],
      "id": "589fea97-67ac-4d5a-94cf-00f6ad507fe5",
      "name": "HTTP Buscar Ubicación Scrap1"
    },
    {
      "parameters": {
        "jsCode": "const res = $json.json?.result || $json.result || $json.body?.result || [];\nconst scrap = Array.isArray(res) && res[0] ? res[0] : null;\nif (!scrap) throw new Error('No se encontró Virtual/Scrap');\n\nlet ctx = {};\ntry { ctx = $items('Resolver Ubicaciones WH1', 0)[0]?.json || {}; } catch {}\n\nconst db          = ctx.db ?? $json.db;\nconst uid         = Number(ctx.uid ?? $json.uid);\nconst company_id  = ctx.company_id ?? $json.company_id;\nconst location_id = ctx.location_id ?? $json.location_id;\n\nif (!db || !Number.isFinite(uid)) {\n  return { error:true, motivo:'sin db/uid en contexto', db, uid };\n}\n\nreturn { db, uid, company_id, location_id, scrap_location_id: scrap.id };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3280,
        18000
      ],
      "id": "2ca2d092-76cb-410f-9c1f-f740aa515b19",
      "name": "Fijar IDs de Ubicaciones1"
    },
    {
      "parameters": {
        "jsCode": "// Normaliza el id creado y lo adjunta al item\nconst res = $json.result ?? $json.body?.result ?? $json.json?.result;\nconst proyecto_id = Number(res);\nif (!Number.isFinite(proyecto_id)) {\n  throw new Error('No se pudo resolver proyecto_id tras crear proyecto');\n}\nreturn { ...$json, proyecto_id };   // 👈 PROPAGA AQUÍ\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -864,
        18128
      ],
      "id": "659bf2d0-8fae-460e-9687-d8080337bd1e",
      "name": "Proyecto ID"
    },
    {
      "parameters": {
        "jsCode": "// Rehidrata ids cuando la tarea YA existe\nconst ctx  = $json;\n\n// Intenta leer de \"FSM ▸ Resolver Tarea ID\" (viene justo antes)\nlet task_id = Number(ctx.task_id);\nlet proyecto_id = Number(ctx.proyecto_id);\n\nif (!Number.isFinite(task_id) || !Number.isFinite(proyecto_id)) {\n  try {\n    const r = ctx.result || ctx.body?.result || [];\n    if (Array.isArray(r) && r[0]) {\n      if (!Number.isFinite(task_id) && r[0].id) task_id = Number(r[0].id);\n      if (!Number.isFinite(proyecto_id) && r[0].project_id) {\n        const pj = r[0].project_id;\n        proyecto_id = Number(Array.isArray(pj) ? pj[0] : pj);\n      }\n    }\n  } catch {}\n}\n\nif (!Number.isFinite(task_id) || !Number.isFinite(proyecto_id)) {\n  throw new Error(`Echo Tarea Existente: faltan ids (proyecto_id=${proyecto_id ?? 'null'}, task_id=${task_id ?? 'null'})`);\n}\n\nreturn { ...ctx, task_id, proyecto_id };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        17888
      ],
      "id": "76e2952a-34ce-411e-883d-4b5e504e1e3f",
      "name": "Tarea Existe"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR BÚSQUEDA PRODUCTOS FSM (multi-búsqueda con OR)\nconst seed = $('FSM ▸ Preparar Datos Completos')?.first()?.json || {};\nconst db   = seed.db;\nconst uid  = seed.uid;\nconst chat_id = seed.chat_id;\nconst productos = Array.isArray(seed.productos) ? seed.productos : [];\n\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\nconst normalize = (s) =>\n  (s || '').toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .toLowerCase()\n    .replace(/[^a-z0-9%\\. ]+/g,' ')\n    .replace(/\\s+/g,' ')\n    .trim();\n\nfunction variants(tok) {\n  const out = new Set([tok]);\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s'))  out.add(tok.slice(0, -1));\n  const m = tok.match(/^(\\d+(?:\\.\\d+)?)(kg|g|mg|l|ml|cm|mm|m|u|uds?)$/);\n  if (m) { out.add(m[1]); out.add(m[2]); }\n  return [...out];\n}\n\nfunction tokens(nombre) {\n  const base = normalize(nombre);\n  if (!base) return [];\n  const raw = base.split(' ').filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) for (const v of variants(tk)) if (v.length >= 2) uniq.add(v);\n  return [...uniq];\n}\n\n// Hojas OR para todos los productos solicitados\nlet leaves = [];\nfor (const p of productos) {\n  const nombre = String(p?.nombre || p?.name || '').trim();\n  const codigo = String(p?.codigo || p?.default_code || '').trim();\n  if (codigo) {\n    leaves.push(['default_code', '=', codigo]);\n  }\n  for (const tk of tokens(nombre)) {\n    leaves.push(['name', 'ilike', tk]);\n    leaves.push(['default_code', 'ilike', tk]);\n  }\n}\n\n// dedupe\nconst seen = new Set();\nleaves = leaves.filter(l => { const k = JSON.stringify(l); if (seen.has(k)) return false; seen.add(k); return true; });\n\nlet domain;\nif (!leaves.length) {\n  domain = [['id', '=', -1]]; // nada que buscar\n} else {\n  const orTokens = (leaves.length === 1) ? [leaves[0]] : [...Array(leaves.length - 1).fill('|'), ...leaves];\n  domain = ['&', ['sale_ok', '=', true], ...orTokens];\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'product.product', 'search_read',\n      [ domain ],\n      { fields: ['id','name','default_code','list_price'], limit: 300 }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn { payload, db, uid, chat_id, productos_solicitados: productos };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3472,
        18000
      ],
      "id": "3a6f4f55-e58e-45e2-a55b-fb76db9110ae",
      "name": "FSM ▸ Preparar Buscar Productos"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{  $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3680,
        18000
      ],
      "id": "6254d76e-b4bd-4caf-aae9-d991572d63bd",
      "name": "FSM ▸ HTTP Buscar Producto"
    },
    {
      "parameters": {
        "jsCode": "// Empareja productos solicitados con resultados de Odoo y devuelve product_id\nconst httpRes = $json.result || $json.body?.result || [];\nconst datos   = $('FSM ▸ Preparar Buscar Productos')?.first()?.json || {};\nconst solicitados = Array.isArray(datos.productos_solicitados) ? datos.productos_solicitados : [];\nconst chat_id = datos.chat_id;\n\nconst STOP = new Set(['con','de','y','para','en','la','el','los','las','por','del','a','al']);\nconst normalize = (s) =>\n  (s || '').toString()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g,'')\n    .replace(/\\s+/g,' ')\n    .toLowerCase()\n    .trim();\n\nfunction tokenVariants(tok) {\n  const out = new Set([tok]);\n  if (tok.endsWith('es')) out.add(tok.slice(0, -2));\n  if (tok.endsWith('s'))  out.add(tok.slice(0, -1));\n  const m = tok.match(/^(\\d+(?:\\.\\d+)?)(kg|g|mg|l|ml|cm|mm|m|u|uds?)$/);\n  if (m) { out.add(m[1]); out.add(m[2]); }\n  return [...out];\n}\nfunction tokens(s) {\n  const base = normalize(s);\n  if (!base) return [];\n  const raw = base.split(/[ \\-_/]+/).filter(t => t && !STOP.has(t));\n  const uniq = new Set();\n  for (const tk of raw) for (const v of tokenVariants(tk)) if (v.length >= 2 || /^\\d+(\\.\\d+)?$/.test(v)) uniq.add(v);\n  return [...uniq];\n}\nfunction levenshtein(a,b){\n  a=normalize(a); b=normalize(b);\n  const m=a.length,n=b.length; if(!m) return n; if(!n) return m;\n  const dp=Array.from({length:m+1},()=>Array(n+1).fill(0));\n  for(let i=0;i<=m;i++) dp[i][0]=i;\n  for(let j=0;j<=n;j++) dp[0][j]=j;\n  for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){\n    const cost=a[i-1]===b[j-1]?0:1;\n    dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+cost);\n  }\n  return dp[m][n];\n}\nfunction jaccardToken(a,b){\n  const A=new Set(tokens(a)), B=new Set(tokens(b));\n  const inter=[...A].filter(x=>B.has(x)).length;\n  const uni=new Set([...A,...B]).size;\n  return uni===0?0:inter/uni;\n}\nfunction sim(a,b){\n  const la=normalize(a), lb=normalize(b);\n  if(!la||!lb) return 0;\n  if(la===lb)  return 1;\n  const maxLen=Math.max(la.length,lb.length);\n  const ld=levenshtein(la,lb);\n  const levScore=1-(ld/Math.max(1,maxLen));\n  const jac=jaccardToken(a,b);\n  return (levScore*0.7)+(jac*0.3);\n}\n\nconst THRESH=0.88, MIN_SUG=0.35;\nconst pool = Array.isArray(httpRes)? httpRes : [];\nconst byExactCode = new Map(pool.filter(p=>p.default_code).map(p=>[String(p.default_code).trim(), p]));\nconst out = [];\nconst ambiguos = [];\n\nfor (const s of solicitados) {\n  const nombre = String(s?.nombre || s?.name || '').trim();\n  const codigo = String(s?.codigo || s?.default_code || '').trim();\n  const qty = Number(s?.cantidad || s?.qty || s?.quantity || 1) || 1;\n\n  // 1) match exacto por código\n  if (codigo && byExactCode.has(codigo)) {\n    const p = byExactCode.get(codigo);\n    out.push({ product_id: p.id, product_name: p.name, quantity: qty });\n    continue;\n  }\n\n  // 2) mejor candidato por similitud de nombre\n  let best = null;\n  for (const p of pool) {\n    const score = sim(nombre, p.name || '');\n    if (!best || score > best.score) best = { p, score };\n  }\n  if (best && best.score >= THRESH) {\n    out.push({ product_id: best.p.id, product_name: best.p.name, quantity: qty });\n  } else {\n    // guarda sugerencias (opcional)\n    const ranked = pool\n      .map(p => ({ id:p.id, name:p.name, score: Number(sim(nombre, p.name||'').toFixed(2)) }))\n      .filter(x => x.score >= MIN_SUG)\n      .sort((a,b)=>b.score-a.score)\n      .slice(0,7);\n    ambiguos.push({ solicitado: nombre, cantidad: qty, candidatos: ranked });\n  }\n}\n\nconst requiere_correccion = ambiguos.length > 0;\nlet texto_correccion = '';\nif (requiere_correccion) {\n  const lines = [\n    '🔎 Algunos productos no se pudieron identificar con seguridad.',\n    '',\n    'Responde con correcciones en el formato: `Nombre correcto x cantidad` (varios separados por comas).',\n    ''\n  ];\n  for (const amb of ambiguos) {\n    lines.push(`• **${amb.solicitado}** x ${amb.cantidad}`);\n    const sug = amb.candidatos.length ? amb.candidatos.map((c,i)=>`${i+1}. ${c.name} (${c.id})`).join('\\n') : '— Sin sugerencias —';\n    lines.push(`  Sugerencias:\\n${sug}\\n`);\n  }\n  texto_correccion = lines.join('\\n');\n}\n\nreturn {\n  chat_id,\n  requiere_correccion,\n  texto_correccion,\n  productos_validados: out\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3872,
        18000
      ],
      "id": "dc25b024-25a5-436b-b143-686f591b1851",
      "name": "Validar Productos"
    },
    {
      "parameters": {
        "content": "## Bloque consultar estado de proyecto",
        "width": 368
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -4000,
        18928
      ],
      "id": "477da184-a640-4b14-955e-525f9da16c0a",
      "name": "Sticky Note - Estado Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR CONSULTA ESTADO PROYECTO (con filtro por ETAPA)\nlet base = $json || {};\ntry { base = $('Router de Acciones FIXED').first().json || base; } catch {}\ntry { base = Object.assign({}, base, $('Preparar Datos AI Agent').first().json || {}); } catch {}\n\nconst rawMsg = String(base.mensaje_usuario || base.mensaje_original || '').trim();\n\n// --- detectar etapa solicitada ---\nconst stages = [\n  { key: 'in_progress', re: /(en\\s+(proceso|progreso|curso)|in\\s*progress|andando)/i,\n    labels: ['In Progress','En Progreso','En proceso','En curso'] },\n  { key: 'new', re: /(nuevo(s)?|nueva(s)?|por\\s*empezar|planificaci[oó]n|por\\s*hacer|to\\s*do)/i,\n    labels: ['New','Nuevo','Por hacer','To Do'] },\n  { key: 'done', re: /(hecho(s)?|finalizad[oa]s?|completad[oa]s?|cerrad[oa]s?|terminad[oa]s?|done)/i,\n    labels: ['Done','Hecho','Finalizado','Completado','Cerrado','Terminado'] },\n  { key: 'cancelled', re: /(cancelad[oa]s?|anulad[oa]s?)/i,\n    labels: ['Cancelled','Cancelado','Anulado'] },\n];\n\nlet listar_por_etapa = false;\nlet filtro_etapa = null;\nif (/\\bproyectos?\\b/i.test(rawMsg)) {\n  for (const s of stages) {\n    if (s.re.test(rawMsg)) { listar_por_etapa = true; filtro_etapa = { key: s.key, labels: s.labels }; break; }\n  }\n}\n\n// --- extracción de posible nombre de proyecto (para el flujo “uno solo”) ---\nlet proyecto = base.proyecto || '';\nif (!proyecto) {\n  let m = rawMsg.match(/[\"'“”‘’]([^\"'“”‘’]+)[\"'“”‘’]/); if (m) proyecto = m[1];\n}\nif (!proyecto) {\n  let m = rawMsg.match(/(?:proyecto|del\\s+proyecto|estado\\s+del\\s+proyecto)\\s+([\\p{L}\\d _-]+)/iu);\n  if (m) proyecto = m[1].trim();\n}\nif (!proyecto && rawMsg) {\n  const toks = rawMsg.split(/\\s+/); proyecto = (toks[toks.length-1]||'').replace(/[\\.,;:!?]+$/,'');\n}\n\n// detalle de timesheets\nconst includeTimesheets = /\\b(registro|registros|timesheet|partes?\\s*de\\s*trabajo|horas\\s*registradas)\\b/i.test(rawMsg) || base.includeTimesheets === true;\nconst daysBack = Number(base.daysBack || 90);\nconst since = new Date(Date.now() - daysBack*24*3600*1000).toISOString().slice(0,10);\n\nreturn {\n  chat_id: base.chat_id || 0,\n  user_id: base.user_id || 0,\n  user_name: base.user_name || 'Usuario',\n  mensaje_original: rawMsg,\n  proyecto_query: proyecto,\n  includeTimesheets,\n  daysBack,\n  since,\n  listar_por_etapa,\n  filtro_etapa\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3184,
        19072
      ],
      "id": "a1a72b87-a662-4c05-9986-216d2e8449b5",
      "name": "Preparar Consulta Estado Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Buscar Proyecto (SAFE)\nconst uid = $('Autenticar Odoo').item.json.result;\nconst name = $json.proyecto_query;\nif (!name) throw new Error('No se pudo extraer el nombre del proyecto');\n\nconst fields = [\n  'id','name','partner_id','user_id','date_start','date','company_id'\n  // ⛔ NO pongas: analytic_account_id, planned_hours, timesheet_grid, allow_timesheets\n];\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'project.project',\n      'search_read',\n      [\n        [[ 'name', 'ilike', name ]],\n        fields\n      ]\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn {\n  payload,\n  proyecto_query: name,\n  chat_id: $json.chat_id,\n  includeTimesheets: $json.includeTimesheets,\n  daysBack: $json.daysBack,\n  since: $json.since\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2736,
        19072
      ],
      "id": "ec5ad83d-5156-4b68-abbe-cb2e4cb99279",
      "name": "Preparar Buscar Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// Elegir proyecto o desambiguar\nconst res = $json.body?.result || $json.result || [];\nconst query = $('Preparar Buscar Proyecto').item.json.proyecto_query;\nlet chosen = null;\nlet suggestions = [];\nif (Array.isArray(res) && res.length) {\n  const norm = s => String(s||'').trim().toLowerCase();\n  chosen = res.find(p => norm(p.name) === norm(query)) || res[0];\n  suggestions = res.map(p => ({ id: p.id, name: p.name })).slice(0,5);\n}\nreturn { found: !!chosen, project: chosen, suggestions, query,\n         chat_id: $('Preparar Buscar Proyecto').item.json.chat_id,\n         includeTimesheets: $('Preparar Buscar Proyecto').item.json.includeTimesheets,\n         daysBack: $('Preparar Buscar Proyecto').item.json.daysBack,\n         since: $('Preparar Buscar Proyecto').item.json.since }"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2256,
        19072
      ],
      "id": "3337d544-cfd5-4cb3-b143-c3c950a264cc",
      "name": "Resolver Proyecto / Desambiguar"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "96dab1fd-11a8-44fc-9a98-f44466d2fec3",
              "leftValue": "={{ $json.found === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2016,
        19072
      ],
      "id": "1a5aa2db-44aa-40e5-bda5-99f19e956d34",
      "name": "¿Proyecto encontrado?"
    },
    {
      "parameters": {
        "jsCode": "// Preguntar por desambiguación y guardar memoria mínima\nconst sug = $json.suggestions || [];\nconst chat_id = $json.chat_id;\nlet texto = `🧭 No encontré una coincidencia clara para \"${$json.query}\".\\n`;\nif (sug.length) {\n  texto += `¿Te refieres a alguno de estos?\\n` + sug.map((s,i)=>`${i+1}. ${s.name}`).join('\\n');\n  texto += `\\n\\nResponde con el número o el nombre exacto.`;\n}\n// Guardar memoria simple en global para este chat (tu flujo ya persiste en PostgreSQL más adelante si quieres)\nconst key = `memoria_${chat_id}`; const m = global[key] || {}; m.esperando_confirmacion = 'elegir_proyecto_consulta'; m.datos_pendientes = { accion_original: 'consulta_estado_proyecto', query: $json.query, opciones: sug }; global[key] = m;\nreturn { chat_id, texto }"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1792,
        19216
      ],
      "id": "392a0ca7-4c8c-414f-a3b1-4ff2262c42d7",
      "name": "Formatear Desambiguación"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1536,
        19248
      ],
      "id": "67128b8a-5b92-44f9-8b5b-68f2ea9fb07f",
      "name": "Telegram Preguntar Proyecto",
      "webhookId": "1a111111-1111-4111-8111-111111111111"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Get Tareas (SAFE, sin planned_hours)\nconst uid = $('Autenticar Odoo').item.json.result;\nconst p = $json.project;\n\nconst fields = [\n  'id','name','stage_id','priority','date_deadline',\n  'project_id','create_date','write_date'\n  // ⛔ NO: 'planned_hours', 'kanban_state', 'user_id', 'effective_hours', 'remaining_hours'\n];\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'project.task',\n      'search_read',\n      [\n        [[ 'project_id','=', p.id ]],\n        fields\n      ]\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn {\n  payload,\n  project: p,\n  chat_id: $json.chat_id,\n  includeTimesheets: $json.includeTimesheets,\n  daysBack: $json.daysBack,\n  since: $json.since\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1776,
        18880
      ],
      "id": "17f1cd24-a913-4b24-a8d2-28182cb0239a",
      "name": "Preparar Get Tareas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1536,
        18880
      ],
      "id": "7ed96eac-7cc5-4ae4-8076-1b2bcd661323",
      "name": "HTTP Get Tareas"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Horas Agrupadas (robusto)\n// - Si hay tareas: domain = ['task_id','in', taskIds]\n// - Si NO hay tareas: domain = ['project_id','=', project.id]\n// - Opcional: filtro por fecha 'since' si existe\n\nconst uid = $('Autenticar Odoo').item.json.result;\n\n// Normaliza de dónde vienen las tareas\nconst raw = $json || {};\nconst tasksFromHttp = (raw.body && raw.body.result) ? raw.body.result\n                     : (Array.isArray(raw.result) ? raw.result\n                     : (Array.isArray(raw.tasks_full) ? raw.tasks_full : []));\nconst taskIds = tasksFromHttp.map(t => t.id).filter(id => Number.isInteger(id));\n\nconst project = raw.project || {};\nconst since = raw.since; // 'YYYY-MM-DD' si lo pasas en tu flujo\n\n// Construye el dominio\nconst domain = [];\nif (taskIds.length > 0) {\n  domain.push(['task_id', 'in', taskIds]);\n} else if (project.id) {\n  domain.push(['project_id', '=', project.id]);\n} else {\n  // Sin tareas y sin proyecto → evita llamada y devuelve estructura vacía\n  return {\n    skip_http: true,\n    tasks_full: [],\n    project,\n    chat_id: raw.chat_id,\n    since\n  };\n}\n\n// Filtro temporal opcional\nif (since) domain.push(['date', '>=', since]);\n\n// Payload para read_group\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898', // <-- tu DB\n      uid,\n      'admin',\n      'account.analytic.line',\n      'read_group',\n      [\n        domain,\n        ['unit_amount:sum'],   // suma horas\n        ['task_id']            // agrupación\n      ],\n      { lazy: false }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn {\n  payload,\n  tasks_full: tasksFromHttp,\n  project,\n  chat_id: raw.chat_id,\n  since\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1296,
        18880
      ],
      "id": "22a26425-f1c2-4921-b2a2-f78de8eeba7c",
      "name": "Preparar Horas Agrupadas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1056,
        18880
      ],
      "id": "2d351a1f-c8c3-4193-801a-df7944863447",
      "name": "HTTP Horas por Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Timesheets Detalle (robusto con fallback por grupos de horas)\n\n// Utilidad para leer items de otros nodos sin romper\nconst getNodeJson = (name, runIndex = 0, outputIndex = 0) => {\n  try {\n    const arr = $items(name, runIndex, outputIndex);\n    return (Array.isArray(arr) && arr.length) ? arr[0].json : null;\n  } catch (e) { return null; }\n};\n\nconst uid = $('Autenticar Odoo').item.json.result;\nconst db  = 'lsanchezgoshawk-n8npruebas-main-25736898'; // tu DB\n\n// 1) Intentamos conseguir TAREAS completas\nconst httpTareas = getNodeJson('HTTP Get Tareas');           // respuesta HTTP con body.result = tareas\nconst prepHoras  = getNodeJson('Preparar Horas Agrupadas');  // suele llevar tasks_full y since\nconst resProj    = getNodeJson('Resolver Proyecto / Desambiguar');\n\nconst tasks = (httpTareas?.body?.result) || httpTareas?.result || prepHoras?.tasks_full || $json.tasks_full || [];\nlet taskIds = (Array.isArray(tasks) ? tasks : []).map(t => t.id).filter(n => Number.isInteger(n));\n\n// 2) PROYECTO (si existe)\nconst project = (resProj?.project) || $json.project || prepHoras?.project || {};\n\n// 3) SINCE (si existe y es válido YYYY-MM-DD)\nconst sinceRaw = prepHoras?.since || $json.since || null;\nconst since = (sinceRaw && String(sinceRaw).match(/^\\d{4}-\\d{2}-\\d{2}$/)) ? sinceRaw : null;\n\n// 4) FALLBACK: si NO hay tasks, usa los GRUPOS del nodo de horas (entrada directa de este nodo)\nconst groupsIn = ($json?.body?.result) || $json.result || [];\nif ((!taskIds || taskIds.length === 0) && Array.isArray(groupsIn) && groupsIn.length) {\n  const fromGroups = [];\n  for (const g of groupsIn) {\n    const tid = Array.isArray(g.task_id) ? g.task_id[0] : g.task_id;\n    if (Number.isInteger(tid)) fromGroups.push(tid);\n  }\n  if (fromGroups.length) taskIds = Array.from(new Set(fromGroups));\n}\n\n// 5) Construcción de dominio (tareas > proyecto). Si nada, evitamos HTTP.\nconst domain = [];\nif (taskIds.length > 0) {\n  domain.push(['task_id','in', taskIds]);\n} else if (project.id) {\n  domain.push(['project_id','=', project.id]);\n} else {\n  return { skip_http: true, tasks_full: [], project: {} };\n}\nif (since) domain.push(['date','>=', since]); // jamás meter date >= null\n\n// 6) Payload search_read de líneas de horas (detalle)\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'account.analytic.line',\n      'search_read',\n      [\n        domain,\n        ['id','task_id','date','user_id','employee_id','unit_amount','name']\n      ],\n      { limit: 2000, order: 'date desc, id desc' }\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn {\n  payload,\n  project,\n  tasks_full: tasks,                       // puede ir vacío; no pasa nada\n  chat_id: prepHoras?.chat_id || $json.chat_id || 0,\n  since\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -496,
        18912
      ],
      "id": "abe4109f-64ce-44ef-874c-fd6710e3fa22",
      "name": "Preparar Timesheets Detalle"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -272,
        18912
      ],
      "id": "a07e3b78-a5b3-465f-bc54-6ce76eff45e2",
      "name": "HTTP Timesheets Detalle"
    },
    {
      "parameters": {
        "jsCode": "// ===== Formatear Respuesta Estado Proyecto (versión visual con emojis) =====\n\n// Helper: leer 1ª salida JSON de otro nodo\nconst getNodeJson = (name, runIndex = 0, outputIndex = 0) => {\n  try {\n    const arr = $items(name, runIndex, outputIndex);\n    return (Array.isArray(arr) && arr.length) ? arr[0].json : null;\n  } catch { return null; }\n};\n\n// Escape seguro para Markdown (usaremos backticks en nombres)\nconst clean = (s) => String(s ?? '').replace(/`/g, \"'\");\n\n// Datos base\nconst resProj   = getNodeJson('Resolver Proyecto / Desambiguar');\nconst httpTasks = getNodeJson('HTTP Get Tareas');\nconst httpHours = getNodeJson('HTTP Horas por Tarea');\nconst httpTs    = getNodeJson('HTTP Timesheets Detalle');\n\nconst project    = resProj?.project || $json.project || {};\nconst tasks      = (httpTasks?.body?.result) || httpTasks?.result || $json.tasks_full || [];\nconst hoursGroup = ($json.body?.result) || $json.result || httpHours?.body?.result || httpHours?.result || [];\nconst timesheets = (httpTs?.body?.result) || httpTs?.result || [];\n\nconst baseUrl = 'https://lsanchezgoshawk-n8npruebas.odoo.com';\nconst today   = new Date().toISOString().slice(0,10);\n\n// Mapa horas por tarea (read_group)\nconst hoursByTask = {};\nfor (const g of (hoursGroup || [])) {\n  const tid = Array.isArray(g.task_id) ? g.task_id[0] : g.task_id;\n  if (!tid) continue;\n  const v = (g['unit_amount'] ?? g['unit_amount:sum'] ?? 0);\n  hoursByTask[tid] = Number(v) || 0;\n}\n\n// KPI globales\nlet plan = 0, eff = 0;\nfor (const t of tasks) {\n  if (typeof t.planned_hours === 'number') plan += Number(t.planned_hours || 0);\n  eff += Number(hoursByTask[t.id] || t.effective_hours || 0);\n}\nconst avance = plan > 0 ? Math.min(100, Math.max(0, Math.round((eff/plan)*100))) : null;\n\n// Barra de progreso (10 bloques)\nconst progressBar = (pct) => {\n  const total = 10;\n  const filled = Math.round((pct/100)*total);\n  return '▰'.repeat(filled) + '▱'.repeat(total - filled);\n};\n\n// Icono por etapa / estado + retraso\nconst stageIcon = (stageName, isLate) => {\n  const s = String(stageName || '').toLowerCase();\n  const base = s.includes('done') || s.includes('hecho') ? '✅'\n             : s.includes('progress') || s.includes('en ') ? '🚧'\n             : '🆕';\n  return isLate ? '⏰' : base;\n};\n\n// Cabecera\nlet texto = `🗂️ *Proyecto:* \\`${clean(project?.name || '—')}\\`\\n`;\ntexto += `👤 *Cliente:* \\`${clean(project?.partner_id ? project.partner_id[1] : '—')}\\`  •  👨‍💼 *PM:* \\`${clean(project?.user_id ? project.user_id[1] : '—')}\\`\\n`;\ntexto += `🗓️ *Fechas:* inicio \\`${clean(project?.date_start || '—')}\\` · fin prevista \\`${clean(project?.date || '—')}\\`\\n`;\n\nif (plan > 0) {\n  texto += `⏱️ *Horas:* plan \\`${plan}h\\` · efectivas \\`${eff}h\\` · avance \\`${avance}%\\`\\n`;\n  texto += `   ${progressBar(avance)}\\n`;\n} else {\n  texto += `⏱️ *Horas:* efectivas \\`${eff}h\\`\\n`;\n}\n\nif (project?.id) {\n  texto += `🔗 [Abrir proyecto](${baseUrl}/web#id=${project.id}&model=project.project&view_type=form)\\n`;\n}\n\ntexto += `\\n📋 *Tareas (${tasks.length}):*\\n`;\n\n// Filas de tareas (máx 25 para no saturar Telegram)\nconst MAX_ROWS = 25;\nconst rows = [];\nfor (const t of tasks.slice(0, MAX_ROWS)) {\n  const etapa = Array.isArray(t.stage_id) ? t.stage_id[1] : null;\n\n  // Horas hechas\n  const hechas = (typeof t.effective_hours === 'number') ? t.effective_hours : (hoursByTask[t.id] || 0);\n\n  // Plan y restantes (si existe planned_hours)\n  const tienePlan = typeof t.planned_hours === 'number';\n  const rest = tienePlan ? Math.max(0, Number(t.planned_hours || 0) - Number(hechas || 0)) : null;\n\n  // Retraso (si no está done/hecho y deadline vencida)\n  const isDone = (String(etapa||'').toLowerCase().includes('done') || String(etapa||'').toLowerCase().includes('hecho'));\n  const isLate = (t.date_deadline && t.date_deadline < today && !isDone);\n\n  const icon = stageIcon(etapa, isLate);\n  const link = t.id ? `  🔗 [Abrir](${baseUrl}/web#id=${t.id}&model=project.task&view_type=form)` : '';\n\n  let line1 = `${icon} *\\`${clean(t.name)}\\`*  —  \\`${clean(etapa || '—')}\\``;\n  let line2 = `   · ⏱️ \\`Hechas ${hechas}h\\`` + (tienePlan ? ` · \\`Plan ${t.planned_hours||0}h\\` · \\`Rest. ${rest}h\\`` : ``);\n  if (t.date_deadline) line2 += ` · 🗓️ \\`${t.date_deadline}\\``;\n  const line3 = link;\n\n  rows.push(`${line1}\\n${line2}${line3 ? `\\n${line3}` : ''}`);\n}\nif (rows.length) texto += rows.join('\\n') + (tasks.length > MAX_ROWS ? `\\n… \\`${tasks.length - MAX_ROWS}\\` más` : '');\nelse texto += '—';\n\n// Bloque de timesheets (si hay)\nif (Array.isArray(timesheets) && timesheets.length) {\n  // Índice por tarea + ordenar por fecha desc\n  const tsByTask = {};\n  for (const l of timesheets) {\n    const tid = Array.isArray(l.task_id) ? l.task_id[0] : l.task_id;\n    if (!tid) continue;\n    (tsByTask[tid] ||= []).push(l);\n  }\n  for (const k of Object.keys(tsByTask)) tsByTask[k].sort((a,b)=> a.date < b.date ? 1 : -1);\n\n  texto += `\\n\\n🧾 *Registros recientes (máx. 3 por tarea):*\\n`;\n  for (const t of tasks) {\n    const ts = (tsByTask[t.id] || []).slice(0,3);\n    if (!ts.length) continue;\n    const lines = ts.map(x=>{\n      const who = (Array.isArray(x.user_id) ? x.user_id[1] :\n                  (Array.isArray(x.employee_id) ? x.employee_id[1] : '—'));\n      return `   · \\`${x.date || '—'}\\` · \\`${clean(who)}\\` · \\`${x.unit_amount || 0}h\\` · ${clean(x.name || '')}`;\n    });\n    texto += `• *\\`${clean(t.name)}\\`*\\n${lines.join('\\n')}\\n`;\n  }\n}\n\n// chat_id desde cualquier nodo previo\nconst chatId =\n  getNodeJson('Preparar Horas Agrupadas')?.chat_id ||\n  getNodeJson('Preparar Get Tareas')?.chat_id ||\n  getNodeJson('Resolver Proyecto / Desambiguar')?.chat_id ||\n  $json.chat_id || 0;\n\nreturn { chat_id: chatId, texto };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -16,
        18864
      ],
      "id": "1f46c3ed-f5a9-49c1-838e-326cb880b051",
      "name": "Formatear Respuesta Estado Proyecto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        224,
        18864
      ],
      "id": "c830d9b9-f49f-4a3e-bc22-05beaf21175b",
      "name": "Telegram Enviar Estado Proyecto",
      "webhookId": "2b222222-2222-4222-8222-222222222222"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2496,
        19072
      ],
      "id": "053f791e-7330-41c8-ba3e-b965ab22e385",
      "name": "HTTP Buscar Proyecto1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "05637c0d-ea70-4f42-84d5-93370d8d8f11",
              "leftValue": "={{ $json.listar_por_etapa === true }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2976,
        19072
      ],
      "id": "cc90f339-70b1-4586-819a-aebfaa06bb03",
      "name": "¿Listar por etapa?"
    },
    {
      "parameters": {
        "jsCode": "// Lee las tareas por etapa y devuelve los proyectos que caen en esa etapa.\n// No toca stage_id de project.project (evita AccessError).\nconst uid = $('Autenticar Odoo').item.json.result;\nconst db  = 'lsanchezgoshawk-n8npruebas-main-25736898';\n\nconst labels = ($json.filtro_etapa && $json.filtro_etapa.labels) || [];\nif (!labels.length) throw new Error('No pude identificar la etapa solicitada');\n\nconst parts = labels.map(l => ['stage_id.name','ilike', l]);\n// OR en dominio: N-1 pipes\nconst domain = parts.length === 1 ? parts\n  : [ ...Array(parts.length - 1).fill('|'), ...parts ];\n\n// Opcionalmente filtra activos\n// domain.push(['active','=',true]);\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'project.task', 'read_group',\n      [ domain, ['id:count'], ['project_id','stage_id'] ],\n      { lazy: false }\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn { payload, filtro_etapa: $json.filtro_etapa, chat_id: $json.chat_id };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2720,
        18624
      ],
      "id": "df0ba6f3-ac69-4215-9e25-40fa7cb953ed",
      "name": "Preparar Buscar Proyectos por Etapa"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2528,
        18624
      ],
      "id": "053bb032-a87d-4f51-9413-2aec5c62a851",
      "name": "HTTP Buscar Proyectos por Etapa"
    },
    {
      "parameters": {
        "jsCode": "const clean = s => String(s ?? '').replace(/`/g,\"'\");\nconst baseUrl = 'https://lsanchezgoshawk-n8npruebas.odoo.com';\n\nconst rows = ($json.body?.result) || $json.result || [];\nconst stage_by_project =\n  $json.stage_by_project ||\n  ($items('Preparar Buscar Proyectos por ID')[0]?.json?.stage_by_project) ||\n  {};\n\nconst etapaTxt = ($json.filtro_etapa?.labels?.[0]) ||\n                 ($items('Preparar Buscar Proyectos por ID')[0]?.json?.filtro_etapa?.labels?.[0]) ||\n                 'Etapa';\n\nconst iconByStage = (s) => {\n  s = String(s||'').toLowerCase();\n  if (s.includes('done') || s.includes('hecho') || s.includes('finaliz')) return '✅';\n  if (s.includes('progress') || s.includes('progreso') || s.includes('proceso') || s.includes('curso')) return '🚧';\n  if (s.includes('cancel')) return '🚫';\n  return '🆕';\n};\n\nlet texto = `🗂️ *Proyectos en:* \\`${clean(etapaTxt)}\\`\\n`;\ntexto += `Total: \\`${rows.length}\\`\\n\\n`;\n\nconst MAX = 50;\nconst list = [];\nfor (const p of rows.slice(0, MAX)) {\n  const stageName = stage_by_project[p.id] || '';\n  const icon = iconByStage(stageName);\n  const link = p.id ? `🔗 [Abrir](${baseUrl}/web#id=${p.id}&model=project.project&view_type=form)` : '';\n  list.push(\n    `${icon} *\\`${clean(p.name)}\\`* — \\`${clean(stageName||'—')}\\`\\n` +\n    `   👤 \\`${p.partner_id ? p.partner_id[1] : '—'}\\` · 👨‍💼 \\`${p.user_id ? p.user_id[1] : '—'}\\`${link ? `\\n   ${link}`: ''}`\n  );\n}\ntexto += list.join('\\n\\n');\nif (rows.length > MAX) texto += `\\n\\n… \\`${rows.length - MAX}\\` más`;\n\nconst chat_id = $json.chat_id || ($items('Preparar Buscar Proyectos por Etapa')[0]?.json?.chat_id) || 0;\nreturn { chat_id, texto };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1952,
        18624
      ],
      "id": "7252a25a-dc41-4bd5-95ce-b250722cda44",
      "name": "Formatear Lista Proyectos por Etapa"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1728,
        18624
      ],
      "id": "e251cb6e-ff5c-46c5-b88e-5e4c12ee5d65",
      "name": "Enviar Lista Proyectos por Etapa",
      "webhookId": "2b222222-2222-4222-8222-222222222222"
    },
    {
      "parameters": {
        "jsCode": "// Toma el resultado del read_group, extrae IDs de proyecto y arma un search_read seguro\nconst uid = $('Autenticar Odoo').item.json.result;\nconst db  = 'lsanchezgoshawk-n8npruebas-main-25736898';\n\nconst groups = ($json.body?.result) || $json.result || [];\nconst projectIds = [];\nconst stageByProject = {};\n\nfor (const g of groups) {\n  const pid = Array.isArray(g.project_id) ? g.project_id[0] : g.project_id;\n  const sName = Array.isArray(g.stage_id) ? g.stage_id[1] : g.stage_id;\n  if (Number.isInteger(pid)) {\n    projectIds.push(pid);\n    // guardamos la etapa “que ha hecho match” (leeremos 1)\n    if (!stageByProject[pid]) stageByProject[pid] = sName || '';\n  }\n}\n\nconst ids = Array.from(new Set(projectIds));\nif (!ids.length) {\n  return { chat_id: $json.chat_id, stage_by_project: stageByProject, empty: true };\n}\n\nconst fields = ['id','name','partner_id','user_id','date_start','date','company_id']; // SIN stage_id\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db, uid, 'admin',\n      'project.project', 'search_read',\n      [ [ ['id','in', ids] ], fields ]\n    ]\n  },\n  id: Math.floor(Math.random()*1e6)\n};\n\nreturn {\n  payload,\n  chat_id: $json.chat_id,\n  stage_by_project: stageByProject,\n  filtro_etapa: $json.filtro_etapa\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2320,
        18624
      ],
      "id": "ded7fe6c-d59b-41d2-97e4-d8609f83e090",
      "name": "Preparar Buscar Proyectos por ID"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2128,
        18624
      ],
      "id": "4284f31f-f3c0-404d-a224-3540031a4348",
      "name": "HTTP Buscar Proyectos por ID"
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot7856829828:AAGur9z3VznlJd-hCNlyE5xD5Bk8l4QZ4WI/getFile?file_id={{ $json.imagen_file_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -208,
        13616
      ],
      "id": "04d3c2a6-000d-4ea5-8402-a507beb4500d",
      "name": "Obtener File Path Real1"
    },
    {
      "parameters": {
        "jsCode": "// BUSCAR EMPLEADO (AUSENCIA) — prioriza odoo_user (email/login) + nombre\nconst datos = $('Procesar Datos Ausencia').item.json;\n\nconsole.log('🔍 === BUSCAR EMPLEADO (AUSENCIA) ===');\nconsole.log('📥 Datos recibidos:', JSON.stringify(datos, null, 2));\n\nconst datosAusencia = datos.datos_ausencia;\nconst uid = datos.uid;\n\nconst criterioNombre = (datosAusencia.empleado_nombre || '').toString().trim();\nconst criterioEmail  = (datosAusencia.odoo_user || '').toString().trim();\n\nconsole.log('👤 Criterio nombre:', criterioNombre);\nconsole.log('📧 Criterio email/login (odoo_user):', criterioEmail || '(no provisto)');\n\n// Dominio OR: name ilike OR work_email ilike OR user_id.login ilike\nlet domain;\nif (criterioEmail) {\n  domain = [\"|\",\"|\",\n    [\"work_email\", \"ilike\", criterioEmail],\n    [\"user_id.login\", \"ilike\", criterioEmail],\n    [\"name\", \"ilike\", criterioNombre || criterioEmail]\n  ];\n} else {\n  domain = [\"|\",\"|\",\n    [\"name\", \"ilike\", criterioNombre],\n    [\"work_email\", \"ilike\", criterioNombre],\n    [\"user_id.login\", \"ilike\", criterioNombre]\n  ];\n}\n\nconst consultaEmpleado = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"hr.employee\",\n      \"search_read\",\n      [ [ ...domain ] ],\n      { fields: [\"id\", \"name\", \"work_email\", \"user_id\"], limit: 10 }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Consulta empleado (ausencia):', JSON.stringify(consultaEmpleado, null, 2));\n\nreturn {\n  consulta_empleado: consultaEmpleado,\n  datos_ausencia: datosAusencia,\n  empleado_nombre: criterioNombre,\n  uid,\n  mensaje_error: `❌ No encontré al empleado \"${criterioNombre || criterioEmail}\" en Odoo.\\n\\n🤔 Verifica el nombre o el email (odoo_user).`\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2160,
        13616
      ],
      "id": "531f142c-dd1d-43ef-ad30-5b4245fc07f5",
      "name": "Buscar Empleado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_empleado }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1968,
        13616
      ],
      "id": "c90425e9-e4bc-454f-a2d3-efd034c8f34b",
      "name": "HTTP Buscar Empleado Ausencia"
    },
    {
      "parameters": {
        "jsCode": "// BUSCAR TIPO AUSENCIA con sinónimos y dominio OR\nconst { datos_ausencia, uid } = $('Procesar Datos Ausencia').item.json;\nconst tipoEntrada = (datos_ausencia.tipo || '').trim();\n\nconst MAPA_SINONIMOS = {\n  'Vacaciones': ['vacaciones', 'holiday', 'paid time off', 'time off', 'pto'],\n  'Permiso Médico': ['permiso médico', 'medico', 'médico', 'cita médica', 'doctor', 'medical', 'sick', 'sick leave', 'sick time', 'enfermedad'],\n  'Permiso': ['permiso', 'personal', 'leave'],\n  'Baja': ['baja', 'enfermedad', 'sick', 'sick leave'],\n};\n\nlet candidatos = [tipoEntrada];\nconst lower = tipoEntrada.toLowerCase();\nif (lower.includes('vacac')) candidatos = MAPA_SINONIMOS['Vacaciones'];\nelse if (lower.includes('méd') || lower.includes('medic') || lower.includes('doctor')) candidatos = MAPA_SINONIMOS['Permiso Médico'];\nelse if (lower.includes('permiso')) candidatos = MAPA_SINONIMOS['Permiso'];\nelse if (lower.includes('baja') || lower.includes('enfer')) candidatos = MAPA_SINONIMOS['Baja'];\nelse {\n  candidatos = [...new Set([\n    ...MAPA_SINONIMOS['Permiso Médico'],\n    ...MAPA_SINONIMOS['Permiso'],\n    ...MAPA_SINONIMOS['Baja'],\n    ...MAPA_SINONIMOS['Vacaciones'],\n  ])];\n}\n\n// Dominio OR: ['|','|', ['name','ilike','x'], ...]\nconst domain = [];\nfor (let i = 0; i < candidatos.length - 1; i++) domain.push('|');\nfor (const c of candidatos) domain.push(['name', 'ilike', c]);\n\nconst consultaTipo = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"hr.leave.type\",\n      \"search_read\",\n      [domain],\n      { fields: [\"id\", \"name\"], limit: 10 }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn { consulta_tipo: consultaTipo, datos_ausencia, uid, candidatos };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1584,
        13616
      ],
      "id": "9aac1d33-788a-4e2a-a4a0-2012476aca21",
      "name": "Buscar Tipo Ausencia"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.consulta_tipo}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1424,
        13616
      ],
      "id": "b9be917e-0f58-4e03-a3e5-d78e88de3589",
      "name": "HTTP Buscar Tipo Ausencia"
    },
    {
      "parameters": {
        "jsCode": "// CREAR AUSENCIA — elegir empleado por email (odoo_user ↔ work_email) si hay ambigüedad\nconst { datos_ausencia, uid } = $('Procesar Datos Ausencia').item.json;\nconst lista = $('HTTP Buscar Empleado Ausencia').item.json?.result || [];\nconst tipo = $('Elegir Tipo Ausencia').item.json.tipo_elegido;\n\nconst odooUser = (datos_ausencia.odoo_user || '').toString().trim().toLowerCase();\n\nif (!lista.length) throw new Error(`Empleado no encontrado: ${datos_ausencia.empleado_nombre}`);\nif (!tipo || typeof tipo.id !== 'number') throw new Error('Tipo de ausencia no válido');\n\n// 🔹 AQUI forzamos a que el tipo de ausencia sea el name que viene del nodo \"Elegir Tipo Ausencia\"\ndatos_ausencia.tipo = tipo.name || datos_ausencia.tipo || 'Ausencia';\n\n// 1) Coincidencia EXACTA por work_email si tenemos odoo_user\nlet empleado = null;\nif (odooUser) {\n  empleado = lista.find(e => (e.work_email || '').toString().trim().toLowerCase() === odooUser) || null;\n  if (empleado) {\n    console.log('🎯 Empleado elegido por email exacto:', empleado.name, empleado.work_email, 'ID:', empleado.id);\n  }\n}\n\n// 2) Coincidencia PARCIAL por email si hay varias y no hubo exacta\nif (!empleado && odooUser && lista.length > 1) {\n  const [local, domain] = odooUser.split('@');\n  empleado = lista.find(e => {\n    const em = (e.work_email || '').toString().trim().toLowerCase();\n    return (local && em.includes(local)) || (domain && em.endsWith('@' + domain));\n  }) || null;\n  if (empleado) {\n    console.log('🔎 Empleado elegido por email parcial:', empleado.name, empleado.work_email, 'ID:', empleado.id);\n  }\n}\n\n// 3) Si sigue sin candidato y hay un único resultado, tomarlo\nif (!empleado && lista.length === 1) {\n  empleado = lista[0];\n  console.log('✔️ Único resultado, seleccionado:', empleado.name, 'ID:', empleado.id);\n}\n\n// 4) Coincidencia EXACTA por nombre\nif (!empleado && lista.length > 1) {\n  const target = (datos_ausencia.empleado_nombre || '').toString().trim().toLowerCase();\n  empleado = lista.find(e => (e.name || '').toString().trim().toLowerCase() === target) || null;\n  if (empleado) {\n    console.log('🧭 Empleado elegido por nombre exacto:', empleado.name, 'ID:', empleado.id);\n  }\n}\n\n// 5) Último recurso\nif (!empleado) {\n  empleado = lista[0];\n  console.log('⚠️ Ambigüedad no resuelta. Tomando el primero:', empleado.name, empleado.work_email, 'ID:', empleado.id);\n}\n\n// Construir valores de la ausencia\nconst values = {\n  // 🔹 Usamos el tipo.name para que también quede bonito en Odoo\n  name: datos_ausencia.descripcion || `Ausencia (${datos_ausencia.tipo})`,\n  holiday_status_id: tipo.id,     // sigue yendo el ID, que es lo que Odoo espera\n  employee_id: empleado.id,\n};\n\nif (datos_ausencia.date_from && datos_ausencia.date_to) {\n  values.date_from = datos_ausencia.date_from;\n  values.date_to   = datos_ausencia.date_to;\n  values.request_date_from = datos_ausencia.fecha_inicio;\n  values.request_date_to   = datos_ausencia.fecha_fin;\n} else {\n  values.request_date_from = datos_ausencia.fecha_inicio;\n  values.request_date_to   = datos_ausencia.fecha_fin;\n}\n\nreturn {\n  consulta_crear_ausencia: {\n    jsonrpc:\"2.0\",\n    method:\"call\",\n    params:{\n      service:\"object\",\n      method:\"execute_kw\",\n      args:[\n        \"lsanchezgoshawk-n8npruebas-main-25736898\",\n        uid,\n        \"admin\",\n        \"hr.leave\",\n        \"create\",\n        [values]\n      ]\n    },\n    id: Math.floor(Math.random()*1000000)\n  },\n  datos_ausencia,\n  uid,\n  empleado_seleccionado: {\n    id: empleado.id,\n    name: empleado.name,\n    work_email: empleado.work_email || null\n  }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1056,
        13616
      ],
      "id": "c3ca2491-8bee-4dad-ae59-3c74dc6cca61",
      "name": "Crear Ausencia"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json.consulta_crear_ausencia}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -832,
        13616
      ],
      "id": "f1f4625f-b575-402c-ab20-c002e877d51a",
      "name": "Crear Ausencia Odoo"
    },
    {
      "parameters": {
        "jsCode": "// ADJUNTAR IMAGEN A LA AUSENCIA - ACTIVO\nconst leaveId = $json.result; // ID de la ausencia creada\nconst datosAusencia = $('Crear Ausencia').item.json.datos_ausencia;\nconst uid = $('Crear Ausencia').item.json.uid;\n\nconsole.log('🖼️ === ADJUNTAR IMAGEN (AUSENCIA) - ACTIVO ===');\nconsole.log('Leave ID:', leaveId);\nconsole.log('UID:', uid);\nconsole.log('Tiene imagen:', datosAusencia?.tiene_imagen);\nconsole.log('File ID:', datosAusencia?.imagen_file_id);\n\n// 👉 URL base de tu instancia Odoo\nconst baseUrl = 'https://lsanchezgoshawk-n8npruebas.odoo.com';\nconst enlaceOdoo = `${baseUrl}/web#id=${leaveId}&model=hr.leave&view_type=form`;\n\n// Validaciones básicas\nif (!leaveId) {\n  throw new Error('No se recibió el ID de la ausencia (leaveId).');\n}\n\n// Si no hay imagen o no hay file_id, continuar sin adjuntar\nif (!datosAusencia?.tiene_imagen || !datosAusencia?.imagen_file_id) {\n  console.log('ℹ️ No hay imagen para adjuntar en la ausencia');\n  return {\n    leave_id: leaveId,\n    datos_ausencia: datosAusencia,\n    imagen_adjuntada: false,\n    imagen_base64: null,\n    imagen_descargada: false,\n    uid,\n    enlace_odoo: enlaceOdoo,          // 👈 añadimos el enlace aquí también\n    paso: 'sin_imagen',\n    mensaje: 'Ausencia creada sin imagen'\n  };\n}\n\n// Preparar datos para la descarga de la imagen\nconsole.log('📸 Preparando descarga de imagen para ausencia...');\nreturn {\n  leave_id: leaveId,\n  datos_ausencia: datosAusencia,\n  imagen_file_id: datosAusencia.imagen_file_id,\n  img_data: datosAusencia.img_data || null,\n  uid,\n  enlace_odoo: enlaceOdoo,            // 👈 y aquí\n  paso: 'descargar_imagen',\n  mensaje: 'Preparando descarga de imagen (ausencia)'\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        13616
      ],
      "id": "549a4e2e-1fba-4208-b6ad-de81d227756f",
      "name": "Descargar y Adjuntar Imagen Ausencia"
    },
    {
      "parameters": {
        "jsCode": "// CONSTRUIR URL DE DESCARGA CON FILE_PATH REAL\nconst datosAnteriores = $('Descargar y Adjuntar Imagen Ausencia').item.json;\nconst getFileResponse = $('Obtener File Path Real1').item.json;\n\n// Crear objeto debug\nconst debugInfo = {\n  paso: 'CONSTRUIR_URL_CON_FILE_PATH_REAL',\n  respuesta_getfile: getFileResponse,\n  tiene_result: !!getFileResponse.result,\n  file_path_recibido: getFileResponse.result ? getFileResponse.result.file_path : null\n};\n\n// Obtener file_path real de la respuesta de getFile\nlet filePath = null;\nif (getFileResponse.ok && getFileResponse.result && getFileResponse.result.file_path) {\n  filePath = getFileResponse.result.file_path;\n  debugInfo.file_path_extraido = filePath;\n} else {\n  debugInfo.error = 'No se pudo obtener file_path de la respuesta getFile';\n  debugInfo.respuesta_completa = getFileResponse;\n  return {\n    ...datosAnteriores,\n    ERROR: 'No se pudo obtener file_path real de la API de Telegram',\n    DEBUG_COMPLETO: debugInfo\n  };\n}\n\n// Construir URL completa de descarga\nconst tokenReal = '7856829828:AAGur9z3VznlJd-hCNlyE5xD5Bk8l4QZ4WI';\nconst downloadUrl = `https://api.telegram.org/file/bot${tokenReal}/${filePath}`;\n\ndebugInfo.url_construida = downloadUrl;\ndebugInfo.token_usado = 'TOKEN_REAL_CORRECTO';\n\nconst resultado = {\n  ...datosAnteriores,\n  file_path: filePath,\n  download_url: downloadUrl,\n  telegram_file_info: getFileResponse.result,\n  DEBUG_VISIBLE: debugInfo\n};\n\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        13616
      ],
      "id": "f763fd70-7e70-45e6-add5-beb127b6155a",
      "name": "Construir URL Descarga Ausencia"
    },
    {
      "parameters": {
        "url": "={{ $json.download_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        208,
        13616
      ],
      "id": "bd618175-92e4-4d03-9ab8-26bb05dfc1bc",
      "name": "Descargar Imagen HTTP Ausencia"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR ADJUNTO DIRECTO (funciona con binario del item o del nodo HTTP)\nconst datosAnteriores = $('Construir URL Descarga Ausencia').item.json; // o el nodo que traiga leave_id/gasto_id\nconst resId = datosAnteriores.leave_id || datosAnteriores.gasto_id; // soporta ausencia/gasto\nconst uid = datosAnteriores.uid || 2;\n\nif (!resId) {\n  throw new Error('No hay ID de registro (leave_id/gasto_id) para adjuntar.');\n}\n\n// 1) Intento: binario en el item actual\nlet bin = null;\nlet binKeys = Object.keys($binary || {});\nif (binKeys.length) {\n  bin = $binary[binKeys[0]];\n}\n\n// 2) Fallback: leer binario del nodo \"Descargar Imagen HTTP\"\nif (!bin || !bin.data) {\n  const httpItems = $items('Descargar Imagen HTTP Ausencia', 0, 0) || [];\n  if (httpItems.length && httpItems[0].binary) {\n    const httpBinKeys = Object.keys(httpItems[0].binary);\n    if (httpBinKeys.length) {\n      bin = httpItems[0].binary[httpBinKeys[0]];\n    }\n  }\n}\n\n// 3) Si aún no hay binario, error con debug\nif (!bin || !bin.data) {\n  const debug = {\n    tieneBinaryActual: !!$binary,\n    keysBinaryActual: Object.keys($binary || {}),\n    tieneItemsHTTP: ($items('Descargar Imagen HTTP Ausencia', 0, 0) || []).length,\n    keysBinaryHTTP: (() => {\n      const it = $items('Descargar Imagen HTTP Ausencia', 0, 0) || [];\n      return it.length && it[0].binary ? Object.keys(it[0].binary) : [];\n    })(),\n    download_url: datosAnteriores.download_url || null,\n  };\n  throw new Error('No se encontraron datos binarios del archivo descargado | DEBUG: ' + JSON.stringify(debug));\n}\n\n// 4) Convertir base64 → Buffer\nconst archivoBinario = Buffer.from(bin.data, 'base64');\n\n// 5) Tipo/extension\nlet mimetype = bin.mimeType || 'image/jpeg';\nlet extension = bin.fileExtension || null;\nif (!extension) {\n  const sig = archivoBinario.slice(0, 8).toString('hex').toUpperCase();\n  if (sig.startsWith('89504E47')) { mimetype = 'image/png'; extension = 'png'; }\n  else if (sig.startsWith('FFD8FF')) { mimetype = 'image/jpeg'; extension = 'jpg'; }\n  else if (sig.startsWith('47494638')) { mimetype = 'image/gif'; extension = 'gif'; }\n  else if (sig.startsWith('52494646')) { mimetype = 'image/webp'; extension = 'webp'; }\n  else { extension = mimetype.includes('png') ? 'png' : 'jpg'; }\n}\n\n// 6) Preparar adjunto para Odoo\nconst archivoBase64 = archivoBinario.toString('base64');\nconst ts = new Date().toISOString().replace(/[:.]/g, '-');\nconst nombreArchivo = `Adjunto-${ts}.${extension}`;\n\n// Detectar modelo según lo que tengamos\nconst resModel = datosAnteriores.leave_id ? 'hr.leave' : 'hr.expense';\n\nconst consultaAdjunto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"ir.attachment\",\n      \"create\",\n      [{\n        name: nombreArchivo,\n        datas: archivoBase64,\n        res_model: resModel,\n        res_id: resId,\n        mimetype: mimetype,\n        type: 'binary'\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  leave_id: datosAnteriores.leave_id || null,\n  gasto_id: datosAnteriores.gasto_id || null,\n  datos_ausencia: datosAnteriores.datos_ausencia || null,\n  datos_gasto: datosAnteriores.datos_gasto || null,\n  consulta_adjunto: consultaAdjunto,\n  imagen_adjuntada: true,\n  archivo_info: {\n    nombre: nombreArchivo,\n    mimetype,\n    tamaño: archivoBinario.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        432,
        13616
      ],
      "id": "42b6f9a1-20a7-4557-91e8-45b91d28cd95",
      "name": "Preparar Adjunto Directo Ausencia"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_adjunto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        640,
        13616
      ],
      "id": "b55719ab-c286-43ea-848e-873133cbbf3a",
      "name": "HTTP Crear Adjunto Odoo Ausencia"
    },
    {
      "parameters": {
        "jsCode": "// FINALIZAR ADJUNTO (AUSENCIA)\nconst adjuntoId = $json.result;\nconst datosAnteriores = $('Preparar Adjunto Directo Ausencia').item.json;\n\n// Si no vino propagado, lo reconstruimos por seguridad\nconst baseUrl = 'https://lsanchezgoshawk-n8npruebas.odoo.com';\nconst enlaceFallback = datosAnteriores.leave_id\n  ? `${baseUrl}/web#id=${datosAnteriores.leave_id}&model=hr.leave&view_type=form`\n  : null;\n\n// Intentamos tomar el que ya venía desde \"Descargar y Adjuntar Imagen Ausencia\"\nconst enlaceOdoo =\n  $('Descargar y Adjuntar Imagen Ausencia').item.json.enlace_odoo || enlaceFallback;\n\nconsole.log('✅ === ADJUNTO COMPLETADO (AUSENCIA) ===');\nconsole.log('🆔 Adjunto ID:', adjuntoId);\n\nreturn {\n  leave_id: datosAnteriores.leave_id,\n  datos_ausencia: datosAnteriores.datos_ausencia,\n  imagen_adjuntada: true,\n  adjunto_id: adjuntoId,\n  enlace_odoo: enlaceOdoo,      // 👈 lo mantenemos en el payload final\n  mensaje: 'Ausencia creada con justificante adjuntado exitosamente'\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        13616
      ],
      "id": "9d6e5f9a-7644-48c7-9c58-16cf739ff20c",
      "name": "Finalizar Adjunto Ausencia"
    },
    {
      "parameters": {
        "jsCode": "// ELEGIR TIPO AUSENCIA (usa principal o fallback, el más parecido)\nconst principal = $('HTTP Buscar Tipo Ausencia').item.json?.result || [];\n\nconst candidatos = $('Buscar Tipo Ausencia').item.json.candidatos || [];\nconst pool = principal.length ? principal : fallback;\n\nfunction score(name) {\n  const n = (name || '').toLowerCase();\n  let s = 0;\n  for (const c of candidatos) if ((c||'') && n.includes(c.toLowerCase())) s += 2;\n  if (n.includes('sick') || n.includes('medical') || n.includes('méd')) s += 1;\n  if (n.includes('vac')) s += 1;\n  if (n.includes('permiso') || n.includes('leave')) s += 1;\n  return s;\n}\n\nconst ordenados = pool.map(t => ({ t, s: score(t.name) })).sort((a,b)=>b.s-a.s);\nif (!ordenados.length) throw new Error('Tipo de ausencia no encontrado en Odoo. Revisa hr.leave.type');\nconst elegido = ordenados[0].t;\n\nreturn { tipo_elegido: elegido };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1248,
        13616
      ],
      "id": "7b486bcf-0b68-4d0e-b261-e1eb906723e2",
      "name": "Elegir Tipo Ausencia"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ed56c2a4-20a1-4047-a782-3c732a97a472",
              "leftValue": "={{ $json.paso === 'descargar_imagen' && !!$json.imagen_file_id }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -432,
        13712
      ],
      "id": "dc657909-884f-4169-bc23-ea98f631f524",
      "name": "¿Hay imagen para adjuntar?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "77d760e5-b8f1-4a7e-bbb7-04687a4ce516",
              "leftValue": "={{ !!$json.result && Array.isArray($json.result) && $json.result.length > 0 }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1776,
        13616
      ],
      "id": "078f510c-68a1-44a2-9909-c6682c8e4909",
      "name": "¿Empleado Ausencia Encontrado?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Procesar Datos Ausencia').item.json.datos_ausencia.chat_id }}",
        "text": "={{ $('Buscar Empleado').item.json.mensaje_error }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1616,
        13792
      ],
      "id": "4c5b81d4-776d-4c99-9cb4-1c676ec711eb",
      "name": "Empleado No Encontrado Ausencia",
      "webhookId": "a8428235-06a8-4d75-9a88-15d68acb0106"
    },
    {
      "parameters": {
        "jsCode": "// BUSCAR EMPLEADO SIMPLIFICADO\nconst datos = $('Procesar Datos Gasto').item.json;\n\nconsole.log('🔍 === BUSCAR EMPLEADO SIMPLIFICADO ===');\nconsole.log('📥 Datos recibidos:', JSON.stringify(datos, null, 2));\n\nconst datosGasto = datos.datos_gasto;\nconst uid = datos.uid;\nlet empleadoNombre = datosGasto.empleado_nombre;\n\n// Si empleado_nombre está vacío, usar odoo_user como fallback\nif (!empleadoNombre || empleadoNombre.trim() === '') {\n    empleadoNombre = datosGasto.odoo_user;\n    console.log('ℹ️ Usando odoo_user como fallback:', empleadoNombre);\n}\n\nconsole.log('👤 Buscando empleado:', empleadoNombre);\n\n// Preparar consulta para buscar empleado directamente en hr.employee\nconst consultaEmpleado = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"hr.employee\",\n      \"search_read\",\n      [[\n        [\"name\", \"ilike\", empleadoNombre]\n      ]],\n      {\n        fields: [\"id\", \"name\", \"work_email\", \"user_id\"]\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🔍 Consulta empleado:', JSON.stringify(consultaEmpleado, null, 2));\n\nreturn {\n  consulta_empleado: consultaEmpleado,\n  datos_gasto: datosGasto,\n  empleado_nombre: empleadoNombre,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1872,
        9888
      ],
      "id": "73b71873-716f-43a5-a572-1a2772793b40",
      "name": "Buscar Empleado Simplificado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_empleado }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1680,
        9888
      ],
      "id": "336015a1-5467-48bc-8567-44a455996cd5",
      "name": "HTTP Buscar Empleado"
    },
    {
      "parameters": {
        "jsCode": "// VERIFICAR EMPLEADO SIMPLIFICADO (desambiguar por odoo_user ↔ work_email)\nconst empleadosEncontrados = $json.result || [];\nconst datos = $('Buscar Empleado Simplificado').item.json;\nconst datosGasto = datos.datos_gasto || {};\nconst empleadoNombre = (datos.empleado_nombre || '').toString().trim();\nconst uid = datos.uid;\n\nconst odooUser = (datosGasto.odoo_user || '').toString().trim().toLowerCase();\n\nconsole.log('✅ === VERIFICAR EMPLEADO SIMPLIFICADO ===');\nconsole.log('👥 Empleados encontrados:', empleadosEncontrados.length);\nconsole.log('👤 Buscando por nombre:', empleadoNombre);\nconsole.log('📧 Desambiguando por odoo_user:', odooUser || '(no provisto)');\n\nif (empleadosEncontrados.length === 0) {\n  console.log('❌ No se encontró empleado');\n  return {\n    empleado_encontrado: false,\n    datos_gasto: datosGasto,\n    empleado_nombre: empleadoNombre,\n    uid: uid,\n    mensaje_error: `❌ No encontré al empleado \"${empleadoNombre}\" en Odoo.\\n\\n💰 Gasto: ${datosGasto.importe}€ por ${datosGasto.descripcion}\\n\\n🤔 Verifica el nombre del empleado o el email (odoo_user).`\n  };\n}\n\n// 1) Si tenemos odoo_user, priorizar coincidencia EXACTA con work_email\nlet candidato = null;\nif (odooUser) {\n  const exactEmailMatch = empleadosEncontrados.find(e =>\n    (e.work_email || '').toString().trim().toLowerCase() === odooUser\n  );\n  if (exactEmailMatch) {\n    candidato = exactEmailMatch;\n    console.log('🎯 Coincidencia EXACTA por work_email:', exactEmailMatch.work_email, 'ID:', exactEmailMatch.id);\n  }\n}\n\n// 2) Si no hay exacta, y hay varias, intentar coincidencia parcial por email\nif (!candidato && odooUser && empleadosEncontrados.length > 1) {\n  const [local, domain] = odooUser.split('@');\n  const parcial = empleadosEncontrados.find(e => {\n    const em = (e.work_email || '').toString().trim().toLowerCase();\n    return (local && em.includes(local)) || (domain && em.endsWith('@' + domain));\n  });\n  if (parcial) {\n    candidato = parcial;\n    console.log('🔎 Coincidencia PARCIAL por work_email:', parcial.work_email, 'ID:', parcial.id);\n  }\n}\n\n// 3) Si sigue sin candidato y hay un único resultado, tomarlo\nif (!candidato && empleadosEncontrados.length === 1) {\n  candidato = empleadosEncontrados[0];\n  console.log('✔️ Único resultado, seleccionado:', candidato.name, 'ID:', candidato.id);\n}\n\n// 4) Si no hay odoo_user y hay múltiples, intentar match EXACTO por nombre\nif (!candidato && !odooUser && empleadosEncontrados.length > 1) {\n  const exactName = empleadosEncontrados.find(e =>\n    (e.name || '').toString().trim().toLowerCase() === empleadoNombre.toLowerCase()\n  );\n  if (exactName) {\n    candidato = exactName;\n    console.log('🧭 Coincidencia EXACTA por nombre:', exactName.name, 'ID:', exactName.id);\n  }\n}\n\n// 5) Si aún ambiguo, devolver error con opciones para que el flujo lo maneje\nif (!candidato) {\n  const opciones = empleadosEncontrados.map(e => {\n    const email = e.work_email || 'sin email';\n    return `${e.name} <${email}> [id:${e.id}]`;\n  }).join('\\n- ');\n  const msg = `⚠️ Hay varias coincidencias para \"${empleadoNombre}\" y no se pudo desambiguar por email.\\n` +\n              (odooUser ? `Intenté casar con \"${odooUser}\".\\n` : 'No se proporcionó odoo_user para desambiguar.\\n') +\n              `\\nCoincidencias:\\n- ${opciones}\\n\\n` +\n              `💰 Gasto: ${datosGasto.importe}€ por ${datosGasto.descripcion}\\n` +\n              `👉 Indica el email exacto (odoo_user) o elige uno.`;\n\n  console.log('❌ Ambigüedad en empleados. Requiere intervención.', opciones);\n  return {\n    empleado_encontrado: false,\n    datos_gasto: datosGasto,\n    empleado_nombre: empleadoNombre,\n    uid: uid,\n    mensaje_error: msg\n  };\n}\n\n// ✅ Candidato elegido\nconsole.log('✅ Empleado seleccionado:', candidato.name, 'Email:', candidato.work_email, 'ID:', candidato.id);\n\nreturn {\n  empleado_encontrado: true,\n  empleado: candidato,\n  datos_gasto: datosGasto,\n  uid: uid\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        9888
      ],
      "id": "b2b547b8-f618-4cd7-992a-8ae5c91c8c59",
      "name": "Verificar Empleado Simplificado"
    },
    {
      "parameters": {
        "jsCode": "// CREAR GASTO SIMPLIFICADO — con manejo de error de empleado no encontrado\nconst empleadoEncontrado = $json.empleado_encontrado;\nconst empleado = $json.empleado;\nconst datosGasto = $json.datos_gasto;\nconst uid = $json.uid;\n\nconsole.log('💰 === CREAR GASTO SIMPLIFICADO ===');\n\n// Verificar si el empleado fue encontrado\nif (!empleadoEncontrado) {\n  console.log('❌ Empleado no encontrado, lanzando error para manejo del workflow');\n  const mensajeError = $json.mensaje_error || 'No se pudo encontrar el empleado';\n  \n  // Crear un error personalizado que incluya el chat_id para poder enviar el mensaje\n  const error = new Error(mensajeError);\n  error.chatId = datosGasto.chat_id;\n  error.description = JSON.stringify({\n    error: true,\n    chat_id: datosGasto.chat_id,\n    mensaje: mensajeError,\n    tipo: 'empleado_no_encontrado'\n  });\n  \n  throw error;\n}\n\nconsole.log('👤 Empleado:', empleado.name, '(ID:', empleado.id, ')');\nconsole.log('💵 Gasto:', datosGasto.importe, '€ -', datosGasto.descripcion);\nconsole.log('📅 Fecha:', datosGasto.fecha);\n\n// Crear gasto directamente en hr.expense\nconst consultaCrearGasto = {\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"object\",\n    \"method\": \"execute_kw\",\n    \"args\": [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"hr.expense\",\n      \"create\",\n      [{\n        \"name\": datosGasto.descripcion,\n        \"total_amount_currency\": datosGasto.importe,\n        \"quantity\": 1.0,\n        \"date\": datosGasto.fecha,\n        \"employee_id\": empleado.id,\n        \"payment_mode\": \"own_account\",\n        \"product_id\": 1  // Categoría \"Gastos\" por defecto - ajustar ID según tu configuración\n      }]\n    ]\n  },\n  \"id\": Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  consulta_crear_gasto: consultaCrearGasto,\n  empleado: empleado,\n  datos_gasto: datosGasto,\n  uid: uid,\n  error: false\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1040,
        9888
      ],
      "id": "1c040150-cad6-4823-ba25-21f5ae4cdc18",
      "name": "Crear Gasto Simplificado",
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_crear_gasto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -848,
        9888
      ],
      "id": "b87a2734-d205-4eca-8c11-ea31b0ec5751",
      "name": "Crear Gasto Odoo",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ADJUNTAR IMAGEN AL GASTO - ACTIVO CON MANEJO DE ERROR\n// Verificar si hubo error en los nodos anteriores\nconst datosCrearGasto = $('Crear Gasto Simplificado').item.json;\n\n// Si el nodo anterior falló por empleado no encontrado\nif (datosCrearGasto.error) {\n  console.log('❌ === ERROR DETECTADO: Empleado no encontrado ===');\n  console.log('📤 Preparando mensaje de error para Telegram');\n  \n  // Extraer el mensaje de error del objeto error\n  let mensajeError = datosCrearGasto.mensaje_error || '❌ No se pudo crear el gasto.';\n  \n  // Si hay información del error en pairedItem\n  if ($json.error && $json.error.message) {\n    console.log('Error capturado:', $json.error.message);\n    mensajeError = $json.error.message;\n  }\n  \n  // Retornar datos para enviar mensaje de error por Telegram\n  return {\n    error_gasto: true,\n    chat_id: datosCrearGasto.datos_gasto?.chat_id,\n    mensaje_telegram: mensajeError,\n    tipo: 'error_empleado_no_encontrado'\n  };\n}\n\nconst gastoId = $json.result; // ID del gasto creado\nconst datosGasto = datosCrearGasto.datos_gasto;\nconst uid = datosCrearGasto.uid;\n\nconsole.log('🖼️ === ADJUNTAR IMAGEN - ACTIVO ===');\nconsole.log('Gasto ID:', gastoId);\nconsole.log('UID:', uid);\nconsole.log('Tiene imagen flag:', datosGasto.tiene_imagen);\n\n// Si no hay imagen, continuar sin ella\nif (!datosGasto.tiene_imagen) {\n  console.log('ℹ️ No hay imagen para adjuntar');\n  return {\n    gasto_id: gastoId,\n    datos_gasto: datosGasto,\n    imagen_adjuntada: false,\n    imagen_base64: null,\n    imagen_descargada: false,\n    uid: uid,\n    paso: 'sin_imagen',\n    mensaje: 'Gasto creado sin imagen'\n  };\n}\n\nconsole.log('📸 Preparando descarga de imagen...');\nconsole.log('🆔 File ID:', datosGasto.imagen_file_id);\n\n// Pasar datos para que el siguiente nodo descargue la imagen\nreturn {\n  gasto_id: gastoId,\n  datos_gasto: datosGasto,\n  imagen_file_id: datosGasto.imagen_file_id,\n  img_data: datosGasto.img_data,\n  uid: uid,\n  paso: 'descargar_imagen',\n  mensaje: 'Preparando descarga de imagen'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -544,
        9888
      ],
      "id": "0c83ba04-a9b5-4229-a034-5cdfb9e8abe4",
      "name": "Descargar y Adjuntar Imagen"
    },
    {
      "parameters": {
        "jsCode": "// CONSTRUIR URL DE DESCARGA CON FILE_PATH REAL\nconst datosAnteriores = $('Descargar y Adjuntar Imagen').item.json;\nconst getFileResponse = $('Obtener File Path Real').item.json;\n\n// Crear objeto debug\nconst debugInfo = {\n  paso: 'CONSTRUIR_URL_CON_FILE_PATH_REAL',\n  respuesta_getfile: getFileResponse,\n  tiene_result: !!getFileResponse.result,\n  file_path_recibido: getFileResponse.result ? getFileResponse.result.file_path : null\n};\n\n// Obtener file_path real de la respuesta de getFile\nlet filePath = null;\nif (getFileResponse.ok && getFileResponse.result && getFileResponse.result.file_path) {\n  filePath = getFileResponse.result.file_path;\n  debugInfo.file_path_extraido = filePath;\n} else {\n  debugInfo.error = 'No se pudo obtener file_path de la respuesta getFile';\n  debugInfo.respuesta_completa = getFileResponse;\n  return {\n    ...datosAnteriores,\n    ERROR: 'No se pudo obtener file_path real de la API de Telegram',\n    DEBUG_COMPLETO: debugInfo\n  };\n}\n\n// Construir URL completa de descarga\nconst tokenReal = '7856829828:AAGur9z3VznlJd-hCNlyE5xD5Bk8l4QZ4WI';\nconst downloadUrl = `https://api.telegram.org/file/bot${tokenReal}/${filePath}`;\n\ndebugInfo.url_construida = downloadUrl;\ndebugInfo.token_usado = 'TOKEN_REAL_CORRECTO';\n\nconst resultado = {\n  ...datosAnteriores,\n  file_path: filePath,\n  download_url: downloadUrl,\n  telegram_file_info: getFileResponse.result,\n  DEBUG_VISIBLE: debugInfo\n};\n\nreturn resultado;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -128,
        9888
      ],
      "id": "b3d178e3-ec89-4767-9648-39d977bc0233",
      "name": "Construir URL Descarga",
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot7856829828:AAGur9z3VznlJd-hCNlyE5xD5Bk8l4QZ4WI/getFile?file_id={{ $('Descargar y Adjuntar Imagen').item.json.imagen_file_id }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -336,
        9888
      ],
      "id": "1072d947-8893-4855-9171-2b440c6244ef",
      "name": "Obtener File Path Real",
      "continueOnFail": true
    },
    {
      "parameters": {
        "url": "={{ $json.download_url }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        64,
        9888
      ],
      "id": "07faf514-0017-4e6c-b69f-73a1c73674ba",
      "name": "Descargar Imagen HTTP",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR ADJUNTO DIRECTO DESDE DESCARGA HTTP\n// Metadatos desde el nodo que construye la URL\nconst datosAnteriores = $('Construir URL Descarga').item.json;\nconst gastoId = datosAnteriores.gasto_id;\nconst uid = datosAnteriores.uid || 2;\n\nconsole.log('📎 === PREPARAR ADJUNTO DIRECTO ===');\nconsole.log('Gasto ID:', gastoId);\nconsole.log('UID:', uid);\nconsole.log('🔗 download_url:', datosAnteriores.download_url);\n\n// Validar que tenemos el gasto ID\nif (!gastoId) {\n  throw new Error('gastoId es requerido para crear el adjunto');\n}\n\n// 1) Intento normal: binario del item actual\nlet bin = null;\nlet binKeys = Object.keys($binary || {});\nconsole.log('Binary keys (item actual):', binKeys);\n\nif (binKeys.length) {\n  bin = $binary[binKeys[0]];\n}\n\n// 2) Fallback: tomar binario explícitamente del nodo \"Descargar Imagen HTTP\"\nif (!bin || !bin.data) {\n  const httpItems = $items('Descargar Imagen HTTP', 0, 0) || [];\n  if (httpItems.length && httpItems[0].binary) {\n    const httpBinKeys = Object.keys(httpItems[0].binary);\n    console.log('Binary keys (desde \"Descargar Imagen HTTP\"):', httpBinKeys);\n    if (httpBinKeys.length) {\n      bin = httpItems[0].binary[httpBinKeys[0]];\n    }\n  }\n}\n\n// Si aún no hay binario, detallar por qué\nif (!bin || !bin.data) {\n  console.log('❌ No hay binario disponible.');\n  console.log('Resumen debug:', {\n    tieneBinaryActual: !!$binary,\n    keysBinaryActual: Object.keys($binary || {}),\n    tieneItemsHTTP: !!$items('Descargar Imagen HTTP', 0, 0)?.length,\n    jsonHTTP: $items('Descargar Imagen HTTP', 0, 0)?.[0]?.json || null,\n  });\n  throw new Error('No se encontraron datos binarios del archivo descargado');\n}\n\n// Convertir base64 → Buffer\nconst archivoBinario = Buffer.from(bin.data, 'base64');\nconsole.log('✅ Binario cargado:', archivoBinario.length, 'bytes');\n\n// Detectar tipo de archivo\nlet mimetype = bin.mimeType || 'image/jpeg';\nlet extension = bin.fileExtension || null;\n\n// Deducción por firma si falta extensión\nif (!extension) {\n  const firstBytes = archivoBinario.slice(0, 8);\n  const signature = firstBytes.toString('hex').toUpperCase();\n\n  if (signature.startsWith('89504E47')) {\n    mimetype = 'image/png';\n    extension = 'png';\n  } else if (signature.startsWith('FFD8FF')) {\n    mimetype = 'image/jpeg';\n    extension = 'jpg';\n  } else if (signature.startsWith('47494638')) {\n    mimetype = 'image/gif';\n    extension = 'gif';\n  } else if (signature.startsWith('52494646')) {\n    mimetype = 'image/webp';\n    extension = 'webp';\n  } else {\n    if (mimetype.includes('png')) extension = 'png';\n    else if (mimetype.includes('webp')) extension = 'webp';\n    else if (mimetype.includes('gif')) extension = 'gif';\n    else extension = 'jpg';\n  }\n}\n\nconsole.log('🖼️ Tipo detectado:', mimetype, 'Extensión:', extension);\n\n// Convertir a base64 para Odoo\nconst archivoBase64 = archivoBinario.toString('base64');\nconsole.log('✅ Convertido a base64:', archivoBase64.length, 'caracteres');\n\n// Crear nombre de archivo\nconst timestamp = new Date().toISOString().replace(/[:.]/g, '-');\nconst nombreArchivo = `Recibo-${timestamp}.${extension}`;\n\n// Preparar consulta para Odoo\nconst consultaAdjunto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"ir.attachment\",\n      \"create\",\n      [{\n        name: nombreArchivo,\n        datas: archivoBase64,\n        res_model: 'hr.expense',\n        res_id: gastoId,\n        mimetype: mimetype,\n        type: 'binary'\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('🎯 Adjunto preparado para Odoo');\nconsole.log('📄 Nombre:', nombreArchivo);\nconsole.log('📏 Tamaño:', archivoBinario.length, 'bytes');\n\nreturn {\n  gasto_id: gastoId,\n  datos_gasto: datosAnteriores.datos_gasto,\n  consulta_adjunto: consultaAdjunto,\n  imagen_adjuntada: true,\n  archivo_info: {\n    nombre: nombreArchivo,\n    mimetype: mimetype,\n    tamaño: archivoBinario.length\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        320,
        9888
      ],
      "id": "be28150f-29e7-49bd-b62d-c8091cfcace2",
      "name": "Preparar Adjunto Directo",
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.consulta_adjunto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        576,
        9888
      ],
      "id": "5ad34bf9-4dc8-4a3f-970a-49d16dabd1b2",
      "name": "HTTP Crear Adjunto Odoo",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// FINALIZAR ADJUNTO DE RECIBO\nconst adjuntoId = $json.result;\nconst datosAnteriores = $('Preparar Adjunto Directo').item.json;\n\nconsole.log('✅ === ADJUNTO COMPLETADO ===');\nconsole.log('🆔 Adjunto ID:', adjuntoId);\n\nreturn {\n  gasto_id: datosAnteriores.gasto_id,\n  datos_gasto: datosAnteriores.datos_gasto,\n  imagen_adjuntada: true,\n  adjunto_id: adjuntoId,\n  mensaje: 'Gasto creado con recibo adjuntado exitosamente'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        944,
        9888
      ],
      "id": "26673682-7dc7-44a4-b790-edef1e92aafa",
      "name": "Finalizar Adjunto",
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "aa3050fe-0829-419c-b963-1656907cb793",
              "leftValue": "={{ $json.empleado_encontrado }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1280,
        9888
      ],
      "id": "a9d4d8fd-1344-41fc-a2a3-36bc2440e833",
      "name": "¿Existe empleado?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id \n   || $json.datos_gasto?.chat_id\n   || $('Crear Gasto Simplificado').item.json.datos_gasto?.chat_id\n}}",
        "text": "={{ $('Verificar Empleado Simplificado').item.json.mensaje_error || '❌ Ha ocurrido un error. Por favor revisa el nombre del empleado.' }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1104,
        10064
      ],
      "id": "3338ff7c-7e2c-4d45-ab76-6ba5f0df8331",
      "name": "Empleado No Encontrado",
      "webhookId": "621a1ad0-bd5c-4899-aabf-3ac32ca741ef"
    },
    {
      "parameters": {
        "jsCode": "const normalize = (s) => {\n  if (!s) return s;\n  return s.normalize('NFD').replace(/\\p{Diacritic}/gu, '').toLowerCase().trim().replace(/\\s+/g, ' ');\n};\n\nconst input = items[0].json || {};\nlet producto = input.producto || (input.datos_pendientes && input.datos_pendientes.producto) || null;\nlet cantidad = input.cantidad || (input.datos_pendientes && input.datos_pendientes.cantidad) || null;\nlet unidad = input.unidad || null;\nlet almacen_origen = input.almacen_origen || (input.datos_pendientes && input.datos_pendientes.almacen_origen) || null;\nlet almacen_destino = input.almacen_destino || (input.datos_pendientes && input.datos_pendientes.almacen_destino) || null;\n\nconst mensaje = input.mensaje_usuario || '';\nif ((!producto || !cantidad) && mensaje) {\n  // Patrón: \"pasa 5 tornillos del almacen WH al almacen AA\"\n  const m1 = mensaje.match(/(?:pasa|pasar|transferir|mueve|envia|envía)\\s+([0-9]+(?:[.,][0-9]+)?)\\s+([^,\\n]+?)\\s+(?:del|desde|de)\\s+almac[ée]n?\\s+([A-Za-z0-9_-]+)\\s+(?:al|a|hacia)\\s+(?:almac[ée]n\\s+)?([A-Za-z0-9_-]+)/i);\n  if (m1) {\n    cantidad = cantidad || parseFloat(m1[1].replace(',', '.'));\n    producto = producto || m1[2].trim();\n    almacen_origen = almacen_origen || m1[3].trim();\n    almacen_destino = almacen_destino || m1[4].trim();\n  }\n}\n\nproducto = producto ? producto.toString().trim() : null;\nconst producto_norm = producto ? normalize(producto) : null;\nconst almacen_origen_norm = almacen_origen ? almacen_origen.toString().trim() : null;\nconst almacen_destino_norm = almacen_destino ? almacen_destino.toString().trim() : null;\n\n// Mapeo de alias\nconst alias_almacenes = {\n  'principal': 'WH',\n  'secundario': 'AA',\n  'almacen principal': 'WH',\n  'almacen secundario': 'AA'\n};\nconst mapAlias = (v) => {\n  if (!v) return v;\n  const low = v.toString().toLowerCase();\n  return alias_almacenes[low] || v;\n};\n\nconst out = {\n  accion: input.accion || 'transferir_stock_almacen',\n  producto: producto_norm || null,\n  producto_raw: producto || null,\n  cantidad: cantidad != null ? cantidad : null,\n  unidad: unidad || null,\n  almacen_origen: mapAlias(almacen_origen_norm) || null,\n  almacen_destino: mapAlias(almacen_destino_norm) || null,\n  datos_pendientes: input.datos_pendientes || null,\n  mensaje_usuario: mensaje || null,\n  chat_id: input.chat_id,\n  uid: input.uid\n};\n\nreturn [{ json: out }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3232,
        19680
      ],
      "id": "8a08078c-c48b-40dd-bef1-893ee58ec34b",
      "name": "Preparar Datos Transferencia Stock"
    },
    {
      "parameters": {
        "jsCode": "// Validar Completitud - Function\nconst item = items[0].json;\nconst faltantes = [];\nif (!item.producto) faltantes.push('producto');\nif (!item.cantidad && item.cantidad !== 0) faltantes.push('cantidad');\nif (!item.almacen_origen) faltantes.push('almacen_origen');\nif (!item.almacen_destino) faltantes.push('almacen_destino');\n\nif (faltantes.length > 0) {\n  return [{ json: {\n    accion: 'transferir_stock_almacen_incompleto',\n    producto: item.producto || item.producto_raw || null,\n    cantidad: item.cantidad || null,\n    almacen_origen: item.almacen_origen || null,\n    almacen_destino: item.almacen_destino || null,\n    datos_faltantes: faltantes,\n    respuesta_usuario: `📦 Me faltan estos datos para la transferencia: ${faltantes.join(', ')}.`,\n    chat_id: item.chat_id,\n    uid: item.uid\n  }}];\n}\n\n// Todo OK\nreturn [{ json: Object.assign({}, item, { accion: 'transferir_stock_almacen' }) }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3008,
        19680
      ],
      "id": "efc0b17b-7e71-4bcc-9008-db8c5ca93f71",
      "name": "Validar Completitud Transferencia"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "acfcdb8d-ff5a-4b6f-bce7-5c25dc5cbe79",
              "name": "accion",
              "value": "transferir_stock_almacen_confirmado",
              "type": "string"
            },
            {
              "id": "d04d5524-00a4-4968-a7c9-b0186c34087d",
              "name": "respuesta_usuario",
              "value": "=`=\"📦 Transferencia: \" + $json.cantidad + \" \" + ($json.producto || $json.producto_raw) + \" de \" + $json.almacen_origen + \" → \" + $json.almacen_destino + \". Procesando...\"`",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2736,
        19680
      ],
      "id": "9c82229f-a3aa-45f3-8f8e-a4d2b03ebcba",
      "name": "Consultar Transferencia Completada"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "acfcdb8d-ff5a-4b6f-bce7-5c25dc5cbe79",
              "name": "accion",
              "value": "transferir_stock_almacen_incompletotransferir_stock_almacen_incompleto",
              "type": "string"
            },
            {
              "id": "d04d5524-00a4-4968-a7c9-b0186c34087d",
              "name": "respuesta_usuario",
              "value": "=$json.respuesta_usuario",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2544,
        19680
      ],
      "id": "27713f83-aa71-4ad1-abd3-3fa55105c7ad",
      "name": "Enviar Datos Faltantes"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.respuesta_usuario }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2368,
        19680
      ],
      "id": "e6c9a5d3-019e-410f-9cc8-cf9b663512d9",
      "name": "Enviar respuesta al usuario",
      "webhookId": "a02c0082-c638-405a-af95-4242f4ceb0cd"
    },
    {
      "parameters": {
        "functionCode": "// Preparar Datos Transferencia - Function\nconst normalize = (s) => { if (!s) return s; return s.normalize('NFD').replace(/\\p{Diacritic}/gu, '').toLowerCase().trim().replace(/\\s+/g,' '); };\nconst input = items[0].json || {};\nlet producto = input.producto || (input.datos_pendientes && input.datos_pendientes.producto) || null;\nlet cantidad = input.cantidad || (input.datos_pendientes && input.datos_pendientes.cantidad) || null;\nlet almacen_origen = input.almacen_origen || (input.datos_pendientes && input.datos_pendientes.almacen_origen) || null;\nlet almacen_destino = input.almacen_destino || (input.datos_pendientes && input.datos_pendientes.almacen_destino) || null;\nconst mensaje = input.mensaje_usuario || '';\nif((!producto || !cantidad) && mensaje){\n  const m1 = mensaje.match(/(?:pasa|pasar|transferir|mueve|envia|env\\u00eda)\\s+([0-9]+(?:[.,][0-9]+)?)\\s+([^,\\n]+?)\\s+(?:del|desde|de)\\s+almac[ee]n?\\s+([A-Za-z0-9_-]+)\\s+(?:al|a|hacia)\\s+(?:almac[ee]n\\s+)?([A-Za-z0-9_-]+)/i);\n  if(m1){ cantidad = cantidad || parseFloat(m1[1].replace(',','.')); producto = producto || m1[2].trim(); almacen_origen = almacen_origen || m1[3].trim(); almacen_destino = almacen_destino || m1[4].trim(); }\n}\nproducto = producto ? producto.toString().trim() : null;\nconst producto_norm = producto ? normalize(producto) : null;\nconst alias_almacenes = { 'principal': 'WH', 'secundario': 'AA', 'almacen principal': 'WH', 'almacen secundario': 'AA' };\nconst mapAlias = (v) => { if(!v) return v; const low = v.toString().toLowerCase(); return alias_almacenes[low] || v; };\nconst out = { accion: input.accion || 'transferir_stock_almacen', producto: producto_norm || null, producto_raw: producto || null, cantidad: cantidad != null ? cantidad : null, almacen_origen: mapAlias(almacen_origen) || null, almacen_destino: mapAlias(almacen_destino) || null, chat_id: input.chat_id || null, uid: input.uid || null, datos_pendientes: input.datos_pendientes || null };\nreturn [{ json: out }];"
      },
      "name": "Preparar Datos Transferencia",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -3232,
        20032
      ],
      "id": "d4c4861c-e55b-409c-80b2-afe9547d0545"
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "options": {}
      },
      "name": "Buscar Producto Odoo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -3024,
        20032
      ],
      "id": "d9a01709-cb0f-4898-af85-12d4fd566346"
    },
    {
      "parameters": {
        "functionCode": "// Procesar respuesta Buscar Producto\nconst res = items[0].json;\n// Adaptarse a search_read respuesta: puede venir como lista directa\nconst rows = Array.isArray(res) ? res : (res.result || res.records || []);\nif(!rows || rows.length === 0) { return [{ json: { found: false } }]; }\nconst p = rows[0];\nreturn [{ json: { found: true, product_id: p.id, product_name: p.name, uom_id: (p.uom_id && p.uom_id[0]) || null } }];"
      },
      "name": "Procesar Buscar Producto",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -2832,
        20032
      ],
      "id": "df2c3b22-a578-4738-a79f-c318590d7a6c"
    },
    {
      "parameters": {
        "url": "={{ $env.ODOO_BASE_URL + '/jsonrpc' }}",
        "jsonParameters": true,
        "options": {}
      },
      "name": "Buscar Almacen Origen Odoo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -2624,
        20032
      ],
      "id": "02e1ad45-a394-4cca-b034-474f4e6463ab"
    },
    {
      "parameters": {
        "functionCode": "const res = items[0].json; const rows = Array.isArray(res) ? res : (res.result || res.records || []); if(!rows || rows.length === 0) { return [{ json: { found: false } }]; } const l = rows[0]; return [{ json: { found: true, location_id: l.id, location_name: l.name } }];"
      },
      "name": "Procesar Almacen Origen",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -2384,
        20032
      ],
      "id": "517a2df5-2375-43a6-aee6-1aed084f69cc"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{ $env.ODOO_BASE_URL + '/jsonrpc' }}",
        "jsonParameters": true,
        "options": {}
      },
      "name": "Buscar Almacen Destino Odoo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -2128,
        20032
      ],
      "id": "02a7aab3-78ba-4cf4-b780-4f074418048c",
      "disabled": true
    },
    {
      "parameters": {
        "functionCode": "const res = items[0].json; const rows = Array.isArray(res) ? res : (res.result || res.records || []); if(!rows || rows.length === 0) { return [{ json: { found: false } }]; } const l = rows[0]; return [{ json: { found: true, location_id_dest: l.id, location_name_dest: l.name } }];"
      },
      "name": "Procesar Almacen Destino",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1888,
        20032
      ],
      "id": "e937b488-fb10-4424-a6b5-df08ef239a59"
    },
    {
      "parameters": {
        "authentication": "headerAuth",
        "url": "={{ $env.ODOO_BASE_URL + '/jsonrpc' }}",
        "jsonParameters": true,
        "options": {}
      },
      "name": "Crear Stock Move Odoo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        -1632,
        20032
      ],
      "id": "8c5acf6f-649b-43de-a1f1-128cdbd4444e",
      "disabled": true
    },
    {
      "parameters": {
        "functionCode": "// Procesar creación de move\nconst res = items[0].json; // puede contener {result: id} o simplemente id\nlet moveId = null;\nif (typeof res === 'object') { if (res.result) moveId = res.result; else if (Array.isArray(res)) moveId = res[0]; else if (res.id) moveId = res.id; } else if (typeof res === 'number') moveId = res;\nif (!moveId) { return [{ json: { success: false, payload: res } }]; }\nreturn [{ json: { success: true, move_id: moveId, respuesta_usuario: `📦 Transferencia creada (move id: ${moveId}).` } }];"
      },
      "name": "Procesar Crear Move",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        -1392,
        20032
      ],
      "id": "82a7391e-936c-4991-97d2-6711d332fcd8"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "accion",
              "value": "transferir_stock_almacen_confirmado"
            },
            {
              "name": "respuesta_usuario",
              "value": "=\"📦 Transferencia creada: \" + ($json.move_id || '') + \". ¿Necesitas algo más?\""
            }
          ]
        },
        "options": {}
      },
      "name": "Notificar Resultado",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        -1136,
        20032
      ],
      "id": "0b09dd96-491c-449d-90b1-efe5d27ce599"
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -13456,
        3360
      ],
      "id": "d1861af2-e0e9-4f20-89aa-a3e323bcec3b",
      "name": "Telegram Trigger",
      "webhookId": "ca6109d2-1f96-4ee5-bc37-3ef7eb738393"
    },
    {
      "parameters": {
        "jsCode": "const datosNorm = $('Normalizar Parte+Materiales FSM').item.json;\nconst auth = $('Autenticar Odoo').item.json;\n\nconst DB   = datosNorm.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst UID  = auth.result;    // uid de admin (2)\nconst PASS = 'admin';        // contraseña / API key de admin\n\nconst email = datosNorm.odoo_user;   // aquí viene el email del usuario final\n\nif (!email) {\n  throw new Error('Falta odoo_user (email) en datos normalizados');\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      DB, UID, PASS,\n      'res.users', 'search_read',\n      [[\n        '|',\n        ['login', '=', email],\n        ['email', '=', email],\n      ]],\n      { fields: ['id', 'name', 'login', 'email', 'partner_id'], limit: 1 },\n    ],\n  },\n  id: 1,\n};\n\nreturn { payload };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2944,
        17664
      ],
      "id": "ed7a5474-4459-4970-9957-8718b806b7ec",
      "name": "Preparar Buscar Usuario Odoo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json[\"payload\"]}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2736,
        17664
      ],
      "id": "6a92bbc8-d6d8-44a5-9640-9ab69a3b5471",
      "name": "Buscar Usuario Odoo"
    },
    {
      "parameters": {
        "jsCode": "const datosNorm = $('FSM ▸ Preparar Datos Completos').item.json;\nconst auth = $('Autenticar Odoo').item.json;\n\nconst DB   = datosNorm.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst UID  = auth.result;    // uid de admin (2)\nconst PASS = 'admin';        // contraseña / API key de admin\n\nconst email = datosNorm.odoo_user;   // aquí viene el email del usuario final\n\nif (!email) {\n  throw new Error('Falta odoo_user (email) en datos normalizados');\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      DB, UID, PASS,\n      'res.users', 'search_read',\n      [[\n        '|',\n        ['login', '=', email],\n        ['email', '=', email],\n      ]],\n      { fields: ['id', 'name', 'login', 'email', 'partner_id'], limit: 1 },\n    ],\n  },\n  id: 1,\n};\n\nreturn { payload };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3008,
        18304
      ],
      "id": "d9cdb47c-78bf-4e17-ba65-b5bf4049e1f9",
      "name": "Preparar Buscar Usuario Odoo1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{$json[\"payload\"]}}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2800,
        18304
      ],
      "id": "e16d47a4-b7a9-4482-8d46-7f664eeb873e",
      "name": "Buscar Usuario Odoo1"
    },
    {
      "parameters": {
        "jsCode": "// Lee el resultado de Buscar Usuario Odoo1\nconst r = $json.result || $json.body?.result || $json.json?.result || [];\nconst user = Array.isArray(r) && r[0] ? r[0] : null;\n\nlet odoo_user_id = null;\nlet odoo_partner_id = null;\n\nif (user) {\n  if (user.id) odoo_user_id = Number(user.id);\n  if (user.partner_id) {\n    odoo_partner_id = Array.isArray(user.partner_id)\n      ? Number(user.partner_id[0])\n      : Number(user.partner_id);\n  }\n}\n\n// Propaga ambos valores junto con todo lo que ya venía\nreturn {\n  ...$json,\n  odoo_user_id,\n  odoo_partner_id\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2592,
        18304
      ],
      "id": "65e7e674-584f-4c5c-9277-5235f4495a83",
      "name": "Propagar Usuario Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Preparar Message Post Desecho - construir payload para message_post (args y kwargs separados)\nconst res = $json.json?.result ?? $json.result ?? $json.body?.result;\nconst scrapId = Array.isArray(res) ? res[0] : res;\n\nconst prev = $items('Crear Órdenes de Desecho', 0)[$itemIndex] || {};\nconst db  = prev.json?.db || prev.db || $json.db;\nconst uid = Number(prev.json?.uid ?? prev.uid ?? $json.uid);\n\n// obtener partner_id si está disponible (buscar en Buscar Usuario Odoo o en seed)\nlet partnerId = null;\ntry {\n  const respUsuario = $('Buscar Usuario Odoo')?.first()?.json;\n  if (respUsuario) {\n    const listaUsuarios = respUsuario.result || respUsuario;\n    const usuario = Array.isArray(listaUsuarios) && listaUsuarios.length > 0 ? listaUsuarios[0] : null;\n    if (usuario && Array.isArray(usuario.partner_id) && usuario.partner_id.length > 0) {\n      partnerId = usuario.partner_id[0];\n    }\n  }\n} catch (e) {\n  console.log('No se pudo leer Buscar Usuario Odoo:', e.message);\n}\n\nconst usuarioNombre = prev.json?.usuarioNombre ?? prev.usuarioNombre ?? null;\n\nif (!scrapId || !db || !Number.isFinite(uid)) {\n  return [{ json: { skip_post: true, motivo: 'Faltan scrapId/db/uid', scrapId, db, uid } }];\n}\n\nconst bodyText = usuarioNombre\n  ? `Desecho registrado por: ${usuarioNombre}`\n  : 'Desecho registrado';\n\nconst kwargs = {\n  body: bodyText,\n  message_type: 'comment',\n  subtype_xmlid: 'mail.mt_note'\n};\nif (partnerId) kwargs.author_id = partnerId;\n\n// args: list of ids as positional arg; kwargs separate\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'stock.scrap',\n      'message_post',\n      [[ Number(scrapId) ]], // positional args\n      kwargs                 // kwargs dict\n    ]\n  },\n  id: Math.floor(Math.random() * 1e6)\n};\n\nreturn [{ json: { payload, db, uid, scrapId, partnerId, usuarioNombre } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3520,
        17328
      ],
      "id": "ed98bf5d-544f-43d5-90af-a279a5f896d6",
      "name": "Preparar Message Post Desecho"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3728,
        17328
      ],
      "id": "5ed6c594-c210-4834-81f4-173b1a11f198",
      "name": "HTTP Postear Autor Desecho"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7e2cb360-3252-4504-b7cc-b7788158bb45",
              "leftValue": "={{ Boolean($json.direccion_calle?.trim() && $json.codigo_postal?.trim() && $json.poblacion?.trim() && $json.provincia?.trim() && $json.pais?.trim()) }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2016,
        11120
      ],
      "id": "f9f0f2cf-358f-4cfb-9dea-bfea42176020",
      "name": "¿Tiene Dirección Para Pedido?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Router de Acciones FIXED').item.json.chat_id }}",
        "text": "=📦 Antes de crear tu pedido necesito tu **dirección de envío**.\n\n✉️ Envíamela en un mensaje con este formato (todo seguido):\n`mi direccion es Gran Via 25 CP 28013 poblacion Madrid Provincia Madrid Pais España` \n\nCuando la reciba y la guarde te avisaré y podrás volver a decirme qué quieres pedir. 🛒",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1776,
        11232
      ],
      "id": "dd3261ba-dd63-4597-9ee7-7b490eae86e4",
      "name": "Pedir Dirección Para Pedido",
      "webhookId": "5cc7271b-bb4a-4907-8d2b-0cff3a2fafd1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "51a3f3ef-7159-4659-9fc0-821427950e0d",
              "leftValue": "={{ $json.mensaje_usuario && $json.mensaje_usuario.toString().toLowerCase().trim().startsWith('mi direccion es') }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -13088,
        3360
      ],
      "id": "9e43038d-3bf4-453b-ab2b-76911dae811e",
      "name": "¿Mensaje Es Dirección?"
    },
    {
      "parameters": {
        "jsCode": "// Tomamos los datos básicos\nconst datosExtraer = $('Extraer Datos').item.json;\nconst mensaje = String(datosExtraer.mensaje_usuario || '').trim();\n\nconsole.log('📍 Mensaje para extraer dirección:', mensaje);\n\n// Formato:\n// mi direccion es Calle 123 4ºB CP 07013 poblacion Palma Provincia Islas Baleares Pais España\nconst regex = /^mi\\s+direc+i[oó]n\\s+(?:es|:)\\s*(.+?)\\s+CP\\s+(\\d{4,5})\\s+poblacion\\s+(.+?)\\s+provincia\\s+(.+?)\\s+pais\\s+(.+)$/i;\n\nconst match = mensaje.match(regex);\n\nif (!match) {\n  console.log('❌ No coincide con el patrón de dirección');\n  return {\n    ...datosExtraer,\n    direccion_valida: false,\n    error_mensaje: 'Formato inválido. Usa: mi direccion es Gran Via 25 CP 28013 poblacion Madrid Provincia Madrid Pais España'\n  };\n}\n\nconst direccion = match[1].trim();\nconst codigoPostal = match[2].trim();\nconst poblacion = match[3].trim();\nconst provincia = match[4].trim();\nconst pais = match[5].trim();\n\nconsole.log('✅ Dirección extraída:');\nconsole.log('🏠', direccion);\nconsole.log('📮', codigoPostal);\nconsole.log('🏙️', poblacion);\nconsole.log('🗺️', provincia);\nconsole.log('🌍', pais);\n\nreturn {\n  ...datosExtraer,\n  direccion_valida: true,\n  direccion_calle: direccion,\n  codigo_postal: codigoPostal,\n  poblacion,\n  provincia,\n  pais\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -14864,
        3792
      ],
      "id": "d3166ca4-b89c-4c86-b383-72ac4a016de9",
      "name": "Extraer Dirección Pedido"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b899e3f8-f0cb-47dd-ba1a-59c054bdf120",
              "leftValue": "={{ $json.direccion_valida === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -14688,
        3792
      ],
      "id": "d507381f-cc46-4393-b71a-3058c0a459f5",
      "name": "¿Dirección Válida?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE telegram_users\nSET \n  direccion_calle = $1,\n  codigo_postal   = $2,\n  poblacion       = $3,\n  provincia       = $4,\n  pais            = $5\nWHERE user_id     = $6;\n",
        "options": {
          "queryReplacement": "={{ [$json.direccion_calle, $json.codigo_postal, $json.poblacion, $json.provincia, $json.pais, $json.user_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -14464,
        3776
      ],
      "id": "1af28659-a71f-483d-ac1a-6fa9d354ca82",
      "name": "Actualizar Dirección Usuario"
    },
    {
      "parameters": {
        "chatId": "={{ $('Extraer Dirección Pedido').item.json.chat_id }}",
        "text": "=✅ **Dirección guardada correctamente**\n\n🏠 {{ $('Extraer Dirección Pedido').item.json.direccion_calle }}\n📮 CP {{ $('Extraer Dirección Pedido').item.json.codigo_postal }} – {{ $('Extraer Dirección Pedido').item.json.poblacion }} ({{ $('Extraer Dirección Pedido').item.json.provincia }}, {{ $('Extraer Dirección Pedido').item.json.pais }})\n\n🛒 Ya puedes volver a decirme qué quieres pedir.\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -14272,
        3776
      ],
      "id": "39eec369-1673-4493-8bad-bb4ec6bb1a83",
      "name": "Confirmar Dirección Guardada Pedido",
      "webhookId": "8639f06d-9611-4667-ad53-778547c73de0"
    },
    {
      "parameters": {
        "chatId": "=={{ $json.chat_id && $json.chat_id !== 'null' && $json.chat_id !== '' \n    ? Number($json.chat_id) \n    : Number($json.user_id) }}\n",
        "text": "={{ $json.error_mensaje || \"⚠️ El formato de la dirección no es válido. Prueba de nuevo con algo como:\\n`mi direccion es Calle Ciudad de Barcelona 123 4ºB CP 28007 poblacion Madrid Provincia Madrid Pais España`\" }}\n",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -14400,
        4016
      ],
      "id": "55b94312-48f7-4b70-953a-2c20bb351720",
      "name": "Mensaje Error Dirección",
      "webhookId": "8639f06d-9611-4667-ad53-778547c73de0"
    },
    {
      "parameters": {
        "jsCode": "// Tomamos los datos de la dirección recién extraída\nconst d = $('Extraer Dirección Pedido').item.json;\n\nreturn {\n  user_id: d.user_id,\n  chat_id: d.chat_id,\n  user_name: d.user_name,\n  // si ya tienes el correo guardado, intenta arrastrarlo aquí también\n  user_mail: d.correo_extraido || d.user_mail || null,\n\n  direccion_calle: d.direccion_calle,\n  codigo_postal: d.codigo_postal,\n  poblacion: d.poblacion,\n  provincia: d.provincia,\n  pais: d.pais,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -14080,
        3776
      ],
      "id": "2c4725ec-e598-4db7-8648-0bf9de3d5446",
      "name": "Preservar Datos Dirección"
    },
    {
      "parameters": {
        "jsCode": "// PASO 1: Buscar país en Odoo por código ISO\nconst userData = $('Preservar Datos Dirección').item.json;\n// Tomamos el UID desde el nodo de autenticación de Odoo\nconst uid = $('Autenticar Odoo Dirección').item.json.result;\n\nlet paisNombre = userData.pais || '';\n\nif (!paisNombre || paisNombre.trim() === '') {\n  console.log('⚠️ No hay país para buscar');\n  return {\n    skip_country: true,\n    user_data: userData,\n    uid: uid\n  };\n}\n\n// Mapeo de países a códigos ISO\nconst paisesMap = {\n  'españa': 'ES', 'espana': 'ES', 'spain': 'ES',\n  'mexico': 'MX', 'méxico': 'MX',\n  'argentina': 'AR',\n  'colombia': 'CO',\n  'chile': 'CL',\n  'peru': 'PE', 'perú': 'PE',\n  'venezuela': 'VE',\n  'ecuador': 'EC',\n  'bolivia': 'BO',\n  'paraguay': 'PY',\n  'uruguay': 'UY',\n  'costa rica': 'CR',\n  'panama': 'PA', 'panamá': 'PA',\n  'estados unidos': 'US', 'united states': 'US',\n  'francia': 'FR', 'france': 'FR',\n  'alemania': 'DE', 'germany': 'DE',\n  'italia': 'IT', 'italy': 'IT',\n  'portugal': 'PT',\n  'reino unido': 'GB', 'united kingdom': 'GB',\n  'brasil': 'BR', 'brazil': 'BR'\n};\n\nconst paisKey = paisNombre\n  .toLowerCase()\n  .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\n  .replace(/ñ/gi, 'n')\n  .trim();\n\nconst paisCode = paisesMap[paisKey];\n\nconsole.log('🔍 Buscando país en Odoo:');\nconsole.log('  Original:', paisNombre);\nconsole.log('  Código ISO:', paisCode || 'No mapeado - buscando por nombre');\n\nlet filtros;\nif (paisCode) {\n  filtros = [[\"code\", \"=\", paisCode]];\n} else {\n  filtros = [[\"name\", \"ilike\", paisNombre]];\n}\n\nconst buscarPais = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.country\",\n      \"search_read\",\n      [filtros],\n      {\n        fields: [\"id\", \"name\", \"code\"],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Filtros búsqueda:', JSON.stringify(filtros, null, 2));\n\nreturn {\n  url: 'https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: buscarPais,\n  method: 'POST',\n  uid: uid,\n  user_data: userData\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -13744,
        3776
      ],
      "id": "73073eed-492e-4b33-beb7-603773d93d3a",
      "name": "Buscar País Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -13552,
        3776
      ],
      "id": "6643e854-5492-4f4c-a061-749f33c96ad7",
      "name": "Ejecutar Búsqueda País",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// PASO 2: Procesar resultado del país y buscar provincia\nconst userData = $('Buscar País Odoo').item.json.user_data;\nconst uid = $('Buscar País Odoo').item.json.uid;\nconst paisResultado = $json.result || [];\nlet provinciaNombre = userData.provincia || '';\n\nlet paisId = null;\nif (paisResultado && paisResultado.length > 0) {\n  paisId = paisResultado[0].id;\n  console.log('✅ País encontrado:', paisResultado[0].name, 'ID:', paisId);\n} else {\n  console.log('⚠️ País no encontrado:', userData.pais);\n}\n\nif (!provinciaNombre || provinciaNombre.trim() === '') {\n  console.log('⚠️ No hay provincia para buscar');\n  return {\n    skip_state: true,\n    user_data: userData,\n    uid: uid,\n    pais_id: paisId\n  };\n}\n\n// Normalizar el nombre de la provincia\nconst provinciaNormalizada = provinciaNombre\n  .normalize('NFD')\n  .replace(/[\\u0300-\\u036f]/g, '')\n  .replace(/ñ/gi, 'n')\n  .trim();\n\nconsole.log('🔍 Buscando provincia:');\nconsole.log('  Original:', provinciaNombre);\nconsole.log('  Normalizada:', provinciaNormalizada);\n\nprovinciaNombre = provinciaNormalizada;\n\n// Buscar provincia/estado\nconst filtros = [[\"name\", \"ilike\", provinciaNombre]];\nif (paisId) {\n  filtros.push([\"country_id\", \"=\", paisId]);\n}\n\nconst buscarProvincia = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      uid,\n      \"admin\",\n      \"res.country.state\",\n      \"search_read\",\n      [filtros],\n      {\n        fields: [\"id\", \"name\", \"code\", \"country_id\"],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📤 Request de búsqueda provincia:', JSON.stringify(buscarProvincia, null, 2));\n\nreturn {\n  url: 'https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: buscarProvincia,\n  method: 'POST',\n  uid: uid,\n  user_data: userData,\n  pais_id: paisId\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -13344,
        3776
      ],
      "id": "57bc9fd9-caad-445a-97c3-a2be88c55257",
      "name": "Buscar Provincia Odoo",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -13152,
        3776
      ],
      "id": "316ed187-867b-4ca0-9a9c-9853a39da95d",
      "name": "Ejecutar Búsqueda Provincia",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const userData = $('Preservar Datos Dirección').item.json;\nconst uid = $('Autenticar Odoo Dirección').item.json.result;\n\nconst email = (userData.user_mail || '').toString().trim();\nconst nombre = (userData.user_name || '').toString().trim();\n\nif (!email && !nombre) {\n  throw new Error('No hay email ni nombre para buscar el partner en Odoo');\n}\n\nlet domain;\nif (email) {\n  domain = [['email', 'ilike', email]];\n} else {\n  domain = [['name', 'ilike', nombre]];\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'res.partner',\n      'search_read',\n      [domain],\n      {\n        fields: ['id', 'name', 'email'],\n        limit: 1\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000),\n};\n\nreturn {\n  url: 'https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: payload,\n  method: 'POST',\n  uid,\n  user_data: userData\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -12944,
        3776
      ],
      "id": "3f9cf06a-14e3-40c1-be4c-75e25c9b0dc9",
      "name": "Buscar Partner Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -12752,
        3776
      ],
      "id": "51284f0b-448b-4331-85ad-4cf05b460d96",
      "name": "Ejecutar Búsqueda Partner",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const userData   = $('Preservar Datos Dirección').item.json;\nconst uid        = $('Autenticar Odoo Dirección').item.json.result;\n\nconst paisRes    = $('Ejecutar Búsqueda País').item.json.result || [];\nconst provRes    = $('Ejecutar Búsqueda Provincia').item.json.result || [];\nconst partnerRes = $json.result || [];\n\nconst countryId  = paisRes[0]?.id || null;\nconst stateId    = provRes[0]?.id || null;\nconst partnerId  = partnerRes[0]?.id || null;\n\nif (!partnerId) {\n  throw new Error('No se encontró el contacto en Odoo para actualizar la dirección');\n}\n\nconst vals = {\n  street: userData.direccion_calle || '',\n  zip: userData.codigo_postal || '',\n  city: userData.poblacion || '',\n};\n\nif (stateId)   vals.state_id   = stateId;\nif (countryId) vals.country_id = countryId;\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'res.partner',\n      'write',\n      [[partnerId], vals]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('📝 Actualizando partner', partnerId, 'con', vals);\n\nreturn {\n  url: 'https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc',\n  headers: { 'Content-Type': 'application/json' },\n  body: payload,\n  method: 'POST',\n  partner_id: partnerId,\n  country_id: countryId,\n  state_id: stateId\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -12544,
        3776
      ],
      "id": "8d900801-12e9-480e-ac51-3c5eb6ffbda0",
      "name": "Actualizar Dirección en Odoo"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.body) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -12320,
        3776
      ],
      "id": "7275f114-409a-4230-b5b1-717a37d6b103",
      "name": "Ejecutar Update Dirección Odoo",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"lsanchezgoshawk-n8npruebas-main-25736898\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -13904,
        3776
      ],
      "id": "964c64b1-3850-4e20-867d-6209be003010",
      "name": "Autenticar Odoo Dirección"
    },
    {
      "parameters": {
        "jsCode": "const saleId = $json.result; // ID que devuelve el create\nconst uid = $('Crear Pedido Venta').item.json.uid;\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'lsanchezgoshawk-n8npruebas-main-25736898',\n      uid,\n      'admin',\n      'sale.order',\n      'read',\n      [[saleId], ['name']]\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  payload,\n  sale_id: saleId,\n  uid,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1104,
        10544
      ],
      "id": "a35fa44e-2364-4b56-9318-57652073902e",
      "name": "Preparar Leer Pedido"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1280,
        10544
      ],
      "id": "fe2f3d69-7319-40ad-aa01-24088c9499a3",
      "name": "HTTP Leer Pedido"
    },
    {
      "parameters": {
        "jsCode": "const fromCreate = $('Crear Pedido Venta').item.json;\nconst fromRespuesta = $('Formatear Respuesta Pedido').item.json;\n\nconst chat_id = fromCreate.chat_id;\nconst user_id = $('Router de Acciones FIXED').item.json.user_id || chat_id;\nconst cliente_id = fromCreate.cliente_id || null;\nconst cliente_nombre = fromCreate.cliente_datos?.name || '';\nconst pedido_id = fromRespuesta.pedido_id;\nconst pedido_numero = fromRespuesta.pedido_numero;\nconst lineas = fromCreate.lineas_pedido || [];\n\nreturn {\n  chat_id,\n  user_id,\n  cliente_id,\n  cliente_nombre,\n  pedido_id,\n  pedido_numero,\n  lineas_json: JSON.stringify(lineas),\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1632,
        10544
      ],
      "id": "cd32418f-6084-44e8-bee2-055692afdca9",
      "name": "Preparar Guardar Pedido Cliente"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO pedidos_cliente\n  (chat_id, user_id, cliente_id, cliente_nombre, pedido_id, pedido_numero, lineas, created_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, NOW());",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,\n  $json.user_id,\n  $json.cliente_id,\n  $json.cliente_nombre,\n  $json.pedido_id,\n  $json.pedido_numero,\n  $json.lineas_json\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        1824,
        10544
      ],
      "id": "95acc6d6-71c0-4f84-8997-b4411f75a7fc",
      "name": "Guardar Pedido Cliente"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "DELETE FROM pedidos_cliente\nWHERE cliente_id = $1\n  AND id NOT IN (\n    SELECT id\n    FROM pedidos_cliente\n    WHERE cliente_id = $1\n    ORDER BY created_at DESC\n    LIMIT 10\n  );",
        "options": {
          "queryReplacement": "={{ [ $json.cliente_id ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        2000,
        10544
      ],
      "id": "c6109da1-0f0d-45fe-bcce-6036cd8a4080",
      "name": "Limitar a 10 Pedidos por Cliente"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "98236b1f-6482-4fd0-b172-5113c0cc4aba",
              "leftValue": "={{ $json.numero_pedido }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3040,
        20320
      ],
      "id": "f9387f48-b930-45af-8105-48fa211a5c1e",
      "name": "¿Hay número de pedido?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Detectar Número Pedido').item.json.chat_id }}",
        "text": "Dime el número de pedido que deseas modificar.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2624,
        20224
      ],
      "id": "99fa9d34-c34c-44c9-bf69-376ba7fd1bf2",
      "name": "Pedir Número de Pedido",
      "webhookId": "49af8b2b-f694-4147-9384-433f42099c4e"
    },
    {
      "parameters": {
        "jsCode": "// Entrada del workflow (lo que le pasamos con Execute Workflow)\nconst input = $json;\n\n// Mensaje que ha escrito el usuario\nconst msg = input.mensaje_original || input.text || '';\n\n// Intentar detectar algo tipo \"S00015\", \"SO0123\", etc.\nconst mName = msg.match(/([A-Z]{1,3}\\d{3,})/i);\n\n// Intentar detectar un número \"123\", \"2345\", etc.\nconst mId = msg.match(/\\b(\\d{3,})\\b/);\n\nlet numero_pedido = null;\n\nif (mName) {\n  numero_pedido = mName[1];\n} else if (mId) {\n  numero_pedido = mId[1];\n}\n\n// Devolvemos todo lo que nos llegue + el numero_pedido detectado\nreturn {\n  ...input,\n  numero_pedido,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3296,
        20320
      ],
      "id": "129aaa9e-110e-432c-ab24-5d4642c59db4",
      "name": "Detectar Número Pedido"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW());",
        "options": {
          "queryReplacement": "=={{ [\n  parseInt($('Detectar Número Pedido').item.json.chat_id) || 0,          // chat_id\n  parseInt($('Detectar Número Pedido').item.json.user_id) || 0,          // user_id\n  'Usuario',                                                             // user_name genérico\n  'modificar_pedido_pedir_numero',                                      // esperando_confirmacion\n  'Dime el número de pedido que deseas modificar.',                     // ultimo_mensaje_bot\n  JSON.stringify({ accion_original: 'modificar_pedido_venta' }),        // datos_pendientes\n  $('Detectar Número Pedido').item.json.mensaje_original || '',         // mensaje_usuario\n  JSON.stringify([]),                                                   // historial\n  JSON.stringify([\n    {\n      tipo: 'bot',\n      contenido: 'Dime el número de pedido que deseas modificar.',\n      timestamp: new Date().toISOString()\n    }\n  ])                                                                    // historial_conversacion\n] }}\n"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2416,
        20224
      ],
      "id": "fa3ac101-4abd-4313-929c-e74baa65fda6",
      "name": "Guardar Memoria Modificar Pedido - Pedir Número"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM pedidos_cliente\nWHERE (upper(pedido_numero) = upper($1) OR pedido_id::text = $1)\n  AND chat_id::text = $2::text\nORDER BY created_at DESC\nLIMIT 1;",
        "options": {
          "queryReplacement": "={{ $json.query_params }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2624,
        20416
      ],
      "id": "402e5363-8fde-411a-adde-fbdb003ff4a7",
      "name": "Buscar Pedido Cliente",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ef74b53d-2261-484a-92f8-4da82aaec704",
              "leftValue": "={{ $json.pedido_id || 0 }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2416,
        20416
      ],
      "id": "4780b9f0-2653-497b-929a-8c38443dcb68",
      "name": "¿Pedido encontrado?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Detectar Número Pedido').item.json.chat_id }}",
        "text": "⚠️ No encontré ningún pedido con ese número.   Revisa que el número esté bien escrito (por ejemplo: S00015 o el ID como 123).",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2208,
        20512
      ],
      "id": "71d41daa-43d7-41c6-9edb-2d1341d10f36",
      "name": "Avisar Pedido No Encontrado",
      "webhookId": "ee382849-437b-48c0-a4ca-20f2978309b4"
    },
    {
      "parameters": {
        "jsCode": "// Aquí $json YA es el pedido, no un array\nconst pedido = $json;\n\nconst lineas = pedido.lineas || [];\nconst numeroPedido = pedido.pedido_numero || pedido.pedido_id;\n\nlet texto = `🧾 *Pedido ${numeroPedido}*\\n`;\ntexto += `👤 Cliente: ${pedido.cliente_nombre || 'Desconocido'}\\n\\n`;\ntexto += `📦 *Productos:*\\n`;\n\nfor (const linea of lineas) {\n  texto += `• ${linea.name} — Cantidad: ${linea.product_uom_qty}\\n`;\n}\n\ntexto += `\\n¿Qué deseas modificar?\\n`;\ntexto += `Puedes decir cosas como:\\n`;\ntexto += `- \"añade 2 tartas de queso\"\\n`;\ntexto += `- \"quita 1 coca cola\"\\n`;\ntexto += `- \"cambia tarta grande por tarta pequeña\"\\n`;\n\nreturn {\n  chat_id: pedido.chat_id,\n  user_id: pedido.user_id,\n  pedido_id: pedido.pedido_id,\n  pedido_numero: numeroPedido,\n  lineas,\n  texto,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2208,
        20320
      ],
      "id": "84f8ecda-4b7c-4e3e-b725-595874f6d059",
      "name": "Formatear Pedido para Mostrar"
    },
    {
      "parameters": {
        "chatId": "={{ $('Formatear Pedido para Mostrar').item.json.chat_id }}",
        "text": "={{ $('Formatear Pedido para Mostrar').item.json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1856,
        20320
      ],
      "id": "a1220db5-9a17-46c6-9862-5d9d36c58f5b",
      "name": "Mostrar Pedido al Usuario",
      "webhookId": "fd3713e8-0235-479b-a669-ec53543392e8"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW());\n",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,\n  $json.user_id,\n  'Usuario',\n  'modificar_pedido_detalle', // nuevo estado\n  $json.texto,\n  JSON.stringify({\n    pedido_id: $json.pedido_id,\n    pedido_numero: $json.pedido_numero,\n    lineas: $json.lineas\n  }),\n  '',\n  JSON.stringify([]),\n  JSON.stringify([{ tipo: 'bot', contenido: $json.texto, timestamp: new Date().toISOString() }])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2032,
        20320
      ],
      "id": "1e7d012a-9369-4708-9199-8d72a9c96270",
      "name": "Guardar Memoria Modificar Pedido"
    },
    {
      "parameters": {
        "jsCode": "const input = $json;\nconst msgRaw = (input.mensaje_original || input.text || '').toString();\nconst msg = msgRaw.toLowerCase();\n\n// 1) Detectar si es un CAMBIO (\"cambia X por Y\", \"tarta cambialo por tarta de queso\")\nif (/cambi(a|ar|alo|alos|arlo)/.test(msg) || /\\spor\\s/.test(msg)) {\n  let producto_origen_texto = '';\n  let producto_destino_texto = '';\n  let cantidad_destino = null;\n\n  // patrón 1: \"cambia X por Y\"\n  let m = msg.match(/cambi[a-z]*\\s+(.+?)\\s+por\\s+(.+)/);\n  if (m) {\n    producto_origen_texto = m[1].trim();\n    producto_destino_texto = m[2].trim();\n  } else {\n    // patrón 2: \"X cambialo por Y\"\n    m = msg.match(/(.+?)\\s+cambi[a-z]*\\s+por\\s+(.+)/);\n    if (m) {\n      producto_origen_texto = m[1].trim();\n      producto_destino_texto = m[2].trim();\n    }\n  }\n\n  // Extraer cantidad destino si viene tipo \"tarta de queso x 2\"\n  let m2 = producto_destino_texto.match(/(.+?)\\s*x\\s*(\\d+(?:[.,]\\d+)?)/);\n  if (m2) {\n    producto_destino_texto = m2[1].trim();\n    cantidad_destino = parseFloat(m2[2].replace(',', '.')) || null;\n  }\n\n  if (!producto_origen_texto || !producto_destino_texto) {\n    return {\n      ...input,\n      necesita_aclaracion: true,\n      texto_bot: 'Para cambiar un producto dime algo como: \"cambia tarta grande por tarta de queso x 2\".'\n    };\n  }\n\n  return {\n    ...input,\n    operacion: 'cambiar',\n    necesita_aclaracion: false,\n    producto_origen_texto,\n    producto_destino_texto,\n    cantidad_destino,\n  };\n}\n\n// 2) Si no es cambio, mirar si es añadir / quitar / eliminar\n\nlet operacion = null;\nlet tipo_ajuste = null;\n\n// ¿Hay algún número en el mensaje?\nconst tieneNumero = /\\d+(?:[.,]\\d+)?/.test(msg);\n\n// AÑADIR\nif (/(añad|anad|agreg|pon|mete|sum[ae])/i.test(msg)) {\n  operacion = 'ajustar';\n  tipo_ajuste = 'aumentar';\n\n// QUITAR (quitar/restar cantidad, no eliminar del todo)\n} else if (/(quit|borr|sac[ao])/i.test(msg)) {\n  operacion = 'ajustar';\n  tipo_ajuste = 'reducir';\n\n// ELIMINAR\n} else if (/elimin/i.test(msg)) {\n  if (tieneNumero) {\n    // \"elimina 2 clavos\" → reducir 2\n    operacion = 'ajustar';\n    tipo_ajuste = 'reducir';\n  } else {\n    // \"elimina el producto clavos\" / \"elimina todas las lineas de clavos\"\n    // → eliminar la línea completa\n    operacion = 'eliminar_linea';\n    tipo_ajuste = 'eliminar_linea';\n  }\n}\n\nif (!operacion) {\n  // No entendemos qué hacer\n  return {\n    ...input,\n    necesita_aclaracion: true,\n    texto_bot: 'No he entendido qué quieres hacer. Dime por ejemplo: \"añade 2 tartas de queso\", \"quita 1 coca cola\" o \"cambia tarta grande por tarta de queso\".'\n  };\n}\n\n// Extraer cantidad y nombre de producto para añadir/quitar/eliminar\n\nlet cantidad = 1;\nlet producto_texto = '';\n\n// patrón \"<verbo> 2 tarta de queso\"\nlet m = msg.match(/(?:añad|anad|agreg|pon|mete|sum[ae]|quit|elimin|borr|sac[ao])[a-z]*\\s+(\\d+(?:[.,]\\d+)?)\\s+(.+)/);\nif (m) {\n  cantidad = parseFloat(m[1].replace(',', '.')) || 1;\n  producto_texto = m[2].trim();\n} else {\n  // patrón \"tarta de queso x 2\"\n  m = msg.match(/(.+?)\\s*x\\s*(\\d+(?:[.,]\\d+)?)/);\n  if (m) {\n    producto_texto = m[1].trim();\n    cantidad = parseFloat(m[2].replace(',', '.')) || 1;\n  } else {\n    // sin cantidad: \"<verbo> tarta de queso\" / \"elimina el producto clavos\"\n    producto_texto = msg\n      .replace(/(?:añad|anad|agreg|pon|mete|sum[ae]|quit|elimin|borr|sac[ao])[a-z]*/g, '')\n      .trim();\n    cantidad = 1;\n  }\n}\n\nif (!producto_texto) {\n  return {\n    ...input,\n    necesita_aclaracion: true,\n    texto_bot: 'Necesito que me digas el producto. Ejemplo: \"añade 2 tartas de queso\" o \"quita 1 coca cola\".'\n  };\n}\n\nreturn {\n  ...input,\n  operacion,         // 'ajustar' o 'eliminar_linea'\n  tipo_ajuste: tipo_ajuste || 'aumentar',\n  cantidad,\n  producto_texto,\n  necesita_aclaracion: false\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3488,
        20832
      ],
      "id": "7899ef35-ffea-4042-82f9-cc58c24accde",
      "name": "Interpretar Modificación Pedido"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "35213ba6-21ae-4bba-b206-5445f1725bcb",
              "leftValue": "={{ $json.necesita_aclaracion }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3280,
        20832
      ],
      "id": "74d821c8-6722-4f26-b64c-ee5a231d6a4c",
      "name": "¿Necesita aclaración modificación?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Interpretar Modificación Pedido').item.json.chat_id }}",
        "text": "={{ $('Interpretar Modificación Pedido').item.json.texto_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2688,
        20640
      ],
      "id": "a322c942-00ab-43c9-a97b-02d7f43dbffc",
      "name": "Mensaje Aclaración Modificación",
      "webhookId": "260136f8-bffe-4a9a-89a2-9fc4728b3773"
    },
    {
      "parameters": {
        "jsCode": "// 👇 Helper para leer el JSON de otro nodo sin romper el flujo\nfunction safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Entrada que viene del nodo anterior (IA + interpretar modificación)\nconst entrada = $json;\n\n// Datos que nos interesan del mensaje de la IA\nconst {\n  tipo_ajuste,     // 'aumentar', 'reducir' o 'eliminar_linea'\n  operacion,       // puede venir 'eliminar_linea' en los casos de \"elimina el producto X\"\n  cantidad,\n  producto_texto,\n  chat_id,\n  user_id,\n} = entrada;\n\n// 👇 Recuperamos SIEMPRE el pedido original desde \"Preparar datos AI Agent\"\nconst origenMemoria = safeJson('Preparar datos AI Agent') || {};\nconst dp = origenMemoria.datos_pendientes || {};\n\n// Pedido e info base\nconst pedido_id = dp.pedido_id || entrada.pedido_id;\nconst pedido_numero = dp.pedido_numero || entrada.pedido_numero;\n\n// Preferimos SIEMPRE las líneas de datos_pendientes (tienen product_id y price_unit correctos)\nlet lineas = Array.isArray(dp.lineas) && dp.lineas.length\n  ? dp.lineas\n  : (entrada.lineas || []);\n\n// Normalizamos tipos numéricos por seguridad\nlineas = lineas.map(l => ({\n  ...l,\n  product_id: l.product_id != null ? Number(l.product_id) : null,\n  price_unit: l.price_unit != null ? Number(l.price_unit) : null,\n  product_uom_qty: Number(l.product_uom_qty || 0),\n}));\n\nif (!pedido_id || !Array.isArray(lineas) || lineas.length === 0) {\n  return {\n    ...entrada,\n    pedido_id,\n    pedido_numero,\n    error_modificacion: true,\n    texto_bot: 'No tengo los datos del pedido para modificarlo.'\n  };\n}\n\n// --- Búsqueda de la línea a modificar / eliminar ---\n\nconst normalize = (s) => (s || '').toString()\n  .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\n  .toLowerCase().replace(/\\s+/g, ' ')\n  .trim();\n\nconst target = normalize(producto_texto || '');\n\nconst candidatos = [];\nfor (let i = 0; i < lineas.length; i++) {\n  const l = lineas[i];\n  const nameNorm = normalize(l.name);\n  if (!nameNorm) continue;\n\n  let score = 0;\n  if (nameNorm.includes(target) || target.includes(nameNorm)) {\n    score = 3;\n  } else {\n    const t1 = new Set(nameNorm.split(' '));\n    const t2 = new Set(target.split(' '));\n    let inter = 0;\n    for (const t of t1) if (t2.has(t)) inter++;\n    if (inter > 0) score = 1;\n  }\n\n  if (score > 0) {\n    candidatos.push({ index: i, linea: l, score });\n  }\n}\n\n// Si no hay líneas candidatas → lo tratamos como producto nuevo\nif (candidatos.length === 0) {\n  return {\n    ...entrada,\n    pedido_id,\n    pedido_numero,\n    lineas,\n    es_producto_nuevo: true,\n    error_modificacion: false,\n    texto_bot: null\n  };\n}\n\n// Varias líneas parecidas → pedir desambiguación\nif (candidatos.length > 1) {\n  const textoOpciones = candidatos\n    .map((c, idx) => `${idx + 1}. ${c.linea.name} — Cantidad: ${c.linea.product_uom_qty}`)\n    .join('\\n');\n\n  return {\n    ...entrada,\n    pedido_id,\n    pedido_numero,\n    lineas,\n    necesita_desambiguacion_linea: true,\n    candidatos_linea: candidatos,\n    texto_bot: `He encontrado varios productos que se parecen a \"${producto_texto}\":\\n\\n${textoOpciones}\\n\\nPor favor, dime el número del producto que quieres modificar.`\n  };\n}\n\n// Solo 1 línea candidata\nconst elegido = candidatos[0];\nconst idx = elegido.index;\nconst linea = { ...elegido.linea };\nconst nuevas_lineas = lineas.map(l => ({ ...l })); // copia shallow\n\nconst actual = Number(linea.product_uom_qty || 0);\nconst q = Number(cantidad || 1);\n\n// --- CASO 1: eliminar COMPLETAMENTE la línea ---\n// Aquí entra cuando el interpretador ha marcado operacion/tipo_ajuste = 'eliminar_linea'\n// (por frases tipo \"elimina el producto clavos\" o \"elimina todas las líneas de clavos\")\nif (operacion === 'eliminar_linea' || tipo_ajuste === 'eliminar_linea') {\n  nuevas_lineas.splice(idx, 1); // borramos la línea completa\n\n  return {\n    ...entrada,\n    pedido_id,\n    pedido_numero,\n    lineas,           // estado original del pedido\n    nuevas_lineas,    // sin la línea eliminada\n    error_modificacion: false,\n    es_producto_nuevo: false,\n    linea_afectada: linea,\n    texto_bot: null\n  };\n}\n\n// --- CASO 2: AUMENTAR cantidad ---\nif (tipo_ajuste === 'aumentar') {\n  nuevas_lineas[idx].product_uom_qty = actual + q;\n  return {\n    ...entrada,\n    pedido_id,\n    pedido_numero,\n    lineas,\n    nuevas_lineas,\n    error_modificacion: false,\n    es_producto_nuevo: false,\n    linea_afectada: linea,\n    texto_bot: null\n  };\n}\n\n// --- CASO 3: REDUCIR cantidad (quita X unidades) ---\nif (tipo_ajuste === 'reducir') {\n  if (q < actual) {\n    // solo bajamos la cantidad\n    nuevas_lineas[idx].product_uom_qty = actual - q;\n    return {\n      ...entrada,\n      pedido_id,\n      pedido_numero,\n      lineas,\n      nuevas_lineas,\n      error_modificacion: false,\n      es_producto_nuevo: false,\n      linea_afectada: linea,\n      texto_bot: null\n    };\n  } else {\n    // sigue el comportamiento antiguo: pedir confirmación para eliminar del todo\n    return {\n      ...entrada,\n      pedido_id,\n      pedido_numero,\n      lineas,\n      error_modificacion: false,\n      requiere_confirmar_eliminacion: true,\n      linea_a_eliminar: linea,\n      indice_linea_a_eliminar: idx,\n      texto_bot: `Solo hay ${actual} unidades de \"${linea.name}\" en el pedido. ¿Quieres eliminar este producto del pedido? (responde \"sí\" o \"no\").`\n    };\n  }\n}\n\n// Si llega algo raro que no sea aumentar/reducir/eliminar_linea\nreturn {\n  ...entrada,\n  pedido_id,\n  pedido_numero,\n  lineas,\n  error_modificacion: true,\n  texto_bot: 'Por ahora solo puedo añadir, quitar cantidad o eliminar completamente productos del pedido.'\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2864,
        20928
      ],
      "id": "527df102-95ba-412e-b913-2f23f6a709f6",
      "name": "Aplicar Modificación"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e25b9a91-d677-4a81-8d23-4b9f92dc0d83",
              "leftValue": "={{ $json.error_modificacion === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2448,
        21168
      ],
      "id": "29fb4f51-8ef1-46a4-bede-7e729242c200",
      "name": "¿Error en modificación?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2032,
        21072
      ],
      "id": "2fdea57c-080e-4051-a07b-016b9bdf3ea2",
      "name": "Mensaje Error Modificación",
      "webhookId": "06a3fc02-803a-473a-bc83-b330c2d68c71"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload ? JSON.stringify($json.payload) : '{}' }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2016,
        21312
      ],
      "id": "698a7108-a5e6-44c9-8d07-435bb64e6f65",
      "name": "HTTP Actualizar Pedido"
    },
    {
      "parameters": {
        "jsCode": "// Helper para leer json de otro nodo\nfunction safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Preferimos los datos de Procesar Producto Nuevo si existen (producto añadido)\n// Si no, usamos los de Aplicar Modificación (ajuste de línea existente)\nconst desdeNuevo = safeJson('Procesar Producto Nuevo') || {};\nconst desdeMod   = safeJson('Aplicar Modificación')   || {};\n\nconst datos = Object.keys(desdeNuevo).length ? desdeNuevo : desdeMod;\n\nconst nuevas_lineas   = datos.nuevas_lineas || datos.lineas || [];\nconst numeroPedido    = datos.pedido_numero || datos.pedido_id;\nconst clienteNombre   = datos.cliente_nombre || '';\nconst chatId          = datos.chat_id;\nconst userId          = datos.user_id;\nconst pedidoId        = datos.pedido_id;\n\nlet texto = `✅ *Pedido ${numeroPedido} actualizado*.\\n\\n`;\ntexto += `📦 *Productos actuales:*\\n`;\n\nfor (const l of nuevas_lineas) {\n  texto += `• ${l.name} — Cantidad: ${l.product_uom_qty}\\n`;\n}\n\ntexto += `\\nSi quieres hacer otro cambio, puedes decirme por ejemplo:\\n`;\ntexto += `- \"añade 1 coca cola\"\\n`;\ntexto += `- \"quita 2 tartas de queso\"\\n`;\n\nreturn {\n  chat_id: chatId,\n  user_id: userId,\n  pedido_id: pedidoId,\n  pedido_numero: numeroPedido,\n  cliente_nombre: clienteNombre,\n  lineas: nuevas_lineas,\n  texto,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1808,
        21312
      ],
      "id": "432fdf4d-08c8-4ee6-9666-4750ddae9de3",
      "name": "Formatear Resumen Pedido Actualizado"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1600,
        21312
      ],
      "id": "dac071de-9787-4609-947c-ed54421fdd11",
      "name": "Enviar Pedido Actualizado",
      "webhookId": "06a3fc02-803a-473a-bc83-b330c2d68c71"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE pedidos_cliente\nSET lineas = $1::jsonb\nWHERE pedido_id = $2\n  AND chat_id = $3;",
        "options": {
          "queryReplacement": "={{ JSON.stringify($node[\"Formatear Resumen Pedido Actualizado\"].json[\"lineas\"] || []) }},{{ \n  $node[\"Formatear Resumen Pedido Actualizado\"].json[\"pedido_id\"]\n}},{{ \n  $node[\"Formatear Resumen Pedido Actualizado\"].json[\"chat_id\"]\n}}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1408,
        21312
      ],
      "id": "addc3b96-fe88-4cd9-bc62-ebdc09415678",
      "name": "Actualizar pedidos_cliente"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW());",
        "options": {
          "queryReplacement": "={{ [\n  // $1 - chat_id\n  $node[\"Formatear Resumen Pedido Actualizado\"].json[\"chat_id\"],\n\n  // $2 - user_id\n  $node[\"Formatear Resumen Pedido Actualizado\"].json[\"user_id\"],\n\n  // $3 - user_name\n  \"Usuario\",\n\n  // $4 - esperando_confirmacion\n  \"modificar_pedido_detalle\",\n\n  // $5 - ultimo_mensaje_bot\n  $node[\"Formatear Resumen Pedido Actualizado\"].json[\"texto\"],\n\n  // $6 - datos_pendientes\n  JSON.stringify({\n    pedido_id: $node[\"Formatear Resumen Pedido Actualizado\"].json[\"pedido_id\"],\n    pedido_numero: $node[\"Formatear Resumen Pedido Actualizado\"].json[\"pedido_numero\"],\n    lineas: $node[\"Formatear Resumen Pedido Actualizado\"].json[\"lineas\"] || []\n  }),\n\n  // $7 - mensaje_usuario (si quieres guardar algo aquí; si no, déjalo vacío)\n  \"\",\n\n  // $8 - historial\n  JSON.stringify([]),\n\n  // $9 - historial_conversacion\n  JSON.stringify([\n    {\n      tipo: \"bot\",\n      contenido: $node[\"Formatear Resumen Pedido Actualizado\"].json[\"texto\"],\n      timestamp: new Date().toISOString()\n    }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1232,
        21312
      ],
      "id": "dd53a152-6244-46a1-a1ae-d78d6f2bca60",
      "name": "Guardar Memoria Modificar Pedido - Detalle"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1,$2,$3,$4,$5,$6,$7,$8,$9,NOW(),NOW());",
        "options": {
          "queryReplacement": "={{ [\n    $json.chat_id,                                     // $1\n    $json.user_id,                                     // $2\n    'Usuario',                                         // $3\n    'modificar_pedido_elegir_linea',                   // $4\n    $json.texto_bot,                                   // $5\n    JSON.stringify({                                   // $6 -> datos_pendientes\n      pedido_id: $json.pedido_id,\n      pedido_numero: $json.pedido_numero,\n      lineas: $json.lineas,\n      candidatos_linea: $json.candidatos_linea,\n      tipo_ajuste: $json.tipo_ajuste,\n      cantidad: $json.cantidad,\n      producto_texto: $json.producto_texto\n    }),\n    '',                                                // $7 -> mensaje_usuario (vacío)\n    JSON.stringify([{                                  // $8 -> historial\n      tipo: 'bot',\n      contenido: $json.texto_bot,\n      timestamp: new Date().toISOString()\n    }]),\n    JSON.stringify([{                                  // $9 -> historial_conversacion\n      tipo: 'bot',\n      contenido: $json.texto_bot,\n      timestamp: new Date().toISOString()\n    }])\n  ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1824,
        21072
      ],
      "id": "03a9374d-4dbb-4d4f-bceb-72f35b847b9f",
      "name": "Modificar Líneas"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bd1268a-26a7-490a-b2f8-86c66ce8153d",
              "leftValue": "={{ $json.es_producto_nuevo === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2656,
        20928
      ],
      "id": "6c92d1ea-5fde-4520-857e-3278acf2cbdb",
      "name": "¿Es producto nuevo?"
    },
    {
      "parameters": {
        "jsCode": "const {\n  producto_texto,\n  cantidad,\n  pedido_id,\n  pedido_numero,\n  lineas = [],\n  chat_id,\n  user_id,\n} = $json;\n\n// UID de Odoo desde tu nodo de login\nconst uid = $('Autenticar Odoo').item.json.result;\nconst db = 'lsanchezgoshawk-n8npruebas-main-25736898';\n\nif (!uid) {\n  return {\n    ...$json,\n    error_producto_nuevo: true,\n    texto_bot: 'No he podido autenticar con Odoo para añadir el producto nuevo.',\n  };\n}\n\nconst term = (producto_texto || '').toString().trim();\n\n// Dominio simple: productos vendibles cuyo nombre contenga el texto\nconst domain = ['&', ['sale_ok', '=', true], ['name', 'ilike', term]];\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'product.product',\n      'search_read',\n      [domain],\n      { fields: ['id', 'name', 'list_price', 'default_code'], limit: 20 },\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  uid,\n  db,\n  chat_id,\n  user_id,\n  pedido_id,\n  pedido_numero,\n  lineas,\n  producto_texto: term,\n  cantidad,\n  payload,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2448,
        20832
      ],
      "id": "419fa195-2915-4af3-8d60-990bf1fd6971",
      "name": "Preparar Búsqueda Producto Nuevo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2256,
        20832
      ],
      "id": "6ff2808f-3ca0-474a-b2e0-5a3461ac8448",
      "name": "HTTP Buscar Producto Nuevo"
    },
    {
      "parameters": {
        "jsCode": "// Nodo: Procesar Producto Nuevo\n\n// 1) Respuesta pura de Odoo que viene del HTTP\nconst respuesta = $json;\nconst resultados = Array.isArray(respuesta.result) ? respuesta.result : [];\n\n// 2) Recuperamos el contexto original del nodo \"Preparar Búsqueda Producto Nuevo\"\nconst original = $('Preparar Búsqueda Producto Nuevo').item.json;\n\nconst {\n  producto_texto,\n  cantidad,\n  lineas = [],\n  pedido_id,\n  pedido_numero,\n  chat_id,\n  user_id,\n  db,\n  uid,\n} = original;\n\n// 3) Si NO hay resultados → pedir corrección\nif (!resultados.length) {\n  return {\n    ...original,\n    odoo_raw: respuesta,\n    error_producto_nuevo: true,\n    texto_bot:\n      `No he encontrado ningún producto en Odoo que se parezca a \"*${producto_texto}*\".\\n\\n` +\n      `Prueba a decirme el producto con otro nombre o más detalle.\\n` +\n      `Por ejemplo:\\n` +\n      `• \"añade 2 tarta de queso grande\"\\n` +\n      `• \"tarta de queso entera x 2\"`,\n  };\n}\n\n// 4) Si hay varios resultados → mostrar opciones y pedir que aclare\nif (resultados.length > 1) {\n  const top = resultados.slice(0, 7); // máximo 7\n\n  const opciones = top\n    .map((p, idx) => {\n      const ref = p.default_code || 'sin referencia';\n      const precio = (p.list_price ?? 0).toString().replace('.', ',');\n      return `${idx + 1}. ${p.name}  (ref: ${ref})  —  €${precio}`;\n    })\n    .join('\\n');\n\n  const texto_bot =\n    `He encontrado varios productos que se parecen a \"*${producto_texto}*\":\\n\\n` +\n    `${opciones}\\n\\n` +\n    `Por favor, dime el producto correcto escribiendo su *nombre completo* y cantidad.\\n\\n` +\n    `Ejemplos:\\n` +\n    `• \"añade 2 ${resultados[0].name}\"\\n` +\n    `• \"${resultados[0].name} x 2\"`;\n\n  return {\n    ...original,\n    odoo_raw: respuesta,\n    error_producto_nuevo: true,\n    texto_bot,\n  };\n}\n\n// 5) Solo 1 resultado → lo usamos para añadir la línea al pedido\nconst p = resultados[0];\n\n// --- NUEVO CÓDIGO PARA LIMPIAR LAS LÍNEAS ---\n\n// Normalizamos y filtramos las líneas que ya había en el pedido\nconst lineas_validas = (lineas || [])\n  .map(l => {\n    const product_id = Number(l.product_id);\n    const product_uom_qty = Number(l.product_uom_qty);\n    const price_unit = Number(l.price_unit);\n\n    return {\n      name: l.name,\n      product_id,\n      product_uom_qty,\n      price_unit,\n    };\n  })\n  // Nos quedamos solo con las que tengan números válidos\n  .filter(l =>\n    Number.isFinite(l.product_id) &&\n    Number.isFinite(l.product_uom_qty) &&\n    Number.isFinite(l.price_unit)\n  );\n\n// Ahora construimos las nuevas líneas del pedido:\n//  - todas las válidas anteriores\n//  - la nueva línea del producto encontrado en Odoo\nconst nuevas_lineas = [\n  ...lineas_validas,\n  {\n    product_id: p.id,\n    product_uom_qty: cantidad,\n    price_unit: p.list_price,\n    name: p.name,\n  },\n];\n\nif (!pedido_id || !uid) {\n  return {\n    ...original,\n    odoo_raw: respuesta,\n    error_producto_nuevo: true,\n    texto_bot: 'Faltan datos del pedido o del UID de Odoo para actualizar el pedido.',\n  };\n}\n\n// Comandos order_line: borramos y volvemos a crear todas las líneas\nconst order_line_commands = [\n  [5, 0, 0], // limpiar todas las líneas\n  ...nuevas_lineas.map(l => [\n    0,\n    0,\n    {\n      product_id: l.product_id,\n      product_uom_qty: l.product_uom_qty,\n      price_unit: l.price_unit,\n      name: l.name,\n    },\n  ]),\n];\n\nconst payloadUpdate = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order',\n      'write',\n      [[pedido_id], { order_line: order_line_commands }],\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...original,\n  odoo_raw: respuesta,\n  error_producto_nuevo: false,\n  nuevas_lineas,\n  payload: payloadUpdate,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2048,
        20832
      ],
      "id": "8103a080-9612-4b48-9176-66672c20dc0d",
      "name": "Procesar Producto Nuevo"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "47372fed-d793-44a1-832d-6dbf0ae00b72",
              "leftValue": "={{ $json.error_producto_nuevo === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1840,
        20832
      ],
      "id": "583befd7-3fe4-4f44-b990-417096cf294c",
      "name": "¿Error producto nuevo?"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Búsqueda Producto Nuevo').item.json.chat_id }}",
        "text": "={{ $('Procesar Producto Nuevo').item.json.texto_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1552,
        20688
      ],
      "id": "8f898d3d-4946-492d-b3cb-a3a4dc5f1b54",
      "name": "Mensaje Error Producto Nuevo",
      "webhookId": "06a3fc02-803a-473a-bc83-b330c2d68c71"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1328,
        20896
      ],
      "id": "09ec65c8-ea27-4690-9109-4ac8d8c0c5e3",
      "name": "HTTP Actualizar Pedido1"
    },
    {
      "parameters": {
        "jsCode": "// Helper para leer json de otro nodo\nfunction safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Intentamos recuperar el contexto más “rico”\nconst desdeNuevo = safeJson('Procesar Producto Nuevo') || {};\nconst desdeMod   = safeJson('Aplicar Modificación')   || {};\nconst desdePayload = safeJson('Preparar Payload Actualizar Pedido1') || {};\n\nlet datos = {};\n\n// Prioridad: lo que ya tiene lineasFinales desde el payload → luego nuevo → luego mod\nif (Array.isArray(desdePayload.lineas) && desdePayload.lineas.length) {\n  datos = desdePayload;\n} else if (Object.keys(desdeNuevo).length) {\n  datos = desdeNuevo;\n} else {\n  datos = desdeMod;\n}\n\n// Originales y parches (por si acaso queremos fusionar)\nconst originales = Array.isArray(datos.lineas) ? datos.lineas : [];\nconst parches    = Array.isArray(datos.nuevas_lineas) ? datos.nuevas_lineas : [];\n\n// Misma función de key que en el otro nodo\nfunction buildKey(l) {\n  if (l.product_id && l.product_id !== 'id producto') {\n    return String(l.product_id);\n  }\n  return (l.name || '')\n    .toString()\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim();\n}\n\nfunction mergeLineas(originales, parches) {\n  if (!parches.length) return originales;\n\n  const patchMap = new Map();\n  for (const p of parches) {\n    patchMap.set(buildKey(p), p);\n  }\n\n  const resultado = [];\n\n  for (const orig of originales) {\n    const key = buildKey(orig);\n    if (patchMap.has(key)) {\n      const patch = patchMap.get(key);\n      const qtyPatch = Number(patch.product_uom_qty ?? patch.cantidad ?? 0) || 0;\n      if (patch.eliminar === true || qtyPatch === 0) {\n        patchMap.delete(key);\n        continue;\n      }\n      resultado.push({ ...orig, ...patch });\n      patchMap.delete(key);\n    } else {\n      resultado.push(orig);\n    }\n  }\n\n  for (const patch of patchMap.values()) {\n    const qtyPatch = Number(patch.product_uom_qty ?? patch.cantidad ?? 0) || 0;\n    if (patch.eliminar === true || qtyPatch === 0) continue;\n    resultado.push(patch);\n  }\n\n  return resultado;\n}\n\nlet lineasFinales = [];\n\nif (originales.length && parches.length) {\n  lineasFinales = mergeLineas(originales, parches);\n} else if (originales.length) {\n  lineasFinales = originales;\n} else {\n  lineasFinales = parches;\n}\n\n// Si desde el nodo de payload ya venían lineas finales, las priorizamos\nif (Array.isArray(desdePayload.lineas) && desdePayload.lineas.length) {\n  lineasFinales = desdePayload.lineas;\n}\n\nconst numeroPedido  = datos.pedido_numero || datos.pedido_id;\nconst clienteNombre = datos.cliente_nombre || '';\nconst chatId        = datos.chat_id;\nconst userId        = datos.user_id;\n\nlet texto = `✅ *Pedido ${numeroPedido} actualizado*.\\n\\n`;\ntexto += `📦 *Productos actuales:*\\n`;\n\nfor (const l of lineasFinales) {\n  const qty = Number(l.product_uom_qty ?? l.cantidad ?? 0) || 0;\n  texto += `• ${l.name} — Cantidad: ${qty}\\n`;\n}\n\ntexto += `\\nSi quieres hacer otro cambio, puedes decirme por ejemplo:\\n`;\ntexto += `- \"añade 1 coca cola\"\\n`;\ntexto += `- \"quita 2 tartas de queso\"\\n`;\n\nreturn {\n  chat_id: chatId,\n  user_id: userId,\n  pedido_id: datos.pedido_id,\n  pedido_numero: numeroPedido,\n  cliente_nombre: clienteNombre,\n  lineas: lineasFinales,\n  texto,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1136,
        20896
      ],
      "id": "94a477ec-f95a-42d0-96e7-7b3cf95c5d1b",
      "name": "Formatear Resumen Pedido Actualizado1"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -928,
        20896
      ],
      "id": "9cedb830-06f2-4716-8638-4985848a1de3",
      "name": "Enviar Pedido Actualizado1",
      "webhookId": "06a3fc02-803a-473a-bc83-b330c2d68c71"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE pedidos_cliente\nSET lineas = $1::jsonb\nWHERE pedido_id = $2\n  AND chat_id = $3;",
        "options": {
          "queryReplacement": "={{ [\n  // $1 -> lineas (jsonb)\n  JSON.stringify(\n    $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"lineas\"] || []\n  ),\n\n  // $2 -> pedido_id\n  $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"pedido_id\"],\n\n  // $3 -> chat_id\n  $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"chat_id\"]\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -736,
        20896
      ],
      "id": "68e69d6b-9e29-4811-87b5-3cb062251808",
      "name": "Actualizar pedidos_cliente1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW());",
        "options": {
          "queryReplacement": "={{ [\n  // $1 - chat_id\n  $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"chat_id\"],\n\n  // $2 - user_id\n  $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"user_id\"],\n\n  // $3 - user_name\n  \"Usuario\",\n\n  // $4 - esperando_confirmacion\n  \"modificar_pedido_detalle\",\n\n  // $5 - ultimo_mensaje_bot\n  $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"texto\"],\n\n  // $6 - datos_pendientes\n  JSON.stringify({\n    pedido_id: $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"pedido_id\"],\n    pedido_numero: $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"pedido_numero\"],\n    lineas: $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"lineas\"] || []\n  }),\n\n  // $7 - mensaje_usuario (si quieres guardar algo aquí; si no, déjalo vacío)\n  \"\",\n\n  // $8 - historial\n  JSON.stringify([]),\n\n  // $9 - historial_conversacion\n  JSON.stringify([\n    {\n      tipo: \"bot\",\n      contenido: $node[\"Formatear Resumen Pedido Actualizado1\"].json[\"texto\"],\n      timestamp: new Date().toISOString()\n    }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -560,
        20896
      ],
      "id": "02fc9738-b4b2-45f6-a60a-4b268a673c6e",
      "name": "Guardar Memoria Modificar Pedido - Detalle1"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR PAYLOAD PARA ACTUALIZAR EL PEDIDO EN ODOO\n\nfunction safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst cur = $json;\n\n// 1) Si ya hay payload (caso \"Procesar Producto Nuevo\"), no lo tocamos\nif (cur.payload) {\n  return cur;\n}\n\n// 2) uid / db\nconst auth = safeJson('Autenticar Odoo') || {};\nconst uid  = cur.uid || auth.result;\nconst db   = cur.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\n\n// 3) Sanitizar líneas\nconst toNumber = (v, def = 0) => {\n  if (v === null || v === undefined) return def;\n  const n = Number(String(v).replace(',', '.'));\n  return isNaN(n) ? def : n;\n};\n\nconst sanitizeLine = (l) => {\n  // si el product_id no es numérico, la línea es basura/ejemplo → la saltamos\n  const pid = toNumber(l.product_id, NaN);\n  if (isNaN(pid)) {\n    return null;\n  }\n\n  return {\n    product_id: pid,\n    product_uom_qty: toNumber(l.product_uom_qty, 1),\n    price_unit: toNumber(l.price_unit ?? l.list_price, 0),\n    name: l.name || '',\n  };\n};\n\nconst rawLines = cur.nuevas_lineas || cur.lineas || [];\nconst nuevas_lineas = rawLines\n  .map(sanitizeLine)\n  .filter(l => l !== null);\n\n// por seguridad: si tras sanear no queda ninguna línea, mejor no tocar el pedido\nif (!cur.pedido_id || !uid || nuevas_lineas.length === 0) {\n  return {\n    ...cur,\n    error_modificacion: true,\n    texto_bot: 'No puedo actualizar el pedido porque las líneas no tienen datos válidos (IDs o precios numéricos).',\n  };\n}\n\n// 4) Construir comandos order_line\nconst order_line_commands = [\n  [5, 0, 0], // limpia las líneas existentes\n  ...nuevas_lineas.map(l => [0, 0, {\n    product_id: l.product_id,\n    product_uom_qty: l.product_uom_qty,\n    price_unit: l.price_unit,\n    name: l.name,\n  }]),\n];\n\n// 5) Payload JSON-RPC\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order',\n      'write',\n      [[cur.pedido_id], { order_line: order_line_commands }],\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...cur,\n  uid,\n  db,\n  nuevas_lineas,\n  payload,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2240,
        21264
      ],
      "id": "1e868cd2-972f-4da6-9ced-8e51abe3167e",
      "name": "Preparar Payload Actualizar Pedido"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR PAYLOAD PARA ACTUALIZAR EL PEDIDO EN ODOO\n// Este nodo mezcla las líneas originales con las nuevas\n// y además filtra las líneas \"fake\" (id producto / precio texto).\n\n// Helper para leer json de otro nodo sin romper si no existe\nfunction safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst cur = $json;\n\n// 1) Si ya hay payload (caso \"Procesar Producto Nuevo\"), de momento lo vamos a recalcular,\n//    porque queremos asegurarnos de que las líneas están saneadas.\nlet base = { ...cur };\n\n// 2) Tomamos líneas originales + parches (nuevas_lineas)\nlet originales = Array.isArray(base.lineas) ? base.lineas : [];\nlet parches    = Array.isArray(base.nuevas_lineas) ? base.nuevas_lineas : [];\n\n// Función para generar una clave de comparación por línea\nfunction buildKey(l) {\n  if (l.product_id && l.product_id !== 'id producto') {\n    return String(l.product_id);\n  }\n  return (l.name || '')\n    .toString()\n    .toLowerCase()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .trim();\n}\n\n// Si no hay originales y sí hay parches, usamos parches como base\nif (!originales.length && parches.length) {\n  originales = parches;\n}\n\n// Fusionar líneas originales + nuevas (sin perder productos)\nfunction mergeLineas(originales, parches) {\n  if (!parches.length) return originales;\n\n  const patchMap = new Map();\n  for (const p of parches) {\n    patchMap.set(buildKey(p), p);\n  }\n\n  const resultado = [];\n\n  // 1) Aplicar parches sobre originales\n  for (const orig of originales) {\n    const key = buildKey(orig);\n    if (patchMap.has(key)) {\n      const patch = patchMap.get(key);\n\n      const qtyPatch = Number(patch.product_uom_qty ?? patch.cantidad ?? 0) || 0;\n      if (patch.eliminar === true || qtyPatch === 0) {\n        patchMap.delete(key);\n        continue; // eliminamos esta línea\n      }\n\n      resultado.push({\n        ...orig,\n        ...patch,\n      });\n\n      patchMap.delete(key);\n    } else {\n      // Línea sin cambios → se mantiene\n      resultado.push(orig);\n    }\n  }\n\n  // 2) Añadir líneas nuevas que no existían antes\n  for (const patch of patchMap.values()) {\n    const qtyPatch = Number(patch.product_uom_qty ?? patch.cantidad ?? 0) || 0;\n    if (patch.eliminar === true || qtyPatch === 0) continue;\n\n    resultado.push(patch);\n  }\n\n  return resultado;\n}\n\nconst lineasFusionadas = mergeLineas(originales, parches);\n\n// 3) Normalizar y FILTRAR solo las líneas válidas para Odoo\nconst lineasValidas = lineasFusionadas\n  .map(l => {\n    const pid   = Number(l.product_id);\n    const qty   = Number(l.product_uom_qty ?? l.cantidad ?? 0);\n    const price = Number(l.price_unit ?? 0);\n\n    return {\n      ...l,\n      product_id: pid,\n      product_uom_qty: Number.isFinite(qty) ? qty : 0,\n      price_unit: Number.isFinite(price) ? price : 0,\n    };\n  })\n  .filter(l =>\n    Number.isInteger(l.product_id) &&\n    l.product_id > 0\n  ); // <- fuera \"id producto\", null, etc.\n\nif (!lineasValidas.length) {\n  // No hay ninguna línea con product_id numérico: NO intentamos escribir en Odoo.\n  return {\n    ...base,\n    error_modificacion: true,\n    texto_bot: 'No tengo ninguna línea de producto con un ID válido para actualizar el pedido en Odoo.',\n  };\n}\n\n// 4) Intentamos obtener uid y db\nconst auth = safeJson('Autenticar Odoo') || {};\nconst uid  = base.uid || auth.result;\nconst db   = base.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\n\nconst pedidoId = base.pedido_id;\n\nif (!pedidoId || !uid) {\n  return {\n    ...base,\n    error_modificacion: true,\n    texto_bot: 'Faltan datos para actualizar el pedido en Odoo (uid o pedido_id).',\n  };\n}\n\n// 5) Construir los comandos order_line para Odoo (solo con líneas válidas)\nconst order_line_commands = [\n  [5, 0, 0], // limpia las líneas existentes en el pedido\n  ...lineasValidas.map(l => ([\n    0,\n    0,\n    {\n      product_id: l.product_id,\n      product_uom_qty: l.product_uom_qty,\n      price_unit: l.price_unit,\n      name: l.name,\n    },\n  ])),\n];\n\n// 6) Construir el payload JSON-RPC para sale.order.write\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order',\n      'write',\n      [[pedidoId], { order_line: order_line_commands }],\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...base,\n  uid,\n  db,\n  // Para el resto del flujo usamos ya las líneas saneadas\n  lineas: lineasValidas,\n  nuevas_lineas: lineasValidas,\n  payload,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1536,
        20896
      ],
      "id": "b9bffeee-4722-4110-bff4-c0847fa070e8",
      "name": "Preparar Payload Actualizar Pedido1"
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\n\nreturn [{\n  numero_pedido: item.numero_pedido,\n  chat_id: item.chat_id,\n  query_params: [item.numero_pedido, item.chat_id]\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2832,
        20416
      ],
      "id": "6807c899-18d1-4c42-8a8c-4c782ac24e0c",
      "name": "Code"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();const input = $json;\n\n// Texto que va a ver el usuario (ya viene de Interpretar Modificación Pedido)\nconst textoBot = input.texto_bot || 'Necesito que me concretes un poco más.';\n\n// Último mensaje del usuario, por si lo quieres guardar\nconst mensajeUsuario = input.mensaje_original || input.mensaje_usuario || input.text || '';\n\nreturn {\n  chat_id: input.chat_id,\n  user_id: input.user_id || input.chat_id,\n  user_name: input.user_name || 'Usuario',\n  texto: textoBot,\n  mensaje_usuario: mensajeUsuario,\n\n  // Pedido en memoria para la siguiente vuelta (\"añade 2 clavos\", etc.)\n  pedido_id: input.pedido_id,\n  pedido_numero: input.pedido_numero,\n  lineas: input.lineas || []\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3072,
        20736
      ],
      "id": "5a0241dd-5de6-4a4c-9668-f31df57e0403",
      "name": "Preparar Memoria Aclaración Modificación"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW());",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,              // $1\n  $json.user_id,              // $2\n  $json.user_name,            // $3\n  'modificar_pedido_detalle', // $4 -> seguimos en flujo de modificación\n  $json.texto,                // $5 -> último mensaje del bot (la aclaración)\n  JSON.stringify({            // $6 -> datos_pendientes (pedido en memoria)\n    pedido_id: $json.pedido_id,\n    pedido_numero: $json.pedido_numero,\n    lineas: $json.lineas || []\n  }),\n  $json.mensaje_usuario || '', // $7 -> último mensaje del usuario\n  JSON.stringify([]),          // $8 -> historial (si no lo usas, lo dejas vacío)\n  JSON.stringify([\n    {\n      tipo: 'bot',\n      contenido: $json.texto,\n      timestamp: new Date().toISOString()\n    }\n  ])                            // $9 -> historial_conversacion\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2864,
        20736
      ],
      "id": "b5c8fd75-9fc9-49d7-b11e-9e5b41b2c76d",
      "name": "Guardar Memoria Aclaración Modificación"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst cur = $json;\nconst auth = safeJson('Autenticar Odoo') || {};\n\nconst uid = cur.uid || auth.result;\nconst db = cur.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\nconst pedido_id = cur.pedido_id;\n\nif (!uid || !pedido_id) {\n  return {\n    ...cur,\n    error_sync: true,\n    texto_bot: 'No puedo sincronizar el pedido sin autenticación o ID de pedido.',\n  };\n}\n\n// Payload para leer el pedido y sus líneas\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order',\n      'read',\n      [[pedido_id]],\n      {\n        fields: ['order_line', 'partner_id', 'name']\n      }\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...cur,\n  uid,\n  db,\n  payload_read_order: payload,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3472,
        22400
      ],
      "id": "45cf2a01-9b5a-4e04-b9e1-15283998d46b",
      "name": "Code1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload_read_order) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3280,
        22400
      ],
      "id": "5c751509-1069-4332-b9ae-429cf2ee4860",
      "name": "HTTP Leer Líneas Actuales de Odoo"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Respuesta del HTTP Request anterior\nconst respuesta = $json;\nconst original = safeJson('Leer Líneas Actuales de Odoo') || {};\n\nif (!respuesta.result || !Array.isArray(respuesta.result) || !respuesta.result[0]) {\n  return {\n    ...original,\n    error_sync: true,\n    texto_bot: 'No pude obtener las líneas del pedido desde Odoo.',\n  };\n}\n\nconst pedidoData = respuesta.result[0];\nconst lineIds = pedidoData.order_line || [];\n\nif (!lineIds.length) {\n  // Pedido sin líneas (nuevo o vacío)\n  return {\n    ...original,\n    lineas_odoo: [],\n    lineas: [],\n  };\n}\n\n// Ahora necesitamos leer los detalles de cada línea\nconst uid = original.uid;\nconst db = original.db;\n\nconst payload_read_lines = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order.line',\n      'read',\n      [lineIds],\n      {\n        fields: ['id', 'product_id', 'product_uom_qty', 'price_unit', 'name']\n      }\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...original,\n  line_ids_to_read: lineIds,\n  payload_read_lines,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3104,
        22400
      ],
      "id": "a09e91d9-c310-4029-97d3-2a03d4513dba",
      "name": "Procesar IDs de Líneas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload_read_lines) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2944,
        22400
      ],
      "id": "1c7f203c-5cfc-4365-bfa0-c4483c974509",
      "name": "HTTP Leer Líneas Detalle"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst respuesta = $json;\nconst original = safeJson('Procesar IDs de Líneas') || {};\n\nif (!respuesta.result || !Array.isArray(respuesta.result)) {\n  return {\n    ...original,\n    error_sync: true,\n    texto_bot: 'Error al leer los detalles de las líneas.',\n  };\n}\n\n// Formatear líneas con toda la información necesaria\nconst lineas = respuesta.result.map(l => ({\n  id: l.id, // ⭐ ID de la línea en Odoo (CLAVE)\n  product_id: Array.isArray(l.product_id) ? l.product_id[0] : l.product_id,\n  product_uom_qty: Number(l.product_uom_qty || 0),\n  price_unit: Number(l.price_unit || 0),\n  name: Array.isArray(l.name) ? l.name[1] : (l.name || ''),\n}));\n\nreturn {\n  ...original,\n  lineas, // Líneas completas con IDs\n  error_sync: false,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2736,
        22400
      ],
      "id": "82e50c89-a2c1-43f2-98a2-740dd841f1e7",
      "name": "Formatear Líneas con IDs Odoo"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst httpResponse = $json;\nconst original = safeJson('Preparar Payload Actualizar Pedido') || {};\n\nconst uid = original.uid;\nconst db = original.db;\nconst pedido_id = original.pedido_id;\n\nif (!uid || !pedido_id) {\n  return {\n    ...original,\n    error_sync: true,\n  };\n}\n\nif (httpResponse.error) {\n  return {\n    ...original,\n    error_modificacion: true,\n    texto_bot: 'Error al actualizar el pedido en Odoo: ' + (httpResponse.error.message || 'desconocido'),\n  };\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order',\n      'read',\n      [[pedido_id]],\n      {\n        fields: ['order_line']\n      }\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...original,\n  payload_resync: payload,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1584,
        22784
      ],
      "id": "a7511572-db9f-42e0-86eb-691f4ff888ab",
      "name": "Re-sincronizar Después de Actualizar"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload_resync) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1392,
        22784
      ],
      "id": "64cf9121-5f45-444d-849c-d7f4b2a2ac23",
      "name": "HTTP Re-sincronizar Pedido"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Respuesta del HTTP Request anterior\nconst respuesta = $json;\nconst original = safeJson('Re-sincronizar Después de Actualizar') || {};\n\nif (!respuesta.result || !Array.isArray(respuesta.result) || !respuesta.result[0]) {\n  return {\n    ...original,\n    error_sync: true,\n    texto_bot: 'No pude obtener las líneas del pedido desde Odoo.',\n  };\n}\n\nconst pedidoData = respuesta.result[0];\nconst lineIds = pedidoData.order_line || [];\n\nif (!lineIds.length) {\n  // Pedido sin líneas (nuevo o vacío)\n  return {\n    ...original,\n    lineas_odoo: [],\n    lineas: [],\n  };\n}\n\n// Ahora necesitamos leer los detalles de cada línea\nconst uid = original.uid;\nconst db = original.db;\n\nconst payload_read_lines = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order.line',\n      'read',\n      [lineIds],\n      {\n        fields: ['id', 'product_id', 'product_uom_qty', 'price_unit', 'name']\n      }\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...original,\n  line_ids_to_read: lineIds,\n  payload_read_lines,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1184,
        22784
      ],
      "id": "79a50bbc-49bb-46ee-8d88-9f03b0876966",
      "name": "Procesar IDs"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload_read_lines) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -992,
        22784
      ],
      "id": "ecdd6eb0-5fbb-46c5-bfef-8b9a4a6e1880",
      "name": "HTTP Leer Líneas Detalle1"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst respuesta = $json;\nconst original = safeJson('Procesar IDs') || {};\n\nif (!respuesta.result || !Array.isArray(respuesta.result)) {\n  return {\n    ...original,\n    error_sync: true,\n    texto_bot: 'Error al leer los detalles de las líneas.',\n  };\n}\n\n// Formatear líneas con toda la información necesaria\nconst lineas = respuesta.result.map(l => ({\n  id: l.id, // ⭐ ID de la línea en Odoo (CLAVE)\n  product_id: Array.isArray(l.product_id) ? l.product_id[0] : l.product_id,\n  product_uom_qty: Number(l.product_uom_qty || 0),\n  price_unit: Number(l.price_unit || 0),\n  name: Array.isArray(l.name) ? l.name[1] : (l.name || ''),\n}));\n\nreturn {\n  ...original,\n  lineas, // Líneas completas con IDs\n  error_sync: false,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        22784
      ],
      "id": "981e247f-a7d7-4c16-bce2-cf23263e43ca",
      "name": "Formatear Líneas con IDs Odoo1"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst httpResponse = $json;\nconst original = safeJson('Preparar Payload Actualizar Pedido1') || {};\n\nconst uid = original.uid;\nconst db = original.db;\nconst pedido_id = original.pedido_id;\n\nif (!uid || !pedido_id) {\n  return {\n    ...original,\n    error_sync: true,\n  };\n}\n\nif (httpResponse.error) {\n  return {\n    ...original,\n    error_modificacion: true,\n    texto_bot: 'Error al actualizar el pedido en Odoo: ' + (httpResponse.error.message || 'desconocido'),\n  };\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order',\n      'read',\n      [[pedido_id]],\n      {\n        fields: ['order_line']\n      }\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...original,\n  payload_resync: payload,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -912,
        22368
      ],
      "id": "26acd36e-08fc-4f1a-95d1-5dcaa18f78fc",
      "name": "Re-sincronizar Después de Actualizar1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload_resync) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -720,
        22368
      ],
      "id": "3f47d7e7-d225-4f9e-8420-82292095f4c0",
      "name": "HTTP Re-sincronizar Pedido1"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Respuesta del HTTP Request anterior\nconst respuesta = $json;\nconst original = safeJson('Re-sincronizar Después de Actualizar1') || {};\n\nif (!respuesta.result || !Array.isArray(respuesta.result) || !respuesta.result[0]) {\n  return {\n    ...original,\n    error_sync: true,\n    texto_bot: 'No pude obtener las líneas del pedido desde Odoo.',\n  };\n}\n\nconst pedidoData = respuesta.result[0];\nconst lineIds = pedidoData.order_line || [];\n\nif (!lineIds.length) {\n  // Pedido sin líneas (nuevo o vacío)\n  return {\n    ...original,\n    lineas_odoo: [],\n    lineas: [],\n  };\n}\n\n// Ahora necesitamos leer los detalles de cada línea\nconst uid = original.uid;\nconst db = original.db;\n\nconst payload_read_lines = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order.line',\n      'read',\n      [lineIds],\n      {\n        fields: ['id', 'product_id', 'product_uom_qty', 'price_unit', 'name']\n      }\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...original,\n  line_ids_to_read: lineIds,\n  payload_read_lines,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -512,
        22368
      ],
      "id": "a7eb21fa-0430-49e0-a541-4552ed9e4843",
      "name": "Procesar IDs1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload_read_lines) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -320,
        22368
      ],
      "id": "ab826c8b-5347-4fba-8c8e-a0b20fb28fa7",
      "name": "HTTP Leer Líneas Detalle2"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst respuesta = $json;\nconst original = safeJson('Procesar IDs1') || {};\n\nif (!respuesta.result || !Array.isArray(respuesta.result)) {\n  return {\n    ...original,\n    error_sync: true,\n    texto_bot: 'Error al leer los detalles de las líneas.',\n  };\n}\n\n// Formatear líneas con toda la información necesaria\nconst lineas = respuesta.result.map(l => ({\n  id: l.id, // ⭐ ID de la línea en Odoo (CLAVE)\n  product_id: Array.isArray(l.product_id) ? l.product_id[0] : l.product_id,\n  product_uom_qty: Number(l.product_uom_qty || 0),\n  price_unit: Number(l.price_unit || 0),\n  name: Array.isArray(l.name) ? l.name[1] : (l.name || ''),\n}));\n\nreturn {\n  ...original,\n  lineas, // Líneas completas con IDs\n  error_sync: false,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -144,
        22368
      ],
      "id": "445a3860-08b2-4224-a79e-96f287815aac",
      "name": "Formatear Líneas con IDs Odoo2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "35213ba6-21ae-4bba-b206-5445f1725bcb",
              "leftValue": "={{ $json.necesita_aclaracion }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3680,
        22304
      ],
      "id": "8fd3ebb5-8485-4e63-bd83-282aecda14bb",
      "name": "¿Necesita aclaración modificación?1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Interpretar Modificación Pedido').item.json.chat_id }}",
        "text": "={{ $('Interpretar Modificación Pedido').item.json.texto_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2880,
        22112
      ],
      "id": "6dedddd8-fdef-4da3-b986-4924624f2861",
      "name": "Mensaje Aclaración Modificación1",
      "webhookId": "260136f8-bffe-4a9a-89a2-9fc4728b3773"
    },
    {
      "parameters": {
        "jsCode": "const {\n  pedido_id,\n  pedido_numero,\n  lineas = [], // ⭐ Ahora estas líneas TIENEN IDs de Odoo\n  tipo_ajuste,\n  cantidad,\n  producto_texto,\n  chat_id,\n  user_id,\n  operacion,\n} = $json;\n\nif (!pedido_id || !Array.isArray(lineas)) {\n  return {\n    ...$json,\n    error_modificacion: true,\n    texto_bot: 'No tengo los datos del pedido para modificarlo.',\n  };\n}\n\n// Normalizar texto\nconst normalize = (s) => (s || '').toString()\n  .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\n  .toLowerCase().replace(/\\s+/g, ' ')\n  .trim();\n\nconst target = normalize(producto_texto || '');\n\n// Buscar línea candidata\nconst candidatos = [];\nfor (let i = 0; i < lineas.length; i++) {\n  const l = lineas[i];\n  const nameNorm = normalize(l.name);\n  if (!nameNorm) continue;\n\n  let score = 0;\n  if (nameNorm.includes(target) || target.includes(nameNorm)) {\n    score = 3;\n  } else {\n    const t1 = new Set(nameNorm.split(' '));\n    const t2 = new Set(target.split(' '));\n    let inter = 0;\n    for (const t of t1) if (t2.has(t)) inter++;\n    if (inter > 0) score = 1;\n  }\n\n  if (score > 0) {\n    candidatos.push({ index: i, linea: l, score });\n  }\n}\n\n// CASO 1: No encontrado → producto nuevo\nif (candidatos.length === 0) {\n  return {\n    ...$json,\n    es_producto_nuevo: true,\n    error_modificacion: false,\n    texto_bot: null,\n  };\n}\n\n// CASO 2: Múltiples candidatos → desambiguar\nif (candidatos.length > 1) {\n  const textoOpciones = candidatos\n    .map((c, idx) => `${idx + 1}. ${c.linea.name} — Cantidad: ${c.linea.product_uom_qty}`)\n    .join('\\n');\n\n  return {\n    ...$json,\n    necesita_desambiguacion_linea: true,\n    candidatos_linea: candidatos,\n    texto_bot: `He encontrado varios productos parecidos a \"${producto_texto}\":\\n\\n${textoOpciones}\\n\\nDime el número del producto a modificar.`,\n  };\n}\n\n// CASO 3: Una sola línea encontrada\nconst elegido = candidatos[0];\nconst linea = elegido.linea;\nconst actual = Number(linea.product_uom_qty || 0);\nconst q = Number(cantidad || 1);\n\n// ⭐ ELIMINAR LÍNEA COMPLETA\nif (operacion === 'eliminar_linea' || tipo_ajuste === 'eliminar_linea') {\n  return {\n    ...$json,\n    error_modificacion: false,\n    es_producto_nuevo: false,\n    operacion: 'eliminar_linea',\n    linea_afectada: linea,\n    comando_odoo: [2, linea.id, 0], // ⭐ Comando para Odoo: eliminar esta línea\n    texto_bot: null,\n  };\n}\n\n// ⭐ AUMENTAR CANTIDAD\nif (tipo_ajuste === 'aumentar') {\n  const nuevaCantidad = actual + q;\n  \n  return {\n    ...$json,\n    error_modificacion: false,\n    es_producto_nuevo: false,\n    operacion: 'ajustar',\n    tipo_ajuste: 'aumentar',\n    linea_afectada: linea,\n    nueva_cantidad: nuevaCantidad,\n    comando_odoo: [1, linea.id, { product_uom_qty: nuevaCantidad }], // ⭐ Comando UPDATE\n    texto_bot: null,\n  };\n}\n\n// ⭐ REDUCIR CANTIDAD\nif (tipo_ajuste === 'reducir') {\n  if (q < actual) {\n    const nuevaCantidad = actual - q;\n    \n    return {\n      ...$json,\n      error_modificacion: false,\n      es_producto_nuevo: false,\n      operacion: 'ajustar',\n      tipo_ajuste: 'reducir',\n      linea_afectada: linea,\n      nueva_cantidad: nuevaCantidad,\n      comando_odoo: [1, linea.id, { product_uom_qty: nuevaCantidad }],\n      texto_bot: null,\n    };\n  } else {\n    // Quiere quitar más de lo que hay → confirmar eliminación\n    return {\n      ...$json,\n      error_modificacion: false,\n      requiere_confirmar_eliminacion: true,\n      linea_a_eliminar: linea,\n      texto_bot: `Solo hay ${actual} unidades de \"${linea.name}\". ¿Eliminar este producto? (sí/no)`,\n    };\n  }\n}\n\nreturn {\n  ...$json,\n  error_modificacion: true,\n  texto_bot: 'Por ahora solo puedo añadir o quitar cantidad.',\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2592,
        22400
      ],
      "id": "30fdeab6-74cc-4ba2-a619-2ffc6857740a",
      "name": "Aplicar Modificación1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e25b9a91-d677-4a81-8d23-4b9f92dc0d83",
              "leftValue": "={{ $json.error_modificacion === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2224,
        22640
      ],
      "id": "96f1c586-8529-4220-91cf-97038ad3a7d8",
      "name": "¿Error en modificación?1"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1808,
        22544
      ],
      "id": "cd3f74b0-fd94-4c22-8406-272af5425861",
      "name": "Mensaje Error Modificación1",
      "webhookId": "06a3fc02-803a-473a-bc83-b330c2d68c71"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload ? JSON.stringify($json.payload) : '{}' }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1792,
        22784
      ],
      "id": "c5c8337c-7ece-48e4-815c-b655433ca8b7",
      "name": "HTTP Actualizar Pedido2"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) : it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Tomar las líneas del último nodo de formateo\nconst datos = $json;\n\nconst lineasFinales = datos.lineas || [];\nconst numeroPedido = datos.pedido_numero || datos.pedido_id;\nconst clienteNombre = datos.cliente_nombre || '';\nconst chatId = datos.chat_id;\nconst userId = datos.user_id;\nconst pedidoId = datos.pedido_id;\n\nlet texto = `✅ *Pedido ${numeroPedido} actualizado*.\\\\n\\\\n`;\ntexto += `📦 *Productos actuales:*\\\\n`;\n\nfor (const l of lineasFinales) {\n  texto += `• ${l.name} — Cantidad: ${l.product_uom_qty}\\\\n`;\n}\n\ntexto += `\\\\nSi quieres hacer otro cambio, puedes decirme por ejemplo:\\\\n`;\ntexto += `- \\\"añade 1 coca cola\\\"\\\\n`;\ntexto += `- \\\"quita 2 tartas de queso\\\"\\\\n`;\n\nreturn {\n  chat_id: chatId,\n  user_id: userId,\n  pedido_id: pedidoId,\n  pedido_numero: numeroPedido,\n  cliente_nombre: clienteNombre,\n  lineas: lineasFinales,\n  texto,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        22784
      ],
      "id": "bf9a6fdd-355d-44c3-8c83-d6e158b45f5a",
      "name": "Formatear Resumen Pedido Actualizado2"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -416,
        22784
      ],
      "id": "29759c61-05b1-4d20-8fb4-4e3c4c061a79",
      "name": "Enviar Pedido Actualizado2",
      "webhookId": "06a3fc02-803a-473a-bc83-b330c2d68c71"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE pedidos_cliente\nSET lineas = $1::jsonb\nWHERE pedido_id = $2\n  AND chat_id = $3;",
        "options": {
          "queryReplacement": "={{ JSON.stringify($node[\"Formatear Resumen Pedido Actualizado2\"].json[\"lineas\"] || []) }},{{ \n  $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"pedido_id\"]\n}},{{ \n  $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"chat_id\"]\n}}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -224,
        22784
      ],
      "id": "4ff67b28-80a7-48a6-9f3b-e0fd006be8aa",
      "name": "Actualizar pedidos_cliente2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW());",
        "options": {
          "queryReplacement": "={{ [\n  // $1 - chat_id\n  $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"chat_id\"],\n\n  // $2 - user_id\n  $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"user_id\"],\n\n  // $3 - user_name\n  \"Usuario\",\n\n  // $4 - esperando_confirmacion\n  \"modificar_pedido_detalle\",\n\n  // $5 - ultimo_mensaje_bot\n  $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"texto\"],\n\n  // $6 - datos_pendientes\n  JSON.stringify({\n    pedido_id: $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"pedido_id\"],\n    pedido_numero: $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"pedido_numero\"],\n    lineas: $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"lineas\"] || []\n  }),\n\n  // $7 - mensaje_usuario (si quieres guardar algo aquí; si no, déjalo vacío)\n  \"\",\n\n  // $8 - historial\n  JSON.stringify([]),\n\n  // $9 - historial_conversacion\n  JSON.stringify([\n    {\n      tipo: \"bot\",\n      contenido: $node[\"Formatear Resumen Pedido Actualizado2\"].json[\"texto\"],\n      timestamp: new Date().toISOString()\n    }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -48,
        22784
      ],
      "id": "b64babd0-4c53-4d17-b461-f84bab2c8ba7",
      "name": "Guardar Memoria Modificar Pedido - Detalle2"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1,$2,$3,$4,$5,$6,$7,$8,$9,NOW(),NOW());",
        "options": {
          "queryReplacement": "={{ [\n    $json.chat_id,                                     // $1\n    $json.user_id,                                     // $2\n    'Usuario',                                         // $3\n    'modificar_pedido_elegir_linea',                   // $4\n    $json.texto_bot,                                   // $5\n    JSON.stringify({                                   // $6 -> datos_pendientes\n      pedido_id: $json.pedido_id,\n      pedido_numero: $json.pedido_numero,\n      lineas: $json.lineas,\n      candidatos_linea: $json.candidatos_linea,\n      tipo_ajuste: $json.tipo_ajuste,\n      cantidad: $json.cantidad,\n      producto_texto: $json.producto_texto\n    }),\n    '',                                                // $7 -> mensaje_usuario (vacío)\n    JSON.stringify([{                                  // $8 -> historial\n      tipo: 'bot',\n      contenido: $json.texto_bot,\n      timestamp: new Date().toISOString()\n    }]),\n    JSON.stringify([{                                  // $9 -> historial_conversacion\n      tipo: 'bot',\n      contenido: $json.texto_bot,\n      timestamp: new Date().toISOString()\n    }])\n  ] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1600,
        22544
      ],
      "id": "c079e109-35be-425d-a8d7-c7b87189f01d",
      "name": "Modificar Líneas1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4bd1268a-26a7-490a-b2f8-86c66ce8153d",
              "leftValue": "={{ $json.es_producto_nuevo === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2432,
        22400
      ],
      "id": "c809e5ed-e37a-4b93-9d95-f7eae816c06e",
      "name": "¿Es producto nuevo?1"
    },
    {
      "parameters": {
        "jsCode": "const {\n  producto_texto,\n  cantidad,\n  pedido_id,\n  pedido_numero,\n  lineas = [],\n  chat_id,\n  user_id,\n} = $json;\n\n// UID de Odoo desde tu nodo de login\nconst uid = $('Autenticar Odoo').item.json.result;\nconst db = 'lsanchezgoshawk-n8npruebas-main-25736898';\n\nif (!uid) {\n  return {\n    ...$json,\n    error_producto_nuevo: true,\n    texto_bot: 'No he podido autenticar con Odoo para añadir el producto nuevo.',\n  };\n}\n\nconst term = (producto_texto || '').toString().trim();\n\n// Dominio simple: productos vendibles cuyo nombre contenga el texto\nconst domain = ['&', ['sale_ok', '=', true], ['name', 'ilike', term]];\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'product.product',\n      'search_read',\n      [domain],\n      { fields: ['id', 'name', 'list_price', 'default_code'], limit: 20 },\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  uid,\n  db,\n  chat_id,\n  user_id,\n  pedido_id,\n  pedido_numero,\n  lineas,\n  producto_texto: term,\n  cantidad,\n  payload,\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2224,
        22304
      ],
      "id": "5ea5a100-d85c-40f0-a824-400bbb0edbc9",
      "name": "Preparar Búsqueda Producto Nuevo1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2032,
        22304
      ],
      "id": "3ec89058-b485-4daf-a82c-01ef9799dcf2",
      "name": "HTTP Buscar Producto Nuevo1"
    },
    {
      "parameters": {
        "jsCode": "// Nodo: Procesar Producto Nuevo\n\n// 1) Respuesta pura de Odoo que viene del HTTP \"HTTP Buscar Producto Nuevo\"\nconst respuesta = $json;\nconst resultados = Array.isArray(respuesta.result) ? respuesta.result : [];\n\n// 2) Recuperamos el contexto original del nodo \"Preparar Búsqueda Producto Nuevo\"\nconst original = $('Preparar Búsqueda Producto Nuevo1').item.json;\n\nconst {\n  producto_texto,\n  cantidad,\n  lineas = [],\n  pedido_id,\n  pedido_numero,\n  chat_id,\n  user_id,\n  db,\n  uid,\n} = original;\n\n// 3) Si NO hay resultados → pedir corrección\nif (!resultados.length) {\n  return {\n    ...original,\n    odoo_raw: respuesta,\n    error_producto_nuevo: true,\n    texto_bot:\n      `No he encontrado ningún producto en Odoo que se parezca a \"*${producto_texto}*\".\\n\\n` +\n      `Prueba a decirme el producto con otro nombre o más detalle.\\n` +\n      `Por ejemplo:\\n` +\n      `• \"añade 2 tarta de queso grande\"\\n` +\n      `• \"tarta de queso entera x 2\"`,\n  };\n}\n\n// 4) Si hay varios resultados → mostrar opciones y pedir que aclare\nif (resultados.length > 1) {\n  const top = resultados.slice(0, 7); // máximo 7\n\n  const opciones = top\n    .map((p, idx) => {\n      const ref = p.default_code || 'sin referencia';\n      const precio = (p.list_price ?? 0).toString().replace('.', ',');\n      return `${idx + 1}. ${p.name}  (ref: ${ref})  —  €${precio}`;\n    })\n    .join('\\n');\n\n  const texto_bot =\n    `He encontrado varios productos que se parecen a \"*${producto_texto}*\":\\n\\n` +\n    `${opciones}\\n\\n` +\n    `Por favor, dime el producto correcto escribiendo su *nombre completo* y cantidad.\\n\\n` +\n    `Ejemplos:\\n` +\n    `• \"añade 2 ${resultados[0].name}\"\\n` +\n    `• \"${resultados[0].name} x 2\"`;\n\n  return {\n    ...original,\n    odoo_raw: respuesta,\n    error_producto_nuevo: true,\n    texto_bot,\n  };\n}\n\n// 5) Solo 1 resultado → LO USAMOS, pero aquí NO tocamos el pedido.\n//    Este nodo SOLO devuelve la línea nueva; el siguiente nodo construye el payload.\n\nconst p = resultados[0];\n\nconst nueva_linea = {\n  product_id: p.id,\n  product_uom_qty: Number(cantidad || 1),\n  price_unit: Number(p.list_price || 0),\n  name: p.name,\n};\n\n// IMPORTANTE:\n// - NO construimos aquí el write a Odoo.\n// - NO limpiamos el pedido.\n// - Solo devolvemos el \"parche\" de línea nueva.\n// El nodo \"Preparar Payload Actualizar Pedido1\" será el que la fusione con las\n// líneas que ya existen y, si no tiene información suficiente, no tocará el pedido.\n\nreturn {\n  ...original,\n  odoo_raw: respuesta,\n  error_producto_nuevo: false,   // ✅ ÉXITO: rama FALSE del IF\n  nueva_linea,\n  // Para que el nodo de payload la vea como \"parche\"\n  nuevas_lineas: [\n    ...(original.nuevas_lineas || []),\n    nueva_linea,\n  ],\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1824,
        22304
      ],
      "id": "109b0c2e-c400-45ef-a5d9-2e3046119ccc",
      "name": "Procesar Producto Nuevo1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "47372fed-d793-44a1-832d-6dbf0ae00b72",
              "leftValue": "={{ $json.error_producto_nuevo === true }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1616,
        22304
      ],
      "id": "fdb6ba43-d1e4-4912-ad8f-eed9501ae968",
      "name": "¿Error producto nuevo?1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Búsqueda Producto Nuevo1').item.json.chat_id }}",
        "text": "={{ $('Procesar Producto Nuevo1').item.json.texto_bot }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1328,
        22160
      ],
      "id": "265d2c9c-c75e-4c5a-8ec4-4f2a8f8c350e",
      "name": "Mensaje Error Producto Nuevo1",
      "webhookId": "06a3fc02-803a-473a-bc83-b330c2d68c71"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lsanchezgoshawk-n8npruebas.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1104,
        22368
      ],
      "id": "ecd45f3d-5754-42be-88a8-4ba60a7c8ff6",
      "name": "HTTP Actualizar Pedido3"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        240,
        22368
      ],
      "id": "ff8e4808-39bc-4de0-aead-87327af86384",
      "name": "Enviar Pedido Actualizado3",
      "webhookId": "06a3fc02-803a-473a-bc83-b330c2d68c71"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE pedidos_cliente\nSET lineas = $1::jsonb\nWHERE pedido_id = $2\n  AND chat_id = $3;",
        "options": {
          "queryReplacement": "={{ [\n  // $1 -> lineas (jsonb)\n  JSON.stringify(\n    $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"lineas\"] || []\n  ),\n\n  // $2 -> pedido_id\n  $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"pedido_id\"],\n\n  // $3 -> chat_id\n  $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"chat_id\"]\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        432,
        22368
      ],
      "id": "7869309a-239e-499c-8345-fece849d3ece",
      "name": "Actualizar pedidos_cliente3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW());",
        "options": {
          "queryReplacement": "={{ [\n  // $1 - chat_id\n  $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"chat_id\"],\n\n  // $2 - user_id\n  $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"user_id\"],\n\n  // $3 - user_name\n  \"Usuario\",\n\n  // $4 - esperando_confirmacion\n  \"modificar_pedido_detalle\",\n\n  // $5 - ultimo_mensaje_bot\n  $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"texto\"],\n\n  // $6 - datos_pendientes\n  JSON.stringify({\n    pedido_id: $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"pedido_id\"],\n    pedido_numero: $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"pedido_numero\"],\n    lineas: $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"lineas\"] || []\n  }),\n\n  // $7 - mensaje_usuario (si quieres guardar algo aquí; si no, déjalo vacío)\n  \"\",\n\n  // $8 - historial\n  JSON.stringify([]),\n\n  // $9 - historial_conversacion\n  JSON.stringify([\n    {\n      tipo: \"bot\",\n      contenido: $node[\"Formatear Resumen Pedido Actualizado3\"].json[\"texto\"],\n      timestamp: new Date().toISOString()\n    }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        608,
        22368
      ],
      "id": "cf87118e-f252-4d0f-9651-65b7131bcf81",
      "name": "Guardar Memoria Modificar Pedido - Detalle3"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst cur = $json;\n\n// Si ya hay payload, no lo tocamos\nif (cur.payload) {\n  return cur;\n}\n\nconst auth = safeJson('Autenticar Odoo') || {};\nconst uid = cur.uid || auth.result;\nconst db = cur.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\n\nif (!uid || !cur.pedido_id) {\n  return {\n    ...cur,\n    error_modificacion: true,\n    texto_bot: 'Faltan datos de autenticación o ID del pedido.',\n  };\n}\n\nlet order_line_commands = [];\n\n// ⭐ CASO 1: Ya viene un comando_odoo preparado (de \"Aplicar Modificación\")\nif (cur.comando_odoo && Array.isArray(cur.comando_odoo)) {\n  order_line_commands = [cur.comando_odoo];\n}\n// ⭐ CASO 2: Añadir producto nuevo (viene de \"Procesar Producto Nuevo\")\nelse if (cur.es_producto_nuevo && cur.nueva_linea) {\n  const l = cur.nueva_linea;\n  \n  const pid = Number(l.product_id);\n  if (!pid || isNaN(pid)) {\n    return {\n      ...cur,\n      error_modificacion: true,\n      texto_bot: 'El producto nuevo no tiene un ID válido.',\n    };\n  }\n  \n  order_line_commands = [[\n    0, 0, {\n      product_id: pid,\n      product_uom_qty: Number(l.product_uom_qty || 1),\n      price_unit: Number(l.price_unit || 0),\n      name: l.name || '',\n    }\n  ]];\n}\nelse {\n  return {\n    ...cur,\n    error_modificacion: true,\n    texto_bot: 'No sé cómo actualizar el pedido con los datos recibidos.',\n  };\n}\n\nif (order_line_commands.length === 0) {\n  return {\n    ...cur,\n    error_modificacion: true,\n    texto_bot: 'No hay comandos válidos para actualizar el pedido.',\n  };\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order',\n      'write',\n      [[cur.pedido_id], { order_line: order_line_commands }],\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...cur,\n  uid,\n  db,\n  payload,\n  order_line_commands,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2016,
        22736
      ],
      "id": "a5927c8b-cb02-4498-98d5-eaf18af7a6b7",
      "name": "Preparar Payload Actualizar Pedido2"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) ? it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\nconst cur = $json;\n\n// Si ya hay payload, no lo tocamos\nif (cur.payload) {\n  return cur;\n}\n\nconst auth = safeJson('Autenticar Odoo') || {};\nconst uid = cur.uid || auth.result;\nconst db = cur.db || 'lsanchezgoshawk-n8npruebas-main-25736898';\n\nif (!uid || !cur.pedido_id) {\n  return {\n    ...cur,\n    error_modificacion: true,\n    texto_bot: 'Faltan datos de autenticación o ID del pedido.',\n  };\n}\n\nlet order_line_commands = [];\n\n// ⭐ CASO 1: Ya viene un comando_odoo preparado (de \"Aplicar Modificación\")\nif (cur.comando_odoo && Array.isArray(cur.comando_odoo)) {\n  order_line_commands = [cur.comando_odoo];\n}\n// ⭐ CASO 2: Añadir producto nuevo (viene de \"Procesar Producto Nuevo\")\nelse if (cur.es_producto_nuevo && cur.nueva_linea) {\n  const l = cur.nueva_linea;\n  \n  const pid = Number(l.product_id);\n  if (!pid || isNaN(pid)) {\n    return {\n      ...cur,\n      error_modificacion: true,\n      texto_bot: 'El producto nuevo no tiene un ID válido.',\n    };\n  }\n  \n  order_line_commands = [[\n    0, 0, {\n      product_id: pid,\n      product_uom_qty: Number(l.product_uom_qty || 1),\n      price_unit: Number(l.price_unit || 0),\n      name: l.name || '',\n    }\n  ]];\n}\nelse {\n  return {\n    ...cur,\n    error_modificacion: true,\n    texto_bot: 'No sé cómo actualizar el pedido con los datos recibidos.',\n  };\n}\n\nif (order_line_commands.length === 0) {\n  return {\n    ...cur,\n    error_modificacion: true,\n    texto_bot: 'No hay comandos válidos para actualizar el pedido.',\n  };\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      db,\n      uid,\n      'admin',\n      'sale.order',\n      'write',\n      [[cur.pedido_id], { order_line: order_line_commands }],\n    ],\n  },\n  id: Math.floor(Math.random() * 1e6),\n};\n\nreturn {\n  ...cur,\n  uid,\n  db,\n  payload,\n  order_line_commands,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1312,
        22368
      ],
      "id": "79a44562-b351-4898-ac7a-4b0ef622be57",
      "name": "Preparar Payload Actualizar Pedido3"
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();const input = $json;\n\n// Texto que va a ver el usuario (ya viene de Interpretar Modificación Pedido)\nconst textoBot = input.texto_bot || 'Necesito que me concretes un poco más.';\n\n// Último mensaje del usuario, por si lo quieres guardar\nconst mensajeUsuario = input.mensaje_original || input.mensaje_usuario || input.text || '';\n\nreturn {\n  chat_id: input.chat_id,\n  user_id: input.user_id || input.chat_id,\n  user_name: input.user_name || 'Usuario',\n  texto: textoBot,\n  mensaje_usuario: mensajeUsuario,\n\n  // Pedido en memoria para la siguiente vuelta (\"añade 2 clavos\", etc.)\n  pedido_id: input.pedido_id,\n  pedido_numero: input.pedido_numero,\n  lineas: input.lineas || []\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3264,
        22208
      ],
      "id": "365d46e9-c2fe-42a1-861a-4235f4a98026",
      "name": "Preparar Memoria Aclaración Modificación1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n\n  (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at)\nVALUES\n  ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW());",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,              // $1\n  $json.user_id,              // $2\n  $json.user_name,            // $3\n  'modificar_pedido_detalle', // $4 -> seguimos en flujo de modificación\n  $json.texto,                // $5 -> último mensaje del bot (la aclaración)\n  JSON.stringify({            // $6 -> datos_pendientes (pedido en memoria)\n    pedido_id: $json.pedido_id,\n    pedido_numero: $json.pedido_numero,\n    lineas: $json.lineas || []\n  }),\n  $json.mensaje_usuario || '', // $7 -> último mensaje del usuario\n  JSON.stringify([]),          // $8 -> historial (si no lo usas, lo dejas vacío)\n  JSON.stringify([\n    {\n      tipo: 'bot',\n      contenido: $json.texto,\n      timestamp: new Date().toISOString()\n    }\n  ])                            // $9 -> historial_conversacion\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3056,
        22208
      ],
      "id": "4113d7b5-a8c6-4001-bf2f-8c5b4bd9f219",
      "name": "Guardar Memoria Aclaración Modificación1"
    },
    {
      "parameters": {
        "jsCode": "function safeJson(nodeName) {\n  try {\n    const it = $items(nodeName, 0, 0);\n    return (Array.isArray(it) && it[0] && it[0].json) : it[0].json : null;\n  } catch (e) {\n    return null;\n  }\n}\n\n// Tomar las líneas del último nodo de formateo\nconst datos = $json;\n\nconst lineasFinales = datos.lineas || [];\nconst numeroPedido = datos.pedido_numero || datos.pedido_id;\nconst clienteNombre = datos.cliente_nombre || '';\nconst chatId = datos.chat_id;\nconst userId = datos.user_id;\nconst pedidoId = datos.pedido_id;\n\nlet texto = `✅ *Pedido ${numeroPedido} actualizado*.\\\\n\\\\n`;\ntexto += `📦 *Productos actuales:*\\\\n`;\n\nfor (const l of lineasFinales) {\n  texto += `• ${l.name} — Cantidad: ${l.product_uom_qty}\\\\n`;\n}\n\ntexto += `\\\\nSi quieres hacer otro cambio, puedes decirme por ejemplo:\\\\n`;\ntexto += `- \\\"añade 1 coca cola\\\"\\\\n`;\ntexto += `- \\\"quita 2 tartas de queso\\\"\\\\n`;\n\nreturn {\n  chat_id: chatId,\n  user_id: userId,\n  pedido_id: pedidoId,\n  pedido_numero: numeroPedido,\n  cliente_nombre: clienteNombre,\n  lineas: lineasFinales,\n  texto,\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        48,
        22368
      ],
      "id": "8b3925d3-fcae-4063-8037-829472e61d62",
      "name": "Formatear Resumen Pedido Actualizado3"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "shared": [
    {
      "updatedAt": "2026-02-18T07:59:12.134Z",
      "createdAt": "2026-02-18T07:59:12.134Z",
      "role": "workflow:owner",
      "workflowId": "417aaYOkSYKL004f",
      "projectId": "s4WYDaCaT1Iwz31l"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-02-18T07:59:12.134Z",
  "versionId": "47e7f473-b587-47b1-a75e-9863ff771e64"
}