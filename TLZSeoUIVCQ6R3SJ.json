{
  "active": false,
  "activeVersion": null,
  "activeVersionId": null,
  "connections": {
    "Preparar Datos Completos Tarea": {
      "main": [
        [
          {
            "node": "Flujo Crear Tarea y Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Horas Registradas": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Horas Directo": {
      "main": [
        [
          {
            "node": "¬øPlataforma?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Horas Directo": {
      "main": [
        [
          {
            "node": "HTTP Registrar Horas Directo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Tarea No Existe": {
      "main": [
        [
          {
            "node": "¬øPlataforma?2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Tarea No Existe": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Tarea No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria PostgreSQL Proyecto No Existe": {
      "main": [
        [
          {
            "node": "¬øPlataforma?3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Memoria Proyecto No Existe": {
      "main": [
        [
          {
            "node": "Guardar Memoria PostgreSQL Proyecto No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Tarea": {
      "main": [
        [
          {
            "node": "¬øTarea Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Buscar Tarea": {
      "main": [
        [
          {
            "node": "HTTP Buscar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Buscar Proyecto": {
      "main": [
        [
          {
            "node": "¬øProyecto Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Proyecto y Tarea Horas": {
      "main": [
        [
          {
            "node": "HTTP Buscar Proyecto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øDatos V√°lidos para PostgreSQL?": {
      "main": [
        [
          {
            "node": "Insertar en PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Datos Inv√°lidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos PostgreSQL": {
      "main": [
        [
          {
            "node": "¬øDatos V√°lidos para PostgreSQL?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Contacto Creado": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Contacto Creado": {
      "main": [
        [
          {
            "node": "¬øPlataforma?12",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Contacto": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Contacto Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Contacto": {
      "main": [
        [
          {
            "node": "HTTP Crear Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Datos Transcripci√≥n": {
      "main": [
        [
          {
            "node": "Autenticar Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Transcripci√≥n": {
      "main": [
        [
          {
            "node": "Actualizar Datos Transcripci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Transcripci√≥n": {
      "main": [
        [
          {
            "node": "Confirmar Transcripci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Descargar Audio": {
      "main": [
        [
          {
            "node": "HTTP Request - Upload Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Descarga": {
      "main": [
        [
          {
            "node": "Descargar Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Archivo de Voz": {
      "main": [
        [
          {
            "node": "Preparar Descarga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øEs Audio?": {
      "main": [
        [
          {
            "node": "Obtener Archivo de Voz",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Autenticar Odoo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Tarea Horas": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Tarea Horas": {
      "main": [
        [
          {
            "node": "¬øPlataforma?14",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Horas Tarea Solo": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Tarea Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Horas Tarea Solo": {
      "main": [
        [
          {
            "node": "HTTP Registrar Horas Tarea Solo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Tarea Solo": {
      "main": [
        [
          {
            "node": "Preparar Horas Tarea Solo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Flujo Completo": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Flujo Completo": {
      "main": [
        [
          {
            "node": "¬øPlataforma?13",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Registrar Horas Paso3": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Flujo Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registrar Horas Paso3": {
      "main": [
        [
          {
            "node": "HTTP Registrar Horas Paso3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Tarea Paso2": {
      "main": [
        [
          {
            "node": "Preparar Registrar Horas Paso3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Tarea Paso2": {
      "main": [
        [
          {
            "node": "HTTP Crear Tarea Paso2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Crear Proyecto Paso1": {
      "main": [
        [
          {
            "node": "Preparar Crear Tarea Paso2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Confirmaci√≥n": {
      "main": [
        [
          {
            "node": "¬øPlataforma?16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Actualizar Contacto": {
      "main": [
        [
          {
            "node": "Formatear Confirmaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Nuevo Valor": {
      "main": [
        [
          {
            "node": "Actualizar Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pedir Nuevo Valor": {
      "main": [
        [
          {
            "node": "¬øPlataforma?15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øFalta Nuevo Valor?": {
      "main": [
        [
          {
            "node": "Pedir Nuevo Valor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Nuevo Valor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Contacto": {
      "main": [
        [
          {
            "node": "¬øFalta Nuevo Valor?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Modificar Contacto": {
      "main": [
        [
          {
            "node": "Buscar Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flujo Crear Tarea y Horas": {
      "main": [
        [
          {
            "node": "HTTP Crear Tarea Solo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Flujo Crear Proyecto Tarea Horas": {
      "main": [
        [
          {
            "node": "HTTP Crear Proyecto Paso1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos Completos Proyecto": {
      "main": [
        [
          {
            "node": "Flujo Crear Proyecto Tarea Horas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo Completado": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Horas Autom√°tico": {
      "main": [
        [
          {
            "node": "¬øPlataforma?6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registro Autom√°tico": {
      "main": [
        [
          {
            "node": "Registrar Horas Autom√°tico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øTiene Horas Pendientes?": {
      "main": [
        [
          {
            "node": "Preparar Registro Autom√°tico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Registro Horas Pendiente": {
      "main": [
        [
          {
            "node": "¬øTiene Horas Pendientes?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limpiar Memoria Tarea": {
      "main": [
        [
          {
            "node": "Verificar Registro Horas Pendiente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Procesar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Tarea Creada": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Tarea HTTP": {
      "main": [
        [
          {
            "node": "¬øPlataforma?7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Tarea": {
      "main": [
        [
          {
            "node": "Crear Tarea HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Proyecto No Existe para Tarea": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øProyecto Existe para Tarea?": {
      "main": [
        [
          {
            "node": "Preparar Crear Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¬øPlataforma?8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Proyecto para Tarea": {
      "main": [
        [
          {
            "node": "¬øProyecto Existe para Tarea?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Proyecto para Tarea": {
      "main": [
        [
          {
            "node": "Consultar Proyecto para Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo Autom√°tico": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Completa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Horas Autom√°tico Completo": {
      "main": [
        [
          {
            "node": "¬øPlataforma?5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Registro Autom√°tico Completo": {
      "main": [
        [
          {
            "node": "Registrar Horas Autom√°tico Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Tarea Autom√°tica HTTP": {
      "main": [
        [
          {
            "node": "Preparar Registro Autom√°tico Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Tarea Autom√°tica": {
      "main": [
        [
          {
            "node": "Crear Tarea Autom√°tica HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Proyecto Creado": {
      "main": [
        [
          {
            "node": "Preparar Crear Tarea Autom√°tica",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øContinuar con Tarea?": {
      "main": [
        [
          {
            "node": "¬øPlataforma?4",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¬øPlataforma?4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analizar Proyecto Creado": {
      "main": [
        [
          {
            "node": "¬øContinuar con Tarea?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear Proyecto HTTP": {
      "main": [
        [
          {
            "node": "Analizar Proyecto Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Crear Proyecto": {
      "main": [
        [
          {
            "node": "Crear Proyecto HTTP",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øTarea Existe?": {
      "main": [
        [
          {
            "node": "Registrar Horas Directo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Tarea No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øProyecto Existe?": {
      "main": [
        [
          {
            "node": "Preparar Buscar Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Memoria Proyecto No Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Contacto": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Contacto": {
      "main": [
        [
          {
            "node": "¬øPlataforma?11",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Contacto": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Contacto": {
      "main": [
        [
          {
            "node": "HTTP Consulta Contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Ventas": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Ventas": {
      "main": [
        [
          {
            "node": "¬øPlataforma?10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Facturas Completo": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Pre-HTTP": {
      "main": [
        [
          {
            "node": "HTTP Info Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Info Facturas": {
      "main": [
        [
          {
            "node": "Debug Facturas Completo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øRequiere Info Facturas?": {
      "main": [
        [
          {
            "node": "Debug Pre-HTTP",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatear Respuesta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Info Facturas": {
      "main": [
        [
          {
            "node": "¬øRequiere Info Facturas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Ventas": {
      "main": [
        [
          {
            "node": "Preparar Info Facturas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Ventas": {
      "main": [
        [
          {
            "node": "HTTP Consulta Ventas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Producto": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Respuesta Producto": {
      "main": [
        [
          {
            "node": "¬øPlataforma?9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Consulta Producto": {
      "main": [
        [
          {
            "node": "Formatear Respuesta Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Consulta Producto": {
      "main": [
        [
          {
            "node": "HTTP Consulta Producto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Acciones": {
      "main": [
        [
          {
            "node": "Verificar Proyecto y Tarea Horas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Crear Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Buscar Proyecto para Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Producto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Ventas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Consulta Contacto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Crear Contacto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Datos Completos Proyecto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Datos Completos Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Modificar Contacto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Acci√≥n No Contemplada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router de Acciones FIXED": {
      "main": [
        [
          {
            "node": "Switch Acciones",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Procesar Respuesta": {
      "main": [
        [
          {
            "node": "Router de Acciones FIXED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Datos AI Agent": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Detectar Confirmaci√≥n": {
      "main": [
        [
          {
            "node": "Consultar Memoria PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preparar Datos AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Chat ID": {
      "main": [
        [
          {
            "node": "IF Detectar Confirmaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Memoria PostgreSQL": {
      "main": [
        [
          {
            "node": "Preparar Datos AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Autenticar Odoo": {
      "main": [
        [
          {
            "node": "Obtener Chat ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraer Datos": {
      "main": [
        [
          {
            "node": "¬øEs Audio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Extraer Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Upload Audio": {
      "main": [
        [
          {
            "node": "HTTP Request - Create Transcript (ES)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Create Transcript (ES)": {
      "main": [
        [
          {
            "node": "Esperar Transcripci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request - Get Transcript": {
      "main": [
        [
          {
            "node": "Procesar Transcripci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Esperar Transcripci√≥n": {
      "main": [
        [
          {
            "node": "HTTP Request - Get Transcript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acci√≥n No Contemplada": {
      "main": [
        [
          {
            "node": "¬øPlataforma?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Horas Registradas Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Tarea Creada Whatsapp": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo Completado Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Proyecto Creado Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Crear Tarea Autom√°tica",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Todo Autom√°tico Whatsapp": {
      "main": [
        [
          {
            "node": "Limpiar Memoria Completa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Proyecto No Existe Para Tarea Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Producto Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Ventas Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Contacto Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enviar Respuesta Contacto Creado Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Flujo Completo Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Tareas Horas Whatsapp": {
      "main": [
        [
          {
            "node": "Preparar Datos PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Acci√≥n No Contemplada Telegram",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Acci√≥n No Contemplada Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?1": {
      "main": [
        [
          {
            "node": "Confirmar Horas Registradas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Horas Registradas Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?2": {
      "main": [
        [
          {
            "node": "Preguntar Crear Tarea Solamente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preguntar Crear Tarea Solamente Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?3": {
      "main": [
        [
          {
            "node": "Preguntar Crear Proyecto Completo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Preguntar Crear Proyecto Completo Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?4": {
      "main": [
        [
          {
            "node": "Confirmar Proyecto Creado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Proyecto Creado Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?5": {
      "main": [
        [
          {
            "node": "Confirmar Todo Autom√°tico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Todo Autom√°tico Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?6": {
      "main": [
        [
          {
            "node": "Confirmar Todo Completado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Todo Completado Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?7": {
      "main": [
        [
          {
            "node": "Confirmar Tarea Creada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Tarea Creada Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?8": {
      "main": [
        [
          {
            "node": "Proyecto No Existe para Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Proyecto No Existe Para Tarea Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?9": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Producto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Producto Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?10": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Ventas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Ventas Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?11": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Contacto",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Contacto Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?12": {
      "main": [
        [
          {
            "node": "Enviar Respuesta Contacto Creado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Enviar Respuesta Contacto Creado Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?13": {
      "main": [
        [
          {
            "node": "Confirmar Flujo Completo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Flujo Completo Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?14": {
      "main": [
        [
          {
            "node": "Confirmar Tarea Horas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Tareas Horas Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?15": {
      "main": [
        [
          {
            "node": "Telegram Pedir Nuevo Valor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Pedir Nuevo Valor Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¬øPlataforma?16": {
      "main": [
        [
          {
            "node": "Telegram Confirmar Modificaci√≥n",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Modificaci√≥n Whatsapp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-02-18T07:55:57.313Z",
  "id": "TLZSeoUIVCQ6R3SJ",
  "isArchived": false,
  "meta": null,
  "name": "ChatBotTest Telegram + Whatsapp (FUNCIONA)",
  "nodes": [
    {
      "parameters": {
        "content": "## Modificar contacto\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2112,
        3568
      ],
      "typeVersion": 1,
      "id": "13dc5384-ddd7-48e4-9db3-cb41369c5080",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "content": "## Guardar en postgre consulta\n"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2208,
        1296
      ],
      "typeVersion": 1,
      "id": "71a13c7b-c0b8-4383-b3d0-1c3c6f23e43e",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "content": "## Crear tarea y horas si no existe"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2112,
        3232
      ],
      "typeVersion": 1,
      "id": "877cf927-e86b-4f44-a8cd-36d6ed5f0e5b",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "content": "## Crear proyecto tarea horas si no existe"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2112,
        2768
      ],
      "typeVersion": 1,
      "id": "e1f29955-a2e6-49b8-83cf-225f743002c8",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "content": "## Bloque crear contacto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2112,
        2416
      ],
      "typeVersion": 1,
      "id": "a63c8892-7957-4d91-828f-d1478746452b",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "content": "## Bloque consultar contacto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2112,
        2048
      ],
      "typeVersion": 1,
      "id": "4ab14fd1-30b9-4192-8cfe-f12a944ab3e8",
      "name": "Sticky Note7"
    },
    {
      "parameters": {
        "content": "## Bloque consultar ventas"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2112,
        1712
      ],
      "typeVersion": 1,
      "id": "c51041d6-38e2-40ff-9e75-6370ccb35b99",
      "name": "Sticky Note6"
    },
    {
      "parameters": {
        "content": "## Bloque consultar producto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2112,
        1376
      ],
      "typeVersion": 1,
      "id": "1275a656-43cb-428b-aa01-9fe9c7b90e9b",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "content": "## Bloque crear tarea"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2096,
        1008
      ],
      "typeVersion": 1,
      "id": "738fcb78-3a5a-4c9a-854e-df31bf58bf3e",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## Bloque crear proyecto"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2096,
        640
      ],
      "typeVersion": 1,
      "id": "cef82732-7018-4894-9551-a40d10edbbdf",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "content": "## Bloque de registro de horas"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2096,
        208
      ],
      "typeVersion": 1,
      "id": "ea57b9d0-aede-4b2f-80a4-57dc47d508b8",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "content": "## Acceder a memoria si se introduce un \"si\"",
        "height": 200,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4336,
        1136
      ],
      "typeVersion": 1,
      "id": "a7831bd8-a568-4f53-8936-6a5acbcc3cc8",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Trasncriptor de audio a texto\n",
        "width": 1680,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4992,
        576
      ],
      "typeVersion": 1,
      "id": "d8b9b4e4-32e2-4b2c-af34-c03fece92e72",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS COMPLETOS PARA CREAR TAREA Y HORAS\n// OBTENER DATOS DESDE EL NODO CORRECTO\nlet datos = $json;\n\nconsole.log('üîß DATOS DESDE SWITCH ACCIONES (TAREA):', JSON.stringify(datos, null, 2));\n\n// IMPORTANTE: Obtener datos desde el nodo que S√ç tiene la informaci√≥n\nlet datosFromAI;\ntry {\n  datosFromAI = $('Preparar Datos AI Agent').first().json;\n  console.log('‚úÖ Datos obtenidos desde Preparar Datos AI Agent');\n  console.log('üì• Datos AI Agent:', JSON.stringify(datosFromAI, null, 2));\n  \n  // Si los datos llegan como array, extraer el primer elemento\n  if (Array.isArray(datosFromAI) && datosFromAI.length > 0) {\n    console.log('‚ö†Ô∏è Datos recibidos como array, extrayendo primer elemento');\n    datosFromAI = datosFromAI[0];\n  }\n  \n  datos = datosFromAI;\n} catch (e) {\n  console.error('‚ùå Error obteniendo datos desde Preparar Datos AI Agent:', e.message);\n  console.log('üìã Usando datos del Switch (pueden estar vac√≠os)');\n  \n  // Si los datos del Switch llegan como array, extraer el primer elemento\n  if (Array.isArray(datos) && datos.length > 0) {\n    console.log('‚ö†Ô∏è Datos del Switch como array, extrayendo primer elemento');\n    datos = datos[0];\n  }\n}\n\nconsole.log('üîß === PREPARAR DATOS COMPLETOS TAREA ===');\nconsole.log('üì• Datos recibidos:', JSON.stringify(datos, null, 2));\nconsole.log('üîç DEBUGGING COMPLETO:');\nconsole.log('   - Tipo de datos:', typeof datos);\nconsole.log('   - Es array?:', Array.isArray(datos));\nconsole.log('   - Claves principales:', Object.keys(datos || {}));\nconsole.log('   - datos.datos_pendientes existe?:', !!datos.datos_pendientes);\nif (datos.datos_pendientes) {\n  console.log('   - Contenido datos_pendientes:', JSON.stringify(datos.datos_pendientes, null, 2));\n  console.log('   - datos_pendientes.proyecto:', datos.datos_pendientes.proyecto);\n  console.log('   - datos_pendientes.proyecto_id:', datos.datos_pendientes.proyecto_id);\n  console.log('   - datos_pendientes.tarea:', datos.datos_pendientes.tarea);\n  console.log('   - datos_pendientes.horas:', datos.datos_pendientes.horas);\n}\n\n// Obtener datos del Router de Acciones anterior para asegurar informaci√≥n completa\nlet datosRouter = {};\ntry {\n  datosRouter = $('Router de Acciones FIXED').first().json;\n  console.log('‚úÖ Datos del Router obtenidos exitosamente');\n  console.log('üîç Datos del Router:', JSON.stringify(datosRouter, null, 2));\n} catch (e) {\n  console.log('‚ö†Ô∏è No se pudieron obtener datos del Router de Acciones:', e.message);\n  console.log('üìã Usando solo datos del Switch');\n}\n\n// COMBINAR Y VALIDAR DATOS DE M√öLTIPLES FUENTES\n// PRIORIDAD: datos_pendientes > datos directos > router\nconst datosCompletos = {\n  // Datos b√°sicos del usuario\n  chat_id: datos.chat_id || datosRouter.chat_id,\n  user_id: datos.user_id || datosRouter.user_id,\n  user_name: datos.user_name || datosRouter.user_name,\n  uid: datos.uid || datosRouter.uid,\n  mensaje_original: datos.mensaje_original || datosRouter.mensaje_original,\n  \n  // Acci√≥n espec√≠fica\n  accion: datos.accion || 'crear_tarea_y_horas',\n  \n  // Datos del proyecto/tarea/horas - PRIORIDAD A datos_pendientes\n  proyecto: datos.datos_pendientes?.proyecto || datos.proyecto || datosRouter.proyecto || datosRouter.datos_pendientes?.proyecto,\n  proyecto_id: datos.datos_pendientes?.proyecto_id || datos.proyecto_id || datosRouter.proyecto_id || datosRouter.datos_pendientes?.proyecto_id,\n  tarea: datos.datos_pendientes?.tarea || datos.tarea || datosRouter.tarea || datosRouter.datos_pendientes?.tarea,\n  horas: datos.datos_pendientes?.horas || datos.horas || datosRouter.horas || datosRouter.datos_pendientes?.horas,\n  descripcion: datos.datos_pendientes?.descripcion || datos.descripcion || datosRouter.descripcion || datosRouter.datos_pendientes?.descripcion,\n  \n  // Datos pendientes completos\n  datos_pendientes: {\n    proyecto: datos.datos_pendientes?.proyecto || datos.proyecto || datosRouter.proyecto || datosRouter.datos_pendientes?.proyecto,\n    proyecto_id: datos.datos_pendientes?.proyecto_id || datos.proyecto_id || datosRouter.proyecto_id || datosRouter.datos_pendientes?.proyecto_id,\n    tarea: datos.datos_pendientes?.tarea || datos.tarea || datosRouter.tarea || datosRouter.datos_pendientes?.tarea,\n    horas: datos.datos_pendientes?.horas || datos.horas || datosRouter.horas || datosRouter.datos_pendientes?.horas,\n    descripcion: datos.datos_pendientes?.descripcion || datos.descripcion || datosRouter.descripcion || datosRouter.datos_pendientes?.descripcion,\n    uid: datos.uid || datosRouter.uid,\n    tipo_creacion: 'solo_tarea_horas',\n    ...datos.datos_pendientes\n  }\n};\n\nconsole.log('üéØ DATOS COMPLETOS PREPARADOS (TAREA):');\nconsole.log('   üìã Proyecto:', datosCompletos.proyecto);\nconsole.log('   üÜî Proyecto ID:', datosCompletos.proyecto_id);\nconsole.log('   ‚úÖ Tarea:', datosCompletos.tarea);\nconsole.log('   ‚è∞ Horas:', datosCompletos.horas);\nconsole.log('   üìù Descripci√≥n:', datosCompletos.descripcion);\nconsole.log('   üîë UID:', datosCompletos.uid);\nconsole.log('   üí¨ Chat ID:', datosCompletos.chat_id);\nconsole.log('   üóÇÔ∏è Datos pendientes completos:', JSON.stringify(datosCompletos.datos_pendientes, null, 2));\n\n// VALIDACI√ìN FINAL\nif (!datosCompletos.tarea || !datosCompletos.horas || !datosCompletos.proyecto_id) {\n  console.error('‚ùå VALIDACI√ìN FALLIDA - Faltan datos cr√≠ticos despu√©s de preparaci√≥n:');\n  console.error('   - Proyecto:', datosCompletos.proyecto);\n  console.error('   - Proyecto ID:', datosCompletos.proyecto_id);\n  console.error('   - Tarea:', datosCompletos.tarea);\n  console.error('   - Horas:', datosCompletos.horas);\n  console.error('   - Datos originales Switch:', JSON.stringify(datos, null, 2));\n  console.error('   - Datos Router:', JSON.stringify(datosRouter, null, 2));\n  throw new Error(`Preparaci√≥n de datos fallida. Proyecto: ${datosCompletos.proyecto}, Proyecto ID: ${datosCompletos.proyecto_id}, Tarea: ${datosCompletos.tarea}, Horas: ${datosCompletos.horas}`);\n}\n\nconsole.log('‚úÖ VALIDACI√ìN EXITOSA - Todos los datos cr√≠ticos est√°n presentes');\nconsole.log('üöÄ Enviando datos completos al Flujo Crear Tarea y Horas');\n\nreturn datosCompletos;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2080,
        3360
      ],
      "id": "045963fb-6926-42ce-bd05-bfc942fd2064",
      "name": "Preparar Datos Completos Tarea"
    },
    {
      "parameters": {
        "chatId": "={{ $('Registrar Horas Directo').item.json.datos_registro.chat_id }}",
        "text": "=‚úÖ **¬°Parte de horas registrado exitosamente!**\n\nüìã **Detalles del registro:**\n‚Ä¢ **Proyecto:** {{ $('Registrar Horas Directo').item.json.datos_registro.proyecto }}\n‚Ä¢ **Tarea:** {{ $('Registrar Horas Directo').item.json.datos_registro.tarea }}\n‚Ä¢ **Horas:** {{ $('Registrar Horas Directo').item.json.datos_registro.horas }}\n‚Ä¢ **Descripci√≥n:** {{ $('Registrar Horas Directo').item.json.datos_registro.descripcion }}\n‚Ä¢ **Fecha:** {{ new Date().toLocaleDateString('es-ES') }}\n‚Ä¢ **ID del registro:** {{ $json.result }}\n\nüéâ **¬°Listo!** ¬øNecesitas registrar m√°s horas? üòä",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        0,
        0
      ],
      "id": "e2d95e3e-1b59-4d28-bbbf-6cfed046b2f0",
      "name": "Confirmar Horas Registradas",
      "webhookId": "be9ec93c-d206-40aa-802e-a92a2dd12fd6"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -400,
        112
      ],
      "id": "3e8325fa-4ac8-4046-a08b-289376da8381",
      "name": "HTTP Registrar Horas Directo"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO Y TAREA EXISTEN - Registrar horas directamente\nconst datosVerificacion = $('Preparar Buscar Tarea').item.json.datos_verificacion;\nconst proyectoData = $('Preparar Buscar Tarea').item.json.proyecto_data;\nconst tareaData = $json.result[0];\nconst uid = datosVerificacion.uid;\n\nconsole.log('‚úÖ PROYECTO Y TAREA EXISTEN - Registrando horas directamente');\nconsole.log('üìã Proyecto:', proyectoData.name, 'ID:', proyectoData.id);\nconsole.log('‚úÖ Tarea:', tareaData.name, 'ID:', tareaData.id);\nconsole.log('‚è∞ Horas a registrar:', datosVerificacion.horas);\n\n// Crear el registro de horas directamente\nconst registrarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosVerificacion.descripcion,\n        project_id: proyectoData.id,\n        task_id: tareaData.id,\n        unit_amount: datosVerificacion.horas,\n        date: new Date().toISOString().split('T')[0]\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: registrarHoras,\n  datos_registro: {\n    proyecto: proyectoData.name,\n    tarea: tareaData.name,\n    horas: datosVerificacion.horas,\n    descripcion: datosVerificacion.descripcion,\n    chat_id: datosVerificacion.chat_id,\n    uid: uid\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        112
      ],
      "id": "38f48b04-1312-4408-8c39-7febc23d147b",
      "name": "Registrar Horas Directo"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Tarea No Existe').item.json.chat_id }}",
        "text": "=‚úÖ **El proyecto \"{{ $('Guardar Memoria Tarea No Existe').item.json.proyecto }}\" existe.**\n‚ùå **Pero la tarea \"{{ $('Guardar Memoria Tarea No Existe').item.json.tarea }}\" no existe.**\n\nüìã **Parte de horas pendiente:**\n‚Ä¢ **Proyecto:** {{ $('Guardar Memoria Tarea No Existe').item.json.proyecto }} ‚úÖ\n‚Ä¢ **Tarea:** {{ $('Guardar Memoria Tarea No Existe').item.json.tarea }} ‚ùå\n‚Ä¢ **Horas:** {{ $('Guardar Memoria Tarea No Existe').item.json.horas }}\n‚Ä¢ **Descripci√≥n:** {{ $('Guardar Memoria Tarea No Existe').item.json.descripcion }}\n\nü§î **¬øQuieres que cree la tarea?**\n\nSi dices **\"s√≠\"**, crear√©:\n1Ô∏è‚É£ La tarea \"{{ $('Guardar Memoria Tarea No Existe').item.json.tarea }}\" en el proyecto existente\n2Ô∏è‚É£ El parte de horas autom√°ticamente\n\n**Responde:**\n‚Ä¢ **'s√≠'** para crear la tarea y registrar horas\n‚Ä¢ **'no'** para cancelar",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        128,
        352
      ],
      "id": "fa8897db-ce92-4160-98cc-f6ef95988698",
      "name": "Preguntar Crear Tarea Solamente",
      "webhookId": "2d35b2d3-073a-4cb6-9237-0da02dd331fc"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Marcos',\n  'crear_tarea_solamente',\n  `El proyecto \"${$json.proyecto}\" existe pero la tarea \"${$json.tarea}\" no existe. ¬øQuieres que cree la tarea?`,\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),\n  `Registro de horas en tarea inexistente: ${$json.tarea}`,\n  JSON.stringify($json.memoria_actualizada?.historial || []),\n  JSON.stringify([{\n    tipo: 'usuario',\n    contenido: `Registrar ${$json.horas}h en ${$json.proyecto}/${$json.tarea}`,\n    timestamp: new Date().toISOString()\n  },\n    {\n      tipo: 'bot',\n      contenido: `Tarea \"${$json.tarea}\" no existe en proyecto existente. Esperando confirmaci√≥n para crear.`,\n      timestamp: new Date().toISOString()\n    }\n  ])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -288,
        432
      ],
      "id": "d07121f9-869f-4e9b-ba8d-ae1d1f347e02",
      "name": "Guardar Memoria PostgreSQL Tarea No Existe"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO EXISTE, TAREA NO EXISTE - Guardar en memoria\nconst datosVerificacion = $('Preparar Buscar Tarea').item.json.datos_verificacion;\nconst proyectoData = $('Preparar Buscar Tarea').item.json.proyecto_data;\nconst chatId = datosVerificacion.chat_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconsole.log('‚úÖ PROYECTO EXISTE, ‚ùå TAREA NO EXISTE');\nconsole.log('üìã Proyecto:', proyectoData.name, 'ID:', proyectoData.id);\nconsole.log('‚ùå Tarea no encontrada:', datosVerificacion.tarea);\n\n// Guardar datos para crear solo tarea + horas\nmemoria.esperando_confirmacion = 'crear_tarea_solamente';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  proyecto: datosVerificacion.proyecto_nombre,\n  proyecto_id: datosVerificacion.proyecto_id,\n  tarea: datosVerificacion.tarea,\n  horas: datosVerificacion.horas,\n  descripcion: datosVerificacion.descripcion,\n  accion_original: 'registrar_horas',\n  tipo_creacion: 'solo_tarea_horas', // Solo crear tarea y horas\n  uid: datosVerificacion.uid\n};\n\n// Actualizar historial\nconst entradaHistorial = {\n  timestamp: new Date().toISOString(),\n  usuario: `Registrar ${datosVerificacion.horas}h en ${datosVerificacion.proyecto}/${datosVerificacion.tarea}`,\n  bot: `Tarea \"${datosVerificacion.tarea}\" no existe en proyecto existente`,\n  accion: 'tarea_no_existe_en_proyecto',\n  chat_id: chatId\n};\n\nif (!memoria.historial) memoria.historial = [];\nmemoria.historial.push(entradaHistorial);\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  chat_id: chatId,\n  proyecto: datosVerificacion.proyecto_nombre,\n  proyecto_id: datosVerificacion.proyecto_id,\n  tarea: datosVerificacion.tarea,\n  horas: datosVerificacion.horas,\n  descripcion: datosVerificacion.descripcion,\n  tipo_respuesta: 'tarea_no_existe',\n  memoria_actualizada: memoria\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        432
      ],
      "id": "b9ea886a-1d45-47d0-9dad-673a8896c2ee",
      "name": "Guardar Memoria Tarea No Existe"
    },
    {
      "parameters": {
        "chatId": "={{ $('Guardar Memoria Proyecto No Existe').item.json.chat_id }}",
        "text": "=‚ùå **El proyecto \"{{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\" no existe.**\n\nüìã **Parte de horas pendiente:**\n‚Ä¢ **Proyecto:** {{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\n‚Ä¢ **Tarea:** {{ $('Guardar Memoria Proyecto No Existe').item.json.tarea }}\n‚Ä¢ **Horas:** {{ $('Guardar Memoria Proyecto No Existe').item.json.horas }}\n‚Ä¢ **Descripci√≥n:** {{ $('Guardar Memoria Proyecto No Existe').item.json.descripcion }}\n\nü§î **¬øQuieres que cree el proyecto completo?**\n\nSi dices **\"s√≠\"**, crear√©:\n1Ô∏è‚É£ El proyecto \"{{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\"\n2Ô∏è‚É£ La tarea \"{{ $('Guardar Memoria Proyecto No Existe').item.json.tarea }}\"\n3Ô∏è‚É£ El parte de horas autom√°ticamente\n\n**Responde:**\n‚Ä¢ **'s√≠'** para crear todo\n‚Ä¢ **'no'** para cancelar",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -880,
        416
      ],
      "id": "7d2bba22-a21c-4269-b066-672f8e521c52",
      "name": "Preguntar Crear Proyecto Completo",
      "webhookId": "7582ee56-6fbc-4868-a00a-ea393e6676ec"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (chat_id, user_id, user_name, esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, mensaje_usuario, historial, historial_conversacion, created_at, updated_at) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, NOW(), NOW())",
        "options": {
          "queryReplacement": "={{ [\n  parseInt($json.chat_id) || 0,\n  parseInt($json.chat_id) || 0,\n  'Marcos',\n  'crear_proyecto_completo',\n  `‚ùå El proyecto \"${$json.proyecto}\" no existe. ¬øQuieres que cree el proyecto completo?`,\n  JSON.stringify($json.memoria_actualizada?.datos_pendientes || {}),\n  `Registro de horas en proyecto inexistente: ${$json.proyecto}`,\n  JSON.stringify($json.memoria_actualizada?.historial || []),\n  JSON.stringify([{\n    tipo: 'usuario',\n    contenido: `Registrar ${$json.horas}h en ${$json.proyecto}/${$json.tarea}`,\n    timestamp: new Date().toISOString()\n  },\n  {\n    tipo: 'bot',\n    contenido: `Proyecto \"${$json.proyecto}\" no existe. Esperando confirmaci√≥n para crear.`,\n    timestamp: new Date().toISOString()\n  }])\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -1248,
        448
      ],
      "id": "f2d75a29-070a-49a5-b68e-e8c50d71ba62",
      "name": "Guardar Memoria PostgreSQL Proyecto No Existe"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO NO EXISTE - Guardar en memoria y preguntar al usuario\nconst datosVerificacion = $('Verificar Proyecto y Tarea Horas').item.json.datos_verificacion;\nconst chatId = datosVerificacion.chat_id;\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\nconsole.log('‚ùå PROYECTO NO EXISTE - Guardando en memoria:', datosVerificacion.proyecto);\n\n// Guardar TODOS los datos del parte de horas en memoria\nmemoria.esperando_confirmacion = 'crear_proyecto_completo';\nmemoria.esperando_respuesta = true;\nmemoria.datos_pendientes = {\n  proyecto: datosVerificacion.proyecto,\n  tarea: datosVerificacion.tarea,\n  horas: datosVerificacion.horas,\n  descripcion: datosVerificacion.descripcion,\n  accion_original: 'registrar_horas',\n  tipo_creacion: 'proyecto_tarea_horas', // Indica que hay que crear todo\n  uid: datosVerificacion.uid\n};\n\n// Actualizar historial\nconst entradaHistorial = {\n  timestamp: new Date().toISOString(),\n  usuario: `Registrar ${datosVerificacion.horas}h en ${datosVerificacion.proyecto}/${datosVerificacion.tarea}`,\n  bot: `Proyecto \"${datosVerificacion.proyecto}\" no existe`,\n  accion: 'proyecto_no_existe_para_horas',\n  chat_id: chatId\n};\n\nif (!memoria.historial) memoria.historial = [];\nmemoria.historial.push(entradaHistorial);\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  chat_id: chatId,\n  proyecto: datosVerificacion.proyecto,\n  tarea: datosVerificacion.tarea,\n  horas: datosVerificacion.horas,\n  descripcion: datosVerificacion.descripcion,\n  tipo_respuesta: 'proyecto_no_existe',\n  memoria_actualizada: memoria\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        448
      ],
      "id": "f990cade-52e6-4bfe-a591-b552d59b43af",
      "name": "Guardar Memoria Proyecto No Existe"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload_tarea }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1072,
        256
      ],
      "id": "1ec8f024-5a49-44c0-853f-0b8b829e4001",
      "name": "HTTP Buscar Tarea"
    },
    {
      "parameters": {
        "jsCode": "// PROYECTO EXISTE - Ahora verificar si la tarea tambi√©n existe\nconst datosVerificacion = $('Verificar Proyecto y Tarea Horas').item.json.datos_verificacion;\nconst proyectoData = $json.result[0];\nconst uid = datosVerificacion.uid;\n\nconsole.log('‚úÖ PROYECTO EXISTE - Verificando tarea:', datosVerificacion.tarea);\nconsole.log('üìã Proyecto encontrado:', proyectoData.name, 'ID:', proyectoData.id);\n\n// Buscar tarea en el proyecto\nconst buscarTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"search_read\",\n      [\n        [\n          [\"name\", \"ilike\", datosVerificacion.tarea],\n          [\"project_id\", \"=\", proyectoData.id]\n        ],\n        [\"id\", \"name\", \"project_id\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload_tarea: buscarTarea,\n  datos_verificacion: {\n    ...datosVerificacion,\n    proyecto_id: proyectoData.id,\n    proyecto_nombre: proyectoData.name,\n    paso: 'verificar_tarea'\n  },\n  proyecto_data: proyectoData\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1440,
        288
      ],
      "id": "0404664c-1300-48c4-a952-e6da79e7ccbe",
      "name": "Preparar Buscar Tarea"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload_proyecto }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1840,
        368
      ],
      "id": "4df15d9f-541b-4b7e-aaf4-5bdfce79c0f9",
      "name": "HTTP Buscar Proyecto"
    },
    {
      "parameters": {
        "jsCode": "// VERIFICACI√ìN INTELIGENTE PARA REGISTRO DE HORAS\n// Este nodo verifica si el proyecto Y la tarea existen para determinar qu√© crear\n\nconst datosHoras = $json;\nconst uid = datosHoras.uid;\nconst nombreProyecto = datosHoras.proyecto;\nconst nombreTarea = datosHoras.tarea;\nconst horas = datosHoras.horas;\nconst descripcion = datosHoras.descripcion;\nconst chatId = datosHoras.chat_id;\n\nconsole.log('üîç === VERIFICACI√ìN INTELIGENTE PROYECTO Y TAREA ===');\nconsole.log('üìã Proyecto:', nombreProyecto);\nconsole.log('‚úÖ Tarea:', nombreTarea);\nconsole.log('‚è∞ Horas:', horas);\nconsole.log('üìù Descripci√≥n:', descripcion);\n\n// PASO 1: Buscar proyecto\nconst buscarProyecto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"project.project\",\n      \"search_read\",\n      [\n        [[\"name\", \"ilike\", nombreProyecto]],\n        [\"id\", \"name\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload_proyecto: buscarProyecto,\n  datos_verificacion: {\n    proyecto: nombreProyecto,\n    tarea: nombreTarea,\n    horas: horas,\n    descripcion: descripcion,\n    chat_id: chatId,\n    uid: uid,\n    paso: 'verificar_proyecto'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2032,
        368
      ],
      "id": "827a7173-d5e3-42aa-8fbd-26608b830485",
      "name": "Verificar Proyecto y Tarea Horas"
    },
    {
      "parameters": {
        "jsCode": "// Log para datos inv√°lidos que no se pueden guardar en PostgreSQL\nconsole.log('‚ùå DATOS INV√ÅLIDOS - No se guard√≥ en PostgreSQL:');\nconsole.log('üìÑ Datos recibidos:', JSON.stringify($json, null, 2));\nconsole.log('üö´ Raz√≥n:', $json.razon || 'No especificada');\nconsole.log('üìä Chat ID original:', $json.chat_id_original);\nconsole.log('üî¢ Chat ID num√©rico:', $json.chat_id_numerico);\n\nreturn { \n  mensaje: 'Datos no guardados en PostgreSQL por ser inv√°lidos',\n  detalles: $json \n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2336,
        1648
      ],
      "id": "402de9e7-d30d-4165-9ffe-58129dacfa99",
      "name": "Log Datos Inv√°lidos"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.resultado !== 'skipped' }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2032,
        1488
      ],
      "id": "a20733b1-a7b7-49a9-954f-551c1ae2ffbb",
      "name": "¬øDatos V√°lidos para PostgreSQL?"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO n8n (\n  chat_id, user_id, user_name, proyecto_anterior, tarea_anterior,\n  ultima_accion, esperando_confirmacion, esperando_respuesta,\n  ultimo_mensaje_bot, mensaje_usuario, datos_pendientes, historial, historial_conversacion,\n  created_at, updated_at\n) VALUES (\n  $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, NOW(), NOW()\n);",
        "options": {
          "queryReplacement": "={{ [\n  $json.chat_id,\n  $json.user_id,\n  $json.user_name,\n  $json.proyecto_anterior,\n  $json.tarea_anterior,\n  $json.ultima_accion,\n  $json.esperando_confirmacion,\n  $json.esperando_respuesta,\n  $json.ultimo_mensaje_bot,\n  $json.mensaje_usuario,\n  $json.datos_pendientes,\n  $json.historial,\n  $json.historial_conversacion\n] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        2480,
        1440
      ],
      "id": "33a43cfe-fe1d-4c57-aa51-fde540faef85",
      "name": "Insertar en PostgreSQL"
    },
    {
      "parameters": {
        "jsCode": "// NODO UNIFICADOR - PREPARAR DATOS POSTGRESQL CON B√öSQUEDA ACTIVA\nconst timestampActual = new Date().toISOString();\nconst respuestaBot = $json.text || $json.respuesta_usuario || 'Respuesta procesada';\n\nconsole.log('üîÑ === PREPARAR DATOS POSTGRESQL - B√öSQUEDA ACTIVA ===');\nconsole.log('üì• Datos recibidos directamente:', JSON.stringify($json, null, 2));\n\n// FUNCI√ìN PARA BUSCAR DATOS DEL USUARIO EN NODOS ANTERIORES\nfunction buscarDatosUsuario() {\n  // Lista de nodos donde pueden estar los datos del usuario (en orden de prioridad)\n  const nodosABuscar = [\n    'Router de Acciones FIXED',\n    'Procesar Respuesta', \n    'Preparar Datos AI Agent',\n    'Obtener Chat ID',\n    'Extraer Datos'\n  ];\n  \n  for (const nombreNodo of nodosABuscar) {\n    try {\n      const datos = $(nombreNodo).first().json;\n      if (datos && datos.chat_id && datos.chat_id !== 'unknown') {\n        console.log(`‚úÖ Datos encontrados en: ${nombreNodo}`);\n        return {\n          chat_id: datos.chat_id,\n          user_id: datos.user_id || datos.chat_id,\n          user_name: datos.user_name || 'Usuario',\n          mensaje_original: datos.mensaje_usuario || datos.mensaje_original || 'mensaje no disponible',\n          fuente: nombreNodo\n        };\n      }\n    } catch (e) {\n      console.log(`‚ö†Ô∏è No se pudo acceder a ${nombreNodo}:`, e.message);\n    }\n  }\n  \n  return null;\n}\n\n// INTENTAR OBTENER DATOS DEL USUARIO\nlet datosUsuario = {\n  chat_id: $json.chat_id,\n  user_id: $json.user_id,\n  user_name: $json.user_name,\n  mensaje_original: $json.mensaje_usuario || $json.mensaje_original\n};\n\n// Si no tenemos chat_id v√°lido, buscar en nodos anteriores\nif (!datosUsuario.chat_id || datosUsuario.chat_id === 'unknown') {\n  console.log('üîç Chat ID no v√°lido, buscando en nodos anteriores...');\n  const datosBuscados = buscarDatosUsuario();\n  \n  if (datosBuscados) {\n    datosUsuario = datosBuscados;\n    console.log(`‚úÖ Datos recuperados desde: ${datosBuscados.fuente}`);\n  } else {\n    console.log('‚ùå No se encontraron datos v√°lidos del usuario');\n    datosUsuario = {\n      chat_id: 0,\n      user_id: 0,\n      user_name: 'unknown',\n      mensaje_original: 'mensaje no disponible',\n      fuente: 'fallback'\n    };\n  }\n}\n\nconsole.log('üë§ DATOS FINALES DEL USUARIO:', {\n  chat_id: datosUsuario.chat_id,\n  user_id: datosUsuario.user_id,\n  user_name: datosUsuario.user_name,\n  fuente: datosUsuario.fuente || 'directo'\n});\n\n// CREAR REGISTRO PARA POSTGRESQL\nconst registroPostgreSQL = {\n  chat_id: parseInt(datosUsuario.chat_id) || 0,\n  user_id: parseInt(datosUsuario.user_id) || 0,\n  user_name: datosUsuario.user_name === 'unknown' ? null : datosUsuario.user_name,\n  ultima_accion: 'conversar',\n  ultimo_mensaje_bot: respuestaBot,\n  mensaje_usuario: datosUsuario.mensaje_original === 'mensaje no disponible' ? null : datosUsuario.mensaje_original,\n  historial: JSON.stringify([{\n    timestamp: timestampActual,\n    usuario: datosUsuario.mensaje_original,\n    bot: respuestaBot,\n    accion: 'conversar'\n  }]),\n  historial_conversacion: JSON.stringify([{\n    timestamp: timestampActual,\n    contenido: datosUsuario.mensaje_original,\n    tipo: 'usuario'\n  }, {\n    timestamp: timestampActual,\n    contenido: respuestaBot,\n    tipo: 'bot'\n  }])\n};\n\nconsole.log('üì§ REGISTRO FINAL PARA POSTGRESQL:', {\n  chat_id: registroPostgreSQL.chat_id,\n  user_id: registroPostgreSQL.user_id,\n  user_name: registroPostgreSQL.user_name\n});\n\nreturn [registroPostgreSQL];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        1696
      ],
      "id": "e4c7ee91-dac8-4266-8a2c-71582f1124e1",
      "name": "Preparar Datos PostgreSQL"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1072,
        2448
      ],
      "id": "ed7c8b58-0fc5-432d-abff-410db5c62f4e",
      "name": "Enviar Respuesta Contacto Creado",
      "webhookId": "73e11549-5f8d-43de-9cff-41a48fd090d4"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de contacto creado para Telegram\nconst contactoCreado = $json.result;\nconst datosContacto = $('Preparar Crear Contacto').item.json.datos_contacto;\nlet texto = '';\n\nif (!contactoCreado) {\n  texto = '‚ùå Error al crear el contacto. Por favor, intenta de nuevo.';\n} else {\n  texto = `‚úÖ **¬°Contacto creado exitosamente!**\\n\\n`;\n  texto += `üë§ **Nombre:** ${datosContacto.nombre}\\n`;\n  texto += `üÜî **ID en Odoo:** ${contactoCreado}\\n`;\n  \n  if (datosContacto.email && datosContacto.email.trim() !== '') {\n    texto += `üìß **Email:** ${datosContacto.email}\\n`;\n  }\n  \n  if (datosContacto.telefono && datosContacto.telefono.trim() !== '') {\n    texto += `üì± **Tel√©fono:** ${datosContacto.telefono}\\n`;\n  }\n  \n  if (datosContacto.es_empresa) {\n    texto += `üè¢ **Tipo:** Empresa\\n`;\n  } else {\n    texto += `üë§ **Tipo:** Persona\\n`;\n  }\n  \n  texto += `\\n¬°Ya puedes usar este contacto en Odoo! üéâ`;\n}\n\nreturn{\n  texto,\n  chat_id: datosContacto.chat_id || $('Preparar Crear Contacto').item.json.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1648,
        2576
      ],
      "id": "2d0cf7e5-8cc2-43f9-ba84-9e67051a3763",
      "name": "Formatear Respuesta Contacto Creado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1856,
        2576
      ],
      "id": "68bf9363-12e9-4fdc-b039-8e27f22aa486",
      "name": "HTTP Crear Contacto"
    },
    {
      "parameters": {
        "jsCode": "// Preparar creaci√≥n de contacto en Odoo\nconst datosAI = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreContacto = datosAI.nombre;\nconst emailContacto = datosAI.email || '';\nconst telefonoContacto = datosAI.telefono || '';\nconst empresaContacto = datosAI.empresa || '';\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticaci√≥n');\n}\n\n// Validar que tenemos nombre del contacto\nif (!nombreContacto) {\n  throw new Error('No se encontr√≥ el nombre del contacto');\n}\n\n// Preparar datos del contacto\nconst datosContacto = {\n  name: nombreContacto,\n  is_company: false,\n  customer_rank: 1,  // Marcar como cliente\n  supplier_rank: 0   // No es proveedor por defecto\n};\n\n// A√±adir email si est√° disponible\nif (emailContacto && emailContacto.trim() !== '') {\n  datosContacto.email = emailContacto.trim();\n}\n\n// A√±adir tel√©fono si est√° disponible\nif (telefonoContacto && telefonoContacto.trim() !== '') {\n  datosContacto.phone = telefonoContacto.trim();\n}\n\n// Si se especifica empresa, buscarla primero\nlet esEmpresa = false;\nif (empresaContacto && empresaContacto.trim() !== '') {\n  esEmpresa = true;\n  datosContacto.is_company = true;\n  datosContacto.name = empresaContacto.trim();\n}\n\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\", // DB\n      uid, \n      \"admin\", \n      \"res.partner\", \n      \"create\",\n      [datosContacto]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  datos_contacto: {\n    nombre: nombreContacto,\n    email: emailContacto,\n    telefono: telefonoContacto,\n    empresa: empresaContacto,\n    es_empresa: esEmpresa\n  },\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2048,
        2576
      ],
      "id": "ace77847-ebe0-4cce-9369-70cbcf06e601",
      "name": "Preparar Crear Contacto"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ 'telegram_' + ($input.all()[0].json.chat_id || $json.chat_id || 'default') }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -3728,
        1680
      ],
      "id": "c6a3cf19-826e-449d-9f85-b02482e5a5f9",
      "name": "Postgres Chat Memory"
    },
    {
      "parameters": {
        "jsCode": "// Combinar datos de transcripci√≥n para que lleguen correctamente al AI Agent\nconst datosTranscripcion = $('Procesar Transcripci√≥n').item.json;\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('üîÑ Combinando datos para AI Agent:');\nconsole.log('üìÑ Datos originales:', JSON.stringify(datosOriginales, null, 2));\nconsole.log('üé§ Datos transcripci√≥n:', JSON.stringify(datosTranscripcion, null, 2));\n\n// Usar los datos de transcripci√≥n que ya tienen el mensaje_usuario actualizado\nconst datosFinales = {\n  ...datosTranscripcion,\n  // Asegurar que tenemos todos los campos necesarios\n  chat_id: datosTranscripcion.chat_id || datosOriginales.chat_id,\n  user_id: datosTranscripcion.user_id || datosOriginales.user_id,\n  user_name: datosTranscripcion.user_name || datosOriginales.user_name,\n  timestamp: datosTranscripcion.timestamp || datosOriginales.timestamp,\n  es_audio: true,\n  audio_transcrito: true,\n  file_id: datosTranscripcion.file_id || datosOriginales.file_id\n};\n\nconsole.log('‚úÖ Datos finales para AI Agent:', JSON.stringify(datosFinales, null, 2));\nconsole.log('üí¨ Mensaje que recibir√° AI Agent:', datosFinales.mensaje_usuario);\n\nreturn datosFinales;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3248,
        640
      ],
      "id": "4445f3d5-26e0-445b-bd17-67a36790993d",
      "name": "Actualizar Datos Transcripci√≥n"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=üé§ **Audio transcrito exitosamente:**\n\n\"{{ $json.transcripcion_original }}\"\n\n‚úÖ Procesando tu solicitud...",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3440,
        640
      ],
      "id": "8a2ac6d6-4754-4a62-9fa9-497d6e3ff64f",
      "name": "Confirmar Transcripci√≥n",
      "webhookId": "336b8018-098e-4911-9648-19bde38f9764"
    },
    {
      "parameters": {
        "jsCode": "// Procesar transcripci√≥n de AssemblyAI y combinar con datos originales\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('üìÑ Respuesta completa de AssemblyAI:', JSON.stringify($json, null, 2));\n\n// AssemblyAI devuelve la transcripci√≥n en el campo 'text'\nlet transcripcion = '';\n\n// Verificar si el proceso se complet√≥ exitosamente\nif ($json.status === 'completed' && $json.text) {\n  transcripcion = $json.text;\n} else if ($json.status === 'error') {\n  transcripcion = '[Error en transcripci√≥n: ' + ($json.error || 'Error desconocido') + ']';\n  console.error('‚ùå Error en AssemblyAI:', $json.error);\n} else if ($json.status === 'processing') {\n  transcripcion = '[Transcripci√≥n a√∫n en proceso, espera un momento m√°s]';\n  console.log('‚è≥ AssemblyAI a√∫n est√° procesando');\n} else if ($json.status === 'queued') {\n  transcripcion = '[Transcripci√≥n en cola, espera un momento]';\n  console.log('‚è≥ AssemblyAI en cola');\n} else {\n  // Fallback: intentar obtener texto de otras posibles ubicaciones\n  transcripcion = $json.text || $json.transcript || '[Error: no se pudo obtener transcripci√≥n]';\n}\n\n// Limpiar la transcripci√≥n\ntranscripcion = String(transcripcion).trim();\n\nif (!transcripcion || transcripcion === '' || transcripcion === 'undefined') {\n  transcripcion = '[Error: transcripci√≥n vac√≠a]';\n  console.error('‚ùå Error: No se pudo obtener transcripci√≥n v√°lida');\n  console.error('üìÑ Estado:', $json.status);\n  console.error('üìÑ Datos recibidos:', JSON.stringify($json, null, 2));\n}\n\nconsole.log('üé§ Transcripci√≥n obtenida de AssemblyAI (ES):', transcripcion);\nconsole.log('üìä Estado AssemblyAI:', $json.status);\nconsole.log('üåç Idioma detectado:', $json.language_code);\nconsole.log('üéØ Confianza:', $json.confidence);\n\n// Actualizar el mensaje usuario con la transcripci√≥n\nreturn {\n  ...datosOriginales,\n  mensaje_usuario: transcripcion,\n  es_audio: true,\n  audio_transcrito: true,\n  transcripcion_original: transcripcion,\n  assemblyai_response: $json,\n  transcriptor: 'assemblyai',\n  estado_transcripcion: $json.status,\n  confidence: $json.confidence,\n  audio_duration: $json.audio_duration\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3648,
        640
      ],
      "id": "697fdc14-586f-4b61-9aa9-0a1aa69fe693",
      "name": "Procesar Transcripci√≥n"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4528,
        640
      ],
      "id": "8b870835-8276-4378-98d9-d9a780b9c14e",
      "name": "Descargar Audio",
      "webhookId": "67ba68d6-5737-4201-b4f0-6efef55ec7a9"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos del archivo de voz para descarga via Telegram\nconst datosArchivo = $json;\nconst datosOriginales = $('Extraer Datos').item.json;\n\nconsole.log('üìÑ Datos del archivo obtenidos:', JSON.stringify(datosArchivo, null, 2));\nconsole.log('üìÑ Datos originales:', JSON.stringify(datosOriginales, null, 2));\n\n// Obtener file_id desde los datos originales (es lo que necesita el nodo Telegram)\nlet fileId = datosOriginales.file_id;\n\n// Tambi√©n intentar obtener file_path si est√° disponible para referencia\nlet filePath = null;\nif (datosArchivo.file_path) {\n  filePath = datosArchivo.file_path;\n} else if (datosArchivo.result && datosArchivo.result.file_path) {\n  filePath = datosArchivo.result.file_path;\n} else if (datosArchivo.body && datosArchivo.body.result && datosArchivo.body.result.file_path) {\n  filePath = datosArchivo.body.result.file_path;\n}\n\nif (!fileId) {\n  console.error('‚ùå No se encontr√≥ file_id. Estructura completa:', JSON.stringify(datosArchivo, null, 2));\n  throw new Error('No se obtuvo file_id del archivo de voz. Revisa la estructura de datos en los logs.');\n}\n\nconsole.log('‚úÖ file_id obtenido:', fileId);\nif (filePath) {\n  console.log('üìÅ file_path obtenido:', filePath);\n}\n\n// Usar file_id que es lo que requiere el nodo Telegram\nreturn {\n  ...datosArchivo,\n  ...datosOriginales,\n  file_id: fileId,\n  file_path: filePath,\n  voice_file_ready: true,\n  processing_method: 'telegram_file_id',\n  // Informaci√≥n para debug\n  download_info: {\n    file_id: fileId,\n    file_path: filePath,\n    method: 'telegram_get_file'\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4752,
        640
      ],
      "id": "7a65dd83-f4d9-4e68-9f3b-db4aa02c000d",
      "name": "Preparar Descarga"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4992,
        640
      ],
      "id": "0f3dca8c-c516-4a07-981b-0947245160c8",
      "name": "Obtener Archivo de Voz",
      "webhookId": "de0f675c-7d73-4a72-8d32-6ed74016f1ff"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.es_audio }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -5248,
        1200
      ],
      "id": "6c597600-79cc-43b1-af56-15bba1b7cfbf",
      "name": "¬øEs Audio?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=‚úÖ **¬°Tarea y horas registradas exitosamente!**\n\nüìã **Proyecto existente:** {{ $json.resumen_creado.proyecto }} (ID: {{ $json.resumen_creado.proyecto_id }})\n‚úÖ **Tarea creada:** {{ $json.resumen_creado.tarea }} (ID: {{ $json.resumen_creado.tarea_id }})\n‚è∞ **Horas registradas:** {{ $json.resumen_creado.horas }}h (ID: {{ $json.resumen_creado.horas_id }})\nüìÖ **Fecha:** {{ $json.resumen_creado.fecha }}\nüìù **Descripci√≥n:** {{ $json.resumen_creado.descripcion }}\n\nüéØ Tarea y horas a√±adidas al proyecto exitosamente.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -560,
        3232
      ],
      "id": "6391963c-80dd-4e10-94dc-ce6443952182",
      "name": "Confirmar Tarea Horas",
      "webhookId": "08da628b-b430-46ed-94a1-5d1a5b228077"
    },
    {
      "parameters": {
        "jsCode": "// Limpiar memoria despu√©s del flujo tarea + horas exitoso\nconst responseHoras = $json;\nconst datosFlujo = $('Preparar Horas Tarea Solo').item.json.datos_flujo;\n\nconsole.log('üßπ === LIMPIAR MEMORIA TAREA + HORAS ===');\nconsole.log('‚úÖ Respuesta horas:', JSON.stringify(responseHoras, null, 2));\nconsole.log('üîÑ Datos flujo final:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID del registro de horas\nlet horasId;\nif (responseHoras.result) {\n  horasId = responseHoras.result;\n} else if (responseHoras.body && responseHoras.body.result) {\n  horasId = responseHoras.body.result;\n} else {\n  console.error('‚ùå No se encontr√≥ ID del registro de horas:', responseHoras);\n  throw new Error('No se pudo obtener el ID del registro de horas');\n}\n\nconsole.log('üÜî Horas ID obtenido:', horasId);\n\n// Preparar datos para limpiar memoria y confirmar √©xito\nreturn {\n  chat_id: datosFlujo.chat_id,\n  uid: datosFlujo.uid,\n  flujo_tarea_horas_exitoso: true,\n  limpieza_memoria: {\n    tipo_creacion: null,\n    esperando_confirmacion: false,\n    datos_pendientes: {},\n    ultimo_mensaje_bot: 'Flujo tarea + horas exitoso'\n  },\n  resumen_creado: {\n    proyecto: datosFlujo.proyecto,\n    proyecto_id: datosFlujo.proyecto_id,\n    tarea: datosFlujo.tarea,\n    tarea_id: datosFlujo.tarea_id,\n    horas: datosFlujo.horas,\n    horas_id: horasId,\n    descripcion: datosFlujo.descripcion,\n    fecha: datosFlujo.fecha\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -992,
        3328
      ],
      "id": "a9b207f9-8fed-4c32-aea1-26939fc3e108",
      "name": "Limpiar Memoria Tarea Horas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n-main-21528542.dev.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1216,
        3328
      ],
      "id": "44a8a2ce-0c51-4ab7-8038-acf84505b460",
      "name": "HTTP Registrar Horas Tarea Solo"
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta de tarea creada y preparar registro de horas (proyecto existente)\nconst responseTarea = $json;\nconst datosFlujo = $('Flujo Crear Tarea y Horas').item.json.datos_flujo;\n\nconsole.log('‚úÖ === PREPARAR HORAS - TAREA SOLO ===');\nconsole.log('üìã Respuesta tarea:', JSON.stringify(responseTarea, null, 2));\nconsole.log('üîÑ Datos flujo:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID de la tarea creada\nlet tareaId;\nif (responseTarea.result) {\n  tareaId = responseTarea.result;\n} else if (responseTarea.body && responseTarea.body.result) {\n  tareaId = responseTarea.body.result;\n} else {\n  console.error('‚ùå No se encontr√≥ ID de la tarea en respuesta:', responseTarea);\n  throw new Error('No se pudo obtener el ID de la tarea creada');\n}\n\nconsole.log('üÜî Tarea ID obtenido:', tareaId);\n\n// Obtener fecha actual\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\n// Preparar registro de horas\nconst registrarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      datosFlujo.uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosFlujo.descripcion || `Registro de ${datosFlujo.horas} horas en ${datosFlujo.tarea}`,\n        project_id: datosFlujo.proyecto_id,\n        task_id: tareaId,\n        unit_amount: parseFloat(datosFlujo.horas),\n        date: fechaHoy,\n        user_id: datosFlujo.uid\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: registrarHoras,\n  datos_flujo: {\n    ...datosFlujo,\n    paso: 'registrar_horas_tarea_solo',\n    tarea_id: tareaId,\n    tarea_creada: true,\n    fecha: fechaHoy\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1408,
        3328
      ],
      "id": "12e3260c-f0d3-402e-bd4e-e3c6372a8e87",
      "name": "Preparar Horas Tarea Solo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n-main-21528542.dev.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1632,
        3328
      ],
      "id": "cf7532f2-de3c-4c33-adbf-623db9347ddc",
      "name": "HTTP Crear Tarea Solo"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "=üéâ **¬°Flujo completo exitoso!**\n\n‚úÖ **Proyecto creado:** {{ $json.resumen_creado.proyecto }} (ID: {{ $json.resumen_creado.proyecto_id }})\n‚úÖ **Tarea creada:** {{ $json.resumen_creado.tarea }} (ID: {{ $json.resumen_creado.tarea_id }})\n‚úÖ **Horas registradas:** {{ $json.resumen_creado.horas }}h (ID: {{ $json.resumen_creado.horas_id }})\nüìÖ **Fecha:** {{ $json.resumen_creado.fecha }}\nüìù **Descripci√≥n:** {{ $json.resumen_creado.descripcion }}\n\nüöÄ Todo ha sido creado y registrado exitosamente en Odoo.",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -240,
        2768
      ],
      "id": "2ecd882f-958c-4514-a7fc-0fd6262f4bfd",
      "name": "Confirmar Flujo Completo",
      "webhookId": "930536c1-0f1f-44b2-bec0-a32d0a7318ce"
    },
    {
      "parameters": {
        "jsCode": "// Limpiar memoria despu√©s del flujo completo exitoso\nconst responseHoras = $json;\nconst datosFlujo = $('Preparar Registrar Horas Paso3').item.json.datos_flujo;\n\nconsole.log('üßπ === LIMPIAR MEMORIA FLUJO COMPLETO ===');\nconsole.log('‚úÖ Respuesta horas:', JSON.stringify(responseHoras, null, 2));\nconsole.log('üîÑ Datos flujo final:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID del registro de horas\nlet horasId;\nif (responseHoras.result) {\n  horasId = responseHoras.result;\n} else if (responseHoras.body && responseHoras.body.result) {\n  horasId = responseHoras.body.result;\n} else {\n  console.error('‚ùå No se encontr√≥ ID del registro de horas:', responseHoras);\n  throw new Error('No se pudo obtener el ID del registro de horas');\n}\n\nconsole.log('üÜî Horas ID obtenido:', horasId);\n\n// Preparar datos para limpiar memoria y confirmar √©xito\nreturn {\n  chat_id: datosFlujo.chat_id,\n  uid: datosFlujo.uid,\n  flujo_completo_exitoso: true,\n  limpieza_memoria: {\n    tipo_creacion: null,\n    esperando_confirmacion: false,\n    datos_pendientes: {},\n    ultimo_mensaje_bot: 'Flujo completo exitoso'\n  },\n  resumen_creado: {\n    proyecto: datosFlujo.proyecto,\n    proyecto_id: datosFlujo.proyecto_id,\n    tarea: datosFlujo.tarea,\n    tarea_id: datosFlujo.tarea_id,\n    horas: datosFlujo.horas,\n    horas_id: horasId,\n    descripcion: datosFlujo.descripcion,\n    fecha: datosFlujo.fecha\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -672,
        2928
      ],
      "id": "4864efde-8a4b-40e1-a2ed-ff030a46b74c",
      "name": "Limpiar Memoria Flujo Completo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n-main-21528542.dev.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -880,
        2928
      ],
      "id": "48e32374-183a-46fb-b4d6-856012471c16",
      "name": "HTTP Registrar Horas Paso3"
    },
    {
      "parameters": {
        "jsCode": "// PASO 3: Procesar respuesta de la tarea creada y preparar registro de horas\nconst responseTarea = $json;\nconst datosFlujo = $('Preparar Crear Tarea Paso2').item.json.datos_flujo;\n\nconsole.log('‚úÖ === PASO 3: PROCESAR TAREA CREADA ===');\nconsole.log('üìã Respuesta tarea:', JSON.stringify(responseTarea, null, 2));\nconsole.log('üîÑ Datos flujo:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID de la tarea creada\nlet tareaId;\nif (responseTarea.result) {\n  tareaId = responseTarea.result;\n} else if (responseTarea.body && responseTarea.body.result) {\n  tareaId = responseTarea.body.result;\n} else {\n  console.error('‚ùå No se encontr√≥ ID de la tarea en respuesta:', responseTarea);\n  throw new Error('No se pudo obtener el ID de la tarea creada');\n}\n\nconsole.log('üÜî Tarea ID obtenido:', tareaId);\n\n// Obtener fecha actual\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\n// Preparar registro de horas\nconst registrarHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      datosFlujo.uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosFlujo.descripcion || `Registro de ${datosFlujo.horas} horas en ${datosFlujo.tarea}`,\n        project_id: datosFlujo.proyecto_id,\n        task_id: tareaId,\n        unit_amount: parseFloat(datosFlujo.horas),\n        date: fechaHoy,\n        user_id: datosFlujo.uid\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: registrarHoras,\n  datos_flujo: {\n    ...datosFlujo,\n    paso: 'registrar_horas',\n    tarea_id: tareaId,\n    tarea_creada: true,\n    fecha: fechaHoy\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1072,
        2928
      ],
      "id": "b502a61f-936d-4111-875a-5039f8478223",
      "name": "Preparar Registrar Horas Paso3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n-main-21528542.dev.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1280,
        2928
      ],
      "id": "2989ab51-94b7-4ac7-a0a1-e299a0c14067",
      "name": "HTTP Crear Tarea Paso2"
    },
    {
      "parameters": {
        "jsCode": "// PASO 2: Procesar respuesta del proyecto creado y preparar creaci√≥n de tarea\nconst responseProyecto = $json;\nconst datosFlujo = $('Flujo Crear Proyecto Tarea Horas').item.json.datos_flujo;\n\nconsole.log('‚úÖ === PASO 2: PROCESAR PROYECTO CREADO ===');\nconsole.log('üìã Respuesta proyecto:', JSON.stringify(responseProyecto, null, 2));\nconsole.log('üîÑ Datos flujo:', JSON.stringify(datosFlujo, null, 2));\n\n// Extraer ID del proyecto creado\nlet proyectoId;\nif (responseProyecto.result) {\n  proyectoId = responseProyecto.result;\n} else if (responseProyecto.body && responseProyecto.body.result) {\n  proyectoId = responseProyecto.body.result;\n} else {\n  console.error('‚ùå No se encontr√≥ ID del proyecto en respuesta:', responseProyecto);\n  throw new Error('No se pudo obtener el ID del proyecto creado');\n}\n\nconsole.log('üÜî Proyecto ID obtenido:', proyectoId);\n\n// Preparar creaci√≥n de tarea\nconst crearTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      datosFlujo.uid,\n      \"admin\",\n      \"project.task\",\n      \"create\",\n      [{\n        name: datosFlujo.tarea,\n        project_id: proyectoId,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearTarea,\n  datos_flujo: {\n    ...datosFlujo,\n    paso: 'crear_tarea',\n    proyecto_id: proyectoId,\n    proyecto_creado: true\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        2928
      ],
      "id": "70fc43ae-599c-4526-8fd8-50b62a2b307c",
      "name": "Preparar Crear Tarea Paso2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n-main-21528542.dev.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1680,
        2928
      ],
      "id": "8364640d-cda6-4cf9-9188-a53a4b0ea14e",
      "name": "HTTP Crear Proyecto Paso1"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        0,
        3552
      ],
      "id": "881246fe-59a5-440b-8e00-1bf25e7e4524",
      "name": "Telegram Confirmar Modificaci√≥n",
      "webhookId": "520e93cf-0c81-45fa-a086-d8804f280b43"
    },
    {
      "parameters": {
        "jsCode": "// Recupera los datos del contexto anterior\nconst contacto = $node[\"Preparar Modificar Contacto\"].json.contacto;\nconst campo = $node[\"Preparar Modificar Contacto\"].json.campo;\nconst nuevo_valor = $node[\"Formatear Nuevo Valor\"].json.nuevo_valor ?? $json.nuevo_valor;\nconst chat_id = $node[\"Preparar Modificar Contacto\"].json.chat_id;\n\n// Obtener datos del contacto actualizado desde la respuesta de b√∫squeda\nconst contactoData = $node[\"Buscar Contacto\"].json.result[0];\nconst nombreCompleto = contactoData ? contactoData.name : contacto;\n\n// Mapeo para mostrar el campo de forma amigable\nconst campoMap = {\n  telefono: 'tel√©fono',\n  email: 'email',\n  direccion: 'direcci√≥n',\n  web: 'p√°gina web',\n  notas: 'notas internas'\n};\n\nconst campoAmigable = campoMap[campo] || campo;\n\n// Obtener valor anterior del contacto para mostrar el antes/despu√©s\nconst fieldMap = {\n  telefono: 'phone',\n  email: 'email',\n  direccion: 'street',\n  web: 'website',\n  notas: 'comment'\n};\nconst valorAnterior = contactoData ? contactoData[fieldMap[campo]] : 'No disponible';\n\n// Mensaje de confirmaci√≥n m√°s detallado\nlet texto = `üéâ **¬°Contacto actualizado exitosamente!**\\n\\n`;\ntexto += `üë§ **Contacto:** ${nombreCompleto}\\n`;\ntexto += `üìù **Campo modificado:** ${campoAmigable}\\n\\n`;\n\nif (campo && typeof nuevo_valor !== \"undefined\") {\n  // Mostrar el antes y despu√©s\n  texto += `**CAMBIOS REALIZADOS:**\\n`;\n  texto += `‚Ä¢ **Valor anterior:** ${valorAnterior || 'Vac√≠o'}\\n`;\n  texto += `‚Ä¢ **Nuevo valor:** ${nuevo_valor === \"\" ? \"Eliminado/vac√≠o\" : nuevo_valor}\\n\\n`;\n}\n\ntexto += `‚úÖ La informaci√≥n del contacto ha sido actualizada correctamente en Odoo.`;\n\nreturn {\n  chat_id,\n  texto\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -400,
        3696
      ],
      "id": "e6839adf-99ac-4017-8dec-a932da5be4c6",
      "name": "Formatear Confirmaci√≥n"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -592,
        3696
      ],
      "id": "d49adedf-6f53-4a17-a912-58bbedb4fc3a",
      "name": "Actualizar Contacto"
    },
    {
      "parameters": {
        "jsCode": "const contacto = $node[\"Preparar Modificar Contacto\"].json.contacto;\nconst campo = $node[\"Preparar Modificar Contacto\"].json.campo;\nconst chat_id = $node[\"Preparar Modificar Contacto\"].json.chat_id;\nconst uid = $node[\"Preparar Modificar Contacto\"].json.uid;\nconst contactoData = $node[\"Buscar Contacto\"].json.result[0];\nif (!contactoData) {\n  throw new Error(\"No se encontr√≥ el contacto para actualizar.\");\n}\nconst contacto_id = contactoData.id;\n\n// El nuevo valor viene del mensaje del usuario\nconst nuevo_valor = $json.text ?? $node[\"Preparar Modificar Contacto\"].json.nuevo_valor;\n\n// Mapeo de campos\nconst fieldMap = {\n  telefono: 'phone',\n  email: 'email',\n  direccion: 'street',\n  web: 'website',\n  notas: 'comment'\n};\nconst field = fieldMap[campo];\n\n// DEPURACI√ìN\nconsole.log(\"Campo recibido:\", campo);\nconsole.log(\"Field Odoo:\", field);\nconsole.log(\"Nuevo valor:\", nuevo_valor);\n\nif (!field) {\n  throw new Error(\"Campo no soportado o no reconocido: \" + campo);\n}\nif (typeof nuevo_valor === \"undefined\" || nuevo_valor === null) {\n  throw new Error(\"No se recibi√≥ el nuevo valor del usuario.\");\n}\n\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'azorn8n-main-21528542',\n      uid,\n      'admin',\n      'res.partner',\n      'write',\n      [ [contacto_id], { [field]: nuevo_valor } ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload,\n  chat_id,\n  contacto_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -832,
        3840
      ],
      "id": "95094f9c-39be-4a89-b28d-6202cd1e99f4",
      "name": "Formatear Nuevo Valor"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1056,
        3552
      ],
      "id": "ce5cd861-5129-45d1-b76e-59690db0cefb",
      "name": "Telegram Pedir Nuevo Valor",
      "webhookId": "8eb8bb62-7aaa-462c-b039-9a0dfa66db2b"
    },
    {
      "parameters": {
        "jsCode": "// Pide el nuevo valor al usuario\nconst datos = $node[\"Preparar Modificar Contacto\"].json;\nreturn {\n  chat_id: datos.chat_id,\n  texto: `¬øQu√© *nuevo valor* quieres poner en el campo *${datos.campo}* del contacto *${datos.contacto}*?`\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1472,
        3680
      ],
      "id": "f5e449fe-155b-46d7-8a99-7317bdbe16e4",
      "name": "Pedir Nuevo Valor"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $node[\"Preparar Modificar Contacto\"].json.nuevo_valor == null }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1680,
        3728
      ],
      "id": "59ae4cee-085c-4f66-83e6-cf5c3770e575",
      "name": "¬øFalta Nuevo Valor?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.payload) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1872,
        3728
      ],
      "id": "d29bbc14-b35f-43a4-b6f7-6bb90ba59332",
      "name": "Buscar Contacto"
    },
    {
      "parameters": {
        "jsCode": "// Prepara el payload para buscar el contacto en Odoo\nconst contacto = $json.contacto;\nconst campo = $json.campo;\nconst chat_id = $json.chat_id;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nuevo_valor = $json.nuevo_valor;\nconst payload = {\n  jsonrpc: '2.0',\n  method: 'call',\n  params: {\n    service: 'object',\n    method: 'execute_kw',\n    args: [\n      'azorn8n-main-21528542',\n      uid,\n      'admin',\n      'res.partner',\n      'search_read',\n      [ [ ['name', 'ilike', contacto] ], ['id', 'name', 'phone', 'email', 'street', 'city', 'zip', 'country_id', 'website', 'comment'] ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\nreturn { contacto, campo, chat_id, uid, nuevo_valor, payload };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2080,
        3728
      ],
      "id": "49a717de-ef79-49cd-a795-d301ae6126bb",
      "name": "Preparar Modificar Contacto"
    },
    {
      "parameters": {
        "jsCode": "// FLUJO: Crear SOLO Tarea ‚Üí Registrar Horas (proyecto ya existe)\nconst datos = $json;\nconst uid = datos.uid;\n\n// Los datos pueden venir desde el Router de Acciones de dos formas:\n// 1. Como datos.datos_pendientes (estructura anidada)\n// 2. Como datos directos desde Router (proyecto, tarea, horas, etc.)\nlet datosPendientes = datos.datos_pendientes;\n\n// Si no est√°n en datos_pendientes, construirlos desde los datos directos\nif (!datosPendientes || !datosPendientes.tarea) {\n  datosPendientes = {\n    proyecto: datos.proyecto,\n    proyecto_id: datos.proyecto_id,\n    tarea: datos.tarea,\n    horas: datos.horas,\n    descripcion: datos.descripcion,\n    uid: datos.uid,\n    tipo_creacion: 'solo_tarea_horas'\n  };\n}\n\nconst chatId = datos.chat_id;\n\nconsole.log('‚úÖ === FLUJO CREAR TAREA ‚Üí HORAS (Proyecto existe) ===');\nconsole.log('üìÑ Datos recibidos completos:', JSON.stringify(datos, null, 2));\nconsole.log('üìã Datos pendientes procesados:', JSON.stringify(datosPendientes, null, 2));\n\n// Validar que tenemos los datos cr√≠ticos desde cualquier fuente\nconst proyectoNombre = datosPendientes?.proyecto || datos.proyecto;\nconst proyectoId = datosPendientes?.proyecto_id || datos.proyecto_id;\nconst tareaNombre = datosPendientes?.tarea || datos.tarea;\nconst horasValor = datosPendientes?.horas || datos.horas;\n\nif (!tareaNombre || !horasValor) {\n  console.error('‚ùå Faltan datos cr√≠ticos:');\n  console.error('  - Proyecto:', proyectoNombre);\n  console.error('  - Proyecto ID:', proyectoId);\n  console.error('  - Tarea:', tareaNombre);\n  console.error('  - Horas:', horasValor);\n  console.error('‚ùå Datos originales recibidos:', JSON.stringify(datos, null, 2));\n  console.error('‚ùå Datos pendientes procesados:', JSON.stringify(datosPendientes, null, 2));\n  throw new Error(`Faltan datos cr√≠ticos para crear la tarea. Proyecto: ${proyectoNombre}, Tarea: ${tareaNombre}, Horas: ${horasValor}`);\n}\n\nif (!proyectoId) {\n  console.error('‚ùå No se encontr√≥ proyecto_id:');\n  console.error('  - Proyecto ID en datosPendientes:', datosPendientes?.proyecto_id);\n  console.error('  - Proyecto ID en datos:', datos.proyecto_id);\n  console.error('‚ùå Datos originales recibidos:', JSON.stringify(datos, null, 2));\n  throw new Error('No se encontr√≥ ID del proyecto existente. Revisa que el proyecto_id est√© en memoria.');\n}\n\n// Asegurar que datosPendientes tenga todos los datos necesarios\ndatosPendientes = {\n  proyecto: proyectoNombre,\n  proyecto_id: proyectoId,\n  tarea: tareaNombre,\n  horas: horasValor,\n  descripcion: datosPendientes?.descripcion || datos.descripcion || `Registro de ${horasValor} horas en ${tareaNombre}`,\n  uid: datos.uid,\n  tipo_creacion: datosPendientes?.tipo_creacion || 'solo_tarea_horas'\n};\n\nconsole.log('üìã Proyecto existente:', datosPendientes.proyecto, 'ID:', datosPendientes.proyecto_id);\nconsole.log('‚úÖ Tarea a crear:', datosPendientes.tarea);\nconsole.log('‚è∞ Horas a registrar:', datosPendientes.horas);\nconsole.log('üìù Descripci√≥n:', datosPendientes.descripcion);\n\n// PASO 1: Crear la tarea en el proyecto existente\nconst crearTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"create\",\n      [{\n        name: datosPendientes.tarea,\n        project_id: datosPendientes.proyecto_id,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearTarea,\n  datos_flujo: {\n    paso: 'crear_tarea_solo',\n    proyecto: datosPendientes.proyecto,\n    proyecto_id: datosPendientes.proyecto_id,\n    tarea: datosPendientes.tarea,\n    horas: datosPendientes.horas,\n    descripcion: datosPendientes.descripcion,\n    chat_id: chatId,\n    uid: uid\n  },\n  datos_pendientes: datosPendientes\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1856,
        3360
      ],
      "id": "b984b955-f5db-483b-abda-e3cad53328fe",
      "name": "Flujo Crear Tarea y Horas"
    },
    {
      "parameters": {
        "jsCode": "// FLUJO SECUENCIAL: Crear Proyecto ‚Üí Tarea ‚Üí Registrar Horas\nconst datos = $json;\nconst uid = datos.uid;\n\n// Los datos pueden venir desde el Router de Acciones de dos formas:\n// 1. Como datos.datos_pendientes (estructura anidada)\n// 2. Como datos directos desde Router (proyecto, tarea, horas, etc.)\nlet datosPendientes = datos.datos_pendientes;\n\n// Si no est√°n en datos_pendientes, construirlos desde los datos directos\nif (!datosPendientes || !datosPendientes.proyecto) {\n  datosPendientes = {\n    proyecto: datos.proyecto,\n    tarea: datos.tarea,\n    horas: datos.horas,\n    descripcion: datos.descripcion,\n    uid: datos.uid,\n    tipo_creacion: 'proyecto_tarea_horas'\n  };\n}\n\nconst chatId = datos.chat_id;\n\nconsole.log('üèóÔ∏è === FLUJO CREAR PROYECTO ‚Üí TAREA ‚Üí HORAS ===');\nconsole.log('üìÑ Datos recibidos completos:', JSON.stringify(datos, null, 2));\nconsole.log('üìã Datos pendientes procesados:', JSON.stringify(datosPendientes, null, 2));\n\n// Validar que tenemos los datos cr√≠ticos desde cualquier fuente\nconst proyectoNombre = datosPendientes?.proyecto || datos.proyecto;\nconst tareaNombre = datosPendientes?.tarea || datos.tarea;\nconst horasValor = datosPendientes?.horas || datos.horas;\n\nif (!proyectoNombre || !tareaNombre || !horasValor) {\n  console.error('‚ùå Faltan datos cr√≠ticos:');\n  console.error('  - Proyecto:', proyectoNombre);\n  console.error('  - Tarea:', tareaNombre);\n  console.error('  - Horas:', horasValor);\n  console.error('‚ùå Datos originales recibidos:', JSON.stringify(datos, null, 2));\n  console.error('‚ùå Datos pendientes procesados:', JSON.stringify(datosPendientes, null, 2));\n  throw new Error(`Faltan datos cr√≠ticos para crear el proyecto. Proyecto: ${proyectoNombre}, Tarea: ${tareaNombre}, Horas: ${horasValor}`);\n}\n\n// Asegurar que datosPendientes tenga todos los datos necesarios\ndatosPendientes = {\n  proyecto: proyectoNombre,\n  tarea: tareaNombre,\n  horas: horasValor,\n  descripcion: datosPendientes?.descripcion || datos.descripcion || `Registro de ${horasValor} horas`,\n  uid: datos.uid,\n  tipo_creacion: datosPendientes?.tipo_creacion || 'proyecto_tarea_horas'\n};\n\nconsole.log('üìã Proyecto a crear:', datosPendientes.proyecto);\nconsole.log('‚úÖ Tarea a crear:', datosPendientes.tarea);\nconsole.log('‚è∞ Horas a registrar:', datosPendientes.horas);\nconsole.log('üìù Descripci√≥n:', datosPendientes.descripcion);\n\n// PASO 1: Crear el proyecto\nconst crearProyecto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"project.project\",\n      \"create\",\n      [{\n        name: datosPendientes.proyecto,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearProyecto,\n  datos_flujo: {\n    paso: 'crear_proyecto',\n    proyecto: datosPendientes.proyecto,\n    tarea: datosPendientes.tarea,\n    horas: datosPendientes.horas,\n    descripcion: datosPendientes.descripcion,\n    chat_id: chatId,\n    uid: uid\n  },\n  datos_pendientes: datosPendientes\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1872,
        2928
      ],
      "id": "bded1bd0-9a76-4e5f-bef0-b79d4ac72d39",
      "name": "Flujo Crear Proyecto Tarea Horas"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS COMPLETOS PARA CREAR PROYECTO TAREA HORAS\n// OBTENER DATOS DESDE EL NODO CORRECTO\nlet datos = $json;\n\nconsole.log('üîß DATOS DESDE SWITCH ACCIONES:', JSON.stringify(datos, null, 2));\n\n// IMPORTANTE: Obtener datos desde el nodo que S√ç tiene la informaci√≥n\nlet datosFromAI;\ntry {\n  datosFromAI = $('Preparar Datos AI Agent').first().json;\n  console.log('‚úÖ Datos obtenidos desde Preparar Datos AI Agent');\n  console.log('üì• Datos AI Agent:', JSON.stringify(datosFromAI, null, 2));\n  \n  // Si los datos llegan como array, extraer el primer elemento\n  if (Array.isArray(datosFromAI) && datosFromAI.length > 0) {\n    console.log('‚ö†Ô∏è Datos recibidos como array, extrayendo primer elemento');\n    datosFromAI = datosFromAI[0];\n  }\n  \n  datos = datosFromAI;\n} catch (e) {\n  console.error('‚ùå Error obteniendo datos desde Preparar Datos AI Agent:', e.message);\n  console.log('üìã Usando datos del Switch (pueden estar vac√≠os)');\n  \n  // Si los datos del Switch llegan como array, extraer el primer elemento\n  if (Array.isArray(datos) && datos.length > 0) {\n    console.log('‚ö†Ô∏è Datos del Switch como array, extrayendo primer elemento');\n    datos = datos[0];\n  }\n}\n\nconsole.log('üîß === PREPARAR DATOS COMPLETOS PROYECTO ===');\nconsole.log('üì• Datos recibidos:', JSON.stringify(datos, null, 2));\nconsole.log('üîç DEBUGGING COMPLETO:');\nconsole.log('   - Tipo de datos:', typeof datos);\nconsole.log('   - Es array?:', Array.isArray(datos));\nconsole.log('   - Claves principales:', Object.keys(datos || {}));\nconsole.log('   - datos.datos_pendientes existe?:', !!datos.datos_pendientes);\nif (datos.datos_pendientes) {\n  console.log('   - Contenido datos_pendientes:', JSON.stringify(datos.datos_pendientes, null, 2));\n  console.log('   - datos_pendientes.proyecto:', datos.datos_pendientes.proyecto);\n  console.log('   - datos_pendientes.tarea:', datos.datos_pendientes.tarea);\n  console.log('   - datos_pendientes.horas:', datos.datos_pendientes.horas);\n}\n\n// Obtener datos del Router de Acciones anterior para asegurar informaci√≥n completa\nlet datosRouter = {};\ntry {\n  datosRouter = $('Router de Acciones FIXED').first().json;\n  console.log('‚úÖ Datos del Router obtenidos exitosamente');\n  console.log('üîç Datos del Router:', JSON.stringify(datosRouter, null, 2));\n} catch (e) {\n  console.log('‚ö†Ô∏è No se pudieron obtener datos del Router de Acciones:', e.message);\n  console.log('üìã Usando solo datos del Switch');\n}\n\n// COMBINAR Y VALIDAR DATOS DE M√öLTIPLES FUENTES\n// PRIORIDAD: datos_pendientes > datos directos > router\nconst datosCompletos = {\n  // Datos b√°sicos del usuario\n  chat_id: datos.chat_id || datosRouter.chat_id,\n  user_id: datos.user_id || datosRouter.user_id,\n  user_name: datos.user_name || datosRouter.user_name,\n  uid: datos.uid || datosRouter.uid,\n  mensaje_original: datos.mensaje_original || datosRouter.mensaje_original,\n  \n  // Acci√≥n espec√≠fica\n  accion: datos.accion || 'crear_proyecto_tarea_horas',\n  \n  // Datos del proyecto/tarea/horas - PRIORIDAD A datos_pendientes\n  proyecto: datos.datos_pendientes?.proyecto || datos.proyecto || datosRouter.proyecto || datosRouter.datos_pendientes?.proyecto,\n  tarea: datos.datos_pendientes?.tarea || datos.tarea || datosRouter.tarea || datosRouter.datos_pendientes?.tarea,\n  horas: datos.datos_pendientes?.horas || datos.horas || datosRouter.horas || datosRouter.datos_pendientes?.horas,\n  descripcion: datos.datos_pendientes?.descripcion || datos.descripcion || datosRouter.descripcion || datosRouter.datos_pendientes?.descripcion,\n  \n  // Datos pendientes completos\n  datos_pendientes: {\n    proyecto: datos.datos_pendientes?.proyecto || datos.proyecto || datosRouter.proyecto || datosRouter.datos_pendientes?.proyecto,\n    tarea: datos.datos_pendientes?.tarea || datos.tarea || datosRouter.tarea || datosRouter.datos_pendientes?.tarea,\n    horas: datos.datos_pendientes?.horas || datos.horas || datosRouter.horas || datosRouter.datos_pendientes?.horas,\n    descripcion: datos.datos_pendientes?.descripcion || datos.descripcion || datosRouter.descripcion || datosRouter.datos_pendientes?.descripcion,\n    uid: datos.uid || datosRouter.uid,\n    tipo_creacion: 'proyecto_tarea_horas',\n    ...datos.datos_pendientes\n  }\n};\n\nconsole.log('üéØ DATOS COMPLETOS PREPARADOS:');\nconsole.log('   üìã Proyecto:', datosCompletos.proyecto);\nconsole.log('   ‚úÖ Tarea:', datosCompletos.tarea);\nconsole.log('   ‚è∞ Horas:', datosCompletos.horas);\nconsole.log('   üìù Descripci√≥n:', datosCompletos.descripcion);\nconsole.log('   üîë UID:', datosCompletos.uid);\nconsole.log('   üí¨ Chat ID:', datosCompletos.chat_id);\nconsole.log('   üóÇÔ∏è Datos pendientes completos:', JSON.stringify(datosCompletos.datos_pendientes, null, 2));\n\n// VALIDACI√ìN FINAL\nif (!datosCompletos.proyecto || !datosCompletos.tarea || !datosCompletos.horas) {\n  console.error('‚ùå VALIDACI√ìN FALLIDA - Faltan datos cr√≠ticos despu√©s de preparaci√≥n:');\n  console.error('   - Proyecto:', datosCompletos.proyecto);\n  console.error('   - Tarea:', datosCompletos.tarea);\n  console.error('   - Horas:', datosCompletos.horas);\n  console.error('   - Datos originales Switch:', JSON.stringify(datos, null, 2));\n  console.error('   - Datos Router:', JSON.stringify(datosRouter, null, 2));\n  throw new Error(`Preparaci√≥n de datos fallida. Proyecto: ${datosCompletos.proyecto}, Tarea: ${datosCompletos.tarea}, Horas: ${datosCompletos.horas}`);\n}\n\nconsole.log('‚úÖ VALIDACI√ìN EXITOSA - Todos los datos cr√≠ticos est√°n presentes');\nconsole.log('üöÄ Enviando datos completos al Flujo Crear Proyecto Tarea Horas');\n\nreturn datosCompletos;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2080,
        2928
      ],
      "id": "588ace7b-a1f6-49b3-a81a-3f956e7d1d97",
      "name": "Preparar Datos Completos Proyecto"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Registro Autom√°tico').item.json.datos_registro.chat_id }}",
        "text": "=‚úÖ **¬°Tarea creada y horas registradas exitosamente!**\n\nüìã **Proyecto:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.proyecto_nombre }}\nüìù **Tarea:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.tarea_nombre }} (NUEVA)\n‚è∞ **Horas:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.horas }}\nüìÖ **Fecha:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.fecha }}\nüí¨ **Descripci√≥n:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.descripcion }}\n\nüéâ ¬°Todo completado autom√°ticamente! ¬°Gracias por mantener tu registro actualizado!",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        416,
        992
      ],
      "id": "03743f3e-91a4-46a7-8d05-abce51cb9dbb",
      "name": "Confirmar Todo Completado",
      "webhookId": "e2033027-5eb3-4bfe-9eae-b1e0e77bdc36"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        32,
        1072
      ],
      "id": "f97f709f-cf30-4427-abf3-f64125a590ca",
      "name": "Registrar Horas Autom√°tico"
    },
    {
      "parameters": {
        "jsCode": "// Preparar registro autom√°tico de horas tras crear tarea\nconst datosHoras = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\nconst crearHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosHoras.descripcion,\n        unit_amount: parseFloat(datosHoras.horas),\n        project_id: parseInt(datosHoras.proyecto_data.id),\n        task_id: parseInt(datosHoras.tarea_creada_id),\n        date: fechaHoy\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearHoras,\n  datos_registro: {\n    proyecto_nombre: datosHoras.proyecto,\n    tarea_nombre: datosHoras.tarea,\n    horas: datosHoras.horas,\n    descripcion: datosHoras.descripcion,\n    fecha: fechaHoy,\n    chat_id: datosHoras.chat_id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        1072
      ],
      "id": "039e6566-e08a-4d58-8b28-22acd5b45fe7",
      "name": "Preparar Registro Autom√°tico"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.accion === 'registrar_horas_automatico' }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -480,
        1088
      ],
      "id": "edd16613-2b52-46de-bab3-cb48dbf7282d",
      "name": "¬øTiene Horas Pendientes?"
    },
    {
      "parameters": {
        "jsCode": "// Verificar si despu√©s de crear la tarea hay que registrar horas pendientes\nconst datosLimpiar = $json;\nconst chatId = datosLimpiar.datos_tarea?.chat_id;\nconst memoria = datosLimpiar.memoria;\n\nif (!chatId || !memoria) {\n  console.log('No se encontr√≥ chatId o memoria');\n  return { accion: 'terminar' };\n}\n\n// Si hab√≠a datos pendientes de registro de horas, proceder a registrarlas\nif (memoria.datos_pendientes && memoria.datos_pendientes.accion_original === 'registrar_horas') {\n  const datosHoras = memoria.datos_pendientes;\n  \n  console.log('Registrando horas autom√°ticamente:', datosHoras);\n  \n  // Limpiar memoria ahora que vamos a registrar las horas\n  const contextoKey = `memoria_${chatId}`;\n  let memoriaActualizada = global[contextoKey] || {};\n  memoriaActualizada.esperando_confirmacion = null;\n  memoriaActualizada.datos_pendientes = null;\n  global[contextoKey] = memoriaActualizada;\n  \n  // Preparar datos para registrar horas con la tarea reci√©n creada\n  return {\n    proyecto: datosHoras.proyecto,\n    tarea: datosHoras.tarea,\n    horas: datosHoras.horas,\n    descripcion: datosHoras.descripcion,\n    uid: datosLimpiar.uid,\n    chat_id: chatId,\n    accion: 'registrar_horas_automatico',\n    proyecto_data: {\n      id: datosLimpiar.datos_tarea.proyecto_id,\n      name: datosHoras.proyecto\n    },\n    tarea_creada_id: datosLimpiar.tarea_creada_id\n  };\n} else {\n  // No hay horas pendientes, terminar\n  console.log('No hay horas pendientes para registrar');\n  return { accion: 'terminar' };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -672,
        1088
      ],
      "id": "fa4b6d05-9220-428f-9877-74d481057357",
      "name": "Verificar Registro Horas Pendiente"
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos despu√©s de crear tarea exitosamente\nconst chatId = $('Preparar Crear Tarea').item.json.datos_tarea.chat_id;\nconst tareaCreada = $json.result; // ID de la tarea reci√©n creada\nconst contextoKey = `memoria_${chatId}`;\nlet memoria = global[contextoKey] || {};\n\n// Actualizar memoria con la nueva tarea creada\nmemoria.proyecto_anterior = $('Preparar Crear Tarea').item.json.datos_tarea.nombre_proyecto;\nmemoria.tarea_anterior = $('Preparar Crear Tarea').item.json.datos_tarea.nombre_tarea;\nmemoria.ultima_accion = 'crear_tarea';\n\n// Conservar datos pendientes si existen para registro autom√°tico de horas\nconst tieneHorasPendientes = memoria.datos_pendientes && memoria.datos_pendientes.accion_original === 'registrar_horas';\n\nif (!tieneHorasPendientes) {\n  memoria.esperando_confirmacion = null;\n  memoria.datos_pendientes = null;\n}\n\nglobal[contextoKey] = memoria;\n\nreturn {\n  ...($json),\n  datos_tarea: $('Preparar Crear Tarea').item.json.datos_tarea,\n  tarea_creada_id: tareaCreada,\n  uid: $('Preparar Crear Tarea').item.json.datos_tarea.uid || $('Buscar Proyecto para Tarea').item.json.uid,\n  memoria: memoria\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -848,
        1088
      ],
      "id": "ebf7a3c9-5588-4fd9-b51c-8d50d2772340",
      "name": "Limpiar Memoria Tarea"
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-flash-preview-05-20",
        "options": {
          "temperature": 0.3,
          "topP": 0.9
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -3888,
        1696
      ],
      "id": "0e817849-0b74-4ba0-940a-cb920ef9be25",
      "name": "Google Gemini Chat Model"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres un asistente virtual para Odoo con el estilo de comunicaci√≥n de Jorge, un consultor especializado en automatizaci√≥n con IA y Odoo. Analiza este mensaje y responde en JSON.\n\n**MENSAJE DEL USUARIO:** {{ $json.mensaje_usuario }}\n**USUARIO:** {{ $json.user_name || 'Usuario' }} (ID: {{ $json.user_id || 'unknown' }})\n**TIPO:** {{ $json.es_audio ? 'Audio transcrito' : 'Texto' }}\n\n{% if $json.es_audio %}\nüé§ **MENSAJE DE VOZ TRANSCRITO:** {{ $json.mensaje_usuario }}\n{% endif %}\n\n**MEMORIA DEL USUARIO (CONTEXTO ACTUAL):**\n{% if $json.esperando_confirmacion %}\nüîÑ **ESPERANDO CONFIRMACI√ìN PARA:** {{ $json.esperando_confirmacion }}\nüìù **√öLTIMO MENSAJE BOT:** {{ $json.ultimo_mensaje_bot }}\nüìã **DATOS PENDIENTES:** {{ $json.datos_pendientes | tojsonpretty }}\n{% endif %}\n\n**üìå CONTEXTO GENERAL - ESTILO JORGE**\nSoy consultor en automatizaci√≥n con IA y Odoo, especializado en eficiencia tecnol√≥gica para empresas. Trabajo con pymes industriales, empresas de servicios y startups tecnol√≥gicas. Mi objetivo es generar leads, construir autoridad, abrir conversaciones, educar al mercado y posicionarme como una voz experta en tecnolog√≠a, IA y herramientas como n8n. Me dirijo principalmente a decisores de negocio y tecnolog√≠a, mostrando con claridad c√≥mo la automatizaci√≥n puede transformar procesos reales.\n\n**üß† ACT√öA COMO UN COPYWRITER ESPECIALIZADO EN COMUNICACI√ìN TECNOL√ìGICA**\nAdopta el estilo de Jorge, un profesional directo, t√©cnico pero cercano, que prioriza la claridad y la confianza. Su forma de escribir se basa en construir relaciones reales con clientes, explicar conceptos con naturalidad y mostrar el valor de forma transparente, sin adornos innecesarios.\n\n**üë®‚Äçüíº IDENTIDAD PERSONAL**\n* Hombre, 33 a√±os, madrile√±o.\n* M√°s de 10 a√±os de experiencia en tecnolog√≠a y negocios.\n* Apasionado de la tecnolog√≠a que genera impacto real.\n* Sagaz, directo, cr√≠tico y aut√©ntico.\n\n**üó£Ô∏è TONO**\n* Profesional sin rigidez. Habla claro, con naturalidad, como si escribieras un correo real a un cliente.\n* Cercano pero sin adornos. Nada de exageraciones ni frases hechas. No busca sonar \"moderno\" ni intentar impresionar con jerga.\n* Reflexivo, observador y con criterio propio. El texto debe sonar como alguien que piensa en voz alta con l√≥gica y experiencia.\n* Se puede usar una ligera iron√≠a o comentarios personales, si aporta cercan√≠a.\n* Evita palabras en ingl√©s salvo que sean necesarias (ej. nombres propios, conceptos como \"Data Driven, Business Intelligence,etc...\"). Si existe una forma clara de decirlo en castellano, √∫sala.\n* Siempre orientado a construir confianza. No se vende humo, se aportan hechos.\n* Se prioriza la l√≥gica, los beneficios tangibles y la claridad t√©cnica explicada sin jerga.\n\n**‚ú® ESTILO ESCRITO**\n* Frases cortas y naturales. Nada rebuscado ni inflado. Como si lo dijeras hablando.\n* Tono directo, sin vueltas. Si hay un problema, se menciona. Si hay una ventaja, se justifica.\n* Expone ideas como una secuencia de pensamiento: plantea una observaci√≥n, la analiza y ofrece una postura razonable.\n* Incluye ejemplos concretos o referencias a situaciones reales (sin sonar como manual).\n* Si el contenido es t√©cnico, expl√≠calo como si se lo contaras a alguien que no lo domina (pero con respeto).\n* Uso puntual de MAY√öSCULAS para √©nfasis y estructura clara.\n* Cierre con reflexi√≥n o pregunta que invite al lector a compartir su opini√≥n, adem√°s de posibles CTAs.\n\n**üåü P√öBLICO OBJETIVO**\nConecta con:\nCTOs, COOs, CIOs, CMOs, CFOs, Tech Leads, project managers, responsables de BI, operaciones, supply chain, fundadores de eCommerce, gerentes de pymes industriales y consultores IT.\n\nHabla como a un colega que sabe de lo que habla, entiende los retos y ofrece soluciones claras: automatizaci√≥n, integraci√≥n, eficiencia y escalabilidad. Nada de discursos vac√≠os.\n\n**RECONOCIMIENTO DE PATRONES - EVAL√öA SI EL MENSAJE CONTIENE:**\n- ‚úÖ Palabras clave de REGISTRO: \"registrar\", \"parte\", \"horas\", \"proyecto\", \"tarea\"\n- ‚úÖ Palabras clave de CREACI√ìN: \"crear\", \"nuevo\", \"proyecto\", \"tarea\"\n- ‚úÖ Palabras clave de CONSULTA: \"cu√°nto\", \"precio\", \"stock\", \"ventas\", \"contacto\"\n- ‚úÖ Palabras clave de MODIFICACI√ìN: \"modificar\", \"cambiar\", \"editar\", \"actualizar\", \"corregir\", \"pon\", \"quitar\", \"eliminar\", \"a√±adir\" (contactos)\n- ‚úÖ Palabras de CONFIRMACI√ìN: \"s√≠\", \"si\", \"vale\", \"adelante\", \"confirmar\", \"crear\", \"ok\", \"perfecto\"\n\n**DATOS B√ÅSICOS:**\n- Usuario actual procesando mensaje\n- Sistema listo para registro de horas y gesti√≥n de proyectos\n\n**INSTRUCCIONES CR√çTICAS PARA TRANSCRIPCIONES DE AUDIO:**\n- SIEMPRE extrae informaci√≥n de registro de horas de las transcripciones de audio\n- Busca patrones como: \"registrar\", \"parte de horas\", \"proyecto\", \"tarea\", n√∫meros de horas\n- Interpreta n√∫meros escritos como texto: \"dos horas\" = 2, \"tres horas\" = 3, etc.\n- Si detectas solicitud de registro de horas en audio, SIEMPRE usar acci√≥n \"registrar_horas\"\n- Busca nombres de proyectos y tareas aunque est√©n mal transcritos\n\n**EJEMPLOS DE TRANSCRIPCIONES DE AUDIO A RECONOCER:**\n- \"Registrar parte de horas en proyecto test N8N, tarea prueba N8N. Quiero un parte de horas de dos horas con un mensaje que sea cortar fichase\" ‚Üí registrar_horas\n- \"Quiero registrar tres horas en el proyecto Marketing Digital tarea gesti√≥n redes\" ‚Üí registrar_horas\n- \"Parte de horas proyecto X tarea Y cinco horas mensaje desarrollo\" ‚Üí registrar_horas\n\n**INSTRUCCIONES GENERALES:**\n- ANALIZA EL MENSAJE para entender el contexto\n- Si el usuario dice \"s√≠\", \"si\", \"crear\", \"adelante\" considera que est√° confirmando algo\n- Mant√©n la conversaci√≥n fluida\n\n**MANEJO DE CONFIRMACIONES (CR√çTICO):**\n{% if $json.esperando_confirmacion %}\nüî• **ATENCI√ìN: EL USUARIO EST√Å EN PROCESO DE CONFIRMACI√ìN**\n- Tipo de confirmaci√≥n esperada: {{ $json.esperando_confirmacion }}\n- Datos pendientes: {{ $json.datos_pendientes | tojsonpretty }}\n\n**CONFIRMACI√ìN DETECTADA EN ESTOS CASOS:**\n1. **Confirmaci√≥n EXPL√çCITA**: palabras como \"s√≠\", \"si\", \"vale\", \"crear\", \"adelante\", \"ok\", \"perfecto\", \"confirmar\"\n2. **Confirmaci√≥n IMPL√çCITA**: usuario repite solicitud de \"registrar horas\" cuando ya est√° esperando confirmaci√≥n\n3. **Confirmaci√≥n por INSISTENCIA**: menciona \"quiero registrar\", \"registrar parte\" o similar cuando est√° esperando confirmaci√≥n\n\n**SI DETECTAS CONFIRMACI√ìN (EXPL√çCITA O IMPL√çCITA):**\n  * Si esperando_confirmacion = \"crear_proyecto_completo\" ‚Üí acci√≥n: \"crear_proyecto_tarea_horas\"\n  * Si esperando_confirmacion = \"crear_tarea_solamente\" ‚Üí acci√≥n: \"crear_tarea_y_horas\"\n  * Si esperando_confirmacion = \"crear_proyecto\" ‚Üí acci√≥n: \"crear_proyecto_tarea_horas\"\n  * Si esperando_confirmacion = \"crear_tarea_y_registrar\" ‚Üí acci√≥n: \"crear_tarea_y_horas\"\n\n**RESPUESTA PARA CONFIRMACIONES:**\n```json\n{\n  \"accion\": \"crear_proyecto_tarea_horas\",\n  \"respuesta_usuario\": \"‚úÖ ¬°Perfecto! Detect√© que quieres proceder. Voy a crear el proyecto ‚Üí tarea ‚Üí registrar horas autom√°ticamente. Comenzando...\"\n}\n```\n\n- Si el mensaje contiene negaci√≥n (no, cancelar, nada), usa acci√≥n: \"conversar\"\n{% else %}\n- Si el usuario confirma algo sin contexto previo ‚Üí pedir aclaraci√≥n\n{% endif %}\n\n**TUS CAPACIDADES:**\n1. üìã **Registrar horas** de trabajo en proyectos y tareas\n2. üèóÔ∏è **Crear proyectos** nuevos\n3. ‚úÖ **Crear tareas** dentro de proyectos\n4. üîç **Consultar** informaci√≥n de proyectos y tareas\n5. üõçÔ∏è **Consultar productos** - precio, stock, informaci√≥n\n6. üí∞ **Consultar ventas** - ventas del mes, por producto, totales\n7. üë§ **Consultar contactos** - informaci√≥n de clientes\n8. üìù **Modificar contactos** - cambiar datos de un contacto (tel√©fono, email, direcci√≥n, web, notas internas)\n9. üí¨ **Conversar** de manera natural y amigable\n10. üß† **Recordar** contexto de conversaciones anteriores\n11. üé§ **Procesar audio** transcripto autom√°ticamente\n\n**FORMATOS DE RESPUESTA REQUERIDOS (CON ESTILO JORGE):**\n\n**Para registrar horas** (cuando tengas TODA la informaci√≥n necesaria):\n```json\n{\n  \"accion\": \"registrar_horas\",\n  \"proyecto\": \"nombre exacto del proyecto\",\n  \"tarea\": \"nombre exacta de la tarea\",\n  \"horas\": numero_de_horas,\n  \"descripcion\": \"descripci√≥n del trabajo realizado\",\n  \"respuesta_usuario\": \"üé§ Audio transcrito exitosamente\\n\\nüìù Perfecto, voy a registrar [X] horas en la tarea '[TAREA]' del proyecto '[PROYECTO]' por: [DESCRIPCI√ìN]. ¬øProcedo con el registro?\"\n}\n```\n\n**Para crear tarea**:\n```json\n{\n  \"accion\": \"crear_tarea\",\n  \"proyecto\": \"nombre del proyecto existente\",\n  \"tarea\": \"nombre de la nueva tarea\",\n  \"horas\": numero_de_horas_pendientes,\n  \"descripcion\": \"descripci√≥n del trabajo pendiente\",\n  \"respuesta_usuario\": \"üé§ Audio transcrito exitosamente\\n\\n‚úÖ Perfecto, voy a crear la tarea '[TAREA]' en el proyecto '[PROYECTO]' con [X] horas por: [DESCRIPCI√ìN].\"\n}\n```\n\n**Para consultar productos**:\n```json\n{\n  \"accion\": \"consultar_producto\",\n  \"producto\": \"nombre del producto a buscar\",\n  \"respuesta_usuario\": \"üîç Buscando informaci√≥n del producto '[PRODUCTO]'...\"\n}\n```\n\n**Para consultar ventas**:\n```json\n{\n  \"accion\": \"consultar_ventas\",\n  \"tipo_consulta\": \"mes_actual|mes_pasado|producto_especifico|producto_especifico_con_fechas|mes_nombre\",\n  \"parametro\": \"nombre_producto_o_mes\",\n  \"fecha_desde\": \"YYYY-MM-DD (solo para producto_especifico_con_fechas)\",\n  \"fecha_hasta\": \"YYYY-MM-DD (solo para producto_especifico_con_fechas)\",\n  \"respuesta_usuario\": \"üí∞ Consultando ventas...\"\n}\n```\n\n**Para consultar contactos**:\n```json\n{\n  \"accion\": \"consultar_contacto\",\n  \"contacto\": \"nombre del contacto a buscar\",\n  \"respuesta_usuario\": \"üë§ Buscando informaci√≥n del contacto '[CONTACTO]'...\"\n}\n```\n\n**Para crear contactos**:\n```json\n{\n  \"accion\": \"crear_contacto\",\n  \"nombre\": \"nombre del contacto\",\n  \"email\": \"email@ejemplo.com\",\n  \"telefono\": \"+34 600 000 000\",\n  \"empresa\": \"nombre de empresa (opcional)\",\n  \"respuesta_usuario\": \"üÜï Creando contacto '[NOMBRE]' en Odoo...\"\n}\n```\n\n**Para modificar contactos** (NUEVA FUNCIONALIDAD):\n\nSi NO tienes toda la informaci√≥n, pide solo lo que falta:\n```json\n{\n  \"accion\": \"modificar_contacto\",\n  \"contacto\": \"Nombre del contacto\",\n  \"campo\": \"telefono|email|direccion|web|notas\",\n  \"nuevo_valor\": null,\n  \"respuesta_usuario\": \"Voy a modificar el [CAMPO] de [CONTACTO]. ¬øCu√°l es el nuevo valor?\"\n}\n```\n\nSi el usuario da el nuevo valor directamente:\n```json\n{\n  \"accion\": \"modificar_contacto\",\n  \"contacto\": \"Nombre del contacto\",\n  \"campo\": \"telefono|email|direccion|web|notas\",\n  \"nuevo_valor\": \"nuevo valor aqu√≠\",\n  \"respuesta_usuario\": \"He actualizado el [CAMPO] de [CONTACTO] a: [NUEVO_VALOR].\"\n}\n```\n\n**Para conversaci√≥n general**:\n```json\n{\n  \"accion\": \"conversar\",\n  \"respuesta_usuario\": \"üé§ Audio transcrito exitosamente\\n\\nRespuesta contextual basada en la conversaci√≥n con estilo Jorge\"\n}\n```\n\n**Para confirmaciones de flujos secuenciales**:\n```json\n{\n  \"accion\": \"crear_proyecto_tarea_horas\",\n  \"respuesta_usuario\": \"‚úÖ ¬°Perfecto! Voy a crear el proyecto ‚Üí tarea ‚Üí registrar horas autom√°ticamente. Comenzando...\"\n}\n```\n\n```json\n{\n  \"accion\": \"crear_tarea_y_horas\",\n  \"respuesta_usuario\": \"‚úÖ ¬°Entendido! Voy a crear la tarea ‚Üí registrar horas autom√°ticamente. Comenzando...\"\n}\n```\n\n**EJEMPLOS ESPEC√çFICOS DE TRANSCRIPCIONES:**\n\nüì• **Audio transcrito**: \"Registrar parte de horas en proyecto test N8N, tarea prueba N8N. Quiero un parte de horas de dos horas con un mensaje que sea cortar fichase\"\nüì§ **Respuesta**:\n```json\n{\n  \"accion\": \"registrar_horas\",\n  \"proyecto\": \"test N8N\",\n  \"tarea\": \"prueba N8N\",\n  \"horas\": 2,\n  \"descripcion\": \"cortar fichase\",\n  \"respuesta_usuario\": \"üé§ Audio transcrito exitosamente\\n\\nüìù Perfecto, voy a registrar 2 horas en la tarea 'prueba N8N' del proyecto 'test N8N' por: cortar fichase. ¬øProcedo con el registro?\"\n}\n```\n\n**EJEMPLOS DE CONSULTAS A ODOO:**\n\n**Productos:**\n- \"dime el stock de cabinet\" ‚Üí consultar_producto, producto: \"cabinet\"\n- \"precio de la camisa\" ‚Üí consultar_producto, producto: \"camisa\"\n- \"producto silla\" ‚Üí consultar_producto, producto: \"silla\"\n\n**Ventas:**\n- \"ventas totales del √∫ltimo mes\" ‚Üí consultar_ventas, tipo_consulta: \"mes_actual\"\n- \"ventas del mes pasado\" ‚Üí consultar_ventas, tipo_consulta: \"mes_pasado\"\n- \"ventas de junio\" ‚Üí consultar_ventas, tipo_consulta: \"mes_nombre\", parametro: \"junio\"\n- \"cu√°ntas ventas se han hecho de cabinet\" ‚Üí consultar_ventas, tipo_consulta: \"producto_especifico\", parametro: \"cabinet\"\n- \"cuanto se ha vendido de Elevator Installation desde el 1/7/2025 hasta dia de hoy\" ‚Üí consultar_ventas, tipo_consulta: \"producto_especifico_con_fechas\", parametro: \"Elevator Installation\", fecha_desde: \"2025-07-01\", fecha_hasta: \"2025-07-02\"\n- \"ventas de sillas entre enero y marzo\" ‚Üí consultar_ventas, tipo_consulta: \"producto_especifico_con_fechas\", parametro: \"sillas\", fecha_desde: \"2025-01-01\", fecha_hasta: \"2025-03-31\"\n- \"cu√°nto cabinet se vendi√≥ en junio\" ‚Üí consultar_ventas, tipo_consulta: \"producto_especifico_con_fechas\", parametro: \"cabinet\", fecha_desde: \"2025-06-01\", fecha_hasta: \"2025-06-30\"\n\n**Contactos:**\n- \"existe el contacto Peterson\" ‚Üí consultar_contacto, contacto: \"Peterson\"\n- \"dime los datos de Juan\" ‚Üí consultar_contacto, contacto: \"Juan\"\n- \"cliente Mar√≠a\" ‚Üí consultar_contacto, contacto: \"Mar√≠a\"\n- \"crear contacto Juan Garc√≠a con email juan@empresa.com\" ‚Üí crear_contacto\n- \"nuevo cliente Ana L√≥pez tel√©fono 600123456\" ‚Üí crear_contacto\n- \"a√±adir contacto empresa Tecnolog√≠a SA\" ‚Üí crear_contacto\n\n**Modificar Contactos (NUEVA FUNCIONALIDAD):**\n- \"modifica el contacto Juan\" ‚Üí modificar_contacto, contacto: \"Juan\", campo: null, nuevo_valor: null (pide qu√© campo)\n- \"cambia el tel√©fono de Laura\" ‚Üí modificar_contacto, contacto: \"Laura\", campo: \"telefono\", nuevo_valor: null (pide nuevo n√∫mero)\n- \"pon el email de Pedro como pedro@nuevo.com\" ‚Üí modificar_contacto, contacto: \"Pedro\", campo: \"email\", nuevo_valor: \"pedro@nuevo.com\"\n- \"actualiza la direcci√≥n de Ana\" ‚Üí modificar_contacto, contacto: \"Ana\", campo: \"direccion\", nuevo_valor: null (pide nueva direcci√≥n)\n- \"a√±ade una nota a Carlos: Cliente VIP\" ‚Üí modificar_contacto, contacto: \"Carlos\", campo: \"notas\", nuevo_valor: \"Cliente VIP\"\n- \"quita el tel√©fono de Mar√≠a\" ‚Üí modificar_contacto, contacto: \"Mar√≠a\", campo: \"telefono\", nuevo_valor: \"\"\n- \"elimina la web de Juan\" ‚Üí modificar_contacto, contacto: \"Juan\", campo: \"web\", nuevo_valor: \"\"\n\n**RECONOCIMIENTO DE N√öMEROS EN TEXTO:**\n- \"uno\" / \"una hora\" = 1\n- \"dos horas\" = 2\n- \"tres horas\" = 3\n- \"cuatro horas\" = 4\n- \"cinco horas\" = 5\n- \"media hora\" = 0.5\n- \"hora y media\" = 1.5\n\n**REGLAS CR√çTICAS:**\n- SIEMPRE responde con JSON v√°lido\n- Para audio transcripto, EXTRAE DATOS aunque el texto no sea perfecto\n- Si detectas \"registrar\", \"parte de horas\" o similar en audio ‚Üí acci√≥n \"registrar_horas\"\n- Si detectas \"modificar\", \"cambiar\", \"editar\", \"actualizar\" + \"contacto\" ‚Üí acci√≥n \"modificar_contacto\"\n- Nunca devuelvas \"conversar\" si detectas solicitud de modificar contacto, aunque sea incompleta\n- APLICA SIEMPRE EL ESTILO DE JORGE: directo, t√©cnico pero cercano, sin jerga innecesaria\n\nResponde √öNICAMENTE con el JSON requerido:",
        "options": {
          "systemMessage": "MENSAJE ACTUAL: {{ $json.mensaje_usuario }}\n\nüéØ DETECTAR AUTOM√ÅTICAMENTE:\n- Contiene \"registrar\" + \"horas\" ‚Üí registrar_horas\n- Contiene \"crear proyecto\" ‚Üí crear_proyecto  \n- Contiene \"crear tarea\" ‚Üí crear_tarea\n- Contiene \"precio\" o \"stock\" ‚Üí consultar_producto\n- Contiene \"ventas\" ‚Üí consultar_ventas\n- Contiene \"contacto\" ‚Üí consultar_contacto\n\nUSAR datos reales del mensaje, NUNCA valores fijos.\nResponder SOLO con JSON v√°lido.",
          "maxIterations": 1,
          "returnIntermediateSteps": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        -3856,
        1408
      ],
      "id": "43da48d8-ec52-4108-8a6d-2fe39d679c93",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Crear Tarea').item.json.datos_tarea.chat_id }}",
        "text": "=‚úÖ **¬°Tarea creada exitosamente!**\n\nüìù **Tarea:** {{ $('Preparar Crear Tarea').item.json.datos_tarea.nombre_tarea }}\nüèóÔ∏è **Proyecto:** {{ $('Preparar Crear Tarea').item.json.datos_tarea.nombre_proyecto }}\nüÜî **ID:** {{ $json.result }}\n\nYa puedes registrar horas en esta tarea. ¬øNecesitas ayuda con algo m√°s? üòä",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1040,
        1008
      ],
      "id": "2dd58f6a-aa88-467c-b2c6-86e42ed5ad35",
      "name": "Confirmar Tarea Creada",
      "webhookId": "c8e2ae3a-6306-44a1-b11d-31027aaab751"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1328,
        1088
      ],
      "id": "1c248d6b-c6a9-4c6a-b0ea-6df8590881c9",
      "name": "Crear Tarea HTTP"
    },
    {
      "parameters": {
        "jsCode": "// Crear tarea en el proyecto encontrado\nconst datosOriginales = $('Buscar Proyecto para Tarea').item.json;\nconst proyectoData = $json.result[0];\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconst crearTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"create\",\n      [{\n        name: datosOriginales.tarea,\n        project_id: proyectoData.id,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearTarea,\n  datos_tarea: {\n    nombre_tarea: datosOriginales.tarea,\n    nombre_proyecto: proyectoData.name,\n    proyecto_id: proyectoData.id,\n    chat_id: datosOriginales.chat_id\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1488,
        1088
      ],
      "id": "f7113a0c-2c02-47b4-b82e-446529ac0dd1",
      "name": "Preparar Crear Tarea"
    },
    {
      "parameters": {
        "chatId": "={{ $('Buscar Proyecto para Tarea').item.json.chat_id }}",
        "text": "=‚ùå El proyecto \"{{ $('Buscar Proyecto para Tarea').item.json.proyecto }}\" no existe.\n\nDebes crear el proyecto primero antes de a√±adir tareas. ¬øQuieres que lo cree? Responde:\n- **'s√≠'** para crear el proyecto\n- **'no'** para cancelar",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -560,
        1248
      ],
      "id": "706168c3-8529-411d-ae99-b73dab6ae336",
      "name": "Proyecto No Existe para Tarea",
      "webhookId": "6336dbb1-4915-4717-8860-980730ff8c19"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.result && $json.result.length > 0 }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1696,
        1168
      ],
      "id": "9647f71f-3a63-4691-a83b-36a04f3f7159",
      "name": "¬øProyecto Existe para Tarea?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1856,
        1168
      ],
      "id": "5dd983f2-b316-4f96-a107-389e0943e645",
      "name": "Consultar Proyecto para Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Crear nueva tarea en proyecto existente - B√öSQUEDA CASE-INSENSITIVE\n// Obtener uid de la fuente correcta\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreTarea = $json.tarea;\nconst nombreProyecto = $json.proyecto;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticaci√≥n');\n}\n\n// Buscar el proyecto con ilike (case-insensitive)\nconst buscarProyecto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"project.project\",\n      \"search_read\",\n      [\n        [[\"name\", \"ilike\", nombreProyecto]],\n        [\"id\", \"name\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: buscarProyecto,\n  ...$json,\n  uid: uid // Asegurar que uid se pasa al siguiente nodo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2032,
        1168
      ],
      "id": "b1b27a98-d043-4b04-a673-d56d80486faa",
      "name": "Buscar Proyecto para Tarea"
    },
    {
      "parameters": {
        "jsCode": "// Los estados se actualizar√°n autom√°ticamente en PostgreSQL en la siguiente interacci√≥n\nconst datosRegistro = $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico;\nconsole.log('üßπ PostgreSQL manejar√° la actualizaci√≥n de estado autom√°ticamente');\nconsole.log('‚úÖ Proceso autom√°tico completado para:', datosRegistro.chat_id);\n\nreturn $json;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        800
      ],
      "id": "3575518f-2500-40d3-8552-c7294a575109",
      "name": "Limpiar Memoria Completa"
    },
    {
      "parameters": {
        "chatId": "={{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.chat_id }}",
        "text": "=üéâ **¬°TODO COMPLETADO AUTOM√ÅTICAMENTE!**\n\n‚úÖ **Proyecto creado:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.proyecto_nombre }}\n‚úÖ **Tarea creada:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.tarea_nombre }}\n‚úÖ **Horas registradas:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.horas }}\nüìÖ **Fecha:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.fecha }}\nüí¨ **Descripci√≥n:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.descripcion }}\n\n¬°Incre√≠ble! He creado el proyecto, la tarea y registrado tus horas autom√°ticamente. ¬°Todo listo! üöÄ",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        208,
        736
      ],
      "id": "9a47bed3-317d-4fb9-85b9-26541ef1c1e1",
      "name": "Confirmar Todo Autom√°tico",
      "webhookId": "c09647cd-c927-49e8-9a27-26f69354ebdf"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -176,
        816
      ],
      "id": "3d73aa46-fdc2-4179-bd42-429488154005",
      "name": "Registrar Horas Autom√°tico Completo"
    },
    {
      "parameters": {
        "jsCode": "// Preparar registro autom√°tico de horas tras crear proyecto y tarea\nconst datosTarea = $('Preparar Crear Tarea Autom√°tica').item.json.datos_tarea_automatica;\nconst tareaCreada = $json.result; // ID de la tarea reci√©n creada\nconst fechaHoy = new Date().toISOString().split('T')[0];\n\nconst crearHoras = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      datosTarea.uid,\n      \"admin\",\n      \"account.analytic.line\",\n      \"create\",\n      [{\n        name: datosTarea.descripcion,\n        unit_amount: parseFloat(datosTarea.horas),\n        project_id: parseInt(datosTarea.proyecto_id),\n        task_id: parseInt(tareaCreada),\n        date: fechaHoy\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearHoras,\n  datos_registro_automatico: {\n    proyecto_nombre: datosTarea.nombre_proyecto,\n    tarea_nombre: datosTarea.nombre_tarea,\n    horas: datosTarea.horas,\n    descripcion: datosTarea.descripcion,\n    fecha: fechaHoy,\n    chat_id: datosTarea.chat_id,\n    tarea_id: tareaCreada\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -352,
        816
      ],
      "id": "946afb09-6a4f-48a9-ae6b-d2041741097e",
      "name": "Preparar Registro Autom√°tico Completo"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -528,
        800
      ],
      "id": "06d220d7-1db6-4c49-96fb-1629601452f2",
      "name": "Crear Tarea Autom√°tica HTTP"
    },
    {
      "parameters": {
        "jsCode": "// Crear tarea autom√°ticamente despu√©s de crear proyecto\nconst datosProyecto = $json;\nconst uid = $('Autenticar Odoo').item.json.result;\n\nconst crearTarea = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"project.task\",\n      \"create\",\n      [{\n        name: datosProyecto.tarea,\n        project_id: parseInt(datosProyecto.proyecto_id),\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearTarea,\n  datos_tarea_automatica: {\n    nombre_tarea: datosProyecto.tarea,\n    nombre_proyecto: datosProyecto.proyecto_nombre,\n    proyecto_id: datosProyecto.proyecto_id,\n    horas: datosProyecto.horas,\n    descripcion: datosProyecto.descripcion,\n    chat_id: datosProyecto.chat_id,\n    uid: uid\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -752,
        800
      ],
      "id": "ca8a0987-9f8f-4772-8b27-581ea62b1f7c",
      "name": "Preparar Crear Tarea Autom√°tica"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.mensaje_confirmacion }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1056,
        720
      ],
      "id": "2e67e488-de5f-420e-8af6-63ad37324ff0",
      "name": "Confirmar Proyecto Creado",
      "webhookId": "2111177f-8e16-435a-9994-ec5050e2a77c"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.accion === 'continuar_con_tarea' }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1456,
        800
      ],
      "id": "4f354d38-aeda-43a6-a5a5-831a8be4de9d",
      "name": "¬øContinuar con Tarea?"
    },
    {
      "parameters": {
        "jsCode": "// Verificar PostgreSQL para continuaci√≥n de flujo tras crear proyecto\nconst proyectoCreado = $json.result;\nconst datosProyecto = $('Preparar Crear Proyecto').item.json;\nconst chatId = datosProyecto.chat_id;\n\n// Funci√≥n para acceso seguro sin memoria compleja\nfunction obtenerDatosSeguro(nombreNodo) {\n  try {\n    return $(nombreNodo).item.json;\n  } catch (e) {\n    console.log(`‚ö†Ô∏è Nodo \"${nombreNodo}\" no disponible:`, e.message);\n    return null;\n  }\n}\n\n// Obtener memoria desde PostgreSQL o usar memoria global simplificada\nconst memoriaGlobal = global[`memoria_${chatId}`] || {};\n\n// Verificar si hay datos pendientes en PostgreSQL o memoria global\nif (memoriaGlobal && memoriaGlobal.datos_pendientes && memoriaGlobal.datos_pendientes.accion_original === 'registrar_horas') {\n  const datosPendientes = memoriaGlobal.datos_pendientes;\n  \n  console.log('üìã Proyecto creado, continuando con tarea y horas desde PostgreSQL:', datosPendientes);\n  \n  return {\n    accion: 'continuar_con_tarea',\n    proyecto_id: proyectoCreado,\n    proyecto_nombre: datosProyecto.proyecto,\n    tarea: datosPendientes.tarea,\n    horas: datosPendientes.horas,\n    descripcion: datosPendientes.descripcion,\n    uid: datosProyecto.uid,\n    chat_id: chatId,\n    mensaje_confirmacion: `‚úÖ **¬°Proyecto creado exitosamente!**\\n\\nüèóÔ∏è **Proyecto:** ${datosProyecto.proyecto}\\nüÜî **ID:** ${proyectoCreado}\\n\\nüîÑ Ahora voy a crear la tarea \"${datosPendientes.tarea}\" y registrar ${datosPendientes.horas} horas...`\n  };\n} else {\n  console.log('‚úÖ Proyecto creado sin acciones pendientes en PostgreSQL');\n  return {\n    accion: 'solo_confirmar',\n    chat_id: chatId,\n    mensaje_confirmacion: `‚úÖ **¬°Proyecto creado exitosamente!**\\n\\nüèóÔ∏è **Proyecto:** ${datosProyecto.proyecto}\\nüÜî **ID:** ${proyectoCreado}\\n\\nYa puedes crear tareas en este proyecto y registrar tus horas. ¬øNecesitas ayuda con algo m√°s? üòä`\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1632,
        800
      ],
      "id": "00b044ff-6707-4274-b523-d39cca7443a9",
      "name": "Analizar Proyecto Creado"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1840,
        800
      ],
      "id": "2c2c5a2a-db66-4b9a-83c8-47297eebca42",
      "name": "Crear Proyecto HTTP"
    },
    {
      "parameters": {
        "jsCode": "// Crear nuevo proyecto en Odoo\n// Obtener uid de la fuente correcta\nconst uid = $('Autenticar Odoo').item.json.result;\nconst nombreProyecto = $json.proyecto;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticaci√≥n');\n}\n\nconst crearProyecto = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"project.project\",\n      \"create\",\n      [{\n        name: nombreProyecto,\n        allow_timesheets: true\n      }]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: crearProyecto,\n  ...$json,\n  uid: uid // Asegurar que uid se pasa al siguiente nodo\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2032,
        800
      ],
      "id": "32083097-830e-4aaf-ae8b-66db378bc4cc",
      "name": "Preparar Crear Proyecto"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.result && $json.result.length > 0 }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -816,
        256
      ],
      "id": "bbbf4e9c-001d-492b-8108-6b3bc9a2ca96",
      "name": "¬øTarea Existe?"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.result && $json.result.length > 0 }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1632,
        368
      ],
      "id": "ecd8e32a-091b-4cb6-a840-26aa6d78ad75",
      "name": "¬øProyecto Existe?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1248,
        2096
      ],
      "id": "09383bd5-ad6b-4825-81f3-e12b01398500",
      "name": "Enviar Respuesta Contacto",
      "webhookId": "f41186dc-171b-42f4-b629-54e9c800cd10"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de contactos para Telegram\nconst contactos = $json.result;\nconst datosConsulta = $('Preparar Consulta Contacto').item.json;\nlet texto = '';\n\nif (!Array.isArray(contactos) || contactos.length === 0) {\n  texto = '‚ùå No se encontr√≥ ning√∫n contacto con ese nombre.';\n} else {\n  texto = `üë§ *Contactos encontrados:*\\n`;\n  contactos.forEach((c, idx) => {\n    texto += `\\n${idx+1}. Nombre: ${c.name}\\n   üìß Email: ${c.email || 'No disponible'}\\n   üì± Tel√©fono: ${c.phone || 'No disponible'}\\n`;\n  });\n}\n\nreturn{\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1648,
        2208
      ],
      "id": "33e4a1de-f696-4b4f-a7df-c35f4310d443",
      "name": "Formatear Respuesta Contacto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n-main-21528542.dev.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1856,
        2208
      ],
      "id": "cd4ecb81-3a00-4db0-8a88-0f5df3351cbb",
      "name": "HTTP Consulta Contacto"
    },
    {
      "parameters": {
        "jsCode": "// Procesar consulta de contacto desde AI Agent\nconst datosAI = $json;\nconst uid = $json.uid || 'user_uid_fallback';\nconst nombreContacto = datosAI.contacto;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticaci√≥n');\n}\n\n// Validar que tenemos nombre del contacto\nif (!nombreContacto) {\n  throw new Error('No se encontr√≥ el nombre del contacto');\n}\n\n// B√öSQUEDA CASE-INSENSITIVE usando ilike\nconst palabras = nombreContacto.split(' ');\nconst condiciones = palabras.map(p => [\"name\", \"ilike\", p]);\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\", // DB\n      uid, \n      \"admin\", \n      \"res.partner\", \n      \"search_read\",\n      [\n        [[\"name\", \"ilike\", nombreContacto], ...condiciones],\n        [\"id\", \"name\", \"email\", \"phone\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  contacto: nombreContacto,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2048,
        2208
      ],
      "id": "dab2e872-982d-4a0a-9ab1-7304ed4f8ed0",
      "name": "Preparar Consulta Contacto"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -96,
        1760
      ],
      "id": "ba58f01b-884f-4de3-be1a-df89df4b4571",
      "name": "Enviar Respuesta Ventas",
      "webhookId": "fe6fe418-98fa-4f6d-ad08-92f3659eb578"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de ventas para Telegram CON INFORMACI√ìN COMPLETA DE FACTURAS\nconst datosPreparar = $json.datos_preparar || {};\n\n// Si no requiere informaci√≥n de facturas, usar formateo simple\nif (!datosPreparar.requiere_info_facturas) {\n  const ventas = datosPreparar.result || $json.result;\n  const datosConsulta = datosPreparar.datos_consulta || $json.datos_consulta;\n  let texto = '';\n  \n  console.log('üìã FORMATEO SIN INFO FACTURAS:');\n  console.log('   - Ventas encontradas:', ventas?.length || 0);\n  console.log('   - Tipo consulta:', datosConsulta?.tipo_consulta);\n  console.log('   - Par√°metro:', datosConsulta?.parametro);\n  \n  if (datosConsulta.tipo_consulta === 'producto_especifico' || datosConsulta.tipo_consulta === 'producto_especifico_con_fechas') {\n    const nombreProducto = datosConsulta.parametro || 'el producto';\n    \n    if (!Array.isArray(ventas) || ventas.length === 0) {\n      // Mensaje espec√≠fico con el nombre del producto y per√≠odo si aplica\n      if (datosConsulta.tipo_consulta === 'producto_especifico_con_fechas') {\n        const fechaDesdeFormateada = new Date(datosConsulta.fecha_desde).toLocaleDateString('es-ES');\n        const fechaHastaFormateada = new Date(datosConsulta.fecha_hasta).toLocaleDateString('es-ES');\n        texto = `‚ùå **No se encontraron ventas de \"${nombreProducto}\"**\\n\\nüìÖ **Per√≠odo consultado:** ${fechaDesdeFormateada} - ${fechaHastaFormateada}\\n\\nüí° *Verifica que el nombre del producto sea correcto o prueba con palabras clave m√°s generales.*`;\n      } else {\n        texto = `‚ùå **No se encontraron ventas de \"${nombreProducto}\"**\\n\\nüí° *Verifica que el nombre del producto sea correcto o prueba con palabras clave m√°s generales.*`;\n      }\n    } else {\n      const totalVentas = ventas.reduce((acc, v) => acc + (v.product_uom_qty || 0), 0);\n      texto = `üî¢ Se han vendido *${totalVentas} unidades* de \"${nombreProducto}\".\\n\\n`;\n      ventas.forEach((v, idx) => {\n        texto += `${idx+1}. Cantidad: ${v.product_uom_qty}\\n   Total l√≠nea: ${v.price_total} ‚Ç¨\\n`;\n      });\n    }\n  } else {\n    // Formateo para otros tipos de consulta\n    if (!Array.isArray(ventas) || ventas.length === 0) {\n      texto = '‚ùå No se encontr√≥ ninguna venta en ese per√≠odo.';\n    } else {\n      const total = ventas.reduce((acc, v) => acc + (v.amount_total || 0), 0);\n      texto = `üí∞ *Ventas totales*: ${total} ‚Ç¨\\n\\n`;\n      ventas.forEach((v, idx) => {\n        texto += `${idx+1}. üìÑ Pedido: ${v.name}\\n   üë§ Cliente: ${v.partner_id?.[1] || 'Desconocido'}\\n   üí∞ Total: ${v.amount_total} ‚Ç¨\\n   üìÖ Fecha: ${v.date_order}\\n\\n`;\n      });\n    }\n  }\n  \n  return {\n    texto,\n    chat_id: datosConsulta.chat_id\n  };\n}\n\n// FORMATEO AVANZADO CON INFORMACI√ìN COMPLETA DE FACTURAS\nconst ventasLineas = datosPreparar.ventas_lineas;\nconst facturas = $json.result || [];\nconst datosConsulta = datosPreparar.datos_consulta;\n\n// DEBUG CR√çTICO DEL FORMATEO FINAL\nconsole.log('üìã FORMATEAR RESPUESTA VENTAS - AN√ÅLISIS FINAL:');\nconsole.log('üíæ Estructura completa $json:', JSON.stringify($json, null, 2));\nconsole.log('üìä N√∫mero de facturas obtenidas:', facturas?.length || 0);\nconsole.log('üìù Array de facturas:', facturas);\nif (facturas && facturas.length > 0) {\n  console.log('üîç AN√ÅLISIS DETALLADO DE CADA FACTURA:');\n  facturas.forEach((factura, idx) => {\n    console.log(`   Factura ${idx + 1}:`);\n    console.log(`     - ID: ${factura.id}`);\n    console.log(`     - Nombre: ${factura.name}`);\n    console.log(`     - partner_id: ${JSON.stringify(factura.partner_id)}`);\n    console.log(`     - date_order: ${factura.date_order}`);\n    console.log(`     - state: ${factura.state}`);\n    console.log(`     - amount_total: ${factura.amount_total}`);\n    console.log(`     - Estructura completa:`, JSON.stringify(factura, null, 2));\n  });\n} else {\n  console.log('‚ùå NO HAY FACTURAS - Verificar respuesta HTTP');\n  console.log('   - $json.result:', $json.result);\n  console.log('   - $json.error:', $json.error);\n  console.log('   - Tipo de $json.result:', typeof $json.result);\n}\n\nif (!Array.isArray(ventasLineas) || ventasLineas.length === 0) {\n  const nombreProducto = datosConsulta?.parametro || 'el producto';\n  return {\n    texto: `‚ùå **No se encontraron ventas de \"${nombreProducto}\"**\\n\\nüí° *Verifica que el nombre del producto sea correcto o prueba con palabras clave m√°s generales.*`,\n    chat_id: datosConsulta.chat_id\n  };\n}\n\n// Crear un mapa de facturas para acceso r√°pido\nconst facturasPorId = {};\nfacturas.forEach(factura => {\n  facturasPorId[factura.id] = factura;\n});\n\n// AN√ÅLISIS DETALLADO POR FACTURAS\nconst totalUnidades = ventasLineas.reduce((acc, v) => acc + (v.product_uom_qty || 0), 0);\nconst totalImporte = ventasLineas.reduce((acc, v) => acc + (v.price_total || 0), 0);\n\n// Agrupar por orden de venta (factura)\nconst ventasPorOrden = {};\nventasLineas.forEach(venta => {\n  const orderId = venta.order_id?.[0] || 'Sin ID';\n  const facturaInfo = facturasPorId[orderId];\n  \n  if (!ventasPorOrden[orderId]) {\n    ventasPorOrden[orderId] = {\n      id: orderId,\n      nombre: facturaInfo?.name || venta.order_id?.[1] || 'Orden desconocida',\n      cliente: facturaInfo?.partner_id?.[1] || 'Cliente no disponible',\n      fecha: facturaInfo?.date_order || 'Fecha no disponible',\n      estado: facturaInfo?.state || 'Estado no disponible',\n      totalFactura: facturaInfo?.amount_total || 0,\n      lineas: [],\n      totalUnidades: 0,\n      totalImporteProducto: 0\n    };\n  }\n  \n  ventasPorOrden[orderId].lineas.push(venta);\n  ventasPorOrden[orderId].totalUnidades += (venta.product_uom_qty || 0);\n  ventasPorOrden[orderId].totalImporteProducto += (venta.price_total || 0);\n});\n\nconst numeroFacturas = Object.keys(ventasPorOrden).length;\nconst nombreProducto = ventasLineas[0]?.product_id?.[1] || 'Producto no identificado';\n\n// GENERAR TEXTO FINAL\nlet texto = `üìä **INFORME DETALLADO DE VENTAS**\\n\\n`;\ntexto += `üõçÔ∏è **Producto:** ${nombreProducto}\\n`;\n\n// A√±adir informaci√≥n del per√≠odo si es una consulta con fechas\nif (datosConsulta.tipo_consulta === 'producto_especifico_con_fechas') {\n  const fechaDesdeFormateada = new Date(datosConsulta.fecha_desde).toLocaleDateString('es-ES');\n  const fechaHastaFormateada = new Date(datosConsulta.fecha_hasta).toLocaleDateString('es-ES');\n  texto += `üìÖ **Per√≠odo:** ${fechaDesdeFormateada} - ${fechaHastaFormateada}\\n`;\n}\n\ntexto += `üî¢ **Total unidades vendidas:** ${totalUnidades}\\n`;\ntexto += `üí∞ **Importe total del producto:** ${totalImporte.toFixed(2)} ‚Ç¨\\n`;\ntexto += `üìÑ **N√∫mero de facturas:** ${numeroFacturas}\\n\\n`;\n\n// DETALLE POR FACTURA\ntexto += `üìã **DETALLE POR FACTURAS:**\\n\\n`;\n\nlet contadorFactura = 1;\nObject.values(ventasPorOrden).forEach(orden => {\n  // Formatear fecha\n  const fechaFormateada = orden.fecha !== 'Fecha no disponible' ? \n    new Date(orden.fecha).toLocaleDateString('es-ES') : orden.fecha;\n  \n  // Estados en espa√±ol\n  const estadoMap = {\n    'draft': 'Borrador',\n    'sent': 'Enviado',\n    'sale': 'Confirmado',\n    'done': 'Completado',\n    'cancel': 'Cancelado'\n  };\n  const estadoEspanol = estadoMap[orden.estado] || orden.estado;\n  \n  texto += `**${contadorFactura}. ${orden.nombre}**\\n`;\n  texto += `   üë§ Cliente: ${orden.cliente}\\n`;\n  texto += `   üìÖ Fecha: ${fechaFormateada}\\n`;\n  texto += `   üìä Estado: ${estadoEspanol}\\n`;\n  texto += `   üì¶ Unidades del producto: ${orden.totalUnidades}\\n`;\n  texto += `   üí∞ Importe del producto: ${orden.totalImporteProducto.toFixed(2)} ‚Ç¨\\n`;\n  texto += `   üíº Total factura: ${orden.totalFactura.toFixed(2)} ‚Ç¨\\n`;\n  \n  // Si hay m√∫ltiples l√≠neas del mismo producto en la misma factura\n  if (orden.lineas.length > 1) {\n    texto += `   üìù L√≠neas del producto (${orden.lineas.length}):\\n`;\n    orden.lineas.forEach((linea, idx) => {\n      texto += `      ${idx + 1}. Cant: ${linea.product_uom_qty} | Precio unit: ${linea.price_unit?.toFixed(2) || 'N/A'} ‚Ç¨\\n`;\n    });\n  } else {\n    const linea = orden.lineas[0];\n    texto += `   üí∂ Precio unitario: ${linea.price_unit?.toFixed(2) || 'N/A'} ‚Ç¨\\n`;\n  }\n  \n  texto += `\\n`;\n  contadorFactura++;\n});\n\nreturn {\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -512,
        1872
      ],
      "id": "ccb16cf8-d296-4bae-906d-4897e240af30",
      "name": "Formatear Respuesta Ventas"
    },
    {
      "parameters": {
        "jsCode": "// DEBUGGING COMPLETO DEL PROCESO DE FACTURAS\nconst respuestaFacturas = $json.result || [];\nconst datosPreparar = $json.datos_preparar || {};\n\nconsole.log('üî¨ DEBUGGING COMPLETO - AN√ÅLISIS DE FACTURAS:');\nconsole.log('=' .repeat(60));\n\n// 1. INFORMACI√ìN DE ENTRADA\nconsole.log('üì• DATOS DE ENTRADA:');\nconsole.log('   - Respuesta HTTP facturas:', respuestaFacturas?.length || 0, 'facturas');\nconsole.log('   - L√≠neas de venta:', datosPreparar.ventas_lineas?.length || 0, 'l√≠neas');\nconsole.log('   - √ìrdenes IDs esperadas:', datosPreparar.ordenes_ids?.length || 0, '√≥rdenes');\nconsole.log('   - Debug info:', JSON.stringify(datosPreparar.debug_info || {}, null, 2));\n\n// 2. AN√ÅLISIS DETALLADO DE RESPUESTA HTTP\nif (respuestaFacturas && respuestaFacturas.length > 0) {\n  console.log('\\n‚úÖ FACTURAS OBTENIDAS DE ODOO:');\n  respuestaFacturas.forEach((factura, idx) => {\n    console.log(`   Factura ${idx + 1}:`);\n    console.log(`     - ID: ${factura.id}`);\n    console.log(`     - Nombre: ${factura.name || 'Sin nombre'}`);\n    console.log(`     - Cliente ID: ${factura.partner_id?.[0] || 'Sin ID'}`);\n    console.log(`     - Cliente Nombre: ${factura.partner_id?.[1] || 'Sin nombre'}`);\n    console.log(`     - Fecha: ${factura.date_order || 'Sin fecha'}`);\n    console.log(`     - Total: ${factura.amount_total || 0}`);\n    console.log(`     - Estado: ${factura.state || 'Sin estado'}`);\n    console.log(`     - Estructura completa:`, JSON.stringify(factura, null, 4));\n  });\n} else {\n  console.log('\\n‚ùå NO SE OBTUVIERON FACTURAS:');\n  console.log('   - Respuesta completa:', JSON.stringify($json, null, 2));\n  console.log('   - ¬øHubo error?:', $json.error || 'No hay error reportado');\n}\n\n// 3. AN√ÅLISIS DE L√çNEAS DE VENTA\nif (datosPreparar.ventas_lineas && datosPreparar.ventas_lineas.length > 0) {\n  console.log('\\nüìä AN√ÅLISIS DE L√çNEAS DE VENTA:');\n  const ordenesEnLineas = {};\n  \n  datosPreparar.ventas_lineas.forEach((linea, idx) => {\n    const orderId = linea.order_id?.[0];\n    const orderName = linea.order_id?.[1];\n    \n    if (!ordenesEnLineas[orderId]) {\n      ordenesEnLineas[orderId] = {\n        id: orderId,\n        nombre: orderName,\n        lineas: 0,\n        totalUnidades: 0,\n        totalImporte: 0\n      };\n    }\n    \n    ordenesEnLineas[orderId].lineas++;\n    ordenesEnLineas[orderId].totalUnidades += (linea.product_uom_qty || 0);\n    ordenesEnLineas[orderId].totalImporte += (linea.price_total || 0);\n    \n    console.log(`   L√≠nea ${idx + 1}:`);\n    console.log(`     - Producto: ${linea.product_id?.[1] || 'N/A'}`);\n    console.log(`     - Orden ID: ${orderId}`);\n    console.log(`     - Orden Nombre: ${orderName}`);\n    console.log(`     - Cantidad: ${linea.product_uom_qty}`);\n    console.log(`     - Precio unitario: ${linea.price_unit}`);\n    console.log(`     - Total l√≠nea: ${linea.price_total}`);\n  });\n  \n  console.log('\\nüìà RESUMEN POR √ìRDENES:');\n  Object.values(ordenesEnLineas).forEach((orden, idx) => {\n    console.log(`   Orden ${idx + 1}:`);\n    console.log(`     - ID: ${orden.id}`);\n    console.log(`     - Nombre: ${orden.nombre}`);\n    console.log(`     - L√≠neas: ${orden.lineas}`);\n    console.log(`     - Total unidades: ${orden.totalUnidades}`);\n    console.log(`     - Total importe: ${orden.totalImporte}`);\n  });\n  \n  console.log(`\\nüìä TOTAL √ìRDENES √öNICAS EN L√çNEAS: ${Object.keys(ordenesEnLineas).length}`);\n}\n\n// 4. VERIFICACI√ìN DE CONCORDANCIA\nconsole.log('\\nüîç VERIFICACI√ìN DE CONCORDANCIA:');\nconst ordenesEsperadas = datosPreparar.ordenes_ids || [];\nconst ordenesObtenidas = respuestaFacturas.map(f => f.id) || [];\n\nconsole.log('   - IDs esperadas:', ordenesEsperadas);\nconsole.log('   - IDs obtenidas:', ordenesObtenidas);\n\nconst faltantes = ordenesEsperadas.filter(id => !ordenesObtenidas.includes(id));\nconst extras = ordenesObtenidas.filter(id => !ordenesEsperadas.includes(id));\n\nif (faltantes.length > 0) {\n  console.log('   ‚ö†Ô∏è √ìrdenes faltantes:', faltantes);\n}\nif (extras.length > 0) {\n  console.log('   ‚ûï √ìrdenes extras:', extras);\n}\nif (faltantes.length === 0 && extras.length === 0) {\n  console.log('   ‚úÖ Concordancia perfecta');\n}\n\nconsole.log('\\n' + '=' .repeat(60));\n\n// COMBINAR DATOS PARA EL SIGUIENTE NODO\n// Intentar obtener datos del nodo anterior con fallback\nlet datosAnteriores = {};\ntry {\n  datosAnteriores = $('Debug Pre-HTTP').item.json;\n} catch (e) {\n  console.log('‚ö†Ô∏è No se pudieron obtener datos del nodo Debug Pre-HTTP:', e.message);\n}\n\nconst datosCombinados = {\n  ...$json, // Respuesta HTTP\n  datos_preparar: {\n    ventas_lineas: datosAnteriores.ventas_lineas || [],\n    datos_consulta: datosAnteriores.datos_consulta || {},\n    requiere_info_facturas: datosAnteriores.requiere_info_facturas || false,\n    ordenes_ids: datosAnteriores.ordenes_ids || [],\n    debug_info: datosAnteriores.debug_info || {}\n  }\n};\n\nconsole.log('üîÑ DATOS COMBINADOS PARA FORMATEO:');\nconsole.log('   - Facturas HTTP:', datosCombinados.result?.length || 0);\nconsole.log('   - L√≠neas de venta:', datosCombinados.datos_preparar?.ventas_lineas?.length || 0);\nconsole.log('   - Requiere info facturas:', datosCombinados.datos_preparar?.requiere_info_facturas);\n\nreturn datosCombinados;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        1712
      ],
      "id": "832e48d7-9914-44de-9f01-9704807e89ea",
      "name": "Debug Facturas Completo"
    },
    {
      "parameters": {
        "jsCode": "// DEBUG ADICIONAL: Verificar payload antes de env√≠o HTTP\nconst payloadOrdenes = $json.payload_ordenes;\nconst debugInfo = $json.debug_info;\n\nconsole.log('üåê DEBUG HTTP INFO FACTURAS - ANTES DEL ENV√çO:');\nconsole.log('=' .repeat(50));\nconsole.log('üì§ Payload que se enviar√°:', JSON.stringify(payloadOrdenes, null, 2));\nconsole.log('üîç Debug info recibido:', JSON.stringify(debugInfo, null, 2));\nconsole.log('üìä IDs que se buscar√°n:', debugInfo?.ordenes_ids);\nconsole.log('üîë UID en uso:', debugInfo?.uid_usado);\nconsole.log('=' .repeat(50));\n\n// Pasar datos sin modificar\nreturn $json;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1088,
        1712
      ],
      "id": "0e793c49-5c24-4d28-8fa3-8a630b8b53f6",
      "name": "Debug Pre-HTTP"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n-main-21528542.dev.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload_ordenes }}",
        "options": {
          "timeout": 30000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -896,
        1712
      ],
      "id": "662a227e-bd37-4850-9603-4786d4b262aa",
      "name": "HTTP Info Facturas"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.requiere_info_facturas }}",
              "value2": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1456,
        1872
      ],
      "id": "839841ef-b5f0-40d3-96ce-54837d231b5d",
      "name": "¬øRequiere Info Facturas?"
    },
    {
      "parameters": {
        "jsCode": "// Obtener informaci√≥n detallada de las facturas para productos espec√≠ficos CON DEBUGGING MEJORADO\nconst ventas = $json.result;\nconst datosConsulta = $('Preparar Consulta Ventas').item.json;\n\nconsole.log('üìä PREPARAR INFO FACTURAS - DEBUG MEJORADO:');\nconsole.log('üìÑ Tipo consulta:', datosConsulta.tipo_consulta);\nconsole.log('üìà N√∫mero de l√≠neas de venta:', ventas?.length || 0);\nconsole.log('üîç Estructura completa respuesta Odoo:', JSON.stringify($json, null, 2));\n\n// Si no es una consulta de producto espec√≠fico, pasar directamente al formateo\nif (datosConsulta.tipo_consulta !== 'producto_especifico' && datosConsulta.tipo_consulta !== 'producto_especifico_con_fechas') {\n  console.log('‚ùå No es consulta de producto espec√≠fico');\n  return {\n    ...($json),\n    requiere_info_facturas: false,\n    datos_consulta: datosConsulta\n  };\n}\n\n// Si no hay ventas, pasar directamente\nif (!Array.isArray(ventas) || ventas.length === 0) {\n  console.log('‚ùå No hay ventas o no es array');\n  return {\n    ...($json),\n    requiere_info_facturas: false,\n    datos_consulta: datosConsulta\n  };\n}\n\n// DEBUGGING DETALLADO DE √ìRDENES\nconsole.log('üîç ANALIZANDO √ìRDENES DE VENTA CON DETALLE:');\nventas.forEach((venta, idx) => {\n  console.log(`  L√≠nea ${idx + 1}:`);\n  console.log(`    - Producto: ${venta.product_id?.[1] || 'N/A'}`);\n  console.log(`    - Order ID: ${venta.order_id?.[0] || 'N/A'}`);\n  console.log(`    - Order Name: ${venta.order_id?.[1] || 'N/A'}`);\n  console.log(`    - Cantidad: ${venta.product_uom_qty}`);\n  console.log(`    - Precio total: ${venta.price_total}`);\n  console.log(`    - Estructura order_id completa:`, JSON.stringify(venta.order_id, null, 2));\n});\n\n// Obtener IDs √∫nicos de las √≥rdenes de venta\nconst ordenesIds = [...new Set(ventas.map(v => v.order_id?.[0]).filter(id => id))];\n\nconsole.log('üìã √ìRDENES √öNICAS ENCONTRADAS:');\nconsole.log('   IDs √∫nicos:', ordenesIds);\nconsole.log('   N√∫mero de √≥rdenes diferentes:', ordenesIds.length);\nconsole.log('   Tipo de IDs:', ordenesIds.map(id => typeof id));\n\nif (ordenesIds.length === 0) {\n  console.log('‚ùå No se encontraron IDs de √≥rdenes v√°lidas');\n  return {\n    ...($json),\n    requiere_info_facturas: false,\n    datos_consulta: datosConsulta\n  };\n}\n\n// Preparar consulta para obtener informaci√≥n de las √≥rdenes de venta\nconst uid = datosConsulta.uid || 'user_uid_fallback';\nconsole.log('üîë UID obtenido para consulta:', uid);\n\n// CONSULTA MEJORADA CON M√ÅS CAMPOS Y DEBUGGING\nconst consultaOrdenesMejorada = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\",\n      uid,\n      \"admin\",\n      \"sale.order\",\n      \"search_read\",\n      [[[\"id\", \"in\", ordenesIds]]],\n      { \n        fields: [\n          \"id\", \"name\", \"partner_id\", \"date_order\", \"amount_total\", \n          \"state\", \"amount_untaxed\", \"amount_tax\"\n        ],\n        limit: 100\n      }\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nconsole.log('üöÄ CONSULTA MEJORADA A √ìRDENES DE VENTA:');\nconsole.log('   üî¢ IDs a buscar:', ordenesIds);\nconsole.log('   üìä Cantidad de IDs:', ordenesIds.length);\nconsole.log('   üîë UID usado:', uid);\nconsole.log('   üìù Consulta completa:', JSON.stringify(consultaOrdenesMejorada, null, 2));\n\nreturn {\n  payload_ordenes: consultaOrdenesMejorada,\n  ventas_lineas: ventas,\n  datos_consulta: datosConsulta,\n  requiere_info_facturas: true,\n  ordenes_ids: ordenesIds,\n  debug_info: {\n    total_lineas: ventas.length,\n    ordenes_unicas: ordenesIds.length,\n    ordenes_ids: ordenesIds,\n    uid_usado: uid,\n    consulta_preparada: new Date().toISOString(),\n    tipos_ids: ordenesIds.map(id => typeof id)\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1648,
        1872
      ],
      "id": "530530c7-5ee3-4c0c-8fb0-7ca80b5ec324",
      "name": "Preparar Info Facturas"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n-main-21528542.dev.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1856,
        1872
      ],
      "id": "9b021c8b-0b00-4987-bfc0-b96d4cd9d26e",
      "name": "HTTP Consulta Ventas"
    },
    {
      "parameters": {
        "jsCode": "// Procesar consulta de ventas desde AI Agent\nconst datosAI = $json;\nconst uid = $json.uid || 'user_uid_fallback';\nconst tipoConsulta = datosAI.tipo_consulta;\nconst parametro = datosAI.parametro;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticaci√≥n');\n}\n\nlet jsonRpcPayload;\n\n// VENTAS DEL MES ACTUAL\nif (tipoConsulta === 'mes_actual') {\n  const now = new Date();\n  const year = now.getFullYear();\n  const month = now.getMonth() + 1;\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"azorn8n-main-21528542\",\n        uid,\n        \"admin\",\n        \"sale.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", primerDia],\n          [\"date_order\", \"<\", primerDiaSiguienteMes]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n} \n// VENTAS DEL MES PASADO\nelse if (tipoConsulta === 'mes_pasado') {\n  const now = new Date();\n  let year = now.getFullYear();\n  let month = now.getMonth();\n  if (month === 0) {\n    month = 12;\n    year = year - 1;\n  }\n  const mes = month < 10 ? `0${month}` : `${month}`;\n  const primerDia = `${year}-${mes}-01`;\n  const siguienteMes = month === 12 ? 1 : month + 1;\n  const siguienteAnio = month === 12 ? year + 1 : year;\n  const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n  const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"azorn8n-main-21528542\",\n        uid,\n        \"admin\",\n        \"sale.order\",\n        \"search_read\",\n        [[\n          [\"date_order\", \">=\", primerDia],\n          [\"date_order\", \"<\", primerDiaSiguienteMes]\n        ]],\n        { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\"] }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// VENTAS POR PRODUCTO\nelse if (tipoConsulta === 'producto_especifico') {\n  const palabras = parametro.split(' ');\n  const condiciones = palabras.map(p => [\"product_id\", \"ilike\", p]);\n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"azorn8n-main-21528542\",\n        uid,\n        \"admin\",\n        \"sale.order.line\",\n        \"search_read\",\n        [[[\"product_id\", \"ilike\", parametro], ...condiciones]],\n        { \"fields\": [\"order_id\", \"product_id\", \"product_uom_qty\", \"price_total\", \"price_unit\", \"name\"], \"limit\": 1000 }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// VENTAS POR PRODUCTO CON FILTROS DE FECHA\nelse if (tipoConsulta === 'producto_especifico_con_fechas') {\n  const fechaDesde = datosAI.fecha_desde;\n  const fechaHasta = datosAI.fecha_hasta;\n  \n  // Validar fechas\n  if (!fechaDesde || !fechaHasta) {\n    throw new Error('Se requieren fecha_desde y fecha_hasta para consultas con filtros de fecha');\n  }\n  \n  const palabras = parametro.split(' ');\n  const condicionesProducto = palabras.map(p => [\"product_id\", \"ilike\", p]);\n  \n  // Necesitamos hacer una consulta compleja:\n  // 1. Buscar l√≠neas de venta del producto\n  // 2. Filtrar por fechas de las √≥rdenes asociadas\n  // Para eso, usaremos una consulta con join impl√≠cito\n  \n  jsonRpcPayload = {\n    jsonrpc: \"2.0\",\n    method: \"call\",\n    params: {\n      service: \"object\",\n      method: \"execute_kw\",\n      args: [\n        \"azorn8n-main-21528542\",\n        uid,\n        \"admin\",\n        \"sale.order.line\",\n        \"search_read\",\n        [[\n          [\"product_id\", \"ilike\", parametro], \n          ...condicionesProducto,\n          [\"order_id.date_order\", \">=\", fechaDesde],\n          [\"order_id.date_order\", \"<=\", fechaHasta]\n        ]],\n        { \n          \"fields\": [\"order_id\", \"product_id\", \"product_uom_qty\", \"price_total\", \"price_unit\", \"name\"], \n          \"limit\": 1000 \n        }\n      ]\n    },\n    id: Math.floor(Math.random() * 1000000)\n  };\n}\n// VENTAS POR MES ESPEC√çFICO (nombre)\nelse if (tipoConsulta === 'mes_nombre') {\n  const meses = [\n    \"enero\", \"febrero\", \"marzo\", \"abril\", \"mayo\", \"junio\",\n    \"julio\", \"agosto\", \"septiembre\", \"octubre\", \"noviembre\", \"diciembre\"\n  ];\n  const mesIndex = meses.indexOf(parametro.toLowerCase());\n  if (mesIndex !== -1) {\n    const now = new Date();\n    let year = now.getFullYear();\n    if (mesIndex + 1 > (now.getMonth() + 1)) {\n      year = year - 1;\n    }\n    const mes = (mesIndex + 1) < 10 ? `0${mesIndex + 1}` : `${mesIndex + 1}`;\n    const primerDia = `${year}-${mes}-01`;\n    const siguienteMes = (mesIndex + 2) > 12 ? 1 : (mesIndex + 2);\n    const siguienteAnio = (mesIndex + 2) > 12 ? year + 1 : year;\n    const mesSiguiente = siguienteMes < 10 ? `0${siguienteMes}` : `${siguienteMes}`;\n    const primerDiaSiguienteMes = `${siguienteAnio}-${mesSiguiente}-01`;\n\n    jsonRpcPayload = {\n      jsonrpc: \"2.0\",\n      method: \"call\",\n      params: {\n        service: \"object\",\n        method: \"execute_kw\",\n        args: [\n          \"azorn8n-main-21528542\",\n          uid,\n          \"admin\",\n          \"sale.order\",\n          \"search_read\",\n          [[\n            [\"date_order\", \">=\", primerDia],\n            [\"date_order\", \"<\", primerDiaSiguienteMes]\n          ]],\n          { fields: [\"name\", \"partner_id\", \"amount_total\", \"date_order\"] }\n        ]\n      },\n      id: Math.floor(Math.random() * 1000000)\n    };\n  }\n}\n\nreturn {\n  payload: jsonRpcPayload,\n  tipo_consulta: tipoConsulta,\n  parametro: parametro,\n  fecha_desde: datosAI.fecha_desde || null,\n  fecha_hasta: datosAI.fecha_hasta || null,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2048,
        1872
      ],
      "id": "b68ddb05-8747-413e-8a54-4a8003963776",
      "name": "Preparar Consulta Ventas"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1312,
        1440
      ],
      "id": "0cf9792a-0dbc-48b4-95f9-09b80fc982af",
      "name": "Enviar Respuesta Producto",
      "webhookId": "8d190a46-cc62-4e77-9970-ddccd65470ac"
    },
    {
      "parameters": {
        "jsCode": "// Formatear respuesta de productos para Telegram\nconst respuestaOdoo = $json.result;\nconst datosConsulta = $('Preparar Consulta Producto').item.json;\nlet texto = '';\n\nif (!Array.isArray(respuestaOdoo) || respuestaOdoo.length === 0) {\n  texto = '‚ùå No se encontr√≥ ning√∫n producto con ese nombre.';\n} else {\n  texto = `‚úÖ *Productos encontrados:*\\n`;\n  respuestaOdoo.forEach((p, idx) => {\n    texto += `\\n${idx+1}. üõçÔ∏è Nombre: ${p.name}\\n   üí∞ Precio: ${p.list_price} ‚Ç¨\\n   üì¶ Stock disponible: ${p.qty_available}\\n`;\n  });\n}\n\nreturn{\n  texto,\n  chat_id: datosConsulta.chat_id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1712,
        1536
      ],
      "id": "25216c9e-cd08-4134-87cc-6ab3ed41b7e6",
      "name": "Formatear Respuesta Producto"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ $json.payload }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1872,
        1536
      ],
      "id": "c790e7da-f62b-4411-92fd-dd3c8b056531",
      "name": "HTTP Consulta Producto"
    },
    {
      "parameters": {
        "jsCode": "// Procesar consulta de producto desde AI Agent\nconst datosAI = $json;\nconst uid = $json.uid || 'user_uid_fallback';\nconst nombreProducto = datosAI.producto;\n\n// Validar que tenemos uid\nif (!uid) {\n  throw new Error('No se pudo obtener el UID de autenticaci√≥n');\n}\n\n// Validar que tenemos nombre del producto\nif (!nombreProducto) {\n  throw new Error('No se encontr√≥ el nombre del producto');\n}\n\n// B√öSQUEDA CASE-INSENSITIVE usando ilike\nconst jsonRpcPayload = {\n  jsonrpc: \"2.0\",\n  method: \"call\",\n  params: {\n    service: \"object\",\n    method: \"execute_kw\",\n    args: [\n      \"azorn8n-main-21528542\", // DB\n      uid, \n      \"admin\", \n      \"product.template\", \n      \"search_read\",\n      [\n        [[\"name\", \"ilike\", nombreProducto]],\n        [\"id\", \"name\", \"list_price\", \"qty_available\"]\n      ]\n    ]\n  },\n  id: Math.floor(Math.random() * 1000000)\n};\n\nreturn {\n  payload: jsonRpcPayload,\n  producto: nombreProducto,\n  chat_id: datosAI.chat_id,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2048,
        1536
      ],
      "id": "205d73a2-f07f-4c67-af6d-e39a1a68ae93",
      "name": "Preparar Consulta Producto"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "registrar_horas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "db6b3a7e-1dbc-480b-9f19-140a5b475ff8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "registrar_horas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_proyecto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "4d3b1b52-3a05-4db9-8e20-4a169f36c573"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_proyecto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_tarea",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7982d83f-173e-4fd4-8575-f14bbd738755"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_tarea"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_producto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "bdbcf283-8a52-450f-abdc-fd2b9c59118b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_producto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_ventas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f110a38e-bd19-44f9-b101-60d57a8d0c4c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_ventas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "consultar_contacto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c4b58122-b0e0-44ad-8bb3-f518d674a40e"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_contacto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_contacto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "23be78fa-e92c-45e1-a66e-023bd2a99a31"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_contacto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_proyecto_tarea_horas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "e1a59b7b-5617-4db7-925b-f544943d2364"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_proyecto_tarea_horas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "crear_tarea_y_horas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3720ebf9-3c0c-43ed-8c15-6c3e2abfb46f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_tarea_y_horas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 1
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.accion }}",
                    "rightValue": "modificar_contacto",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7e6cda34-8686-4a24-8f48-61870b29dbc8"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "modificar_contacto"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3,
      "position": [
        -2640,
        1280
      ],
      "id": "58d0e2f4-933b-4ba4-9c22-5e05740f17a1",
      "name": "Switch Acciones"
    },
    {
      "parameters": {
        "jsCode": "// ROUTER INTELIGENTE - Detecta confirmaciones y consulta memoria\nconst respuestaAgent = $json;\nconst chatId = respuestaAgent.chat_id;\n\n\n// üî• USAR MEMORIA DE POSTGRESQL EN LUGAR DE GLOBAL\n// Obtener memoria desde el nodo anterior que consult√≥ PostgreSQL\nconst datosConMemoria = $('Preparar Datos AI Agent').first().json;\nlet memoria = {\n  esperando_confirmacion: datosConMemoria.esperando_confirmacion,\n  datos_pendientes: datosConMemoria.datos_pendientes\n};\n\nconsole.log('üéØ === ROUTER INTELIGENTE ===');\nconsole.log('üì• Acci√≥n recibida:', respuestaAgent.accion);\nconsole.log('üí¨ Mensaje usuario:', respuestaAgent.mensaje_usuario || respuestaAgent.mensaje_original);\nconsole.log('üß† Memoria PostgreSQL:', JSON.stringify(memoria, null, 2));\nconsole.log('üìã Datos completos AI Agent:', JSON.stringify(datosConMemoria, null, 2));\n\n// DETECTAR CONFIRMACIONES INTELIGENTES\nlet accionFinal = respuestaAgent.accion;\nlet datosFinales = { ...respuestaAgent };\n\n// Si el usuario est√° esperando confirmaci√≥n y dice algo que parece confirmaci√≥n\nif (memoria.esperando_confirmacion && memoria.datos_pendientes) {\n  const mensajeUsuario = (respuestaAgent.mensaje_usuario || '').toLowerCase();\n  const esConfirmacion = mensajeUsuario.includes('s√≠') || \n                        mensajeUsuario.includes('si') || \n                        mensajeUsuario.includes('crear') ||\n                        mensajeUsuario.includes('adelante') ||\n                        mensajeUsuario.includes('vale') ||\n                        respuestaAgent.accion === 'conversar' && mensajeUsuario.includes('s√≠');\n  \n  if (esConfirmacion) {\n    console.log('‚úÖ CONFIRMACI√ìN DETECTADA!');\n    console.log('ü§î Esperando confirmaci√≥n de:', memoria.esperando_confirmacion);\n    console.log('üìã Datos pendientes:', memoria.datos_pendientes);\n    \n    // Determinar acci√≥n bas√°ndose en lo que est√° pendiente\n    if (memoria.esperando_confirmacion === 'crear_proyecto_completo' && \n        memoria.datos_pendientes.tipo_creacion === 'proyecto_tarea_horas') {\n      accionFinal = 'crear_proyecto_tarea_horas';\n      datosFinales = {\n        ...respuestaAgent,\n        accion: 'crear_proyecto_tarea_horas',\n        proyecto: memoria.datos_pendientes.proyecto,\n        tarea: memoria.datos_pendientes.tarea,\n        horas: memoria.datos_pendientes.horas,\n        descripcion: memoria.datos_pendientes.descripcion,\n        datos_pendientes: memoria.datos_pendientes\n      };\n      console.log('üèóÔ∏è Acci√≥n cambiada a: crear_proyecto_tarea_horas');\n    }\n    else if (memoria.esperando_confirmacion === 'crear_tarea_solamente' && \n             memoria.datos_pendientes.tipo_creacion === 'solo_tarea_horas') {\n      accionFinal = 'crear_tarea_y_horas';\n      datosFinales = {\n        ...respuestaAgent,\n        accion: 'crear_tarea_y_horas',\n        proyecto: memoria.datos_pendientes.proyecto,\n        proyecto_id: memoria.datos_pendientes.proyecto_id,\n        tarea: memoria.datos_pendientes.tarea,\n        horas: memoria.datos_pendientes.horas,\n        descripcion: memoria.datos_pendientes.descripcion,\n        datos_pendientes: memoria.datos_pendientes\n      };\n      console.log('‚úÖ Acci√≥n cambiada a: crear_tarea_y_horas');\n    }\n    else if (memoria.esperando_confirmacion === 'crear_proyecto' && \n             memoria.datos_pendientes.accion_original === 'registrar_horas') {\n      // Mantener l√≥gica existente para compatibilidad\n      accionFinal = 'crear_proyecto';\n      console.log('üèóÔ∏è Manteniendo l√≥gica existente: crear_proyecto');\n    }\n  }\n}\n\n// Actualizar memoria solo para acciones espec√≠ficas\nif (accionFinal === 'registrar_horas') {\n  const contextoKey = `memoria_${chatId}`;\n  memoria.proyecto_anterior = respuestaAgent.proyecto;\n  memoria.tarea_anterior = respuestaAgent.tarea;\n  memoria.ultima_accion = 'registrar_horas';\n  global[contextoKey] = memoria;\n}\n\nconsole.log('üéØ ACCI√ìN FINAL:', accionFinal);\nconsole.log('üìä DATOS FINALES:', JSON.stringify(datosFinales, null, 2));\n\nreturn datosFinales;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3280,
        1408
      ],
      "id": "03d57fd8-85d5-4b95-9eaa-6a6ad7669cac",
      "name": "Router de Acciones FIXED"
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta del AI Agent - SIMPLIFICADO\n\nlet respuestaAgent;\n\ntry {\n  // Obtener la respuesta del AI Agent\n  const textoRespuesta = $json.output || $json.response || $json.text || $json.message || '';\n  \n  // Intentar extraer JSON de la respuesta\n  const jsonMatch = textoRespuesta.match(/```json\\s*([\\s\\S]*?)\\s*```/) || \n                   textoRespuesta.match(/{[\\s\\S]*}/);\n  \n  if (jsonMatch) {\n    respuestaAgent = JSON.parse(jsonMatch[1] || jsonMatch[0]);\n  } else {\n    try {\n      respuestaAgent = JSON.parse(textoRespuesta);\n    } catch {\n      respuestaAgent = {\n        accion: \"conversar\",\n        respuesta_usuario: textoRespuesta || \"Lo siento, no entend√≠ tu mensaje. ¬øPodr√≠as reformularlo?\"\n      };\n    }\n  }\n} catch (error) {\n  console.error('Error parseando respuesta del AI Agent:', error);\n  respuestaAgent = {\n    accion: \"conversar\",\n    respuesta_usuario: \"Hubo un error procesando tu solicitud. ¬øPodr√≠as intentar de nuevo?\"\n  };\n}\n\n// OBTENER DATOS DEL USUARIO DESDE EL NODO ANTERIOR (PREPARAR DATOS AI AGENT)\n// El AI Agent solo devuelve su respuesta JSON, los datos del usuario est√°n en el nodo anterior\nconst datosUsuario = $('Preparar Datos AI Agent').first().json;\n\nconst chatId = datosUsuario.chat_id || 'unknown';\nconst userId = datosUsuario.user_id || 'unknown';\nconst userName = datosUsuario.user_name || 'Usuario';\nconst mensajeUsuario = datosUsuario.mensaje_usuario || 'mensaje no disponible';\nconst uid = datosUsuario.uid || 'unknown';\nconst plataforma = $('Extraer Datos').first().json.plataforma;\n\nconsole.log('üîç PROCESAR RESPUESTA - Datos recibidos:');\nconsole.log('   chat_id:', chatId);\nconsole.log('   user_name:', userName);\nconsole.log('   mensaje_usuario:', mensajeUsuario);\nconsole.log('   uid:', uid);\nconsole.log('üìã Datos del usuario completos:', JSON.stringify(datosUsuario, null, 2));\nconsole.log('ü§ñ Respuesta del AI Agent:', JSON.stringify(respuestaAgent, null, 2));\n\n// Actualizar memoria seg√∫n la acci√≥n\nif (chatId !== 'unknown') {\n  const contextoKey = `memoria_${chatId}`;\n  let memoriaActualizada = global[contextoKey] || {};\n\n  if (respuestaAgent.accion === 'crear_tarea') {\n    memoriaActualizada = {\n      ...memoriaActualizada,\n      esperando_confirmacion: 'crear_tarea',\n      datos_pendientes: {\n        proyecto: respuestaAgent.proyecto,\n        tarea: respuestaAgent.tarea,\n        accion_original: 'crear_tarea_simple'\n      }\n    };\n    global[contextoKey] = memoriaActualizada;\n  } else if (respuestaAgent.accion === 'registrar_horas') {\n    memoriaActualizada = {\n      ...memoriaActualizada,\n      proyecto_anterior: respuestaAgent.proyecto,\n      tarea_anterior: respuestaAgent.tarea,\n      ultima_accion: 'registrar_horas'\n    };\n    global[contextoKey] = memoriaActualizada;\n  }\n}\n\nreturn [{\n  ...respuestaAgent,\n  chat_id: chatId,\n  user_id: userId,\n  user_name: userName,\n  uid: uid,\n  mensaje_original: mensajeUsuario,\n  plataforma\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3488,
        1408
      ],
      "id": "fc086ead-eaa7-404f-a916-87a80d58eeb7",
      "name": "Procesar Respuesta"
    },
    {
      "parameters": {
        "jsCode": "// PREPARAR DATOS PARA AI AGENT CON MEMORIA - Solo para confirmaciones\n\n// Obtener datos del usuario desde \"Obtener Chat ID\"\nconst datosUsuario = $('Obtener Chat ID').item.json;\n\nconsole.log('‚úÖ CAMINO CONFIRMACI√ìN - Obteniendo memoria PostgreSQL...');\nconsole.log('üìù Mensaje confirmaci√≥n:', datosUsuario.mensaje_usuario);\n\n// üóÑÔ∏è GESTI√ìN Y OBTENCI√ìN DE MEMORIA POSTGRESQL\nlet memoriaUsuario = {\n  esperando_confirmacion: null,\n  ultimo_mensaje_bot: null,\n  datos_pendientes: null\n};\n\ntry {\n  const consultaMemoria = $('Consultar Memoria PostgreSQL').first();\n  if (consultaMemoria && consultaMemoria.json) {\n    const registro = consultaMemoria.json;\n    memoriaUsuario = {\n      esperando_confirmacion: registro.esperando_confirmacion,\n      ultimo_mensaje_bot: registro.ultimo_mensaje_bot,\n      datos_pendientes: registro.datos_pendientes ? (typeof registro.datos_pendientes === 'string' ? JSON.parse(registro.datos_pendientes) : registro.datos_pendientes) : null\n    };\n    console.log('‚úÖ Memoria PostgreSQL encontrada:', memoriaUsuario);\n  } else {\n    console.log('üì≠ No se encontr√≥ memoria previa para este usuario');\n  }\n} catch (error) {\n  console.log('‚ö†Ô∏è Error obteniendo memoria PostgreSQL:', error.message);\n}\n\n// Datos completos CON memoria para confirmaciones\nconst datosCompletos = {\n  // Datos del usuario\n  mensaje_usuario: datosUsuario.mensaje_usuario,\n  chat_id: datosUsuario.chat_id,\n  user_id: datosUsuario.user_id,\n  user_name: datosUsuario.user_name,\n  es_audio: datosUsuario.es_audio || false,\n  timestamp: datosUsuario.timestamp || new Date().toISOString(),\n  \n  // Datos de autenticaci√≥n\n  uid: datosUsuario.uid,\n  \n  // üî• MEMORIA COMPLETA PARA CONFIRMACIONES\n  esperando_confirmacion: memoriaUsuario.esperando_confirmacion,\n  ultimo_mensaje_bot: memoriaUsuario.ultimo_mensaje_bot,\n  datos_pendientes: memoriaUsuario.datos_pendientes,\n  \n  // Campos adicionales\n  file_id: datosUsuario.file_id,\n  transcripcion_original: datosUsuario.transcripcion_original,\n  audio_transcrito: datosUsuario.audio_transcrito\n};\n\nconsole.log('üì§ ENVIANDO AL AI AGENT CON MEMORIA COMPLETA');\nconsole.log('üéØ Datos:', {\n  mensaje_usuario: datosCompletos.mensaje_usuario,\n  user_name: datosCompletos.user_name,\n  chat_id: datosCompletos.chat_id,\n  tiene_memoria: !!datosCompletos.esperando_confirmacion\n});\n\n// ‚úÖ IMPORTANTE: Devolver como ARRAY para que n8n lo procese correctamente\nreturn [datosCompletos];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4080,
        1408
      ],
      "id": "55bc5479-3a48-4aa8-9ae0-238ff9e621c2",
      "name": "Preparar Datos AI Agent"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "0fe0638d-d5d0-4a23-92a7-2e711191f1bd",
              "leftValue": "={{ $json.mensaje_usuario }}",
              "rightValue": "s√≠",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -4480,
        1392
      ],
      "id": "33e2773f-d7bd-4f65-8558-f03842ecef4a",
      "name": "IF Detectar Confirmaci√≥n"
    },
    {
      "parameters": {
        "jsCode": "// OBTENER CHAT_ID DEL USUARIO\nconst uid = $json.result;\n\n// Funci√≥n para obtener datos de nodos anteriores con manejo de errores\nfunction obtenerDatosSeguro(nombreNodo) {\n  try {\n    return $(nombreNodo).item.json;\n  } catch (e) {\n    console.log(`‚ö†Ô∏è Nodo \"${nombreNodo}\" no disponible:`, e.message);\n    return null;\n  }\n}\n\n// Intentar obtener datos del usuario desde diferentes fuentes\nlet datosUsuario = null;\n\n// Primero intentar desde \"Actualizar Datos Transcripci√≥n\" (para audio)\ndatosUsuario = obtenerDatosSeguro('Actualizar Datos Transcripci√≥n');\n\n// Si no existe, intentar desde \"Extraer Datos\" (para texto)\nif (!datosUsuario) {\n  datosUsuario = obtenerDatosSeguro('Extraer Datos');\n}\n\n// Si a√∫n no tenemos datos, usar valores por defecto\nif (!datosUsuario) {\n  console.error('‚ùå GRAVE: No se encontraron datos del usuario en ning√∫n nodo');\n  datosUsuario = {\n    mensaje_usuario: 'ERROR: No se encontr√≥ mensaje del usuario',\n    chat_id: 'unknown',\n    user_id: 'unknown',\n    user_name: 'Usuario',\n    es_audio: false\n  };\n}\n\nconsole.log('üîç OBTENER CHAT ID - Datos obtenidos:', {\n  mensaje_usuario: datosUsuario.mensaje_usuario,\n  chat_id: datosUsuario.chat_id,\n  user_name: datosUsuario.user_name\n});\n\nreturn {\n  ...datosUsuario,\n  uid: uid\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4672,
        1312
      ],
      "id": "292a5504-3b63-4f3b-9c5a-7caeb324b859",
      "name": "Obtener Chat ID"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT esperando_confirmacion, ultimo_mensaje_bot, datos_pendientes, created_at FROM n8n WHERE chat_id = $1 AND esperando_confirmacion IS NOT NULL AND esperando_confirmacion != '' ORDER BY created_at DESC LIMIT 1",
        "options": {
          "queryReplacement": "={{ [$('Obtener Chat ID').item.json.chat_id] }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        -4272,
        1248
      ],
      "id": "f5dee6a5-26bc-4d6b-8ab4-18a0fe4091df",
      "name": "Consultar Memoria PostgreSQL"
    },
    {
      "parameters": {
        "url": "https://azorn8n.odoo.com/jsonrpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"jsonrpc\": \"2.0\",\n  \"method\": \"call\",\n  \"params\": {\n    \"service\": \"common\",\n    \"method\": \"authenticate\",\n    \"args\": [\n      \"azorn8n-main-21528542\",\n      \"admin\",\n      \"admin\",\n      {}\n    ]\n  },\n  \"id\": 1\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4848,
        1312
      ],
      "id": "67d225dc-4c6f-40f3-b10b-9233fc493d24",
      "name": "Autenticar Odoo"
    },
    {
      "parameters": {
        "jsCode": "// Extraer informaci√≥n b√°sica tanto de Telegram como de WhatsApp\nlet mensaje = '';\nlet esAudio = false;\nlet fileId = null;\nlet chatId = null;\nlet userId = null;\nlet userName = 'Usuario';\n\n// 1) Mensaje de Telegram\nif ($json.message) {\n  const msg = $json.message;\n  chatId    = msg.chat?.id;\n  userId    = msg.from?.id;\n  userName  = msg.from?.first_name || userName;\n\n  if (msg.text) {\n    mensaje = msg.text;\n  } else if (msg.voice) {\n    esAudio = true;\n    fileId  = msg.voice.file_id;\n    mensaje = '[Mensaje de voz recibido. Transcribiendo‚Ä¶]';\n  }\n\n// 2) Mensaje de WhatsApp\n} else if ($json.messages) {\n  const wa = $json.messages[0];\n  // chatId y userId suelen ser el n√∫mero de tel√©fono\n  chatId   = wa.from || $input.first().json.contacts?.[0]?.wa_id;\n  userId   = wa.from;\n  userName = $json.contacts?.[0]?.profile?.name || userName;\n\n  if (wa.text?.body) {\n    mensaje = wa.text.body;\n  } else if (wa.type === 'audio') {\n    esAudio = true;\n    // n8n descarga el binario en $binary\n    // si necesitas el archivo, f√≠jate en wa.audio?.id o en $binary['data']\n    fileId  = wa.audio?.id || null;\n    mensaje = '[Mensaje de voz recibido. Transcribiendo‚Ä¶]';\n  }\n}\n\n// Detectar plataforma en el payload crudo\nconst plataforma =   $json.message  ? 'telegram'\n                   : $json.messages ? 'whatsapp'\n                   : 'unknown';\n\nreturn {\n  mensaje_usuario: mensaje,\n  chat_id:        chatId,\n  user_id:        userId,\n  user_name:      userName,\n  timestamp:      new Date().toISOString(),\n  es_audio:       esAudio,\n  file_id:        fileId,\n  plataforma\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5472,
        1200
      ],
      "id": "931c091b-65a1-4682-82e8-b5ed83c8ec90",
      "name": "Extraer Datos"
    },
    {
      "parameters": {
        "updates": [
          "message",
          "voice"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -5712,
        1200
      ],
      "id": "9a474cd8-3894-425c-bc3b-680751ebf708",
      "name": "Telegram Trigger",
      "webhookId": "977df3a4-bb10-432e-b34b-8af62370055f"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.assemblyai.com/v2/upload",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4320,
        640
      ],
      "id": "be1ca33c-55c3-4a85-a418-3742638d5fd5",
      "name": "HTTP Request - Upload Audio"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.assemblyai.com/v2/transcript",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify({audio_url: $json.upload_url, language_code: 'es', punctuate: true}) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4112,
        640
      ],
      "id": "ee3f9927-981f-4016-9d2f-5076b85ac4c8",
      "name": "HTTP Request - Create Transcript (ES)"
    },
    {
      "parameters": {
        "url": "=https://api.assemblyai.com/v2/transcript/{{ $json.id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "9180ed0422f64e0196e8bfe27baf019b"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3888,
        640
      ],
      "id": "aaf912b4-a42f-49bf-b01c-950a7d56525f",
      "name": "HTTP Request - Get Transcript"
    },
    {
      "parameters": {
        "amount": 10,
        "unit": "seconds"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [
        -4000,
        640
      ],
      "id": "42a586b8-24bd-4aa1-b758-a2285df79a70",
      "name": "Esperar Transcripci√≥n",
      "webhookId": "d61ddaf5-03ee-41a3-8c80-ddd1be652ddb"
    },
    {
      "parameters": {
        "jsCode": "// Manejar acci√≥n no contemplada\nconst datos = $json;\nconst accion = datos.accion || 'acci√≥n desconocida';\nconst mensajeUsuario = datos.mensaje_usuario || datos.mensaje_original || 'mensaje no disponible';\nconst chatId = datos.chat_id || 'unknown';\nconst plataforma = $input.first().json.plataforma;\n\n\nconsole.log('‚ùå ACCI√ìN NO CONTEMPLADA DETECTADA');\nconsole.log('üîç Acci√≥n recibida:', accion);\nconsole.log('üí¨ Mensaje usuario:', mensajeUsuario);\nconsole.log('üì± Chat ID:', chatId);\n\n// Lista de acciones contempladas\nconst accionesContempladas = [\n  'registrar horas',\n  'crear proyecto',\n  'crear tarea',\n  'consultar producto',\n  'consultar ventas',\n  'consultar contacto',\n  'crear contacto',\n  'crear proyecto tarea horas',\n  'crear tarea y horas',\n  'modificar contacto'\n];\n\n// Crear mensaje de respuesta\nconst mensajeRespuesta = `‚ùå **La acci√≥n \"${accion}\" no est√° contemplada en el sistema.**\n\n**Acciones contempladas:**\n${accionesContempladas.map(acc => `‚Ä¢ ${acc}`).join('\\n')}\n\n**Tu mensaje:** \"${mensajeUsuario}\"\n\nPor favor, reformula tu solicitud usando una de las acciones disponibles.`;\n\nreturn {\n  chat_id: chatId,\n  texto: mensajeRespuesta,\n  accion_no_contemplada: accion,\n  mensaje_original: mensajeUsuario,\n  plataforma\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2096,
        4176
      ],
      "id": "e9c68f5b-4887-4756-a795-9653c636e2d7",
      "name": "Acci√≥n No Contemplada"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{ $json.chat_id }}",
        "textBody": "={{ $json.texto }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -1600,
        4240
      ],
      "id": "b99a406d-0581-4236-9583-f562c0725677",
      "name": "Enviar Respuesta Acci√≥n No Contemplada Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ $json.texto }}",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1600,
        4016
      ],
      "id": "3f9eed70-8d4f-4411-8c78-cb871c9e42f1",
      "name": "Enviar Respuesta Acci√≥n No Contemplada Telegram",
      "webhookId": "bb89483c-c521-4f30-92bf-dcafb29e96a0"
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=‚úÖ **¬°Parte de horas registrado exitosamente!**\n\nüìã **Detalles del registro:**\n‚Ä¢ **Proyecto:** {{ $('Registrar Horas Directo').item.json.datos_registro.proyecto }}\n‚Ä¢ **Tarea:** {{ $('Registrar Horas Directo').item.json.datos_registro.tarea }}\n‚Ä¢ **Horas:** {{ $('Registrar Horas Directo').item.json.datos_registro.horas }}\n‚Ä¢ **Descripci√≥n:** {{ $('Registrar Horas Directo').item.json.datos_registro.descripcion }}\n‚Ä¢ **Fecha:** {{ new Date().toLocaleDateString('es-ES') }}\n‚Ä¢ **ID del registro:** {{ $json.result }}\n\nüéâ **¬°Listo!** ¬øNecesitas registrar m√°s horas? üòä",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        0,
        176
      ],
      "id": "7a666f60-96a1-4fb7-a547-206b5892ec44",
      "name": "Confirmar Horas Registradas Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=‚úÖ **El proyecto \"{{ $('Guardar Memoria Tarea No Existe').item.json.proyecto }}\" existe.**\n‚ùå **Pero la tarea \"{{ $('Guardar Memoria Tarea No Existe').item.json.tarea }}\" no existe.**\n\nüìã **Parte de horas pendiente:**\n‚Ä¢ **Proyecto:** {{ $('Guardar Memoria Tarea No Existe').item.json.proyecto }} ‚úÖ\n‚Ä¢ **Tarea:** {{ $('Guardar Memoria Tarea No Existe').item.json.tarea }} ‚ùå\n‚Ä¢ **Horas:** {{ $('Guardar Memoria Tarea No Existe').item.json.horas }}\n‚Ä¢ **Descripci√≥n:** {{ $('Guardar Memoria Tarea No Existe').item.json.descripcion }}\n\nü§î **¬øQuieres que cree la tarea?**\n\nSi dices **\"s√≠\"**, crear√©:\n1Ô∏è‚É£ La tarea \"{{ $('Guardar Memoria Tarea No Existe').item.json.tarea }}\" en el proyecto existente\n2Ô∏è‚É£ El parte de horas autom√°ticamente\n\n**Responde:**\n‚Ä¢ **'s√≠'** para crear la tarea y registrar horas\n‚Ä¢ **'no'** para cancelar",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        128,
        560
      ],
      "id": "3f2a334f-b66c-42a5-bff4-0bd0837d0443",
      "name": "Preguntar Crear Tarea Solamente Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=‚úÖ **¬°Tarea creada exitosamente!**\n\nüìù **Tarea:** {{ $('Preparar Crear Tarea').item.json.datos_tarea.nombre_tarea }}\nüèóÔ∏è **Proyecto:** {{ $('Preparar Crear Tarea').item.json.datos_tarea.nombre_proyecto }}\nüÜî **ID:** {{ $json.result }}\n\nYa puedes registrar horas en esta tarea. ¬øNecesitas ayuda con algo m√°s? üòä",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -1040,
        1200
      ],
      "id": "79306b86-c46b-490a-8471-dcdd238ac92d",
      "name": "Confirmar Tarea Creada Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=‚úÖ **¬°Tarea creada y horas registradas exitosamente!**\n\nüìã **Proyecto:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.proyecto_nombre }}\nüìù **Tarea:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.tarea_nombre }} (NUEVA)\n‚è∞ **Horas:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.horas }}\nüìÖ **Fecha:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.fecha }}\nüí¨ **Descripci√≥n:** {{ $('Preparar Registro Autom√°tico').item.json.datos_registro.descripcion }}\n\nüéâ ¬°Todo completado autom√°ticamente! ¬°Gracias por mantener tu registro actualizado!",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        416,
        1200
      ],
      "id": "dba533a3-4732-470c-beab-ca9463278bc9",
      "name": "Confirmar Todo Completado Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=‚ùå **El proyecto \"{{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\" no existe.**\n\nüìã **Parte de horas pendiente:**\n‚Ä¢ **Proyecto:** {{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\n‚Ä¢ **Tarea:** {{ $('Guardar Memoria Proyecto No Existe').item.json.tarea }}\n‚Ä¢ **Horas:** {{ $('Guardar Memoria Proyecto No Existe').item.json.horas }}\n‚Ä¢ **Descripci√≥n:** {{ $('Guardar Memoria Proyecto No Existe').item.json.descripcion }}\n\nü§î **¬øQuieres que cree el proyecto completo?**\n\nSi dices **\"s√≠\"**, crear√©:\n1Ô∏è‚É£ El proyecto \"{{ $('Guardar Memoria Proyecto No Existe').item.json.proyecto }}\"\n2Ô∏è‚É£ La tarea \"{{ $('Guardar Memoria Proyecto No Existe').item.json.tarea }}\"\n3Ô∏è‚É£ El parte de horas autom√°ticamente\n\n**Responde:**\n‚Ä¢ **'s√≠'** para crear todo\n‚Ä¢ **'no'** para cancelar",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -880,
        608
      ],
      "id": "15fa01ac-5032-4b71-a27f-438f5a18e3e9",
      "name": "Preguntar Crear Proyecto Completo Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "={{ $json.mensaje_confirmacion }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -1056,
        896
      ],
      "id": "f1fcaebb-6b75-4feb-ad4d-4ad7ac3e3399",
      "name": "Confirmar Proyecto Creado Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=üéâ **¬°TODO COMPLETADO AUTOM√ÅTICAMENTE!**\n\n‚úÖ **Proyecto creado:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.proyecto_nombre }}\n‚úÖ **Tarea creada:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.tarea_nombre }}\n‚úÖ **Horas registradas:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.horas }}\nüìÖ **Fecha:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.fecha }}\nüí¨ **Descripci√≥n:** {{ $('Preparar Registro Autom√°tico Completo').item.json.datos_registro_automatico.descripcion }}\n\n¬°Incre√≠ble! He creado el proyecto, la tarea y registrado tus horas autom√°ticamente. ¬°Todo listo! üöÄ",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        208,
        912
      ],
      "id": "c1f7a119-f694-4475-be8a-80ebbc9642b4",
      "name": "Confirmar Todo Autom√°tico Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=‚ùå El proyecto \"{{ $('Buscar Proyecto para Tarea').item.json.proyecto }}\" no existe.\n\nDebes crear el proyecto primero antes de a√±adir tareas. ¬øQuieres que lo cree? Responde:\n- **'s√≠'** para crear el proyecto\n- **'no'** para cancelar",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -560,
        1440
      ],
      "id": "c83cd80e-8e8a-4a83-9ba9-02e6b805a8bc",
      "name": "Proyecto No Existe Para Tarea Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "={{ $json.texto }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -1312,
        1632
      ],
      "id": "750d2185-766f-41cb-a62e-5d25f5e9bdaa",
      "name": "Enviar Respuesta Producto Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "={{ $json.texto }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -96,
        1952
      ],
      "id": "ddaabce0-c15a-47bc-b842-675eea81abcb",
      "name": "Enviar Respuesta Ventas Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "={{ $json.texto }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -1248,
        2288
      ],
      "id": "c45a73ed-42bf-4c65-aaa1-b87dd6fabea9",
      "name": "Enviar Respuesta Contacto Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "={{ $json.texto }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -1072,
        2656
      ],
      "id": "2ebfec8c-f0dd-4b07-a14b-f4d897054df5",
      "name": "Enviar Respuesta Contacto Creado Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=üéâ **¬°Flujo completo exitoso!**\n\n‚úÖ **Proyecto creado:** {{ $json.resumen_creado.proyecto }} (ID: {{ $json.resumen_creado.proyecto_id }})\n‚úÖ **Tarea creada:** {{ $json.resumen_creado.tarea }} (ID: {{ $json.resumen_creado.tarea_id }})\n‚úÖ **Horas registradas:** {{ $json.resumen_creado.horas }}h (ID: {{ $json.resumen_creado.horas_id }})\nüìÖ **Fecha:** {{ $json.resumen_creado.fecha }}\nüìù **Descripci√≥n:** {{ $json.resumen_creado.descripcion }}\n\nüöÄ Todo ha sido creado y registrado exitosamente en Odoo.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -240,
        2992
      ],
      "id": "cc941dd9-649f-4570-aaa8-15e3249467aa",
      "name": "Confirmar Flujo Completo Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "=‚úÖ **¬°Tarea y horas registradas exitosamente!**\n\nüìã **Proyecto existente:** {{ $json.resumen_creado.proyecto }} (ID: {{ $json.resumen_creado.proyecto_id }})\n‚úÖ **Tarea creada:** {{ $json.resumen_creado.tarea }} (ID: {{ $json.resumen_creado.tarea_id }})\n‚è∞ **Horas registradas:** {{ $json.resumen_creado.horas }}h (ID: {{ $json.resumen_creado.horas_id }})\nüìÖ **Fecha:** {{ $json.resumen_creado.fecha }}\nüìù **Descripci√≥n:** {{ $json.resumen_creado.descripcion }}\n\nüéØ Tarea y horas a√±adidas al proyecto exitosamente.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -560,
        3392
      ],
      "id": "b6266a15-e8c9-40bd-91c3-550d136a7236",
      "name": "Confirmar Tareas Horas Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "={{ $json.texto }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        -1056,
        3728
      ],
      "id": "9ce8ad6a-9dc2-4163-982d-20c9cf4c47d2",
      "name": "Pedir Nuevo Valor Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "780727378449037",
        "recipientPhoneNumber": "={{$('Router de Acciones FIXED').first().json.chat_id}}",
        "textBody": "={{ $json.texto }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        0,
        3776
      ],
      "id": "6aea4fc7-51d4-4b9f-ac7e-e7baf5da7dbb",
      "name": "Confirmar Modificaci√≥n Whatsapp",
      "webhookId": "6b96cc08-e870-407e-b9e4-3c3d19cb3680",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1936,
        4176
      ],
      "id": "36b200ff-3b11-441e-b83b-daf0232a7114",
      "name": "¬øPlataforma?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -240,
        112
      ],
      "id": "a12b1d77-dcb6-4160-bb1f-94aae0fde0f0",
      "name": "¬øPlataforma?1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -112,
        432
      ],
      "id": "3d910fea-1f56-497a-94ae-75770c92a4a2",
      "name": "¬øPlataforma?2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1056,
        448
      ],
      "id": "e0140e32-45d1-472c-8cf1-dbc99a157ecf",
      "name": "¬øPlataforma?3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1248,
        800
      ],
      "id": "a7ece127-1eec-4058-86e0-a7f6b90584f4",
      "name": "¬øPlataforma?4"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        0,
        816
      ],
      "id": "90bec962-6efb-4be1-b1d5-7a46a4abce8b",
      "name": "¬øPlataforma?5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        208,
        1072
      ],
      "id": "65b18079-9461-4fef-a434-a06d7779f1a8",
      "name": "¬øPlataforma?6"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1168,
        1088
      ],
      "id": "6124a8e9-c0eb-4182-9427-e86fc9a1eb1e",
      "name": "¬øPlataforma?7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -880,
        1360
      ],
      "id": "7685581f-1db7-45d2-8d05-1472f1c1d5e3",
      "name": "¬øPlataforma?8"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1536,
        1552
      ],
      "id": "d21b3792-7982-46b0-afa6-e7ffb04daee5",
      "name": "¬øPlataforma?9"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -320,
        1872
      ],
      "id": "4f86fef6-80da-41a7-a374-97d1902524e0",
      "name": "¬øPlataforma?10"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1472,
        2208
      ],
      "id": "56c6cde9-6809-4bf2-b625-27a1250363e2",
      "name": "¬øPlataforma?11"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1456,
        2576
      ],
      "id": "49214a84-d0bc-47f1-918c-7a387190cd91",
      "name": "¬øPlataforma?12"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -480,
        2928
      ],
      "id": "7348e28d-aab5-4668-9874-8e2ad14cb9c4",
      "name": "¬øPlataforma?13"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -800,
        3328
      ],
      "id": "a0ce71b2-2b16-4a67-bab4-c5dc05147f7d",
      "name": "¬øPlataforma?14"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1296,
        3680
      ],
      "id": "1a2e2f12-0691-48bf-8627-696936bb8fd7",
      "name": "¬øPlataforma?15"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2848859-33aa-48bc-bd64-58ee850508a1",
              "leftValue": "={{ $('Switch Acciones').item.json.plataforma }}",
              "rightValue": "telegram",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -192,
        3696
      ],
      "id": "b7a5b2c9-3469-425c-b7f2-3e43202ccb18",
      "name": "¬øPlataforma?16"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "shared": [
    {
      "updatedAt": "2026-02-18T07:55:57.313Z",
      "createdAt": "2026-02-18T07:55:57.313Z",
      "role": "workflow:owner",
      "workflowId": "TLZSeoUIVCQ6R3SJ",
      "projectId": "s4WYDaCaT1Iwz31l"
    }
  ],
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-02-18T07:55:57.313Z",
  "versionId": "5e9c4153-87ee-4102-bc8a-c011e0bed898"
}